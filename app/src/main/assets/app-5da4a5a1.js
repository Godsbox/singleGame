!function(){"use strict";var e="undefined"==typeof global?self:global;if("function"!=typeof e.require){var t={},n={},a={},o={}.hasOwnProperty,r=/^\.\.?(\/|$)/,i=function(e,t){for(var n,a=[],o=(r.test(t)?e+"/"+t:t).split("/"),i=0,s=o.length;i<s;i++)n=o[i],".."===n?a.pop():"."!==n&&""!==n&&a.push(n);return a.join("/")},s=function(e){return e.split("/").slice(0,-1).join("/")},l=function(t){return function(n){var a=i(s(t),n);return e.require(a,t)}},c=function(e,t){var a=y&&y.createHot(e),o={id:e,exports:{},hot:a};return n[e]=o,t(o.exports,l(e),o),o.exports},u=function(e){return a[e]?u(a[e]):e},d=function(e,t){return u(i(s(e),t))},h=function(e,a){null==a&&(a="/");var r=u(e);if(o.call(n,r))return n[r].exports;if(o.call(t,r))return c(r,t[r]);throw new Error("Cannot find module '"+e+"' from '"+a+"'")};h.alias=function(e,t){a[t]=e};var f=/\.[^.\/]+$/,m=/\/index(\.[^\/]+)?$/,p=function(e){if(f.test(e)){var t=e.replace(f,"");o.call(a,t)&&a[t].replace(f,"")!==t+"/index"||(a[t]=e)}if(m.test(e)){var n=e.replace(m,"");o.call(a,n)||(a[n]=e)}};h.register=h.define=function(e,a){if(e&&"object"==typeof e)for(var r in e)o.call(e,r)&&h.register(r,e[r]);else t[e]=a,delete n[e],p(e)},h.list=function(){var e=[];for(var n in t)o.call(t,n)&&e.push(n);return e};var y=e._hmr&&new e._hmr(d,h,t,n);h._cache=n,h.hmr=y&&y.wrap,h.brunch=!0,e.require=h}}(),function(){var e="undefined"==typeof window?this:window;require.register("js/AppConstants.js",function(e,t,n){"use strict";window.diygamePlayer={AppConstants:{CMD_STARTUP:"CMD_STARTUP",CMD_FRAME_ENTER:"CMD_FRAME_ENTER",CMD_SVG_MENU:"CMD_SVG_MENU",CMD_LOAD_GAME:"CMD_LOAD_GAME",CMD_UPDATE_MUSIC_STATE:"CMD_UPDATE_MUSIC_STATE",APP_DEBUG_MODE:"APP_DEBUG_MODE",APP_LOG:"APP_LOG",APP_SHOW_INSPECTOR:"APP_SHOW_INSPECTOR",APP_SHOW_MENUBAR:"APP_SHOW_MENUBAR",APP_FPS_UPDATE:"APP_FPS_UPDATE",STAGE_TRAP_MOUSE:"STAGE_TRAP_MOUSE",SCENE_SHOW_ERROR:"SCENE_SHOW_ERROR",SCENE_SHOW_SAVE_ALERT:"SCENE_SHOW_SAVE_ALERT",SCENE_SHOW_AD:"SCENE_SHOW_AD",SCENE_TOOGLE_SCREEN_STATE:"SCENE_TOOGLE_SCREEN_STATE",SCENE_SKIPPING:"SCENE_SKIPPING",SCENE_PRELOADING_BEGIN:"SCENE_PRELOADING_BEGIN",SCENE_PRELOADING_PROGRESS:"SCENE_PRELOADING_PROGRESS",SCENE_PRELOADING_COMPLETE:"SCENE_PRELOADING_COMPLETE",SCENE_LOADING_BEGIN:"SCENE_LOADING_BEGIN",SCENE_LOADING_PROGRESS:"SCENE_LOADING_PROGRESS",SCENE_LOADING_COMPLETE:"SCENE_LOADING_COMPLETE",SCENE_TEMPLATE_LOADED:"SCENE_TEMPLATE_LOADED",SCENE_SHOW_LOGO:"SCENE_SHOW_LOGO",SCENE_GOTO_COVERMENU:"SCENE_GOTO_COVERMENU",SCENE_GOTO_MAINMENU:"SCENE_GOTO_MAINMENU",SCENE_GOTO_SETTINGS:"SCENE_GOTO_SETTINGS",SCENE_GOTO_PLAYBACK:"SCENE_GOTO_PLAYBACK",SCENE_GOTO_RECORD:"SCENE_GOTO_RECORD",SCENE_GOTO_END:"SCENE_GOTO_END",SCENE_CLOSE_MENU:"SCENE_CLOSE_MENU",SCENE_PLOT_ANIM_BEGIN:"SCENE_PLOT_ANIM_BEGIN",SCENE_PLOT_SKIP:"SCENE_PLOT_SKIP",SCENE_PLOT_CLOSED:"SCENE_PLOT_CLOSED",SCENE_PLOT_LOAD_BEGIN:"SCENE_PLOT_LOAD_BEGIN",SCENE_PLOT_LOAD_ASSETS_READY:"SCENE_PLOT_LOAD_ASSETS_READY",SCENE_PLOT_LOAD_ASSETS_LOADED:"SCENE_PLOT_LOAD_ASSETS_LOADED",SCENE_PLOT_LOAD_END:"SCENE_PLOT_LOAD_END",SCENE_BACKGROUND_COLOR_UPDATE:"SCENE_BACKGROUND_COLOR_UPDATE",SCENE_BACKGROUND_UPDATE:"SCENE_BACKGROUND_UPDATE",SCENE_BACKGROUND_ENTERED:"SCENE_BACKGROUND_ENTERED",SCENE_BACKGROUND_SWITCH:"SCENE_BACKGROUND_SWITCH",SCENE_MUSIC_UPDATE:"SCENE_MUSIC_UPDATE",SCENE_SOUND_UPDATE:"SCENE_SOUND_UPDATE",SCENE_CHARACTER_UPDATE:"SCENE_CHARACTER_UPDATE",SCENE_PROP_UPDATE:"SCENE_PROP_UPDATE",SCENE_VIEW_UPDATE:"SCENE_VIEW_UPDATE",SCENE_DIALOG_UPDATE:"SCENE_DIALOG_UPDATE",SCENE_DIALOG_COMPLETE:"SCENE_DIALOG_COMPLETE",SCENE_CHECK_IF_SKIP:"SCENE_CHECK_IF_SKIP",SCENE_CLICK_ON_SCENE:"SCENE_CLICK_ON_SCENE",SCENE_OPTION_UPDATE:"SCENE_OPTION_UPDATE",SCENE_MENUBUTTON_UPDATE:"SCENE_MENUBUTTON_UPDATE",SCENE_WEATHER_UPDATE:"SCENE_WEATHER_UPDATE",SCENE_EFFECT_SHAKE:"SCENE_EFFECT_SHAKE",SCENE_EFFECT_TWINKLE:"SCENE_EFFECT_TWINKLE",SCENE_CLEAR:"SCENE_CLEAR",SCENE_SHOW_GUIDE:"SCENE_SHOW_GUIDE",ADD_PLAYBACK_CONTENT:"ADD_PLAYBACK_CONTENT",SCENE_DESTROY_VIEW:"SCENE_DESTROY_VIEW",SCENE_SHOW_INPUT_VIEW:"SCENE_SHOW_INPUT_VIEW"}}}),require.register("js/ApplicationFacade.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.ApplicationFacade",parent:r["default"].Facade},{startup:function(){this.initialized||(this.initialized=!0,this.registerCommand(diygamePlayer.AppConstants.CMD_STARTUP,diygamePlayer.controller.command.StartupCommand),this.sendNotification(diygamePlayer.AppConstants.CMD_STARTUP))}},{getInstance:function(e){var t=r["default"].Facade.instanceMap,n=t[e];return n?n:t[e]=new diygamePlayer.ApplicationFacade(e)},NAME:"diygamePlayer"})}),require.register("js/common/Dialog.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"showDialog",value:function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]&&arguments[5],i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0;!this.isShow&&(this.isShow=!0);var l=this;return new Promise(function(c,u){var d=function(){document.body.removeChild(m),l.isShow=!1,c("ok")},h=function(){document.body.removeChild(m),l.isShow=!1,u("cancel")},f=function(){document.body.removeChild(m),l.isShow=!1,u("close")},m=document.createElement("div");m.classList.add("ModalContainer");var p=document.createElement("div");p.classList.add("ModalPortal"),document.body.clientWidth<=document.body.clientHeight&&(p.style.transform="rotate(90deg)"),window.onresize=function(){document.body.clientWidth<=document.body.clientHeight?flashvars.vertical?p.style.transform="rotate(0)":p.style.transform="rotate(90deg)":flashvars.vertical?p.style.transform="rotate(90deg)":p.style.transform="rotate(0)"},m.appendChild(p);var y=document.createElement("div");y.classList.add("Title");var g=document.createElement("span");g.innerText=e;var v=document.createElement("span");v.classList.add("spaceSpan");var x=document.createElement("span");x.classList.add("Close"),x.innerText="×",x.onclick=r?f:h,y.appendChild(g),y.appendChild(v),y.appendChild(x),p.appendChild(y);var P=document.createElement("div");P.classList.add("Content"),p.appendChild(P);var w=document.createElement("div");w.classList.add("ContentData"),n&&w.classList.add(n),w.innerText=t,P.appendChild(w);var k=document.createElement("div");k.classList.add("Buttons"),P.appendChild(k);var b=document.createElement("button"),C=document.createElement("button");if(b.classList.add("ButtonOk"),C.classList.add("ButtonsCancel"),b.innerText=a||"确定",C.innerText=o||"取消",k.appendChild(b),k.appendChild(C),b.onclick=d,C.onclick=h,document.body.appendChild(m),i>0){var _=function S(e,t,n){t<=0?(e.removeAttribute("disabled"),e.style.background="#3DC826",e.style.backgroundColor="#3DC826",e.style.border="#3DC826",e.style.color="#FFFFFF",e.innerText=n):(e.setAttribute("disabled",!0),e.style.background="#8c8c8c",e.style.backgroundColor="#8c8c8c",e.style.color="#FFFFFF",e.style.border="#8c8c8c",e.innerText=t,t--,setTimeout(function(){S(e,t,n)},1e3))};0===s?_(b,i,b.innerText):1===s?_(C,i,C.innerText):2===s&&(_(b,i,b.innerText),_(C,i,C.innerText))}window.onresize()})}},{key:"info",value:function(e){if(!this.isShow)return this.showDialog("提示",e,"Info")}},{key:"warn",value:function(e){if(!this.isShow)return this.showDialog("警告",e,"Warn")}},{key:"error",value:function(e){if(!this.isShow)return this.showDialog("错误",e,"Error")}},{key:"custom",value:function(e,t,n,a,o,r,i,s){return this.isShow?Promise.reject():this.showDialog(n,t,e,a,o,r,i,s)}}]),e}();e["default"]=r}),require.register("js/common/FontUtils.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t("./Utils.js"),s=a(i),l=function(){function e(){o(this,e)}return r(e,null,[{key:"isFontExist",value:function(e){var t=["Microsoft YaHei","Helvetica","sans-serif","serif"],n="qwertyuiopasdfghjklzxcvbnm",a="72px",o=document.createElement("span");if(o.style.fontSize=a,o.innerHTML=n,!this.defaultWidth||!this.defaultHeight){this.defaultWidth={},this.defaultHeight={};for(var r in t)o.style.fontFamily=t[r],document.body.appendChild(o),this.defaultWidth[t[r]]=o.offsetWidth,this.defaultHeight[t[r]]=o.offsetHeight,document.body.removeChild(o)}var i=!1;for(var s in t){o.style.fontFamily=e+","+t[s],document.body.appendChild(o);var l=o.offsetWidth!=this.defaultWidth[t[s]]||o.offsetHeight!=this.defaultHeight[t[s]];document.body.removeChild(o),i=i||l}return i}},{key:"mergeFontImage",value:function(t,n){var a=this,o=[];return t.size?t.size.target.width?(this.charWidth=t.size.target.width,this.charHeight=t.size.target.height):(this.charWidth=t.size.target,this.charHeight=t.size.target):(this.charWidth=n,this.charHeight=n),this.widthImg=this.countPerRow*this.charWidth,this.heightImg=this.rowPerImg*this.charHeight,new Promise(function(n,r){if(!t)return n();if(a.isFontExist(t.fontFamily))return n();e.fontFamily=t.fontFamily;for(var i=0;i<t.images.length;i++)o[i]="https://apppic.3000test.com"+t.images[i].url,a.fontChars+=t.images[i].chars;var l=document.createElement("canvas"),c=l.getContext("2d"),u=o.length,d=Math.ceil(a.fontChars.length/a.countPerRow);l.width=a.widthImg,l.height=d*a.charHeight;var h=function f(t){if(!(t<u)){var r=l.toDataURL("image/png",1),i=s["default"].dataURLtoBlob(r),h=i?URL.createObjectURL(i):r;return a.fontImage=h,n()}var m=new Image,p=t===u-1?d%a.rowPerImg*a.charHeight:a.heightImg;m.src=o[t],m.onload=function(){return c.drawImage(m,0,0,e.widthImg,p,0,t*e.heightImg,e.widthImg,p),f(t+1)}};return h(0)})}},{key:"getCharSpace",value:function(e,t){return/[a-zA-Z0-9]/.test(e)?14*t/25:"("===e||")"===e?8*t/25:"-"===e?11*t/25:"."===e||":"===e?7:32===e.charCodeAt(0)||160===e.charCodeAt(0)||" "===e?t>>1:t}},{key:"getLeftMargin",value:function(e,t){return/[a-zA-Z0-9\.\)]/.test(e)?0:"("===e||":"===e?-(4*t/25):"-"===e?-(t/25):6*t/25}}]),e}();e["default"]=l,l.defaultWidth=void 0,l.defaultHeight=void 0,l.fontImage=void 0,l.fontChars="",l.fontFamily="",l.charWidth=25,l.charHeight=25,l.countPerRow=40,l.rowPerImg=20,l.widthImg=1e3,l.heightImg=500}),require.register("js/common/OtherWap.js",function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=t("spark-md5"),l=o(s),c=t("./Utils.js"),u=o(c),d=t("./XmlHttpRequest.js"),h=a(d),f=t("./Dialog.js"),m=o(f),p=function(){function e(){r(this,e)}return i(e,null,[{key:"initQHSdk",value:function(){var e=function(e){return new Promise(function(t,n){var a=document.getElementsByTagName("head").item(0),o=document.createElement("script");o.type="text/javascript",o.src=e,a.appendChild(o),o.onload=function(){return t("QHSKD INIT SUCCESS")}})};return e("//port.2r3r.com/game/qhjssdk").then(function(e){var t={username:flashvars.qh_username,gid:flashvars.qh_qhgid,qhchannel:flashvars.qh_qhchannel,qhchannelid:flashvars.qh_qhchannelid};return window.qhsdk.init(t),Promise.resolve(e)})}},{key:"pay",value:function(e,t,n,a,o,r,i){var s=l["default"].hash(e.toString()+flashvars.qh_username+n+flashvars.qh_key),c={userId:flashvars.qh_username,gid:flashvars.qh_qhgid,goodsId:t,goodsName:e+"闪币",money:e,roleName:"3000闪艺",ext:n,serverId:flashvars.qh_serverid,sign:s};1===r&&(o.payValues[0].name=encodeURI(o.payValues[0].name));var d={game_id:flashvars.gid,uuid:flashvars.uuid,chapter_uuid:a,amount:e,set_value:0===r?"":u["default"].encodeBase64(JSON.stringify(o.payValues)),payindex:r,ext:n,event_id:t,qh_username:flashvars.qh_username,qh_qhgid:flashvars.qh_qhgid},f=function(e,t){h.xhrSend(e,t,null,4e3).then(function(e){},function(e){})};f("https://pay.3000.com/qunhei/paydata.php",JSON.stringify(d)),window.qhsdk.pay(c,function(){console.log("群黑充值返回")}),u["default"].timeout(200).then(function(){0===r?m["default"].custom("Info","如果购买成功则点击继续观看作品，如果暂不购买则不能继续。","是否支付成功？","已支付成功","暂不购买",!1).then(function(){i&&i("success")},function(){i&&i("cancel")}):m["default"].custom("Info","若已支付成功，作品将会刷新，可读取存档继续观看。若暂不购买，将返回商城。","是否支付成功？","已支付成功","暂不购买",!1).then(function(){window.location.reload()},function(){i&&i()})})}},{key:"sendQHData",value:function(){var e=function(e,t){return h.xhrSend(e,t,null,4e3).then(function(e){if(0===e.responseText.length)return Promise.reject("Get failed, no response data");var t=JSON.parse(e.responseText);return 0===t.status&&t.success===!0&&t.data?(flashvars.uid=t.data.uid,flashvars.token=t.data.token,flashvars.u=t.data.u,Promise.resolve()):void 0},function(e){})},t={qh_username:flashvars.qh_username,qh_serverid:flashvars.qh_serverid,qh_time:flashvars.qh_time,qh_isadult:flashvars.qh_isadult,qh_flag:flashvars.qh_flag,qh_uid:flashvars.qh_uid,qh_nname:u["default"].encodeBase64(flashvars.qh_nname),qh_qhchannel:flashvars.qh_qhchannel,qh_qhchannelid:flashvars.qh_qhchannelid,refresh_token:1};return e("https://ptlogin.3000.com/?m=ptlogin&ac=qhlogin",JSON.stringify(t))}}]),e}();e["default"]=p}),require.register("js/common/PhoneUtils.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"loadAudioUrl",value:function(e){function t(t,n,a){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,n){if(this.loadingAudioMap[e]=!0,this.audioErrorResourceRef[e]=0,"ios"===flashvars.client){var a={key:e,url:t,local:n};this.audioCountLoadByPhone.total++,"1"===flashvars.offline?loadAudioUrl(JSON.stringify(a)):window.webkit&&window.webkit.messageHandlers.loadAudioUrl.postMessage(JSON.stringify(a))}})},{key:"playMusic",value:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=e?e:this.musicKey,r=t||0===t?t:1,i=void 0===n||null===n||n;this.musicInfo.key=o,this.musicInfo.volume=r*a,this.musicInfo.prevolume=r,this.musicInfo.inheritvolume=-1,this.musicInfo.tweenId=parseInt(100*Math.random()),this.playAudioUrl(o,r,i,"music",a)}},{key:"stopMusic",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.stopAudioUrl("music"),e&&(this.musicInfo.key="")}},{key:"playInheritMusic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.musicInfo.inheritvolume=e,this.setAudioUrlVolume("music",e*t)}},{key:"tweenFromMusic",value:function(e,t,n){var a=this;return new Promise(function(o,r){if(t<=10)return a.musicInfo.volume=e,a.setAudioUrlVolume("music",e),o();var i=t/20,s=(a.musicInfo.volume-e)/i,l=e;a.musicInfo.tweenId=parseInt(100*Math.random());var c=a.musicInfo.tweenId,u=function d(){var t=a;return function(){return(t.musicInfo.volume>l&&s>0||t.musicInfo.volume<l&&s<0)&&c===t.musicInfo.tweenId?(l+=s,l>1?l=1:l<0&&(l=0),t.setAudioUrlVolume("music",l),t.musicInfo.volume=l,setTimeout(d(),20),void 0):(t.musicInfo.volume=e,t.musicInfo.prevolume=e,o())}};setTimeout(u(),n)})}},{key:"tweenToMusic",value:function(e,t,n){var a=this;return new Promise(function(o,r){if(t<=10)return a.musicInfo.volume=e,a.setAudioUrlVolume("music",e),o();var i=t/20,s=(e-a.musicInfo.volume)/i,l=a.musicInfo.volume;a.musicInfo.tweenId=parseInt(100*Math.random());var c=a.musicInfo.tweenId,u=function d(){var t=a;return function(){return(l>e&&s<0||l<e&&s>0)&&c===t.musicInfo.tweenId?(l+=s,l<0?l=0:l>1&&(l=1),t.setAudioUrlVolume("music",l),t.musicInfo.volume=l,setTimeout(d(),20),void 0):(t.musicInfo.volume=e,t.musicInfo.prevolume=e,o())}};setTimeout(u(),n)})}},{key:"tweenToSound",value:function(e,t,n,a){var o=this;return new Promise(function(r,i){if(!o.soundsInfo[e].key)return r();if(n<=10)return o.soundsInfo[e].volume=t,o.setAudioUrlVolume("sound"+e,t),r();var s=n/20,l=(t-o.soundsInfo[e].volume)/s,c=o.soundsInfo[e].volume;o.soundsInfo[e].tweenId=parseInt(100*Math.random());var u=o.soundsInfo[e].tweenId,d=function h(){var n=o;return function(){return(c>t&&l<0||c<t&&l>0)&&u===n.soundsInfo[e].tweenId?(c+=l,c<0?c=0:c>1&&(c=1),n.setAudioUrlVolume("sound"+e,c),n.soundsInfo[e].volume=c,setTimeout(h(),20),void 0):(n.soundsInfo[e].volume=t,n.soundsInfo[e].prevolume=t,r())}};setTimeout(d(),a)})}},{key:"stopSound",value:function(e){if(e===-1)for(var t=0;t<this.soundsInfo.length;t++){var n=this.soundsInfo[t];n&&n.key&&this.stopAudioUrl("sound"+t)}else{var a=this.soundsInfo[e].key;a&&this.stopAudioUrl("sound"+e),this.soundsInfo[e].key=""}}},{key:"playSound",value:function(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,r=t?t:this.soundsInfo[e].key,i=n||0===n?n:1,s=void 0===a||null===a||a;this.soundsInfo[e].key=r,this.soundsInfo[e].volume=i*o,this.soundsInfo[e].loop=s,this.soundsInfo[e].prevolume=i,this.soundsInfo[e].inheritvolume=-1,this.soundsInfo[e].tweenId=parseInt(100*Math.random()),this.playAudioUrl(r,i,s,"sound"+e,o)}},{key:"playInheritSound",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.soundsInfo[e].inheritvolume=t,this.setAudioUrlVolume("sound"+e,t*n)}},{key:"playAudioUrl",value:function(e){function t(t,n,a,o){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if("ios"===flashvars.client){var r={key:e,volume:t*o,loop:n?1:0,channel:a};1==flashvars.offline?playAudioUrl(JSON.stringify(r)):window.webkit&&window.webkit.messageHandlers.playAudioUrl.postMessage(JSON.stringify(r))}})},{key:"stopAudioUrl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if("ios"===flashvars.client){var t={channel:e};1==flashvars.offline?stopAudioUrl(JSON.stringify(t)):window.webkit&&window.webkit.messageHandlers.stopAudioUrl.postMessage(JSON.stringify(t))}})},{key:"updateMusicVolume",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.musicInfo){var n=void 0!==this.musicInfo.inheritvolume&&this.musicInfo.inheritvolume!==-1?this.musicInfo.inheritvolume*t:this.musicInfo.prevolume*t;this.setAudioUrlVolume(e,n)}}},{key:"updateSoundVolume",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.soundsInfo&&this.soundsInfo.length>0)for(var n=0;n<this.soundsInfo.length;n++){var a=this.soundsInfo[n];if(a){var o=void 0!==a.inheritvolume&&a.inheritvolume!==-1?a.inheritvolume*t:a.prevolume*t;this.setAudioUrlVolume(e+n,o)}}}},{key:"setAudioUrlVolume",value:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){if("ios"===flashvars.client){var n={channel:e,volume:t};n.volume||0===n.volume||(n.volume=1),"music"===e&&(this.musicInfo.volume=n.volume),"1"===flashvars.offline?setAudioUrlVolume(JSON.stringify(n)):window.webkit&&window.webkit.messageHandlers.setAudioUrlVolume.postMessage(JSON.stringify(n))}})},{key:"removeAudioUrl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if(e!==this.musicInfo.key&&!this.soundsInfo.some(function(t){return e===t})){var t={key:e};this.audioResourceRef[e]=0,1==flashvars.offline?removeAudioUrl(JSON.stringify(t)):window.webkit&&window.webkit.messageHandlers.removeAudioUrl.postMessage(JSON.stringify(t))}})},{key:"isAudioInCache",value:function(e){return!!this.audioResourceRef[e]}},{key:"isAudioError",value:function(e){return!!this.audioErrorResourceRef[e]}},{key:"isLoadingAudio",value:function(e){return!!this.loadingAudioMap[e]}},{key:"audioCanPlayCallBack",value:function(e){delete this.loadingAudioMap[e],this.audioCountLoadByPhone.loaded++,this.load.onSoundExtendLoad.dispatch(e),this.audioResourceRef[e]=1}},{key:"audioErrorCallBack",value:function(e){delete this.loadingAudioMap[e],this.audioCountLoadByPhone.loaded++,this.load.onSoundExtendLoadError.dispatch(e),this.audioResourceRef[e]=0,this.audioErrorResourceRef[e]=1}}]),e}();e["default"]=r,r.loadingAudioMap={},r.audioCountLoadByPhone={loaded:0,total:0},r.load=null,r.musicInfo={key:"",volume:1,tweenId:0},r.soundsInfo=[{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0}],r.audioResourceRef=[],r.audioErrorResourceRef=[]}),require.register("js/common/RePhaser.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t("./Utils.js"),s=a(i),l=function(){function e(){o(this,e)}return r(e,null,[{key:"updateText",value:function(){this.texture.baseTexture.resolution=this._res,this.context.font=this.style.font;var e=this.text;this.style.wordWrap&&(e=this.runWordWrap(this.text),this.realText=e);var t=e.split(/(?:\r\n|\r|\n)/),n=this.style.tabs,a=[],o=0,r=this.determineFontProperties(this.style.font),i=t.length;this.style.maxLines>0&&this.style.maxLines<t.length&&(i=this.style.maxLines),this._charCount=0;for(var s=0;s<i;s++){if(0===n){var l=this.style.strokeThickness+this.padding.x;l+=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(t[s]):this.context.measureText(t[s]).width}else{var c=t[s].split(/(?:\t)/),l=this.padding.x+this.style.strokeThickness;if(Array.isArray(n))for(var u=0,d=0;d<c.length;d++){var h=0;h=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(c[d]):Math.ceil(this.context.measureText(c[d]).width),d>0&&(u+=n[d-1]),l=u+h}else for(var d=0;d<c.length;d++){l+=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(c[d]):Math.ceil(this.context.measureText(c[d]).width);var f=this.game.math.snapToCeil(l,n)-l;l+=f}}a[s]=Math.ceil(l),o=Math.max(o,a[s])}this.canvas.width=o*this._res;var m=r.fontSize+this.style.strokeThickness+this.padding.y,p=m*i,y=this._lineSpacing;0>y&&Math.abs(y)>m&&(y=-m),0!==y&&(p+=y>0?y*t.length:y*(t.length-1)),this.canvas.height=(p-4)*this._res,this.context.scale(this._res,this._res),navigator.isCocoonJS&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.style.backgroundColor&&(this.context.fillStyle=this.style.backgroundColor,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)),this.context.fillStyle=this.style.fill,this.context.font=this.style.font,this.context.strokeStyle=this.style.stroke,this.context.textBaseline="alphabetic",this.context.lineWidth=this.style.strokeThickness,this.context.lineCap="round",this.context.lineJoin="round";var g,v,s;for(this._charCount=0,s=0;i>s;s++)g=this.style.strokeThickness/2,v=this.style.strokeThickness/2+s*m+r.ascent,s>0&&(v+=y*s),"right"===this.style.align?g+=o-a[s]:"center"===this.style.align&&(g+=(o-a[s])/2),this.autoRound&&(g=Math.round(g),v=Math.round(v)),this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.updateLine(t[s],g,v):(this.style.stroke&&this.style.strokeThickness&&(this.updateShadow(this.style.shadowStroke),0===n?this.context.strokeText(t[s],g,v):this.renderTabLine(t[s],g,v,!1)),this.style.fill&&(this.updateShadow(this.style.shadowFill),0===n?this.context.fillText(t[s],g,v):this.renderTabLine(t[s],g,v,!0)));this.updateTexture()}},{key:"advancedWordWrap",value:function(e){for(var t=this.context,n=this.style.wordWrapWidth,a="",o=e.split(/\r?\n/gi),r=o.length,i=0;i<r;i++){var s=o[i],l=t.measureText(s).width;if(l<n)a+=s+"\n";else for(var c=function(e,t){if(!e||!t||/\s/.test(e)||/\s/.test(t))return!1;var n=/[\u4E00-\u9FA5\uF900-\uFA2D]|\s/,a=new RegExp("[!！)）|}':;',\\].>》/?……）\\-|}】‘；：”“’。，、？]"),o=new RegExp("[!！?？:：;；.。》』\\-\\]】）]");return n.test(e)&&a.test(t)||!n.test(e)&&!n.test(t)&&!o.test(e)},u=s;;){var d=-1,h="",f=t.measureText(u).width;if(!(f>n)){u&&(a+=u+"\n");break}for(var m=0;u[m]&&(h+=u[m],f=t.measureText(h).width,d=c(u[m-1],u[m])?d:m-1,m++,f<n););d!==-1&&d!==h.length-1?(h&&(h=h.slice(0,d+1)),u=u.substr(h.length).trimLeft()):(h&&(h=h.slice(0,-1)),u=u.substr(h.length).trimLeft()),a+=h+"\n"}}return a=a.replace(/\n$/gi,"")}},{key:"loadImageTag",value:function(e){var t=this,n=function(n){var a=n.requestObject.response,o=void 0;a instanceof ArrayBuffer&&(o=new Uint8Array(a));var r=!1;o[0]!=="G".charCodeAt()||o[1]!=="I".charCodeAt()||o[2]!=="F".charCodeAt()||o[3]!=="8".charCodeAt()||o[4]!=="9".charCodeAt()&&!"7".charCodeAt()||o[5]!=="a".charCodeAt()||(r=!0),e.data=new Image,e.data.name=e.key,t.crossOrigin&&(e.data.crossOrigin=t.crossOrigin);var i=function(){e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))};e.data.onload=function(){URL.revokeObjectURL(e.url),i()},e.data.onerror=function(){URL.revokeObjectURL(e.url),e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileError(e))},r?s["default"].spliceGif(a).then(function(n){e.data.frames=n.frames,e.data.loopCount=n.loopCount,e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)},function(){e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)}):(e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)),e.data.complete&&e.data.width&&e.data.height&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))};this.xhrLoad(e,this.transformUrl(e.url,e),"arraybuffer",n)}},{key:"soundStop",value:function(){var e=this;if(this.isPlaying&&this._sound)if(this.usingWebAudio){if(this.externalNode){var t=this._sound.onended;this._sound.onended=function(){e._sound.disconnect(e.externalNode),t&&t()}}else if(this.gainNode){var n=this._sound.onended;this._sound.onended=function(){e._sound.disconnect(e.gainNode),n&&n()}}if(void 0===this._sound.stop)this._sound.noteOff(0);else try{this._sound.stop(0)}catch(a){alert(a)}}else this.usingAudioTag&&(this._sound.pause(),this._sound.currentTime=0);if(this.pendingPlayback=!1,this.isPlaying=!1,!this.paused){var o=this.currentMarker;""!==this.currentMarker&&this.onMarkerComplete.dispatch(this.currentMarker,this),this.currentMarker="",null!==this.fadeTween&&this.fadeTween.stop(),this.onStop.dispatch(this,o)}}},{key:"soundDecode",value:function(e,t){var n=this;t=t||null;var a=this.game.cache.getSoundData(e);if(a&&this.game.cache.isSoundDecoded(e)===!1){this.game.cache.updateSound(e,"isDecoding",!0);var o=this,r=function(){n.onSoundDecodeError.dispatch(e),console.warn("Unable to encode audio "+e)};try{this.context.decodeAudioData(a,function(n){n&&(o.game.cache.decodedSound(e,n),o.onSoundDecode.dispatch(e,t))})["catch"](r)}catch(i){r()}}}},{key:"loadAudioTag",value:function(e){var t=this,n=e.url;n.indexOf("?")>=0&&(n=n.substr(0,n.indexOf("?")));var a=n.substr((Math.max(0,n.lastIndexOf("."))||1/0)+1),o="dat"===a.toLowerCase(),r=function(e){if(t.game.sound.touchLocked)e.data=i.AudioTagPool.get(),e.data.name=e.key,e.data.src=t.transformUrl(e.url,e),t.fileComplete(e);else{var n=i.AudioTagPool.get();if(e.data=n,e.data.name=e.key,!i.AudioTagPool.exist(n))return t.game.sound.touchLocked=!0,e.data.src=t.transformUrl(e.url,e),void t.fileComplete(e);var a=function o(){e.data.removeEventListener("canplaythrough",o,!1),e.data.onerror=null,t.fileComplete(e)};e.data.onerror=function(){e.data.removeEventListener("canplaythrough",a,!1),e.data.onerror=null,t.fileComplete(e)},e.data.src=t.transformUrl(e.url,e),e.data.addEventListener("canplaythrough",a,!1),e.data.load()}},s=function(e){return t.game.device.android?void r(e):void t.xhrLoad(e,t.transformUrl(e.url,e),"arraybuffer",function(e,t){e.url=URL.createObjectURL(new Blob([t.response],{type:"audio/mp3"})),e.isDatFile=!0,r(e)})};o?s(e):r(e)}},{key:"tintWithMultiply",value:function(e,t,n){var a=n.getContext("2d"),o=e.crop,r=o.width,i=o.height;e.rotated&&(r=i,i=o.width),n.width===r&&n.height===i||(n.width=r,n.height=i),a.clearRect(0,0,r,i),a.drawImage(e.baseTexture.source,o.x,o.y,r,i,0,0,r,i),a.globalCompositeOperation="source-atop",a.fillStyle="#"+("00000"+(0|t).toString(16)).substr(-6),a.fillRect(0,0,r,i)}}]),e}();e["default"]=l,function(){PIXI.CanvasTinter.tintWithMultiply=l.tintWithMultiply,Phaser.Game.prototype.destroyComponent=new Phaser.Signal;var e=Phaser.Sprite.prototype.destroy;Phaser.Sprite.prototype.destroy=function(){var t=this.game;e.apply(this,arguments),t&&t.destroyComponent&&t.destroyComponent.dispatch(this.key||null)};var t=Phaser.Sprite.prototype._renderCanvas;Phaser.Sprite.prototype._renderCanvas=function(){try{t.apply(this,arguments)}catch(e){}};var n=Phaser.Image.prototype.destroy;Phaser.Image.prototype.destroy=function(){var e=this.game;n.apply(this,arguments),e&&e.destroyComponent&&e.destroyComponent.dispatch(this.key||null)};var a=Phaser.Button.prototype.destroy;Phaser.Button.prototype.destroy=function(){var e=this;Object.keys(this).forEach(function(t){e.hasOwnProperty(t)&&e[t]instanceof Phaser.Sound&&e[t].destroy()}),a.apply(this,arguments)};var o=new Set;Phaser.Loader.prototype.forceRemoveFile=function(e,t){var n=this,a=this.getAsset(e,t);if(a)if(a.loaded||a.loading){forceRemoveFileKeys.add(t);var r=function(){o.has(t)&&("audio"===e&&n.cache.checkSoundKey(t)&&n.cache.removeSound(t),"image"===e&&n.cache.checkImageKey(t)&&n.cache.removeImage(t),o["delete"](t))},i=function s(e,a,o,i,l){a==t&&(r(),n.onFileComplete.remove(s))};a.loaded&&r(),a.loading&&this.onFileComplete.add(i)}else this._fileList.splice(a.index,1)},Phaser.Loader.prototype.cancelForceRemoveFile=function(e,t){o["delete"](t)},Phaser.Loader.prototype.loadAudioTag=l.loadAudioTag;var r=Phaser.Sound.prototype.destroy;Phaser.Sound.prototype.destroy=function(){if(r.apply(this,arguments),this.usingWebAudio){this.game.sound.context&&!this.game.sound.scratchBuffer&&(this.game.sound.scratchBuffer=this.game.sound.context.createBuffer(1,1,22050));try{this._sound.buffer=this.game.sound.scratchBuffer}catch(e){}}this._sound=null},Phaser.Cache.prototype.reloadSound=function(e){var t=this,n=this.getSound(e);if(n&&!i.AudioTagPool.exist(n.data)){var a=i.AudioTagPool.get();if(!i.AudioTagPool.exist(a))return;n.data=a,n.data.src=n.url,n.data.addEventListener("canplaythrough",function(){
return t.reloadSoundComplete(e)},!1),n.data.load()}},Phaser.Device.canPlayAudio=function(e){return!("mp3"!==e||!this.mp3)||(!("ogg"!==e||!this.ogg&&!this.opus)||(!("m4a"!==e||!this.m4a)||(!("opus"!==e||!this.opus)||(!("wav"!==e||!this.wav)||(!("webm"!==e||!this.webm)||(!("mp4"!==e||!this.dolby)||"dat"===e))))))},Phaser.SoundManager.prototype.setMute=function(){if(!this._muted){this._muted=!0,this.usingWebAudio&&(this._muteVolume=this.masterGain.gain.value,this.masterGain.gain.value=0);for(var e=0;e<this._sounds.length;e++)this._sounds[e].usingAudioTag&&(this.game.device.iOS&&this._sounds[e].pause(),this._sounds[e].mute=!0);this.onMute.dispatch()}},Phaser.SoundManager.prototype.unsetMute=function(){if(this._muted&&!this._codeMuted){this._muted=!1,this.usingWebAudio&&(this.masterGain.gain.value=this._muteVolume);for(var e=0;e<this._sounds.length;e++)this._sounds[e].usingAudioTag&&(this.game.device.iOS&&this._sounds[e].resume(),this._sounds[e].mute=!1);this.onUnMute.dispatch()}}}()}),require.register("js/common/ShanyiMenu.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"showSyMenu",value:function(){!this.isShow&&(this.isShow=!0);var e=this;return new Promise(function(t,n){var a=function(){document.body.removeChild(r),e.isShow=!1,t(1)},o=function(n){document.body.removeChild(r),e.isShow=!1,t(n)};gameCallback.syMenuBack=a,gameCallback.syMenuExit=o;var r=document.createElement("div");r.classList.add("syModalContainer");var i=document.createElement("div");i.classList.add("syModalPortal"),document.body.clientWidth<=document.body.clientHeight&&(i.style.transform=flashvars.vertical?"rotate(0)":"rotate(90deg)"),window.onresize=function(){document.body.clientWidth<=document.body.clientHeight?i.style.transform=flashvars.vertical?"rotate(0)":"rotate(90deg)":i.style.transform=flashvars.vertical?"rotate(90deg)":"rotate(0)"},r.appendChild(i);var s=document.createElement("div");s.classList.add("syContent"),i.appendChild(s),flashvars.vertical&&(s.style.width="320px",s.style.height="510px");var l=document.createElement("iframe");l.src="https://www.3000.com/popup.html?uuid="+flashvars.uuid+"&wap="+flashvars.wap+"&vertical="+(flashvars.vertical?1:0),l.scrolling="no",l.width="100%",l.height="100%",l.frameBorder="0",s.appendChild(l),document.body.appendChild(r)})}}]),e}();e["default"]=r}),require.register("js/common/Utils.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e,t){var n={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(n[a]=e[a]);return n}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.AudioTagPool=e.ResourcesManager=void 0;var l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),u=t("./XmlHttpRequest.js"),d=o(u),h=t("./Version.js"),f=(a(h),t("js-base64")),m=t("crypto-js"),p=a(m),y=t("spark-md5"),g=a(y),v=t("./PhoneUtils.js"),x=a(v),P=function(){function e(){s(this,e)}return c(e,null,[{key:"getWeatherFilePathName",value:function(e){return flashvars.vertical?e+"_1":e}},{key:"getWeatherOfflinePathName",value:function(){return"1"===flashvars.offline,"weather"}},{key:"convertToAllowAccessControlOriginUrl",value:function(e){if(!e)return Promise.resolve("");if("http://f1.img4399.com/ma~217_20160518155234_573c1f42bb260.jpeg"===e)return Promise.resolve("https://apppic.3000test.com/m~web/41/2017/02/08/09_j1sGyq.960x540.jpg");if("/"===e[0]&&(e=e.substring(1)),/blob:/i.test(e))return Promise.reject(e);var t=void 0,n=e.indexOf("://");if(n>-1){var a=e.split("/");a.shift(),a.shift(),a.shift(),t="https://apppic.3000test.com/"+a.join("/")}else t="https://apppic.3000test.com/"+e;return"1"===flashvars.offline&&(t="game"+flashvars.gid+"/"+t.substring(28)),Promise.resolve(t)}},{key:"spliceGif",value:function(e){var t=this;return new Promise(function(n,a){var o=void 0,r=0,s=void 0,l=document.createElement("canvas"),c=document.createElement("canvas"),u=void 0,d=void 0,h=null,f=null,m=null,p=null,y=null,g=1,v=[],x=function(e){return e.reduce(function(e,t){return 2*e+t},0)},P=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},w=function(e){o=e,r=0,this.readByte=function(){if(r>=e.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[r++]:255&e.charCodeAt(r++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},k=function(e,t){var n=0,a=function(e){for(var a=0,o=0;o<e;o++)t[n>>3]&1<<(7&n)&&(a|=1<<o),n++;return a},o=1<<e,r=o+1,i=e+1,s=4096,l=4096,c=new Uint8Array(s),u=new Uint8Array(l),d=[],h=0,f=0,m=function(){for(var e=0;e<o;e++)d[e]=new Uint8Array(1),d[e][0]=e;d[o]=new Uint8Array(0),d[r]=null},p=function(){var t=o+2;d.splice(t,d.length-t),i=e+1,h=0},y=function(){var e=c.length+s,t=new Uint8Array(e);t.set(c),c=t,s<<=1},g=function(){var e=u.length+l,t=new Uint8Array(e);t.set(u),u=t,l<<=1},v=function(e,t){for(var n=d[t].byteLength+1;h+n>u.length;)g();var a=u.subarray(h,h+n);a.set(d[t]),a[n-1]=d[e][0],h+=n,d.push(a)},x=void 0,P=void 0;for(m();;)if(P=x,x=a(i),x!==o){if(x===r)break;if(x<d.length)P!==o&&v(x,P);else{if(x!==d.length)throw new Error("Invalid LZW code.");v(P,P)}for(var w=d[x].length;f+w>c.length;)y();c.set(d[x],f),f+=w,d.length===1<<i&&i<12&&i++}else p();return c.subarray(0,f)},b=function(e,t){l.width=e,l.height=t,l.style.width=e+"px",l.style.height=t+"px",l.getContext("2d").setTransform(1,0,0,1,0,0),c.width=e,c.height=e},C=function(){h=null,f=null,d=m,m=null,u=null},_=function(e){s=e,b(s.width,s.height)},S=function(e){I(),C(),h=e.transparencyGiven?e.transparencyIndex:null,f=e.delayTime,m=e.disposalMethod},I=function(){if(u){var e=l.toDataURL("image/png"),n=t.dataURLtoBlob(e);v.push({blobUrl:n?URL.createObjectURL(n):e,delay:Math.max(f,10)})}},L=function(e){u||(u=l.getContext("2d"));var t=v.length,n=e.lctFlag?e.lct:s.gct;t>0&&(3===d?null!==p?v[p].data&&u.putImageData(v[p].data,0,0):u.clearRect(y.leftPos,y.topPos,y.width,y.height):p=t-1,2===d&&u.clearRect(y.leftPos,y.topPos,y.width,y.height));for(var a=u.getImageData(e.leftPos,e.topPos,e.width,e.height),o=0;o<e.pixels.length;o++){var r=e.pixels[o];if(r!==h){var i=n[r],c=4*o;a.data[c]=i[0],a.data[c+1]=i[1],a.data[c+2]=i[2],a.data[c+3]=255}}u.putImageData(a,e.leftPos,e.topPos),y=e},E=function(){},M=function(e){g=e.iterations},T={hdr:_,gce:S,com:E,app:{NETSCAPE:M},img:L,eof:function(){I()}},O=function(e,t){t||(t={});var a=function(t){for(var n=[],a=0;a<t;a++)n.push(e.readBytes(3));return n},o=function(){var t=void 0,n=void 0,a=0,o=8192;n=new Uint8Array(o);var r=function(){var e=new Uint8Array(n.length+o);e.set(n),n=e};do{for(t=e.readByte();a+t>n.length;)r();n.set(e.readBytes(t),a),a+=t}while(0!==t);return n.subarray(0,a)},r=function(){var n={};if(n.sig=e.read(3),n.ver=e.read(3),"GIF"!==n.sig)throw new Error("Not a GIF file.");n.width=e.readUnsigned(),n.height=e.readUnsigned();var o=P(e.readByte());n.gctFlag=o.shift(),n.colorRes=x(o.splice(0,3)),n.sorted=o.shift(),n.gctSize=x(o.splice(0,3)),n.bgColor=e.readByte(),n.pixelAspectRatio=e.readByte(),n.gctFlag&&(n.gct=a(1<<n.gctSize+1)),t.hdr&&t.hdr(n)},s=function(n){var a=function(n){var a=(e.readByte(),P(e.readByte()));n.reserved=a.splice(0,3),n.disposalMethod=x(a.splice(0,3)),n.userInput=a.shift(),n.transparencyGiven=a.shift(),n.delayTime=e.readUnsigned(),n.transparencyIndex=e.readByte(),n.terminator=e.readByte(),t.gce&&t.gce(n)},r=function(e){e.comment=o(),t.com&&t.com(e)},i=function(n){e.readByte();n.ptHeader=e.readBytes(12),n.ptData=o(),t.pte&&t.pte(n)},s=function(n){var a=function(n){e.readByte();n.unknown=e.readByte(),n.iterations=e.readUnsigned(),n.terminator=e.readByte(),t.app&&t.app.NETSCAPE&&t.app.NETSCAPE(n)},r=function(e){e.appData=o(),t.app&&t.app[e.identifier]&&t.app[e.identifier](e)};e.readByte();switch(n.identifier=e.read(8),n.authCode=e.read(3),n.identifier){case"NETSCAPE":a(n);break;default:r(n)}},l=function(e){e.data=o(),t.unknown&&t.unknown(e)};switch(n.label=e.readByte(),n.label){case 249:n.extType="gce",a(n);break;case 254:n.extType="com",r(n);break;case 1:n.extType="pte",i(n);break;case 255:n.extType="app",s(n);break;default:n.extType="unknown",l(n)}},l=function(n){var r=function(e,t){for(var n=new Array(e.length),a=e.length/t,o=function(a,o){var r,s=e.slice(o*t,(o+1)*t);n.splice.apply(n,(r=[a*t,t]).concat.apply(r,i(s)))},r=[0,4,2,1],s=[8,8,4,2],l=0,c=0;c<4;c++)for(var u=r[c];u<a;u+=s[c])o(u,l),l++;return n};n.leftPos=e.readUnsigned(),n.topPos=e.readUnsigned(),n.width=e.readUnsigned(),n.height=e.readUnsigned();var s=P(e.readByte());n.lctFlag=s.shift(),n.interlaced=s.shift(),n.sorted=s.shift(),n.reserved=s.splice(0,2),n.lctSize=x(s.splice(0,3)),n.lctFlag&&(n.lct=a(1<<n.lctSize+1)),n.lzwMinCodeSize=e.readByte();var l=o();n.pixels=k(n.lzwMinCodeSize,l),n.interlaced&&(n.pixels=r(n.pixels,n.width)),t.img&&t.img(n)},c=function d(){var a={};switch(a.sentinel=e.readByte(),String.fromCharCode(a.sentinel)){case"!":a.type="ext",s(a);break;case",":a.type="img",l(a);break;case";":a.type="eof",t.eof&&t.eof(a);break;default:throw new Error("Unknown block: 0x"+a.sentinel.toString(16))}"eof"!==a.type?setTimeout(d,0):n({loopCount:g,frames:v})},u=function(){r(),setTimeout(c,0)};u()};try{var A=new Uint8Array(e),V=new w(A);setTimeout(O(V,T),0)}catch(N){a(N),console.error("parseGIF ERROR!!"+N)}})}},{key:"isObject",value:function(e){return"[object Object]"===Object.prototype.toString.apply(e)}},{key:"fixColorValue",value:function(e){var t=e.match(/rgb\([\s]*(\d+)[\s]*,[\s]*(\d+)[\s]*,[\s]*(\d+)[\s]*\)/i),n=function(e){var t=parseInt(e,10).toString(16);return 2!==t.length?"0"+t:t};return t?e="#"+n(t[1])+n(t[2])+n(t[3]):(e&&"#"!==e[0]&&(e="#"+e),isNaN(parseInt(e.slice(1),16))&&(e="#ffffff"),e?e:"#ffffff")}},{key:"timeout",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=null,n=new Promise(function(n,a){return t=setTimeout(n,e)});return n.cancel=function(){return clearTimeout(t)},n}},{key:"getTimeOffset",value:function(){var e=this,t="https://my.3000.com/?m=timestamp&op=index&ac=get&api_v=1.0.0&api_from=webpc";return d.xhrGetServerTime(t).then(function(t){if(0===t.responseText.length)return Promise.reject("Get file failed, no response data");var n=JSON.parse(t.responseText);return 0===n.status?(e.timeStamp=n.data.timestamp,e.timeOffset=e.timeStamp-e.curLocalTime(),Promise.resolve(e.timeOffset)):Promise.reject(n.msg+": "+n.status)},function(e){return Promise.reject(e)})}},{key:"localUpdateTime",value:function(){e.localTime===-1&&(e.localTime=this.curLocalTime()),setInterval(function(){e.localTime++},1e3)}},{key:"curLocalTime",value:function(){return Math.floor((new Date).getTime()/1e3)}},{key:"updateContextTimeValues",value:function(t){if(-1!==this.timeStamp){t.systemValues[2].value=e.localTime+this.timeOffset;var n=new Date(1e3*t.systemValues[2].value);t.systemValues[3].value=n.getFullYear(),t.systemValues[4].value=n.getMonth()+1,t.systemValues[5].value=n.getDate(),t.systemValues[6].value=n.getHours(),t.systemValues[7].value=n.getMinutes(),t.systemValues[8].value=n.getSeconds(),t.systemValues[10].value=n.getDay()}}},{key:"getCurrentDateTime",value:function(e){var t=new Date(e),n="-",a=":",o=function(e,t,n){return e>=n&&e<=t?"0"+e:""+e},r=t.getFullYear()+n+o(t.getMonth()+1,9,1)+n+o(t.getDate(),9,0)+" "+o(t.getHours(),9,0)+a+o(t.getMinutes(),9,0)+a+o(t.getSeconds(),9,0);return r}},{key:"createBlob",value:function(e,t){var n=void 0,a=void 0;try{return new Blob([e])}catch(o){if(n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)return a=new n,a.append(e),a.getBlob(t);throw new Error("Unable to create blob")}}},{key:"dataURLtoBlob",value:function(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]),o=a.length,r=new Uint8Array(o);o--;)r[o]=a.charCodeAt(o);var i=null;try{i=new Blob([r],{type:n})}catch(s){console.error(s.name+"  "+s.message)}return i}},{key:"encodeBase64",value:function(e){return""===e?"":f.Base64.encode(e)}},{key:"decryptBase64",value:function(e){return""===e?"":f.Base64.decode(e)}},{key:"aesEncrypt",value:function(e,t){if(""===e)return"";var n="de3kt|jq|fdcgj_|",a="ff_|pf|#%@fw_j+q";1===t?(n="WDF#$H*#SJN*&G$&",a="JH&$GF$DR%*K@SC%"):2===t?(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf"):3===t&&(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf");var o=p["default"].enc.Utf8.parse(n),r=p["default"].enc.Utf8.parse(a),i=p["default"].AES.encrypt(e+"",o,{iv:r,mode:p["default"].mode.CBC,padding:p["default"].pad.ZeroPadding}),s=i.toString();return s}},{key:"aesDecrypt",value:function(e,t){if(""===e)return"";var n="de3kt|jq|fdcgj_|",a="ff_|pf|#%@fw_j+q";1===t?(n="WDF#$H*#SJN*&G$&",a="JH&$GF$DR%*K@SC%"):2===t?(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf"):4===t&&(n="xiamenshanyi4399",a="");var o=p["default"].enc.Utf8.parse(n),r=p["default"].enc.Utf8.parse(a),i=p["default"].AES.decrypt(e,o,{iv:r,mode:4!==t?p["default"].mode.CBC:p["default"].mode.ECB,padding:p["default"].pad.ZeroPadding}),s=i.toString(p["default"].enc.Utf8);return s}},{key:"getCookie",value:function(e){var t=void 0,n=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(n))?decodeURI(t[2]):null}},{key:"getUidByCookie",value:function(){var e=this.getCookie("SYPauth");if(e){var t=e.indexOf("|");e=e.substring(0,t)}return e?e:""}},{key:"generateUUID",value:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)});return t}},{key:"localStorageGetItem",value:function(e){if(flashvars.app_version<"1.2.0")return window.localStorage.getItem(e);if("android"===flashvars.client&&window.app){var t=window.app.localStorage_getItem(e);return""===t?null:t}if("ios"===flashvars.client){var n=null;return n="1"===flashvars.offline?localStorage_getItem(e):window.localStorage.getItem(e),""===n&&(n=null),n}return""===flashvars.client?window.localStorage.getItem(e):null}},{key:"localStorageSetItem",value:function(e,t){if(flashvars.app_version<"1.2.0")return void window.localStorage.setItem(e,t);if("android"===flashvars.client)window.app&&window.app.localStorage_setItem(e,t);else if("ios"===flashvars.client){var n={key:e,value:t};"1"===flashvars.offline?localStorage_setItem(JSON.stringify(n)):(window.webkit&&window.webkit.messageHandlers.localStorage_setItem.postMessage(JSON.stringify(n)),window.localStorage.setItem(e,t))}else window.localStorage.setItem(e,t)}},{key:"localStorageRemoveItem",value:function(e){return flashvars.app_version<"1.2.0"?void window.localStorage.removeItem(e):void("android"===flashvars.client?window.app&&window.app.removeLocalStorage(e):"ios"===flashvars.client?"1"===flashvars.offline?removeLocalStorage(e):(window.webkit&&window.webkit.messageHandlers.removeLocalStorage.postMessage(e),window.localStorage.removeItem(e)):window.localStorage.removeItem(e))}},{key:"localStorageClear",value:function(){window.localStorage.clear()}},{key:"getSensitiveWords",value:function(){var t=this,n="https://mapi.3000api.com/apis/soft/v1.0/game-GetSensitiveStr.html",a="action=all";return d.xhrSend(n,a).then(function(n){if(0===n.responseText.length)return Promise.reject("getSensitiveWords failed, no response data");var a=JSON.parse(n.responseText);if(100==a.code){if("[object Array]"==Object.prototype.toString.call(a.result))t.sensitiveWords=a.result.concat();else{var o=JSON.parse(e.aesDecrypt(a.result,4));t.sensitiveWords=o.concat()}return Promise.resolve()}return Promise.reject()},function(e){return Promise.reject(e)})}},{key:"getDeviceId",value:function(){if("android"===flashvars.client){var e=navigator.userAgent.match(/[0-9A-Za-z]{8}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{12}/g);return e?e[0]:""}if("ios"===flashvars.client){var t=navigator.userAgent.match(/[0-9A-Za-z]{40}/g);return t?t[0]:""}return""}},{key:"formatNum",value:function(e){return 0===e?"00000":e<10?"0000"+e:e<100?"000"+e:"00"+e}},{key:"sendStatistics",value:function(){if("android"!==flashvars.client&&"ios"!==flashvars.client)return Promise.resolve();var e=this.getDeviceId(),t=Math.floor((new Date).getTime()/1e3)+this.timeOffset,n="mac_name="+e+"&time="+t+"&uid="+flashvars.uid+"&v_key=shanyi_WDF#$H*#SJN*&G$&**";n=this.aesEncrypt(g["default"].hash(g["default"].hash(n)),1),t=this.aesEncrypt(t,1);var a="https://app.3000.com/?m=statistics&op=start&ac=h5&v="+flashvars.v+"&client="+flashvars.client,o="mac_name="+encodeURIComponent(this.aesEncrypt(e,1))+"&uid="+encodeURIComponent(this.aesEncrypt(flashvars.uid,1))+"&sign="+encodeURIComponent(n)+"&time="+encodeURIComponent(t);return d.xhrSend(a,o)}},{key:"sendSelOptions",value:function(){var e=this,t=function(){if(0===e.selOptions.length)return setTimeout(n(),3e4),Promise.resolve();var t="https://www.3000.com/apis/client/v1.0/trace-optionClick.html?",a="from=h5&uuid="+flashvars.uuid+"&optionid="+JSON.stringify(e.selOptions);return d.xhrLoad(t+a,"").then(function(){return e.selOptions.splice(0,e.selOptions.length),setTimeout(n(),3e4),Promise.resolve()},function(){return setTimeout(n(),3e4),Promise.reject()})},n=function(){return function(){t()}};setTimeout(n(),3e4)}},{key:"searchChapterByUUID",value:function(e,t){for(var n=function r(e){if(e.uuid===t)return e;for(var n=0;n<e.subchapters.length;++n){var a=r(e.subchapters[n]);if(a)return a}},a=null,o=0;o<e.chapters.length;++o)if(a=n(e.chapters[o]))return a;return a}}]),e}();e["default"]=P,P.timeStamp=-1,P.timeOffset=0,P.sensitiveWords=[],P.selOptions=[],P.soundVolume=1,P.musicVolume=1,P.localTime=-1;var w=function(){function e(){s(this,e),this.gifList=[],this.imgList=[]}return c(e,[{key:"popGif",value:function(){var e=this.gifList.findIndex(function(e){return 1===k.getCount("img",e.key)});if(~e){var t=this.gifList[e].key;this.gifList.splice(e,1),k.removeFromCache("img",t,!0)}}},{key:"popImg",value:function(){var e=this.imgList.findIndex(function(e){return 1===k.getCount("img",e.key)});if(~e){var t=this.imgList[e].key;this.imgList.splice(e,1),k.removeFromCache("img",t,!0)}}},{key:"push",value:function(e,t){t?(this.gifList.push({key:e,timestamp:Date.now()}),k.addRefCount("img",e,"cache"),this.gifList.length>20&&this.popGif()):(this.imgList.push({key:e,timestamp:Date.now()}),k.addRefCount("img",e,"cache"),this.imgList.length>100&&this.popImg())}}]),e}(),k=e.ResourcesManager=function(){function e(){s(this,e)}return c(e,null,[{key:"pushInLoader",value:function(e,t,n,a){var o=this,r=n||e;return!("img"===t&&this.cache.checkImageKey(r)||"audio"===t&&this.cache.checkSoundKey(r))||"ios"===flashvars.client&&"audio"===t&&flashvars.app_version>="1.5.0"?P.convertToAllowAccessControlOriginUrl(e).then(function(e){if(!e)return!1;var n=!o.load.getAsset("img"===t?"image":"audio",r);if("img"===t)n&&o.load.image(r,e),!a&&o.addRefCount("img",r,"global");else if("audio"===t){var i=o.forceDecode.music===r||o.forceDecode.sounds.some(function(e){return e===r});if("ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var s=!x["default"].isAudioInCache(r)&&!x["default"].isLoadingAudio(r);return s&&x["default"].loadAudioUrl(r,e,flashvars.offline),s}n&&o.load.audio(r,e,i),!a&&o.addRefCount("audio",r,"global")}return n},function(e){return console.error("Invalid URL: "+e)}):Promise.resolve(!1)}},{key:"forEachReCount",value:function(e){var t=this;Object.keys(this.refCount.audio).forEach(function(n){return e&&e("audio",n,t.getCount("audio",n))}),Object.keys(this.refCount.img).forEach(function(n){return e&&e("img",n,t.getCount("img",n))})}},{key:"resetReCount",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];[this.refCount.img,this.refCount.audio].forEach(function(t,n){Object.keys(t).forEach(function(n){var a=t[n],o=a.global,r=void 0===o?0:o,i=a.cache,s=void 0===i?0:i,l={global:r,cache:s},c=Object.keys(t[n]);e.forEach(function(e){return c.forEach(function(t){return~t.indexOf(e)?l[t]=a[t]:void 0})}),t[n]=l})})}},{key:"updateRefTypePrefix",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];[this.refCount.img,this.refCount.audio].forEach(function(o,r){Object.keys(o).forEach(function(i){o.hasOwnProperty(i)&&Object.keys(o[i]).forEach(function(s){if(s.startsWith(e)){var l=s.replace(e,"");n&&l&&(o[i][l]=(o[i][l]||0)+(o[i][s]||0)),delete o[i][s],a&&t.removeFromCache(r?"audio":"img",i)}})})})}},{key:"transferRefCount",value:function(e,t,n,a,o){this.refCount[e][a]=this.refCount[e][a]||{},this.refCount[e][a][o]=this.refCount[e][a][o]||0,this.refCount[e][t]&&(this.refCount[e][a][o]+=this.refCount[e][t][n],this.refCount[e][t][n]=0,this.removeFromCache(e,t))}},{key:"transferByRefCount",value:function(e,t){[this.refCount.img,this.refCount.audio].forEach(function(n){Object.keys(n).forEach(function(a){var o=n[a];o[t]=(o[t]||0)+(o[e]||0),delete o[e]})})}},{key:"transferByRefCountByPrefix",value:function(e,t){[this.refCount.img,this.refCount.audio].forEach(function(n){Object.keys(n).forEach(function(a){var o=n[a],r=0;Object.keys(o).forEach(function(t){t.startsWith(e)&&(r+=o[t],delete o[t])}),o[t]=(o[t]||0)+r})})}},{key:"addRefCount",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"play",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e&&t&&(this.load.cancelForceRemoveFile(e,t),this.refCount[e][t]=this.refCount[e][t]||{},this.refCount[e][t][n]=(this.refCount[e][t][n]||0)+a)}},{key:"subRefCount",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"play";if(this.refCount[e][t]){for(var a=Object.keys(this.refCount[e][t]),o=0;o<a.length;o++)if(/^\$([A-Za-z0-9]*-){4}([A-Za-z0-9]*)l\d/.test(a[o]))return;var r=this.refCount[e][t];r[n]=(r[n]||0)-1,r[n]=r[n]<0?0:r[n],this.removeFromCache(e,t)}else"audio"===e&&"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version&&!!t&&x["default"].removeAudioUrl(t)}},{key:"delRefTypeCount",value:function(e,t,n){if(this.refCount[e][t]){var a=this.refCount[e][t];a[n]=0,this.removeFromCache(e,t)}}},{key:"delByRefType",value:function(e){var t=this;[this.refCount.img,this.refCount.audio].forEach(function(e,n){Object.keys(e).forEach(function(a){delete e[a],t.removeFromCache(n?"audio":"img",a)})})}},{key:"getCount",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return this.refCount[e][t]?a?this.refCount[e][t][a]||0:Object.keys(this.refCount[e][t]).reduce(function(a,o){return a+n.refCount[e][t][o]},0):0}},{key:"isGlobal",value:function(e,t){return this.refCount[e][t].global>0}},{key:"removeFromCache",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.refCount[e][t]&&(!this.getCount(e,t)||n)){var a=this.usingKeyMap,o=a.background,r=a.music,i=a.sounds,s=a.preBackground;if(o===t||s===t||r===t)return void this.addRefCount(e,t);for(var l=0;l<i.length;l++)if(i[l]===t)return void this.addRefCount(e,t);if("audio"===e&&this.cache){if("ios"===flashvars.client&&flashvars.app_version>="1.5.0")x["default"].removeAudioUrl(t);else{var c=this.cache.getSound(t);c&&c.audioTag&&c.data&&(c.data.free=!0),c&&/blob:/i.test(c.url)&&URL.revokeObjectURL(c.url),this.cache.checkSoundKey(t)&&this.cache.removeSound(t),this.load.forceRemoveFile(e,t)}this.PreloadState.size+=2e6}if("img"===e&&this.cache){t.indexOf("?")>=0&&(t=t.substr(0,t.indexOf("?")));var u=t.substr((Math.max(0,t.lastIndexOf("."))||1/0)+1).toLowerCase();if(!n)return this.delayRemoveManager.push(t,"gif"===u),this.PreloadState.size+=2e5,void this.startPreloadResources();var d=this.cache.getImage(t,!0);if(d){var h=d.data.frames;h&&h.forEach(function(e){URL.revokeObjectURL(e.blobUrl),e.blobUrl=null}),/blob:/i.test(d.url)&&URL.revokeObjectURL(d.url),this.cache.checkImageKey(t)&&this.cache.removeImage(t),this.load.forceRemoveFile("image",t)}this.PreloadState.size+=2e5}delete this.refCount[e][t],this.startPreloadResources()}}},{key:"startPreloadResources",value:function(){var e=this;if(!(this.PreloadState.loading||this.PreloadState.size<=0)){this.PreloadState.loading=!0;var t=function(e){var t=e.context,n=e.chapter,a=e.pIndex,o=e.cmdInfo,s=e.cIndex,l=e.preloadType,c=e.preloadedCount,u=e.lock,d=r(t,[]);return d.stack=[].concat(i(d.stack||[])),d.cmdStack=[].concat(i(d.cmdStack||[])),{context:d,chapter:n,pIndex:a,cmdInfo:o,cIndex:s,preloadType:l,preloadedCount:c,lock:u}},n=function(n,a,o){for(var r=(o.context,o.chapter),i=(o.pIndex,o.cmdInfo,o.cIndex,o.preloadType),s=[],l=n[a]||[],c=0;c<l.length;c++){var u=l[c];if(u.plots.length){var d=t(o);d.chapter={plots:u.plots,uuid:r.uuid},d.pIndex=0;var h="options"===a?"o":"branch"!==u.type&&e.checkCondOptionResources(u)<=50?"l":"c";d.preloadType=("play"===i?"":i)+"$"+n.uuid+h+c+"-",u.plots[0].commands&&(d.cmdInfo={commands:u.plots[0].commands},d.cIndex=0),s.push(d)}}return s},a=function(n,a){for(var o=(a.context,a.chapter,a.pIndex,a.cmdInfo),r=a.cIndex,i=void 0===r?0:r,s=a.preloadType,l=[],c=n.args,u=0;u<c.length;u++){var d=c[u];if(d.commands.length){var h=t(a);h.cmdInfo={commands:d.commands,parentInfo:o,parentCmdIndex:i},h.cIndex=0;var f="options"===n.type?"o":"branch"!==d.type&&e.checkCondOptionResources(d,"command")<=50?"l":"c";h.preloadType=("play"===s?"":s)+"$"+n.uuid+f+u+"-",l.push(h)}}return l},o=function(e){!e.cmdInfo&&e.chapter.plots.length>e.pIndex&&e.chapter.plots[e.pIndex].commands&&(e.cmdInfo={commands:e.chapter.plots[e.pIndex].commands},e.cIndex=0)},s=function(n,a,r){n=t(n);var i=n,s=i.context,l=i.chapter,c=i.cmdInfo,u=i.preloadType,d=i.pIndex,h=void 0===d?0:d,f=i.cIndex,m=void 0===f?0:f,p=null;switch(a){case"pop":p=s.stack[0],s.stack=s.stack.slice(1),n.chapter=l.parent.pChapter,n.pIndex=l.parent.pnPlot+1,n.preloadType="play",n.cmdInfo=null,p&&"insert"===p.type&&(s.cmdStack=s.cmdStack.slice(1),n.cmdInfo=p.cmdInfo,n.cIndex=p.cmdIndex+1,n.preloadType=p.preloadType||"play",n.pIndex--),o(n);break;case"jump":case"command-jump":s._preMark={stack:[],cmdStack:[],chapter:l,cmdInfo:c,pIndex:h,cIndex:m,preloadType:u},s.stack=[],s.cmdStack=[],n.cmdInfo=null,n.chapter=P.searchChapterByUUID(e.gameData,r),n.pIndex=0,n.preloadType=("play"===u?"":u)+"$"+n.chapter.uuid+"j",o(n);break;case"insert":case"command-insert":s._preMark={stack:s.stack,cmdStack:s.cmdStack,chapter:l,cmdInfo:c,pIndex:h,cIndex:m,preloadType:u},s.stack=[],s.cmdStack=[],n.cmdInfo=null,n.chapter=P.searchChapterByUUID(e.gameData,r),n.pIndex=0,n.preloadType=("play"===u?"":u)+"$"+n.chapter.uuid+"i",o(n);break;case"command-pop":n.cmdInfo=c&&c.parentInfo||null,n.cIndex=(c&&c.parentCmdIndex||0)+1,c.parentInfo?(n.preloadType="play",s.cmdStack=s.cmdStack.slice(1)):(n.cmdInfo=null,n.pIndex++,o(n));break;case"command-break":n.cmdInfo=null,n.pIndex++,o(n)}return n},l=function(){for(var t=["jump","insert","back","options","conditionOptions","addImage","showDialog","playMusic","playSound","weather"],r=0,i=e.LoadedMark.length;e.LoadedMark&&r<i;r++)for(var l=0;e.LoadedMark[r]&&l<e.LoadedMark[r].length;l++){var c=e.LoadedMark[r][l],u=c,h=u.context,f=u.chapter,m=u.pIndex,p=void 0===m?0:m,y=u.cmdInfo,g=u.cIndex,v=void 0===g?0:g,x=(u.preloadType,d(c));if(x){var P=0;if(y){var w=y.commands[v]||{},k=w.type,b=w.args;P="options"===k||"conditionOptions"===k?b.length:0}else{var C=f.plots[p]||{},_=C.options,S=void 0===_?[]:_,I=C.condition_options,L=void 0===I?[]:I;P=Math.max(S.length,L.length)}if(c.preloadedCount=c.preloadedCount||0,c.preloadedCount>10||2===x&&c.preloadedCount>1||P>8){c.lock=!0;continue}c.preloadedCount++}if(c.lock)c.lock=!1,c.preloadedCount=0;else if(y)if(y.commands.length<=v)e.LoadedMark[r].splice(l--,1),(h.stack.length||h.cmdStack.length)&&y.parentInfo?e.pushLoadMarks([s(c,"command-pop")]):y.parentInfo||e.pushLoadMarks([s(c,"command-break")]);else{var E=y.commands[v]||{},M=E.type,T=E.args;if("options"===M||"conditionOptions"===M){var O=a(E,c);c.cIndex++,O.length&&e.pushLoadMarks(O)}else"back"===M||"jump"===M||"insert"===M?("insert"!==M&&e.LoadedMark[r].splice(l--,1),"jump"===M&&e.pushLoadMarks([s(c,"command-jump",T[0])]),"insert"===M&&e.pushLoadMarks([s(c,"command-insert",T[0])]),c.cIndex++):!function(){for(var e=y.commands[++c.cIndex]||{},n=e.type;n&&!t.some(function(e){return e===n});){var a=y.commands[++c.cIndex]||{};n=a.type}}()}else if(f.plots.length<=p)e.LoadedMark[r].splice(l--,1),h.stack.length&&(c=s(c,"pop"),e.pushLoadMarks([c]));else{var A=f.plots[p]||{},V=A.options,N=void 0===V?[]:V,j=A.condition_options,B=void 0===j?[]:j;if(N.length||B.length){var R=n(A,"options",c),D=n(A,"condition_options",c);c.pIndex++,o(c),R.length&&e.pushLoadMarks(R),D.length&&e.pushLoadMarks(D)}else A.back||A.jump||A.insert?(A.insert||e.LoadedMark[r].splice(l--,1),A.jump&&e.pushLoadMarks([s(c,"jump",A.jump)]),A.insert&&e.pushLoadMarks([s(c,"insert",A.insert)]),c.pIndex++,o(c)):(c.pIndex++,o(c))}}for(var F=0;e.LoadedMark&&F<e.LoadedMark.length;F++)e.LoadedMark[F]&&!e.LoadedMark[F].length&&e.LoadedMark.splice(F--,1)},c=function(e){if(e.context._preMark){var t=e.context._preMark,n=t.stack,a=t.cmdStack,r=t.chapter;e.context.stack=n,e.context.cmdStack=a,e.chapter=r,e.pIndex=0,o(e),delete e.context._preMark}},u=function(t){var n=t.chapter;if(n.md5&&0===n.plots.length&&"1"!==flashvars.offline&&!n.chapter){var a=n.downloadUuid?n.downloadUuid:n.uuid,o=null,r=function(o){var r=o.type,s=o.plots,l=void 0===s?[]:s;if("revert"===r)c(t);else if("succes"===r){var u;0===n.plots.length&&(u=n.plots).push.apply(u,i(l)),e.PreloadState.loadingChapterMap[a]=null}return t};return e.PreloadState.loadingChapterMap[a]?e.PreloadState.loadingChapterMap[a].then(r):(o=e.sceneProxy.checkIfChapterFree(a,n.md5,!1).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return{type:"succes",plots:e}},function(e){console.warn(e)}),e.PreloadState.loadingChapterMap[a]=o,o.then(r))}return Promise.resolve(t)},d=function(e){for(var t=e.preloadType,n=void 0===t?"play":t,a=n.split("$").slice(1).map(function(e){var t=e.slice(36);return/j$/.test(t)?"jump":/i$/.test(t)?"insert":/o\d-$/.test(t)?"option":/(c|l)\d-$/.test(t)?"condOption":void 0}),o=[],r=[],i=[],s=0,l=0;l<a.length;l++){switch(a[l]){case"option":if(o.push(l),i.length)return 2;if(o.length>2)return 2;2===o.length&&(s=1);break;case"condOption":if(r.push(l),r.length>2&&i.length>=1)return 2;r.length>2&&(s=1);break;case"jump":case"insert":if(i.push(l),s=1,o.length>1)return 2;if(i.length>1)return 2}if(i.length&&r.length+o.length>2)return 2;if(4===l)return 1;if(l>4)return 2}return s},h=function f(){l();for(var t=[],n=0,a=function(a){for(var o=[],r=function(t){var r=e.LoadedMark[a][t];if(r.lock)return"continue";var i=P.timeout(0).then(function(){return e.LoadedMark[a]&&e.LoadedMark[a][t]&&r===e.LoadedMark[a][t]?u(e.LoadedMark[a][t]):Promise.reject()}).then(function(t){return e.preloadResources(t)}).then(function(t){return Promise.all(t.data.map(function(t){return e.pushInLoader(t.key,t.type,t.key,!0).then(function(e){return Object.assign(t,{
pushed:e})})}))}).then(function(t){var a=t.filter(function(e){return e.pushed}),o=a.reduce(function(e,t){return e+("img"===t.type?2e5:2e6)},0);e.PreloadState.size-=o,a.length&&o&&n++,a.length&&e.load.start()}).then(function(){return P.timeout(15)});o.push(i)},i=0;e.LoadedMark[a]&&i<e.LoadedMark[a].length;i++){r(i)}o.length&&t.push(Promise.all(o).then(null,function(e){return console.warn(e)}))},o=0;e.LoadedMark&&o<e.LoadedMark.length&&e.PreloadState.preloaded<200;o++)a(o);var r=function(){n&&e.PreloadState.preloaded++,e.PreloadState.size<=0||!e.LoadedMark.length||e.PreloadState.preloaded>=200?e.PreloadState.loading=!1:setTimeout(f,0)};t.length?Promise.all(t).then(r,r):e.PreloadState.loading=!1};setTimeout(h,0)}}},{key:"resetInsertPreload",value:function(e){var t="$"+e.uuid+"i";this.transferByRefCount(t,"play"),this.updateRefTypePrefix(t),this.updateLoadMarkByPrefix(t),this.startPreloadResources()}},{key:"resetInsertBack",value:function(t,n){var a=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=r.cmdInfo,s=r.cmdIndex,l=void 0===s?0:s;e.LoadedMark=[],this.resetReCount();var c=this.sceneProxy.usingResourceCountMap();this.forEachReCount(function(e,t,n){c[t]&&a.addRefCount(e,t,c[t])}),this.getResourcesByContext(t,n,o,i,l).then(function(){return a.startPreloadResources()})}},{key:"resetJumpPreload",value:function(e){var t=this,n="$"+e.uuid+"j";this.resetReCount([n]),this.transferByRefCount(n,"play"),this.updateRefTypePrefix(n,!0,!1);var a=this.sceneProxy.usingResourceCountMap();this.forEachReCount(function(e,n,o){a[n]?t.addRefCount(e,n,a[n]):0===o&&t.removeFromCache(e,n)}),this.updateLoadMarkByPrefix(n,!1),this.startPreloadResources()}},{key:"resetCmdPOptionPreload",value:function(e,t,n){var a=this,o=e[t];if(o){for(var r="options"===o.type?"o":"c",i="$"+o.uuid+r+n+"-",s=[],l=0;l<this.LoadedMark.length;l++)for(var c=0;c<this.LoadedMark[l].length;c++){var u=this.LoadedMark[l][c];u.preloadType.startsWith(i)&&s.push(u)}var d=s.length&&s.every(function(e){return/^\$.{36}j/.test(e.preloadType.substring(i.length))});this.transferByRefCount(i,"play"),o.args.forEach(function(e,t){var i="$"+o.uuid+r+t+"-",s=t===n;!s&&a.updateRefTypePrefix(i),!s&&a.clearLoadMarkByPrefix(i)}),this.updateLoadMarkByPrefix(i,!d,!1),this.updateRefTypePrefix(i,!0),this.startPreloadResources()}}},{key:"clearPreCmdResources",value:function(e,t){var n=this;this.startPreloadResources();var a=e[t-1],o=["jump","insert","back","options","conditionOptions","addImage","showDialog","playMusic","playSound","weather"];a&&o.some(function(e){return e===a.type})&&this.PreloadState.preloaded--,a&&"conditionOptions"===a.type&&a.args.forEach(function(e,t){return n.updateRefTypePrefix("$"+a.uuid+"l"+t+"-",!1)})}},{key:"resetPlotOptionPreload",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,o="options"===n?"o":"condition_options"===n?"c":"",r=e.options,i=void 0===r?[]:r,s=e.condition_options,l=void 0===s?[]:s;if(i.length||l.length){for(var c="$"+e.uuid+o+a+"-",u=[],d=0;d<this.LoadedMark.length;d++)for(var h=0;h<this.LoadedMark[d].length;h++){var f=this.LoadedMark[d][h];f.preloadType.startsWith(c)&&u.push(f)}this.transferByRefCount(c,"play");var m=u.length&&u.every(function(e){return/^\$.{36}j/.test(e.preloadType.substring(c.length))});i.forEach(function(o,r){var i="$"+e.uuid+"o"+r+"-",s=r===a&&"options"===n;!s&&t.updateRefTypePrefix(i,s),!s&&t.clearLoadMarkByPrefix(i)}),l.forEach(function(o,r){var i="$"+e.uuid+"c"+r+"-",s=r===a&&"condition_options"===n;!s&&t.updateRefTypePrefix(i,s),!s&&t.clearLoadMarkByPrefix(i)}),this.updateLoadMarkByPrefix(c,!m,!1),this.updateRefTypePrefix(c,!0),this.startPreloadResources()}}},{key:"clearPrePlotResources",value:function(e,t){var n=this;this.startPreloadResources(),this.PreloadState.preloaded--;var a=e[t-1];if(a&&!a.commands&&(a.condition_options||a.condition_options.length)){var o=a.condition_options,r=void 0===o?[]:o;r.forEach(function(e,t){return n.updateRefTypePrefix("$"+a.uuid+"l"+t+"-",!1)})}}},{key:"preloadResources",value:function(e){var t=this,n=(e.context,e.chapter),a=e.pIndex,o=void 0===a?0:a,r=e.cmdInfo,i=e.cIndex,s=void 0===i?0:i,l=e.preloadType,c={data:[],size:0};if(!n||!n.plots||!n.plots[o]||r&&!r.commands[s])return Promise.resolve(c);var u=function(e,n,a){return t.addRefCount(e,n,a)},h=function(e,t,n){return u(t,e,n),c.data.some(function(t){return t.key===e})?Promise.resolve(!1):d.getResourceSize(e,t).then(function(n){return c.data.push({key:e,type:t,size:n}),c.size+=n,!0})},f=function(e,n,a){return n>=e.commands.length?Promise.resolve():Promise.all(t.getCommandResources(e.commands[n]).map(function(e){return h(e.url,e.type,a)}))},m=function(n,a,o){var r=n.plots[a];return!r||r.commands&&!r.commands.length?Promise.resolve():r.commands?(e.cmdInfo={commands:r.commands},e.cIndex=0,f(r,0,o)):Promise.all(t.getPlotResources(r).map(function(e){return h(e.url,e.type,o)}))};return r?f(r,s,l).then(function(){return c}):m(n,o,l).then(function(){return c})}},{key:"pushLoadMarks",value:function(e){if(e.length){this.LoadedMark.push(e)}}},{key:"updateLoadMarkByPrefix",value:function(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=0;a<this.LoadedMark.length;a++){for(var o=0;o<this.LoadedMark[a].length;o++){var r=this.LoadedMark[a][o],i=r.preloadType,s=r.context;if(i.startsWith(e)){if(i=i.substring(e.length),r.preloadType=i?i:"play",n){var l=s.stack.pop();l&&"insert"===l.type&&s.cmdStack.pop()}}else t||(this.updateRefTypePrefix(i,!1),this.LoadedMark[a].splice(o--,1))}this.LoadedMark[a].length||this.LoadedMark.splice(a--,1)}}},{key:"clearLoadMarkByPrefix",value:function(e){for(var t=0;t<this.LoadedMark.length;t++){for(var n=0;n<this.LoadedMark[t].length;n++){var a=this.LoadedMark[t][n],o=a.preloadType;o.startsWith(e)&&this.LoadedMark[t].splice(n--,1)}this.LoadedMark[t].length||this.LoadedMark.splice(t--,1)}}},{key:"getWeatherResources",value:function(e){var t=[];if("snowy"===e)for(var n=0;n<120;n++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("snow")+"/xuehua_"+P.formatNum(n)+".png",type:"img"});else if("windy"===e){if(flashvars.vertical)for(var a=0;a<20;a++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("wind")+"/feng_"+P.formatNum(a)+".png",type:"img"})}else if("rainy"===e)for(var o=0;o<50;o++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("rain")+"/xiayu_"+P.formatNum(o)+".png",type:"img"});else if("defoliation"===e)for(var r=0;r<90;r++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("mapleLeaves")+"/fengye_"+P.formatNum(r)+".png",type:"img"});else if("fallingPeach"===e)for(var i=0;i<90;i++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("beachBlossom")+"/taohua_"+P.formatNum(i)+".png",type:"img"});else if("fallingFlower"===e)for(var s=0;s<90;s++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("blossom")+"/yinghua_"+P.formatNum(s)+".png",type:"img"});else if("lightning"===e)for(var l=0;l<50;l++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("lightning")+"/shandian_"+P.formatNum(l)+".png",type:"img"});return t}},{key:"getCommandResources",value:function(e){var t=[];switch(e.type){case"addImage":e.args[0].url&&"inherit"!==e.args[0].url&&t.push({type:"img",url:e.args[0].url,isBackground:1===e.args[0].index});break;case"showDialog":t.push({type:"img",url:e.args[0].avatar.url});break;case"playMusic":e.args[0].url&&"inherit"!==e.args[0].url&&t.push({type:"audio",url:e.args[0].url,isMusic:!0});break;case"playSound":e.args[0].url&&"inherit"!==e.args[0].url&&t.push({type:"audio",url:e.args[0].url,isSound:!0,index:e.args[0].index});break;case"options":var n=!0,a=!1,o=void 0;try{for(var r,s=e.args[Symbol.iterator]();!(n=(r=s.next()).done);n=!0){var l=r.value,c=l.background,u=l.sound;if(c){var d=c.normal,h=c.active,f=c.disable;d&&d.url&&t.push({type:"img",url:d.url}),h&&h.url&&t.push({type:"img",url:h.url}),f&&f.url&&t.push({type:"img",url:f.url})}u&&u.url&&t.push({type:"audio",url:u.url})}}catch(m){a=!0,o=m}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw o}}break;case"weather":"1"!==flashvars.offline&&t.push.apply(t,i(this.getWeatherResources(e.args[0])))}return t}},{key:"getPlotResources",value:function(e){var t=[];if("[object Array]"==Object.prototype.toString.call(e.plot_sound))for(var n in e.plot_sound){var a=e.plot_sound[n];a&&"inherit"!==a.url&&t.push({url:a.url,type:"audio",isSound:!0,index:n})}else e.plot_sound.url&&"inherit"!==e.plot_sound.url&&t.push({url:item.url,type:"audio",isSound:!0,index:0});e.background.url&&"inherit"!==e.background.url&&t.push({url:e.background.url,type:"img",isBackground:!0}),e.avatar.url&&t.push({url:e.avatar.url,type:"img"}),e.music.url&&"inherit"!==e.music.url&&t.push({url:e.music.url,type:"audio",isMusic:!0});var o=!0,r=!1,s=void 0;try{for(var l,c=e.characters[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;u.url&&t.push({url:u.url,type:"img"})}}catch(d){r=!0,s=d}finally{try{!o&&c["return"]&&c["return"]()}finally{if(r)throw s}}var h=!0,f=!1,m=void 0;try{for(var p,y=e.props[Symbol.iterator]();!(h=(p=y.next()).done);h=!0){var g=p.value;g.url&&t.push({url:g.url,type:"img"})}}catch(d){f=!0,m=d}finally{try{!h&&y["return"]&&y["return"]()}finally{if(f)throw m}}var v=!0,x=!1,P=void 0;try{for(var w,k=e.options[Symbol.iterator]();!(v=(w=k.next()).done);v=!0){var b=w.value,C=b.background,_=b.sound;if(C){var S=C.normal,I=C.active,L=C.disable;S&&S.url&&t.push({type:"img",url:S.url}),I&&I.url&&t.push({type:"img",url:I.url}),L&&L.url&&t.push({type:"img",url:L.url})}_&&_.url&&t.push({type:"audio",url:_.url})}}catch(d){x=!0,P=d}finally{try{!v&&k["return"]&&k["return"]()}finally{if(x)throw P}}return e.weather.value&&"1"!==flashvars.offline&&t.push.apply(t,i(this.getWeatherResources(e.weather.value))),t}},{key:"checkCondOptionResources",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"general",a=this.OptionResourcesCountMap.get(e)||0;if(a)return a;var o={},r=function(e){o[e.url]||(a++,o[e.url]=!0)},s=function(e){for(var n=0;n<e.plots.length&&a<=50;n++){var o=e.plots[n],s=[];o.commands?s=o.commands.map(function(e){return"options"!==e.type&&"conditionOptions"!==e.type||u(e.args),t.getCommandResources(e)}).reduce(function(e,t){return[].concat(i(t),[e])},[]):(o.options.length&&l(o.options),o.condition_options.length&&l(o.condition_options),s=t.getPlotResources(o)),s.forEach(function(e){return r(e)})}},l=function(e){return e.forEach(function(e){return s(e)})},c=function(e){for(var n=0;n<e.commands.length&&a<=50;n++){var o=e.commands[n];t.getCommandResources(o).forEach(function(e){return r(e)}),"options"!==o.type&&"conditionOptions"!==o.type||u(o.args)}},u=function(e){return e.forEach(function(e){return c(e)})};return"general"===n?s(e):c(e),a}},{key:"getResourcesByContext",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments[3],o=this,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],c={data:[],size:0};if(e=l({},e),e.stack=[].concat(i(e.stack||[])),e.cmdStack=[].concat(i(e.cmdStack||[])),!t||!t.plots||!t.plots[n]||a&&!a.commands[r])return Promise.resolve(c);var u=function(){return c.size>o.MaxSize/5||c.data.length>30},h=function(e,t,n){return s&&o.addRefCount(e,t,n)},f=function(e,t,n){return h(t,e,n),c.data.some(function(t){return t.key===e})?Promise.resolve():d.getResourceSize(e,t).then(function(n){c.data.push({key:e,type:t,size:n}),c.size+=n})},m=function(e){var t=e.context,n=e.chapter,a=e.pIndex,o=e.cmdInfo,r=e.cIndex,i=e.preloadType,s=l({},t,{stack:[],cmdStack:[]}),c=n.plots||[];return!o&&c.length>a&&c[a]&&c[a].commands&&(o={commands:c[a].commands},r=-1),{context:s,chapter:n,pIndex:a,cmdInfo:o,cIndex:r,preloadType:i}},p=function(e,t){var n=e,a=n.context,r=n.preloadType,i=P.searchChapterByUUID(o.gameData,t);if(i)return r=("play"===r?"":r)+"$"+i.uuid+"j",e={context:a,cmdInfo:null,chapter:i,pIndex:-1,preloadType:r},m(e)},y=function(e,t){var n=e,a=n.context,r=n.preloadType,i=P.searchChapterByUUID(o.gameData,t);if(i)return r=("play"===r?"":r)+"$"+i.uuid+"i",e={context:a,cmdInfo:null,chapter:i,pIndex:-1,preloadType:r},m(e)},g=function(e,t){var n=o.getCommandResources(e);return n.forEach(function(e){var t=(e.type,e.url),n=e.isMusic,a=e.isSound,r=e.index;n&&o.forceDecode.musics.length<o.MaxForceDecodeMusic&&o.forceDecode.musics.push(t),a&&!o.forceDecode.sounds[r]&&(o.forceDecode.sounds[r]=t)}),Promise.all(n.map(function(e){return f(e.url,e.type,t)}))},v=function S(e){for(var t=e.context,n=e.preloadType,a=(e.chapter,e.pIndex,e.cmdInfo),r=e.cIndex,i=a.commands[r],s=i.args,c=[],d=[],h=function(a){for(var r=s[a],h="options"===i.type?"o":"branch"!==r.type&&o.checkCondOptionResources(r,"command")<=50?"l":"c",f={commands:r.commands},v=("play"===n?"":n)+"$"+i.uuid+h+a+"-",x=function(t){var n=m(l({},e,{cmdInfo:f,cIndex:t,preloadType:v}));d.push(n)},P=l({},e,{cmdInfo:f,cIndex:0,preloadType:v}),w=Promise.resolve(),k=function(e){var n=r.commands[e],a=n.type,i=n.args;if(w=w.then(function(){return g(n,v).then(function(){if(u(!0))return Promise.reject(e);if("options"===a||"conditionOptions"===a){var n=l({},P,{cIndex:e});return n.context=l({},t,{cmdStack:[]}),S(n)}return"jump"===a?(o.pushLoadMarks([p(l({},P,{cIndex:e}),i[0])]),Promise.reject(-1)):"insert"===a?(o.pushLoadMarks([y(l({},P,{cIndex:e}),i[0])]),Promise.reject(-1)):"back"===a?Promise.reject(-1):Promise.resolve()})}),"options"===a||"conditionOptions"===a)return e+1<r.commands.length&&(w=w.then(function(){return Promise.reject(e)})),"break"},b=0;b<r.commands.length&&b<10;b++){var C=k(b);if("break"===C)break}w=w.then(function(){r.commands.length>10&&x(9)},function(e){e>=0&&r.commands.length>e&&x(e)}),c.push(w)},f=0;s&&f<s.length;f++)h(f);return Promise.all(c).then(function(){return d.length&&o.pushLoadMarks(d),Promise.resolve()})},x=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=e.context,a=e.chapter,r=e.pIndex,i=e.cmdInfo,s=e.cIndex;e.preloadType;if(u(!0))return o.pushLoadMarks([m(e)]),Promise.resolve();var c=i.commands[s]||{},d=c.type,h=c.args;if("jump"===d)return o.pushLoadMarks([p(e,h[0])]),Promise.resolve();if("insert"===d)return o.pushLoadMarks([y(e,h[0])]),w(l({},e,{cIndex:s+1}));if("back"===d)return Promise.resolve();if("options"===d||"conditionOptions"===d)return v(e,t).then(function(){return w(l({},e,{cIndex:s+1}),t)});if(i.commands.length>s+1)return w(l({},e,{cIndex:s+1}),t);if(t&&n.cmdStack.length){if(n.cmdStack=n.cmdStack.splice(1),s=i.parentCmdIndex+1,i=i.parentInfo,i&&Number.isInteger(s))return w(l({},e,{cmdInfo:i,cIndex:s}),t)}else if(t&&n.stack.length&&(n.stack=n.stack.slice(1),a.parent&&(r=a.parent.pnPlot+1,a=a.parent.pChapter),a&&Number.isInteger(r)))return b(l({},e,{chapter:a,pIndex:r}));return t?b(l({},e,{pIndex:r+1})):Promise.resolve()},w=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=(e.chapter,e.pIndex,e.cmdInfo),a=e.cIndex,o=e.preloadType;return a>=n.commands.length?x(e,t):g(n.commands[a],o).then(function(){return x(e,t)})},k=function(e){for(var t=0,n=0;e.options&&n<e.options.length;n++)t+=e.options[n].plots.length;for(var a=0;e.condition_options&&a<e.condition_options.length;a++)t+=e.condition_options[a].plots.length;return t},b=function I(e){var t=e.chapter,n=e.pIndex,a=e.preloadType,r=t.plots[n];if(!r||r.commands&&!r.commands.length)return Promise.resolve();if(r.commands)return w(l({},e,{cmdInfo:r,cIndex:0}));var i=function(e,t){var n=o.getPlotResources(e);return n.forEach(function(e){var t=(e.type,e.url),n=e.isMusic,a=e.isSound,r=e.index;n&&o.forceDecode.musics.length<o.MaxForceDecodeMusic&&o.forceDecode.musics.push(t),a&&!o.forceDecode.sounds[r]&&(o.forceDecode.sounds[r]=t)}),Promise.all(n.map(function(e){return f(e.url,e.type,t)}))},s=function d(e){for(var t=e.chapter,n=e.pIndex,a=e.preloadType,r=e.context,s=t.plots[n],c=[],h=[],f=[],g=[],v=function(e,t){return t.push(m(e))},x=function(e,t,n){return e=e.then(function(){return t.commands?(n.cmdInfo={commands:t.commands},n.cIndex=0,w(n,!1)):i(t,n.preloadType)}).then(function(){return u(!0)?Promise.reject(n.pIndex):k(t)?d(n):t.jump?(o.pushLoadMarks([p(n,t.jump)]),Promise.reject(-1)):t.insert?(o.pushLoadMarks([y(n,t.insert)]),Promise.reject(-1)):t.back?Promise.reject(-1):Promise.resolve()})},P=function(n){for(var o=s.options[n],i=("play"===a?"":a)+"$"+s.uuid+"o"+n+"-",u={plots:o.plots,uuid:t.uuid},d=l({},e,{chapter:u,pIndex:0,preloadType:i}),h=Promise.resolve(),m=0;m<o.plots.length&&m<5;m++){var p=l({},d,{pIndex:m});p.context=l({},r),h=x(h,o.plots[m],p)}h=h.then(function(){o.plots.length>5&&v(l({},d,{pIndex:4}),c)},function(e){return e>=0&&o.plots.length>e&&!o.plots[e].commands&&v(l({},d,{pIndex:e}),c),Promise.resolve()}),f.push(h)},b=0;s.options&&b<s.options.length;b++)P(b);for(var C=function(i){for(var c=s.condition_options[i],u={plots:c.plots,parent:{pChapter:t,pnPlot:n},uuid:t.uuid},d="branch"!==c.type&&o.checkCondOptionResources(c)<=50?"l":"c",f=("play"===a?"":a)+"$"+s.uuid+d+i+"-",m=l({},e,{chapter:u,pIndex:0,preloadType:f}),p=Promise.resolve(),y=0;y<c.plots.length&&y<5;y++){var P=l({},m,{pIndex:y});P.context=l({},r),p=x(p,c.plots[y],P)}p=p.then(function(){c.plots.length>5&&v(l({},m,{pIndex:4}),h)},function(e){return e>=0&&c.plots.length>e&&!c.plots[e].commands&&v(l({},m,{pIndex:e}),h),Promise.resolve()}),g.push(p)},b=0;s.condition_options&&b<s.condition_options.length;b++)C(b);var _=Promise.all(f).then(function(){return c.length&&o.pushLoadMarks(c)}),S=Promise.all(g).then(function(){return h.length&&o.pushLoadMarks(h)});return Promise.all([_,S])},c=function(e){var t=e.context,n=e.chapter,a=e.pIndex,r=n.plots[a];if(u()){var i=m(e);return o.pushLoadMarks([i]),Promise.resolve()}return r.back?Promise.resolve():r.jump?(o.pushLoadMarks([p(e,r.jump)]),Promise.resolve()):r.insert?(o.pushLoadMarks([y(e,r.insert)]),I(l({},e,{pIndex:a+1}))):k(r)?s(e).then(function(){return I(l({},e,{pIndex:a+1}))}):n.plots.length>a+1?I(l({},e,{pIndex:a+1})):t.stack.length&&(t.stack=t.stack.slice(1),n.parent&&(a=n.parent.pnPlot+1,n=n.parent.pChapter),n&&Number.isInteger(a))?I(l({},e,{chapter:n,pIndex:a})):Promise.resolve()};return i(r,a).then(function(){return c(e)})},C=function(e){return e.size<o.MaxSize&&(o.PreloadState.size=o.MaxSize-e.size),o.PreloadState.size>0&&o.startPreloadResources(),e},_={context:e,chapter:t,pIndex:n,cmdInfo:a,cIndex:r,preloadType:"play"};return a?w(_).then(function(){return C(c)}):b(_).then(function(){return C(c)})}},{key:"getResourcesSize",value:function(e){var t=[];return e.forEach(function(e){t.push(d.getResourceSize(e.key,e.type))}),Promise.all(t).then(function(e){return e.reduce(function(e,t){return e+t},0)})}},{key:"updateUsingKey",value:function(e){var t=e.type,n=e.key,a=e.index,o="";switch(t){case"background":this.usingKeyMap.background=n;break;case"preBackground":this.usingKeyMap.preBackground=n;break;case"music":o=this.usingKeyMap.music,this.usingKeyMap.music=n,o&&this.subRefCount("audio",o);break;case"sound":o=this.usingKeyMap.sounds[a],this.usingKeyMap.sounds[a]=n,o&&this.subRefCount("audio",o)}}},{key:"isUsingKey",value:function(e){var t=this.usingKeyMap,n=t.background,a=t.music,o=t.sounds,r=t.preBackground;return n===e||r===e||a===e||o.some(function(t){return t===e})}}]),e}();k.delayRemoveManager=new w,k.OptionResourcesCountMap=new Map,k.PreloadState={size:0,loading:!1,preloaded:0,loadingChapterMap:{}},k.LoadedMark=[],k.MaxSize=1e8,k.MaxForceDecodeMusic=3,k.refCount={audio:{},img:{}},k.usingKeyMap={background:"",sounds:new Array(10).fill(""),music:"",preBackground:""},k.forceDecode={musics:[],sounds:new Array(10).fill("")};var b=e.AudioTagPool=function(){function e(){s(this,e)}return c(e,null,[{key:"get",value:function(){var t=e.pool.find(function(e){return e.free});return t?(t.pause(),t.free=!1):t=document.createElement("audio"),t}},{key:"exist",value:function(t){return e.pool.some(function(e){return e===t})}},{key:"fill",value:function(){var t=function(t){for(var n=0;n<t;n++){var a=document.createElement("audio");a.free=!0,a.loop=!1,a.play(),e.pool.push(a)}};if(e.pool.length){var n=e.pool.reduce(function(e,t){return e+(t&&t.free?1:0)},0);n<10&&t(50)}else t(100)}}]),e}();b.pool=[]}),require.register("js/common/Version.js",function(e,t,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a="4e7d8dcabb05d52b1ca1b74147f73d1e63d63b3c";e["default"]=a;var o="1.0.0";e.version=o}),require.register("js/common/XmlHttpRequest.js",function(e,t,n){"use strict";function a(e){return e._=Date.now(),"?"+Object.keys(e).map(function(t){var n=e[t];return n?encodeURIComponent(t)+"="+encodeURIComponent(n):""}).join("&")}function o(e){return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onload=function(){try{return 4===a.readyState&&a.status>=400&&a.status<=599?n("error readyState: "+a.readyState+", status: "+a.status):t(a)}catch(e){n(e)}},a.onerror=n,a.send()})}function r(e,t,n,a){return new Promise(function(o,r){var i=new XMLHttpRequest;i.ontimeout=function(){console.log(e+" time out")},i.onreadystatechange=function(){switch(i.readyState){case 4:return i.status>=200&&i.status<300||304==i.status?o(i):r("error readyState: "+i.readyState+", status: "+i.status)}},i.open("post",e,!0),i.withCredentials=!0,a&&(i.timeout=a),n&&i.addEventListener("progress",n,!1),i.setRequestHeader("CONTENT-TYPE","application/x-www-form-urlencoded"),i.send(t),i.onerror=r})}function i(e,t,n){var a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return new Promise(function(o,r){var i=new XMLHttpRequest;i.ontimeout=function(){if(console.log(e+" time out"),a)return r("get time out")},i.onload=function(){try{return 4===i.readyState&&i.status>=400&&i.status<=599?r("error readyState: "+i.readyState+", status: "+i.status):o(i)}catch(e){return r(e)}},i.open("GET",e,!0),i.responseType=t,n&&i.addEventListener("progress",n,!1),a&&(i.timeout=5e3),i.onerror=r,i.send()})}function s(e,t){return i(e,"",t,!1).then(function(e){return JSON.parse(e.response)})}function l(e){return s(f.materialRedirect+a({url:e})).then(function(e){return"100"==e.code?e.result:Promise.reject(e.message)})}function c(e,t){var n=f.getGame+"?uuid="+e;return s(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function u(e,t){var n=f.getTestGame+"?uuid="+e;return s(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function d(e,t){var n=f.getOtherGame+"?uuid="+e;return s(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function h(e,t){return"img"===t?Promise.resolve(2e5):"audio"===t?Promise.resolve(2e6):void 0}Object.defineProperty(e,"__esModule",{value:!0}),e.xhrGetServerTime=o,e.xhrSend=r,e.xhrLoad=i,e.getJson=s,e.getMaterialRedirect=l,e.getGame=c,e.getTestGame=u,e.getOtherGame=d,e.getResourceSize=h;var f={getGame:"https://mapi.3000api.com/apis/soft/v1.0/game-info.html",getTestGame:"https://mapi.3000api.com/apis/soft/v1.0/game-test.html",getOtherGame:"https://mapi.3000api.com/apis/soft/v1.0/game-external.html",materialRedirect:"https://mapi.3000api.com/client/material-redirect.html"}}),require.register("js/controller/command/PrepareControllerCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareControllerCommand",parent:r["default"].SimpleCommand},{execute:function(e){}})}),require.register("js/controller/command/PrepareModelCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareModelCommand",parent:r["default"].SimpleCommand},{execute:function(e){this.facade.registerProxy(new diygamePlayer.model.proxy.SceneProxy)}})}),require.register("js/controller/command/PrepareViewCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareViewCommand",parent:r["default"].SimpleCommand},{execute:function(e){this.facade.registerMediator(new diygamePlayer.view.mediator.SceneMediator)}})}),require.register("js/controller/command/StartupCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.StartupCommand",parent:r["default"].MacroCommand},{initializeMacroCommand:function(){this.addSubCommand(diygamePlayer.controller.command.PrepareControllerCommand),this.addSubCommand(diygamePlayer.controller.command.PrepareModelCommand),this.addSubCommand(diygamePlayer.controller.command.PrepareViewCommand)}})}),require.register("js/main.js",function(t,n,a){"use strict";n("babel-polyfill"),n("./AppConstants.js"),n("./ApplicationFacade.js"),n("./controller/command/PrepareControllerCommand.js"),n("./controller/command/PrepareModelCommand.js"),n("./controller/command/PrepareViewCommand.js"),n("./controller/command/StartupCommand.js"),n("./model/proxy/SceneProxy.js"),n("./view/component/Scene.js"),n("./view/mediator/SceneMediator.js"),document.addEventListener("DOMContentLoaded",function(){e.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,e.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,diygamePlayer.ApplicationFacade.getInstance(diygamePlayer.ApplicationFacade.NAME).startup(),console.log("Initialized")})}),require.register("js/model/proxy/SceneProxy.js",function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),l=t("puremvc"),c=o(l),u=t("../../common/Utils.js"),d=o(u),h=t("spark-md5"),f=o(h),m=t("./../../common/Dialog.js"),p=o(m),y=t("./../../common/ShanyiMenu.js"),g=o(y),v=t("./../../common/XmlHttpRequest.js"),x=a(v),P=t("../../common/PhoneUtils.js"),w=o(P),k=t("../../common/FontUtils.js"),b=o(k),C=t("../../common/OtherWap"),_=o(C),S=t("copy-to-clipboard"),I=o(S),L=t("jsonp"),E=o(L);c["default"].define({name:"diygamePlayer.model.proxy.SceneProxy",parent:c["default"].Proxy},{chargeMsgReceive:function(e){if("msgCharged"===e.originalEvent.key){var t=JSON.parse(e.originalEvent.newValue);t&&"doit"==t.command&&alert(t.data)}},resumeAudio:function(){this.bk_music&&this.bk_music.play(),this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.resume()})},pauseAudio:function(){this.bk_music&&this.bk_music.pause(),this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.pause()})},preloadingBegin:function(){this.stringMap={},this.stringMap.loadMenu="读档",this.stringMap.overMenu="结束",this.stringMap.settingsMenu="设置",this.stringMap.startMenu="开始",this.stringMap.menu="菜单",this.stringMap.mainMenu="菜单",this.stringMap.save="保存进度",this.stringMap.load="读取进度",this.stringMap.playback="剧情回放",this.stringMap.autoplay="自动播放",this.stringMap.manualPlay="手动播放",this.stringMap.settings="设置",this.stringMap.displayHeader="显示设定",this.stringMap.displayCaption="画面模式",this.stringMap.volumeHeader="音量",this.stringMap.musicCaption="音乐音量",this.stringMap.soundCaption="音效音量",this.stringMap.textHeader="文字设定",this.stringMap.textCaption="自动进行",this.stringMap.autoOn="开",this.stringMap.autoOff="关",this.stringMap.windowMode="窗口模式",this.stringMap.fullMode="全屏模式",this.stringMap.back="返回",this.progressTips=["手指右滑就可召唤退出按钮，退出作品时，记得存档哦","收藏作品，更新会第一时间通知你","把作品下载到本地，随时随地任性玩","感觉作品很棒，和你的好友分享吧~","引战、刷屏、作品无关的评论会被删除哦","素材库为全站通用，可能发生人物走错片场的情况，请不要慌张","在当前作品的评论中对比其他作品容易给作者大大招黑哦~","制作辛苦，写下精彩长评支持喜欢的作者吧","长按屏幕可以快进剧情"],this.recordTipCount=0,this.isShowGuide=!1,this.plotSounds=[],this.playbackData=[],this.plotViews=[],this.prgsViews=[],this.plotViewKeys=[],this.bViewLoaded=!1,this.bSignedIn=!1,this.bCloudSel=!1,this.visibleLayout=[],this.resourceManager={plotIndex:0,resourceList:[],baseList:[]},this.lstDialogInfo=[],this.menuInfo=[],this.quickPlay=!1,this.isScreenHold=!1,this.bCmdAutoText=!1,this.isGameStarted=!1,this.usedStarCount=0,this.gameStarLimit=0,this.lstPlotTweens=[],this.twinkleTimer=null,this.uiOnLoadQueue=[],this.timerCounts=[],this.menuTimer=[],this.recUidBelongTo=flashvars.uid,this.gameUidBelongTo=flashvars.uid,this.bSwitchAccInPlot=!0,this.payValueUid=flashvars.uid,this.unlockChapterCallBack=null,this.mallPayCallback=null,this.isPaying=!1,this.isGettingNext=!0,this.isPreferentialFinished=!1,this.preferentialVector=[],this.isSetValues=!1,this.isPaySuccess=!1,this.isGoToCommand=!0,this.shakeLoopObj={level:0,duration:0,delay:0,loop:!1,commands:null},this.prePlotBkKey=null,this.isQuickPlay=!0,this.hasCountDown=!1,this.playAdCallBack=null,this.isWapOther()&&(_["default"].sendQHData(),_["default"].initQHSdk().then(function(e){console.log("--->>>>> "+e)})),audioMgr.pause=this.pauseAudio.bind(this),audioMgr.resume=this.resumeAudio.bind(this),audioMgr.audioCanPlayCallBack=w["default"].audioCanPlayCallBack.bind(w["default"]),audioMgr.audioErrorCallBack=w["default"].audioErrorCallBack.bind(w["default"]),gameCallback.updateAccInfo=this.updateAccInfo.bind(this),gameCallback.unlockChapterFinished=this.unlockChapterFinished.bind(this),gameCallback.mallPay=this.mallPay.bind(this),gameCallback.preferentialFinished=this.preferentialFinished.bind(this),gameCallback.showSave=this.showSaveInterface.bind(this),gameCallback.playadBack=this.playadBackInterface.bind(this),this.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN)},playadBackInterface:function(e){null!==this.playAdCallBack&&this.playAdCallBack(e)},showSaveInterface:function(){this.recordLayer.visible&&(this.recordLayer.visible=!1),this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),this.menuLayer.visible=!0,this.getSnap(),this.menuLayer.visible=!1,this.showSave()},preferentialFinished:function(e){var t=this.curChapter&&(this.curChapter.downloadUuid?this.curChapter.downloadUuid:this.curChapter.uuid);this.preferentialVector.push(e.uuid?e.uuid:e),t===(e.uuid?e.uuid:e)&&(this.isPreferentialFinished=!0)},unlockChapterFinished:function(e,t){this.unlockChapterCallBack&&this.unlockChapterCallBack(e,t)},dislodgePreferentVector:function(e){for(var t=0;t<this.preferentialVector.length;t++)e===this.preferentialVector[t]&&this.preferentialVector.splice(t,1)},mallPay:function(e){this.mallPayCallback&&this.mallPayCallback(e),this.mallPayCallback=null},checkIfMallPaySuccess:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=function(t,n){return x.xhrSend(t,n).then(function(t){if(0===t.responseText.length)return Promise.resolve(!1);var n=JSON.parse(t.responseText);return"wap"===flashvars.client?100===n.status?Promise.resolve(n.data.serial_num===e&&"1"==n.data.c_status):200===n.status?Promise.resolve(!1):102===n.status?Promise.resolve(!1):101===n.status?Promise.resolve(!1):Promise.resolve(!1):0===n.status?Promise.resolve(n.data.serial_num===e&&"1"==n.data.c_status):100===n.status?Promise.resolve(!1):Promise.resolve(!1)},function(e){return Promise.resolve(!1)})},a="https://app.3000.com/?m=consume&op=index&ac=market_order_status&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,o="u="+encodeURIComponent(d["default"].aesEncrypt(flashvars.u,1))+"&token="+encodeURIComponent(d["default"].aesEncrypt(flashvars.token,1))+"&serial_num="+encodeURIComponent(d["default"].aesEncrypt(e,1));
return"wap"===flashvars.client?""===flashvars.uid?this.getUserInfoFromWap().then(function(){return""===flashvars.uid?Promise.resolve(!1):(a="https://pay.3000.com/?m=consume&op=h5_flash_request",o="type="+encodeURIComponent(d["default"].aesEncrypt(t,3))+"&serial_num="+encodeURIComponent(d["default"].aesEncrypt(e,3)),n(a,o))}):(a="https://pay.3000.com/?m=consume&op=h5_flash_request",o="type="+encodeURIComponent(d["default"].aesEncrypt(t,3))+"&serial_num="+encodeURIComponent(d["default"].aesEncrypt(e,3)),n(a,o)):n(a,o)},addAssets:function(e,t,n,a){return u.ResourcesManager.pushInLoader(e,t,n,a)},addImage:function(e,t,n){this.viewComponent.game.cache.addImage(e,t||null,n)},addImageUrl:function(e,t){var n=this;return new Promise(function(a,o){var r=new Image;r.src=e,r.onload=function(o){n.viewComponent.game.load.cache.checkImageKey(t)||(n.viewComponent.game.cache.addImage(t,e,o.target),a())},r.onerror=r.onabort=function(e){return o(e)}})},parseJsonFile:function(e){var t=this;this.json_data=e;var n=[];return this.json_data.template&&this.json_data.template.json&&(n.push(this.parseTemplateCoverAssets()),n.push(this.parseTemplateDialogAssets()),n.push(this.parseTemplateMenuAssets()),n.push(this.parseTemplateSyMenuAssets()),n.push(this.parseTemplateMainMenuAssets()),n.push(this.parseTemplateSettingsAssets()),n.push(this.parseTemplateOptionAssets()),n.push(this.parseTemplatePlaybackAssets()),n.push(this.parseTemplateRecordAssets()),n.push(this.parseTemplateSoundAssets())),Promise.all(n).then(function(){return Promise.resolve()}).then(function(){if(n.length=0,b["default"].fontImage&&t.viewComponent.game.load.image(b["default"].fontFamily,b["default"].fontImage),t.json_data.logo&&t.json_data.logo.background&&t.json_data.logo.background.url&&n.push(t.addAssets(t.json_data.logo.background.url,"img")),t.json_data.cover.background&&t.json_data.cover.background.url&&n.push(t.addAssets(t.json_data.cover.background.url,"img")),t.json_data.cover.music&&t.json_data.cover.music.url){var e=t.json_data.cover.music.url;n.push(t.addAssets(e,"audio"))}var a=function(e){"[object Array]"==Object.prototype.toString.call(e)&&e.forEach(function(e){e.events.forEach(function(e){"playMusic"===e.type&&e.handle.music.url?n.push(t.addAssets(e.handle.music.url,"audio")):"playSound"===e.type&&e.handle.sounds.forEach(function(e){e&&"inherit"!=e.url&&n.push(t.addAssets(e.url,"audio"))})})})};for(var o in t.json_data.viewMap)if("timer"!==t.json_data.viewMap[o].type){var r=t.json_data.viewMap[o].content.background,i=t.json_data.viewMap[o].content.sound;r&&(r.url&&n.push(t.addAssets(r.url,"img")),r.normal&&r.normal.url&&n.push(t.addAssets(r.normal.url,"img")),r.active&&r.active.url&&n.push(t.addAssets(r.active.url,"img")),r.progress&&r.progress.url&&n.push(t.addAssets(r.progress.url,"img")),i&&i.url&&n.push(t.addAssets(i.url,"audio")),a(t.json_data.viewMap[o].events),t.json_data.viewMap[o].children.forEach(function(e){a(e.events)}))}else a(t.json_data.viewMap[o].events);return Promise.all(n).then(function(){return Promise.resolve()},function(e){return Promise.reject(e)})})},parseTemplateCoverAssets:function(){var e=[],t=this.json_data.template.json.cover,n=t.titleContainer,a=t.startMenu,o=t.loadMenu,r=t.settingsMenu,i=t.overMenu;return n.background.url&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.normal.background.url&&a.normal.background.url&&e.push(this.addAssets(a.normal.background.url,"img")),a.active.background.url&&a.active.background.url&&e.push(this.addAssets(a.active.background.url,"img")),o.normal.background.url&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),r.normal.background.url&&r.normal.background.url&&e.push(this.addAssets(r.normal.background.url,"img")),r.active.background.url&&r.active.background.url&&e.push(this.addAssets(r.active.background.url,"img")),i.normal.background.url&&i.normal.background.url&&e.push(this.addAssets(i.normal.background.url,"img")),i.active.background.url&&i.active.background.url&&e.push(this.addAssets(i.active.background.url,"img")),Promise.all(e)},parseTemplateDialogAssets:function(){var e=[],t=this.json_data.template.json.dialog,n=t.background,a=t.avatarContainer,o=t.titleContainer;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background.url&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.background.url&&o.background.url&&e.push(this.addAssets(o.background.url,"img")),Promise.all(e)},parseTemplateMenuAssets:function(){var e=[],t=this.json_data.template.json.menu,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)},parseTemplateSyMenuAssets:function(){if(this.json_data.template.json.shanyiMenu){var e=[],t=this.json_data.template.json.shanyiMenu,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)}},parseTemplateMainMenuAssets:function(){var e=[],t=this.json_data.template.json.mainMenu,n=t.background,a=t.header,o=t.save,r=t.load,i=t.playback,s=t.autoplay,l=t.settings,c=t.back;return n.url&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),r.normal.background&&r.normal.background.url&&e.push(this.addAssets(r.normal.background.url,"img")),r.active.background&&r.active.background.url&&e.push(this.addAssets(r.active.background.url,"img")),i.normal.background&&i.normal.background.url&&e.push(this.addAssets(i.normal.background.url,"img")),i.active.background&&i.active.background.url&&e.push(this.addAssets(i.active.background.url,"img")),s.normal.background&&s.normal.background.url&&e.push(this.addAssets(s.normal.background.url,"img")),s.active.background&&s.active.background.url&&e.push(this.addAssets(s.active.background.url,"img")),l.normal.background&&l.normal.background.url&&e.push(this.addAssets(l.normal.background.url,"img")),l.active.background&&l.active.background.url&&e.push(this.addAssets(l.active.background.url,"img")),c.normal.background&&c.normal.background.url&&e.push(this.addAssets(c.normal.background.url,"img")),c.active.background&&c.active.background.url&&e.push(this.addAssets(c.active.background.url,"img")),Promise.all(e)},parseTemplateSettingsAssets:function(){var e=[],t=this.json_data.template.json.settings,n=t.background,a=t.header,o=t.displayHeader,r=t.textHeader,i=t.displayCaption,s=t.textCaption,l=t.fullMode,c=t.windowMode,u=t.autoOn,d=t.autoOff,h=t.back;if(this.json_data.template.json.settings.musicCaption){var f=this.json_data.template.json.settings.musicCaption;f.background&&f.background.url&&e.push(this.addAssets(f.background.url,"img"))}if(this.json_data.template.json.settings.musicVolume){var m=this.json_data.template.json.settings.musicVolume;m.normal&&m.normal.background&&m.normal.background.url&&e.push(this.addAssets(m.normal.background.url,"img")),m.progress&&m.progress.background&&m.progress.background.url&&e.push(this.addAssets(m.progress.background.url,"img"))}if(this.json_data.template.json.settings.soundCaption){var p=this.json_data.template.json.settings.soundCaption;p.background&&p.background.url&&e.push(this.addAssets(p.background.url,"img"))}if(this.json_data.template.json.settings.soundVolume){var y=this.json_data.template.json.settings.soundVolume;y.normal&&y.normal.background&&y.normal.background.url&&e.push(this.addAssets(y.normal.background.url,"img")),y.progress&&y.progress.background&&y.progress.background.url&&e.push(this.addAssets(y.progress.background.url,"img"))}if(this.json_data.template.json.settings.volumeHeader){var g=this.json_data.template.json.settings.volumeHeader;g.background&&g.background.url&&e.push(this.addAssets(g.background.url,"img"))}return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.background&&o.background.url&&e.push(this.addAssets(o.background.url,"img")),r.background&&r.background.url&&e.push(this.addAssets(r.background.url,"img")),i.background&&i.background.url&&e.push(this.addAssets(i.background.url,"img")),s.background.url&&s.background.url&&e.push(this.addAssets(s.background.url,"img")),l.unchecked.background&&l.unchecked.background.url&&e.push(this.addAssets(l.unchecked.background.url,"img")),l.checked.background&&l.checked.background.url&&e.push(this.addAssets(l.checked.background.url,"img")),c.unchecked.background&&c.unchecked.background.url&&e.push(this.addAssets(c.unchecked.background.url,"img")),c.checked.background&&c.checked.background.url&&e.push(this.addAssets(c.checked.background.url,"img")),u.unchecked.background&&u.unchecked.background.url&&e.push(this.addAssets(u.unchecked.background.url,"img")),u.checked.background&&u.checked.background.url&&e.push(this.addAssets(u.checked.background.url,"img")),d.unchecked.background&&d.unchecked.background.url&&e.push(this.addAssets(d.unchecked.background.url,"img")),d.checked.background&&d.checked.background.url&&e.push(this.addAssets(d.checked.background.url,"img")),h.normal.background&&h.normal.background.url&&e.push(this.addAssets(h.normal.background.url,"img")),h.active.background&&h.active.background.url&&e.push(this.addAssets(h.active.background.url,"img")),Promise.all(e)},parseTemplateOptionAssets:function(){var e=[],t=this.json_data.template.json.option,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)},parseTemplatePlaybackAssets:function(){var e=[],t=this.json_data.template.json.playback,n=t.background,a=t.scrollBox,o=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),a.item.background&&a.item.background.url&&e.push(this.addAssets(a.item.background.url,"img")),a.item.content.background&&a.item.content.background.url&&e.push(this.addAssets(a.item.content.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),Promise.all(e)},parseTemplateRecordAssets:function(){var e=[],t=this.json_data.template.json.record,n=t.background,a=t.scrollBox,o=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),a.item.background&&a.item.background.url&&e.push(this.addAssets(a.item.background.url,"img")),a.item.content.background&&a.item.content.background.url&&e.push(this.addAssets(a.item.content.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),Promise.all(e)},parseTemplateSoundAssets:function(){var e=[];return this.json_data.template.json.sound&&this.json_data.template.json.sound.url&&e.push(this.addAssets(this.json_data.template.json.sound.url,"audio")),Promise.all(e)},getUserInfoFromWap:function(){return new Promise(function(e,t){(0,E["default"])("https://ptlogin.3000.com/?m=ptlogin&ac=cookieuid",{},function(t,n){return t?(flashvars.uid="",e()):(n&&(flashvars.uid=n.data.uid?n.data.uid:""),e())})})},showLogo:function(){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_LOGO)},showCover:function(){this.json_data.cover.music;this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU)},showMainMenu:function(e){this.onPause(),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU,e)},showSettings:function(e,t){this.onPause(),this.mainMenuLayer.visible&&(this.mainMenuLayer.visible=!1,this.visibleLayout=[this.mainMenuLayer].concat(i(this.visibleLayout))),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS,{context:e,callbackInfo:t})},showPlayback:function(e){this.onPause(),this.mainMenuLayer.visible&&(this.mainMenuLayer.visible=!1,this.visibleLayout=[this.mainMenuLayer].concat(i(this.visibleLayout))),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK,e)},showSave:function(e,t){this.menuLayer.visible=!1,this.bToSaveFile=!0,this.loadData(e),this.showRecord(t)},showLoad:function(e,t){var n=this;this.menuLayer.visible=!1,""===flashvars.u&&""===flashvars.token&&""===flashvars.client&&(flashvars.uid=d["default"].getUidByCookie()),"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){n.getPayInfo().then(function(){n.bToSaveFile=!1,n.loadData(e),n.showRecord(t)})}):this.getPayInfo().then(function(){n.bToSaveFile=!1,n.loadData(e),n.showRecord(t)})},showRecord:function(e){this.onPause(),this.mainMenuLayer.visible&&(this.mainMenuLayer.visible=!1,this.visibleLayout=[this.mainMenuLayer].concat(i(this.visibleLayout))),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_RECORD,e)},showEnd:function(){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!1),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_END)},isPlotResourceExist:function(e){var t="ios"===flashvars.client&&"1.5.0">=flashvars.app_versionl,n=this.usingResourceCountMap(),a=0,o=function(e,t){var o=u.ResourcesManager.getCount(e,t);return!o||o==n[t]&&!u.ResourcesManager.isGlobal(e,t)&&!u.ResourcesManager.isUsingKey(t)||(a++,!1)},r=function(e){if("addImage"===e.type){var t=e.args[0],n=(t.index,t.url);return"inherit"===n||!o("img",n)}if("playMusic"===e.type||"playSound"===e.type)return"inherit"===e.args[0].url||!o("audio",e.args[0].url);if("showDialog"===e.type)return!o("img",e.args[0].avatar.url);if("options"===e.type||"conditionOptions"===e.type){var a=!0,r=!1,i=void 0;try{for(var s,l=e.args[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var c=s.value;if(c.background&&c.background.normal&&c.background.normal.url&&o("img",c.background.normal.url))return!1;if(c.background&&c.background.active&&c.background.active.url&&o("img",c.background.active.url))return!1;if(c.background&&c.background.disable&&c.background.disable.url&&o("img",c.background.disable.url))return!1;if(c.sound&&c.sound.url&&o("audio",c.sound.url))return!1}}catch(u){r=!0,i=u}finally{try{!a&&l["return"]&&l["return"]()}finally{if(r)throw i}}}else if("weather"===e.type&&"1"!==flashvars.offline&&!h(e.args[0].value))return!1;return!0},s={autotext:!1,showDialog:!1,hasOption:!1},l=function(){return!!(s.hasOption&&a>10)||(!!(s.showDialog&&!s.autotext&&a>10)||a>20)},c=function _(e){for(var t=0;t<e.length&&!l();t++){var n=e[t];if(!r(n))return!1;if("options"===n.type&&(s.hasOption=!0),"showDialog"===n.type&&(s.showDialog=!0),"autotext"===n.type&&(s.autotext=!0),"options"===n.type||"conditionOptions"===n.type)for(var a=0;a<n.args.length&&!l();a++)if(!_(n.args[a].commands))return!1}return!0},h=function(e){return("snowy"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("snow")+"/xuehua_00119.png"))&&(("rainy"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("rain")+"/xiayu_00049.png"))&&(("defoliation"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_00089.png"))&&(("fallingPeach"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("beachBlossom")+"/taohua_00089.png"))&&(("fallingFlower"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("blossom")+"/yinghua_00089.png"))&&(("lightning"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("lightning")+"/shandian_00049.png"))&&(!flashvars.vertical||"windy"!==e||!o("img","/"+d["default"].getWeatherOfflinePathName()+"/"+d["default"].getWeatherFilePathName("wind")+"/feng_00019.png")))))))};if(e.commands)return c(e.commands);if(e.background.url&&"inherit"!==e.background.url&&o("img",e.background.url))return!1;if(e.avatar.url&&o("img",e.avatar.url))return!1;if(e.music.url&&"inherit"!==e.music.url&&o("audio",e.music.url)&&!t)return!1;if(e.options.length){var f=!0,m=!1,p=void 0;try{for(var y,g=e.options[Symbol.iterator]();!(f=(y=g.next()).done);f=!0){var v=y.value;if(v.background&&v.background.normal&&v.background.normal.url&&o("img",v.background.normal.url))return!1;if(v.background&&v.background.active&&v.background.active.url&&o("img",v.background.active.url))return!1;if(v.background&&v.background.disable&&v.background.disable.url&&o("img",v.background.disable.url))return!1;if(v.sound&&v.sound.url&&o("audio",v.sound.url))return!1}}catch(x){m=!0,p=x}finally{try{!f&&g["return"]&&g["return"]()}finally{if(m)throw p}}}if(e.characters.length||e.props.length)for(var P=[].concat(i(e.characters),i(e.props)),w=0;w<P.length;w++){var k=P[w];if(o("img",k.url))return!1}if(e.weather&&"1"!==flashvars.offline&&!h(e.weather.value))return!1;for(var b in e.plot_sound)if(e.plot_sound[b]){var C=e.plot_sound[b].url;if(C&&"inherit"!==C&&!t&&o("audio",e.plot_sound[b].url))return!1}return!0},getLoadingPlotResource:function(e){var t=[];if(e.commands){var n=0,a=[],o=function s(e){for(var t=0;t<e.length&&n<20;t++){var o=e[t],r=u.ResourcesManager.getCommandResources(o);if(r.length&&(a.push.apply(a,i(r)),n++),"options"===o.type||"conditionOptions"===o.type)for(var l=0;l<o.args.length&&n<20;l++)s(o.args[l].commands)}};o(e.commands)}else t.push.apply(t,i(u.ResourcesManager.getPlotResources(e)));var r=this.viewComponent.game.load;return t.filter(function(e){var t=e.type,n=e.url;return r.getAsset("img"===t?"image":"audio",n)}).map(function(e){return Object.assign(e,{key:e.url})})},usingResourceCountMap:function(e){var t=this,n={},a=function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.viewComponent.game.world;return e.children.forEach(function(e){n[e.key]=(n[e.key]||0)+1,r(e)})},o=function(){return t.viewComponent.game.sound._sounds.forEach(function(e){return n[e.key]=(n[e.key]||0)+1})};return a(),o(),n},resetResources:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.usingResourceCountMap();u.ResourcesManager.forEachReCount(function(n,a,o){var r=t[a];r>0&&u.ResourcesManager.addRefCount(n,a,"play",r),e.some(function(e){return e.key===a})?(a===u.ResourcesManager.usingKeyMap.music&&u.ResourcesManager.addRefCount(n,a),a===u.ResourcesManager.usingKeyMap.background&&u.ResourcesManager.addRefCount(n,a),u.ResourcesManager.usingKeyMap.sounds.some(function(e){return e===a})&&u.ResourcesManager.addRefCount(n,a)):!o&&u.ResourcesManager.removeFromCache(n,a)})},getResources:function(e,t,n){var a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=arguments[4],i=o.cmdInfo,s=o.cmdIndex,l=o.cmdScreenSnap,c=t.plots,d=u.ResourcesManager.usingKeyMap,h=d.music,f=d.sounds,m=d.background;return r&&(h=r.music.url,f=r.sounds.map(function(e){return e&&e.url}),m=r.background),u.ResourcesManager.forceDecode={musics:[],sounds:new Array(10).fill("")},t.parent||n||u.ResourcesManager.resetReCount(),u.ResourcesManager.LoadedMark=[],u.ResourcesManager.gameData=this.json_data,u.ResourcesManager.sceneProxy=this,u.ResourcesManager.getResourcesByContext(e,t,n,i,s).then(function(e){var i=function(t){e.data.some(function(e){return e.key===t.key})||e.data.push(t),u.ResourcesManager.addRefCount(t.type,t.key)};if(void 0!==n&&c[n]&&!c[n].commands&&"inherit"===c[n].music.url){var s=a.getMusic(t,n);s&&i({key:s,type:"audio"})}if(r){var d=r.music,h=r.sounds,f=r.charsAndProps,m=r.background,p=r.images;m&&!e.data.some(function(e){return e.key===m})&&i({key:m,type:"img"}),d&&!e.data.some(function(e){return e.key===d.url})&&(u.ResourcesManager.forceDecode.musics.push(d.url),i({key:d.url,type:"audio"})),h&&h.forEach(function(t,n){t&&!e.data.some(function(e){return e.key===t.url})&&(u.ResourcesManager.forceDecode.sounds[n]=t.url,i({key:t.url,type:"audio"}))}),f&&f.forEach(function(t){e.data.some(function(e){return e.key===t.url})||i({key:t.url,type:"img"})}),p&&p.forEach(function(t){e.data.some(function(e){return e.key===t.url})||i({key:t.url,type:"img"})})}if(l){var y=o.cmdScreenSnap,g=y.music,v=y.sounds,x=y.charsAndProps,P=y.dialogInfo,w=y.bk;P&&P[0]&&P[0].avatar.url&&i({key:P[0].avatar.url,type:"img"}),w&&w.url&&i({key:w.url,type:"img"}),g&&g.url&&i({key:g.url,type:"audio"}),v&&v.forEach(function(e,t){return e&&e.url&&i({key:e.url,type:"audio"})}),x&&x.forEach(function(e){return e&&e.url&&i({key:e.url,type:"img"})}),""!==l.weatherType&&u.ResourcesManager.getWeatherResources(l.weatherType).forEach(function(e){e&&i({key:e.url,type:e.type})})}return e})},preloadCommandsAssets:function(e,t,n,a,o,r){var i=this;return this.getResources(e,t,n,{cmdInfo:a,cmdIndex:o},r).then(function(e){u.ResourcesManager.PreloadState.preloaded=0;var t=[];return r&&i.resetResources(e.data),e.data.forEach(function(e){t.push(i.addAssets(e.key,e.type,e.key,!0).then(function(t){return Object.assign({needLoad:t},e)}))}),Promise.all(t).then(function(e){return e.filter(function(e){return e.needLoad})})})},preloadChapterAssets:function(e,t,n,a,o,r){var i=this;return this.curChapter=t,this.curPlotIndex=n||0,this.cmdPlotSnap=a,this.getResources(e,t,n,a,o).then(function(t){u.ResourcesManager.PreloadState.preloaded=0;var n=[];return(o||r)&&i.resetResources(t.data),t.data.forEach(function(e){n.push(i.addAssets(e.key,e.type,e.key,!0).then(function(t){return Object.assign({needLoad:t},e)}))}),Promise.all(n).then(function(t){var n=t.filter(function(e){return e.needLoad});i.sendNotification(diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY,{context:e,loadData:o,needLoadList:n})})})},enableLayerInput:function(e,t){var n=function o(e,t){if(e.inputEnabled!=!t||e.text||(e.inputEnabled=t),e.children.length>0)for(var n in e.children)o(e.children[n],t)};if("recordLayer"===e.name)return void(e.visible=t);if("menuLayer"===e.name)e.children[0].inputEnabled=t;else for(var a in e.children)n(e.children[a],t)},apToFinalState:function(){if(this.charsAndPropsLayer&&this.charsAndPropsLayer.exists)for(var e=0;e<this.charsAndPropsLayer.children.length;e++){var t=this.charsAndPropsLayer.children[e],n=t.children[0];n&&n.finalState&&(n.alpha=n.finalState.alpha,n.angle=n.finalState.angle,n.x=n.finalState.x,n.y=n.finalState.y,t.x=0,t.y=0,t.scale.x=t.finalState.scale.x,t.scale.y=t.finalState.scale.y)}},removePlotTweens:function(){for(this.twinkleTimer&&this.twinkleTimer.cancel()&&(this.twinkleTimer=null);this.lstPlotTweens.length;){var e=this.lstPlotTweens.splice(0,1);e[0].stop(!0),e[0].target&&"twinkle"===e[0].target.name&&e[0].target.destroy()}this.apToFinalState()},onPause:function(){this.playPause=!0;for(var e=this.viewComponent.game.tweens._tweens.length-1;e>=0;e--){var t=this.viewComponent.game.tweens._tweens[e];t.name&&"toast"===t.name||t.pause()}this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!1)},onResume:function(){this.isQuickPlay=!0,this.playPause=!1,this.viewComponent.game.tweens.resumeAll(),this.hasCountDown&&this.viewComponent.game.time.events.start(),this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!0)},onCoverStartBtnClicked:function(){var e=this,t=this.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length){if(this.isWapOther()){var a=function(n){null===n?p["default"].error("获取付费章节信息失败"):"fail"===n?p["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,I["default"])("819786897",{debug:!1,message:"复制成功"})},function(){}):(t.plots=n?n:[],e.preloadChapterAssets(e.context,t))};return void this.unlockChapterByWapOther(n,t.charge,t.md5,a)}if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)this.checkIfChapterFree(n,t.md5).then(function(n){var a;(a=t.plots).push.apply(a,i(n)),e.preloadChapterAssets(e.context,t)},function(t){-1===t.indexOf("code=87")?p["default"].error(t):p["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买"),e.coverLayer.visible=!0});else{var o=function(a,o){a?e.checkIfChapterFree(n,t.md5).then(function(n){var a;e.unlockChapterCallBack=null,(a=t.plots).push.apply(a,i(n)),e.preloadChapterAssets(e.context,t)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():p["default"].error("获取付费章节信息失败"),e.coverLayer.visible=!0}):o&&(e.coverLayer.visible=!0)};this.unlockChapter(n,t.charge,t.md5,o)}}else this.preloadChapterAssets(this.context,t);this.coverLayer.visible=!1},onCoverLoadBtnClicked:function(){this.showLoad()},onCoverSettingBtnClicked:function(){this.showSettings(this.context)},onCoverOverBtnClicked:function(){(!flashvars.app_version||"ios"!==flashvars.client&&"android"!==flashvars.client)&&(navigator.userAgent.indexOf("MSIE")>0?navigator.userAgent.indexOf("MSIE 6.0")>0?(window.opener=null,window.close()):(window.open("","_top"),window.top.close()):navigator.userAgent.indexOf("Firefox")>0?window.location.href="about:blank ":(window.opener=null,window.open("","_self"),window.close()))},onMenuBtnClicked:function(){this.getSnap(),this.showMainMenu(this.context)},onSyMenuBtnClicked:function(){if("wap"===flashvars.client)return this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),void(window.parent&&window.parent.closGame());if("ios"===flashvars.client||"android"===flashvars.client){if(this.isWapOther())return this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),void g["default"].showSyMenu().then(function(e){1!==e&&"string"==typeof e&&-1!==e.indexOf("http")&&(window.location.href=e)});flashvars.app_version<"1.2.0"?p["default"].info("版本过低，不支持该功能"):window.app&&window.app.moreWorks()}else this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),g["default"].showSyMenu().then(function(e){1!==e&&"string"==typeof e&&-1!==e.indexOf("http")&&(window.location.href=e)})},onMainMenuSaveBtnClicked:function(){this.context.disableSaveOrLoad&&this.context.disableSaveOrLoad.save?this.showToast(1,"抱歉，作者在此设置了禁用存档"):this.showSave()},onMainMenuLoadBtnClicked:function(){this.context.disableSaveOrLoad&&this.context.disableSaveOrLoad.load?this.showToast(1,"抱歉，作者在此设置了禁用读档"):this.showLoad()},onMainMenuPlaybackBtnClicked:function(){this.showPlayback()},onMainMenuAutoplayBtnClicked:function(){this.context.auto=!this.context.auto,this.onMainMenuBackBtnClicked()},onMainMenuSettingsBtnClicked:function(){this.showSettings(this.context)},onMainMenuBackBtnClicked:function(){this.mainMenuLayer.visible=!1,this.onResume(),this.context.auto&&this.curPlotLayer.onChildInputDown.dispatch("auto")},onSettingsFullModeBtnClicked:function(){this.viewComponent.game.scale.startFullScreen(!1),this.context.fullScreen=!0},onSettingsWindowModeBtnClicked:function(){this.viewComponent.game.scale.stopFullScreen(),this.context.fullScreen=!1},onSettingsAutoOnBtnClicked:function(){this.context.auto=!0},onSettingsAutoOffBtnClicked:function(){this.context.auto=!1},onSettingsBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.visibleLayout=this.visibleLayout.slice(1),this.settingsLayer.visible=!1},onRecordBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.visibleLayout=this.visibleLayout.slice(1),this.recordLayer.visible=!1,this.showMenu()},onRecordLocalBtnClicked:function(){this.bCloudSel=!1,this.bToSaveFile?this.showSave(!0):this.showLoad(!0)},onRecordCloudBtnClicked:function(){this.bCloudSel=!0,this.bToSaveFile?this.showSave(!0):this.showLoad(!0)},showMenu:function(){this.menuLayer.visible=!0,this.curPlotInfo&&this.curPlotInfo.menu&&(this.menuLayer.visible=!this.curPlotInfo.menu.hidden)},showGuideTip:function(e){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_GUIDE,{id:e})},isSignedIn:function(){var e=this;return this.loadCloudRecord(99).then(function(t){var n=function(e){for(var t=JSON.parse(e),n=Array(12),a=0;a<t.length;a++)if(t[a].plotUuid){var o=""+t[a].time_stamp;n[a]={},n[a].plotUuid=t[a].plotUuid,n[a].timestamp=o.length>10?t[a].time_stamp:1e3*t[a].time_stamp,n[a].plotSnap="data:image/jpeg;base64,"+t[a].plot_snap}else n[a]={};return n};return e.bSignedIn=!0,e.cloudPlotsData=""===t?Array(12).fill({}):n(t),e.getPayInfo().then(function(){return e.getAccountInfo()}).then(function(){return Promise.resolve()})},function(t){return e.bSignedIn=!1,Promise.reject(t)})},findFirstChapter:function(){for(var e=function a(e){if(e.plots.length>0||e.md5)return e.isFirst=!0,e;for(var t=0;t<e.subchapters.length;t++){var n=a(e.subchapters[t]);if(n)return n}return null},t=0;t<this.json_data.chapters.length;t++){var n=e(this.json_data.chapters[t]);if(n)return n}return this.json_data.chapters[0]},notifyGameStarted:function(){return flashvars.app_version&&flashvars.app_version<"1.3.0"?void(this.isGameStarted=!0):(this.isGameStarted=!0,void("ios"===flashvars.client?1==flashvars.offline?gameStart("1"):window.webkit&&window.webkit.messageHandlers.gameStart.postMessage("1"):"android"===flashvars.client?window.app&&window.app.gameStart("1"):this.isWap3000()&&x.xhrLoad("https://www.3000.com/apis/client/v1.0/trace-play.html?id="+flashvars.gid+"&from=wap","",null)))},updateAccInfo:function(e,t){var n=this;this.context||(this.context={}),this.getPayInfo().then(function(e){n.getAccountInfo().then(function(e){t&&n.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS)})})},localRecFileToUidRecFile:function(e){var t=flashvars.uuid+flashvars.uid,n=d["default"].localStorageGetItem(t),a=d["default"].localStorageGetItem(flashvars.uuid);!n&&a&&(d["default"].localStorageSetItem(t,a),d["default"].localStorageRemoveItem(flashvars.uuid)),e||(this.recordLayer&&this.recordLayer.visible?this.bSwitchAccInPlot=!1:this.bSwitchAccInPlot=!0),""===this.gameUidBelongTo&&""!==flashvars.uid&&(this.gameUidBelongTo=flashvars.uid)},getFansInfo:function(){var e=this;"ios"!==flashvars.client&&"android"!==flashvars.client&&"wap"!==flashvars.client&&(flashvars.uid=d["default"].getUidByCookie());var t=function(t){return x.xhrLoad(t,"",null,!1).then(function(t){if(0===t.responseText.length)return Promise.resolve("Get Fans Count failed, no response data");var n=JSON.parse(t.responseText);return e.context.systemValues[9].value=n.data.fans_total,Promise.resolve(e.context.systemValues)},function(e){return Promise.resolve("跨域了("+e+")")})},n="https://pay.3000.com/?m=payinterface&op=player_one_opus_fans&opus_id="+flashvars.gid+"&uid="+flashvars.uid;return"wap"===flashvars.client?this.getUserInfoFromWap().then(function(){return n="https://pay.3000.com/?m=payinterface&op=player_one_opus_fans&opus_id="+flashvars.gid+"&uid="+flashvars.uid,t(n)}):t(n)},saveAccountInfo:function(){var e=function(e){return new Promise(function(t,n){return window.app&&window.app.saveGameValue(flashvars.uuid+"systemInfo",e),d["default"].localStorageSetItem(flashvars.uuid+"systemInfo",e),t()})},t=JSON.stringify(this.context.systemValues),n=d["default"].encodeBase64(t);return e(n)},getAccountInfo:function(){var e=this,t=function(){return new Promise(function(t,n){var a=void 0;if(window.app&&(a=window.app.readGameValue(flashvars.uuid+"systemInfo")),null===a&&(a=d["default"].localStorageGetItem(flashvars.uuid+"systemInfo")),a){for(var o=JSON.parse(d["default"].decryptBase64(a)),r=0;r<o.length;r++)for(var i=0;i<e.context.systemValues.length;i++)if(e.context.systemValues[i].uuid===o[r].uuid){e.context.systemValues[i].value=void 0===o[r].value?e.context.systemValues[i].init.value:o[r].value;
break}return t(e.context.systemValues)}for(var s=0;s<e.context.systemValues.length;s++)e.context.systemValues[s].value=e.context.systemValues[s].init.value;return t("失败")})};return this.context.systemValues||(this.context.systemValues=[{name:"闪币余额",uuid:"",key:"coinTotal",init:{type:"system",value:0}},{name:"星星余额",uuid:"",key:"starTotal",init:{type:"system",value:0}},{name:"时间戳",uuid:"",key:"timestamp",init:{type:"system",value:-1}},{name:"当前年",uuid:"",key:"year",init:{type:"system",value:-1}},{name:"当前月",uuid:"",key:"month",init:{type:"system",value:-1}},{name:"当前日",uuid:"",key:"day",init:{type:"system",value:-1}},{name:"当前小时",uuid:"",key:"hour",init:{type:"system",value:-1}},{name:"当前分钟",uuid:"",key:"minute",init:{type:"system",value:-1}},{name:"当前秒",uuid:"",key:"second",init:{type:"system",value:-1}},{name:"贡献值",uuid:"",key:"contribution",init:{type:"system",value:0}},{name:"星期",uuid:"",key:"weekday",init:{type:"system",value:0}}]),t()},getPayInfo:function(){var e=this,t=function(){return new Promise(function(t,n){var a=null;if(window.app&&(a=window.app.readGameValue(flashvars.uuid+"payInfo")),null===a&&(a=d["default"].localStorageGetItem(flashvars.uuid+"payInfo")),a){for(var o=JSON.parse(d["default"].decryptBase64(a)),r=0;r<o.length;r++)for(var i=0;i<e.json_data.payValues.length;i++)if(e.json_data.payValues[i].uuid===o[r].uuid){void 0===o[r].value&&(o[r].value=o[r].init.value||0),e.context.payValues[i]=o[r];break}return t(e.context.payValues)}return t("失败")})};return this.context.payValues||(this.context.payValues=[{name:"消费数值1",uuid:"",init:{type:"const",value:0},value:0}]),t()},savePayInfo:function(){var e=function(e){return new Promise(function(t,n){return window.app&&window.app.saveGameValue(flashvars.uuid+"payInfo",e),d["default"].localStorageSetItem(flashvars.uuid+"payInfo",e),t()})},t=JSON.stringify(this.context.payValues),n=d["default"].encodeBase64(t);return e(n)},getPayGoodsInfo:function(e){var t=this;return this.loadCloudRecord(99).then(function(t){var n=function(e,t){return x.xhrSend(e,t,null,4e3).then(function(e){if(0===e.responseText.length)return Promise.resolve({status:"error",msg:"获取商品支付信息失败",count:0});var t=JSON.parse(e.responseText);return 0===t.status&&t.success&&t.data?Promise.resolve({status:"success",msg:t.msg,count:t.data.count}):Promise.resolve({status:"fail",msg:t.msg,count:0})},function(e){return Promise.resolve({status:"error",msg:"获取商品支付信息失败",count:0})})},a=function(e){var t=[],n=0;for(var a in e)t[n]=encodeURIComponent(a)+"="+encodeURIComponent(e[a]),n++;return t.join("&")},o="https://pay.3000.com/?m=player&op=h5_purchase_market_count",r={event_id:d["default"].aesEncrypt(e,3),game_id:d["default"].aesEncrypt(flashvars.gid,3)};return"ios"!==flashvars.client&&"android"!==flashvars.client||(o="https://app.3000.com/?m=consume&op=index&ac=h5_purchase_market_count&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,r={u:d["default"].aesEncrypt(flashvars.u,1),token:d["default"].aesEncrypt(flashvars.token,1),event_id:d["default"].aesEncrypt(e,1),game_id:d["default"].aesEncrypt(flashvars.gid,1)}),n(o,a(r))},function(e){var n=e.indexOf("- status:-1");return n=n>=0?n:e.indexOf("- status:2"),n>=0?"ios"!==flashvars.client&&"android"!==flashvars.client&&"wap"!==flashvars.client?Promise.resolve({status:"success",msg:"pc端未登入，直接提示去购买！",count:-1}):(e.indexOf("- status:-110")>0?p["default"].error(e.substr(0,n)).then(function(){return t.isPaying=!1,Promise.reject()},function(){return t.isPaying=!1,Promise.reject()}):(flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),"wap"===flashvars.client?(t.isPaying=!1,window.parent&&window.parent.playLogin()):p["default"].error(e.substr(0,n)).then(function(){t.isPaying=!1,window.location.href="lzj3000://login"},function(){t.isPaying=!1})),Promise.reject()):void(0<=e.indexOf("error")&&p["default"].error("网络异常，请检查您的网络！").then(function(){return t.isPaying=!1,Promise.reject()},function(){return t.isPaying=!1,Promise.reject()}))})},getDiscounts:function(e,t,n,a){var o=function(e){return x.xhrLoad(e,"").then(function(e){if(0===e.responseText.length)return Promise.resolve("Get Discounts failed, no response data");var t=JSON.parse(e.responseText);return Promise.resolve(t.result)},function(e){return Promise.resolve("获取商品价格失败！")})},r="uuid="+e+(t?"&chapter_uuid="+t:"&product_id="+n)+"&platform="+a;this.isWapOther()&&(r+="&key=external");var i="https://mapi.3000api.com/apis/soft/v1.0/game-getCharge.html?"+r;return o(i)},payOperation:function(e,t,n,a){var o=this;this.isPaySuccess=!1;var r=-1,i=function(){var i={gid:flashvars.gid,eid:t,charge:e,special_price:r,balance:o.context.systemValues[0].value,starsNeed:100*e,stars:o.context.systemValues[1].value,starsUsed:o.usedStarCount,starsLimited:o.gameStarLimit,payValues:d["default"].encodeBase64(JSON.stringify(o.context.payValues)),indentId:n};"ios"===flashvars.client?(o.mallPayCallback=a,1==flashvars.offline?worksmall(JSON.stringify(i)):window.webkit&&window.webkit.messageHandlers.worksmall.postMessage(JSON.stringify(i))):"android"===flashvars.client?(o.mallPayCallback=a,window.app&&window.app.worksmall(JSON.stringify(i))):"wap"===flashvars.client&&(o.mallPayCallback=a,i.consume_falg="mall",i.uuid=flashvars.uuid,window.parent&&window.parent.get_account_info(JSON.stringify(i)))};return"android"===flashvars.client||"ios"===flashvars.client||"wap"===flashvars.client?flashvars.app_version<"1.2.0"&&"wap"!==flashvars.client?(p["default"].info("版本过低不支持改功能，请先更新版本~").then(function(){o.isPaying=!1},function(){o.isPaying=!1}),Promise.resolve(r)):this.getAccountInfo().then(function(n){if("string"==typeof n)p["default"].error("网络异常，请检查您的网络！"),a(!1);else if(n.status&&n.status>0&&n.status<9)flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),"wap"===flashvars.client?window.parent&&window.parent.playLogin():p["default"].info(n.msg).then(function(){window.location.href="lzj3000://login"}),a(!1);else{if(100!==n.status||n.success)return o.getDiscounts(flashvars.uuid,null,t,"app").then(function(t){return"string"==typeof t?(p["default"].error(t),a(!1)):(e=t.charge,r=t.special_price,i()),Promise.resolve(r)});a(!1)}return Promise.resolve(r)}):(p["default"].info("请前往APP或电脑端购买~").then(null,null),Promise.resolve(r))},chapterInfoProgress:function(e){var t=this.viewComponent.game.world.getByName("chapterInfoProgress");if(!t){t=this.viewComponent.game.add.group(),t.name="chapterInfoProgress";var n=this.viewComponent.game.add.graphics(0,0,t);n.beginFill(0,.5),n.drawRect(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),n.endFill(),n.name="background",n.inputEnabled=!0;var a={font:"16px 宋体",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"},o=this.viewComponent.game.add.text(0,0,"",a,t);o.setTextBounds(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),o.name="chapterInfoProgressText"}var r=t.getByName("chapterInfoProgressText");r&&(r.text="章节信息获取中..."+e)},checkIfChapterFree:function(e,t){var n=this,a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=function(e,t){var o=function(e){a&&n.chapterInfoProgress(e.loaded)};return x.xhrSend(e,t,o).then(function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");if(t&&t.destroy(),0===e.responseText.length)return Promise.reject("Get chapterInfo failed, no response data");var a=JSON.parse(e.responseText);return"100"===a.code?Promise.resolve(a.result.plots):1==flashvars.offline?Promise.resolve(a.plots):Promise.reject(a.message+" code="+a.code)},function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");return t&&t.destroy(),Promise.reject(e)})},r=function(){flashvars.u||flashvars.token||"wap"===flashvars.client||(flashvars.uid=d["default"].getUidByCookie());var a="uuid="+flashvars.uuid+"&uid="+flashvars.uid+"&chapter_uuid="+e+"&md5="+t+"&platform="+(flashvars.client?"app":"pc");n.isWapOther()&&(a+="&key=external");var r="https://mapi.3000api.com/apis/soft/v1.0/chapter-chapterInfo.html?"+a;return o(r,a)};return"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){return r()}):r()},unlockChapterByWapOther:function(e,t,n,a){var o=this;if(this.isWapOther()){var r=0,i=function(e,t,n,a){var r=-1;o.getDiscounts(e,t,null,"app").then(function(e){"string"!=typeof e&&(n=e.charge,r=e.special_price);var o=d["default"].generateUUID();d["default"].timeout(100).then(function(){p["default"].custom("Info","当前为收费章节，需支付"+n+"元解锁观看","章节收费提示","支付","取消",!1).then(function(e){_["default"].pay(n,t,o,t,null,0,function(e){a&&a(e)})},function(e){a&&a("cancel")})})})},s=function(o){"success"===o?l(e,n,t):"cancel"===o?a&&a(null):"fail"===o&&p["default"].custom("Info","未查询到你的付费信息哦，请确认已支付再点击刷新。如未购买请退出或重新购买~","提示","重试","退出",!1,3,0).then(function(){l(e,n,t)},function(){a&&a(null)})},l=function(e,t,n){r++,o.checkIfChapterFree(e,t).then(function(e){a&&a(e)},function(t){-1===t.indexOf("code=87")?p["default"].error(t).then(function(){a&&a(null)},function(){a&&a(null)}):r<=1?i(flashvars.uuid,e,n,s):r<4?s("fail"):a&&a("fail")})};l(e,n,t,a)}},unlockChapter:function(e,t,n,a){var o=this,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(flashvars.app_version<"1.2.0"&&"wap"!==flashvars.client)return r&&p["default"].info("该章节为付费章节，当前版本过低，不支持该功能"),void a(!1,!0);var i=-1;this.getDiscounts(flashvars.uuid,e,null,"app").then(function(r){if("string"!=typeof r&&(t=r.charge,i=r.special_price),"ios"===flashvars.client){var s={gid:flashvars.gid,uuid:e,charge:t,md5:n,special_price:i};o.unlockChapterCallBack=a,1==flashvars.offline?unlock(JSON.stringify(s)):window.webkit&&window.webkit.messageHandlers.unlock.postMessage(JSON.stringify(s))}else if("android"===flashvars.client)window.app&&window.app.unlock(flashvars.gid,e,t,n),o.unlockChapterCallBack=a;else if("wap"===flashvars.client){o.unlockChapterCallBack=a;var l=function(){var a={uuid:flashvars.uuid,gid:flashvars.gid,chapter_uuid:e,charge:t,md5:n,special_price:i,author_id:flashvars.uid,consume_falg:"chapter"};window.parent&&window.parent.get_account_info(JSON.stringify(a))};""===flashvars.uid?o.getUserInfoFromWap().then(function(){""===flashvars.uid?p["default"].info("该章节为付费章节，需登录后查看~").then(function(){a(!1,!0,!0),window.parent&&window.parent.playLogin()},function(){a(!1,!0,!0)}):l()}):l()}})},getPhoneData:function(){var e=encodeURIComponent(d["default"].aesEncrypt(flashvars.u,1)),t=encodeURIComponent(d["default"].aesEncrypt(flashvars.token,1)),n=encodeURIComponent(d["default"].aesEncrypt(""===flashvars.app_name?"shanyi":flashvars.app_name,1)),a=encodeURIComponent(d["default"].aesEncrypt(""===flashvars.device_name?"Google Nexus S":flashvars.device_name,1)),o=encodeURIComponent(d["default"].aesEncrypt(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer,1));return"&u="+e+"&token="+t+"&app_name="+n+"&device_name="+a+"&device_system_version="+o},loadCloudRecord:function(e){var t=function(e,t){return x.xhrSend(e,t).then(function(e){if(0===e.responseText.length)return Promise.reject("Get file failed, no response data");var t=JSON.parse(e.responseText);if(0===t.status){var n=t.data.content||"",a=d["default"].decryptBase64(n);return Promise.resolve(a)}return Promise.reject(t.msg+" - status:"+t.status)},function(e){return Promise.reject(e)})},n=flashvars.u&&flashvars.token?1:0,a=d["default"].localTime+d["default"].timeOffset,o=""===flashvars.gid?1:parseInt(flashvars.gid),r="",i=e+"";r=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+o+"&time="+a+"&token="+flashvars.token+"&type="+i+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"gid="+o+"&time="+a+"&type="+i+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M",o=d["default"].aesEncrypt(o,n),r=d["default"].aesEncrypt(f["default"].hash(f["default"].hash(r)),n),a=d["default"].aesEncrypt(a,n),i=d["default"].aesEncrypt(i,n);var s="https://my.3000.com/?m=cloud_save&op=index&ac=info&client_type=1&api_v=1.0.0&api_from=webpc",l="gid="+encodeURIComponent(o)+"&sign="+encodeURIComponent(r)+"&time="+encodeURIComponent(a)+"&type="+encodeURIComponent(i);return""!==flashvars.u&&""!==flashvars.token&&(s="https://app.3000.com/?m=cloud_save&op=index&ac=info&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,l+=this.getPhoneData()),t(s,l)},saveCloudRecord:function(e){var t=function(e,t){return x.xhrSend(e,t).then(function(e){if(0===e.responseText.length)return Promise.reject("Save file failed, no response data");var t=JSON.parse(e.responseText);return 0===t.status?Promise.resolve():Promise.reject(t.msg+": "+t.status)},function(e){return Promise.reject(e)})},n=flashvars.u&&flashvars.token?1:0,a=JSON.stringify(this.savedPlotsData[e]),o=d["default"].encodeBase64(a),r=d["default"].localTime+d["default"].timeOffset,i=""===flashvars.gid?1:parseInt(flashvars.gid),s="";s=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&content="+o+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+i+"&progress=1&time="+r+"&token="+flashvars.token+"&type="+e+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"content="+o+"&gid="+i+"&progress=1&time="+r+"&type="+e+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M";var l="https://my.3000.com/?m=cloud_save&op=index&ac=save&client_type=1&api_v=1.0.0&api_from=webpc",c="content="+encodeURIComponent(d["default"].aesEncrypt(o,n))+"&gid="+encodeURIComponent(d["default"].aesEncrypt(i,n))+"&progress="+encodeURIComponent(d["default"].aesEncrypt(1,n))+"&sign="+encodeURIComponent(d["default"].aesEncrypt(f["default"].hash(f["default"].hash(s)),n))+"&time="+encodeURIComponent(d["default"].aesEncrypt(r,n))+"&type="+encodeURIComponent(d["default"].aesEncrypt(e+"",n));return""!==flashvars.u&&""!==flashvars.token&&(l="https://app.3000.com/?m=cloud_save&op=index&ac=save&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,c+=this.getPhoneData()),t(l,c)},getViewData:function(e,t){for(var n={},a=function r(e,t){for(var a=0;a<e.length;a++)if(e[a].xInfo&&e[a].yInfo){var o={name:e[a].name,instanceUuid:e[a].instanceUuid,xInfo:e[a].xInfo,yInfo:e[a].yInfo,eventsInfo:e[a].eventsInfo,scale:e[a].scale,visible:e[a].visible};o.children=[],"TIMER"===e[a].viewType&&(n.currentCount=e[a].currentCount),r(e[a].children,o),t.children.push(o)}},o=0;e&&o<e.length;o++)e[o].parent&&(n={name:e[o].name,instanceUuid:e[o].instanceUuid,xInfo:e[o].xInfo,yInfo:e[o].yInfo,eventsInfo:e[o].eventsInfo,scale:e[o].scale,parent:e[o].parent.name,x:e[o].x,y:e[o].y,visible:e[o].visible},n.children=[],"TIMER"===e[o].viewType&&(n.currentCount=e[o].currentCount),e[o].generateType&&(n.generateType=e[o].generateType),a(e[o].children,n),t.push(n))},getViewParentEvents:function(e){var t=this.json_data.viewMap;for(var n in t){if(n===e)return t[n].events.concat();for(var a in t.children)if(t.children[a].ref===e)return t.children[a].events.concat()}},copyFlashViewData:function(e,t){var n=!0;if(t&&t.historyCommand&&t.historyCommand.hideGlobalViews)for(var a=0;a<t.historyCommand.hideGlobalViews.length;a++)if(e.instanceUuid===t.historyCommand.hideGlobalViews[a]){n=!1;break}var o={name:e.ref,instanceUuid:e.instanceUuid,xInfo:"[object Object]"===Object.prototype.toString.apply(e.x)?e.x:{type:"literal",value:e.x},yInfo:"[object Object]"===Object.prototype.toString.apply(e.y)?e.y:{type:"literal",value:e.y},scale:{x:e.scale,y:e.scale,type:25},visible:n};e.currentCount&&(o.currentCount=e.currentCount),o.children=[];for(var r=0;r<e.children.length;r++)o.children[r]=this.copyFlashViewData(e.children[r],t),o.children[r].eventsInfo=this.getViewParentEvents(e.ref);return o},getWeatherType:function(){if(!this.weatherLayer.visible)return"";var e=this.weatherLayer.getByName("wind");return e&&e.visible?"windy":(e=this.weatherLayer.getByName("snow"),e&&e.visible?"snowy":(e=this.weatherLayer.getByName("rain"),e&&e.visible?"rainy":(e=this.weatherLayer.getByName("beachBlossom"),e&&e.visible?"fallingPeach":(e=this.weatherLayer.getByName("blossom"),e&&e.visible?"fallingFlower":(e=this.weatherLayer.getByName("lightning"),e&&e.visible?"lightning":(e=this.weatherLayer.getByName("fallingLeaves"),e&&e.visible?"defoliation":""))))))},getScreenAnime:function(){return this.shakeLoopObj.loop===!0?JSON.parse(JSON.stringify(this.shakeLoopObj)):{level:0,duration:0,delay:0,loop:!1,commands:null}},saveRecord:function(e,t){var n=this;if(0===e&&this.json_data.default_settings.autoSaveOrLoad&&!t)return Promise.resolve(null);var a=function(){!n.savedPlotsData&&n.loadData();var a=Date.now(),o=[],r=[],i=[];n.getViewData(n.globalViews,o),n.getViewData(n.plotViews,r);var s={};if(s.plotUuid=n.curChapter.plots[n.curPlotIndex].uuid,s.chapterUuid=n.curChapter.uuid,s.bkKey=n.lstPlotBkKey,s.bkOpacity=n.lstPlotBkOpacity,s.bkFlex=n.lstPlotBkFlex,s.cmdUuid=n.curCmdUuid,s.bCmdAutoText=n.bCmdAutoText,s.timestamp=a,s.context=JSON.parse(JSON.stringify(n.context)),s.plotSnap=n.plotSnap,s.weatherType=n.getWeatherType(),s.globalViews=o.concat(),s.plotViews=r.concat(),s.playbackData=n.playbackData.concat(),s.animateScene={shake:null},s.animateScene.shake=n.getScreenAnime().commands,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(s.music={url:w["default"].musicInfo.key,volume:w["default"].musicInfo.prevolume||w["default"].musicInfo.volume,inheritvolume:w["default"].musicInfo.inheritvolume},s.sounds=w["default"].soundsInfo.map(function(e){return e.key?{url:e.key,volume:e.prevolume||e.volume,time:e.loop?0:1,inheritvolume:e.inheritvolume}:null})):(s.music={url:n.bk_music&&n.bk_music.key,volume:n.bk_music&&(n.bk_music.prevolume||n.bk_music.volume),inheritvolume:n.bk_music&&n.bk_music.inheritvolume},s.sounds=n.plotSounds.map(function(e){return e?{url:e.key,volume:e.prevolume||e.volume,time:e.loop?0:1,inheritvolume:e.inheritvolume}:null})),""!==n.curCmdUuid){n.charsAndPropsLayer&&n.charsAndPropsLayer.children.forEach(function(e){var t=e.children[0],n={url:t.key,x:t.x,y:t.y,width:t.width,height:t.height,opacity:t.alpha,pivotX:t.pivot.x,pivotY:t.pivot.y,scaleX:t.scale.x,scaleY:t.scale.y,rotate:t.angle,cmdUuid:t.cmdUuid,index:e.zIndex,parentScale:e.scale.x,mirrorH:!!t.mirrorH&&t.mirrorH,mirrorV:!!t.mirrorV&&t.mirrorV};t.finalState&&(n.x=t.finalState.x,n.y=t.finalState.y,n.opacity=t.finalState.alpha,n.rotate=t.finalState.angle),e.finalState&&(n.parentScale=e.finalState.scale.x),i.push(n)});var l=n.curPlotLayer.children[1];s.bk={},l&&(s.bk={url:l.key,opacity:l.alpha},l.finalState&&(s.bk.opacity=l.finalState.alpha))}return s.charsAndProps=i.concat(),s.dialogInfo=n.lstDialogInfo.concat(),s.menuInfo=n.menuInfo.concat(),n.savedPlotsData[e]=JSON.parse(JSON.stringify(s)),n.bSignedIn&&n.bCloudSel&&(n.cloudPlotsData[e]=JSON.parse(JSON.stringify(s))),n.saveData(e,t).then(function(e){return Promise.resolve(s)},function(e){return Promise.resolve(null)})};return t!==!0||this.bSignedIn===!0?a():void this.isSignedIn().then(function(){return n.bCloudSel=!0,a()},function(){return a()})},loadRecord:function(e){var t=this;!this.savedPlotsData&&this.loadData();var n=this.savedPlotsData[e],a=n.plotUuid,o=n.chapterUuid,r=n.context,s=n.playbackData,l=function(n,a){t.destroyAll(),t.lstPlotBkKey=t.savedPlotsData[e].bkKey,t.lstPlotBkOpacity=t.savedPlotsData[e].bkOpacity,t.lstPlotBkFlex=t.savedPlotsData[e].bkFlex,t.globalViews=t.savedPlotsData[e].globalViews.concat(),t.plotViews=t.savedPlotsData[e].plotViews.concat(),t.charsAndPropsInfo=t.savedPlotsData[e].charsAndProps.concat(),t.lstDialogInfo=t.savedPlotsData[e].dialogInfo?t.savedPlotsData[e].dialogInfo.concat():[],t.menuInfo=t.savedPlotsData[e].menuInfo?t.savedPlotsData[e].menuInfo.concat():[],t.curCmdUuid=t.savedPlotsData[e].cmdUuid,t.bCmdAutoText=t.savedPlotsData[e].bCmdAutoText,t.visibleLayout[0]&&(t.visibleLayout[0].visible=!0),t.visibleLayout=t.visibleLayout.slice(1),t.recordLayer.visible=!1,t.mainMenuLayer.visible=!1,t.endLayer.visible=!1,t.onResume(),t.removePlotTweens(),s.forEach(function(e){return t.addPlayBackContent(e)});var o={};t.curCmdUuid&&(""!==t.savedPlotsData[e].weatherType&&("snow"!==t.savedPlotsData[e].weatherType&&"wind"!==t.savedPlotsData[e].weatherType&&"rain"!==t.savedPlotsData[e].weatherType||(t.savedPlotsData[e].weatherType+="y")),o=t.getCommandByCommandUuid(d.plots[a],t.curCmdUuid),o.cmdScreenSnap={charsAndProps:t.charsAndPropsInfo,sounds:t.savedPlotsData[e].sounds,music:t.savedPlotsData[e].music,plotViews:t.plotViews,dialogInfo:t.lstDialogInfo,menuInfo:t.menuInfo,bk:t.savedPlotsData[e].bk,weatherType:t.savedPlotsData[e].weatherType},o.animateScene={shake:null},t.savedPlotsData[e].animateScene&&t.savedPlotsData[e].animateScene.shake&&(o.animateScene.shake=Object.assign(t.savedPlotsData[e].animateScene.shake,{}))),t.initContext(r,!0),r.commandInserts&&(t.context.commandInserts=r.commandInserts.concat());var i={music:t.savedPlotsData[e].music,sounds:t.savedPlotsData[e].sounds,charsAndProps:t.charsAndPropsInfo,background:t.lstPlotBkKey,images:[t.lstDialogInfo&&t.lstDialogInfo[0]?{url:t.lstDialogInfo[0].avatar.url}:{}]};t.preloadChapterAssets(t.context,n,a,o,i),t.coverLayer.visible=!1,!t.isGameStarted&&t.notifyGameStarted()},c=function(e,n){if(n<0){var r=t.getChapterByPlotUuid(t.json_data,a,o),i=r.chapter,s=r.index;l(i,s)}else l(e,n)};if(!a)return!1;var u=this.getChapterByPlotUuid(this.json_data,a,o),d=u.chapter,h=u.index,f=d.downloadUuid?d.downloadUuid:d.uuid,m=function(){var e=function(e){e&&t.checkIfChapterFree(f,d.md5).then(function(e){var n;t.isPreferentialFinished=!1,t.unlockChapterCallBack=null,(n=d.plots).push.apply(n,i(e)),c(d,h)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():p["default"].error("获取付费章节信息失败")})};t.unlockChapter(f,d.charge,d.md5,e)};if(this.isPreferentialFinished===!1||"android"!==flashvars.client&&"ios"!==flashvars.client||this.checkIfChapterFree(f,d.md5).then(function(e){e.length<=0?m():t.isPreferentialFinished=!1},function(e){m()}),d&&d.md5&&0===d.plots.length){if(this.isWapOther()){var y=function(e){if(null===e)p["default"].error("获取付费章节信息失败");else if("fail"===e)p["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,I["default"])("819786897",{debug:!1,message:"复制成功"})},function(){});else{var t;(t=d.plots).push.apply(t,i(e?e:[])),c(d,h)}};return void this.unlockChapterByWapOther(f,d.charge,d.md5,y)}!d.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client?this.checkIfChapterFree(f,d.md5).then(function(e){var t;(t=d.plots).push.apply(t,i(e)),c(d,h)},function(e){-1===e.indexOf("code=87")?p["default"].error(e):p["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")}):""!==flashvars.uid&&"wap"===flashvars.client?this.checkIfChapterFree(f,d.md5).then(function(e){var t;(t=d.plots).push.apply(t,i(e)),c(d,h)},function(){m()}):m()}else d&&-4!==h&&l(d,h);return!0},onRecordItemClicked:function(e,t){var n=this,a=4*t+e,o=function(){return n.bToSaveFile?n.gameUidBelongTo!==n.recUidBelongTo&&""!==n.gameUidBelongTo||n.recUidBelongTo!==flashvars.uid?p["default"].info("存档失败，请登录正确的账号后重新尝试"):n.saveRecord(a).then(function(e){if(!e)return!1;var t=n.recordLayer.getByName("scrollPane").children.find(function(e){return e.name==="recordItem_"+a}),o=t.getByName("content"),r=t.getByName("textTime"),i=function(e){var t=o.width,n=o.height;o.loadTexture(e),o.width=t,o.height=n},s=f["default"].hash(e.plotSnap);n.viewComponent.game.load.cache.checkImageKey(s)?i(s):n.addImageUrl(e.plotSnap,s).then(function(){return i(s)});var l=d["default"].getCurrentDateTime(e.timestamp);if(b["default"].fontFamily){var c=n.json_data.font.size?n.toRealImageFontHeight(r.fontSize):r.fontSize,u=n.json_data.font.size?n.toRealImageFontWidth(r.fontSize):r.fontSize;n.addImageFontText([{data:l}],u,c,r,n.context),r.text=" "}else r.text=l}):n.recUidBelongTo===flashvars.uid?(n.gameUidBelongTo=n.recUidBelongTo,n.savedPlotsData&&n.savedPlotsData[a].plotUuid&&!n.savedPlotsData[a].context?n.loadCloudRecord(a).then(function(e){var t=function(e){var t=JSON.parse(e);if(t.context)n.savedPlotsData[a]=t;else{n.savedPlotsData[a].plotUuid=t.plotUuid,n.savedPlotsData[a].chapterUuid=t.chapterUuid?t.chapterUuid:void 0,n.savedPlotsData[a].bkKey=t.backgroundObject?t.backgroundObject.url:null,n.savedPlotsData[a].context={},n.savedPlotsData[a].context.auto=!1,n.savedPlotsData[a].context.fullScreen=!1,n.savedPlotsData[a].context.values=[],n.savedPlotsData[a].context.savedValues=[],n.savedPlotsData[a].context.stringValues=[],n.savedPlotsData[a].context.indexValues=[];for(var o=0;o<t.values.length;o++)if(t.values[o].saved){for(var r=n.savedPlotsData[a].context.savedValues.length,i=0;i<n.json_data.savedValues.length;i++)if(n.json_data.savedValues[i].uuid===t.values[o].key){r=i;break}n.savedPlotsData[a].context.savedValues[r]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].index){for(var s=n.savedPlotsData[a].context.indexValues.length,l=0;l<n.json_data.indexValues.length;l++)if(n.json_data.indexValues[l].uuid===t.values[o].key){s=l;break}n.savedPlotsData[a].context.indexValues[s]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].init&&"string"===t.values[o].init.type){for(var c=n.savedPlotsData[a].context.stringValues.length,u=0;u<n.json_data.stringValues.length;u++)if(n.json_data.stringValues[u].uuid===t.values[o].key){c=u;break}n.savedPlotsData[a].context.stringValues[c]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].key&&"_"!==t.values[o].key[2]&&!t.values[o].pay){for(var d=n.savedPlotsData[a].context.values.length,h=0;h<n.json_data.values.length;h++)if(n.json_data.values[h].uuid===t.values[o].key){d=h;break}n.savedPlotsData[a].context.values[d]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}n.savedPlotsData[a].context.stack=(t.stack||[]).concat(),n.savedPlotsData[a].context.cmdStack=(t.cmdStack||[]).concat(),n.savedPlotsData[a].globalViews=[],n.savedPlotsData[a].plotViews=[];for(var f=0;f<t.globalViewsData.length;f++)n.savedPlotsData[a].globalViews[f]=n.copyFlashViewData(t.globalViewsData[f],t.commandObj),n.savedPlotsData[a].globalViews[f].x=n.Expression.safeEval(t.globalViewsData[f].x,n.savedPlotsData[a].context)*(1-t.globalViewsData[f].scale),n.savedPlotsData[a].globalViews[f].y=n.Expression.safeEval(t.globalViewsData[f].y,n.savedPlotsData[a].context)*(1-t.globalViewsData[f].scale),n.savedPlotsData[a].globalViews[f].parent="__world";for(var m=0;m<t.viewsData.length;m++)n.savedPlotsData[a].plotViews[m]=n.copyFlashViewData(t.viewsData[m],t.commandObj),n.savedPlotsData[a].plotViews[m].x=n.Expression.safeEval(t.viewsData[m].x,n.savedPlotsData[a].context)*(1-t.viewsData[m].scale),n.savedPlotsData[a].plotViews[m].y=n.Expression.safeEval(t.viewsData[m].y,n.savedPlotsData[a].context)*(1-t.viewsData[m].scale),n.savedPlotsData[a].plotViews[m].parent="plotViewsLayer";if(n.savedPlotsData[a].music=t.musics[0]?{url:t.musics[0].url,volume:t.musics[0].volume}:{},n.savedPlotsData[a].sounds=t.sounds.concat(),n.savedPlotsData[a].playbackData=t.speakings.concat(),n.savedPlotsData[a].bk={},n.savedPlotsData[a].charsAndProps=[],n.savedPlotsData[a].dialogInfo=[],n.savedPlotsData[a].cmdUuid="",n.savedPlotsData[a].weatherType="",n.savedPlotsData[a].bCmdAutoText=!1,t.commandObj&&t.commandObj.historyCommand){var p=t.commandObj.historyCommand,y=p.images,g=p.dialog,v=p.autoText,x=p.weather;if(n.savedPlotsData[a].cmdUuid=t.commandObj.commandUuid,n.savedPlotsData[a].bCmdAutoText=!!v&&v.args[0],n.savedPlotsData[a].dialogInfo=g&&g.command?g.command.args:[],n.savedPlotsData[a].weatherType=x&&x.args[0],t.commandObj.historyCommand.animateScene?n.savedPlotsData[a].animateScene=t.commandObj.historyCommand.animateScene:n.savedPlotsData[a].animateScene=null,y)for(var P=0;P<y.length;P++)if(y[P].index>1){var w={url:y[P].url,x:y[P].x,y:y[P].y,width:y[P].width,height:y[P].height,opacity:y[P].opacity,rotate:y[P].rotate,index:y[P].index,mirrorH:!!y[P].mirrorH&&y[P].mirrorH,mirrorV:!!y[P].mirrorV&&y[P].mirrorV};n.savedPlotsData[a].charsAndProps.push(w)}else 1===y[P].index&&(n.savedPlotsData[a].bk={url:y[P].url,opacity:y[P].opacity})}t.commandInserts&&t.commandInserts.length&&(n.savedPlotsData[a].context.commandInserts=t.commandInserts.concat()),n.cloudPlotsData[a]=JSON.parse(JSON.stringify(n.savedPlotsData[a]))}};t(e),n.loadRecord(a),n.showMenu()},function(){p["default"].error("获取存档数据失败")}):(n.loadRecord(a),n.showMenu())):p["default"].info("读档失败，请登录正确的账号后重新尝试"),!0};if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var r=d["default"].getUidByCookie();flashvars.uid=r}return"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){return o()}):o()},onPlaybackBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.playBackLayer.removeAll(!0),this.visibleLayout=this.visibleLayout.slice(1),this.playBackLayer.visible=!1},addPlayBackContent:function(e){this.sendNotification(diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT,e)},showLoadingToast:function(e){1===e?(this.loadingToastLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.loadingToastLayer)):0===e&&(this.loadingToastLayer.visible=!1)},showToast:function(e,t){var n=this.toastLayer.getByName("typeSuccess"),a=this.toastLayer.getByName("typeError");n&&(0===e?(n.visible=!0,n.children[2].text=t,n.children[0].width=n.children[2].width+36,n.x=(this.viewComponent.game.world.width-n.children[0].width)/2,n.y=flashvars.vertical?100:252):n.visible=!1),a&&(1===e?(a.visible=!0,a.children[2].text=t,a.children[0].width=a.children[2].width+36,a.children[1].visible=!0,a.children[2].x=30,a.x=(this.viewComponent.game.world.width-a.children[0].width)/2,a.y=flashvars.vertical?100:252):2===e?(a.visible=!0,a.children[2].text=t,a.children[0].width=a.children[2].width+20,a.children[1].visible=!1,a.children[2].x=10,a.x=(this.viewComponent.game.world.width-a.children[0].width)/2,a.y=flashvars.vertical?100:252):a.visible=!1),this.toastLayer.alpha=0,this.viewComponent.game.world.bringToTop(this.toastLayer),this.viewComponent.game.add.tween(this.toastLayer).from({alpha:1},2500,null,!0).name="toast"},addRetroText:function(e,t,n,a,o){var r=this.viewComponent.game.add.retroFont(b["default"].fontFamily,b["default"].charWidth,b["default"].charHeight,b["default"].fontChars,b["default"].countPerRow),i=this.viewComponent.game.add.image(e?e:0,t?t:0,r);return i.fontImg=r,document.body.clientWidth<document.body.clientHeight&&(r.stamp.angle=-90),o&&(r.setText(o,!0,0,0,"center",!0),n&&(i.width=n),a&&(i.height=a)),i},addImageFontTextColors:function(e,t,n){t.colors.splice(0,t.colors.length);var a=0,o=this.json_data.default_settings.color;t.fill=o;for(var r=0;r<e.length;r++){var i="";if(!e[r].lineBreak){if(i=e[r].placeholder&&"\\"===e[r].data[0]?this.Expression.parseWaitTime(e[r].data):this.Expression.parseValue(e[r].data,n),o=e[r].color?e[r].color:this.json_data.default_settings.color,"#"===o[0]&&4===o.length){var s="#"+o[1]+o[1]+o[2]+o[2]+o[3]+o[3];o=s}t.addColor(o,a),a+=i.length}}},addImageFontText:function(e,t,n,a,o,r,i){var s=this,l=this.Expression;if(a.children.length){for(var c=a.children[0],u=a.children[1],d=0;d<c.children.length;d++){var h=c.getChildAt(d),f=h.fontImg;f.destroy(),h.destroy()}c.destroy(),u&&u.destroy(),a.removeChildren()}var m=0,p=0,y="#fffffe",g=0,v=0,x=parseFloat(n),P=parseFloat(t),w=this.json_data.font.size?this.json_data.font.size.target.height?this.json_data.font.size.target.height:this.json_data.font.size.target:this.json_data.default_settings.font_size,k=this.json_data.font.size?x*this.json_data.font.size.source/w:x,C=this.json_data.font.size?1.5*k-x:.5*k,_=[],S={content:"",color:"#fffffe",x:0,y:0,space:0},I=0,L=[];
p+=.5*C;for(var E=0;E<e.length;E++){var M="";if(e[E].lineBreak){if(E===e.length-1)break;p+=x+C,m=0}else{M=e[E].placeholder&&"\\"===e[E].data[0]?l.parseWaitTime(e[E].data):l.parseValue(e[E].data,o);for(var T=0;T<M.length;T++){a.colors[I]&&(y=a.colors[I],"#ffffff"===y&&(y="#fefefe"));var O=b["default"].getLeftMargin(M[T],P),A=b["default"].getCharSpace(M[T],P),V=m+O;V+A>a.style.wordWrapWidth&&(g<V+A&&(g=V+A),m=0,V=m+O,p+=x+C,v=O),0===S.space&&(S.space=A,S.color=y,S.x=V,S.y=p,0===v&&(v=O)),32===M[T].charCodeAt(0)||160===M[T].charCodeAt(0)||" "===M[T]||"　"===M[T]||8195===M[T].charCodeAt(0)?(S.content&&_.push(S),_.push({content:M[T],color:y,x:V,y:p,space:A}),S={content:"",color:"#fffffe",x:0,y:0,space:0}):S.space!==A||S.color!==y||S.y!==p||P!==A?(S.content&&_.push(S),S={content:M[T],color:y,x:V,y:p,space:A}):S.content+=M[T],L.push({x:V,y:p,space:A,bottomInText:p+x}),I++,m+=A}}}if(e.length){S.content&&(_[_.length-1]!==S&&_.push(S),g<m&&(g=m));var N=this.viewComponent.game.add.sprite(0,0);if(_.forEach(function(e){if(32!==e.content.charCodeAt(0)&&160!==e.content.charCodeAt(0)&&" "!==e.content&&"　"!==e.content&&8195!==e.content.charCodeAt(0)){var t=s.addRetroText(e.x,e.y,P*e.content.length,x,e.content);t.tint=parseInt(e.color.replace("#","0x")),N.addChild(t)}}),N.extWidth=g,N.extMargin=v,a.addChild(N),a.posInfo=L,_.length&&(a.imgFBottom=_[_.length-1].y+x),r){var j=this.viewComponent.game.add.graphics(0,0),B=a.style.wordWrapWidth,R=i?540:this.json_data.template.json.dialog.rect.height;j.beginFill(16777215),j.drawRect(-B,-R,2*B,R),j.drawRect(-B,0,B,x),j.endFill(),N.mask=j,a.addChild(j)}}},saveData:function(e,t){var n=this;return new Promise(function(a,o){flashvars.uuid&&!n.bCloudSel?(d["default"].localStorageSetItem(flashvars.uuid+flashvars.uid,JSON.stringify(n.savedPlotsData)),!t&&n.showToast(0,"存档成功，下次可以从这里读档继续哦~"),a()):flashvars.gid&&n.bCloudSel&&(n.showLoadingToast(1),n.saveCloudRecord(e).then(function(e){n.showLoadingToast(0),!t&&n.showToast(0,"存档成功，下次可以从这里读档继续哦~"),a()},function(e){n.showLoadingToast(0),!t&&n.showToast(1,"存档失败，请检查您的网络哦~"),o()}))})},loadData:function(e){var t=this,n=function(){if(t.bCloudSel?""===t.recUidBelongTo&&(t.recUidBelongTo=flashvars.uid):t.recUidBelongTo=flashvars.uid,flashvars.uuid)if(t.bSignedIn&&t.bCloudSel)t.savedPlotsData=JSON.parse(JSON.stringify(t.cloudPlotsData));else{var e=d["default"].localStorageGetItem(flashvars.uuid+flashvars.uid);e&&"ios"===flashvars.client&&(e=e.replace(/\n/g,""),e=e.replace(/\r/g,"")),t.savedPlotsData=JSON.parse(e)}t.savedPlotsData||(t.savedPlotsData=Array(12).fill({}))};if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var a=d["default"].getUidByCookie();""!==a&&flashvars.uid!==a?(flashvars.uid=a,this.localRecFileToUidRecFile(e)):flashvars.uid=a}"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){n()}):n()},getSnap:function(){var e=document.createElement("canvas");e.width=this.isWapOther()||"wap"===flashvars.client?this.viewComponent.game.world.width:this.viewComponent.game.world.width/3,e.height=this.isWapOther()||"wap"===flashvars.client?this.viewComponent.game.world.height:this.viewComponent.game.world.height/3,this.viewComponent.game.updateRender(1);var t=e.getContext("2d"),n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;n>a?(flashvars.vertical?(t.save(),t.translate(0,e.height),t.rotate(-90*Math.PI/180),t.drawImage(this.viewComponent.game.canvas,0,0),t.restore()):t.drawImage(this.viewComponent.game.canvas,0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height,0,0,e.width,e.height),this.plotSnap=e.toDataURL("image/jpeg",.3)):(flashvars.vertical?t.drawImage(this.viewComponent.game.canvas,0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height,0,0,e.width,e.height):(t.save(),t.translate(0,e.height),t.rotate(-90*Math.PI/180),t.drawImage(this.viewComponent.game.canvas,0,0),t.restore()),this.plotSnap=e.toDataURL("image/jpeg",.3))},getChapterByPlotUuid:function(e,t,n){var a=function(e,t,n,a){var r=null;return a&&t.uuid!==a?r:(a&&t.uuid===a&&0===t.plots.length&&(r={chapter:t,index:-4}),e.find(function(e,a){return e.uuid===n?r={chapter:t,index:a}:t.plots[a].options&&(r=o(t,a,n)),null!==r}),r)},o=function(e,t,n){var o=null,r=e.plots[t];return r.options.find(function(r,i){return o=a(r.plots,{plots:r.plots,parent:{pChapter:e,pnPlot:t},uuid:e.uuid,md5:e.md5,downloadUuid:e.downloadUuid},n),null!==o}),o?o:(r.condition_options&&r.condition_options.find(function(r,i){return o=a(r.plots,{plots:r.plots,parent:{pChapter:e,pnPlot:t},uuid:e.uuid,md5:e.md5,downloadUuid:e.downloadUuid},n),null!==o}),o)},r=function s(e,t,n){var o=null;return(o=a(e.plots,e,t,n))?o:(e.subchapters.find(function(a,r){return o=s(e.subchapters[r],t,n),null!==o}),o)},i=null;return e.chapters.find(function(a,o){return i=r(e.chapters[o],t,n),null!==i}),i&&(-4!==i.index||i.chapter.md5)||p["default"].error("该剧情已被作者删除啦！\r\n无法从该剧情继续哦~"),i},getCommandByCommandUuid:function(e,t){var n=function(e,t,n){for(var o=0;o<e.length;o++){var r=null;if(r=a({commands:e[o].commands,parentInfo:t,parentCmdIndex:n}),null!==r.cmdInfo)return r}return null},a=function(e){var a=null;return e.commands.find(function(o,r){return o.uuid===t?a={cmdIndex:r,uuid:t,cmdInfo:{commands:e.commands,parentInfo:e.parentInfo,parentCmdIndex:e.parentCmdIndex}}:"options"!==o.type&&"conditionOptions"!==o.type||(a=n(o.args,e,r)),null!==a}),null===a?{cmdIndex:-1,cmdInfo:null}:a},o={commands:e.commands,parentInfo:null,parentCmdIndex:-1};return a(o)},getMusic:function(e,t){for(var n=null,a=t;a>=0;a--){var o=e.plots[a];o.music&&"inherit"!==o.music.url&&(n=o.music.url)}return!n&&e.parent?this.getMusic(e.parent.pChapter,e.parent.pnPlot):!n&&e.isFirst&&this.json_data.cover.music&&"inherit"!==this.json_data.cover.music.url?this.json_data.cover.music.url:n},getCmdScreenSnap:function(){var e=this.bk_music,t=this.plotSounds,n=this.curPlotLayer,a=n.children[1],o=[],r=[],i=this.lstDialogInfo.concat(),s=this.menuInfo.concat(),l=e?{url:e.key,volume:e.volume}:null,c=t.map(function(e){return e?{url:e.key,volume:e.volume,time:e.loop?0:1}:null}),u=a?{url:a.key,opacity:a.alpha,width:a.width,height:a.height}:null;return this.apToFinalState(),this.charsAndPropsLayer&&this.charsAndPropsLayer.children.forEach(function(e){var t=e.children[0],n={url:t.key,x:t.x,y:t.y,width:t.width,height:t.height,opacity:t.alpha,pivotX:t.pivot.x,pivotY:t.pivot.y,scaleX:t.scale.x,scaleY:t.scale.y,rotate:t.angle,cmdUuid:t.cmdUuid,index:e.zIndex,parentScale:e.scale.x};o.push(n)}),this.getViewData(this.plotViews,r),{bk:u,charsAndProps:o,sounds:c,music:l,plotViews:r,dialogInfo:i,menuInfo:s,autoText:this.bCmdAutoText,weatherType:this.getWeatherType()}},getNextPlot:function(e,t,n,a,o){var r=d["default"].searchChapterByUUID,s=this.json_data,l=this.Expression,c=s,u={cmdIndex:0,cmdInfo:null,cmdScreenSnap:null,animateScene:{shake:null}},h=n,f=t,m=void 0,p=void 0,y=t.plots[n];if(h++,"option"===a){if(y.options[o]){var g={};g.type="options",g.index=o,g.loopCondition=null,g.loopCount=1,e.stack=[g].concat(i(e.stack)),f={plots:y.options[o].plots,parent:{pChapter:f,pnPlot:n},uuid:t.uuid},h=0}}else if(y&&!y.insert&&!y.jump&&!y.back&&!a){var v=(y.condition_options||[]).findIndex(function(t){return l.safeEval(t.expression,e)&&(!t.count||parseInt(l.safeEval(t.count,e))>0)}),x=v<0?null:y.condition_options[v];if(x){var P={};P.type="condition_options",P.index=v,P.loopCondition="loop"===x.type||"countLoop"===x.type?x.expression:null,P.loopCount=1,P.loopCountExpr=x.count,e.stack=[P].concat(i(e.stack)),h=0,f={plots:x.plots,parent:{pChapter:t,pnPlot:n},uuid:t.uuid}}}if(y&&(y.jump&&!a||y.jump&&"nextPlot"===a||"jump"===a)){var w="jump"===a?o:y.jump,k=r(c,w);k&&(f=k,h=0,e.stack=[],e.cmdStack=[])}if(y&&(y.back||"back"===a)&&(h=-2,e.stack=[]),y&&"jumpOption"===a){e=JSON.parse(JSON.stringify(this.context));for(var b=0;b<o&&f.parent&&(e.stack[0]&&"insert"!==e.stack[0].type);b++)e.stack=e.stack.splice(1),h=f.parent.pnPlot,f=f.parent.pChapter;-1!==h&&(this.context=e,h++)}if(y&&"backOption"===a){e=JSON.parse(JSON.stringify(this.context));for(var C=0;C<o&&f.parent&&(e.stack[0]&&"insert"!==e.stack[0].type);C++)e.stack=e.stack.splice(1),h=f.parent.pnPlot,f=f.parent.pChapter;if(-1<h)return this.context=e,{chapter:f,nIndex:h,context:e}}if(y&&(y.insert&&!a||"insertPlot"===a&&o)){var _=o||y.insert,S=r(c,_);if(S){var I={};I.type="insert",I.isCommand=!!t.plots[n].commands,I.cmdInfo=I.isCommand?this.curCmdInfo:null,I.cmdIndex=I.isCommand?this.curCmdIndex:null,I.cmdScreenSnap=I.isCommand?this.getCmdScreenSnap():null,I.isCommand&&(e.cmdStack=[{type:"insert"}].concat(i(e.cmdStack))),I.loopCondition=null,I.loopCount=1,I.pPlotUuid=f.plots[h-1].uuid,I.chapterUuid=f.uuid,I.animateScene={shake:null},I.animateScene.shake=this.getScreenAnime().commands,e.stack=[I].concat(i(e.stack)),f={plots:S.plots,md5:S.md5,uuid:S.uuid,downloadUuid:S.downloadUuid,charge:S.charge,parent:{pChapter:f,pnPlot:h-1}},h=0,this.mainMenuLayer.visible&&(this.mainMenuLayer.children[1]&&this.mainMenuLayer.children[1].isMenu&&this.sendNotification(diygamePlayer.AppConstants.SCENE_DESTROY_VIEW,{name:this.mainMenuLayer.children[1].name,isMainMenu:!0}),this.onMainMenuBackBtnClicked())}}for(;!f.plots[h]&&0!==h&&f.plots.length&&e.stack&&0<e.stack.length||!f.plots[h]&&0===h&&!f.plots.length&&!f.md5&&e.stack&&0<e.stack.length;){var L=e.stack[0];if(L.loopCondition&&l.safeEval(L.loopCondition,e)){if(h=0,L.loopCount&&L.loopCount++,!L.loopCountExpr)break;var E=parseInt(l.safeEval(L.loopCountExpr,e));if(L.loopCount<=E)break}if(e.stack=e.stack.splice(1),"insert"===L.type&&e.cmdStack.length&&e.cmdStack[0].type&&"insert"===e.cmdStack[0].type&&(p=e.cmdStack[0],e.cmdStack=e.cmdStack.splice(1),e.commandInserts))for(var M=0;M<e.commandInserts.length;M++)if(L.pPlotUuid===e.commandInserts[M].uuid){var T=this.getChapterByPlotUuid(this.json_data,L.pPlotUuid,L.chapterUuid);if(null===T||T.chapter&&T.index===-4)break;var O=this.getCommandByCommandUuid(T.chapter.plots[T.index],e.commandInserts[M].data.commandUuid);if(L.cmdInfo=O.cmdInfo,L.cmdIndex=O.cmdIndex,e.commandInserts[M].data.historyCommand){var A={charsAndProps:[],sounds:Array(12),music:null,plotViews:[],menuInfo:[]},V=e.commandInserts[M].data.historyCommand,N=V.images,j=V.dialog,B=V.autoText,R=V.weather,D=V.viewsData;if(A.autoText=!!B&&B.args[0],A.dialogInfo=j&&j.command?j.command.args:[],A.weatherType=R?R.args[0]:"",N)for(var F=0;F<N.length;F++)if(N[F].index>1){var U={url:N[F].url,x:N[F].x,y:N[F].y,width:N[F].width,height:N[F].height,opacity:N[F].opacity,rotate:N[F].rotate,index:N[F].index};A.charsAndProps.push(U)}else 1===N[F].index&&(A.bk={url:N[F].url,opacity:N[F].opacity});if(D&&D.length)for(var W=0;W<D.length;W++)A.plotViews[W]=this.copyFlashViewData(D[W]),A.plotViews[W].x=0,A.plotViews[W].y=0,A.plotViews[W].parent="plotViewsLayer";L.cmdScreenSnap=A}break}if(f.parent&&"insert"!==L.type)u.cmdIndex=L.isCommand?L.cmdIndex+1:-1,u.cmdInfo=L.cmdInfo,u.cmdScreenSnap=L.cmdScreenSnap,h=L.isCommand?f.parent.pnPlot:f.parent.pnPlot+1,f=f.parent.pChapter;else if(L.pPlotUuid&&"insert"===L.type){u.cmdIndex=L.isCommand?L.cmdIndex+1:-1,u.cmdInfo=L.cmdInfo,u.cmdScreenSnap=L.cmdScreenSnap,L.animateScene&&null!==L.animateScene.shake&&(u.animateScene.shake=Object.assign(L.animateScene.shake,{}));var G=this.getChapterByPlotUuid(this.json_data,L.pPlotUuid,L.chapterUuid),z=G.chapter,H=G.index;h=L.isCommand?H:H+1,f=z,m=L}}return{chapter:f,nIndex:h,cmdPlotSnap:u,context:e,preStackFrame:m,preCmdStackFrame:p}},getNextCommand:function(e,t,n,a){var o=this.Expression,r=t,s=n;if(s++,"options"===a.type){var l=t.commands[n].args;if(a.index>=0&&l[a.index].commands.length>0){var c={};c.loopCondition=null,c.loopCount=1,e.cmdStack=[c].concat(i(e.cmdStack)),s=0,r={commands:l[a.index].commands,parentInfo:t,parentCmdIndex:n}}else this.optionLayer.destroy()}else if("cdtOptions"===a.type){var u=t.commands[n].args,d=u.findIndex(function(t){return o.safeEval(t.expression,e)&&(!t.count||parseInt(o.safeEval(t.count,e))>0)}),h=d<0?null:u[d];if(h){var f={};f.loopCondition="loop"===h.type||"countLoop"===h.type?h.expression:null,f.loopCount=1,f.loopCountExpr=h.count,e.cmdStack=[f].concat(i(e.cmdStack)),s=0,r={commands:h.commands,parentInfo:t,parentCmdIndex:n}}}else if("backOption"===a.type){for(var m=0;m<a.eArg&&r.parentInfo&&(e.cmdStack[0]&&"insert"!==e.cmdStack[0].type);m++)e.cmdStack=e.cmdStack.splice(1),s=r.parentCmdIndex,r=r.parentInfo;if(s>-1&&r.commands)return{info:r,index:s}}else if("jumpOption"===a.type){for(var p=0;p<a.eArg&&r.parentInfo&&(e.cmdStack[0]&&"insert"!==e.cmdStack[0].type);p++)e.cmdStack=e.cmdStack.splice(1),s=r.parentCmdIndex,r=r.parentInfo;s++}for(;r&&!r.commands[s]&&e.cmdStack&&0<e.cmdStack.length;){var y=e.cmdStack[0];if(y.loopCondition&&o.safeEval(y.loopCondition,e)){if(s=0,y.loopCount&&y.loopCount++,!y.loopCountExpr)break;var g=parseInt(o.safeEval(y.loopCountExpr,e));if(y.loopCount<=g)break}y.type&&"insert"===y.type||(e.cmdStack=e.cmdStack.splice(1)),y.type&&"insert"===y.type?(s=-1,r=null):r.parentInfo&&(s=r.parentCmdIndex+1,r=r.parentInfo)}return{info:r,index:s}},removeInputView:function(e){if(e.inputElement)e.inputElement.destroy();else if(e.children&&e.children.length)for(var t=0;t<e.children.length;t++)this.removeInputView(e.children[t])},removeViewTimer:function(e){var t=this;return"TIMER"===e.viewType?void("timeOut"===e.timerType?clearTimeout(e.timerHandler):clearInterval(e.timerHandler)):void e.children.forEach(function(e){return t.removeViewTimer(e)})},filterInexistentPlotViews:function(e,t){if(t.commands&&0!==t.commands.length)for(var n=function r(e,t){for(var n=0;n<t.length;n++){if(t[n].uuid===e)return!0;if("options"===t[n].type||"conditionOptions"===t[n].type)for(var a=0;a<t[n].args.length;a++)if(r(e,t[n].args[a].commands))return!0}return!1},a=0;a<e.length;a++)if(e[a].generateType){var o=e[a].generateType;n(o,t.commands)||(e.splice(a,1),a--)}},destroyAll:function(){var e=this;if(this.playBackLayer.removeAll(!0),this.globalViews&&this.globalViews.forEach(function(t){e.removeInputView(t),t.destroy&&t.destroy()}),this.globalViews=null,this.plotViewsLayer.children.forEach(function(t){e.removeViewTimer(t),e.removeInputView(t)}),this.plotViewsLayer.removeAll(!0),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version){w["default"].stopMusic(),w["default"].removeAudioUrl(w["default"].musicInfo.key);for(var t=0;t<10;t++)w["default"].soundsInfo[t].key&&(w["default"].stopSound(t),w["default"].removeAudioUrl(w["default"].soundsInfo[t].key))}else this.bk_music&&this.bk_music.destroy(),this.bk_music=null,this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.destroy()}),this.plotSounds=[];this.lstPlotLayer&&(this.lstPlotLayer.destroy(),this.lstPlotLayer=null)},reStart:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];"ios"===flashvars.client?1===flashvars.offline?workFinished("1"):window.webkit&&window.webkit.messageHandlers.workFinished.postMessage("1"):"android"===flashvars.client&&window.app&&window.app.workFinished("1"),this.dialogLayer.visible=!1,this.unlockChapterCallBack=null,this.mallPayCallback=null,this.destroyAll(),this.initContext(this.context);var n=function(){if(!e.json_data.cover.hidden)return e.showCover();var t=e.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(e.isWapOther())return void e.checkIfChapterFree(n,t.md5).then(function(n){var a;(a=t.plots).push.apply(a,i(n)),e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)},function(a){-1===a.indexOf("code=87")?p["default"].error(a):e.unlockChapterByWapOther(n,t.charge,t.md5,null)});if(t.md5&&0===t.plots.length)if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)e.checkIfChapterFree(n,t.md5).then(function(n){t.plots=n,e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)},function(e){-1===e.indexOf("code=87")?p["default"].error(e):p["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var a=function(a){a&&e.checkIfChapterFree(n,t.md5).then(function(n){e.unlockChapterCallBack=null,t.plots=n,e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():p["default"].error("获取付费章节信息失败")})};e.unlockChapter(n,t.charge,t.md5,a)}else e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)};t!==!1?p["default"].custom("Info","没体验够？下载闪艺APP，继续玩！","提示","下载闪艺","取消").then(function(){window.location.href="http://app.3000.com/"},function(e){n()}):n()},valueOperation:function(e,t,n){var a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.isSetValues=!0;var r=function(){return a.savePayInfo().then(function(){return a.saveAccountInfo()})},i=function(t,n,a){if(!a)return n<1?p["default"].info("出现未知数值操作，请联系作者检查修改"):"value"===e.indexValues[t].init.type&&n>e.values.length?p["default"].info("出现未知数值操作，请联系作者检查修改"):"savedValue"===e.indexValues[t].init.type&&n>e.savedValues.length?p["default"].info("出现未知数值操作，请联系作者检查修改"):"stringValue"===e.indexValues[t].init.type&&n>e.stringValues.length?p["default"].info("出现未知数值操作，请联系作者检查修改"):"payValue"===e.indexValues[t].init.type&&n>e.payValues.length&&p["default"].info("出现未知数值操作，请联系作者检查修改"),void(e.indexValues[t].value=n);var o=void 0===e.indexValues[t].value?e.indexValues[t].init.value-1:e.indexValues[t].value-1;if("value"===e.indexValues[t].init.type){if(o<0||o>=e.values.length)return void p["default"].info("出现未知数值操作，请联系作者检查修改");e.values[o].value=n}else if("savedValue"===e.indexValues[t].init.type){if(o<0||o>=e.savedValues.length)return void p["default"].info("出现未知数值操作，请联系作者检查修改");e.savedValues[o].value=n}else if("stringValue"===e.indexValues[t].init.type){if(o<0||o>=e.stringValues.length)return void p["default"].info("出现未知数值操作，请联系作者检查修改");e.stringValues[o].value=n}else if("payValue"===e.indexValues[t].init.type){if(o<0||o>=e.payValues.length)return void p["default"].info("出现未知数值操作，请联系作者检查修改");isupload=!0,e.payValues[o].value=n}};if(t&&t.length>0){var s=0,l=function(e){return e>=t.length-1&&r().then(function(){null!==o&&(a.isSetValues=!1,o())}),e<t.length-1},c=function u(n){var o=t[n],r=a.Expression.safeEval(o.expression,a.context),s=o.uuid,c=void 0;(c=a.context.values.findIndex(function(e){return e.uuid===s}))!==-1?(e.values[c].value=r,l(n)&&u(n+=1)):(c=a.context.savedValues.findIndex(function(e){return e.uuid===s}))!==-1?(e.savedValues[c].value=r,d["default"].localStorageSetItem(flashvars.uuid+"savedValues"+flashvars.uid,JSON.stringify(e.savedValues)),l(n)&&u(n+=1)):(c=a.context.stringValues.findIndex(function(e){return e.uuid===s}))!==-1?(e.stringValues[c].value=r,l(n)&&u(n+=1)):(c=a.context.payValues.findIndex(function(e){return e.uuid===s}))!==-1?(e.payValues[c].value=r,l(n)&&u(n+=1)):(c=a.context.indexValues.findIndex(function(e){return e.uuid===s}))!==-1?(i(c,r,o.reference),l(n)&&u(n+=1)):(console.error("Cannot find value/savedValue with uuid = ",s),l(n)&&u(n+=1))};c(s)}else null!==o&&(this.isSetValues=!1,o())},updateValues:function(e){for(var t=JSON.parse(JSON.stringify(this.json_data.values)),n=0;n<e.values.length;n++)for(var a=0;a<t.length;a++)if(t[a].uuid===e.values[n].uuid){t[a].value=e.values[n].value;break}e.values=t.concat(),t=JSON.parse(JSON.stringify(this.json_data.savedValues));for(var o=0;o<e.savedValues.length;o++)for(var r=0;r<t.length;r++)if(t[r].uuid===e.savedValues[o].uuid){t[r].value=e.savedValues[o].value;break}e.savedValues=t.concat(),t=JSON.parse(JSON.stringify(this.json_data.stringValues));for(var i=0;i<e.stringValues.length;i++)for(var s=0;s<t.length;s++)if(t[s].uuid===e.stringValues[i].uuid){t[s].value=e.stringValues[i].value;break}if(e.stringValues=t.concat(),this.json_data.payValues){if(t=JSON.parse(JSON.stringify(this.json_data.payValues)),e.payValues)for(var l=0;l<e.payValues.length;l++)for(var c=0;c<t.length;c++)if(t[c].uuid===e.payValues[l].uuid){t[c].value=e.payValues[l].value;break}e.payValues=t.concat()}if(this.json_data.indexValues){if(t=JSON.parse(JSON.stringify(this.json_data.indexValues)),e.indexValues)for(var u=0;u<e.indexValues.length;u++)for(var d=0;d<t.length;d++)if(t[d].uuid===e.indexValues[u].uuid){t[d].value=e.indexValues[u].value;break}e.indexValues=t.concat()}},initContext:function(e,t){var n=function(e){return e?JSON.parse(JSON.stringify(e)):e},a={};if(t&&this.updateValues(e),a.auto=this.context&&this.context.auto||!1,a.fullScreen=this.context&&this.context.fullScreen||!1,a.savedValues=n(e&&e.savedValues||this.json_data.savedValues),!e&&!t){var o=d["default"].localStorageGetItem(flashvars.uuid+"savedValues"+flashvars.uid);if(o)for(var r=JSON.parse(o),i=0;i<r.length;i++)for(var s=0;s<a.savedValues.length;s++)if(a.savedValues[s].uuid===r[i].uuid){a.savedValues[s].value=r[i].value;break}}if(t)a.values=n(e.values),a.stringValues=n(e.stringValues),a.payValues=n(this.context.payValues),a.indexValues=n(e.indexValues);else{a.values=n(this.json_data.values),a.stringValues=n(this.json_data.stringValues),a.payValues=n(this.json_data.payValues?this.json_data.payValues:this.context.payValues),a.indexValues=n(this.json_data.indexValues?this.json_data.indexValues:this.context.indexValues);for(var l=0;l<a.payValues.length;l++)for(var c=0;c<this.context.payValues.length;c++)if(a.payValues[l].uuid===this.context.payValues[c].uuid){a.payValues[l].value=this.context.payValues[c].value;break}}if(this.json_data.systemValues?(a.systemValues=n(this.json_data.systemValues),1===a.systemValues.length?a.systemValues=a.systemValues.concat([{},{},{},{},{},{},{},{},{},{}]):9===a.systemValues.length?a.systemValues=a.systemValues.concat([{},{}]):10===a.systemValues.length&&(a.systemValues=a.systemValues.concat([{}])),a.systemValues[0].value=this.context.systemValues[0].value,a.systemValues[1].value=this.context.systemValues[1].value,a.systemValues[9].value=this.context.systemValues[9].value):a.systemValues=n(this.context.systemValues),-1===d["default"].timeStamp)d["default"].getTimeOffset().then(function(){d["default"].updateContextTimeValues(a)},null);else{var u=new Date(1e3*d["default"].timeStamp);a.systemValues[2].value=d["default"].timeStamp,a.systemValues[3].value=u.getFullYear(),a.systemValues[4].value=u.getMonth()+1,a.systemValues[5].value=u.getDate(),a.systemValues[6].value=u.getHours(),a.systemValues[7].value=u.getMinutes(),a.systemValues[8].value=u.getSeconds(),a.systemValues[10].value=u.getDay()}t&&e&&e.stack?(a.stack=n(e.stack),a.cmdStack=n(e.cmdStack)):(a.stack=[],a.cmdStack=[]),this.context=a},doInCT:function(e,t){return e!==this.context?Promise.reject("timeline changed"):t()},txtLineSpace:function(e){var t=0;return t=12==e||14==e||16==e||18==e?-4+e/2:e<19?-5+e/2:e<28?-6+e/2:e<37?-7+e/2:e<46?-9+e/2:e<56?-10+e/2:-Math.ceil(e/5)+e/2,!this.viewComponent.game.device.desktop&&(t-=2),t},updateMusicVolume:function(e){if(d["default"].musicVolume=e,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)w["default"].updateMusicVolume("music",e);else if(this.bk_music){0===this.bk_music.prevolume&&0!==this.bk_music.volume&&(this.bk_music.prevolume=this.bk_music.volume);var t=void 0!==this.bk_music.inheritvolume&&this.bk_music.inheritvolume!==-1?this.bk_music.inheritvolume*e:this.bk_music.prevolume*e;this.bk_music.volume=t;for(var n=0;n<this.lstPlotTweens.length;n++){var a=this.lstPlotTweens[n];a.target&&"music"===a.target.animateMusic&&(a.pause(),a.stop(!0))}}},updateSoundVolume:function(e){if(d["default"].soundVolume=e,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)w["default"].updateSoundVolume("sound",e);else{if(this.plotSounds&&this.plotSounds.length>0)for(var t=0;t<this.plotSounds.length;t++){var n=this.plotSounds[t];if(n){0===n.prevolume&&0!==n.volume&&(n.prevolume=n.volume);var a=void 0!==n.inheritvolume&&n.inheritvolume!==-1?n.inheritvolume*e:n.prevolume*e;n.volume=a}}for(var o=0;o<this.lstPlotTweens.length;o++){var r=this.lstPlotTweens[o];r.target&&"sound"===r.target.animateMusic&&(r.pause(),r.stop(!0))}}},stopMusic:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?w["default"].stopMusic(!t):e&&this.bk_music&&e===this.bk_music.key?this.bk_music.stop():this.bk_music&&(this.bk_music.destroy(),this.bk_music=null,this.decodeCacheAudio(e)),!t&&u.ResourcesManager.updateUsingKey({type:"music",key:""})},playMusic:function(e,t,n){arguments.length>3&&void 0!==arguments[3]&&arguments[3];u.ResourcesManager.updateUsingKey({type:"music",key:e}),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?w["default"].playMusic(e,t,n,d["default"].musicVolume):(this.bk_music&&e===this.bk_music.key||(this.bk_music=this.viewComponent.game.add.sound(e,t,n),this.bk_music.prevolume=t,this.bk_music.inheritvolume=-1),this.bk_music.play(),this.bk_music.volume=this.bk_music.prevolume*d["default"].musicVolume)},playInheritMusic:function(e){"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?w["default"].playInheritMusic(e,d["default"].musicVolume):this.bk_music&&void 0!==e&&(this.bk_music.inheritvolume=e,this.bk_music.volume=e*d["default"].musicVolume)},stopSound:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==e&&void 0!==e){if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)w["default"].stopSound(e);else if(e===-1)for(var a=0;a<this.plotSounds.length;a++){var o=this.plotSounds[a];o&&o.stop()}else t&&this.plotSounds[e]&&t===this.plotSounds[e].key?this.plotSounds[e].stop():this.plotSounds[e]&&(this.plotSounds[e].destroy(),this.plotSounds[e]=null,this.decodeCacheAudio(t));!n&&u.ResourcesManager.updateUsingKey({type:"sound",key:"",index:e})}},playSound:function(e,t,n,a){arguments.length>4&&void 0!==arguments[4]&&arguments[4];u.ResourcesManager.updateUsingKey({type:"sound",key:t,index:e}),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?w["default"].playSound(e,t,n,a,d["default"].soundVolume):(this.plotSounds[e]&&this.plotSounds[e].key===t||(this.plotSounds[e]=this.viewComponent.game.add.sound(t,n,a),this.plotSounds[e].prevolume=n,this.plotSounds[e].inheritvolume=-1,this.plotSounds[e].volume*=d["default"].soundVolume),this.plotSounds[e].play())},playInheritSound:function(e,t){"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?w["default"].playInheritSound(e,t,d["default"].soundVolume):this.plotSounds[e]&&void 0!==t&&(this.plotSounds[e].inheritvolume=t,this.plotSounds[e].volume*=d["default"].soundVolume)},decodeCacheAudio:function(e){var t=this;if(e){var n=this.viewComponent.game.load.cache.getSound(e);return void(!n||n.decoded||n.isDecoding||this.viewComponent.game.sound.decode(e))}var a=0,o=this.viewComponent.game.load.cache.getKeys(Phaser.Cache.SOUND);for(var r in o){var i=this.viewComponent.game.load.cache.getSound(o[r]);if((i.decoded||i.isDecoding)&&a++,a>4)return}o.some(function(e){var n=t.viewComponent.game.load.cache.getSound(e);return!n.decoded&&!n.isDecoding&&(t.viewComponent.game.sound.decode(e),!0)})},toRealImageFontHeight:function(e){var t=this.json_data.font.size.target.height?this.json_data.font.size.target.height:this.json_data.font.size.target;return parseFloat(e)*t/this.json_data.font.size.source},toRealImageFontWidth:function(e){var t=this.json_data.font.size.target.width?this.json_data.font.size.target.width:this.json_data.font.size.target;return parseFloat(e)*t/this.json_data.font.size.source},isWap3000:function(){return!flashvars.wap||flashvars.wap&&"3000"===flashvars.wap},isWapOther:function(){return Boolean(flashvars.wap&&"3000"!==flashvars.wap&&"zxwwap"!==flashvars.wap&&void 0!==flashvars.wap&&""!==flashvars.wap)},isExtend:function(){return Boolean(flashvars.extend&&void 0!==flashvars.extend&&""!==flashvars.extend)},get isShowLocalBtn(){return!this.isWapOther()},get isShowCloudBtn(){return!(this.isExtend()||Boolean(flashvars.wap&&"zxwwap"===flashvars.wap)||this.isWapOther())},Expression:function(){function e(){r(this,e)}return s(e,null,[{key:"isString",value:function(e){return"[object String]"===Object.prototype.toString.apply(e)}},{key:"isArray",value:function(e){return"[object Array]"===Object.prototype.toString.apply(e)}},{key:"toN",value:function(e){var t=Number(e);return isNaN(t)?(console.warn(e+" is not a number"),0):t}},{key:"toInt",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=parseInt(e,t);return isNaN(n)?(console.warn(e+" is not a int"),0):n}},{key:"toWeek",value:function(e){switch(e){case 0:return 7;default:return e}}},{key:"safeEval",value:function(e,t){var n=this,a=function r(e,t){var a=void 0,o=void 0,s=void 0;switch(e.type){case"arg1":return r(e.arg1,t);case"+":return a=r(e.arg1,t),o=r(e.arg2,t),n.isString(a)||n.isString(o)?("#"+a+o).slice(1):n.add(r(e.arg1,t),r(e.arg2,t));case"-":return a=r(e.arg1,t),o=r(e.arg2,t),n.isString(a)||n.isString(o)?(a+"").split(o+"").join(""):n.sub(r(e.arg1,t),r(e.arg2,t));case"*":return n.mul(r(e.arg1,t),r(e.arg2,t));case"/":return n.div(r(e.arg1,t),r(e.arg2,t));case"%":return a=parseInt(r(e.arg1,t)),o=parseInt(r(e.arg2,t)),0===o?(p["default"].error("求余除数不能为 0"),0):n.mod(a,o);case"==":return r(e.arg1,t)===r(e.arg2,t);case"!=":return r(e.arg1,t)!==r(e.arg2,t);case">":return r(e.arg1,t)>r(e.arg2,t);case"<":return r(e.arg1,t)<r(e.arg2,t);case">=":return r(e.arg1,t)>=r(e.arg2,t);case"<=":return r(e.arg1,t)<=r(e.arg2,t);case"min":return Math.min.apply(null,e.args.map(function(e){return r(e,t)}));case"max":return Math.max.apply(null,e.args.map(function(e){return r(e,t)}));case"all":return e.args.map(function(e){return r(e,t)}).every(function(e){return e});case"any":return e.args.map(function(e){return r(e,t)}).some(function(e){return e});case"literal":return Number(e.value);case"int":return parseInt(n.toN(r(e.arg1,t)));case"random":var l=n.toInt(e.range[0]),c=n.toInt(e.range[1]);return~~(Math.random()*(c-l+1)+l);case"value":case"savedValue":case"payValue":return s=[].concat(i(t.values),i(t.savedValues),i(t.payValues)).find(function(t){return t.uuid===e.arg1}),void 0!==s.value?n.toN(s.value):n.safeInitValue(s);case"systemValue":return s=t.systemValues.find(function(t){return t.uuid===e.arg1}),void 0!==s.value?(s.uuid!==t.systemValues[0].uuid&&s.uuid!==t.systemValues[1].uuid&&s.uuid!==t.systemValues[9].uuid&&d["default"].updateContextTimeValues(t),s.uuid===t.systemValues[10].uuid?n.toWeek(s.value):n.toN(s.value)):n.safeInitValue(s);case"indexValue":return s=t.indexValues.find(function(t){return t.uuid===e.arg1}),void 0!==s.value?n.toN(s.value):n.safeInitValue(s);case"string":return e.value+"";case"stringValue":return s=t.stringValues.find(function(t){return t.uuid===e.arg1}),void 0!==s.value?s.value+"":n.safeInitValue(s);case"reference":if(s=t.indexValues.find(function(t){return t.uuid==e.arg1})){var u=(void 0===s.value?n.safeInitValue(s):n.toN(s.value))-1;if("value"===s.init.type)return u<0||u>=t.values.length?(p["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.values[u].value?n.toN(t.values[u].value):n.safeInitValue(t.values[u]);if("savedValue"===s.init.type)return u<0||u>=t.savedValues.length?(p["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.savedValues[u].value?n.toN(t.savedValues[u].value):n.safeInitValue(t.savedValues[u]);if("payValue"===s.init.type)return u<0||u>=t.payValues.length?(p["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.payValues[u].value?n.toN(t.payValues[u].value):n.safeInitValue(t.payValues[u]);if("stringValue"===s.init.type)return u<0||u>=t.stringValues.length?(p["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.stringValues[u].value?t.stringValues[u].value+"":n.safeInitValue(t.stringValues[u])}case"contain":return a=r(e.arg1,t),o=r(e.arg2,t),(a+"").indexOf(o+"")>-1;case"stringLength":return a=r(e.arg1,t),a?a.length:0;default:throw new error("expr type  is  error")}};try{return a(e,t)}catch(o){return console.error(o),NaN}}},{key:"safeInitValue",value:function(e){function t(e){if("const"===e.init.type||"system"===e.init.type)return e.value=e.init.value,e.value;if("random"===e.init.type){
var t=Number(e.init.range[0]),n=Number(e.init.range[1]);return e.value=~~(Math.random()*(n-t+1)+t),e.value}return"string"===e.init.type?(e.value=e.init.value+"",e.value):e.init.onlyRead?(e.value=e.init.value,e.value):(console.error("unknown init type"),0)}try{return t(e)}catch(n){return console.error(n),0}}},{key:"fix",value:function(e,t){var n=this,a=e.type,o=e.arg1,r=e.arg2,s=e.args,l=e.value,c={type:a},u=void 0;switch(a){case"arg1":case"stringLength":var d=this.fix(o,t);return d?(c.arg1=d,c):null;case"+":case"-":case"*":case"/":case"%":case"==":case"!=":case">":case"<":case">=":case"<=":case"contain":return c.arg1=this.fix(o,t),c.arg2=this.fix(r,t),c.arg1&&c.arg2?c:null;case"min":case"max":case"all":case"any":var h=s.map(function(e){return n.fix(e,t)});return c.args=h.filter(function(e){return null!==e}),c;case"literal":return c.value=Number(l),c;case"random":return c.range=(e.range||[0,100]).map(function(e){return n.toInt(e)}),c.range.sort(),c;case"value":case"savedValue":case"payValue":case"systemValues":case"indexValue":return u=[].concat(i(t.values),i(t.savedValues),i(t.payValues),i(t.systemValues),i(t.indexValues)).find(function(t){return t.uuid===e.arg1}),void 0===u?null:(c.arg1=o,c);case"string":return c.value=l+""||"",c;case"stringValue":return u=t.stringValues.find(function(t){return t.uuid===e.arg1}),void 0===u?null:(c.arg1=o,c);default:return null}}},{key:"parseValue",value:function(e,t,n){for(var a=/([\s\S]*)&(s|v|sv|p|x|i|iv)\[(\d+)\]([\s\S]*)/,o=a.exec(e),r=void 0,i=e;o;){var s=o[2],l=parseInt(o[3]),c="[未知数值]";if("s"===s&&t.savedValues[l])r="[Y"+(l+1)+":"+t.savedValues[l].name+"]",c=void 0===t.savedValues[l].value?this.safeInitValue(t.savedValues[l]):t.savedValues[l].value,c=n?r:this.toFixed(c,2);else if("v"===s&&t.values[l])r="[P"+(l+1)+":"+t.values[l].name+"]",c=void 0===t.values[l].value?this.safeInitValue(t.values[l]):t.values[l].value,c=n?r:this.toFixed(c,2);else if("sv"===s&&t.stringValues[l])r="[Z"+(l+1)+":"+t.stringValues[l].name+"]",c=void 0===t.stringValues[l].value?this.safeInitValue(t.stringValues[l]):t.stringValues[l].value,n&&(c=r);else if("p"===s&&t.payValues[l])r="[X"+(l+1)+":"+t.payValues[l].name+"]",c=void 0===t.payValues[l].value?this.safeInitValue(t.payValues[l]):t.payValues[l].value,c=n?r:this.toFixed(c,2);else if("x"===s&&t.systemValues[l])-1===d["default"].timeStamp?d["default"].getTimeOffset().then(function(){d["default"].updateContextTimeValues(t)},function(){p["default"].info("当前网络不佳，获取系统时间失败")}):d["default"].updateContextTimeValues(t),r="[S"+(l+1)+":"+t.systemValues[l].name+"]",c=void 0===t.systemValues[l].value?this.safeInitValue(t.systemValues[l]):10===l?this.toWeek(t.systemValues[10].value):t.systemValues[l].value,c=n?r:this.toFixed(c,2);else if("i"===s&&t.indexValues[l])r="[I"+(l+1)+":"+t.indexValues[l].name+"]",c=void 0===t.indexValues[l].value?this.safeInitValue(t.indexValues[l]):t.indexValues[l].value,c=n?r:this.toFixed(c,2);else if("iv"===s)if(l>=t.indexValues.length)c="[未知数值]";else{r="[IV"+(l+1)+":"+t.indexValues[l].name+"]";var u=(void 0===t.indexValues[l].value?this.safeInitValue(t.indexValues[l]):t.indexValues[l].value)-1;if(n)c=r;else{var h=this.toFixed(u,2);"value"===t.indexValues[l].init.type?u<0||u>=t.values.length?c="[未知数值]":(c=void 0===t.values[h].value?this.safeInitValue(t.values[h]):t.values[h].value,c=this.toFixed(c,2)):"savedValue"===t.indexValues[l].init.type?u<0||u>=t.savedValues.length?c="[未知数值]":(c=void 0===t.savedValues[h].value?this.safeInitValue(t.savedValues[h]):t.savedValues[h].value,c=this.toFixed(c,2)):"payValue"===t.indexValues[l].init.type?u<0||u>=t.payValues.length?c="[未知数值]":(c=void 0===t.payValues[h].value?this.safeInitValue(t.payValues[h]):t.payValues[h].value,c=this.toFixed(c,2)):"stringValue"===t.indexValues[l].init.type&&(c=u<0||u>=t.stringValues.length?"[未知数值]":void 0===t.stringValues[h].value?this.safeInitValue(t.stringValues[h]):t.stringValues[h].value)}}i=o[1]+c+o[4],o=a.exec(i)}return i}},{key:"parseWaitTime",value:function(e,t){for(var n=/([\s\S]*)\\(\d+)\s([\s\S]*)/,a=n.exec(e);a;)e=t?a[1]+("[停顿:"+a[2]+"ms]")+a[3]:a[1]+a[3],a=n.exec(e);return e}},{key:"getGameValueByTimer",value:function(e,t){var n={};if(!e)return-1;var a=e.time,o=a.type,r=a.arg1;if("value"===o)n=t.values.find(function(e){return e.uuid===r});else if("savedValue"===o)n=t.savedValues.find(function(e){return e.uuid===r});else{if("literal"!==o)return-1;n.value=e.time.value}var i=n&&void 0===n.value?this.safeInitValue(n):n.value;return Math.max(i,0)}},{key:"add",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.max(n,a),e=parseInt(e.toString().replace(".",""))*Math.pow(10,o-n),t=parseInt(t.toString().replace(".",""))*Math.pow(10,o-a),(e+t)/Math.pow(10,o)}},{key:"sub",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.max(n,a),e=parseInt(e.toString().replace(".",""))*Math.pow(10,o-n),t=parseInt(t.toString().replace(".",""))*Math.pow(10,o-a),(e-t)/Math.pow(10,o)}},{key:"div",value:function(e,t){if(!t)return p["default"].error("除数不能为 0"),0;var n=0,a=0,o=void 0;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=parseInt(e.toString().replace(".",""))/parseInt(t.toString().replace(".","")),a-n<0||o!==parseInt(o)?this.mul(o,Math.pow(10,a-n)):o*Math.pow(10,a-n)}},{key:"mul",value:function(e,t){var n=0,a=e.toString(),o=t.toString();try{n+=a.includes("1e-")?parseInt(a.split("1e-")[1]):a.split(".")[1].length}catch(r){}try{n+=o.includes("1e-")?parseInt(o.split("1e-")[1]):o.split(".")[1].length}catch(r){}return parseInt(a.replace(".",""))*parseInt(o.replace(".",""))/Math.pow(10,n)}},{key:"mod",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.pow(10,Math.max(n,a)),e*o%(t*o)/o}},{key:"toFixed",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=0;try{n=e.toString().split(".")[1].length}catch(a){}var o=e.toString();return n>t&&t>=0&&(o=o.substring(0,o.indexOf(".")+t+1),n=t),e=parseInt(o.replace(".","")),e/Math.pow(10,n)}}]),e}()},{NAME:"SceneProxy",guideLayer:null,logo:null,coverLayer:null,progressLayer:null,dialogLayer:null,menuLayer:null,mainMenuLayer:null,settingsLayer:null,recordLayer:null,playBackLayer:null,weatherLayer:null,charsAndPropsLayer:null,optionLayer:null,plotViewsLayer:null,globalViews:null,plotViews:null,prgsViews:null,endLayer:null,toastLayer:null,loadingToastLayer:null,quickPlayLayer:null,bk_music:null,plotSounds:null,btn_sound:null,audioDecodedCount:0,lstPlotBkKey:null,prePlotBkKey:null,lstPlotBkOpacity:0,lstPlotBkFlex:1,lstGameBk:null,curPlotLayer:null,lstPlotLayer:null,viewComponent:null,json_data:{},Template:{},stringMap:{},progressTips:[],unlockChapterCallBack:null,mallPayCallback:null,context:{},plotSnap:null,savedPlotsData:null,cloudPlotsData:null,recUidBelongTo:"",gameUidBelongTo:"",bSwitchAccInPlot:!0,payValueUid:"",playPause:!1,bViewLoaded:!1,bSignedIn:!1,bCloudSel:!1,curChapter:null,curPlotInfo:null,curPlotIndex:0,cmdPlotSnap:null,curCmdUuid:"",bCmdAutoText:!1,lstDialogInfo:null,menuInfo:null,charsAndPropsInfo:[],bToSaveFile:!0,space_key:null,globalViewKeys:null,plotViewKeys:null,quickPlay:!1,isScreenHold:!1,isQuickPlay:!0,isShowGuide:!0,recordTipCount:0,visibleLayout:[],resourceManager:{},lstPlotTweens:[],twinkleTimer:null,uiOnLoadQueue:[],timerCounts:[],menuTimer:[],cmdPlotNextPromise:null,cmdPlayHandlerFun:null,curCmdInfo:null,curCmdIndex:0,preWaitCmdUuid:"",isGameStarted:!1,usedStarCount:0,gameStarLimit:0,isPaying:!1,isGettingNext:!1,isPreferentialFinished:!1,preferentialVector:[],isSetValues:!1,isPaySuccess:!1,isGoToCommand:!0,shakeLoopObj:null,hasCountDown:null,playAdCallBack:null})}),require.register("js/view/component/Scene.js",function(t,n,a){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){return e&&e.__esModule?e:{"default":e}}var i=n("puremvc"),s=r(i),l=n("../../common/XmlHttpRequest.js"),c=o(l),u=n("../../common/RePhaser.js"),d=r(u),h=n("../../common/Utils.js"),f=r(h),m=n("../../common/Version.js"),p=r(m),y=n("../../common/PhoneUtils.js"),g=r(y),v=n("../../common/FontUtils.js"),x=r(v);s["default"].define({name:"diygamePlayer.view.component.Scene",constructor:function(){var t=this,n=flashvars.vertical?540:960,a=flashvars.vertical?960:540,o={init:function s(){!t.game.device.desktop&&(t.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL),flashvars.wap&&"qh"===flashvars.wap&&(t.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL),t.game.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL,t.game.scale.pageAlignVertically=!0,t.game.scale.pageAlignHorizontally=!0,t.game.stage.disableVisibilityChange=!0;var n=function(){return navigator.userAgent.indexOf("iPhone")>-1&&window.orientation&&0===window.orientation};t.game.scale.setResizeCallback(function(a,o){var r=document.getElementById("game"),i=n()?e.width:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,s=n()?e.height:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;n()&&i>s&&(i=e.height,s=e.width),r.style.width=i+"px",r.style.height=s+"px",i>s?flashvars.vertical?90!==t.game.world.angle&&(t.game.scale.setGameSize(960,540),t.game.world.angle=90,t.game.world.setBounds(-960,0,540,960),t.game.scale.refresh()):0!==t.game.world.angle&&(t.game.scale.setGameSize(960,540),t.game.world.angle=0,t.game.world.setBounds(0,0,960,540),t.game.scale.refresh()):flashvars.vertical?0!==t.game.world.angle&&(t.game.scale.setGameSize(540,960),t.game.world.angle=0,t.game.world.setBounds(0,0,540,960),t.game.scale.refresh()):90!==t.game.world.angle&&(t.game.scale.setGameSize(540,960),t.game.world.angle=90,t.game.world.setBounds(-960,0,960,540),t.game.scale.refresh())}),t.game.load.loadImageTag=d["default"].loadImageTag,t.game.load.onSoundExtendLoad=new Phaser.Signal,t.game.load.onSoundExtendLoadError=new Phaser.Signal,g["default"].load=t.game.load,t.game.renderer.renderSession.roundPixels=!0,t.game.sound.decode=d["default"].soundDecode,t.game.sound.onSoundDecodeError=new Phaser.Signal;var s=function(){t.game.sound.touchLocked=!1,h.AudioTagPool.fill();var e=t.game.cache.getKeys(Phaser.Cache.SOUND);e.forEach(function(e){var n=t.game.cache.getSound(e);n&&!h.AudioTagPool.exist(n.data)&&t.game.cache.reloadSound(e)})};t.game.device.iOS?t.game.device.iOSVersion>8?t.game.input.touch.addTouchLockCallback(s,t.game,!0):t.game.input.touch.addTouchLockCallback(s,t.game):"wap"!==flashvars.client||!t.game.device.android||navigator.userAgent.indexOf("vivo Y66")===-1&&navigator.userAgent.indexOf("DIG-AL00")===-1?s():t.game.input.touch.addTouchLockCallback(s,t.game,!0),h.ResourcesManager.cache=t.game.cache,h.ResourcesManager.load=t.game.load,t.game.destroyComponent.add(function(e){h.ResourcesManager.subRefCount("img",e,"play")}),window.ResourcesManager=h.ResourcesManager},preload:function(){},create:function(){this.game.canvas.oncontextmenu=function(e){return e.preventDefault()};var e=t.game.add.graphics(0,0);e.name="startBk",e.beginFill(6476757),e.drawRect(0,0,n,a),e.endFill(),t.onRendered&&t.onRendered()},update:function(){}},r=Phaser.CANVAS,i=navigator.userAgent.match(/chrome\/((([0-9]*)+(\.))*)+([0-9]*)/gi);i&&("Chrome/50.0.2661.86"==i[0]||"Chrome/51.0.2704.81"==i[0]?-1===navigator.userAgent.indexOf("Android 6.0.1; MI 4LTE")&&-1===navigator.userAgent.indexOf("vivo Y67")&&(r=Phaser.AUTO):"Chrome/46.0.2490.76"==i[0]&&-1!==navigator.userAgent.indexOf("OPPO R9s")&&(r=Phaser.AUTO)),t.game=new Phaser.Game(n,a,r,"game",o),t.game.preserveDrawingBuffer=!0,window.game=t.game,window.AudioContext=null,window.webkitAudioContext=null,console.log("versionCommit: ",p["default"])}},{showLogo:function(){var e=this.game.world.getByName("logo_preloader");e||(e=this.game.add.image(this.game.world.width/2,this.game.world.height/2,"logo_preloader"),e.name="logo_preloader",e.anchor.setTo(.5,.5)),e.visible=!0},showOfflineBg:function(){var e=this.game.world.getByName("offlinebg");e||(e=this.game.add.image(this.game.world.width/2,this.game.world.height/2,"Operation_tip"),e.name="offlinebg",e.inputEnabled=!0,e.anchor.setTo(.5,.5),this.game.world.setChildIndex(e,1)),e.visible=!0},showLoading:function(){var e=this.game.world.getByName("logo_preloader"),t=this.game.world.getByName("loading_gif");return t||(t=this.game.add.image(this.game.world.width/2,flashvars.vertical?this.game.world.height/2-100:this.game.world.height,"loading_gif"),t.anchor.set(.5,.5),t.x=this.game.world.width/2,t.y=flashvars.vertical?this.game.world.height/2-t.height/2:this.game.world.height/2-80,t.name="loading_gif",this.addGifAnimation(t)),e&&(e.scale.setTo(.35,.35),e.x=this.game.world.width-e.width+25,e.y=this.game.world.height-e.height+12),t.visible=!0,!0},destroyLogo:function(){var e=this.game.world.getByName("startBk"),t=this.game.world.getByName("logo_preloader"),n=this.game.world.getByName("loading_gif"),a=this.game.world.getByName("logInfo");e&&e.destroy(),t&&t.destroy(),n&&n.destroy(),a&&a.destroy()},preLoadCertainAssets:function(){if(flashvars.vertical||this.game.load.spritesheet("wind","./img/wind.png",960,540),this.game.load.image("icon_back","./img/icon_back.png"),this.game.load.image("icon_back_over_pressed","./img/icon_back_over_pressed.png"),this.game.load.image("icon_candy","./img/icon_candy.png"),this.game.load.image("icon_candy_over_pressed","./img/icon_candy_over_pressed.png"),this.game.load.image("icon_get","./img/icon_get.png"),this.game.load.image("icon_get_hover_pressed","./img/icon_get_hover_pressed.png"),this.game.load.image("icon_save","./img/icon_save.png"),this.game.load.image("icon_save_over_pressed","./img/icon_save_over_pressed.png"),this.game.load.image("cloud","./img/cloud.png"),this.game.load.image("cloud_hover","./img/cloud_hover.png"),this.game.load.image("local","./img/local.png"),this.game.load.image("local_hover","./img/local_hover.png"),this.game.load.image("icon_success","./img/icon_success.png"),this.game.load.image("icon_error","./img/icon_error.png"),this.game.load.image("light","./img/light.png"),this.game.load.image("toast_loading","./img/toast_loading.gif"),this.game.load.image("app_button_speed","./img/app_button_speed.png"),this.game.load.image("app_icon_speed","./img/app_icon_speed.png"),"wap"===flashvars.client&&this.game.load.image("wapback","./img/wapback.png"),this.game.load.image("Operation_tip",flashvars.vertical?"./img/Operation_tip_1.png":"./img/Operation_tip.png"),this.game.load.image("Cloud_record_tip","./img/Cloud_record_tip.png"),this.game.load.image("offlinebg",flashvars.vertical?"./img/offlinebg_1.png":"./img/offlinebg.png"),this.game.load.image("Continue","./img/Continue.png"),this.game.load.image("menuMore","./img/more.png"),this.game.load.image("menuMoreHover","./img/more_hover.png"),"1"===flashvars.offline){if(flashvars.vertical)for(var e=0;e<20;e++)this.game.load.image("/weather/wind/feng_"+f["default"].formatNum(e)+".png","./img/wind/feng_"+f["default"].formatNum(e)+".png");for(var t=0;t<50;t++)this.game.load.image("/weather/rain/xiayu_"+f["default"].formatNum(t)+".png","./img/rain/xiayu_"+f["default"].formatNum(t)+".png");for(var n=0;n<120;n++)this.game.load.image("/weather/snow/xuehua_"+f["default"].formatNum(n)+".png","./img/snow/xuehua_"+f["default"].formatNum(n)+".png");for(var a=0;a<90;a++)this.game.load.image("/weather/mapleLeaves/fengye_"+f["default"].formatNum(a)+".png","./img/mapleLeaves/fengye_"+f["default"].formatNum(a)+".png");for(var o=0;o<90;o++)this.game.load.image("/weather/beachBlossom/taohua_"+f["default"].formatNum(o)+".png","./img/beachBlossom/taohua_"+f["default"].formatNum(o)+".png");for(var r=0;r<90;r++)this.game.load.image("/weather/blossom/yinghua_"+f["default"].formatNum(r)+".png","./img/blossom/yinghua_"+f["default"].formatNum(r)+".png");for(var i=0;i<50;i++)this.game.load.image("/weather/lightning/shandian_"+f["default"].formatNum(i)+".png","./img/lightning/shandian_"+f["default"].formatNum(i)+".png")}},preLoad:function(){var e=this;return new Promise(function(t,n){e.preLoadCertainAssets(),e.game.load.onLoadStart.addOnce(function(){e.addLog("正在准备播放..")}),e.game.load.onFileComplete.add(function(t,n,a,o,r){"offlinebg"===n&&e.showOfflineBg(),e.addLog("正在准备播放.. "+t+"%",!0)}),e.game.load.onLoadComplete.addOnce(function(){return e.game.load.onFileComplete.removeAll(),e.addLog("正在准备播放..【成功】",!0),t()}),e.game.load.start()})},getGameJson:function(e){var t=this;flashvars.uuid=flashvars.uuid||"41138941-7f1c-4701-9a94-394893483662";var n=flashvars.uuid;document.title=flashvars.name&&decodeURI(flashvars.name)||"测试";var a=function(e){if(e.lengthComputable){var n=e.loaded/e.total;t.addLog("加载剧情配置.. "+~~n+"%",!0)}else t.addLog("加载剧情配置.. "+e.loaded,!0)};this.addLog("加载剧情配置..");var o=e?c.getOtherGame:1==flashvars.type?c.getTestGame:c.getGame;return o(n,a).then(function(e){return t.addLog("加载剧情配置..【成功】",!0),e},function(e){return t.addLog("发生错误："+e),Promise.reject(e)})},addLog:function(e,t){if(e){var n=this.game.world.getByName("logInfo");if(!n){var a={font:"16px 宋体",fill:"#fff"};n=this.game.add.text(18,this.game.world.height-36,"",a),n.name="logInfo"}var o=n.text,r=o.split(/\r?\n/gi).filter(function(e){return!!e});t?r[r.length-1]=e:r.push(e),n.text="",r.slice(-4).map(function(e){return n.text+=e+"\n"}),n.y=this.game.world.height-26*r.length}},addButton:function(e,t,n,a,o,r,i,s,l,c,u,d){var h=this,m=function(e,t,n,a,o){var r=o.children[0],i=t?t:r?r.text:"";if(i){var s=e.fontSize?parseInt(e.fontSize):25,l=e.color?e.color:"#fefefe",c=h.sceneProxy.json_data.font.size?h.sceneProxy.toRealImageFontHeight(s):s,u=h.sceneProxy.json_data.font.size?h.sceneProxy.toRealImageFontWidth(s):s;if(l.indexOf("rgb")!==-1){var d=l.replace("rgb(","").replace(")","").split(",");o.addColor("#"+("00000"+(parseInt(d[0])<<16|parseInt(d[1])<<8|parseInt(d[2])).toString(16)).substr(-6),0)}else o.addColor("#ffffff"===l?"#fefefe":l,0);o.wordWrapWidth=540,h.sceneProxy.addImageFontText([{data:i}],u,c,o,h.sceneProxy.context);var f=o.children[0].extWidth?o.children[0].extWidth:u*i.length,m=(n-f)/2-(o.children[0].extMargin?o.children[0].extMargin:0),p=(a-c)/2;o.children[0].x=m,o.children[0].y=p,o.children[0].text=i,r&&(r.children.forEach(function(e){return e.fontImg.destroy()}),r.destroy()),o.text=" "}},p=function(e,t,o,r){var i=e.getByName("background"),s=e.getByName("button"),l=e.getByName("text"),c=h.game.load.cache.checkImageKey(t)?t:null;if(s)if(l&&o&&(x["default"].fontFamily?m(o,"",n,a,l):(l.font=o.fontFamily||l.font,l.fontSize=o.fontSize||l.fontSize,l.fontWeight=o.fontWeight||l.fontWeight,l.fill=o.color||l.fill),l.visible=!o.hidden),c){var u=1,d=s.width,f=s.height,p=h.game.cache.getImage(c);p.delay?i.key!==c&&h.addGifAnimation(i,c):(u=Math.min(d/p.width,f/p.height),i.loadTexture(c),i.scale.setTo(u,u),i.x=(d-i.width)/2,i.y=(f-i.height)/2)}else r||i.loadTexture(null)},y=this.game.add.group();y.name=c,u&&u.add(y),y.x=e,y.y=t;var g=this.game.load.cache.checkImageKey(o)?o:null,v=this.game.load.cache.checkImageKey(r)?r:null,P=this.game.add.image(0,0,g,null,y);P.name="background";var w=Math.min(n/P.width,a/P.height);P.scale.setTo(w,w),P.x=(n-P.width)/2,P.y=(a-P.height)/2,this.addGifAnimation(P,g);var k=!1,b=null,C=null,_=function(e,t){b=e,C=t},S=this.game.add.button(0,0,null,d?i:_,this,0,0,0,0,y);S.width=n,S.height=a,S.name="button",l&&(l.prevolume=void 0!==l.prevolume?l.prevolume:l.volume,this.game.device.desktop?S.setOverSound(l):S.setDownSound(l),this.game.device.desktop?S.onInputOut.add(function(){return l.stop()}):S.onInputUp.add(function(){}));var I=null;if(s){var L={},E="";E+=s.normal.fontWeight?s.normal.fontWeight+" ":"normal ",E+=s.normal.fontSize?parseInt(s.normal.fontSize)+"px ":"",E+=s.normal.fontFamily?s.normal.fontFamily:this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:"",L.font=E,L.fill=s.normal.color,L.stroke=s.normal.stroke,L.strokeThickness=s.normal.stroke?2:0,L.boundsAlignH="center",L.boundsAlignV="middle",I=this.game.add.text(0,0,s.text,L,y),I.name="text",x["default"].fontFamily?m(s.normal,s.text,n,a,I):I.setTextBounds(0,(I.height-parseInt(s.normal.fontSize||12))/2,n,a),s.normal.hidden&&(I.visible=!1)}return S.input.mouseOut=function(){if(null!==this.sprite&&this.sprite.inputEnabled){var e=this._pointerData[0];e.isOver=!1,e.isOut=!0,e.timeOut=this.game.time.time,this.useHandCursor&&e.isDragged===!1&&(this.game.canvas.style.cursor="default",this._setHandCursor=!1),this.sprite&&this.sprite.events&&(this.sprite.events.onInputOut$dispatch(this.sprite,null),this.sprite&&this.sprite.parent&&this.sprite.parent.type===Phaser.GROUP&&this.sprite.parent.onChildInputOut.dispatch(this.sprite,null))}},!d&&S.onInputOver.add(function(){S.onOverSound&&(S.onOverSound.volume=(void 0!==S.onOverSound.prevolume?S.onOverSound.prevolume:S.onOverSound.volume)*f["default"].soundVolume),p(y,v,s&&s.normal)}),!d&&S.onInputOut.add(function(){k=!1,p(y,g,s&&s.normal)}),!d&&S.onInputDown.add(function(){k=!0,S.onDownSound&&(S.onDownSound.volume=(null!==S.onDownSound.prevolume?S.onDownSound.prevolume:S.onDownSound.volume)*f["default"].soundVolume),p(y,v,s&&s.active)}),!d&&S.onInputUp.add(function(){k=!1,p(y,g,s&&s.normal),i&&i(b,C)}),y.changeBackground=function(e,t,n){p(this,e,t,n)},y.button=S,y.text=I,y},addGifAnimation:function(e,t){var n=this.game.cache.getImage(e.key,!0),a=n.data,o=a.frames,r=a.loopCount;if(o){var i=1,s=function(t){if(o[t]&&o[t].blobUrl){var n=new Image;n.onload=function(t){var n=new PIXI.BaseTexture(t.target),a=new PIXI.Texture(n);e&&e.parent&&e.setTexture(a)},n.src=o[t].blobUrl}},l=function c(t){f["default"].timeout(10*o[t].delay).then(function(){if(s(t),t++,t>=o.length){if(r&&i>=r||!e||!e.parent)return;i++,c(0)}else c(t)})};l(0)}},addFitImageSprint:function(e,t,n,a,o,r,i){var s=this.game.load.cache.checkImageKey(o)?o:null,l=this.game.add.sprite(e,t,s);if(s){var c=Math.min(n/l.width,a/l.height);l.pivot.x=l.width/2,l.pivot.y=l.height/2,l.scale.setTo(c,c),l.x+=l.width/2,l.y+=l.height/2}if(i>0){var u=0;for(u=0;u<r.children.length;u++){var d=r.getAt(u);if(-1===d)break;if(d.zIndex===i){r.removeChildAt(u),d.destroy();break}if(d.zIndex>i)break}var h=this.game.add.group();h.add(l),h.zIndex=i,r.add(h,!1,u)}else r.add(l);return l},game:null,onRendered:null,sceneProxy:null},{TEXT_CHANGED:"textChanged"})}),require.register("js/view/mediator/CoverMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i),l=t("../../common/PhoneUtils.js"),c=a(l);r["default"].define({name:"diygamePlayer.view.mediator.CoverMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU:this.showCoverLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},addCover:function(){var e=this,t=this.sceneProxy.json_data,n=t.template,a=t.cover,o=n.json.cover,r=o.titleContainer,i=o.startMenu,l=o.loadMenu,c=o.settingsMenu,u=o.overMenu,d=this.game.world.width,h=this.game.world.height,f=function(t,n,a,o,r,i,l,c){var u={},h="";h+=i.fontWeight?i.fontWeight+" ":"normal ",h+=i.fontSize?parseInt(i.fontSize)+"px ":"",h+=i.fontFamily?i.fontFamily:"",u.font=h,u.fill=i.color,u.stroke=i.stroke,u.strokeThickness=i.stroke?2:0,u.boundsAlignH="center",u.boundsAlignV=c?"bottom":"middle";var f=e.game.add.text(0,0,r,u,e.sceneProxy.coverLayer);if(f.name=l,s["default"].fontFamily){var m=("#ffffff"===i.color?"#fefefe":i.color).replace("#","0x"),p=i.fontSize?parseInt(i.fontSize):25;f.colors.splice(0,f.colors.length),f.text=" ",f.fill=m,f.addColor(m,0),f.x=(d-p*r.length)/2,f.y=n,f.wordWrapWidth=d;var y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(p):p,g=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(p):p;e.sceneProxy.addImageFontText([{data:r}],g,y,f,e.sceneProxy.context)}else f.setTextBounds(t,n+(f.height-parseInt(i.fontSize))/2,a,o);return i.hidden&&(f.visible=!1),f},m=function(t,n,a){var o={};o.normal=t.normal.text,o.active=t.active.text,o.text=a;var r=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,t.normal.background.url,t.active.background.url,p,o,e.sceneProxy.btn_sound,n,e.sceneProxy.coverLayer);r.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})},p=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("cover_button_start"===t.parent.name?e.sceneProxy.onCoverStartBtnClicked():"cover_button_load"===t.parent.name?e.sceneProxy.onCoverLoadBtnClicked():"cover_button_settings"===t.parent.name?e.sceneProxy.onCoverSettingBtnClicked():"cover_button_over"===t.parent.name&&e.sceneProxy.onCoverOverBtnClicked())},y=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.coverLayer);y.beginFill(0),y.drawRect(0,0,d,h),y.endFill();var g=a.background.url;if(this.game.load.cache.checkImageKey(g)&&(y=this.sceneProxy.coverLayer.create(0,0,g)),this.sceneProxy.prePlotBkKey=this.sceneProxy.lstPlotBkKey,this.sceneProxy.lstPlotBkKey=a.background.url,this.sceneProxy.lstPlotBkFlex=a.background.flex,this.sceneProxy.lstPlotBkOpacity=a.background.opacity,this.sceneProxy.lstGameBk=this.viewComponent.game.add.sprite(0,0,this.game.load.cache.checkImageKey(g)&&g),y.inputEnabled=!0,3===a.background.flex){var v=y.width/y.height<d/h?d/y.width:h/y.height;y.width*=v,y.height*=v,y.x=-(y.width-d)/2,y.y=-(y.height-h)/2}else if(5===a.background.flex){var x=0;y.width/y.height>d/h?(x=d/y.width,y.width*=x,y.height*=x,y.y=(h-y.height)/2):(x=h/y.height,y.width*=x,y.height*=x,y.x=(d-y.width)/2)}else y.width=d,y.height=h;this.sceneProxy.lstGameBk.x=y.x,this.sceneProxy.lstGameBk.y=y.y,this.sceneProxy.lstGameBk.width=y.width,this.sceneProxy.lstGameBk.height=y.height,a.title.data&&!r.title.text.hidden&&this.viewComponent.addFitImageSprint(r.rect.x,r.rect.y,r.rect.width,r.rect.height,r.background.url,this.sceneProxy.coverLayer);var P=a.title,w=P.font_size,k=P.color,b=P.bold,C=P.fontFamily,_=P.hidden,S=r.title.text;w&&(S.fontSize=w),k&&(S.color=k),void 0!==b&&(S.fontWeight=b?"bold":"normal"),S.fontFamily=this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:C?C:"",void 0!==_&&(S.hidden=_),f(r.title.rect.x+r.rect.x,r.title.rect.y+r.rect.y,r.title.rect.width,r.title.rect.height,a.title.data,S,"cover_text_title",!0),i.hidden||m(i,"cover_button_start",this.sceneProxy.stringMap.startMenu),l.hidden||m(l,"cover_button_load",this.sceneProxy.stringMap.loadMenu),c.hidden||m(c,"cover_button_settings",this.sceneProxy.stringMap.settingsMenu),u.hidden||m(u,"cover_button_over",this.sceneProxy.stringMap.overMenu),this.sceneProxy.coverLayer.visible=!1},showCoverLayer:function(){this.sceneProxy.lstPlotLayer&&this.sceneProxy.lstPlotLayer.destroy(),this.sceneProxy.curPlotLayer&&this.sceneProxy.curPlotLayer.destroy(),this.sceneProxy.dialogLayer.visible=!1,this.sceneProxy.menuLayer.visible=!1,this.sceneProxy.lstGameBk&&(this.sceneProxy.lstGameBk.visible=!0),0===this.sceneProxy.coverLayer.children.length&&this.addCover();var e=this.sceneProxy.json_data.cover,t=e.music,n=e.background;this.sceneProxy.bk_music&&this.sceneProxy.stopMusic(),t&&(this.game.load.cache.checkSoundKey(t.url)||c["default"].isAudioInCache(t.url)&&"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&this.sceneProxy.playMusic(t.url,t.volume,!0),this.sceneProxy.lstPlotBkKey=n.url,this.sceneProxy.lstPlotBkOpacity=n.opacity,this.sceneProxy.lstPlotBkFlex=n.flex,this.sceneProxy.coverLayer.visible=!0,this.game.world.bringToTop(this.sceneProxy.coverLayer)}},{NAME:"CoverMediator"})}),require.register("js/view/mediator/EndMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var r=t("puremvc"),i=a(r);i["default"].define({name:"diygamePlayer.view.mediator.EndMediator",parent:i["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_END]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_END:this.showEndLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game},btnStatesChanged:function(e,t,n,a,o,r,i){a&&(a.font=r.fontFamily,a.fontSize=r.fontSize,a.fontWeight=r.fontWeight,a.fill=r.color,a.visible=!r.hidden,void 0!==i&&(a.inputEnabled=i)),this.loadTexture(n,o)},loadTexture:function(e,t){if(e){var n=e.width,a=e.height,o=this.game.load.cache.checkImageKey(t)?t:null;e.loadTexture(o),e.width=n,e.height=a}},addEnd:function(){var e=this,t=function(t,n,o,r,i,s){var l=e.game.load.cache.checkImageKey(o)?o:null,c=e.game.add.button(t,n,l,a,e,0,0,0,0,e.sceneProxy.endLayer);return c.width=r,c.height=i,c.name=s,c},n=function(t,n,a,o,r,i,s){var l={},c="";c+=i.fontWeight?i.fontWeight+" ":"normal ",c+=i.fontSize?parseInt(i.fontSize)+"px ":"",c+=i.fontFamily?i.fontFamily:"",l.font=c,l.fill=i.color,l.boundsAlignH="center",l.boundsAlignV="middle";var u=e.game.add.text(0,0,r,l,e.sceneProxy.endLayer);return u.name=s,u.setTextBounds(t,n+(u.height-parseInt(i.fontSize))/2,a,o),i.hidden&&(u.visible=!1),u},a=function(t,n){if(n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)switch(t.name){case"end_button_get":e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_gte"),"icon_get",s),e.sceneProxy.endLayer.visible=!1,e.sceneProxy.visibleLayout=[e.sceneProxy.endLayer].concat(o(e.sceneProxy.visibleLayout)),e.sceneProxy.showLoad();break;case"end_button_back":e.sceneProxy.reStart(e.sceneProxy.isExtend()),e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_back"),"icon_back",s),e.sceneProxy.endLayer.visible=!1;break;case"end_button_save":e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_save"),"icon_save",s),e.sceneProxy.showSave()}},r=this.game.add.bitmapData(this.game.world.width,this.game.world.height);r.fill(0,0,0,.8);var i=this.game.add.sprite(0,0,r);i.width=this.game.world.width,i.height=this.game.world.height,i.inputEnabled=!0,this.sceneProxy.endLayer.add(i);var s={fontFamily:"",fontSize:"14px",color:"#ffffff"},l={fontFamily:"",fontSize:"14px",color:"#ef7297"},c=t(flashvars.vertical?55:168,flashvars.vertical?427:100,"icon_get",96,96,"end_button_get"),u=n(flashvars.vertical?55:168,flashvars.vertical?527:200,96,30,"读取进度",s,"end_text_get");c.onInputOver.add(this.btnStatesChanged,this,0,c,u,"icon_get_hover_pressed",l),c.onInputDown.add(this.btnStatesChanged,this,0,c,u,"icon_get_hover_pressed",l),c.onInputOut.add(this.btnStatesChanged,this,0,c,u,"icon_get",s);var d=t(flashvars.vertical?216:432,flashvars.vertical?427:100,"icon_back",96,96,"end_button_back"),h=n(flashvars.vertical?216:432,flashvars.vertical?527:200,96,30,"返回封面",s,"end_text_back");d.onInputOver.add(this.btnStatesChanged,this,0,d,h,"icon_back_over_pressed",l),d.onInputDown.add(this.btnStatesChanged,this,0,d,h,"icon_back_over_pressed",l),d.onInputOut.add(this.btnStatesChanged,this,0,d,h,"icon_back",s);var f=t(flashvars.vertical?377:696,flashvars.vertical?427:100,"icon_save",96,96,"end_button_save"),m=n(flashvars.vertical?377:696,flashvars.vertical?527:200,96,30,"存个档，下次玩",s,"end_text_save");f.onInputOver.add(this.btnStatesChanged,this,0,f,m,"icon_save_over_pressed",l),
f.onInputDown.add(this.btnStatesChanged,this,0,f,m,"icon_save_over_pressed",l),f.onInputOut.add(this.btnStatesChanged,this,0,f,m,"icon_save",s),this.sceneProxy.endLayer.visible=!1},showEndLayer:function(){this.sceneProxy.getSnap(),0===this.sceneProxy.endLayer.children.length&&this.addEnd(),this.game.world.bringToTop(this.sceneProxy.endLayer),this.sceneProxy.endLayer.visible=!0}},{NAME:"EndMediator"})}),require.register("js/view/mediator/HtmlTextBox.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t,n,a,o,r,i,s,l,c){Phaser.Group.call(this,e),this.game=e,this.name="input",this.parentElement=e.canvas.parentNode,this.textBoxElement=document.createElement("input"),this.textBoxElement.style.position="absolute",this.textBoxElement.style.margin="0",this.textBoxElement.style.border="0",this.textBoxElement.style.padding="0",this.textBoxElement.style.left=t+"px",this.textBoxElement.style.top=n+"px",this.textBoxElement.style.width=a+"px",this.textBoxElement.style.height=o+"px",this.textBoxElement.style.color=i,this.textBoxElement.style.backgroundColor="transparent",this.textBoxElement.style.borderColor="transparent transparent transparent transparent",this.textBoxElement.style.outline="none",this.textBoxElement.style.fontSize=s+"px",this.textBoxElement.style.fontFamily=l,this.textBoxElement.style.fontWeight=c?"bold":"normal",this.parentElement.insertBefore(this.textBoxElement,e.canvas),this._x=t,this._y=n,this._width=a,this._height=o,this._fontSize=s,this.text=r,this.isValue=!1,e.add.existing(this),this.onDestroy.add(function(e){this.parentElement.removeChild(this.textBoxElement)},this)}Object.defineProperty(e,"__esModule",{value:!0}),e.HtmlTextBox=o;var r=t("../../common/Utils.js"),i=a(r);o.prototype=Object.create(Phaser.Group.prototype),o.prototype.constructor=o,o.prototype.update=function(){var e=this.game.canvas,t=e.offsetLeft,n=e.offsetTop,a=e.offsetWidth,o=e.offsetHeight;if(this.oldCanvasWidth!=a||this.oldCanvasHeight!=o||this.oldCanvasX!=t||this.oldCanvasY!=n){var r=this.game.world.width,i=this.game.world.height;if(e.offsetWidth>e.offsetHeight){var s=(flashvars.vertical?o:a)/r,l=(flashvars.vertical?a:o)/i,c=this._x/r,u=this._y/i,d=flashvars.vertical?t+a-a*u:t+a*c,h=flashvars.vertical?n+o*c:n+o*u,f=this._width*s,m=this._height*l,p=this._fontSize*l;this.setLeft(flashvars.vertical?d-f/2-m/2:d),this.setTop(flashvars.vertical?h+f/2-m/2:h),this.setWidth(f),this.setHeight(m),this.setFontSize(p),this.textBoxElement.style.transform=flashvars.vertical?"rotate(90deg)":"rotate(0deg)"}else{var y=(flashvars.vertical?a:o)/r,g=(flashvars.vertical?o:a)/i,v=this._x/r,x=this._y/i,P=flashvars.vertical?t+a*v:t+a-a*x,w=flashvars.vertical?n+o*x:n+o*v,k=this._width*y,b=this._height*g,C=this._fontSize*g;this.setLeft(flashvars.vertical?P:P-k/2-b/2),this.setTop(flashvars.vertical?w:w+k/2-b/2),this.setWidth(k),this.setHeight(b),this.setFontSize(C),this.textBoxElement.style.transform=flashvars.vertical?"rotate(0deg)":"rotate(90deg)"}this.oldCanvasWidth=a,this.oldCanvasHeight=o,this.oldCanvasX=t,this.oldCanvasY=n}},o.prototype.destroy=function(){this.parentElement.removeChild(this.textBoxElement)},o.prototype.show=function(e){this.textBoxElement.style.visibility=e?"visible":"hidden"},o.prototype.setInputCallback=function(e){var t=this,n=function(){t._text=t.textBoxElement.value,i["default"].sensitiveWords.forEach(function(e){if(0!==e.length){var n=t._text.indexOf(e);if(n!==-1){var a="*".repeat(e.length);t._text=t._text.replace(new RegExp(e,"gi"),a),t.textBoxElement.value=t._text}}}),e(t._text)};if("ios"===flashvars.client||navigator.userAgent.indexOf("iPhone")>-1){var a=navigator.userAgent.match(/CPU\siPhone\sOS\s((([0-9]*)+(_))*)+([0-9]*)/gi);a&&(a[0]>="CPU iPhone OS 10_3_1"||"CPU iPhone OS 10_0_2"===a[0])?this.textBoxElement.addEventListener("input",n,!1):this.textBoxElement.addEventListener("compositionend",function(){t.textBoxElement.removeEventListener("input",n,!1),t.textBoxElement.addEventListener("input",n,!1)},!1)}else this.textBoxElement.addEventListener("input",n,!1);this.textBoxElement.onblur=function(){if(t.isValue){var e=parseFloat(t._text);e?t.text=e+"":t.text="0"}}},o.prototype.setClickCallback=function(e){var t=this;this.textBoxElement.addEventListener("click",function(){e(t)},!1)},o.prototype.setLeft=function(e){this.textBoxElement.style.left=e+"px"},o.prototype.setTop=function(e){this.textBoxElement.style.top=e+"px"},o.prototype.setWidth=function(e){this.textBoxElement.style.width=e+"px"},o.prototype.setHeight=function(e){this.textBoxElement.style.height=e+"px"},o.prototype.setFontSize=function(e){this.textBoxElement.style.fontSize=e+"px"},o.prototype.setEnable=function(e){this.textBoxElement.readOnly=(!!e).toString()},Object.defineProperty(o.prototype,"x",{get:function(){return this._x},set:function(e){this.setLeft(e),this._x=e}}),Object.defineProperty(o.prototype,"y",{get:function(){return this._y},set:function(e){this.setTop(e),this._y=e}}),Object.defineProperty(o.prototype,"width",{get:function(){return this._width},set:function(e){this.setWidth(e),this._width=e}}),Object.defineProperty(o.prototype,"height",{get:function(){return this._height},set:function(e){this.setHeight(e),this._height=e}}),Object.defineProperty(o.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){this.setFontSize(e),this._fontSize=e}}),Object.defineProperty(o.prototype,"style",{get:function(){return this._style},set:function(e){for(var t in e)this.textBoxElement.style[t]=e[t];this._style=e}}),Object.defineProperty(o.prototype,"text",{get:function(){return this._text},set:function(e){this.textBoxElement.value=e,this._text=e}}),Object.defineProperty(o.prototype,"readOnly",{get:function(){return this.readOnly},set:function(e){this.setEnable(e),this.textBoxElement.readOnly=(!!e).toString()}})}),require.register("js/view/mediator/MainMenuMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i);r["default"].define({name:"diygamePlayer.view.mediator.MainMenuMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU]},handleNotification:function(e){var t=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU:this.showMainMenuLayer(t)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME),this.sceneMediator=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME),this.game=this.sceneMediator.viewComponent&&this.sceneMediator.viewComponent.game,this.viewComponent=this.sceneMediator.viewComponent,this.isAllHide=!1},addMainMenu:function(){var e=this,t=this.sceneProxy.json_data.template.json.mainMenu,n=t.background,a=t.header,o=t.save,r=t.load,i=t.playback,l=t.settings,c=t.autoplay,u=t.back,d=function(t,n,a,o,r,i,s){var l=t.fontSize?parseInt(t.fontSize):25,c=t.color?t.color:"#fefefe",u=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(l):l,d=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(l):l,h=d*i.length,f=n+(o-h)/2,m=a+(r-u)/2,p=e.sceneProxy.addRetroText(f,m,h,u,i);p.tint=("#ffffff"===c?"#fefefe":c).replace("#","0x"),s.addChild(p),s.text=" "},h=function(t,n,a,o,r,i,l){var c={},u="";u+=i.fontWeight?i.fontWeight+" ":"normal ",u+=i.fontSize?parseInt(i.fontSize)+"px ":"",u+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",c.font=u,c.fill=i.color,c.boundsAlignH="center",c.boundsAlignV="middle",c.stroke=i.stroke,c.strokeThickness=i.stroke?2:0;var h=e.viewComponent.game.add.text(0,0,r,c,e.sceneProxy.mainMenuLayer);return h.name=l,s["default"].fontFamily?d(i,t,n,a,o,r,h):h.setTextBounds(t,n+(h.height-parseInt(i.fontSize))/2,a,o),i.hidden&&(h.visible=!1),h},f=function(t,n,a){var o={};o.normal=t.normal.text,o.active=t.active.text,o.text=a;var r=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,t.normal.background.url,t.active.background.url,m,o,e.sceneProxy.btn_sound,n,e.sceneProxy.mainMenuLayer);r.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})},m=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("mainMenu_button_save"===t.parent.name?e.sceneProxy.onMainMenuSaveBtnClicked():"mainMenu_button_load"===t.parent.name?e.sceneProxy.onMainMenuLoadBtnClicked():"mainMenu_button_playback"===t.parent.name?e.sceneProxy.onMainMenuPlaybackBtnClicked():"mainMenu_button_autoplay"===t.parent.name?e.sceneProxy.onMainMenuAutoplayBtnClicked():"mainMenu_button_settings"===t.parent.name?e.sceneProxy.onMainMenuSettingsBtnClicked():"mainMenu_button_back"===t.parent.name&&e.sceneProxy.onMainMenuBackBtnClicked())},p=this.viewComponent.game.add.image(0,0,this.viewComponent.game.load.cache.checkImageKey(n.url)&&n.url);if(p.width=this.viewComponent.game.world.width,p.height=this.viewComponent.game.world.height,p.inputEnabled=!0,this.sceneProxy.mainMenuLayer.add(p),this.viewComponent.game.load.cache.checkImageKey(a.background.url)){var y=this.sceneProxy.mainMenuLayer.create(a.rect.x,a.rect.y,a.background.url);y.width=a.rect.width,y.height=a.rect.height}a.title.text.hidden||h(a.title.rect.x+a.rect.x,a.title.rect.y+a.rect.y,a.title.rect.width,a.title.rect.height,this.sceneProxy.stringMap.mainMenu,a.title.text,"mainMenu_text_header"),o.hidden||f(o,"mainMenu_button_save",this.sceneProxy.stringMap.save),r.hidden||f(r,"mainMenu_button_load",this.sceneProxy.stringMap.load),i.hidden||f(i,"mainMenu_button_playback",this.sceneProxy.stringMap.playback),c.hidden||f(c,"mainMenu_button_autoplay",this.sceneProxy.stringMap.autoplay),l.hidden||f(l,"mainMenu_button_settings",this.sceneProxy.stringMap.settings),u.hidden||f(u,"mainMenu_button_back",this.sceneProxy.stringMap.back),this.sceneProxy.mainMenuLayer.visible=!1,o.hidden&&r.hidden&&i.hidden&&l.hidden&&u.hidden&&(this.isAllHide=!0)},addDiyMainMenuenu:function(){var e=this,t=this.sceneProxy.json_data.default_settings.mainMenu,n=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.mainMenuLayer);n.beginFill(0,0),n.drawRect(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),n.endFill(),n.inputEnabled=!0,this.sceneMediator.registerViewKey(t.ref,t.events,this.sceneProxy.plotViewKeys);var a=this.sceneMediator.addView(this.sceneProxy.mainMenuLayer,t.ref,t.instanceUuid,t.x,t.y,t.events,!1,!1,!0);a.isMenu=!0;var o=function(){var t=function n(t){"TIMER"===t.viewType&&(e.sceneProxy.menuTimer[e.sceneProxy.menuTimer.length]=t.name),t.children.forEach(function(e){n(e)})};a.children.forEach(function(e){t(e)})};o(),this.sceneMediator.uiOnLoadInvoker()},showMainMenuLayer:function(e){this.sceneProxy.mainMenuLayer.children.length>0&&this.sceneProxy.json_data.default_settings.mainMenu&&this.sceneProxy.mainMenuLayer.removeAll(!0),0===this.sceneProxy.mainMenuLayer.children.length&&(this.sceneProxy.json_data.default_settings.mainMenu?this.addDiyMainMenuenu():this.addMainMenu());var t=this.sceneProxy.mainMenuLayer.getByName("mainMenu_button_autoplay"),n=t?t.getByName("text"):void 0;if(e.auto){if(n)if(s["default"].fontFamily){var a=n.children[0];if(a){var o=this.sceneProxy.json_data.template.json.mainMenu.autoplay,r=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(o.normal.text.fontSize):o.normal.text.fontSize,i=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(o.normal.text.fontSize):o.normal.text.fontSize,l=i*this.sceneProxy.stringMap.manualPlay.length,c=(o.rect.width-l)/2,u=(o.rect.height-r)/2;this.sceneProxy.addImageFontText([{data:this.sceneProxy.stringMap.manualPlay}],i,r,n,e),n.children[0].x=c,n.children[0].y=u,a.children.forEach(function(e){return e.fontImg.destroy()}),a.destroy(),n.text=" "}}else n.text=this.sceneProxy.stringMap.manualPlay}else if(n)if(s["default"].fontFamily){var d=n.children[0];if(d){var h=this.sceneProxy.json_data.template.json.mainMenu.autoplay,f=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(h.normal.text.fontSize):h.normal.text.fontSize,m=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(h.normal.text.fontSize):h.normal.text.fontSize,p=m*this.sceneProxy.stringMap.autoplay.length,y=(h.rect.width-p)/2,g=(h.rect.height-f)/2;this.sceneProxy.addImageFontText([{data:this.sceneProxy.stringMap.autoplay}],m,f,n,e),n.children[0].x=y,n.children[0].y=g,d.children.forEach(function(e){return e.fontImg.destroy()}),d.destroy(),n.text=" "}}else n.text=this.sceneProxy.stringMap.autoplay;this.viewComponent.game.world.bringToTop(this.sceneProxy.mainMenuLayer),this.sceneProxy.mainMenuLayer.visible=!0,this.isAllHide!==!1&&this.sceneProxy.onMainMenuBackBtnClicked()}},{NAME:"MainMenuMediator",isAllHide:!1})}),require.register("js/view/mediator/PlaybackMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/RePhaser.js"),s=a(i),l=t("../../common/FontUtils.js");a(l);r["default"].define({name:"diygamePlayer.view.mediator.PlaybackMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK,diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK:this.callbackInfo=e.getBody(),this.showPlaybackLayer();break;case diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT:var t=e.getBody();this.addPlaybackContent(t)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},addTextContent:function(e,t,n,a,o,r){var i={boundsAlignH:"center",boundsAlignV:"middle",wordWrap:!0},s="";s+=r.fontWeight?r.fontWeight+" ":"normal ",s+=r.fontSize?parseInt(r.fontSize)+"px ":"",s+=r.fontFamily?r.fontFamily:"黑体",i.font=s,i.fill=r.color,i.wordWrapWidth=n,this.sceneProxy.stringMap.back===o?(i.boundsAlignH="center",i.boundsAlignV="middle"):(i.boundsAlignH="left",i.boundsAlignV="top");var l=this.game.add.text(0,0,o,i,this.sceneProxy.playBackLayer);return l.setTextBounds(e,t+(l.height-parseInt(r.fontSize||12))/2,n,a),l},addPlayback:function(){var e=this,t=this.sceneProxy.json_data.template.json.playback,n=t.scrollBox,a=t.back,o=t.background,r=this.sceneProxy.playBackLayer.create(0,0,this.game.load.cache.checkImageKey(o.url)&&o.url);r.width=this.game.world.width,r.height=this.game.world.height,r.inputEnabled=!0;var i=n.rect.x,s=n.rect.y,l=n.rect.width,c=n.rect.height,u=Object.assign({x:0,y:0,width:l,height:c},n.background.rect),d=this.sceneProxy.playBackLayer.create(i+u.x,s+u.y,this.game.load.cache.checkImageKey(n.background.url)&&n.background.url);d.width=u.width,d.height=u.height;var h=this.game.add.sprite(0,0),f=i,m=s;h.x=f,h.y=m,h.name="scrollPane",this.sceneProxy.playBackLayer.add(h);var p=(n.item.rect.width,n.item.rect.height),y=Math.max(p-n.item.content.rect.height,0),g=0,v=null,x=!1,P=function(e,t,n){var a=b(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?x||(document.addEventListener(o,_),x=!0):x&&(document.removeEventListener(o,_),x=!1)},w=function(e,t){var n=h.children.length*p-y;return n<c?void(h.y=s):(e!==i&&(h.x=i),void(t>s?h.y=s:t+n<s+c?h.y=s+c-n:h.y=t))},k=function(e,t,n,a,o,r){var i=n,s=a;r&&(g=n),v=h.y,document.body.clientWidth<document.body.clientHeight&&null!==v&&(s=v-n+g),w(i,s)},b=function(e){var t=void 0,n=void 0,a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,o=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return a>o?flashvars.vertical?(t=e.worldY,n=-e.worldX):(t=e.worldX,n=e.worldY):flashvars.vertical?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),n<m||n>m+c||t<f||t>f+l?null:{x:t,y:n}},C=function(e,t,n,a){return b(t)?e.input.enableDrag():e.input.disableDrag()},_=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;w(0,h.y+100*t)};h.inputEnabled=!0,h.input.enableDrag(),h.input.allowHorizontalDrag=!1,h.events.onDragUpdate.add(k,this),h.events.onInputDown.add(C,this),this.game.input.addMoveCallback(P,this);var S=this.game.add.graphics(0,0);S.beginFill(16777215),S.drawRect(i,s,l,c),this.sceneProxy.playBackLayer.add(S),h.mask=S;var I=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||(e.sceneProxy.onPlaybackBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null))};if(!a.hidden){var L={};L.normal=a.normal.text,L.active=a.active.text,L.text=this.sceneProxy.stringMap.back;var E=null;if(this.sceneProxy.json_data.template.json.sound){var M=this.sceneProxy.json_data.template.json.sound;this.sceneProxy.viewComponent.game.load.cache.checkSoundKey(M.url)&&(E=this.sceneProxy.viewComponent.game.add.sound(M.url,M.volume))}var T=this.viewComponent.addButton(a.rect.x,a.rect.y,a.rect.width,a.rect.height,a.normal.background.url,a.active.background.url,I,L,E,"playBack_button_back",this.sceneProxy.playBackLayer);T.button.onInputUp.add(function(){return E&&E.stop()})}this.sceneProxy.playBackLayer.visible=!1},addPlaybackContent:function(e){this.sceneProxy.playbackData.push(e),this.sceneProxy.playbackData.length>100&&this.sceneProxy.playbackData.splice(0,1)},addPlaybackItem:function(e){var t=this.sceneProxy.playBackLayer.getByName("scrollPane"),n=this.sceneProxy.json_data.template.json.playback.scrollBox,a=this.game.load.cache.checkImageKey(n.item.background.url)?n.item.background.url:null,o=this.game.load.cache.checkImageKey(n.item.content.background.url)?n.item.content.background.url:null,r=n.item.rect.x+n.item.content.rect.x,i=n.item.rect.y+n.item.content.rect.y,l=this.game.add.group();l.x=n.item.rect.x,l.y=n.item.rect.y+n.item.rect.height*t.children.length;var c=this.game.add.sprite(0,0,a);c.width=n.item.rect.width,c.height=n.item.rect.height;var u=this.game.add.sprite(r,i,o);u.width=n.item.content.rect.width,u.height=n.item.content.rect.height;var d=this.addTextContent(r+10,i,n.item.content.rect.width-10,n.item.content.rect.height,"",n.item.content.text);d.useAdvancedWrap=!0,d.updateText=s["default"].updateText,d.advancedWordWrap=s["default"].advancedWordWrap,d.lineSpacing=-parseInt(n.item.content.text.fontSize||12)/5,d.text=e,d.name="text";var h=this.game.add.graphics(0,0);h.beginFill(16777215),h.drawRect(r,i,u.width,u.height),d.mask=h,l.addChild(h),l.add(c),l.add(u),l.add(d),t.addChild(l)},showPlaybackLayer:function(){var e=this;this.sceneProxy.playBackLayer.removeAll(!0),this.addPlayback(),this.sceneProxy.playbackData.forEach(function(t){e.addPlaybackItem(t)}),this.game.world.bringToTop(this.sceneProxy.playBackLayer),this.sceneProxy.playBackLayer.visible=!0;var t=this.sceneProxy.json_data.template.json.playback.scrollBox,n=t.rect,a=t.item,o=this.sceneProxy.playBackLayer.getByName("scrollPane"),r=Math.max(a.rect.height-a.content.rect.height,0),i=o.children.length*a.rect.height-r,s=n.y+a.rect.y;i<n.height?o.y=s:o.y=s-i+n.height}},{NAME:"PlaybackMediator"})}),require.register("js/view/mediator/RecordMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("spark-md5"),s=a(i),l=t("./../../common/Dialog.js"),c=a(l),u=t("./../../common/Utils.js"),d=a(u),h=t("../../common/FontUtils.js"),f=a(h);r["default"].define({name:"diygamePlayer.view.mediator.RecordMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_RECORD]},handleNotification:function(e){var t=e.getBody();switch(this.callbackInfo=t?t:this.sceneProxy.recordLayer?this.callbackInfo:null,e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_RECORD:this.showRecordLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent,this.localMode=!0,this.isChangeClick=!1,this.clicktime=0,this.clickchangetime=0},onLocalBtnClicked:function(){if(this.clickInterval(800)===!0&&!this.localMode){this.localMode=!0,this.isChangeClick=!0;var e=this.sceneProxy.recordLayer.getByName("local_btn"),t=this.sceneProxy.recordLayer.getByName("cloud_btn");e&&e.changeBackground("local_hover"),t&&t.changeBackground("cloud"),this.sceneProxy.onRecordLocalBtnClicked()}},onCloudBtnClicked:function(){var e=this;this.clickInterval(800)===!0&&this.localMode&&this.sceneProxy.isSignedIn().then(function(){e.localMode=!1,e.isChangeClick=!0;var t=e.sceneProxy.recordLayer.getByName("local_btn"),n=e.sceneProxy.recordLayer.getByName("cloud_btn");t&&t.changeBackground("local"),n&&n.changeBackground("cloud_hover"),e.sceneProxy.onRecordCloudBtnClicked()},function(t){var n=t.indexOf("- status:-1");if(n=n>=0?n:t.indexOf("- status:2"),n>=0){if(e.sceneProxy.context.fullScreen&&e.sceneProxy.onSettingsWindowModeBtnClicked(),t.indexOf("- status:-110")>0){var a=e.sceneProxy.recordLayer.getByName("local_btn"),o=e.sceneProxy.recordLayer.getByName("cloud_btn");return a&&a.changeBackground("local_hover","local_btn"),o&&o.changeBackground("cloud","cloud_btn"),e.sceneProxy.onRecordLocalBtnClicked(),e.localMode=!0,void c["default"].error(t.substr(0,n)).then(function(){},function(){})}flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),"wap"===flashvars.client?window.parent&&window.parent.playLogin():c["default"].error(t.substr(0,n)).then(function(){window.location.href="lzj3000://login"})}else 0<=t.indexOf("error")&&(e.sceneProxy.context.fullScreen&&e.sceneProxy.onSettingsWindowModeBtnClicked(),c["default"].error("网络异常，请检查您的网络！"))})},addRecord:function(){var e=this,t=this.sceneProxy.json_data.template.json.record,n=t.background,a=t.scrollBox,o=t.back,r=a.rect,i=a.item,s=a.itemsOffsetX,l=a.itemsOffsetY,c=a.itemSpaceX,u=a.itemSpaceY,d=i.rect,h=i.hint,m=i.content,p=h.rect,y=h.text,g=m.rect,v=r.x,x=r.y,P=r.width,w=r.height,k=d.x,b=d.y,C=d.width,_=d.height,S=p.x,I=p.y,L=p.width,E=p.height,M=g.x,T=g.y,O=g.width,A=g.height;c=void 0===c?20:c,u=void 0===u?12:u,s=void 0===s?0:s,l=void 0===l?0:l;var V={boundsAlignH:"center",boundsAlignV:"middle"},N=function(t,n,a,o,r,i){var s=void 0,l="";if(l+=i.fontWeight?i.fontWeight+" ":"normal ",l+=i.fontSize?parseInt(i.fontSize)+"px ":"",l+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",V.font=l,V.fill=i.color,s=e.game.add.text(0,0,r,V,e.sceneProxy.recordLayer),f["default"].fontFamily){var c=(i.color?i.color:e.json_data.default_settings.color).replace("#","0x");if(c.indexOf("rgb")!==-1){var u=c.replace("rgb(","").replace(")","").split(",");s.addColor("#"+("00000"+(parseInt(u[0])<<16|parseInt(u[1])<<8|parseInt(u[2])).toString(16)).substr(-6),0)}else s.addColor(c,0);var d=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(s.fontSize):s.fontSize;s.x=t+(a-196*d/25-21-22*d/25)/2,s.y=n+(s.height-parseInt(s.fontSize))/2,s.wordWrapWidth=260*d/25}else s.setTextBounds(t,n+(s.height-parseInt(i.fontSize))/2,a,o);return s},j=this.sceneProxy.recordLayer.create(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);j.width=this.game.world.width,j.height=this.game.world.height,j.inputEnabled=!0;var B=this.game.add.sprite(0,0),R=Object.assign({x:0,y:0,width:P,height:w},n.rect),D=this.sceneProxy.recordLayer.create(v+R.x,x+R.y,this.game.load.cache.checkImageKey(a.background.url)&&a.background.url);D.width=R.width,D.height=R.height;var F=v+s,U=x+l;B.x=F,B.y=U,B.name="scrollPane",this.sceneProxy.recordLayer.add(B);var W=flashvars.vertical?12:3,G=flashvars.vertical?1:4,z=0,H=0,K=void 0,q={x:0,y:0},J=this.game.add.sprite(0,0);J.width=(C+c)*G,J.height=(_+u)*W,B.addChild(J);var $=0,Y=null,Q=!0,X=function(e,t){(Math.abs(B.y-Y)>2||Math.abs(B.x-$)>2)&&Y&&(Q=!1);var n=_*W+u*(W-1);t>U||n<=w?B.y=U:t+n<x+w?B.y=x+w-(_*W+u*(W-1)):B.y=t},Z=function(e,t,n,a,o,r){var i=n,s=a,l=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;l<c&&null!==Y&&!flashvars.vertical&&(s=Y-n+$),X(i,s)},ee=function(e,t,n,a,o,r){$=n,Y=B.y},te=function(e,t,n,a,o,r){Y=B.y},ne=function(e){var t=void 0,n=void 0,a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,o=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return a>o?flashvars.vertical?(t=e.worldY,n=-e.worldX):(t=e.worldX,n=e.worldY):flashvars.vertical?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),n<U||n>U+w||t<F||t>F+P?null:{x:t,y:n}},ae=function(e,t,n,a){return Q=!0,ne(t)?e.input.enableDrag():e.input.disableDrag()},oe=function(t,n){if(Q===!0){var a=ne(n);if(a&&(n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)){if(0===e.clicktime)e.clicktime=e.game.time.now;else{if(!(e.game.time.now-e.clicktime>=800))return;e.clicktime=0}q.x=0,q.y=0;var o=a.x-B.x,r=a.y-B.y,i=C+c,s=_+u;if(o%i<C&&r%s<_){var l=Math.floor(o/i),d=Math.floor(r/s);flashvars.vertical?e.sceneProxy.onRecordItemClicked(d,l):e.sceneProxy.onRecordItemClicked(l,d),e.sceneProxy.bToSaveFile||(e.callbackInfo=null)}}}},re=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;X(0,B.y+100*t)},ie=!1,se=function(e,t,n){var a=ne(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?ie||(document.addEventListener(o,re),ie=!0):ie&&(document.removeEventListener(o,re),ie=!1)};K=this.game.load.cache.checkImageKey(i.background.url)?i.background.url:null;for(var le=0;le<W;le++)for(var ce=0;ce<G;ce++){var ue=this.game.add.group();ue.x=ce*(C+c)+k,ue.y=le*(_+u)+b,ue.name="recordItem_"+(le*G+ce);var de=this.game.add.sprite(z,H,K);de.width=C,de.height=_;var he=this.sceneProxy.recordLayer.create(M,T,this.game.load.cache.checkImageKey(m.background.url)&&m.background.url);he.name="content",he.width=O,he.height=A;var fe=N(S,I,L,E,"",y);fe.name="textTime";var me=this.game.add.graphics(0,0);if(me.beginFill(),me.drawRect(0,0,C,_),me.endFill(),ue.addChild(me),ue.mask=me,ue.add(de),ue.add(he),ue.add(fe),this.sceneProxy.json_data.default_settings.autoSaveOrLoad&&0===le&&0===ce){var pe=this.game.add.bitmapData(C,_);pe.fill(0,0,0,.4);var ye=this.game.add.sprite(0,0,pe);ye.width=C,ye.height=_;var ge={font:"16px Microsoft YaHei",fill:"white",boundsAlignH:"center",boundsAlignV:"middle"},ve=this.game.add.text(0,0,"自动存档",ge,this.sceneProxy.coverLayer);ve.setTextBounds(0,(ve.height-16)/2,C,_),ue.add(ye),ue.add(ve)}B.addChild(ue)}B.inputEnabled=!0,B.input.enableDrag(),B.input.allowHorizontalDrag=!1,B.events.onDragUpdate.add(Z,this),B.events.onDragStart.add(ee,this),B.events.onDragStop.add(te,this),B.events.onInputUp.add(oe,this),B.events.onInputDown.add(ae,this),this.game.input.addMoveCallback(se,this);var xe=this.game.add.graphics(0,0);xe.beginFill(),xe.drawRect(B.x,B.y,P-s,w-l),xe.endFill(),this.sceneProxy.recordLayer.add(xe),B.mask=xe;var Pe={};Pe.normal=o.normal.text,Pe.active=o.active.text,Pe.text=this.sceneProxy.stringMap.back;var we=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("record_button_back"===t.parent.name?(e.sceneProxy.onRecordBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null)):"local_btn"===t.parent.name?e.onLocalBtnClicked():"cloud_btn"===t.parent.name&&e.onCloudBtnClicked())};if(!o.hidden){var ke=this.viewComponent.addButton(o.rect.x,o.rect.y,o.rect.width,o.rect.height,o.normal.background.url,o.active.background.url,we,Pe,this.sceneProxy.btn_sound,"record_button_back",this.sceneProxy.recordLayer);ke.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}this.sceneProxy.recordLayer.visible=!1},updateItems:function(){var e=this;this.sceneProxy.savedPlotsData.forEach(function(t,n){var a=function(t){var n=e.game.load.cache.checkImageKey(t)?t:null,a=l.getByName("content"),o=a.width,r=a.height;a.loadTexture(n),a.width=o,a.height=r},o=t?t:{},r=o.timestamp,i=o.plotSnap,l=e.sceneProxy.recordLayer.getByName("scrollPane").children.find(function(e){return e.name==="recordItem_"+n});if(l){if(!r)return a(e.sceneProxy.json_data.template.json.record.scrollBox.item.content.background.url),void(l.getByName("textTime").text="");var c=l.getByName("textTime"),u=s["default"].hash(i);if(e.game.load.cache.checkImageKey(u))a(u);else{var h=new Image;h.src=i,h.onload=function(t){e.game.load.cache.checkImageKey(u)||e.game.cache.addImage(u,i,t.target),a(u)}}var m=d["default"].getCurrentDateTime(r);if(f["default"].fontFamily){var p=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(c.fontSize):c.fontSize,y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(c.fontSize):c.fontSize;e.sceneProxy.addImageFontText([{data:m}],y,p,c,e.sceneProxy.context),c.text=" "}else c.text=m}})},showRecordLayer:function(){var e=this;this.clicktime=0,0===this.sceneProxy.recordLayer.children.length&&this.addRecord(),this.sceneProxy.isShowCloudBtn&&this.sceneProxy.isShowLocalBtn&&this.isChangeClick!==!0||this.isChangeClick!==!0&&this.sceneProxy.isWapOther()?this.sceneProxy.isSignedIn().then(function(){e.localMode=!1,e.isChangeClick=!0;var t=e.sceneProxy.recordLayer.getByName("local_btn"),n=e.sceneProxy.recordLayer.getByName("cloud_btn");t&&t.changeBackground("local"),n&&n.changeBackground("cloud_hover"),e.sceneProxy.onRecordCloudBtnClicked()},function(t){e.updateItems(),e.game.world.bringToTop(e.sceneProxy.recordLayer),e.showGuide(),e.sceneProxy.recordLayer.visible=!0}):(this.updateItems(),this.game.world.bringToTop(this.sceneProxy.recordLayer),this.showGuide(),this.sceneProxy.recordLayer.visible=!0)},showGuide:function(){this.sceneProxy.isShowGuide!==!0||this.sceneProxy.recordLayer.visible===!0||this.sceneProxy.isExtend()||Boolean(flashvars.wap&&"zxwwap"===flashvars.wap)||this.sceneProxy.isWapOther()||this.sceneProxy.showGuideTip(1)},clickInterval:function(e){return 0===this.clickchangetime?(this.clickchangetime=this.game.time.now,!0):this.game.time.now-this.clickchangetime>=e&&(this.clickchangetime=0,!0)}},{NAME:"RecordMediator",localMode:!0,isChangeClick:!1,clicktime:0,clickchangetime:0})}),require.register("js/view/mediator/SceneMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t("./CoverMediator.js"),t("./MainMenuMediator.js"),t("./SettingsMediator.js"),t("./PlaybackMediator.js"),t("./RecordMediator.js"),t("./EndMediator.js");var s=t("./HtmlTextBox.js"),l=o(s),c=t("./../../common/Dialog.js"),u=a(c),d=t("../../common/RePhaser.js"),h=a(d),f=t("../../common/Utils.js"),m=a(f),p=t("../../common/PhoneUtils.js"),y=a(p),g=t("../../common/FontUtils.js"),v=a(g),x=t("../../common/OtherWap.js"),P=(a(x),t("copy-to-clipboard")),w=a(P),k=t("puremvc"),b=a(k);b["default"].define({name:"diygamePlayer.view.mediator.SceneMediator",parent:b["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_SHOW_AD,diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN,diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS,diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE,diygamePlayer.AppConstants.SCENE_LOADING_BEGIN,diygamePlayer.AppConstants.SCENE_LOADING_PROGRESS,diygamePlayer.AppConstants.SCENE_LOADING_COMPLETE,diygamePlayer.AppConstants.SCENE_SHOW_LOGO,diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY,diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED,diygamePlayer.AppConstants.SCENE_DESTROY_VIEW,diygamePlayer.AppConstants.SCENE_SHOW_GUIDE,diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW];
},handleNotification:function(e){var t=this,n=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_SHOW_AD:break;case diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN:this.sceneProxy.viewComponent=this.viewComponent,this.sceneProxy.space_key=this.viewComponent.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);var a=this.viewComponent.game.input.keyboard.addKey(Phaser.Keyboard.Z);a.onDown.add(function(){return t.sceneProxy.quickPlay=!0}),a.onUp.add(function(){return t.sceneProxy.quickPlay=!1}),this.viewComponent.game.input.onHold.add(function(){t.screenCaptured()}),this.viewComponent.game.input.onUp.add(function(){t.screenReleased()}),this.generateLayers(),this.viewComponent.game.load.crossOrigin="anonymous",this.viewComponent.preLoad().then(function(){return t.addToastLayer(),t.addLoadingToastLayer(),t.viewComponent.getGameJson(t.sceneProxy.isWapOther())}).then(function(e){return 0===Object.keys(e).length?Promise.reject("链接已过期"):(t.viewComponent.addLog("解析剧情配置..."),t.viewComponent.showOfflineBg(),t.sceneProxy.parseJsonFile(e).then(function(){return t.viewComponent.addLog("解析剧情配置..【成功】",!0),new Promise(function(e,n){var a=t.viewComponent.game.world.getByName("offlinebg");if(!a||"Operation_tip"!==a.key)return e();var o=function i(n,o){if(!o||o.pointerMode!==Phaser.PointerMode.CURSOR||0===o.button){a.events.onInputDown.remove(i);var r=t.viewComponent.game.world.getByName("Continue");return r&&r.destroy(),m["default"].localStorageSetItem("shanyi3000opg","showed"),e()}};if(t.viewComponent.game.cache.checkImageKey("Continue")){var r=t.viewComponent.game.add.image(0,0,"Continue");r.name="Continue",r.x=(t.viewComponent.game.world.width-r.width)/2,r.y=flashvars.vertical?(t.viewComponent.game.world.height-r.height)/2:t.viewComponent.game.world.height-30}a.events.onInputDown.addOnce(o)})},function(e){return t.viewComponent.addLog("剧情配置解析错误:"+e),Promise.reject(e||"解析Json错误")}))}).then(function(){t.sceneProxy.updateAccInfo(!1,!0)},function(e){return Promise.reject(e)}).then(function(){return null},function(e){flashvars.client&&""!==flashvars.client?u["default"].warn(e+"关闭播放器吗？").then(function(){window.location.href="lzj3000://quit"},function(){return null}):u["default"].warn(e+"，返回闪艺首页吗？").then(function(){return window.location.href="http:\\\\www.3000.com"},function(){return null})});break;case diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS:this.assetsLoaderStart(diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE);break;case diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE:this.viewComponent.destroyLogo();var o=this.sceneProxy.json_data;this.sceneProxy.initContext(),this.sceneProxy.updateAccInfo();var i=this.sceneProxy.json_data.template.json.sound,s=this.viewComponent.game.world.getByName("offlinebg"),l=this.viewComponent.game.world.getByName("Continue");if(s&&s.destroy(),l&&l.destroy(),this.viewComponent.game.load.cache.checkSoundKey(i.url)&&(this.sceneProxy.btn_sound=this.viewComponent.game.add.sound(i.url,i.volume)),o.logo&&!o.logo.background.hidden)this.sceneProxy.showLogo();else if(o.cover.hidden){var c=this.sceneProxy.findFirstChapter(),d=c.downloadUuid?c.downloadUuid:c.uuid;if(c.md5&&0===c.plots.length){if(this.sceneProxy.isWapOther()){var h=function(e){null===e?u["default"].error("获取付费章节信息失败"):"fail"===e?u["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,w["default"])("819786897",{debug:!1,message:"复制成功"})},function(){}):(c.plots=e?e:[],t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,c))};return void this.sceneProxy.unlockChapterByWapOther(d,c.charge,c.md5,h)}if(!c.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)this.sceneProxy.checkIfChapterFree(d,c.md5).then(function(e){var n;(n=c.plots).push.apply(n,r(e)),t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,c)},function(e){-1===e.indexOf("code=87")?u["default"].error(e):u["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var f=function(e){e?t.sceneProxy.checkIfChapterFree(d,c.md5).then(function(e){var n;t.sceneProxy.unlockChapterCallBack=null,(n=c.plots).push.apply(n,r(e)),t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,c)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():u["default"].error("获取付费章节信息失败")}):u["default"].error("章节解锁失败")};this.sceneProxy.unlockChapter(d,c.charge,c.md5,f)}}else this.sceneProxy.preloadChapterAssets(this.sceneProxy.context,c)}else this.sceneProxy.showCover();break;case diygamePlayer.AppConstants.SCENE_LOADING_BEGIN:break;case diygamePlayer.AppConstants.SCENE_LOADING_PROGRESS:break;case diygamePlayer.AppConstants.SCENE_LOADING_COMPLETE:break;case diygamePlayer.AppConstants.SCENE_SHOW_LOGO:this.showLogo();break;case diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY:this.assetsLoaderStart(diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED,n);break;case diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED:this.addMenuLayer(!!this.sceneProxy.json_data.template.json.shanyiMenu),this.showPlot(n.context,this.sceneProxy.curChapter,this.sceneProxy.curPlotIndex,this.sceneProxy.cmdPlotSnap,n.loadData);break;case diygamePlayer.AppConstants.SCENE_DESTROY_VIEW:this.destroyView(n.name,n.isMainMenu);break;case diygamePlayer.AppConstants.SCENE_SHOW_GUIDE:this.showGuideTip(n.id);break;case diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW:this.showInputView(this.sceneProxy.plotViewsLayer,!!n)}},generateLayers:function(){this.sceneProxy.coverLayer=this.viewComponent.game.add.group(),this.sceneProxy.coverLayer.name="coverLayer",this.sceneProxy.progressLayer=this.viewComponent.game.add.group(),this.sceneProxy.progressLayer.name="progressLayer",this.sceneProxy.dialogLayer=this.viewComponent.game.add.group(),this.sceneProxy.dialogLayer.name="dialogLayer",this.sceneProxy.dialogLayer.animateTweens=[],this.sceneProxy.menuLayer=this.viewComponent.game.add.group(),this.sceneProxy.menuLayer.name="menuLayer",this.sceneProxy.mainMenuLayer=this.viewComponent.game.add.group(),this.sceneProxy.mainMenuLayer.name="mainMenuLayer",this.sceneProxy.mainMenuLayer.visible=!1,this.sceneProxy.settingsLayer=this.viewComponent.game.add.group(),this.sceneProxy.settingsLayer.name="settingsLayer",this.sceneProxy.settingsLayer.visible=!1,this.sceneProxy.recordLayer=this.viewComponent.game.add.group(),this.sceneProxy.recordLayer.name="recordLayer",this.sceneProxy.recordLayer.visible=!1,this.sceneProxy.playBackLayer=this.viewComponent.game.add.group(),this.sceneProxy.playBackLayer.name="playBackLayer",this.sceneProxy.playBackLayer.visible=!1,this.sceneProxy.weatherLayer=this.viewComponent.game.add.group(),this.sceneProxy.weatherLayer.name="weatherLayer",this.sceneProxy.plotViewsLayer=this.viewComponent.game.add.group(),this.sceneProxy.plotViewsLayer.name="plotViewsLayer",this.sceneProxy.endLayer=this.viewComponent.game.add.group(),this.sceneProxy.endLayer.name="endLayer",this.sceneProxy.toastLayer=this.viewComponent.game.add.group(),this.sceneProxy.toastLayer.name="toastLayer",this.sceneProxy.loadingToastLayer=this.viewComponent.game.add.group(),this.sceneProxy.loadingToastLayer.name="loadToastLayer",this.sceneProxy.quickPlayLayer=this.viewComponent.game.add.group(),this.sceneProxy.quickPlayLayer.name="quickPlayLayer",this.sceneProxy.guideLayer=this.viewComponent.game.add.group(),this.sceneProxy.guideLayer.name="guideLayer"},screenCaptured:function(){var e=this;if(this.sceneProxy.isGameStarted&&this.sceneProxy.isQuickPlay===!0){if(0===this.sceneProxy.quickPlayLayer.children.length){var t=this.sceneProxy.quickPlayLayer.create(0,0,"app_button_speed"),n=this.sceneProxy.quickPlayLayer.create(0,0,"app_icon_speed"),a={font:"25px PingFang-SC-Regular",fill:"#333333"},o=this.viewComponent.game.add.text(0,0,"快进中...",a,this.sceneProxy.quickPlayLayer),r={font:"20px PingFang-SC-Regular",fill:"#aaadb3"},i=this.viewComponent.game.add.text(0,0,"松开手指恢复播放",r,this.sceneProxy.quickPlayLayer);t.x=(this.viewComponent.game.world.width-t.width)/2,t.y=(this.viewComponent.game.world.height-t.height)/2,n.x=t.x+90,n.y=t.y+25,o.x=n.x-10,o.y=n.y+n.height+14,i.x=t.x+39,i.y=o.y+33}this.sceneProxy.isScreenHold=!0,this.sceneProxy.quickPlay=!0,this.sceneProxy.removePlotTweens();var s=function l(){var t=e.sceneProxy,n=e.viewComponent.game;return function(){var e=t.plotViewsLayer.children.length>0;if(!e&&t.playPause!==!0){var a=new Phaser.Pointer(n,1,Phaser.PointerMode.CURSOR);a.button=0,t.curPlotLayer.onChildInputDown.dispatch("quickPlayHandler",a)}t.isScreenHold&&setTimeout(l(),500)}};setTimeout(s(),20),this.sceneProxy.quickPlayLayer.alpha=1,this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)}},screenReleased:function(){this.sceneProxy.isScreenHold&&(this.sceneProxy.isScreenHold=!1,this.sceneProxy.quickPlay=!1,this.sceneProxy.quickPlayLayer.alpha=0)},cmdPlotLoadResources:function(e,t,n,a,o){var i=this,s=this.viewComponent.game.load,l=s.cache,c=a.commands[o],u=f.ResourcesManager.getCommandResources(c),d="ios"===flashvars.client&&flashvars.app_version>="1.5.0",h=0,m=[];u.forEach(function(e){var t=e.type,n=e.url;if(n){if("audio"===t&&d)return void(!y["default"].isAudioInCache(n)&&h++);var a="img"===t?l.checkImageKey(n):l.checkSoundKey(n);a||(h++,a=s.getAsset("img"===t?"image":"audio",n),a&&m.push({type:t,key:n}))}});var p=0,g=[],v=function x(e){for(var t=0;t<e.length&&p<5;t++){var n=e[t],a=f.ResourcesManager.getCommandResources(n);if(a.length&&(g.push.apply(g,r(a)),p++),"options"===n.type||"conditionOptions"===n.type)for(var o=0;o<n.args.length&&p<5;o++)x(n.args[o].commands)}};return f.ResourcesManager.clearPreCmdResources(a.commands,o),h!==m.length?this.sceneProxy.preloadCommandsAssets(e,t,n,a,o).then(function(e){return i.assetsLoader(e,!0,!0)}):h?(v(a.commands.slice(o)),m=g.filter(function(e){var t=e.type,n=e.url;return s.getAsset("img"===t?"image":"audio",n)}).map(function(e){return Object.assign(e,{key:e.url})}),this.assetsLoader(m,!0)):Promise.resolve()},showGuideTip:function(e){var t=this;return new Promise(function(n,a){if("android"!==flashvars.client&&"ios"!==flashvars.client)return t.sceneProxy.guideLayer.visible=!1,n();var o=function(e){if(t.sceneProxy.isShowGuide===!0){var a=t.sceneProxy.guideLayer.getByName("Cloud_record_tip");if(t.sceneProxy.guideLayer.children.length<=0){if(t.sceneProxy.guideLayer.inputEnableChildren=!0,t.sceneProxy.guideLayer.inputEnabled=!0,!t.viewComponent.game.load.cache.checkImageKey("Cloud_record_tip")&&1===e)return n();a=t.sceneProxy.guideLayer.create(t.viewComponent.game.world.width/2,t.viewComponent.game.world.height/2,"Cloud_record_tip"),a.name="Cloud_record_tip",a.anchor.setTo(.5,.5),a.visible=!1}t.sceneProxy.guideLayer.alpha=1,t.sceneProxy.guideLayer.visible=!0,a.visible=0!==e,t.viewComponent.game.world.bringToTop(t.sceneProxy.guideLayer);var o=function i(a,o){o&&o.pointerMode===Phaser.PointerMode.CURSOR&&0!==o.button||(t.sceneProxy.guideLayer.onChildInputDown.remove(i),t.tweenToPromise(t.sceneProxy.guideLayer,{alpha:0},1e3,null,!0,0,0,!1).then(function(){return t.sceneProxy.guideLayer.visible=!1,t.sceneProxy.guideLayer.alpha=0,0!==e&&(t.sceneProxy.isShowGuide=!1),m["default"].localStorageSetItem(r,JSON.stringify({count:t.sceneProxy.recordTipCount})),n()}))};t.sceneProxy.guideLayer.onChildInputDown.add(o)}},r="shanyi3000guide",i=JSON.parse(m["default"].localStorageGetItem(r));if(null!==i&&void 0!==i){if(t.sceneProxy.recordTipCount=i.count,1===e){if(t.sceneProxy.recordTipCount>=10)return t.sceneProxy.isShowGuide=!1,t.sceneProxy.guideLayer.visible=!1,n();t.sceneProxy.recordTipCount++,o(e)}else if(0===e)return t.sceneProxy.guideLayer.visible=!1,n()}else t.sceneProxy.isShowGuide=!0,o(e)})},addLoadingToastLayer:function(){if(0===this.sceneProxy.loadingToastLayer.children.length){var e=this.viewComponent.game.add.group();this.sceneProxy.loadingToastLayer.add(e);var t=this.viewComponent.game.add.graphics(0,0,e);t.beginFill(4048076),t.drawRect(0,0,135,36),t.endFill();var n=e.create(8,9,"toast_loading");this.viewComponent.addGifAnimation(n,"toast_loading");var a={font:"16px 微软雅黑",fill:"#ffffff"},o=this.viewComponent.game.add.text(33,8,"保存档案中~",a,e);o.name="toastText",e.x=(this.viewComponent.game.world.width-o.width)/2,e.y=flashvars.vertical?100:252,e.alpha=.8,this.sceneProxy.loadingToastLayer.visible=!1}},addToastLayer:function(){if(0===this.sceneProxy.toastLayer.children.length){var e=this.viewComponent.game.add.group(),t=this.viewComponent.game.add.group();e.name="typeSuccess",t.name="typeError",this.sceneProxy.toastLayer.add(e),this.sceneProxy.toastLayer.add(t);var n=this.viewComponent.game.add.graphics(0,0,e),a=this.viewComponent.game.add.graphics(0,0,t);n.beginFill(4048076),n.drawRect(0,0,320,36),n.endFill(),a.beginFill(4048076),a.drawRect(0,0,260,36),a.endFill(),e.create(10,10,"icon_success"),t.create(10,10,"icon_error");var o={font:"16px 微软雅黑",fill:"#ffffff"},r=this.viewComponent.game.add.text(30,8,"存档成功，下次可以从这里读档继续哦~",o,e);r.name="toastText",r=this.viewComponent.game.add.text(30,8,"存档失败，请检查您的网络哦~",o,t),r.name="toastText",e.visible=!1,t.visible=!1,this.sceneProxy.toastLayer.alpha=0}},assetsLoaderStart:function(e,t){var n=this,a=t||{},o=a.needLoadList,r=void 0===o?[]:o;return this.assetsLoader(r,!!t).then(function(){return n.sceneProxy.sendNotification(e,t)})},assetsLoader:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=Object.create(null),r=[],i=this.viewComponent.game,s=0,l=i.load,c=i.sound,u=i.cache,d="ios"===flashvars.client&&"1.5.0"<=flashvars.app_version;e=e.filter(function(e){var t=e.type,n=e.key;return"img"===t?!u.checkImageKey(n)&&l.getAsset("image",n):"audio"===t?d?!y["default"].isAudioInCache(n)&&y["default"].isLoadingAudio(n):!u.checkSoundKey(n)&&l.getAsset("audio",n):void 0});var h="";!n&&this.sceneProxy.json_data.cover.music&&this.sceneProxy.json_data.cover.music.url&&d&&""===flashvars.offline&&(h=this.sceneProxy.json_data.cover.music.url,y["default"].isAudioInCache(h)||y["default"].isAudioError(h)?h="":l._totalFileCount+=1);var f=n?e.length:l._totalFileCount,m=!1;return f?new Promise(function(i,p){var g=""===h,v=function(t){e.length?e.forEach(function(e){e.key===t&&e&&!e.loaded&&(e.loaded=!0,s++)}):s++},x=function(){var a=d?""===h||n?e.every(function(e){return e.loaded}):g:r.every(function(e){return e.decoded});m&&a&&(y["default"].audioCountLoadByPhone.total=0,y["default"].audioCountLoadByPhone.loaded=0,c.onSoundDecode.removeAll(o),c.onSoundDecodeError.removeAll(o),l.onSoundExtendLoad.removeAll(o),l.onSoundExtendLoadError.removeAll(o),t.sceneProxy.progressLayer.visible=!1,i()),l.onFileComplete.removeAll(o)},P=function(o){if(""!==h&&!n){if(o!==h)return;g=!0}if(!e.every(function(e){return e.loaded})||m!==!0||""!==h){v(o);var r=parseInt(100*s/f);a&&t.showProgress(r,s,f,n),e.every(function(e){return e.loaded})&&(m=!0)&&x()}},w=function(e){var t=-1,n=u.getSound(e);(t=r.findIndex(function(e){return e===n}))!==-1&&(r.splice(t,1),u.removeSound(e)),x()};c.onSoundDecode.add(function(){return x()},o),c.onSoundDecodeError.add(w,o),l.onSoundExtendLoad.add(P,o),l.onSoundExtendLoadError.add(P,o),l.onFileComplete.add(function(o,i,l,c,d){if(v(i),o=parseInt(100*s/f),a&&t.showProgress(o,s,f,n),u.checkKey(Phaser.Cache.SOUND,i)){var h=u.getSound(i);h&&h.autoDecode&&h.isDecoding&&!h.decoded&&r.push(h)}e.length&&e.every(function(e){return e.loaded})&&(m=!0,x())},o,0),l.onLoadComplete.addOnce(function(){m||(m=!0,x())},o,0),f&&t.showProgress(0,0,0,n),l.start()}):Promise.resolve()},showLogo:function(){var e=this,t=this.sceneProxy,n=t.json_data,a=t.context,o=n.logo,i=(n.chapters,n.cover);if(o&&o.background&&!o.background.hidden&&this.viewComponent.game.load.cache.checkImageKey(o.background.url)){var s=o.background,l=s.flex,c=s.opacity;this.sceneProxy.prePlotBkKey=this.sceneProxy.lstPlotBkKey,this.sceneProxy.lstPlotBkKey=o.background.url,this.sceneProxy.lstPlotBkOpacity=o.background.opacity,this.sceneProxy.lstPlotBkFlex=l;var d=this.viewComponent.game.add.image(0,0,o.background.url);this.backgroundFlex(d,l),d.bringToTop(),d.alpha=0,this.tweenToPromise(d,{alpha:c},1e3,null,!0,0).then(function(){return m["default"].timeout(1e3)}).then(function(){return e.tweenToPromise(d,{alpha:0},1e3,null,!0,0).then(function(){if(i.hidden){var t=e.sceneProxy.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length){if(e.sceneProxy.isWapOther()){var o=function(n){null===n?u["default"].error("获取付费章节信息失败"):"fail"===n?u["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,w["default"])("819786897",{debug:!1,message:"复制成功"})},function(){}):(t.plots=n?n:[],e.sceneProxy.preloadChapterAssets(e.sceneProxy.context,t))};return void e.sceneProxy.unlockChapterByWapOther(n,t.charge,t.md5,o)}if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)e.sceneProxy.checkIfChapterFree(n,t.md5).then(function(n){var o;(o=t.plots).push.apply(o,r(n)),e.sceneProxy.preloadChapterAssets(a,t)},function(e){-1===e.indexOf("code=87")?u["default"].error(e):u["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var s=function(o){o?e.sceneProxy.checkIfChapterFree(n,t.md5).then(function(n){var o;e.sceneProxy.unlockChapterCallBack=null,(o=t.plots).push.apply(o,r(n)),e.sceneProxy.preloadChapterAssets(a,t)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():u["default"].error("获取付费章节信息失败")}):u["default"].error("章节解锁失败")};e.sceneProxy.unlockChapter(n,t.charge,t.md5,s)}}else e.sceneProxy.preloadChapterAssets(a,t)}else e.sceneProxy.showCover()})})}},showProgress:function(e,t,n,a){var o=this.sceneProxy.progressLayer.getByName("background"),r=this.sceneProxy.progressLayer.getByName("type0"),i=this.sceneProxy.progressLayer.getByName("type1"),s=this.viewComponent.game.world.width,l=this.viewComponent.game.world.height;if(o||(o=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.progressLayer),o.beginFill(0),o.drawRect(0,0,s,l),o.endFill(),o.name="background",o.inputEnabled=!0),a){o.alpha=.5,i||(i=this.viewComponent.game.add.group(),i.name="type1",this.sceneProxy.progressLayer.add(i));var c=i.getByName("progressText");if(!c){var u={font:"24px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle"};c=this.viewComponent.game.add.text(0,0,"",u,i),c.name="progressText",c.setTextBounds(s/2-90,l/2-20,180,30)}c.text="加载中..."+e+"%",r&&(r.visible=!1),i&&(i.visible=!0),this.sceneProxy.progressLayer.bringToTop(i)}else{return}this.sceneProxy.progressLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.sceneProxy.progressLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},addDialogLayer:function(){var e=this.sceneProxy.json_data.template.json.dialog,t=e.background,n=e.rect,a=e.avatarContainer,o=e.titleContainer,r=e.content;if(0===this.sceneProxy.dialogLayer.children.length){var i=void 0,s=void 0,l=void 0;if(this.viewComponent.game.load.cache.checkImageKey(t.url)){var c=this.sceneProxy.dialogLayer.create(0,0,t.url);c.width=n.width,c.height=n.height,c.name="dialog_bk"}if(i=o.rect.x,s=o.rect.y,this.viewComponent.game.load.cache.checkImageKey(o.background.url)){var u=this.sceneProxy.dialogLayer.create(i,s,o.background.url);u.width=o.rect.width,u.height=o.rect.height,u.name="dialog_bk_title"}var d=void 0;i=o.rect.x+o.title.rect.x,s=o.rect.y+o.title.rect.y,d=this.viewComponent.game.add.text(0,0,"",{fill:"#fff"},this.sceneProxy.dialogLayer),d.name="dialog_text_title",d.setTextBounds(i+(o.title.rect.width-o.rect.width)/2,s,o.rect.width,o.rect.height),this.viewComponent.game.load.cache.checkImageKey(a.background.url)&&(i=a.rect.x,s=a.rect.y,l=this.sceneProxy.dialogLayer.create(i,s,a.background.url),l.width=a.rect.width,l.height=a.rect.height,l.name="dialog_bk_avatar"),i=a.rect.x+a.avatar.x,s=a.rect.y+a.avatar.y;var f=this.sceneProxy.dialogLayer.create(i,s);f.name="dialog_avatar",f.width=a.avatar.width,f.height=a.avatar.height,d=this.viewComponent.game.add.text(r.rect.x,r.rect.y,"",{fill:"#fff",boundsAlignH:"left",boundsAlignV:"top",wordWrap:!0,wordWrapWidth:r.rect.width},this.sceneProxy.dialogLayer),d.name="dialog_text_content",d.useAdvancedWrap=!0,d.updateText=h["default"].updateText,d.advancedWordWrap=h["default"].advancedWordWrap}this.sceneProxy.dialogLayer.x=n.x,this.sceneProxy.dialogLayer.y=n.y,this.sceneProxy.dialogLayer.alpha=1,this.sceneProxy.dialogLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.sceneProxy.dialogLayer),this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},addMenuLayer:function(e){var t=this;if(0===this.sceneProxy.menuLayer.children.length){var n=this.sceneProxy.json_data.template.json.menu,a=n.rect,o=n.normal,r=n.active,i=function(e,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("menu_button"===e.parent.name?t.sceneProxy.onMenuBtnClicked():t.sceneProxy.onSyMenuBtnClicked())},s={};s.normal=o.text,s.active=r.text,s.text="菜单",this.viewComponent.addButton(flashvars.vertical?442:866,26,a.width,a.height,o.background.url,r.background.url,i,s,this.sceneProxy.btn_sound,"menu_button",this.sceneProxy.menuLayer),this.viewComponent.addButton(flashvars.vertical?450:874,100,56,56,"menuMore","menuMoreHover",i,s,this.sceneProxy.btn_sound,"menu_button_more",this.sceneProxy.menuLayer)}this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.menuLayer.visible=!0},doEffectsAnimation:function(e){var t=function n(t){m["default"].timeout(40).then(function(){if(0!==e.children.length){if(!e.visible)return void n(t);0===t?e.children[e.children.length-1].visible=!1:e.children[t-1].visible=!1,e.children[t].visible=!0,n(++t%e.children.length)}})};t(0)},addRainEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("rain");if(!e){e=this.viewComponent.game.add.group(),e.name="rain",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<50;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("rain")+"/xiayu_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addSnowEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("snow");if(!e){e=this.viewComponent.game.add.group(),e.name="snow",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<120;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("snow")+"/xuehua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addWindEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("wind");if(!e)if(e=this.viewComponent.game.add.group(),e.name="wind",this.sceneProxy.weatherLayer.add(e),flashvars.vertical){for(var t=[],n=0;n<20;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("wind")+"/feng_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}else this.viewComponent.game.add.tileSprite(0,0,960,540,"wind",1,e).autoScroll(-360,0);this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addFallingLeavesEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("fallingLeaves");if(!e){e=this.viewComponent.game.add.group(),e.name="fallingLeaves",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addBeachBlossomEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("beachBlossom");if(!e){e=this.viewComponent.game.add.group(),e.name="beachBlossom",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("beachBlossom")+"/taohua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addBlossomEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("blossom");if(!e){e=this.viewComponent.game.add.group(),e.name="blossom",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("blossom")+"/yinghua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addLightningEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("lightning");if(!e){e=this.viewComponent.game.add.group(),e.name="lightning",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<50;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("lightning")+"/shandian_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},registerViewKey:function(e,t,n){var a=this,o=this.sceneProxy.json_data.viewMap,r=function(e){for(var t in e)"onKeyUp"===e[t].type&&(a.viewComponent.game.input.keyboard.removeKey(e[t].keyCode),n[e[t].keyCode]=a.viewComponent.game.input.keyboard.addKey(e[t].keyCode))},i=function s(e){r(o[e].events);for(var t in o[e].children)s(o[e].children[t].ref),r(o[e].children[t].events)};i(e),r(t)},removeViewKey:function(e){for(var t in e)this.viewComponent.game.input.keyboard.removeKey(t),e.splice(t,1)},removeViewKeyByInstance:function(e,t){var n=this,a=this.sceneProxy.json_data.viewMap,o=function(e){for(var a in e)"onKeyUp"===e[a].type&&(n.viewComponent.game.input.keyboard.removeKey(e[a].keyCode),t.splice(e[a].keyCode,1))},r=function i(e){e.name&&a[e.name]&&o(a[e.name].events);for(var t in e.children)i(e.children[t])};r(e)},addGlobalView:function(e){if(!this.sceneProxy.globalViews){this.sceneProxy.globalViews=[],this.sceneProxy.globalViewKeys=[];var t=this.sceneProxy.json_data.views;for(var n in t)this.registerViewKey(t[n].ref,t[n].events,this.sceneProxy.globalViewKeys),this.sceneProxy.globalViews[n]=this.addView(null,t[n].ref,t[n].instanceUuid,t[n].x,t[n].y,t[n].events),this.sceneProxy.globalViews[n].isGlobal=!0,t[n].scale&&(this.sceneProxy.globalViews[n].scale.set(t[n].scale,t[n].scale),this.sceneProxy.globalViews[n].x+=t[n].x.value*(1-t[n].scale),this.sceneProxy.globalViews[n].y+=t[n].y.value*(1-t[n].scale),this.scaleInputView(this.sceneProxy.globalViews[n],t[n].scale));this.uiOnLoadInvoker()}for(var a in this.sceneProxy.globalViews)e[this.sceneProxy.globalViews[a].name]?(this.sceneProxy.globalViews[a].visible=!1,this.showInputView(this.sceneProxy.globalViews[a],!1)):(this.sceneProxy.globalViews[a].visible=!0,this.showInputView(this.sceneProxy.globalViews[a],!0),this.viewComponent.game.world.bringToTop(this.sceneProxy.globalViews[a]))},addView:function(e,t,n,a,o,s){var c=arguments.length>6&&void 0!==arguments[6]&&arguments[6],d=this,f=arguments.length>7&&void 0!==arguments[7]&&arguments[7],m=arguments.length>8&&void 0!==arguments[8]&&arguments[8];if(!t)return!1;var p=!0,g=this.sceneProxy.json_data.viewMap[t];if(!g)return null;var x=this.viewComponent.game.add.group();x.name=t,x.instanceUuid=n,x.xInfo=a,x.yInfo=o,x.eventsInfo=s,x.inputEnableChildren=!0,x.viewInfoName=g.name,e&&e.add(x);var P=this.sceneProxy,w=P.Expression,k=P.curChapter,b=P.uiOnLoadQueue,C=this.sceneProxy.context,_=w.safeEval(a,C),S=w.safeEval(o,C),I=function(){m&&(d.sceneProxy.mainMenuLayer.children.length>0&&d.sceneProxy.json_data.default_settings.mainMenu&&d.sceneProxy.mainMenuLayer.removeAll(!0),d.sceneProxy.onResume())},L=function fe(t,n,a,o){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=0;for(l=0;l<n.length;l++){if("jump"===n[l].type)return d.sceneProxy.isGettingNext||(d.sceneProxy.uiOnLoadQueue=[],d.sceneProxy.mainMenuLayer.visible&&d.sceneProxy.onMainMenuBackBtnClicked(),d.sceneProxy.context=JSON.parse(JSON.stringify(C)),d.showNextPlot(d.sceneProxy.context,d.sceneProxy.curChapter,d.sceneProxy.curPlotIndex,n[l].type,n[l].handle.uuid)),!1;if("playMusic"===n[l].type)(d.viewComponent.game.load.cache.checkSoundKey(n[l].handle.music.url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&(d.sceneProxy.stopMusic(n[l].handle.music.url,!0),d.sceneProxy.playMusic(n[l].handle.music.url,n[l].handle.music.volume,!0,!0));else if("stopMusic"===n[l].type)d.sceneProxy.stopMusic(null,!0);else if("playSound"===n[l].type)for(var c=0;c<n[l].handle.sounds.length;c++){var h=n[l].handle.sounds[c]?n[l].handle.sounds[c].url:"";if("inherit"!==h)if(d.viewComponent.game.load.cache.checkSoundKey(h)){var f="inherit"===n[l].handle.sounds[c].volume?d.sceneProxy.plotSounds[c].volume:n[l].handle.sounds[c].volume;d.sceneProxy.stopSound(c,h,!0),d.sceneProxy.playSound(c,h,f,!n[l].handle.sounds[c].time,!0)}else if("ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var p="inherit"===n[l].handle.sounds[c].volume?y["default"].soundsInfo[c].volume:n[l].handle.sounds[c].volume;d.sceneProxy.stopSound(c,h,!0),d.sceneProxy.playSound(c,h,p,!n[l].handle.sounds[c].time,!0)}else d.sceneProxy.stopSound(c)}else if("stopSound"===n[l].type)d.sceneProxy.stopSound(-1,null,!0);else if("callUI"===n[l].type){if("save-record"===n[l].handle.id&&"system"===n[l].handle.type){var g=d.sceneProxy.context.disableSaveOrLoad;return g&&g.save?(d.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用存档"),!1):(!d.sceneProxy.mainMenuLayer.visible&&d.sceneProxy.getSnap(),d.sceneProxy.showSave(),!1)}if("load-record"===n[l].handle.id&&"system"===n[l].handle.type){var v=d.sceneProxy.context.disableSaveOrLoad;return v&&v.load?(d.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用读档"),!1):(d.sceneProxy.showLoad(),!1)}if("playback"===n[l].handle.id&&"system"===n[l].handle.type)return d.sceneProxy.showPlayback(),!1;if("settings"===n[l].handle.id&&"system"===n[l].handle.type)return d.sceneProxy.showSettings(d.sceneProxy.context),!1;if(n[l].handle.uuid)for(var x=Object.assign({},n[l].handle.position.x),P=Object.assign({},n[l].handle.position.y),_=n[l].handle.count?w.safeEval(n[l].handle.count,d.sceneProxy.context):1,S=0;S<_;S++){d.registerViewKey(n[l].handle.uuid,[],d.sceneProxy.plotViewKeys);var L=d.addView(e,n[l].handle.uuid,"",x,P,{},!1,!1,m);L&&(e?"plotViewsLayer"===e.name?d.sceneProxy.plotViews.push(L):e.xInfo&&e.yInfo&&(L.x+=w.safeEval(e.xInfo,d.sceneProxy.context),L.y+=w.safeEval(e.yInfo,d.sceneProxy.context)):(L.isGlobal=!0,d.sceneProxy.globalViews.push(L)),e&&e.parent&&"mainMenuLayer"===e.parent.name||d.sceneProxy.mainMenuLayer.visible||d.viewComponent.game.world.bringToTop(d.sceneProxy.menuLayer),"onLoad"!==a&&d.uiOnLoadInvoker())}}else if("refreshUI"===n[l].type){d.refreshView(n[l].handle.uuid)}else if("reload"===n[l].type){var E=d.refreshView(n[l].handle.uuid,!0);if(n[l].handle.uuid===e.name)for(var M=0;M<E.length;M++)if(E[M].name===e.name){e=E[M];break}d.uiOnLoadInvoker()}else if("closeUI"===n[l].type){var T=function(){var e=n[l].handle.uuid,a=t,o=!1,r=function(e){for(a=a&&a.parent;;){if(!a)break;if(a.viewType)return a.name;a=a.parent}};if("system"===n[l].handle.type&&"diyMainMenu"===n[l].handle.id){
if(!d.sceneProxy.json_data.default_settings.mainMenu)return{v:void 0};var i=d.sceneProxy.mainMenuLayer.children[1];i?(e=i.name,o=!0):(e=null,d.sceneProxy.onMainMenuBackBtnClicked(),d.sceneProxy.mainMenuLayer.removeAll(!0,!1,!0))}else e||(t.viewType?e=t.name:(e=r(a,!0),n[l].isParent&&(e=r(a,!0))));if(e){for(var s=e.substring(0,36),c=0;c<b.length;c++)b[c].name!==s&&b[c].instanceUuid!==s||b.splice(c--,1);d.destroyView(e,o)}if("system"===n[l].handle.type)return{v:void 0}}();if("object"===("undefined"==typeof T?"undefined":i(T)))return T.v}else{if("back"===n[l].type)return I(),d.sceneProxy.uiOnLoadQueue=[],d.sceneProxy.mainMenuLayer.visible&&d.sceneProxy.onResume(),d.sceneProxy.context=JSON.parse(JSON.stringify(C)),d.showNextPlot(d.sceneProxy.context,k,d.sceneProxy.curPlotIndex,n[l].type),!1;if("nextPlot"===n[l].type)return I(),d.sceneProxy.uiOnLoadQueue=[],k.plots[d.sceneProxy.curPlotIndex].commands?(d.sceneProxy.optionLayer.destroy(),d.sceneProxy.cmdPlotNextPromise&&d.sceneProxy.cmdPlotNextPromise({type:""}),!1):(d.sceneProxy.context=JSON.parse(JSON.stringify(C)),k.plots[d.sceneProxy.curPlotIndex].condition_options.length>0?(d.showNextPlot(d.sceneProxy.context,k,d.sceneProxy.curPlotIndex),!1):(d.showNextPlot(d.sceneProxy.context,k,d.sceneProxy.curPlotIndex,n[l].type),!1));if("jumpOption"===n[l].type){I(),d.sceneProxy.uiOnLoadQueue=[];var O=w.safeEval(n[l].handle.value,C);if(k.plots[d.sceneProxy.curPlotIndex].commands){var A=d.sceneProxy.getNextCommand(C,d.sceneProxy.curCmdInfo,-1,{eArg:O,type:"jumpOption"}),V=A.info,N=A.index;return N!==-1&&d.sceneProxy.cmdPlayHandlerFun(V,N),!1}return d.showNextPlot(d.sceneProxy.context,k,d.sceneProxy.curPlotIndex,n[l].type,O),!1}if("backOption"===n[l].type){I(),d.sceneProxy.uiOnLoadQueue=[];var j=w.safeEval(n[l].handle.value,C);if(k.plots[d.sceneProxy.curPlotIndex].commands){var B=d.sceneProxy.getNextCommand(C,d.sceneProxy.curCmdInfo,-1,{eArg:j,type:"backOption"}),R=B.info,D=B.index;return D!==-1&&d.sceneProxy.cmdPlayHandlerFun(R,D),!1}return d.showNextPlot(d.sceneProxy.context,k,d.sceneProxy.curPlotIndex,n[l].type,j),!1}if("insertPlot"===n[l].type){I(),d.sceneProxy.uiOnLoadQueue=[];var F=new Phaser.Pointer(d.viewComponent.game,1,Phaser.PointerMode.CURSOR);return F.button=0,d.sceneProxy.curPlotLayer.onChildInputDown.dispatch("insertPlot",F),d.showNextPlot(d.sceneProxy.context,d.sceneProxy.curChapter,d.sceneProxy.curPlotIndex,n[l].type,n[l].handle.uuid),!1}if("setValue"===n[l].type){if(s!==!1){if(o&&(o.paused=!0),l<n.length)return fe(t,n.slice(l+1),a,o,r);break}if(d.sceneProxy.isSetValues!==!1)break;o&&(o.paused=!0),d.sceneProxy.valueOperation(C,n[l].handle.values,!1,function(){if(l<n.length)return fe(t,n.slice(l+1),a,o,r)},r);break}if("pay"===n[l].type){var U=w.safeEval(n[l].handle.price,C);if(!(C.systemValues[0].value>=U)){u["default"].custom("Info","当前闪币余额不足，观看广告可获得更多闪币哟！","提示","立即获得","取消",!1).then(function(){var e=function(e){if(d.sceneProxy.playAdCallBack=null,d.sceneProxy.onResume(),"1"!==e&&1!==e||(C.systemValues[0].value+=1),d.sceneProxy.saveAccountInfo(),l<n.length)return fe(t,n.slice(l+1),a,o,!1,!0)};d.sceneProxy.onPause(),d.sceneProxy.playAdCallBack=e,o&&(o.paused=!0),window.app&&window.app.playAdVideo()},function(){});break}C.systemValues[0].value=C.systemValues[0].value-U,d.sceneProxy.saveAccountInfo()}else if("playad"===n[l].type){var W=function(e){if(d.sceneProxy.playAdCallBack=null,d.sceneProxy.onResume(),"1"!==e&&1!==e||(C.systemValues[0].value+=1),d.sceneProxy.saveAccountInfo(),l<n.length)return fe(t,n.slice(l+1),a,o,!1)};d.sceneProxy.onPause(),d.sceneProxy.playAdCallBack=W,o&&(o.paused=!0),window.app&&window.app.playAdVideo();break}}}return o&&o.paused&&l>=n.length&&o.callback(),!0},E=function(e,t){w.safeEval(t.expression,C)&&L(e,t.events,"onKeyUp")},M=function(e,t,n){var a=[],o=void 0;if(o=g.events,e.viewInfoName&&"g6Hsa9WoK8"===e.viewInfoName&&(o.length>0&&"g6Hsa9WoK8"!==o[0].name||0===o.length)&&o.unshift({events:[{type:"playad",handle:{uuid:"g6Hsa9WoK8"}}],expression:{type:"playad",value:"ad"},name:"g6Hsa9WoK8",type:"onClick"}),s){var r=Object.assign([],s);r.forEach(function(e){return e.events.forEach(function(e){return e.isParent=!0})}),o=r.concat(o)}var i=function(n){if(o[n].type===t&&"onKeyUp"!=o[n].type)a[a.length]=o[n];else if(o[n].type===t&&"onKeyUp"===o[n].type){var r=o[n].keyCode,i=d.sceneProxy.plotViewKeys&&d.sceneProxy.plotViewKeys[r]?d.sceneProxy.plotViewKeys[r]:d.sceneProxy.globalViewKeys&&d.sceneProxy.globalViewKeys[r]?d.sceneProxy.globalViewKeys[r]:void 0;i&&i.onUp.add(function(){return E(e,o[n])})}};for(var l in o)i(l);var c=!0,u=function h(n){for(var a=function(a){if("playad"===n[a].expression.type||"playad"!==n[a].expression.type&&w.safeEval(n[a].expression,C)){var o=function(){h(n.slice(a+1))},r={paused:!1,callback:o};if(!L(e,n[a].events,t,r))return c=!1,"break";if(r.paused)return"break"}},o=0;o<n.length;o++){var r=a(o);if("break"===r)break}};return u(a),n&&n(),c},T=function(e,t){e.isHanding||d.sceneProxy.isPaying||t&&t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button||(e.isHanding=!0,M(e,"onClick",function(){e.isHanding=!1}))},O=function(e){e.events.onInputDown.add(T,d,0,e)},A=function(e){return!!c||M(e,"onLoad")},V=function(e){M(e,"onKeyUp")};if("button"===g.type){var N=null;g.content.sound&&g.content.sound.url&&(N=this.viewComponent.game.add.sound(g.content.sound.url,g.content.sound.volume,!1));var j=this.viewComponent.addButton(_,S,g.width,g.height,g.content.background.normal.url,g.content.background.active.url,function(e,t){return T(e.parent,t)},null,N,null,x);V(j.parent),j.viewInfoName=g.name,x.viewType="BUTTON",x.onLoadBack={name:t,instanceUuid:n,object:j.parent,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:j.parent,callBack:A})}else if("image"===g.type){var B=this.viewComponent.game.add.image(_,S,g.content.background.url);B.width=g.width,B.height=g.height,x.add(B),B.viewInfoName=g.name,O(B),V(B),this.viewComponent.addGifAnimation(B,g.content.background.url),x.viewType="IMAGE",x.onLoadBack={name:t,instanceUuid:n,object:B,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:B,callBack:A})}else if("text"===g.type){var R=void 0,D={boundsAlignH:"left",boundsAlignV:"bottom",wordWrap:!0};R=g.content.font_size+"",R.indexOf("px")<0&&(R+="px"),g.content.bold===!0?R="bold "+R+" "+g.content.fontFamily:g.content.fontFamily?R=R+" "+g.content.fontFamily:this.sceneProxy.json_data.font&&(R=R+" "+this.sceneProxy.json_data.font.fontFamily),D.font=R,D.fill=g.content.color,D.wordWrapWidth=g.width;var F=this.viewComponent.game.add.text(_,S,"",D,x),U="";if(w.isArray(g.content.value)){if(g.content.value.forEach(function(e){return U+=w.parseValue(e.data,C)}),this.sceneProxy.addImageFontTextColors(g.content.value,F,C),v["default"].fontFamily){var W=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(g.content.font_size):g.content.font_size,G=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(g.content.font_size):g.content.font_size;this.sceneProxy.addImageFontText(g.content.value,G,W,F,C)}}else U=w.parseValue(g.content.value,C);F.inputEnabled=!0,F.input.useHandCursor=!0,F.useAdvancedWrap=!0,F.lineSpacing=this.sceneProxy.txtLineSpace(g.content.font_size),F.updateText=h["default"].updateText,F.advancedWordWrap=h["default"].advancedWordWrap,v["default"].fontFamily?(F.children.forEach(function(e){e.visible=!0}),F.text=" "):F.text=U,O(F),V(F),x.viewType="TEXT",x.onLoadBack={name:t,instanceUuid:n,object:F,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:F,callBack:A});var z=s?s:[],H=[].concat(r(g.events),r(z)).filter(function(e){return"onClick"===e.type});!H.length&&(F.inputEnabled=!1)}else if("bar"===g.type){var K=this.viewComponent.game.add.sprite(_,S,g.content.background.normal.url);K.width=g.width,K.height=g.height,x.add(K),O(K),this.viewComponent.addGifAnimation(K,g.content.background.normal.url);var q=this.viewComponent.game.add.sprite(_,S,g.content.background.progress.url);q.width=g.width,q.height=g.height,x.add(q),O(q),this.viewComponent.addGifAnimation(q,g.content.background.progress.url);var J=this.viewComponent.game.add.graphics(_,S);J.beginFill(16777215),J.drawRect(0,0,g.width,g.height),J.endFill(),x.add(J),q.mask=J,O(J),V(J);var $="",Y="";$=0===g.content.basePoint.x?"left":g.content.basePoint.x===g.width?"right":"middle",Y=0===g.content.basePoint.y?"top":g.content.basePoint.y===g.height?"bottom":"center";for(var Q=this.sceneProxy.prgsViews,X=0;X<Q.length&&(Q[X].uuid!==g.uuid||0!==Q[X].layer.children.length);X++);Q[X]={uuid:g.uuid,layer:x,type:$+"-"+Y,content:g.content},this.updateProgressView(),x.viewType="BAR",x.onLoadBack={name:t,instanceUuid:n,object:J,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:J,callBack:A})}else if("input"===g.type){var Z=w.safeEval(g.content.value,C),ee=new l.HtmlTextBox(this.viewComponent.game,_,S,g.width,g.height,Z,g.content.color,g.content.font_size,g.content.fontFamily?g.content.fontFamily:this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:"",g.content.bold?g.content.bold:null);"[未知数值]"===Z&&ee.setEnable(!1);var te=function(e){var t=e,n=g.content.value.arg1,a=function(e,t,n){for(var a="",o=0;o<t.length;o++)(t[o]>="0"&&t[o]<="9"||"."===t[o]&&0!==o)&&(a+=t[o]);var r=parseFloat(a);r=r?r:0,r<-99999999999999?r=-99999999999999:r>99999999999999&&(r=99999999999999),"value"===n?d.sceneProxy.context.values[e].value=r:"savedValue"===n&&(d.sceneProxy.context.savedValues[e].value=r),ee.isValue=!0,parseFloat(a)!==r&&0!==r?ee.text=r+"":a!==t&&(ee.text=a)},o=void 0;if((o=C.values.findIndex(function(e){return e.uuid===n}))!==-1)a(o,t,"value");else if((o=C.savedValues.findIndex(function(e){return e.uuid===n}))!==-1)a(o,t,"savedValue");else if((o=C.stringValues.findIndex(function(e){return e.uuid===n}))!==-1)C.stringValues[o].value=t;else if((o=C.indexValues.findIndex(function(e){return e.uuid===n}))!==-1){var r=(void 0===C.indexValues[o].value?w.safeInitValue(C.indexValues[o],C):C.indexValues[o].value)-1;"value"===C.indexValues[o].init.type?a(r,t,"value"):"savedValue"===C.indexValues[o].init.type?a(r,t,"savedValue"):"stringValue"===C.indexValues[o].init.type&&(C.stringValues[r].value=t)}};ee.setInputCallback(te),ee.setClickCallback(T),ee.mgrParent=x,x.inputElement=ee,V(ee),x.viewType="INPUT",x.onLoadBack={name:t,instanceUuid:n,object:ee,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ee,callBack:A})}else if("timer"===g.type){var ne=this.sceneProxy,ae=this.viewComponent.game.add.image(0,0,null);x.add(ae),x.currentCount=0;var oe=function(){if(ne.playPause){for(var e=0;e<ne.menuTimer.length;e++)if(ne.menuTimer[e]===x.name)return!1;return!0}for(var t=0;t<ne.menuTimer.length;t++)if(ne.menuTimer[t]===x.name)return!0;return!1},re=function me(){return function(){return oe()?void(x.timerHandler=setTimeout(me(),g.content.step.value)):void(x.currentCount++<g.content.count.value&&(M(ae,"onStep"),x.timerHandler=setTimeout(me(),g.content.step.value)))}},ie=function(){return function(){oe()||M(ae,"onStep")}};0===g.content.count.value?(x.timerHandler=setInterval(ie(),g.content.step.value),x.timerType="timeInterval"):(x.timerHandler=setTimeout(re(),g.content.step.value),x.timerType="timeOut");for(var se=0;se<this.sceneProxy.timerCounts.length;se++){var le=this.sceneProxy.timerCounts[se];if(x.name===le.name&&le.parent===e.name){x.currentCount=le.currentCount,this.sceneProxy.timerCounts.splice(se,1);break}}this.sceneProxy.mainMenuLayer.visible&&(this.sceneProxy.menuTimer[this.sceneProxy.menuTimer.length]=t),x.viewType="TIMER",x.onLoadBack={name:t,instanceUuid:n,object:ae,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ae,callBack:A})}else if("container"===g.type){var ce=null;g.content.background.url?(ce=this.viewComponent.game.add.image(_,S,g.content.background.url),ce.width=g.width,ce.height=g.height):(ce=this.viewComponent.game.add.graphics(0,0),ce.beginFill(0,1),ce.drawRect(_,S,g.width,g.height),ce.endFill(),ce.alpha=0),x.add(ce),O(ce),V(ce),x.viewType="CONTAINER",x.onLoadBack={name:t,instanceUuid:n,object:ce,callBack:A},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ce,callBack:A});var ue=function(e){var t=d.addView(x,g.children[e].ref,g.children[e].instanceUuid,g.children[e].x,g.children[e].y,g.children[e].events,c,f,m),n=function(){t.x+=_,t.y+=S,g.children[e].scale&&(t.scale.set(g.children[e].scale,g.children[e].scale),t.x+=w.safeEval(g.children[e].x,C)*(1-g.children[e].scale),t.y+=w.safeEval(g.children[e].y,C)*(1-g.children[e].scale)),t.inputElement&&(t.inputElement.x+=_,t.inputElement.y+=S,g.children[e].scale?(t.inputElement.fontSize*=g.children[e].scale,t.inputElement.width*=g.children[e].scale,t.inputElement.height=t.inputElement.fontSize):t.inputElement.update())};return t?void n():{v:!1}};for(var de in g.children){var he=ue(de);if("object"===("undefined"==typeof he?"undefined":i(he)))return he.v}}return p?x:p},uiOnLoadInvoker:function(){for(;0<this.sceneProxy.uiOnLoadQueue.length;){var e=this.sceneProxy.uiOnLoadQueue[0];this.sceneProxy.uiOnLoadQueue.splice(0,1),e.callBack(e.object)}},updateProgressView:function(){for(var e=this,t=function(t){var n=e.sceneProxy.prgsViews[t];if(!n.layer.children.length)return"continue";var a=n.layer.children[0],o=n.layer.children[1],r=n.layer.children[2],i=e.sceneProxy.Expression.safeEval(n.content.value.normal.width,e.sceneProxy.context),s=e.sceneProxy.Expression.safeEval(n.content.value.normal.height,e.sceneProxy.context),l=e.sceneProxy.Expression.safeEval(n.content.value.progress.width,e.sceneProxy.context),c=e.sceneProxy.Expression.safeEval(n.content.value.progress.height,e.sceneProxy.context),u=function(t,a,r,i,s){t.isMask?(t.destroy(),t=e.viewComponent.game.add.graphics(a,r),t.beginFill(16777215),t.drawRect(0,0,i,s),t.endFill(),t.inputEnabled=!1,n.layer.add(t),o.mask=t):(t.x=a,t.y=r,t.width=i,t.height=s)},d="clip"===n.content.style?r:o,h=Math.min(0===i?0:l*a.width/i,a.width),f=Math.min(0===s?0:c*a.height/s,a.height);switch(n.type){case"left-top":u(d,a.x,a.y,h,f);break;case"middle-top":u(d,a.x+(a.width-h)/2,a.y,h,f);break;case"right-top":u(d,a.x+a.width-h,a.y,h,f);break;case"left-center":u(d,a.x,a.y+(a.height-f)/2,h,f);break;case"middle-center":u(d,a.x+(a.width-h)/2,a.y+(a.height-f)/2,h,f);break;case"right-center":u(d,a.x+a.width-h,a.y+(a.height-f)/2,h,f);break;case"left-bottom":u(d,a.x,a.y+a.height-f,h,f);break;case"middle-bottom":u(d,a.x+(a.width-h)/2,a.y+a.height-f,h,f);break;case"right-bottom":u(d,a.x+a.width-h,a.y+a.height-f,h,f)}},n=0;n<this.sceneProxy.prgsViews.length;n++){t(n)}},destroyView:function(e,t){var n=this,a=function o(e,a){if(e.name&&e.name===a||e.instanceUuid&&e.instanceUuid===a)return n.removeViewKeyByInstance(e,n.sceneProxy.plotViewKeys),n.sceneProxy.removeInputView(e),n.sceneProxy.removeViewTimer(e),e.destroy(),e.isMenu&&t&&(n.sceneProxy.onMainMenuBackBtnClicked(),n.sceneProxy.mainMenuLayer.removeAll(!0,!1,!0)),!0;if(e.children&&e.children.length>0)for(var r=0;r<e.children.length;r++)o(e.children[r],a)&&r--;return!1};a(this.viewComponent.game.world,e)},showInputView:function(e,t){if(e.inputElement)e.inputElement.show(t);else if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)this.showInputView(e.children[n],t)},scaleInputView:function(e,t){if(e.inputElement)e.inputElement.fontSize*=t,e.inputElement.width*=t,e.inputElement.height=e.inputElement.fontSize+6,e.inputElement.update();else if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)this.scaleInputView(e.children[n],t)},refreshView:function(e,t){var n=this,a=function c(e,t){var n=[];return e.name&&e.name===t?n.push(e):n=e.children.reduce(function(e,n){return e.concat(c(n,t))},[]),n},o=[],r=a(this.viewComponent.game.world,e);if(t){if(r.length>0){var i=this.sceneProxy.json_data.viewMap,s=i[e].events;for(var l in s)"onKeyUp"===s[l].type&&this.sceneProxy.plotViewKeys[s[l].keyCode].onUp.removeAll()}r.forEach(function(a){var r=a.xInfo,i=a.yInfo,s=a.scale,l=a.isGlobal,c=a.children,u=a.instanceUuid;for(var d in a.eventsInfo)"onKeyUp"===a.eventsInfo[d].type&&n.sceneProxy.plotViewKeys[a.eventsInfo[d].keyCode].onUp.removeAll();var h=n.addView(a.parent,e,u,r,i,a.eventsInfo,!t);if(h){n.viewComponent.game.world.add(h);for(var f=0;f<c.length;f++){var m=!1;for(var p in h.children)if(h.children[p].name===c[f].name){m=!0;break}m||t||(h.addChild(c[f]),f-=1)}if("CONTAINER"===a.parent.viewType&&(h.x+=n.sceneProxy.Expression.safeEval(a.parent.xInfo,n.sceneProxy.context),h.y+=n.sceneProxy.Expression.safeEval(a.parent.yInfo,n.sceneProxy.context)),s&&(h.scale.set(s.x,s.y),h.x+=n.sceneProxy.Expression.safeEval(r,n.sceneProxy.context)*(1-s.x),h.y+=n.sceneProxy.Expression.safeEval(i,n.sceneProxy.context)*(1-s.y),n.scaleInputView(h,s.x)),l){h.isGlobal=!0;var y=n.sceneProxy.globalViews.findIndex(function(t){return t.name===e});n.sceneProxy.globalViews.splice(y,1,h)}if(a.isMenu&&(h.isMenu=!0),a.parent&&"plotViewsLayer"===a.parent.name){var g=n.sceneProxy.plotViews.indexOf(a);n.sceneProxy.plotViews.splice(g,1,h)}n.sceneProxy.removeViewTimer(a),a.parent.replace(a,h).destroy(),o.push(h)}})}else r.forEach(function(e){var t={sx:0,sy:0},a=function r(e,a){o.push(e);var i={sx:0,sy:0},s=function(e){var t={sx:0,sy:0};return e.scale&&e.xInfo&&e.yInfo&&(t.sx=n.sceneProxy.Expression.safeEval(e.xInfo,n.sceneProxy.context)*(1-e.scale.x),t.sy=n.sceneProxy.Expression.safeEval(e.yInfo,n.sceneProxy.context)*(1-e.scale.y)),t};a&&(t=s(e));var l=n.sceneProxy.json_data.viewMap[e.parent.name];if(e.parent){var c=0,u=0;if(e.parent.xInfo&&e.parent.yInfo?(c=n.sceneProxy.Expression.safeEval(e.parent.xInfo,n.sceneProxy.context),u=n.sceneProxy.Expression.safeEval(e.parent.yInfo,n.sceneProxy.context),"CONTAINER"!==e.parent.viewType||a||(i=s(e),c+=i.sx,u+=i.sy),e.x=c,e.y=u):a&&(e.x=t.sx,e.y=t.sy),"BAR"===e.parent.viewType){var d="",h="";d=0===l.content.basePoint.x?"left":l.content.basePoint.x===l.width?"right":"middle",h=0===l.content.basePoint.y?"top":l.content.basePoint.y===l.height?"bottom":"center";var f=d+"-"+h,m=e.parent.children[0],p=e.parent.children[1],y=e.parent.children[2],g=e.parent,x=n.sceneProxy.Expression.safeEval(l.content.value.normal.width,n.sceneProxy.context),P=n.sceneProxy.Expression.safeEval(l.content.value.normal.height,n.sceneProxy.context),w=n.sceneProxy.Expression.safeEval(l.content.value.progress.width,n.sceneProxy.context),k=n.sceneProxy.Expression.safeEval(l.content.value.progress.height,n.sceneProxy.context),b=function(e,t,a,o,r){e.isMask?(e.destroy(),e=n.viewComponent.game.add.graphics(t,a),e.beginFill(16777215),e.drawRect(0,0,o,r),e.endFill(),e.inputEnabled=!1,g.add(e),p.mask=e):(e.x=t,e.y=a,e.width=o,e.height=r)},C="clip"===l.content.style?y:p;if(!C)return;var _=Math.min(w*m.width/x,m.width),S=Math.min(k*m.height/P,m.height);switch(f){case"left-top":b(C,m.x,m.y,_,S);break;case"middle-top":b(C,m.x+(m.width-_)/2,m.y,_,S);break;case"right-top":b(C,m.x+m.width-_,m.y,_,S);break;case"left-center":b(C,m.x,m.y+(m.height-S)/2,_,S);break;case"middle-center":b(C,m.x+(m.width-_)/2,m.y+(m.height-S)/2,_,S);break;case"right-center":b(C,m.x+m.width-_,m.y+(m.height-S)/2,_,S);break;case"left-bottom":b(C,m.x,m.y+m.height-S,_,S);break;case"middle-bottom":b(C,m.x+(m.width-_)/2,m.y+m.height-S,_,S);break;case"right-bottom":b(C,m.x+m.width-_,m.y+m.height-S,_,S)}}else if("INPUT"===e.parent.viewType){var I=n.sceneProxy.Expression.safeEval(l.content.value,n.sceneProxy.context);e.parent.inputElement.text=I}else if("TEXT"===e.parent.viewType){var L=e.parent.children[0],E="";if(n.sceneProxy.Expression.isArray(l.content.value)){if(l.content.value.forEach(function(e){return E+=n.sceneProxy.Expression.parseValue(e.data,n.sceneProxy.context)}),n.sceneProxy.addImageFontTextColors(l.content.value,L,n.sceneProxy.context),v["default"].fontFamily){var M=n.sceneProxy.json_data.font.size?n.sceneProxy.toRealImageFontHeight(l.content.font_size):l.content.font_size,T=n.sceneProxy.json_data.font.size?n.sceneProxy.toRealImageFontWidth(l.content.font_size):l.content.font_size;n.sceneProxy.addImageFontText(l.content.value,T,M,L,n.sceneProxy.context)}}else E=n.sceneProxy.Expression.parseValue(l.content.value,n.sceneProxy.context);v["default"].fontFamily?(L.children.forEach(function(e){e.visible=!0}),L.text=" "):L.text=E}}if(e.children&&e.children.length>0)for(var O=0;O<e.children.length;O++)r(e.children[O],!1)};a(e,!0)});return o},backgroundFlex:function(e,t){if(3===t){var n=e.width/e.height<this.viewComponent.game.world.width/this.viewComponent.game.world.height?this.viewComponent.game.world.width/e.width:this.viewComponent.game.world.height/e.height;e.width*=n,e.height*=n,e.x=-(e.width-this.viewComponent.game.world.width)/2,e.y=-(e.height-this.viewComponent.game.world.height)/2}else if(5===t){var a=0;e.width/e.height>this.viewComponent.game.world.width/this.viewComponent.game.world.height?(a=this.viewComponent.game.world.width/e.width,e.width*=a,e.height*=a,e.y=(this.viewComponent.game.world.height-e.height)/2):(a=this.viewComponent.game.world.height/e.height,e.width*=a,e.height*=a,e.x=(this.viewComponent.game.world.width-e.width)/2)}else e.width=this.viewComponent.game.world.width,e.height=this.viewComponent.game.world.height},tweenToPromise:function(e,t,n,a,o,r,i,s){var l=this;return n=Math.max(n,1),new Promise(function(c,u){var d=l.viewComponent.game.add.tween(e).to(t,n,a,o,r,i,s);d.onComplete.add(function(){return c()}),l.sceneProxy.lstPlotTweens.push(d),!e.animateTweens&&(e.animateTweens=[]),e.animateTweens.push(d)})},tweenFromPromise:function(e,t,n,a,o,r,i,s){var l=this;return n=Math.max(n,1),new Promise(function(c,u){var d=l.viewComponent.game.add.tween(e).from(t,n,a,o,r,i,s);d.onComplete.add(function(){return c()}),l.sceneProxy.lstPlotTweens.push(d),!e.animateTweens&&(e.animateTweens=[]),e.animateTweens.push(d)})},showPlot:function(e,t,n,a,o){var s=this,l=this.sceneProxy.Expression,c=t.plots[n],d=null,h=null,p=null,g=!1;this.sceneProxy.isQuickPlay!==!0&&appCanBack(flashvars.client,flashvars.app_version,!1,"1"===flashvars.offline),this.sceneProxy.isQuickPlay=!0,!this.sceneProxy.isGameStarted&&t.isFirst&&0===n&&this.sceneProxy.notifyGameStarted();var x=function X(e,a,o){var r=e,i=s.sceneProxy,l={x:i.dialogLayer.x-r,y:i.dialogLayer.y-r},u=[];if(i.curPlotLayer.isShaking=!0,c.speaking&&"bottom"===c.speaking.coverage&&(i.dialogLayer.snakename="shake",u.push(s.tweenToPromise(i.dialogLayer,l,40,null,!0,o,0,!0))),i.charsAndPropsLayer&&i.charsAndPropsLayer.visible){var d=i.charsAndPropsLayer.x,h=i.charsAndPropsLayer.y;i.charsAndPropsLayer.snakename="shake",u.push(s.tweenToPromise(i.charsAndPropsLayer,{x:i.charsAndPropsLayer.x-r,y:i.charsAndPropsLayer.y-r},40,null,!0,o,0,!0).then(function(){i.charsAndPropsLayer.x=d,i.charsAndPropsLayer.y=h}))}return i.curPlotLayer.snakename="shake",u.push(s.tweenToPromise(i.curPlotLayer,{x:-r,y:-r},40,null,!0,o,0,!0).then(function(){return i.curPlotLayer.x=0,i.curPlotLayer.y=0,0===s.sceneProxy.shakeLoopObj.duration?(i.curPlotLayer.isShaking=!1,Promise.resolve()):0<a&&!i.quickPlay&&t===i.curChapter&&n===i.curPlotIndex?X(r,a-100,0):(i.curPlotLayer.isShaking=!1,Promise.resolve())})),Promise.all(u)},P=function(){s.sceneProxy.curPlotLayer&&(s.sceneProxy.curPlotLayer.isShaking=!1),s.sceneProxy.shakeLoopObj.loop=!1,s.sceneProxy.shakeLoopObj.duration=0;for(var e=0;e<s.sceneProxy.lstPlotTweens.length;e++){var t=s.sceneProxy.lstPlotTweens[e];t.target&&"shake"===t.target.snakename&&(t.pause(),t.stop(!0))}},w=function(e,t,n){return s.sceneProxy.twinkleTimer=m["default"].timeout(t||0),s.sceneProxy.twinkleTimer.then(function(){var t=s.viewComponent.game.add.graphics(0,0);return t.beginFill(m["default"].fixColorValue(n).replace("#","0x")),t.moveTo(0,0),t.lineTo(s.viewComponent.game.world.width,0),t.lineTo(s.viewComponent.game.world.width,s.viewComponent.game.world.height),t.lineTo(0,s.viewComponent.game.world.height),t.lineTo(0,0),t.endFill(),t.name="twinkle",s.sceneProxy.twinkleTimer=null,s.tweenToPromise(t,{alpha:0},e,null,!0,0).then(function(){return t.destroy()})})},k=function(e,t){return d?s.tweenFromPromise(d,{alpha:0},e,null,!0,t):Promise.resolve()},b=function(e,t){var n=s.viewComponent.game.world.getByName("curtainscreen1"),a=s.viewComponent.game.world.getByName("curtainscreen2");n||(n=s.viewComponent.game.add.graphics(0,0),n.beginFill(0),n.drawRect(0,0,s.viewComponent.game.width/2,s.viewComponent.game.height),n.endFill(),n.name="curtainscreen1"),a||(a=s.viewComponent.game.add.graphics(0,0),a.beginFill(0),a.drawRect(0,0,s.viewComponent.game.width/2,s.viewComponent.game.height),a.endFill(),a.name="curtainscreen2"),n.x=0,a.x=s.viewComponent.game.width/2,s.viewComponent.game.world.bringToTop(n),s.viewComponent.game.world.bringToTop(a),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var o=[];return o.push(s.tweenToPromise(n,{x:-(s.viewComponent.game.width/2)},e,null,!0,t)),o.push(s.tweenToPromise(a,{x:s.viewComponent.game.width},e,null,!0,t)),Promise.all(o)},C=function(e,t){var n=s.viewComponent.game.world.getByName("interlacingscreen1"),a=s.viewComponent.game.world.getByName("interlacingscreen2"),o=function(e){var t=s.viewComponent.game.add.graphics(0,0);t.beginFill(0,0),t.drawRect(0,0,s.viewComponent.game.width,s.viewComponent.game.height),t.endFill();var n=s.viewComponent.game.height/6,a=function(e,t){var a=s.viewComponent.game.add.graphics(0,0);return a.beginFill(0),a.drawRect(0,0,s.viewComponent.game.width,n),a.endFill(),a.x=e,a.y=t,a};return t.addChild(a(0,n*(1===e?0:1))),t.addChild(a(0,n*(1===e?2:3))),t.addChild(a(0,n*(1===e?4:5))),t.name="interlacingscreen"+e,t};n||(n=o(1)),a||(a=o(2)),n.x=0,a.x=0,s.viewComponent.game.world.bringToTop(n),s.viewComponent.game.world.bringToTop(a),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var r=[];return r.push(s.tweenToPromise(n,{x:-s.viewComponent.game.width},e,null,!0,t)),r.push(s.tweenToPromise(a,{x:s.viewComponent.game.width},e,null,!0,t)),Promise.all(r)},_=function(e,t){var n=s.viewComponent.game.world.getByName("coverblackscreen");n||(n=s.viewComponent.game.add.graphics(0,0),n.beginFill(0),n.drawRect(0,0,s.viewComponent.game.width,s.viewComponent.game.height),n.endFill(),n.name="coverblackscreen"),n.x=-s.viewComponent.game.width;var a=0,o=0;d&&(a=d.x,o=d.y),s.sceneProxy.prePlotBkKey&&s.viewComponent.game.load.cache.checkImageKey(s.sceneProxy.prePlotBkKey)&&d&&(d=s.sceneProxy.curPlotLayer.create(d.x,d.y,s.sceneProxy.prePlotBkKey),d.alpha=void 0===s.sceneProxy.lstPlotBkOpacity?1:s.sceneProxy.lstPlotBkOpacity,s.backgroundFlex(d,s.sceneProxy.lstPlotBkFlex),s.viewComponent.addGifAnimation(d,s.sceneProxy.lstPlotBkKey)),s.viewComponent.game.world.bringToTop(n),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var r=[];return r.push(s.tweenToPromise(n,{x:0},e/2,null,!0,t).then(function(){d=s.sceneProxy.curPlotLayer.create(a,o,s.sceneProxy.lstPlotBkKey),d.alpha=void 0===s.sceneProxy.lstPlotBkOpacity?1:s.sceneProxy.lstPlotBkOpacity,s.backgroundFlex(d,s.sceneProxy.lstPlotBkFlex),s.viewComponent.addGifAnimation(d,s.sceneProxy.lstPlotBkKey),s.tweenToPromise(n,{x:s.viewComponent.game.width},e/2,null,!0,t)})),Promise.all(r)},S=function(e,t){var n=s.sceneProxy,a=[],o=!1,r=s.viewComponent.game.world.getChildIndex(n.curPlotLayer),i=s.viewComponent.game.world.getChildIndex(n.charsAndPropsLayer),l=s.viewComponent.game.world.getChildIndex(n.dialogLayer);s.sceneProxy.weatherLayer.visible&&(s.sceneProxy.weatherLayer.visible=!1,o=!0);var c=s.viewComponent.game.add.group();n.curPlotLayer.snakename="spread",c.add(n.curPlotLayer),n.charsAndPropsLayer&&n.charsAndPropsLayer.visible?(n.charsAndPropsLayer.visible=!0,c.add(n.charsAndPropsLayer)):i=-1,c.add(n.dialogLayer),s.sceneProxy.curPlotLayer.isSpreading=!0;var u=s.viewComponent.game.add.graphics(0,0);u.beginFill(0),u.drawRect(0,0,s.viewComponent.game.world.width,s.viewComponent.game.world.height),u.endFill(),c.add(u),c.mask=u;var d=c.x,h=c.y,f=c.width,m=c.height;return c.x=s.viewComponent.game.world.centerX,c.y=s.viewComponent.game.world.centerY,c.width=0,c.height=0,s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer),a.push(s.tweenToPromise(c,{x:d,y:h,width:f,height:m},e,null,!0,t,0,!1).then(function(){c.x=d,c.y=h,u&&u.destroy(),r!==-1&&s.viewComponent.game.world.addChildAt(n.curPlotLayer,r),i!==-1&&s.viewComponent.game.world.addChildAt(n.charsAndPropsLayer,i),l!==-1&&s.viewComponent.game.world.addChildAt(n.dialogLayer,l),o&&(s.sceneProxy.weatherLayer.visible=!0),c.destroy(),s.sceneProxy.curPlotLayer.isSpreading=!1})),Promise.all(a)},I=function(t){var n=[];return t.forEach(function(t){var a=s.sceneProxy.quickPlay?0:t.delay,o=s.sceneProxy.quickPlay?100:t.duration;"twinkle"===t.type&&n.push(w(o,a,t.color)),"shake"===t.type&&o&&n.push(x(t.level?5*t.level:18,o,a)),"fadein"===t.type&&n.push(k(o,a).then(function(){return s.sceneProxy.doInCT(e,function(){s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=null,s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer})})),"curtain"===t.type&&n.push(b(o,a)),"interlacing"===t.type&&n.push(C(o,a)),"coverblack"===t.type&&n.push(_(o,a)),"spread"===t.type&&n.push(S(o,a))}),Promise.all(n)},L=function(t){var n=s.sceneProxy.dialogLayer;s.addDialogLayer();var a=s.sceneProxy.json_data.template.json.dialog,o=a.avatarContainer,r=a.titleContainer,i=a.content,c=n.getByName("dialog_bk"),u=n.getByName("dialog_bk_avatar"),d=n.getByName("dialog_avatar"),f=n.getByName("dialog_bk_title");if(h=n.getByName("dialog_text_title"),p=n.getByName("dialog_text_content"),c&&(c.visible=!t.speaking.hidden),u&&(u.visible=!t.avatar.hidden),f&&(f.visible=!t.dialogtitle.hidden),d.visible=!t.avatar.hidden,h.visible=!t.dialogtitle.hidden,s.sceneProxy.dialogLayer.x=t.speaking.x,s.sceneProxy.dialogLayer.y=t.speaking.y,s.sceneProxy.dialogLayer.alpha=void 0===t.speaking.opacity?1:t.speaking.opacity,s.viewComponent.game.load.cache.checkImageKey(t.avatar.url)){var m=o.avatar,y=m.x,g=m.y,x=m.width,P=m.height,w=m.clip;y+=o.rect.x,g+=o.rect.y,d.loadTexture(t.avatar.url);var k=Math.min(x*d.scale.x/d.width,P*d.scale.y/d.height);x=d.width/d.scale.x*k,P=d.height/d.scale.y*k,y=o.avatar.x+o.rect.x+(o.avatar.width-x)/2,g=o.avatar.y+o.rect.y+(o.avatar.height-P)/2,d.x=y,d.y=g,d.width=x,d.height=P,d.mask&&d.mask.destroy();var b=s.viewComponent.game.add.graphics(0,0);switch(b.beginFill(),w){case"square":b.drawRect(y,g,x,P);break;case"hexagon":var C=new Phaser.Polygon;C.setTo([new Phaser.Point(x/2+y,g),new Phaser.Point(x/2+P/4*Math.pow(3,.5)+y,P/4+g),new Phaser.Point(x/2+P/4*Math.pow(3,.5)+y,P/4*3+g),new Phaser.Point(x/2+y,P+g),new Phaser.Point(x/2-P/4*Math.pow(3,.5)+y,P/4*3+g),new Phaser.Point(x/2-P/4*Math.pow(3,.5)+y,P/4+g)]),b.drawPolygon(C.points);break;case"heart":b.moveTo(x/2+y,x/4+g),b.bezierCurveTo(3*x/4+y,-x/4+g,3*x/2+y,x/4+g,x/2+y,x+g),b.bezierCurveTo(-x/2+y,x/4+g,x/4+y,-x/4+g,x/2+y,x/4+g);break;case"round":default:b.drawCircle(y+x/2,g+P/2,x)}b.endFill(),s.sceneProxy.dialogLayer.add(b),d.mask=b}var _=t.dialogtitle,S=_.font_size,I=_.color,L=_.bold,E=_.fontFamily,M=_.hidden,T=r.title.text;S&&(T.fontSize=S),I&&(T.color=I),void 0!==L&&(T.fontWeight=L?"bold":"normal"),E?T.fontFamily=E:s.sceneProxy.json_data.font?T.fontFamily=s.sceneProxy.json_data.font.fontFamily:"",void 0!==M&&(T.hidden=M);var O="";if(v["default"].fontFamily){var A=h.children[0],V=l.parseValue(t.dialogtitle.data,e);("#ffffff"===I||"#fff"===I)&&(T.color="#fefefe"),A&&(A.fontImg.destroy(),A.destroy()),A=s.sceneProxy.addRetroText(),h.addChild(A),A.fontImg.setText(V?V:" ",!0,0,0,"left",!0),A.tint=parseInt(T.color.replace("#","0x"));var N=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(T.fontSize):T.fontSize,j=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(T.fontSize):T.fontSize;A.width=j*A.fontImg.text.length,A.height=N;var B=r.rect.x+r.title.rect.x+(r.title.rect.width-A.width)/2,R=r.rect.y+r.title.rect.y;h.setTextBounds(B,R,r.title.rect.width,r.title.rect.height),h.text=" "}else{O+=T.fontWeight?T.fontWeight+" ":"normal ",
O+=T.fontSize?parseInt(T.fontSize)+"px ":"",O+=T.fontFamily?T.fontFamily:"",h.setStyle({font:O,fill:T.color,boundsAlignH:"center",boundsAlignV:"middle"}),h.text=l.parseValue(t.dialogtitle.data,e);var D=r.rect.x+r.title.rect.x,F=r.rect.y+r.title.rect.y;h.setTextBounds(D,F+(h.height-parseInt(T.fontSize||12))/2,r.title.rect.width,r.title.rect.height)}O=t.speaking.font_size+"",O.indexOf("px")<0&&(O+="px"),t.speaking.bold===!0&&(O="bold "+O),O=O+" "+(s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:t.speaking.fontFamily?t.speaking.fontFamily:""),p.style.font=O,p.style.fill=t.speaking.color,p.text="",p.top=i.rect.y,p.lineSpacing=s.sceneProxy.txtLineSpace(t.speaking.font_size),p.mask&&p.mask.destroy();var U=s.viewComponent.game.add.graphics(0,0);return U.beginFill(),U.drawRect(i.rect.x,i.rect.y,i.rect.width,t.speaking.hidden?s.viewComponent.game.world.height:i.rect.height),U.endFill(),s.sceneProxy.dialogLayer.add(U),p.mask=U,t&&t.speaking&&t.speaking.animations&&t.speaking.animations.length>0&&(s.sceneProxy.dialogLayer.visible=!1),Promise.resolve()},E=function(){var e=c.plot_sound;if(o&&(e=o.sounds),"[object Array]"===Object.prototype.toString.call(e))for(var t in e)e[t]?"inherit"===e[t].url?s.sceneProxy.playInheritSound(t,e[t].volume):(s.viewComponent.game.load.cache.checkSoundKey(e[t].url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&(s.sceneProxy.stopSound(t,e[t].url,!0),s.sceneProxy.playSound(t,e[t].url,e[t].volume,0===e[t].time)):s.sceneProxy.stopSound(t);else(s.viewComponent.game.load.cache.checkSoundKey(c.plot_sound.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&s.sceneProxy.playSound(0,c.plot_sound.url,c.plot_sound.volume,!1)},M=function(e){if(e.url&&""!==e.url){if("inherit"===e.url)s.sceneProxy.playInheritMusic(e.volume);else if(s.viewComponent.game.load.cache.checkSoundKey(e.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var t=e.volume;void 0!==e.inheritvolume&&e.inheritvolume!==-1&&(t=e.inheritvolume),s.sceneProxy.stopMusic(e.url,!0),s.sceneProxy.playMusic(e.url,t,1!==e.time,!1)}}else s.sceneProxy.stopMusic()},T=function(e){if(d=s.viewComponent.game.add.graphics(0,0,e),d.beginFill(0,1),d.drawRect(0,0,s.viewComponent.game.world.width,s.viewComponent.game.world.height),d.endFill(),!c.commands){s.sceneProxy.lstGameBk&&s.sceneProxy.lstGameBk.visible&&!c.animations.filter(function(e){return"fadein"===e.type}).length&&(s.sceneProxy.lstGameBk.visible=!1);var t="inherit"===c.background.url,n=t?s.sceneProxy.lstPlotBkOpacity:c.background.opacity,a=t?s.sceneProxy.lstPlotBkFlex:c.background.flex,o=t?s.sceneProxy.lstPlotBkKey:c.background.url;!t&&f.ResourcesManager.updateUsingKey({type:"background",key:o}),o&&(s.sceneProxy.prePlotBkKey=s.sceneProxy.lstPlotBkKey,s.sceneProxy.lstPlotBkKey=o,s.sceneProxy.lstPlotBkOpacity=n,s.sceneProxy.lstPlotBkFlex=a),s.viewComponent.game.load.cache.checkImageKey(o)&&(d.alpha=0,d=e.create(c.background.x,c.background.y,o),d.alpha=void 0===n?1:n,s.backgroundFlex(d,a),s.viewComponent.addGifAnimation(d,o))}},O=function(e,t,n){for(var a=[].concat(r(e),r(t)),o=0;o<a.length;o++){var i=a[o],l=s.viewComponent.addFitImageSprint(i.x,i.y,i.width,i.height,i.url,s.sceneProxy.charsAndPropsLayer,i.index);l.alpha=void 0===i.opacity?1:i.opacity,l.angle=180===parseInt(i.rotate)?179.9:i.rotate||0,l.data.animations=i.animations,l.cmdUuid=n,s.viewComponent.addGifAnimation(l,i.url),i.mirrorH&&(l.angle=-l.angle,l.scale.x=-l.scale.x,l.mirrorH=!0),i.mirrorV&&(l.angle=-l.angle,l.scale.y=-l.scale.y,l.mirrorV=!0)}s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.sceneProxy.dialogLayer.visible&&!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),s.sceneProxy.weatherLayer.visible&&s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer),s.sceneProxy.menuLayer.visible!==!1&&s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer)},A=function(){var e=[],t=!0,n=!1,a=void 0;try{for(var o,r=s.sceneProxy.charsAndPropsLayer.children[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var i=o.value,l=!0,c=!1,u=void 0;try{for(var d,h=i.data.animations[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var f=d.value;if(("in"===f.trigger||"animateIn"===f.trigger)&&!s.sceneProxy.quickPlay)if("fadein"===f.type)e.push(s.tweenFromPromise(i,{alpha:0},f.duration,null,!0,f.delay,0,!1));else if("moveFrom"===f.type){var m=i.mirrorH?f.x-i.width/2:f.x+i.width/2,p=i.mirrorV?f.y-i.height/2:f.y+i.height/2;e.push(s.tweenFromPromise(i,{x:m,y:p},f.duration,null,!0,f.delay,0,!1))}}}catch(y){c=!0,u=y}finally{try{!l&&h["return"]&&h["return"]()}finally{if(c)throw u}}}}catch(y){n=!0,a=y}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw a}}return Promise.all(e)},V=function(a,o){var r=!1;return new Promise(function(i,u){if(c.jump||c.back||c.insert)return i({type:0});var d=(o||[]).findIndex(function(t){return l.safeEval(t.expression,e)}),h=d<0?null:o[d];if(h)return i({type:2,index:d});for(var f=[],p=[],y=function(o){var c=s.sceneProxy.json_data.template.json.option,u=c.rect,d=c.normal,h=c.active,y=u.x,g=u.y,x=u.width,P=u.height,w=d.background.url,k=h.background.url,b=null,C=a[o],_=C.font,S=C.timer,I=C.disable;void 0!==a[o].x&&(y=a[o].x),void 0!==a[o].y&&(g=a[o].y),void 0!==a[o].width&&a[o].hasOwnProperty("background")&&(x=a[o].width),void 0!==a[o].height&&a[o].hasOwnProperty("background")&&(P=a[o].height),a[o].background&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.normal.url)&&(w=a[o].background.normal.url),a[o].background&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.active.url)&&(k=a[o].background.active.url),a[o].background&&a[o].background.disable&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.disable.url)&&(b=a[o].background.disable.url);var L=function(e,t){var n=!0,r=!1,l=void 0;try{for(var c,u=f[Symbol.iterator]();!(n=(c=u.next()).done);n=!0){var d=c.value;d.close()}}catch(h){r=!0,l=h}finally{try{!n&&u["return"]&&u["return"]()}finally{if(r)throw l}}t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button||(e.chapter.plots.length>0?(i({type:1,index:o}),s.sceneProxy.optionLayer.destroy()):(i({type:3}),s.sceneProxy.optionLayer.destroy()),m["default"].selOptions.push(a[o].uuid))},E={fontFamily:_.normal.fontFamily?_.normal.fontFamily:s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:"",fontSize:_.normal.font_size,fontWeight:_.normal.bold?"bold":"normal",color:_.normal.color,hidden:_.normal.hidden},M={fontFamily:_.disable.fontFamily?_.disable.fontFamily:s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:"",fontSize:_.disable.font_size,fontWeight:_.disable.bold?"bold":"normal",color:_.disable.color,hidden:_.disable.hidden},T={};T.normal=E,T.active=E,T.text=a[o].name;var O=void 0;a[o].sound&&s.viewComponent.game.load.cache.checkSoundKey(a[o].sound.url)&&(O=s.viewComponent.game.add.sound(a[o].sound.url,a[o].sound.volume,!1));var A=s.viewComponent.addButton(y,g,x,P,w,k,L,T,O,"option",s.sceneProxy.optionLayer),V=A.getByName("button"),N=A.getByName("text");if(V.chapter={plots:a[o].plots?a[o].plots:a[o].commands,parent:{pChapter:t,pnPlot:n}},I&&(V.inputEnabled=!1,A.changeBackground(b||w,M)),S){s.sceneProxy.hasCountDown=!0;var j=function(){return new Promise(function(t,n){var r=l.getGameValueByTimer(S,e);if(!a[o].hideTimer&&(N.text=a[o].name+("("+r+")"),v["default"].fontFamily)){var i=N.children[0];if(i){var c=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(E.fontSize):E.fontSize,u=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(E.fontSize):E.fontSize,d=u*N.text.length,h=(x-d)/2,m=(P-c)/2;s.sceneProxy.addImageFontText([{data:N.text}],u,c,N,e),N.children[0].x=h,N.children[0].y=m,i.children.forEach(function(e){return e.fontImg.destroy()}),i.destroy(),N.text=" "}}var p=s.viewComponent.game.time.events.loop(Phaser.Timer.SECOND,function(){if(r--,!a[o].hideTimer&&(N.text=a[o].name+("("+r+")"),v["default"].fontFamily)){var n=N.children[0];if(n){var i=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(E.fontSize):E.fontSize,l=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(E.fontSize):E.fontSize,c=l*N.text.length,u=(x-c)/2,d=(P-i)/2;s.sceneProxy.addImageFontText([{data:N.text}],l,i,N,e),N.children[0].x=u,N.children[0].y=d,n.children.forEach(function(e){return e.fontImg.destroy()}),n.destroy(),N.text=" "}}if(r<=0){if(N.text=a[o].name,v["default"].fontFamily){var h=N.children[0];if(h){var f=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(E.fontSize):E.fontSize,m=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(E.fontSize):E.fontSize,y=m*N.text.length,g=(x-y)/2,k=(P-f)/2;s.sceneProxy.addImageFontText([{data:N.text}],m,f,N,e),N.children[0].x=g,N.children[0].y=k,h.children.forEach(function(e){return e.fontImg.destroy()}),h.destroy(),N.text=" "}}s.viewComponent.game.time.events.remove(p),"disable"===S.type?(V.alive&&(V.inputEnabled=!1,A.changeBackground(b||w,M)),t(!1)):(V.alive&&(V.inputEnabled=!0,V.input.useHandCursor=!0,A.changeBackground(w,E)),t(!0))}}),y=function(){s.viewComponent.game.time.events.remove(p),t(!0)};f.push({close:y}),s.viewComponent.game.time.events.start()})};p.push(j())}else p.push(Promise.resolve(!I));r=!0},g=0;g<a.length;g++)y(g);r||(i({type:0}),s.sceneProxy.optionLayer.destroy()),Promise.all(p).then(function(e){s.sceneProxy.hasCountDown=!1,e.some(function(e){return!!e})||i({type:3})})})},N=function(e){s.sceneProxy.weatherLayer.visible=!1;for(var t=0;t<s.sceneProxy.weatherLayer.children.length;t++){var n=s.sceneProxy.weatherLayer.children[t],a=n.visible,o=n.name;a&&o!==e?(s.sceneProxy.weatherLayer.children[t].destroy(),t--):s.sceneProxy.weatherLayer.children[t].visible=!1}"windy"===e?flashvars.vertical?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("wind")+"/feng_00019.png")&&s.addWindEffect():s.addWindEffect():"snowy"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("snow")+"/xuehua_00119.png")&&s.addSnowEffect():"rainy"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("rain")+"/xiayu_00049.png")&&s.addRainEffect():"defoliation"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_00089.png")&&s.addFallingLeavesEffect():"fallingPeach"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("beachBlossom")+"/taohua_00089.png")&&s.addBeachBlossomEffect():"fallingFlower"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("blossom")+"/yinghua_00089.png")&&s.addBlossomEffect():"lightning"===e&&s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("lightning")+"/shandian_00049.png")&&s.addLightningEffect(),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer)},j=function(t,n,a){if(n){for(var o=[],r=0;r<s.sceneProxy.plotViews.length;r++)if("plotInfo"===s.sceneProxy.plotViews[r].generateType){var i=function(e){for(var n=0;n<t.length;n++)if(e.name===t[n].ref)return!0;return!1};i(s.sceneProxy.plotViews[r])||o.push(s.sceneProxy.plotViews[r])}for(var c=0;c<o.length;c++){var u=s.sceneProxy.plotViews.indexOf(o[c]);s.sceneProxy.plotViews.splice(u,1)}return R(s.sceneProxy.plotViews,!0),s.sceneProxy.uiOnLoadQueue.splice(0),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),void(s.sceneProxy.plotViewsLayer.visible=!1)}for(var d in t){s.registerViewKey(t[d].ref,t[d].events,s.sceneProxy.plotViewKeys);var h=s.addView(s.sceneProxy.plotViewsLayer,t[d].ref,t[d].instanceUuid,t[d].x,t[d].y,t[d].events);if(!h)return;t[d].scale&&(h.scale.set(t[d].scale,t[d].scale),h.x+=l.safeEval(t[d].x,e)*(1-t[d].scale),h.y+=l.safeEval(t[d].y,e)*(1-t[d].scale),s.scaleInputView(h,t[d].scale)),h.generateType=a?a:"plotInfo",s.sceneProxy.plotViews.push(h)}s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),s.uiOnLoadInvoker(),s.updateProgressView(),s.sceneProxy.plotViewsLayer.visible=!1},B=function(e,t){var n=[];for(var a in t)for(var o in s.sceneProxy.json_data.views)if(t[a]===s.sceneProxy.json_data.views[o].instanceUuid){n[s.sceneProxy.json_data.views[o].ref]=s.sceneProxy.json_data.views[o].ref;break}if(e&&s.sceneProxy.globalViews){for(var r=function(e){for(var t=0;t<s.sceneProxy.json_data.views.length;t++)if(e===s.sceneProxy.json_data.views[t].instanceUuid)return!0;return!1},i=[],l=0;l<s.sceneProxy.globalViews.length;l++)r(s.sceneProxy.globalViews[l].instanceUuid)||i.push(s.sceneProxy.globalViews[l]);for(var c=0;c<i.length;c++)if(i[c].isGlobal===!0){var u=s.sceneProxy.globalViews.indexOf(i[c]);s.sceneProxy.globalViews.splice(u,1)}R(s.sceneProxy.globalViews,!0);for(var d in s.sceneProxy.globalViews)s.viewComponent.game.world.bringToTop(s.sceneProxy.globalViews[d]),n[s.sceneProxy.globalViews[d].name]&&(s.sceneProxy.globalViews[d].visible=!1,s.showInputView(s.sceneProxy.globalViews[d],!1))}else s.addGlobalView(n);s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer)},R=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];s.sceneProxy.timerCounts=[];var n=function i(e){for(var t=0;t<e.length;t++){var n=e[t];n.currentCount&&(s.sceneProxy.timerCounts[s.sceneProxy.timerCounts.length]={name:n.name,parent:n.parent,currentCount:n.currentCount}),i(n.children)}},a=function(e){for(var t=0;t<e.length;t++){if(e[t].eventsInfo)return;for(var n=0;n<c.views.length;n++)if(c.views[n].ref===e[t].name){e[t].eventsInfo=c.views[n].events.concat();break}}};n(e),!c.commands&&a(e);for(var o=function(n){var a=e[n],o="__world"===a.parent?null:s.viewComponent.game.world.getByName(a.parent),i=s.addView(o,a.name,a.instanceUuid,a.xInfo,a.yInfo,a.eventsInfo,!1,t),l=function(e,t){for(var n=[],a=function(t){for(var n=e.children?e.children.concat():[],a=0;a<n.length;a++)if(n[a]&&t.name===n[a].name&&t.instanceUuid===n[a].instanceUuid)return!0;return!1},o=t.children?t.children.concat():[],r=0;r<o.length;r++)a(o[r])||n.push(s.destroyView(o[r].name));return Promise.all(n)},c=function u(e,n){l(e,n).then(function(){if(!e||e.children)for(var a=n.children?n.children.concat():[],o=function(e,t){for(var n=0;n<t.length;n++)if(e.name===t[n].name&&e.instanceUuid===t[n].instanceUuid)return!0;return!1},r=0;r<e.children.length;r++){if(o(e.children[r],a)){var i=!0;if(e.children[r].children)for(var l=0;l<e.children[r].children.length;l++)i=!!o(e.children[r].children[l],a);if(i===!0)continue}var c=s.addView(n,e.children[r].name,e.children[r].instanceUuid,e.children[r].xInfo,e.children[r].yInfo,e.children[r].eventsInfo,!1,t);n.xInfo&&n.yInfo&&c&&(c.x+=s.sceneProxy.Expression.safeEval(n.xInfo,s.sceneProxy.context),c.y+=s.sceneProxy.Expression.safeEval(n.yInfo,s.sceneProxy.context)),c&&u(e.children[r],c)}})};return i?(!a.isGlobal&&c(a,i),i.scale.set(a.scale.x,a.scale.y),i.x=a.x,i.y=a.y,s.scaleInputView(i,a.scale.x),i.visible=a.visible,e[n]=i,o?o.add(i):i.isGlobal=!0,void(r=n)):(e.splice(n--,1),"continue")},r=0;r<e.length;r++){o(r)}},D=function(){if(c.music.animation&&("fadeinfadeout"===c.music.animation.type||"fadein"===c.music.animation.type)){if(s.sceneProxy.bk_music)return 0===s.sceneProxy.bk_music.prevolume&&(s.sceneProxy.bk_music.prevolume=s.sceneProxy.bk_music.volume,s.sceneProxy.bk_music.inheritvolume=s.sceneProxy.bk_music.volume),s.sceneProxy.bk_music.volume=s.sceneProxy.bk_music.prevolume*m["default"].musicVolume,s.tweenFromPromise(s.sceneProxy.bk_music,{volume:0},s.sceneProxy.quickPlay?10:1e3,null,!0,0,0,!1);if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)return y["default"].tweenFromMusic(0,s.sceneProxy.quickPlay?10:1e3,0)}return Promise.resolve()},F=function(e){if(c.music.animation&&("fadeinfadeout"===c.music.animation.type||"fadeout"===c.music.animation.type)){if(s.sceneProxy.bk_music)return new Promise(function(t,n){var a=s.viewComponent.game.add.tween(s.sceneProxy.bk_music).to({volume:0},s.sceneProxy.quickPlay?10:1e3,null,!0,0,0,!1);a.onComplete.add(function(){s.sceneProxy.bk_music.volume*=m["default"].musicVolume,t(e)})});if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)return y["default"].tweenToMusic(0,s.sceneProxy.quickPlay?10:1e3,0)}return Promise.resolve(e)},U=function(e){if(s.sceneProxy.dialogLayer.visible=!0,!e.length)return Promise.resolve();var t=e.filter(function(e){return"fadein"===e.type}),n=e.filter(function(e){return"moveFrom"===e.type}),a=function(){if(t.length)return s.tweenFromPromise(s.sceneProxy.dialogLayer,{alpha:0},t[0].duration,null,!0,t[0].delay,0,!1)},o=function(){if(n.length)return s.tweenFromPromise(s.sceneProxy.dialogLayer,{x:n[0].x,y:n[0].y},n[0].duration,null,!0,n[0].delay,0,!1)};return Promise.all([a(),o()])},W=function(e){if(!e.length)return Promise.resolve();var t=e.filter(function(e){return"fadeout"===e.type}),n=e.filter(function(e){return"moveTo"===e.type}),a=function(){if(t.length)return s.tweenToPromise(s.sceneProxy.dialogLayer,{alpha:0},t[0].duration,null,!0,t[0].delay,0,!1)},o=function(){if(n.length)return s.tweenToPromise(s.sceneProxy.dialogLayer,{x:n[0].x,y:n[0].y},n[0].duration,null,!0,n[0].delay,0,!1)};return Promise.all([a(),o()])},G=function(){return s.sceneProxy.doInCT(e,function(){return I(c.animations.filter(function(e){return"in"===e.trigger}))}).then(function(){return s.sceneProxy.charsAndPropsLayer&&(s.sceneProxy.charsAndPropsLayer.visible=!0),s.sceneProxy.plotViewsLayer.visible=!0,s.sceneProxy.doInCT(e,function(){return Promise.all([A(),I(c.animations.filter(function(e){return"animateIn"===e.trigger})),U(c.speaking.animations.filter(function(e){return"animateIn"===e.trigger}))])})}).then(function(){return s.sceneProxy.doInCT(e,function(){return I(c.animations.filter(function(e){return"animateInEnd"===e.trigger}))})})},z=function(t){var n=[],a=!0,o=!1,r=void 0;try{for(var i,l=s.sceneProxy.charsAndPropsLayer.children[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var c=i.value,u=!0,d=!1,h=void 0;try{for(var f,m=c.data.animations[Symbol.iterator]();!(u=(f=m.next()).done);u=!0){var p=f.value;if(("out"===p.trigger||"animateOut"===p.trigger)&&!s.sceneProxy.quickPlay)if("fadeout"===p.type)n.push(s.tweenToPromise(c,{alpha:0},p.duration,null,!0,p.delay,0,!1));else if("moveTo"===p.type){var y=c.scale.x<0?-c.width/2:c.width/2,g=c.scale.y<0?-c.height/2:c.height/2;n.push(s.tweenToPromise(c,{x:p.x+y,y:p.y+g},p.duration,null,!0,p.delay,0,!1))}}}catch(v){d=!0,h=v}finally{try{!u&&m["return"]&&m["return"]()}finally{if(d)throw h}}}}catch(v){o=!0,r=v}finally{try{!a&&l["return"]&&l["return"]()}finally{if(o)throw r}}return s.sceneProxy.doInCT(e,function(){return Promise.all(n)})},H=function Z(e){if("\\"===e[0]){var t=/\\(\d+)\s([\s\S]*)/.exec(e);if(t)return m["default"].timeout(s.sceneProxy.quickPlay?0:t[1]).then(function(){return Z(e.slice(t[1].length+2))})}return s.sceneProxy.playPause?m["default"].timeout(1e3).then(function(){return Z(e)}):Promise.resolve(e)},K=function(e,t){var n=s.sceneProxy.json_data.template.json.dialog.content,a=e?s.viewComponent.game.world.height:n.rect.height,o=t-a;o>0&&(p.top=-o+n.rect.y)},q=function ee(e,t,n,a,o){if(v["default"].fontFamily){var r=e,i=0;if(e.replace(/[\n]/g,function(e,t){i++}),r.length&&r.length-i>0){var l=r.length-i-1,c=p.children[1],u=p.posInfo;u[l]&&(c.x=u[l].x+u[l].space,c.y=u[l].y,K(o,u[l].bottomInText),p.setText(" ",!0))}}else{var d=s.viewComponent.game.device.desktop?e:e.replace(new RegExp(" ","gm"),"  ");p.setText(d,!0),K(o,p.height)}return H(t).then(function(t){return s.sceneProxy.doInCT(n,function(){return m["default"].timeout(a).then(function(){return g?Promise.reject():t?s.sceneProxy.doInCT(n,function(){return ee(e+(t[0]?t[0]:""),t.slice(1),n,a,o)}):Promise.resolve()})})})},J=function(t,n){var a="";if(l.isArray(t.data)){for(var o=0;o<t.data.length;o++)a+=l.parseValue(t.data[o].data,e);s.sceneProxy.addImageFontTextColors(t.data,p,e)}else a=l.parseValue(t.data,e);if(a.length&&"\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),v["default"].fontFamily){var r=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(t.font_size):t.font_size,i=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(t.font_size):t.font_size;s.sceneProxy.addImageFontText(t.data,i,r,p,e,!0,t.hidden)}if(n||t.immediate){if(v["default"].fontFamily)p.children[1]&&(p.children[1].y=p.imgFBottom),p.text=" ",K(t.hidden,p.imgFBottom);else{var c=l.parseWaitTime(a);p.text=s.viewComponent.game.device.desktop?c:c.replace(new RegExp(" ","gm"),"  ")}return Promise.resolve()}g=!1;var u=new Promise(function(e,t){s.sceneProxy.curPlotLayer.onChildInputDown.add(function(t,n){"auto"===t||n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||e()})}),d=new Promise(function(e,t){s.sceneProxy.space_key.onDown.add(function(){e()})});return s.sceneProxy.doInCT(e,function(){return Promise.race([q("",a,e,s.sceneProxy.quickPlay?0:parseInt(t.speed),t.hidden),u,d])}).then(function(){if(g=!0,s.sceneProxy.curPlotLayer.onChildInputDown.removeAll(),s.sceneProxy.space_key.onDown.removeAll(),v["default"].fontFamily)p.children[1]&&(p.children[1].y=p.imgFBottom),K(t.hidden,p.imgFBottom),p.setText(" ",!0);else{var e=l.parseWaitTime(a);p.text=s.viewComponent.game.device.desktop?e:e.replace(new RegExp(" ","gm"),"  "),K(t.hidden,p.height)}})},$=function te(e,t){var n=s.sceneProxy.quickPlay?10:e<10?10:e;return m["default"].timeout(n).then(function(){return s.sceneProxy.playPause?te(500,t):Promise.resolve(t)})},Y=function(t){var n="";if("[object Array]"===Object.prototype.toString.call(t.speaking.data))for(var a=0;a<t.speaking.data.length;a++)n+=t.speaking.data[a].data;else n=t.speaking.data;n=n.replace(/\n/g,"");var o=t.dialogtitle.hidden||""===t.dialogtitle.data?n:t.dialogtitle.data+":"+n;o&&s.sceneProxy.addPlayBackContent(l.parseWaitTime(l.parseValue(o,e)))},Q=function(){if(!c)return s.showNextPlot(e,t,n);var r=function(){s.sceneProxy.curCmdUuid="",s.sceneProxy.context.disableSaveOrLoad=c.disableSaveOrLoad?c.disableSaveOrLoad:{save:!1,load:!1};var a={avatar:c.avatar,dialogtitle:c.dialogtitle,speaking:c.speaking};c.speaking.data&&!o&&Y(c),c.menu.hidden||(s.sceneProxy.json_data.template.json.shanyiMenu?s.addMenuLayer(!0):(s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=c.menu.x,s.sceneProxy.menuLayer.y=c.menu.y)),c.animations.find(function(e){return"fadein"===e.type})||(s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer,f.ResourcesManager.updateUsingKey({type:"preBackground",key:s.sceneProxy.lstPlotBkKey}));var r=function(){return E(),M(o?o.music:c.music),T(s.sceneProxy.curPlotLayer),"bottom"===c.speaking.coverage?(L(a),O(c.characters,c.props),N(c.weather.value),s.sceneProxy.dialogLayer.isbottom=!0):(O(c.characters,c.props),N(c.weather.value),L(a),s.sceneProxy.dialogLayer.isbottom=!1),s.sceneProxy.optionLayer&&s.viewComponent.game.world.bringToTop(s.sceneProxy.optionLayer),s.sceneProxy.charsAndPropsLayer&&(s.sceneProxy.charsAndPropsLayer.visible=!1),j(c.views,o),B(null!==o&&void 0!==o,c.hideGlobalViews),s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad&&c.autoSaveOrLoad&&1===c.autoSaveOrLoad.type&&!o?s.sceneProxy.loadRecord(0)?void 0:u["default"].warn("Sorry~读不到存档内容，即将返回封面").then(function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend())},function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend())}):(s.sceneProxy.shakeLoopObj.duration=-1,Promise.all([G(),D()]).then(function(){return s.sceneProxy.lstGameBk&&(s.sceneProxy.lstGameBk.visible=!1),J(c.speaking)}).then(function(){return V(c.options,c.condition_options)}).then(function(t){s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad&&c.autoSaveOrLoad&&0===c.autoSaveOrLoad.type&&(s.sceneProxy.getSnap(),s.sceneProxy.saveRecord(0,!0));var n=s.sceneProxy.plotViewsLayer.children.length>0;return new Promise(function(a,o){if(0===t.type||2===t.type)if(!c.autotext&&(n||!s.sceneProxy.quickPlay&&!e.auto)||s.sceneProxy.playPause){var r=function i(e,r){r&&r.pointerMode===Phaser.PointerMode.CURSOR&&0!==r.button||"auto"===e&&n||(s.sceneProxy.curPlotLayer.onChildInputDown.remove(i),"insertPlot"===e?o():a(t))};s.sceneProxy.curPlotLayer.onChildInputDown.add(r),!n&&s.sceneProxy.space_key.onDown.addOnce(function(){return a(t)})}else a(t);else a(t)})}).then(function(e){return $(c.wait.value,e)}).then(function(t){return Promise.all([z(t),F(t),W(c.speaking.animations.filter(function(e){return"animateOut"===e.trigger}))]).then(function(){return s.sceneProxy.doInCT(e,function(){return Promise.resolve(t)})})}).then(function(a){1===a.type?s.showNextPlot(e,t,n,"option",a.index):s.showNextPlot(e,t,n)},function(e){Promise.reject(e)}))};o?r():s.sceneProxy.valueOperation(e,c.values,!1,function(){r()})},l=function(){var o=[];s.sceneProxy.isGoToCommand=!0;var r=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(a&&a.shake){var r=a.shake;s.sceneProxy.shakeLoopObj.loop=r.args[0].loop,s.sceneProxy.shakeLoopObj.level=r.args[0].level,s.sceneProxy.shakeLoopObj.duration=r.args[0].duration,s.sceneProxy.shakeLoopObj.delay=r.args[0].delay,s.sceneProxy.shakeLoopObj.commands=r;var i=function I(){return s.sceneProxy.curPlotLayer.isShaking=!0,x(r.args[0].level?5*r.args[0].level:18,r.args[0].duration,r.args[0].delay).then(function(){return s.sceneProxy.curPlotLayer.isShaking=!1,r.args[0].loop&&r.args[0].level>0&&s.sceneProxy.shakeLoopObj.loop?(r.args[0].delay=0,I()):Promise.resolve()})};i().then(function(){s.sceneProxy.curPlotLayer.isShaking=!1})}if(e.music&&""!==f.ResourcesManager.usingKeyMap.music||s.sceneProxy.stopMusic(),e.music&&(s.viewComponent.game.load.cache.checkSoundKey(e.music.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")){var l=e.music.volume;void 0!==e.music.inheritvolume&&e.music.inheritvolume!==-1&&(l=e.music.inheritvolume),s.sceneProxy.stopMusic(e.music.url),s.sceneProxy.playMusic(e.music.url,l,!0)}for(var u in e.sounds)if(e.sounds[u]&&""!==f.ResourcesManager.usingKeyMap.sounds[u]){if(s.viewComponent.game.load.cache.checkSoundKey(e.sounds[u].url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var h=e.sounds[u].volume;void 0!==e.sounds[u].inheritvolume&&e.sounds[u].inheritvolume!==-1&&(h=e.sounds[u].inheritvolume),s.sceneProxy.stopSound(u,e.sounds[u].url,!0),s.sceneProxy.playSound(u,e.sounds[u].url,h,0===e.sounds[u].time)}}else s.sceneProxy.stopSound(u);!e.bk&&(e.bk={opacity:0}),d=s.sceneProxy.curPlotLayer.create(0,0,e.bk.url),d.alpha=e.bk.opacity,d.width=s.viewComponent.game.world.width,d.height=s.viewComponent.game.world.height,s.viewComponent.addGifAnimation(d,e.bk.url),s.sceneProxy.charsAndPropsLayer&&s.sceneProxy.charsAndPropsLayer.exists||(s.sceneProxy.charsAndPropsLayer=s.viewComponent.game.add.group(),s.sceneProxy.charsAndPropsLayer.name="charactersAndProps");var m=!0,p=!1,y=void 0;try{for(var g,v=e.charsAndProps[Symbol.iterator]();!(m=(g=v.next()).done);m=!0){var P=g.value,w=P.x,k=P.y;P.pivotX&&P.pivotY&&(P.x-=P.width/2,P.y-=P.height/2);var b=s.viewComponent.addFitImageSprint(P.x,P.y,P.width,P.height,P.url,s.sceneProxy.charsAndPropsLayer,P.index);b.alpha=P.opacity,b.angle=P.rotate,P.pivotX&&(b.scale.x=P.scaleX,b.scale.y=P.scaleY,b.x=w,b.y=k),P.mirrorH&&(b.angle=-b.angle,b.scale.x=-b.scale.x,b.mirrorH=!0),P.mirrorV&&(b.angle=-b.angle,b.scale.y=-b.scale.y,b.mirrorV=!0),b.cmdUuid=P.cmdUuid,P.parentScale&&b.parent.scale.setTo(P.parentScale,P.parentScale),s.viewComponent.addGifAnimation(b,P.url)}}catch(C){p=!0,y=C}finally{try{!m&&v["return"]&&v["return"]()}finally{if(p)throw y}}""!==s.sceneProxy.weatherType&&N(e.weatherType),s.sceneProxy.bCmdAutoText=e.autoText,e.dialogInfo[0]&&(n>=t.length||n<t.length&&"showDialog"!==t[n].type)?(L(e.dialogInfo[0]),J(e.dialogInfo[0].speaking,!0)):s.sceneProxy.dialogLayer.visible=!1,s.sceneProxy.removeViewTimer(s.sceneProxy.plotViewsLayer),s.sceneProxy.removeInputView(s.sceneProxy.plotViewsLayer),s.sceneProxy.plotViewsLayer.removeAll(!0),s.sceneProxy.filterInexistentPlotViews(e.plotViews,c),s.removeViewKey(s.sceneProxy.plotViewKeys),R(e.plotViews),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer);for(var _ in s.sceneProxy.globalViews)if(!s.sceneProxy.globalViews[_].visible)for(var S in s.sceneProxy.json_data.views)if(s.sceneProxy.json_data.views[S].ref===s.sceneProxy.globalViews[_].name){o[_]=s.sceneProxy.json_data.views[S].instanceUuid;break}B(!0,o),e.menuInfo[0]&&(s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=e.menuInfo[0].x,s.sceneProxy.menuLayer.y=e.menuInfo[0].y)},l=function(a,r){var l={type:""};return s.sceneProxy.curCmdInfo=a,s.sceneProxy.curCmdIndex=r,new Promise(function(c,h){if("systemUI"===a.commands[r].type||"jump"===a.commands[r].type||"back"===a.commands[r].type||"insert"===a.commands[r].type)s.sceneProxy.cmdPlotNextPromise=null;else if("showDialog"===a.commands[r].type){var p=function(e){var t=new Phaser.Pointer(s.viewComponent.game,1,Phaser.PointerMode.CURSOR);t.button=0,s.sceneProxy.curPlotLayer.onChildInputDown.dispatch("nextCmd",t),s.sceneProxy.curPlotLayer.onChildInputDown.dispatch("nextCmd",t),c(e)};s.sceneProxy.cmdPlotNextPromise=p}else s.sceneProxy.cmdPlotNextPromise=c;var g=a.commands,v=g[r].args;s.sceneProxy.curCmdUuid=g[r].uuid;var k=function(){switch(g[r].type){case"addView":j(v,null,g[r].uuid),s.sceneProxy.plotViewsLayer.visible=!0,s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);break;case"delView":s.destroyView(v[0]);break;case"systemUI":if("save-record"===v[0]){var i=s.sceneProxy.context.disableSaveOrLoad;return i&&i.save?(s.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用存档"),{v:c(l)}):(!s.sceneProxy.mainMenuLayer.visible&&s.sceneProxy.getSnap(),s.sceneProxy.showSave(!1,{callbackFun:c,callbackArgs:l}),{v:void 0})}if("load-record"===v[0]){var p=s.sceneProxy.context.disableSaveOrLoad;return p&&p.load?(s.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用读档"),{v:c(l)}):(s.sceneProxy.showLoad(!1,{callbackFun:c,callbackArgs:l}),{v:void 0})}if("settings"===v[0])return s.sceneProxy.showPlayback({callbackFun:c,callbackArgs:l}),{v:void 0};if("playback"===v[0])return s.sceneProxy.showSettings(e,{callbackFun:c,callbackArgs:l}),{v:void 0};case"addImage":if(1===v[0].index){var k="inherit"===v[0].url,b=k?s.sceneProxy.lstPlotBkKey:v[0].url,C=k?s.sceneProxy.lstPlotBkFlex:v[0].flex,_=k?s.sceneProxy.lstPlotBkOpacity:v[0].opacity;if(s.viewComponent.game.load.cache.checkImageKey(b)){var I=s.sceneProxy.curPlotLayer.children.splice(1,1);I.length&&I[0].destroy(),d=s.sceneProxy.curPlotLayer.create(v[0].x,v[0].y,b),d.alpha=void 0===_?1:_,s.backgroundFlex(d,C),s.sceneProxy.lstGameBk&&s.sceneProxy.lstGameBk.visible&&(s.sceneProxy.lstGameBk.visible=!1),s.sceneProxy.prePlotBkKey=s.sceneProxy.lstPlotBkKey,s.sceneProxy.lstPlotBkKey=b,s.sceneProxy.lstPlotBkOpacity=_,s.sceneProxy.lstPlotBkFlex=C,s.viewComponent.addGifAnimation(d,v[0].url)}}else O(v,[],g[r].uuid);break;case"delImage":if(1===v[0]){var E=s.sceneProxy.curPlotLayer.children.splice(1,1);E.length&&E[0].destroy()}else for(var T=0;T<s.sceneProxy.charsAndPropsLayer.children.length;T++){var A=s.sceneProxy.charsAndPropsLayer.getAt(T);if(-1===A)break;if(A.zIndex===v[0]){s.sceneProxy.charsAndPropsLayer.removeChildAt(T),A.destroy();break}}break;case"showMenu":s.sceneProxy.menuInfo=v.concat(),s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=v[0].x,s.sceneProxy.menuLayer.y=v[0].y;break;case"hideMenu":s.sceneProxy.menuInfo=[],s.sceneProxy.menuLayer.visible=!1;break;case"showGlobalView":for(var R=0;R<o.length;R++)if(o[R]===v[0]){o.splice(R,1);break}B(!1,o);break;case"hideGlobalView":for(var D=0;D<o.length&&o[D]!==v[0];D++);D>=o.length&&(o[D]=v[0]),B(!1,o);break;case"showDialog":return s.sceneProxy.lstDialogInfo=v.concat(),
s.sceneProxy.dialogLayer.animateTweens.forEach(function(e,t){e.stop()}),s.sceneProxy.dialogLayer.animateTweens.splice(0),Y(v[0]),{v:L(v[0]).then(function(){return v[0].speaking.coverage&&"bottom"===v[0].speaking.coverage?(s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer),s.sceneProxy.dialogLayer.isbottom=!0):(s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer),s.sceneProxy.dialogLayer.isbottom=!1),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),B(!1,o),J(v[0].speaking)}).then(function(){var e=s.sceneProxy.plotViewsLayer.children.length>0;if((s.sceneProxy.bCmdAutoText||!e&&(s.sceneProxy.quickPlay||s.sceneProxy.context.auto))&&!s.sceneProxy.playPause)return c(l);var t=function n(t,a){if(!(a&&a.pointerMode===Phaser.PointerMode.CURSOR&&0!==a.button||"auto"===t&&e))return s.sceneProxy.curPlotLayer.onChildInputDown.remove(n),"insertPlot"===t?h():c(l)};s.sceneProxy.curPlotLayer.onChildInputDown.add(t),!e&&s.sceneProxy.space_key.onDown.addOnce(function(){return c(l)})})};case"hideDialog":s.sceneProxy.lstDialogInfo=[],s.sceneProxy.dialogLayer.visible=!1;break;case"playMusic":M(v[0]);break;case"stopMusic":s.sceneProxy.stopMusic();break;case"playSound":if("inherit"===v[0].url){s.sceneProxy.plotSounds[v[0].index]&&s.sceneProxy.playInheritSound(v[0].index,v[0].volume);break}(s.viewComponent.game.load.cache.checkSoundKey(v[0].url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&(s.sceneProxy.stopSound(v[0].index,v[0].url),s.sceneProxy.playSound(v[0].index,v[0].url,v[0].volume,0===v[0].time));break;case"stopSound":s.sceneProxy.stopSound(v[0]);break;case"animateImage":if(s.sceneProxy.dialogLayer.visible!==!1){var F=s.viewComponent.game.world.getChildIndex(s.sceneProxy.dialogLayer),U=s.viewComponent.game.world.getChildIndex(s.sceneProxy.charsAndPropsLayer);F<U&&!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer)}s.sceneProxy.menuLayer.visible!==!1&&s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var W=s.sceneProxy.quickPlay?0:v[0].delay,G=s.sceneProxy.quickPlay?0:v[0].duration;if(v[0].index>1&&s.sceneProxy.charsAndPropsLayer.exists)for(var z=function(e){var t=s.sceneProxy.charsAndPropsLayer.children[e];if(t.zIndex===v[0].index){var n=t.children[0],a=function(){t.animateTweens&&(t.animateTweens.forEach(function(e,t){e.stop(!1)}),t.animateTweens.splice(0)),n.animateTweens&&(n.animateTweens.forEach(function(e,t){e.stop(!1)}),n.animateTweens.splice(0)),n.finalState&&(n.alpha=n.finalState.alpha,n.angle=n.finalState.angle,n.x=n.finalState.x,n.y=n.finalState.y,t.x=0,t.y=0,t.scale.x=t.finalState.scale.x,t.scale.y=t.finalState.scale.y);var e=v[0].opacity,a=180===parseInt(v[0].rotate)?179.9:v[0].rotate,o=void 0===v[0].scaleX?1:v[0].scaleX,r=void 0===v[0].scaleY?1:v[0].scaleY,i=v[0].x/o+n.width/2,l=v[0].y/r+n.height/2;if(n.mirrorH&&(a=-a,i-=n.width),n.mirrorV&&(a=-a,l-=n.height),(!n.lstAlpha&&n.alpha!==e||n.lstAlpha!==e)&&(n.lstAlpha=e,s.tweenToPromise(n,{alpha:e},G,null,!0,W)),(!n.lstAngle&&n.angle!==a||n.lstAngle!==a)&&(n.lstAngle=a,s.tweenToPromise(n,{angle:a},G,null,!0,W)),!n.lstX&&n.x!==i||n.lstX!==i){n.lstX=i;var c=n.mirrorH?(n.x+n.width/2)*t.scale.x:(n.x-n.width/2)*t.scale.x,u=v[0].x-c*(o/t.scale.x);s.tweenToPromise(t,{x:u},G,null,!0,W).then(function(){t.x=0,n.x=n.lstX})}if(!n.lstY&&n.y!==l||n.lstY!==l){n.lstY=l;var d=n.mirrorV?(n.y+n.height/2)*t.scale.y:(n.y-n.height/2)*t.scale.y,h=v[0].y-d*(r/t.scale.y);s.tweenToPromise(t,{y:h},G,null,!0,W).then(function(){t.y=0,n.y=n.lstY})}n.finalState={alpha:e,angle:a,x:i,y:l},(!t.lstScaleX&&t.scale.x!==o||t.lstScaleX!==o)&&(t.lstScaleX=o,s.tweenToPromise(t.scale,{x:o},G,null,!0,W)),(!t.lstScaleY&&t.scale.y!==r||t.lstScaleY!==r)&&(t.lstScaleY=r,s.tweenToPromise(t.scale,{y:r},G,null,!0,W)),t.finalState={scale:{x:o,y:r}}};return a(),"break"}},H=0;H<s.sceneProxy.charsAndPropsLayer.children.length;H++){var K=z(H);if("break"===K)break}else 1===v[0].index&&s.sceneProxy.curPlotLayer.children[1]&&(s.tweenToPromise(s.sceneProxy.curPlotLayer.children[1],{alpha:v[0].opacity},G,null,!0,W),s.sceneProxy.curPlotLayer.children[1].finalState={alpha:v[0].opacity},s.sceneProxy.lstPlotBkOpacity=v[0].opacity);break;case"animateDialog":if(s.sceneProxy.dialogLayer.visible){var q=s.sceneProxy.quickPlay?0:v[0].delay,Q=s.sceneProxy.quickPlay?0:v[0].duration,X=function(){var e={alpha:v[0].opacity,angle:v[0].rotate,x:parseFloat(v[0].x),y:parseFloat(v[0].y)};return s.sceneProxy.lstDialogInfo[0]&&(s.sceneProxy.lstDialogInfo[0].opacity=v[0].opacity,s.sceneProxy.lstDialogInfo[0].rotate=v[0].rotate,s.sceneProxy.lstDialogInfo[0].x=v[0].x,s.sceneProxy.lstDialogInfo[0].y=v[0].y),s.tweenToPromise(s.sceneProxy.dialogLayer,e,Q,null,!0,q).then(function(){s.sceneProxy.dialogLayer.visible=!0,!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer)})},Z=function(){return s.tweenToPromise(s.sceneProxy.dialogLayer.scale,{x:v[0].scaleX,y:v[0].scaleY},Q,null,!0,q).then(function(){s.sceneProxy.dialogLayer.visible=!0,!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer)})};X()&&Z()}break;case"animateScene":if(!s.sceneProxy.quickPlay){if("twinkle"===v[0].type&&w(v[0].duration,v[0].delay,v[0].color),"shake"===v[0].type){var ee=v[0].loop&&v[0].loop||!1;if(ee&&!s.sceneProxy.shakeLoopObj.loop||s.sceneProxy.curPlotLayer.isShaking!==!0||P(),s.sceneProxy.shakeLoopObj.loop=ee,s.sceneProxy.shakeLoopObj.level=v[0].level,s.sceneProxy.shakeLoopObj.duration=v[0].duration,s.sceneProxy.shakeLoopObj.delay=v[0].delay,s.sceneProxy.shakeLoopObj.commands=g[r],!s.sceneProxy.curPlotLayer.isShaking&&v[0].duration){var te=function ne(){return s.sceneProxy.curPlotLayer.isShaking=!0,x(v[0].level?5*v[0].level:18,v[0].duration,v[0].delay).then(function(){return s.sceneProxy.curPlotLayer.isShaking=!1,s.sceneProxy.shakeLoopObj.loop&&v[0].level>0?(v[0].level!==s.sceneProxy.shakeLoopObj.level&&(v[0].level=s.sceneProxy.shakeLoopObj.level),v[0].duration!==s.sceneProxy.shakeLoopObj.duration&&(v[0].duration=s.sceneProxy.shakeLoopObj.duration),v[0].delay=0,ne()):Promise.resolve()})};te().then(function(){s.sceneProxy.curPlotLayer.isShaking=!1})}}"spread"===v[0].type&&!s.sceneProxy.curPlotLayer.isSpreading&&S(v[0].duration,v[0].delay)}break;case"animateMusic":s.sceneProxy.bk_music&&(s.sceneProxy.bk_music.prevolume=v[0].volume,s.sceneProxy.bk_music.inheritvolume=v[0].volume),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(y["default"].musicInfo&&(y["default"].musicInfo.inheritvolume=v[0].volume,y["default"].musicInfo.prevolume=v[0].volume),v[0].volume*=m["default"].musicVolume,y["default"].tweenToMusic(v[0].volume,v[0].duration,v[0].delay)):(v[0].volume*=m["default"].musicVolume,s.sceneProxy.bk_music&&(s.sceneProxy.bk_music.animateMusic="music",s.tweenToPromise(s.sceneProxy.bk_music,{volume:v[0].volume},v[0].duration,null,!0,v[0].delay).then(function(){s.sceneProxy.bk_music.volume=s.sceneProxy.bk_music.prevolume*m["default"].musicVolume})));break;case"animateSound":s.sceneProxy.plotSounds[v[0].index]&&(s.sceneProxy.plotSounds[v[0].index].prevolume=v[0].volume,s.sceneProxy.plotSounds[v[0].index].inheritvolume=v[0].volume),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(y["default"].soundsInfo[v[0].index]&&(y["default"].soundsInfo[v[0].index].prevolume=v[0].volume,y["default"].soundsInfo[v[0].index].inheritvolume=v[0].volume),v[0].volume*=m["default"].soundVolume,y["default"].tweenToSound(v[0].index,v[0].volume,v[0].duration,v[0].delay)):(v[0].volume*=m["default"].soundVolume,s.sceneProxy.plotSounds[v[0].index]&&(s.sceneProxy.plotSounds[v[0].index].animateMusic="sound",s.tweenToPromise(s.sceneProxy.plotSounds[v[0].index],{volume:v[0].volume},v[0].duration,null,!0,v[0].delay).then(function(){s.sceneProxy.plotSounds[v[0].index].volume=s.sceneProxy.plotSounds[v[0].index].prevolume*m["default"].soundVolume})));break;case"setValues":s.sceneProxy.valueOperation(e,v,!1,function(){return c(l)});break;case"wait":return s.sceneProxy.quickPlay&&s.sceneProxy.preWaitCmdUuid!==g[r].uuid?(s.sceneProxy.preWaitCmdUuid=g[r].uuid,{v:c(l)}):{v:$(v[0].value,{type:0}).then(function(){return s.sceneProxy.curCmdInfo!==a?(t={},Object.assign(t,s.sceneProxy.curChapter),n=s.sceneProxy.curPlotIndex,a={},Object.assign(a,s.sceneProxy.curCmdInfo),r=s.sceneProxy.curCmdIndex,c(!1)):c(l)})};case"jump":return s.sceneProxy.context=JSON.parse(JSON.stringify(s.sceneProxy.context)),s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"jump",v[0]),{v:c(!1)};case"back":return s.sceneProxy.context=JSON.parse(JSON.stringify(s.sceneProxy.context)),s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"back"),{v:c(!1)};case"insert":return s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"insertPlot",v[0]),{v:c(!1)};case"options":return s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.exists||(s.sceneProxy.optionLayer=s.viewComponent.game.add.group()),s.viewComponent.game.world.bringToTop(s.sceneProxy.optionLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),B(!1,o),s.sceneProxy.isScreenHold&&s.viewComponent.game.world.bringToTop(s.sceneProxy.quickPlayLayer),{v:V(v,null).then(function(e){return l.type="options",l.index=e.index,f.ResourcesManager.resetCmdPOptionPreload(g,r,l.index),c(l)})};case"conditionOptions":return s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.exists||(s.sceneProxy.optionLayer=s.viewComponent.game.add.group()),{v:V([],v).then(function(e){return 2===e.type&&(l.type="cdtOptions"),f.ResourcesManager.resetCmdPOptionPreload(g,r,2===e.type?e.index:-1),c(l)})};case"backOption":l.type="backOption",l.eArg=s.sceneProxy.Expression.safeEval(a.commands[r].args[0],e);break;case"jumpOption":l.type="jumpOption",l.eArg=s.sceneProxy.Expression.safeEval(a.commands[r].args[0],e);break;case"autoSaveOrLoad":if(s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad){if(1===v[0].type)return s.sceneProxy.loadRecord(v[0].index)?{v:Promise.resolve(-1)}:{v:u["default"].warn("Sorry~读不到存档内容，即将返回封面").then(function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend()),Promise.resolve(-1)},function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend()),Promise.resolve(-1)})};0===v[0].type&&(s.sceneProxy.getSnap(),s.sceneProxy.saveRecord(v[0].index,!0))}break;case"autotext":s.sceneProxy.bCmdAutoText=v[0];break;case"weather":"none"===v[0]?s.sceneProxy.weatherLayer.visible=!1:N(v[0]);break;case"disableSaveOrLoad":s.sceneProxy.context.disableSaveOrLoad=v[0]}}();return"object"===("undefined"==typeof k?"undefined":i(k))?k.v:"setValues"!==g[r].type?c(l):void 0})},h=function C(a,o){return s.cmdPlotLoadResources(e,t,n,a,o).then(function(){return l(a,o).then(function(r){if(s.sceneProxy.cmdPlotNextPromise=null,r&&e===s.sceneProxy.context&&s.sceneProxy.isGoToCommand!==!1){var i=s.sceneProxy.getNextCommand(e,a,o,r),l=i.info,c=i.index;l&&l.commands[c]?C(l,c):s.showNextPlot(e,t,n)}})})};s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer,f.ResourcesManager.updateUsingKey({type:"preBackground",key:s.sceneProxy.lstPlotBkKey}),s.sceneProxy.bCmdAutoText=!1,s.sceneProxy.lstDialogInfo=[],s.sceneProxy.cmdPlayHandlerFun=h,T(s.sceneProxy.curPlotLayer);var p={commands:c.commands,parentInfo:null,parentCmdIndex:-1},g=0;if(a&&a.cmdInfo){if(s.sceneProxy.context.disableSaveOrLoad=c.disableSaveOrLoad?c.disableSaveOrLoad:s.sceneProxy.context.disableSaveOrLoad,p=a.cmdInfo,g=a.cmdIndex,p.commands[g]&&"systemUI"===p.commands[g].type&&g++,p.commands[g]&&"autoSaveOrLoad"===p.commands[g].type&&g++,r(a.cmdScreenSnap,p.commands,g,a.animateScene?a.animateScene:null),!p.commands[g]){var v=s.sceneProxy.getNextCommand(e,p,g-1,{type:"insert"}),k=v.info,b=v.index;p=k,g=b}}else s.sceneProxy.context.disableSaveOrLoad=c.disableSaveOrLoad?c.disableSaveOrLoad:{save:!1,load:!1};s.addMenuLayer(!!s.sceneProxy.json_data.template.json.shanyiMenu),p&&p.commands[g]?h(p,g):s.showNextPlot(e,t,n)};s.sceneProxy.isGettingNext=!1,s.sceneProxy.curPlotLayer=s.viewComponent.game.add.group(),s.sceneProxy.curPlotLayer.inputEnableChildren=!0,s.sceneProxy.curPlotLayer.isShaking=!1,s.sceneProxy.curPlotLayer.isSpreading=!1,s.sceneProxy.curPlotLayer.name="plotLayer",s.sceneProxy.charsAndPropsLayer&&s.sceneProxy.charsAndPropsLayer.destroy(),s.sceneProxy.charsAndPropsLayer=s.viewComponent.game.add.group(),s.sceneProxy.charsAndPropsLayer.name="charactersAndProps",s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.destroy(),s.sceneProxy.optionLayer=s.viewComponent.game.add.group(),s.viewComponent.game.world.bringToTop(s.sceneProxy.curPlotLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),P(),o||(s.sceneProxy.removeViewTimer(s.sceneProxy.plotViewsLayer),s.sceneProxy.removeInputView(s.sceneProxy.plotViewsLayer),s.sceneProxy.plotViewsLayer.removeAll(!0),s.sceneProxy.plotViews.splice(0,s.sceneProxy.plotViews.length),s.removeViewKey(s.sceneProxy.plotViewKeys)),s.sceneProxy.curPlotInfo=c,s.sceneProxy.curChapter=t,s.sceneProxy.curPlotIndex=n,c.commands?l():r()};Q(),this.sceneProxy.isScreenHold&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},endPlot:function(){this.sceneProxy.coverLayer.visible=!1,this.viewComponent.game.input.onDown.removeAll(),this.sceneProxy.dialogLayer.visible=!1,this.sceneProxy.menuLayer.visible=!1,this.sceneProxy.space_key.onDown.removeAll(),this.sceneProxy.plotViews.splice(0,this.sceneProxy.plotViews.length),this.sceneProxy.removePlotTweens()},showNextPlot:function(e,t,n,a,o){var i=this;this.sceneProxy.isGoToCommand=!1;var s=e.stack,l=this.sceneProxy.getNextPlot(e,t,n,a,o),c=l.chapter,d=l.nIndex,h=l.cmdPlotSnap,m=l.context,p=l.preStackFrame,y=l.preCmdStackFrame,g=function(){if(!c.plots[d]){if(d===-2)return i.sceneProxy.reStart(i.sceneProxy.isExtend());if(!(d<-2))return 0===d?void i.showNextPlot(e,c,d):(i.sceneProxy.dialogLayer.visible=!0,i.sceneProxy.menuLayer.visible=!0,i.gameOver());p&&(m.stack=[p].concat(r(m.stack)),y&&(m.cmdStack=[y].concat(r(m.cmdStack))));var l=i.sceneProxy.getNextPlot(e,t,n,a,o),u=l.chapter,g=l.nIndex,v=l.cmdPlotSnap,x=l.context,P=l.preStackFrame,w=l.preCmdStackFrame;if(c=u,d=g,h=v,m=x,p=P,y=w,d<-2)return p&&(e.stack=[p].concat(r(m.stack)),y&&(m.cmdStack=[y].concat(r(m.cmdStack)))),i.showNextPlot(e,t,n,a,o)}var k=null,b=null,C=null;if(s!==m.stack){var _=m.stack[0]||{},S=_.type,I=_.index;"options"===S||"condition_options"===S?(k=S,b=I):"insert"===S?C="insert":m.stack.length||d||(C="jump")}if(f.ResourcesManager.resetPlotOptionPreload(t.plots[n],k,b),f.ResourcesManager.clearPrePlotResources(t.plots,n),"jump"!==C&&"insert"!==C||("jump"===C?f.ResourcesManager.resetJumpPreload(c):f.ResourcesManager.resetInsertPreload(c)),i.sceneProxy.isPlotResourceExist(c.plots[d])){var L=i.sceneProxy.getLoadingPlotResource(c.plots[d]);L.length?i.assetsLoader(L,!0,!0).then(function(){return i.showPlot(m,c,d,h)}):i.showPlot(m,c,d,h)}else i.sceneProxy.preloadChapterAssets(m,c,d,h)},v=function(){if(0===n)i.showPlot(e,t,0);else{p&&(u.stack=[p].concat(r(u.stack)),y&&(u.cmdStack=[y].concat(r(u.cmdStack))));var a=i.sceneProxy.getNextPlot(e,t,n-1,"",o),s=a.chapter,l=a.nIndex,c=a.cmdPlotSnap,u=a.context;i.sceneProxy.preloadChapterAssets(u,s,l,c)}};if(this.sceneProxy.isGettingNext=!0,this.sceneProxy.shakeLoopObj.loop=!1,this.endPlot(),c.md5&&0===c.plots.length){this.sceneProxy.isPreferentialFinished=!1;var x=c.downloadUuid?c.downloadUuid:c.uuid;if(this.sceneProxy.isWapOther()){var P=function(e){null===e?u["default"].error("获取付费章节信息失败").then(function(){v()},function(){v()}):"fail"===e?u["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,w["default"])("819786897",{debug:!1,message:"复制成功"}),v()},function(){v()}):(c.plots=e?e:[],g())};return void this.sceneProxy.unlockChapterByWapOther(x,c.charge,c.md5,P)}if(!c.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)this.sceneProxy.checkIfChapterFree(x,c.md5).then(function(e){var t;(t=c.plots).push.apply(t,r(e)),g()},function(e){-1===e.indexOf("code=87")?u["default"].error(e):u["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买").then(function(){return v()},function(){return g()})});else{var k=function(){var e=function(e,t){e?i.sceneProxy.checkIfChapterFree(x,c.md5).then(function(e){var t;i.sceneProxy.unlockChapterCallBack=null,(t=c.plots).push.apply(t,r(e)),g()},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():u["default"].error("获取付费章节信息失败"),v()}):t?v():(u["default"].error("章节解锁失败"),g())};i.sceneProxy.unlockChapter(x,c.charge,c.md5,e)};""!==flashvars.uid&&"wap"===flashvars.client?this.sceneProxy.checkIfChapterFree(x,c.md5).then(function(e){var t;i.sceneProxy.unlockChapterCallBack=null,(t=c.plots).push.apply(t,r(e)),g()},function(){k()}):k()}}else{if(("android"===flashvars.client||"ios"===flashvars.client)&&c.charge){var b=c.downloadUuid?c.downloadUuid:c.uuid,C=function(e){for(var t=0;t<i.sceneProxy.preferentialVector.length;t++)if(e===i.sceneProxy.preferentialVector[t])return!0;return!1};if(this.sceneProxy.isPreferentialFinished!==!1||C(b)){var _=function(){var e=function(e,t){e?i.sceneProxy.checkIfChapterFree(b,c.md5).then(function(e){i.sceneProxy.isPreferentialFinished=!1,i.sceneProxy.dislodgePreferentVector(b),i.sceneProxy.unlockChapterCallBack=null,c.plots=e,g()},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():u["default"].error("获取付费章节信息失败"),v()}):t?v():(u["default"].error("章节解锁失败"),g())};i.sceneProxy.unlockChapter(b,c.charge,c.md5,e)};return void this.sceneProxy.checkIfChapterFree(b,c.md5).then(function(e){i.sceneProxy.dislodgePreferentVector(b),g()},function(e){i.sceneProxy.isPreferentialFinished!==!1?u["default"].custom("Info","作品限免已结束，需要付费才能继续观看哦","限免提示","取消","去支付",!0).then(function(){v()},function(e){"cancel"===e?_():"close"===e&&v()}):C(b)&&_()})}}g()}},gameOver:function(){"ios"===flashvars.client?1===flashvars.offline?workFinished("1"):window.webkit&&window.webkit.messageHandlers.workFinished.postMessage("1"):"android"===flashvars.client&&window.app&&window.app.workFinished("1"),this.sceneProxy.showEnd()},onRegister:function(){this.setViewComponent(new diygamePlayer.view.component.Scene),this.facade.registerMediator(new diygamePlayer.view.mediator.CoverMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.SettingsMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.MainMenuMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.RecordMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.PlaybackMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.EndMediator);var e=this;this.viewComponent.onRendered=function(){e.viewComponent.sceneProxy=e.sceneProxy,e.sceneProxy.preloadingBegin()},this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME)},onRemove:function(){this.setViewComponent(null)},curChapter:null},{NAME:"SceneMediator"})}),require.register("js/view/mediator/SettingsMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i),l=t("../../common/Utils.js"),c=a(l);r["default"].define({name:"diygamePlayer.view.mediator.SettingsMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS]},handleNotification:function(e){var t=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS:this.callbackInfo=t.callbackInfo,this.showSettingsLayer(t.context)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},fullMode:function u(){var e=this.sceneProxy.json_data.template.json.settings,u=e.fullMode,t=e.windowMode,n=this.sceneProxy.settingsLayer.getByName("settings_button_fullMode"),a=this.sceneProxy.settingsLayer.getByName("settings_button_windowMode");n&&n.changeBackground(u.checked.background.url,u.checked.text),a&&a.changeBackground(t.unchecked.background.url,t.unchecked.text)},windowMode:function d(){var e=this.sceneProxy.json_data.template.json.settings,t=e.fullMode,d=e.windowMode,n=this.sceneProxy.settingsLayer.getByName("settings_button_fullMode"),a=this.sceneProxy.settingsLayer.getByName("settings_button_windowMode");n&&n.changeBackground(t.unchecked.background.url,t.unchecked.text),a&&a.changeBackground(d.checked.background.url,d.checked.text)},autoOn:function h(){var e=this.sceneProxy.json_data.template.json.settings,h=e.autoOn,t=e.autoOff,n=this.sceneProxy.settingsLayer.getByName("settings_button_autoOn"),a=this.sceneProxy.settingsLayer.getByName("settings_button_autoOff");n&&n.changeBackground(h.checked.background.url,h.checked.text),a&&a.changeBackground(t.unchecked.background.url,t.unchecked.text)},autoOff:function f(){var e=this.sceneProxy.json_data.template.json.settings,t=e.autoOn,f=e.autoOff,n=this.sceneProxy.settingsLayer.getByName("settings_button_autoOn"),a=this.sceneProxy.settingsLayer.getByName("settings_button_autoOff");n&&n.changeBackground(t.unchecked.background.url,t.unchecked.text),a&&a.changeBackground(f.checked.background.url,f.checked.text)},updateVolumeProgress:function(e,t){var n=this.sceneProxy.settingsLayer.getByName(e+"progGroup");if(n){var a=n.getByName("pk"),o=n.getByName("progbk"),r=o.width;t<=0?a.width=.01:a.width=t*r}},addSettings:function(){var e=this,t=this.sceneProxy.json_data.template.json.settings,n=t.background,a=t.header,o=t.displayHeader,r=t.textHeader,i=t.displayCaption,l=t.textCaption,c=t.fullMode,u=t.windowMode,d=t.autoOn,h=t.autoOff,f=t.back,m=function(t,n,a,o,r){var i=e.game.add.group();i.x=o.x,i.y=o.y,i.name=t+"progGroup",e.sceneProxy.settingsLayer.add(i);var s=e.game.load.cache.checkImageKey(n)?n:"",l=e.game.load.cache.checkImageKey(a)?a:"",c=e.game.add.image(0,0,s,null,i);c.width=o.width,c.height=o.height,c.name="progbk";var u=e.game.add.image(0,0,l,null,i);u.width=o.width,u.height=o.height,u.name="progpk";var d=e.game.add.graphics(0,0);d.beginFill(16773120,.5),d.drawRect(0,0,o.width,o.height),d.endFill(),d.name="pk",i.add(d),u.mask=d;var h=!1;c.inputEnabled=!0;var f=c.width,m=0;e.game.time.events.stop(!1);var p=function(e){e<=0?d.width=.01:d.width=e*f};c.events.onInputDown.add(function(t,n){h=!0,m=(n.x-o.x)/f,p(m),e.game.time.events.start()},e),e.game.time.events.loop(10,function(){h&&(m=(e.game.input.x-o.x)/f,m<=0&&(m=0),m>=1&&(m=1),p(m))},e),e.game.input.onUp.add(function(){h&&(r&&r(m),e.game.time.events.stop(!1)),h=!1},e)},p=function(t,n,a){var o=e.game.load.cache.checkImageKey(t)?t:"",r=e.sceneProxy.settingsLayer.create(n.x,n.y,o);r.width=n.width,r.height=n.height,r.name=a},y=function(t,n,a,o,r,i,l){var c={},u="";u+=i.fontWeight?i.fontWeight+" ":"normal ",u+=i.fontSize?parseInt(i.fontSize)+"px ":"",u+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",c.font=u,c.fill=i.color,c.boundsAlignH="center",c.boundsAlignV="middle",c.stroke=i.stroke,c.strokeThickness=i.stroke?2:0;var d=e.game.add.text(0,0,r,c,e.sceneProxy.settingsLayer);if(d.name=l,s["default"].fontFamily){var h=i.color?i.color:"#fefefe",f=i.fontSize?parseInt(i.fontSize):25,m="";if(h.indexOf("rgb")!==-1){var p=h.replace("rgb(","").replace(")","").split(",");m="0x"+parseInt(p[0],16)+parseInt(p[1],16)+parseInt(p[2],16),"0xffffff"===m&&(m="0xfefefe")}else m=("#ffffff"===h?"#fefefe":h).replace("#","0x");var y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(f):f,g=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(f):f;d.colors.splice(0,d.colors.length),d.text=" ",d.fill=m,d.addColor(m,0),d.x=t+(a-g*r.length)/2,d.y=n+(o-y)/2,d.wordWrapWidth=g*(r.length+1),e.sceneProxy.addImageFontText([{data:r}],g,y,d,e.sceneProxy.context)}else d.setTextBounds(t,n+(d.height-parseInt(i.fontSize))/2,a,o);return i.hidden&&(d.visible=!1),d},g=function(t,n,a,o){var r={};r.normal=o?t.unchecked.text:t.normal.text,r.active=o?null:t.active.text,r.text=a;var i=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,o?null:t.normal.background.url,o?null:t.active.background.url,v,r,e.sceneProxy.btn_sound,n,e.sceneProxy.settingsLayer,o);return o&&i.changeBackground(t.unchecked.background.url,a),i},v=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("settings_button_fullMode"===t.parent.name?(e.fullMode(),e.sceneProxy.onSettingsFullModeBtnClicked()):"settings_button_windowMode"===t.parent.name?(e.windowMode(),e.sceneProxy.onSettingsWindowModeBtnClicked()):"settings_button_autoOn"===t.parent.name?(e.autoOn(),e.sceneProxy.onSettingsAutoOnBtnClicked()):"settings_button_autoOff"===t.parent.name?(e.autoOff(),e.sceneProxy.onSettingsAutoOffBtnClicked()):"settings_button_back"===t.parent.name&&(e.sceneProxy.isQuickPlay=!0,appCanBack(flashvars.client,flashvars.app_version,!1,"1"===flashvars.offline),e.sceneProxy.onSettingsBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null)))},x=this.sceneProxy.settingsLayer.create(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);if(x.width=this.game.world.width,x.height=this.game.world.height,x.name="settings_bk_main",x.inputEnabled=!0,p(a.background.url,a.rect),1!=a.title.text.hidden&&y(a.title.rect.x,a.title.rect.y,a.title.rect.width,a.title.rect.height,this.sceneProxy.stringMap.settings,a.title.text,"settings_text_header"),o.hidden||(p(o.background.url,o.rect),o.title.text.hidden||y(o.title.rect.x+o.rect.x,o.title.rect.y+o.rect.y,o.title.rect.width,o.title.rect.height,this.sceneProxy.stringMap.displayHeader,o.title.text,"settings_text_displayHeader")),r.hidden||(p(r.background.url,r.rect),r.title.text.hidden||y(r.title.rect.x+r.rect.x,r.title.rect.y+r.rect.y,r.title.rect.width,r.title.rect.height,this.sceneProxy.stringMap.textHeader,r.title.text,"settings_text_textHeader")),p(i.background.url,i.rect),i.text.hidden||y(i.rect.x,i.rect.y,i.rect.width,i.rect.height,this.sceneProxy.stringMap.displayCaption,i.text,"settings_text_displayCaption"),p(l.background.url,l.rect),l.text.hidden||y(l.rect.x,l.rect.y,l.rect.width,l.rect.height,this.sceneProxy.stringMap.textCaption,l.text,"settings_text_textCaption"),c.hidden||g(c,"settings_button_fullMode",this.sceneProxy.stringMap.fullMode,!0),u.hidden||g(u,"settings_button_windowMode",this.sceneProxy.stringMap.windowMode,!0),d.hidden||g(d,"settings_button_autoOn",this.sceneProxy.stringMap.autoOn,!0),h.hidden||g(h,"settings_button_autoOff",this.sceneProxy.stringMap.autoOff,!0),!f.hidden){var P=g(f,"settings_button_back",this.sceneProxy.stringMap.back);P.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}if(this.sceneProxy.json_data.template.json.settings.musicCaption){var w=this.sceneProxy.json_data.template.json.settings.musicCaption;p(w.background.url,w.rect),w.text.hidden||y(w.rect.x,w.rect.y,w.rect.width,w.rect.height,this.sceneProxy.stringMap.musicCaption,w.text,"settings_text_musicCaption")}if(this.sceneProxy.json_data.template.json.settings.musicVolume){var k=this.sceneProxy.json_data.template.json.settings.musicVolume;m("music",k.normal.background.url,k.progress.background.url,k.rect,function(t){e.sceneProxy.updateMusicVolume(t)})}if(this.sceneProxy.json_data.template.json.settings.soundCaption){var b=this.sceneProxy.json_data.template.json.settings.soundCaption;p(b.background.url,b.rect),b.text.hidden||y(b.rect.x,b.rect.y,b.rect.width,b.rect.height,this.sceneProxy.stringMap.soundCaption,b.text,"settings_text_soundCaption")}if(this.sceneProxy.json_data.template.json.settings.soundVolume){var C=this.sceneProxy.json_data.template.json.settings.soundVolume;m("sound",C.normal.background.url,C.progress.background.url,C.rect,function(t){e.sceneProxy.updateSoundVolume(t)})}if(this.sceneProxy.json_data.template.json.settings.volumeHeader){var _=this.sceneProxy.json_data.template.json.settings.volumeHeader;p(_.background.url,_.rect),_.title.text.hidden||y(o.title.rect.x+o.rect.x,o.title.rect.y+o.rect.y,o.title.rect.width,o.title.rect.height,this.sceneProxy.stringMap.volumeHeader,o.title.text,"settings_text_displayHeader")}this.sceneProxy.settingsLayer.visible=!1},showSettingsLayer:function(e){var t=this;0===this.sceneProxy.settingsLayer.children.length&&this.addSettings();var n=function(){t.game.scale.isFullScreen?(t.fullMode(),e.fullScreen=!0):(t.windowMode(),e.fullScreen=!1)},a=function(){e.auto?t.autoOn():t.autoOff()};this.fullScreenHandler||(this.fullScreenHandler=this.game.scale.onFullScreenChange.add(function(e){return n()})),(this.sceneProxy.json_data.template.json.settings.musicVolume||this.sceneProxy.json_data.template.json.settings.soundVolume)&&(this.sceneProxy.isQuickPlay=!1,appCanBack(flashvars.client,flashvars.app_version,!0,"1"===flashvars.offline)),n(),a(),this.updateVolumeProgress("sound",c["default"].soundVolume),this.updateVolumeProgress("music",c["default"].musicVolume),this.sceneProxy.settingsLayer.visible=!0,this.game.world.bringToTop(this.sceneProxy.settingsLayer)}},{NAME:"SettingsMediator"})}),require.register("___globals___",function(e,t,n){})}(),require("___globals___");
//# sourceMappingURL=app.js.map