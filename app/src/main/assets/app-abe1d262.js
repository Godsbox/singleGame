!function(){"use strict";var e="undefined"==typeof global?self:global;if("function"!=typeof e.require){var t={},n={},a={},o={}.hasOwnProperty,r=/^\.\.?(\/|$)/,i=function(e,t){for(var n,a=[],o=(r.test(t)?e+"/"+t:t).split("/"),i=0,s=o.length;i<s;i++)n=o[i],".."===n?a.pop():"."!==n&&""!==n&&a.push(n);return a.join("/")},s=function(e){return e.split("/").slice(0,-1).join("/")},l=function(t){return function(n){var a=i(s(t),n);return e.require(a,t)}},u=function(e,t){var a=y&&y.createHot(e),o={id:e,exports:{},hot:a};return n[e]=o,t(o.exports,l(e),o),o.exports},c=function(e){return a[e]?c(a[e]):e},d=function(e,t){return c(i(s(e),t))},h=function(e,a){null==a&&(a="/");var r=c(e);if(o.call(n,r))return n[r].exports;if(o.call(t,r))return u(r,t[r]);throw new Error("Cannot find module '"+e+"' from '"+a+"'")};h.alias=function(e,t){a[t]=e};var f=/\.[^.\/]+$/,m=/\/index(\.[^\/]+)?$/,p=function(e){if(f.test(e)){var t=e.replace(f,"");o.call(a,t)&&a[t].replace(f,"")!==t+"/index"||(a[t]=e)}if(m.test(e)){var n=e.replace(m,"");o.call(a,n)||(a[n]=e)}};h.register=h.define=function(e,a){if(e&&"object"==typeof e)for(var r in e)o.call(e,r)&&h.register(r,e[r]);else t[e]=a,delete n[e],p(e)},h.list=function(){var e=[];for(var n in t)o.call(t,n)&&e.push(n);return e};var y=e._hmr&&new e._hmr(d,h,t,n);h._cache=n,h.hmr=y&&y.wrap,h.brunch=!0,e.require=h}}(),function(){var e="undefined"==typeof window?this:window;require.register("js/AppConstants.js",function(e,t,n){"use strict";window.diygamePlayer={AppConstants:{CMD_STARTUP:"CMD_STARTUP",CMD_FRAME_ENTER:"CMD_FRAME_ENTER",CMD_SVG_MENU:"CMD_SVG_MENU",CMD_LOAD_GAME:"CMD_LOAD_GAME",CMD_UPDATE_MUSIC_STATE:"CMD_UPDATE_MUSIC_STATE",APP_DEBUG_MODE:"APP_DEBUG_MODE",APP_LOG:"APP_LOG",APP_SHOW_INSPECTOR:"APP_SHOW_INSPECTOR",APP_SHOW_MENUBAR:"APP_SHOW_MENUBAR",APP_FPS_UPDATE:"APP_FPS_UPDATE",STAGE_TRAP_MOUSE:"STAGE_TRAP_MOUSE",SCENE_SHOW_ERROR:"SCENE_SHOW_ERROR",SCENE_SHOW_SAVE_ALERT:"SCENE_SHOW_SAVE_ALERT",SCENE_SHOW_AD:"SCENE_SHOW_AD",SCENE_TOOGLE_SCREEN_STATE:"SCENE_TOOGLE_SCREEN_STATE",SCENE_SKIPPING:"SCENE_SKIPPING",SCENE_PRELOADING_BEGIN:"SCENE_PRELOADING_BEGIN",SCENE_PRELOADING_PROGRESS:"SCENE_PRELOADING_PROGRESS",SCENE_PRELOADING_COMPLETE:"SCENE_PRELOADING_COMPLETE",SCENE_LOADING_BEGIN:"SCENE_LOADING_BEGIN",SCENE_LOADING_PROGRESS:"SCENE_LOADING_PROGRESS",SCENE_LOADING_COMPLETE:"SCENE_LOADING_COMPLETE",SCENE_TEMPLATE_LOADED:"SCENE_TEMPLATE_LOADED",SCENE_SHOW_LOGO:"SCENE_SHOW_LOGO",SCENE_GOTO_COVERMENU:"SCENE_GOTO_COVERMENU",SCENE_GOTO_MAINMENU:"SCENE_GOTO_MAINMENU",SCENE_GOTO_SETTINGS:"SCENE_GOTO_SETTINGS",SCENE_GOTO_PLAYBACK:"SCENE_GOTO_PLAYBACK",SCENE_GOTO_RECORD:"SCENE_GOTO_RECORD",SCENE_GOTO_END:"SCENE_GOTO_END",SCENE_CLOSE_MENU:"SCENE_CLOSE_MENU",SCENE_PLOT_ANIM_BEGIN:"SCENE_PLOT_ANIM_BEGIN",SCENE_PLOT_SKIP:"SCENE_PLOT_SKIP",SCENE_PLOT_CLOSED:"SCENE_PLOT_CLOSED",SCENE_PLOT_LOAD_BEGIN:"SCENE_PLOT_LOAD_BEGIN",SCENE_PLOT_LOAD_ASSETS_READY:"SCENE_PLOT_LOAD_ASSETS_READY",SCENE_PLOT_LOAD_ASSETS_LOADED:"SCENE_PLOT_LOAD_ASSETS_LOADED",SCENE_PLOT_LOAD_END:"SCENE_PLOT_LOAD_END",SCENE_BACKGROUND_COLOR_UPDATE:"SCENE_BACKGROUND_COLOR_UPDATE",SCENE_BACKGROUND_UPDATE:"SCENE_BACKGROUND_UPDATE",SCENE_BACKGROUND_ENTERED:"SCENE_BACKGROUND_ENTERED",SCENE_BACKGROUND_SWITCH:"SCENE_BACKGROUND_SWITCH",SCENE_MUSIC_UPDATE:"SCENE_MUSIC_UPDATE",SCENE_SOUND_UPDATE:"SCENE_SOUND_UPDATE",SCENE_CHARACTER_UPDATE:"SCENE_CHARACTER_UPDATE",SCENE_PROP_UPDATE:"SCENE_PROP_UPDATE",SCENE_VIEW_UPDATE:"SCENE_VIEW_UPDATE",SCENE_DIALOG_UPDATE:"SCENE_DIALOG_UPDATE",SCENE_DIALOG_COMPLETE:"SCENE_DIALOG_COMPLETE",SCENE_CHECK_IF_SKIP:"SCENE_CHECK_IF_SKIP",SCENE_CLICK_ON_SCENE:"SCENE_CLICK_ON_SCENE",SCENE_OPTION_UPDATE:"SCENE_OPTION_UPDATE",SCENE_MENUBUTTON_UPDATE:"SCENE_MENUBUTTON_UPDATE",SCENE_WEATHER_UPDATE:"SCENE_WEATHER_UPDATE",SCENE_EFFECT_SHAKE:"SCENE_EFFECT_SHAKE",SCENE_EFFECT_TWINKLE:"SCENE_EFFECT_TWINKLE",SCENE_CLEAR:"SCENE_CLEAR",SCENE_SHOW_GUIDE:"SCENE_SHOW_GUIDE",ADD_PLAYBACK_CONTENT:"ADD_PLAYBACK_CONTENT",SCENE_DESTROY_VIEW:"SCENE_DESTROY_VIEW",SCENE_SHOW_INPUT_VIEW:"SCENE_SHOW_INPUT_VIEW"}}}),require.register("js/ApplicationFacade.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.ApplicationFacade",parent:r["default"].Facade},{startup:function(){this.initialized||(this.initialized=!0,this.registerCommand(diygamePlayer.AppConstants.CMD_STARTUP,diygamePlayer.controller.command.StartupCommand),this.sendNotification(diygamePlayer.AppConstants.CMD_STARTUP))}},{getInstance:function(e){var t=r["default"].Facade.instanceMap,n=t[e];return n?n:t[e]=new diygamePlayer.ApplicationFacade(e)},NAME:"diygamePlayer"})}),require.register("js/common/Dialog.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"showDialog",value:function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]&&arguments[5],i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];!this.isShow&&(this.isShow=!0);var u=this;return new Promise(function(c,d){var h=function(){document.body.removeChild(p),u.isShow=!1,c("ok")},f=function(){document.body.removeChild(p),u.isShow=!1,d("cancel")},m=function(){document.body.removeChild(p),u.isShow=!1,d("close")},p=document.createElement("div");p.classList.add("ModalContainer");var y=document.createElement("div");y.classList.add("ModalPortal"),document.body.clientWidth<=document.body.clientHeight&&(y.style.transform="rotate(90deg)"),window.onresize=function(){document.body.clientWidth<=document.body.clientHeight?flashvars.vertical?y.style.transform="rotate(0)":y.style.transform="rotate(90deg)":flashvars.vertical?y.style.transform="rotate(90deg)":y.style.transform="rotate(0)"},p.appendChild(y);var g=document.createElement("div");g.classList.add("Title");var v=document.createElement("span");v.innerText=e;var x=document.createElement("span");x.classList.add("spaceSpan");var P=document.createElement("span");P.classList.add("Close"),P.innerText="×",P.onclick=r?m:f,g.appendChild(v),g.appendChild(x),g.appendChild(P),y.appendChild(g);var w=document.createElement("div");w.classList.add("Content"),y.appendChild(w);var b=document.createElement("div");b.classList.add("ContentData"),n&&b.classList.add(n),b.innerText=t,w.appendChild(b);var k=document.createElement("div");k.classList.add("Buttons"),w.appendChild(k);var C=document.createElement("button"),_=document.createElement("button");if(C.classList.add("ButtonOk"),_.classList.add("ButtonsCancel"),C.innerText=a||"确定",_.innerText=o||"取消",k.appendChild(C),l!==!1&&k.appendChild(_),C.onclick=h,_.onclick=f,document.body.appendChild(p),i>0){var S=function I(e,t,n){t<=0?(e.removeAttribute("disabled"),e.style.background="#3DC826",e.style.backgroundColor="#3DC826",e.style.border="#3DC826",e.style.color="#FFFFFF",e.innerText=n):(e.setAttribute("disabled",!0),e.style.background="#8c8c8c",e.style.backgroundColor="#8c8c8c",e.style.color="#FFFFFF",e.style.border="#8c8c8c",e.innerText=t,t--,setTimeout(function(){I(e,t,n)},1e3))};0===s?S(C,i,C.innerText):1===s?S(_,i,_.innerText):2===s&&(S(C,i,C.innerText),S(_,i,_.innerText))}window.onresize()})}},{key:"info",value:function(e){if(!this.isShow)return this.showDialog("提示",e,"Info")}},{key:"warn",value:function(e){if(!this.isShow)return this.showDialog("警告",e,"Warn")}},{key:"error",value:function(e){if(!this.isShow)return this.showDialog("错误",e,"Error")}},{key:"custom",value:function(e,t,n,a,o,r,i,s){var l=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];return this.isShow?Promise.reject():this.showDialog(n,t,e,a,o,r,i,s,l)}}]),e}();e["default"]=r}),require.register("js/common/FontUtils.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t("./Utils.js"),s=a(i),l=function(){function e(){o(this,e)}return r(e,null,[{key:"isFontExist",value:function(e){var t=["Microsoft YaHei","Helvetica","sans-serif","serif"],n="qwertyuiopasdfghjklzxcvbnm",a="72px",o=document.createElement("span");if(o.style.fontSize=a,o.innerHTML=n,!this.defaultWidth||!this.defaultHeight){this.defaultWidth={},this.defaultHeight={};for(var r in t)o.style.fontFamily=t[r],document.body.appendChild(o),this.defaultWidth[t[r]]=o.offsetWidth,this.defaultHeight[t[r]]=o.offsetHeight,document.body.removeChild(o)}var i=!1;for(var s in t){o.style.fontFamily=e+","+t[s],document.body.appendChild(o);var l=o.offsetWidth!=this.defaultWidth[t[s]]||o.offsetHeight!=this.defaultHeight[t[s]];document.body.removeChild(o),i=i||l}return i}},{key:"mergeFontImage",value:function(t,n){var a=this,o=[];return t.size?t.size.target.width?(this.charWidth=t.size.target.width,this.charHeight=t.size.target.height):(this.charWidth=t.size.target,this.charHeight=t.size.target):(this.charWidth=n,this.charHeight=n),this.widthImg=this.countPerRow*this.charWidth,this.heightImg=this.rowPerImg*this.charHeight,new Promise(function(n,r){if(!t)return n();if(a.isFontExist(t.fontFamily))return n();e.fontFamily=t.fontFamily;for(var i=0;i<t.images.length;i++)o[i]="https://apppic.3000test.com"+t.images[i].url,a.fontChars+=t.images[i].chars;var l=document.createElement("canvas"),u=l.getContext("2d"),c=o.length,d=Math.ceil(a.fontChars.length/a.countPerRow);l.width=a.widthImg,l.height=d*a.charHeight;var h=function f(t){if(!(t<c)){var r=l.toDataURL("image/png",1),i=s["default"].dataURLtoBlob(r),h=i?URL.createObjectURL(i):r;return a.fontImage=h,n()}var m=new Image,p=t===c-1?d%a.rowPerImg*a.charHeight:a.heightImg;m.src=o[t],m.onload=function(){return u.drawImage(m,0,0,e.widthImg,p,0,t*e.heightImg,e.widthImg,p),f(t+1)}};return h(0)})}},{key:"getCharSpace",value:function(e,t){return/[a-zA-Z0-9]/.test(e)?14*t/25:"("===e||")"===e?8*t/25:"-"===e?11*t/25:"."===e||":"===e?7:32===e.charCodeAt(0)||160===e.charCodeAt(0)||" "===e?t>>1:t}},{key:"getLeftMargin",value:function(e,t){return/[a-zA-Z0-9\.\)]/.test(e)?0:"("===e||":"===e?-(4*t/25):"-"===e?-(t/25):6*t/25}}]),e}();e["default"]=l,l.defaultWidth=void 0,l.defaultHeight=void 0,l.fontImage=void 0,l.fontChars="",l.fontFamily="",l.charWidth=25,l.charHeight=25,l.countPerRow=40,l.rowPerImg=20,l.widthImg=1e3,l.heightImg=500}),require.register("js/common/OtherWap.js",function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.H54399Api=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=t("spark-md5"),l=o(s),u=t("./Utils.js"),c=o(u),d=t("./XmlHttpRequest.js"),h=a(d),f=t("./Dialog.js"),m=o(f),p=function(){function e(){r(this,e)}return i(e,null,[{key:"initQHSdk",value:function(){var e=function(e){return new Promise(function(t,n){var a=document.getElementsByTagName("head").item(0),o=document.createElement("script");o.type="text/javascript",o.src=e,a.appendChild(o),o.onload=function(){return t("QHSKD INIT SUCCESS")}})};return e("//port.2r3r.com/game/qhjssdk").then(function(e){var t={username:flashvars.qh_username,gid:flashvars.qh_qhgid,qhchannel:flashvars.qh_qhchannel,qhchannelid:flashvars.qh_qhchannelid};return window.qhsdk.init(t),Promise.resolve(e)})}},{key:"pay",value:function(e,t,n,a,o,r,i){var s=l["default"].hash(e.toString()+flashvars.qh_username+n+flashvars.qh_key),u={userId:flashvars.qh_username,gid:flashvars.qh_qhgid,goodsId:t,goodsName:e+"闪币",money:e,roleName:"3000闪艺",ext:n,serverId:flashvars.qh_serverid,sign:s};1===r&&(o.payValues[0].name=encodeURI(o.payValues[0].name));var d={game_id:flashvars.gid,uuid:flashvars.uuid,chapter_uuid:a,amount:e,set_value:0===r?"":c["default"].encodeBase64(JSON.stringify(o.payValues)),payindex:r,ext:n,event_id:t,qh_username:flashvars.qh_username,qh_qhgid:flashvars.qh_qhgid},f=function(e,t){h.xhrSend(e,t,null,4e3).then(function(e){},function(e){})};f("https://pay.3000.com/qunhei/paydata.php",JSON.stringify(d)),window.qhsdk.pay(u,function(){console.log("群黑充值返回")}),c["default"].timeout(200).then(function(){0===r?m["default"].custom("Info","如果购买成功则点击继续观看作品，如果暂不购买则不能继续。","是否支付成功？","已支付成功","暂不购买",!1).then(function(){i&&i("success")},function(){i&&i("cancel")}):m["default"].custom("Info","若已支付成功，作品将会刷新，可读取存档继续观看。若暂不购买，将返回商城。","是否支付成功？","已支付成功","暂不购买",!1).then(function(){window.location.reload()},function(){i&&i()})})}},{key:"sendQHData",value:function(){var e=function(e,t){return h.xhrSend(e,t,null,4e3).then(function(e){if(0===e.responseText.length)return Promise.reject("Get failed, no response data");var t=JSON.parse(e.responseText);return 0===t.status&&t.success===!0&&t.data?(flashvars.uid=t.data.uid,flashvars.token=t.data.token,flashvars.u=t.data.u,Promise.resolve()):void 0},function(e){})},t={qh_username:flashvars.qh_username,qh_serverid:flashvars.qh_serverid,qh_time:flashvars.qh_time,qh_isadult:flashvars.qh_isadult,qh_flag:flashvars.qh_flag,qh_uid:flashvars.qh_uid,qh_nname:c["default"].encodeBase64(flashvars.qh_nname),qh_qhchannel:flashvars.qh_qhchannel,qh_qhchannelid:flashvars.qh_qhchannelid,refresh_token:1};return e("https://ptlogin.3000.com/?m=ptlogin&ac=qhlogin",JSON.stringify(t))}}]),e}();e["default"]=p;e.H54399Api=function(){function e(){r(this,e)}return i(e,null,[{key:"init4399Api",value:function(){var e=function(e){return new Promise(function(t,n){var a=document.getElementsByTagName("head").item(0),o=document.createElement("script");o.type="text/javascript",o.src=e,a.appendChild(o),o.onload=function(){return t("4399API INIT SUCCESS")}})};return e("//h.api.4399.com/h5mini-2.0/h5api-interface.php").then(function(e){return Promise.resolve(e)})}},{key:"playAd",value:function(){return new Promise(function(e,t){try{window.h5api.playAd(function(t){return 1e4!==t.code?10001===t.code?(console.log("播放结束"),e({success:!0,msg:"成功"})):(console.log("广告异常"),e({success:!1,msg:t.message})):void console.log("开始播放")})}catch(n){return e({success:!1,msg:"广告播放异常！"})}})}},{key:"canPlayAd",value:function(){return new Promise(function(e,t){try{window.h5api.canPlayAd(function(t){if(t){var n=t.canPlayAd,a=parseInt(t.remain);return e({canplay:n,remain:a})}return e({canplay:!1,remain:0})})}catch(n){return e({canplay:!1,remain:0})}})}}]),e}()}),require.register("js/common/PhoneUtils.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"loadAudioUrl",value:function(e){function t(t,n,a){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,n){if(this.loadingAudioMap[e]=!0,this.audioErrorResourceRef[e]=0,"ios"===flashvars.client){var a={key:e,url:t,local:n};this.audioCountLoadByPhone.total++,"1"===flashvars.offline?loadAudioUrl(JSON.stringify(a)):window.webkit&&window.webkit.messageHandlers.loadAudioUrl.postMessage(JSON.stringify(a))}})},{key:"playMusic",value:function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=e?e:this.musicKey,r=t||0===t?t:1,i=void 0===n||null===n||n;this.musicInfo.key=o,this.musicInfo.volume=r*a,this.musicInfo.prevolume=r,this.musicInfo.inheritvolume=-1,this.musicInfo.tweenId=parseInt(100*Math.random()),this.playAudioUrl(o,r,i,"music",a)}},{key:"stopMusic",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.stopAudioUrl("music"),e&&(this.musicInfo.key="")}},{key:"playInheritMusic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.musicInfo.inheritvolume=e,this.setAudioUrlVolume("music",e*t)}},{key:"tweenFromMusic",value:function(e,t,n){var a=this;return new Promise(function(o,r){if(t<=10)return a.musicInfo.volume=e,a.setAudioUrlVolume("music",e),o();var i=t/20,s=(a.musicInfo.volume-e)/i,l=e;a.musicInfo.tweenId=parseInt(100*Math.random());var u=a.musicInfo.tweenId,c=function d(){var t=a;return function(){return(t.musicInfo.volume>l&&s>0||t.musicInfo.volume<l&&s<0)&&u===t.musicInfo.tweenId?(l+=s,l>1?l=1:l<0&&(l=0),t.setAudioUrlVolume("music",l),t.musicInfo.volume=l,setTimeout(d(),20),void 0):(t.musicInfo.volume=e,t.musicInfo.prevolume=e,o())}};setTimeout(c(),n)})}},{key:"tweenToMusic",value:function(e,t,n){var a=this;return new Promise(function(o,r){if(t<=10)return a.musicInfo.volume=e,a.setAudioUrlVolume("music",e),o();var i=t/20,s=(e-a.musicInfo.volume)/i,l=a.musicInfo.volume;a.musicInfo.tweenId=parseInt(100*Math.random());var u=a.musicInfo.tweenId,c=function d(){var t=a;return function(){return(l>e&&s<0||l<e&&s>0)&&u===t.musicInfo.tweenId?(l+=s,l<0?l=0:l>1&&(l=1),t.setAudioUrlVolume("music",l),t.musicInfo.volume=l,setTimeout(d(),20),void 0):(t.musicInfo.volume=e,t.musicInfo.prevolume=e,o())}};setTimeout(c(),n)})}},{key:"tweenToSound",value:function(e,t,n,a){var o=this;return new Promise(function(r,i){if(!o.soundsInfo[e].key)return r();if(n<=10)return o.soundsInfo[e].volume=t,o.setAudioUrlVolume("sound"+e,t),r();var s=n/20,l=(t-o.soundsInfo[e].volume)/s,u=o.soundsInfo[e].volume;o.soundsInfo[e].tweenId=parseInt(100*Math.random());var c=o.soundsInfo[e].tweenId,d=function h(){var n=o;return function(){return(u>t&&l<0||u<t&&l>0)&&c===n.soundsInfo[e].tweenId?(u+=l,u<0?u=0:u>1&&(u=1),n.setAudioUrlVolume("sound"+e,u),n.soundsInfo[e].volume=u,setTimeout(h(),20),void 0):(n.soundsInfo[e].volume=t,n.soundsInfo[e].prevolume=t,r())}};setTimeout(d(),a)})}},{key:"stopSound",value:function(e){if(e===-1)for(var t=0;t<this.soundsInfo.length;t++){var n=this.soundsInfo[t];n&&n.key&&this.stopAudioUrl("sound"+t)}else{var a=this.soundsInfo[e].key;a&&this.stopAudioUrl("sound"+e),this.soundsInfo[e].key=""}}},{key:"playSound",value:function(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,r=t?t:this.soundsInfo[e].key,i=n||0===n?n:1,s=void 0===a||null===a||a;this.soundsInfo[e].key=r,this.soundsInfo[e].volume=i*o,this.soundsInfo[e].loop=s,this.soundsInfo[e].prevolume=i,this.soundsInfo[e].inheritvolume=-1,this.soundsInfo[e].tweenId=parseInt(100*Math.random()),this.playAudioUrl(r,i,s,"sound"+e,o)}},{key:"playInheritSound",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.soundsInfo[e].inheritvolume=t,this.setAudioUrlVolume("sound"+e,t*n)}},{key:"playAudioUrl",value:function(e){function t(t,n,a,o){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,n,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if("ios"===flashvars.client){var r={key:e,volume:t*o,loop:n?1:0,channel:a};1==flashvars.offline?playAudioUrl(JSON.stringify(r)):window.webkit&&window.webkit.messageHandlers.playAudioUrl.postMessage(JSON.stringify(r))}})},{key:"stopAudioUrl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if("ios"===flashvars.client){var t={channel:e};1==flashvars.offline?stopAudioUrl(JSON.stringify(t)):window.webkit&&window.webkit.messageHandlers.stopAudioUrl.postMessage(JSON.stringify(t))}})},{key:"updateMusicVolume",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.musicInfo){var n=void 0!==this.musicInfo.inheritvolume&&this.musicInfo.inheritvolume!==-1?this.musicInfo.inheritvolume*t:this.musicInfo.prevolume*t;this.setAudioUrlVolume(e,n)}}},{key:"updateSoundVolume",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.soundsInfo&&this.soundsInfo.length>0)for(var n=0;n<this.soundsInfo.length;n++){var a=this.soundsInfo[n];if(a){var o=void 0!==a.inheritvolume&&a.inheritvolume!==-1?a.inheritvolume*t:a.prevolume*t;this.setAudioUrlVolume(e+n,o)}}}},{key:"setAudioUrlVolume",value:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){if("ios"===flashvars.client){var n={channel:e,volume:t};n.volume||0===n.volume||(n.volume=1),"music"===e&&(this.musicInfo.volume=n.volume),"1"===flashvars.offline?setAudioUrlVolume(JSON.stringify(n)):window.webkit&&window.webkit.messageHandlers.setAudioUrlVolume.postMessage(JSON.stringify(n))}})},{key:"removeAudioUrl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if(e!==this.musicInfo.key&&!this.soundsInfo.some(function(t){return e===t})){var t={key:e};this.audioResourceRef[e]=0,1==flashvars.offline?removeAudioUrl(JSON.stringify(t)):window.webkit&&window.webkit.messageHandlers.removeAudioUrl.postMessage(JSON.stringify(t))}})},{key:"isAudioInCache",value:function(e){return!!this.audioResourceRef[e]}},{key:"isAudioError",value:function(e){return!!this.audioErrorResourceRef[e]}},{key:"isLoadingAudio",value:function(e){return!!this.loadingAudioMap[e]}},{key:"audioCanPlayCallBack",value:function(e){delete this.loadingAudioMap[e],this.audioCountLoadByPhone.loaded++,this.load.onSoundExtendLoad.dispatch(e),this.audioResourceRef[e]=1}},{key:"audioErrorCallBack",value:function(e){delete this.loadingAudioMap[e],this.audioCountLoadByPhone.loaded++,this.load.onSoundExtendLoadError.dispatch(e),this.audioResourceRef[e]=0,this.audioErrorResourceRef[e]=1}}]),e}();e["default"]=r,r.loadingAudioMap={},r.audioCountLoadByPhone={loaded:0,total:0},r.load=null,r.musicInfo={key:"",volume:1,tweenId:0},r.soundsInfo=[{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0}],r.audioResourceRef=[],r.audioErrorResourceRef=[]}),require.register("js/common/RePhaser.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t("./Utils.js"),s=a(i),l=function(){function e(){o(this,e)}return r(e,null,[{key:"updateText",value:function(){this.texture.baseTexture.resolution=this._res,this.context.font=this.style.font;var e=this.text;this.style.wordWrap&&(e=this.runWordWrap(this.text),this.realText=e);var t=e.split(/(?:\r\n|\r|\n)/),n=this.style.tabs,a=[],o=0,r=this.determineFontProperties(this.style.font),i=t.length;this.style.maxLines>0&&this.style.maxLines<t.length&&(i=this.style.maxLines),this._charCount=0;for(var s=0;s<i;s++){if(0===n){var l=this.style.strokeThickness+this.padding.x;l+=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(t[s]):this.context.measureText(t[s]).width}else{var u=t[s].split(/(?:\t)/),l=this.padding.x+this.style.strokeThickness;if(Array.isArray(n))for(var c=0,d=0;d<u.length;d++){var h=0;h=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(u[d]):Math.ceil(this.context.measureText(u[d]).width),d>0&&(c+=n[d-1]),l=c+h}else for(var d=0;d<u.length;d++){l+=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(u[d]):Math.ceil(this.context.measureText(u[d]).width);var f=this.game.math.snapToCeil(l,n)-l;l+=f}}a[s]=Math.ceil(l),o=Math.max(o,a[s])}this.canvas.width=o*this._res;var m=r.fontSize+this.style.strokeThickness+this.padding.y,p=m*i,y=this._lineSpacing;0>y&&Math.abs(y)>m&&(y=-m),0!==y&&(p+=y>0?y*t.length:y*(t.length-1)),this.canvas.height=(p-4)*this._res,this.context.scale(this._res,this._res),navigator.isCocoonJS&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.style.backgroundColor&&(this.context.fillStyle=this.style.backgroundColor,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)),this.context.fillStyle=this.style.fill,this.context.font=this.style.font,this.context.strokeStyle=this.style.stroke,this.context.textBaseline="alphabetic",this.context.lineWidth=this.style.strokeThickness,this.context.lineCap="round",this.context.lineJoin="round";var g,v,s;for(this._charCount=0,s=0;i>s;s++)g=this.style.strokeThickness/2,v=this.style.strokeThickness/2+s*m+r.ascent,s>0&&(v+=y*s),"right"===this.style.align?g+=o-a[s]:"center"===this.style.align&&(g+=(o-a[s])/2),this.autoRound&&(g=Math.round(g),v=Math.round(v)),this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.updateLine(t[s],g,v):(this.style.stroke&&this.style.strokeThickness&&(this.updateShadow(this.style.shadowStroke),0===n?this.context.strokeText(t[s],g,v):this.renderTabLine(t[s],g,v,!1)),this.style.fill&&(this.updateShadow(this.style.shadowFill),0===n?this.context.fillText(t[s],g,v):this.renderTabLine(t[s],g,v,!0)));this.updateTexture()}},{key:"advancedWordWrap",value:function(e){for(var t=this.context,n=this.style.wordWrapWidth,a="",o=e.split(/\r?\n/gi),r=o.length,i=0;i<r;i++){var s=o[i],l=t.measureText(s).width;if(l<n)a+=s+"\n";else for(var u=function(e,t){if(!e||!t||/\s/.test(e)||/\s/.test(t))return!1;var n=/[\u4E00-\u9FA5\uF900-\uFA2D]|\s/,a=new RegExp("[!！)）|}':;',\\].>》/?……）\\-|}】‘；：”“’。，、？]"),o=new RegExp("[!！?？:：;；.。》』\\-\\]】）]");return n.test(e)&&a.test(t)||!n.test(e)&&!n.test(t)&&!o.test(e)},c=s,d=0;;){var h=-1,f="",m=t.measureText(c).width;if(!(m>n)){c&&(a+=c+"\n"),d=0;break}for(var p=0;c[p]&&(f+=c[p],m=t.measureText(f).width,h=u(c[p-1],c[p])?h:p-1,p++,m<n););if(h!==-1&&h!==f.length-1?(f&&(f=f.slice(0,h+1)),c=c.substr(f.length).trimLeft()):(f&&(f=f.slice(0,-1)),c=c.substr(f.length).trimLeft()),d++,a+=f+"\n",d>4){for(;a.length&&"\n"===a[a.length-1];)a=a.substring(0,a.length-1);c&&(a+="\n"+c+"\n"),d=0;break}}}return a=a.replace(/\n$/gi,"")}},{key:"loadImageTag",value:function(e){var t=this,n=function(n){var a=n.requestObject.response,o=void 0;a instanceof ArrayBuffer&&(o=new Uint8Array(a));var r=!1;o[0]!=="G".charCodeAt()||o[1]!=="I".charCodeAt()||o[2]!=="F".charCodeAt()||o[3]!=="8".charCodeAt()||o[4]!=="9".charCodeAt()&&!"7".charCodeAt()||o[5]!=="a".charCodeAt()||(r=!0),e.data=new Image,e.data.name=e.key,t.crossOrigin&&(e.data.crossOrigin=t.crossOrigin);var i=function(){e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))};e.data.onload=function(){URL.revokeObjectURL(e.url),i()},e.data.onerror=function(){URL.revokeObjectURL(e.url),e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileError(e))},r?s["default"].spliceGif(a).then(function(n){e.data.frames=n.frames,e.data.loopCount=n.loopCount,e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)},function(){e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)}):(e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)),e.data.complete&&e.data.width&&e.data.height&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))};this.xhrLoad(e,this.transformUrl(e.url,e),"arraybuffer",n)}},{key:"soundStop",value:function(){var e=this;if(this.isPlaying&&this._sound)if(this.usingWebAudio){if(this.externalNode){var t=this._sound.onended;this._sound.onended=function(){e._sound.disconnect(e.externalNode),t&&t()}}else if(this.gainNode){var n=this._sound.onended;this._sound.onended=function(){e._sound.disconnect(e.gainNode),n&&n()}}if(void 0===this._sound.stop)this._sound.noteOff(0);else try{this._sound.stop(0)}catch(a){alert(a)}}else this.usingAudioTag&&(this._sound.pause(),this._sound.currentTime=0);if(this.pendingPlayback=!1,this.isPlaying=!1,!this.paused){var o=this.currentMarker;""!==this.currentMarker&&this.onMarkerComplete.dispatch(this.currentMarker,this),this.currentMarker="",null!==this.fadeTween&&this.fadeTween.stop(),this.onStop.dispatch(this,o)}}},{key:"soundDecode",value:function(e,t){var n=this;t=t||null;var a=this.game.cache.getSoundData(e);if(a&&this.game.cache.isSoundDecoded(e)===!1){this.game.cache.updateSound(e,"isDecoding",!0);var o=this,r=function(){n.onSoundDecodeError.dispatch(e),console.warn("Unable to encode audio "+e)};try{this.context.decodeAudioData(a,function(n){n&&(o.game.cache.decodedSound(e,n),o.onSoundDecode.dispatch(e,t))})["catch"](r)}catch(i){r()}}}},{key:"loadAudioTag",value:function(e){var t=this,n=e.url;n.indexOf("?")>=0&&(n=n.substr(0,n.indexOf("?")));var a=n.substr((Math.max(0,n.lastIndexOf("."))||1/0)+1),o="dat"===a.toLowerCase(),r=function(e){if(t.game.sound.touchLocked)e.data=i.AudioTagPool.get(),e.data.name=e.key,e.data.src=t.transformUrl(e.url,e),t.fileComplete(e);else{var n=i.AudioTagPool.get();if(e.data=n,e.data.name=e.key,!i.AudioTagPool.exist(n))return t.game.sound.touchLocked=!0,e.data.src=t.transformUrl(e.url,e),void t.fileComplete(e);var a=null,o=function l(){a&&clearTimeout(a),e.data.removeEventListener("canplaythrough",l,!1),e.data.removeEventListener("abort",r,!1),e.data.removeEventListener("error",r,!1),e.data.removeEventListener("interruptend",r,!1),e.data.removeEventListener("interruptbegin",r,!1),e.data.onabort=e.data.onerror=null,t.fileComplete(e)},r=function u(){a&&clearTimeout(a),e.data.removeEventListener("canplaythrough",o,!1),e.data.removeEventListener("abort",u,!1),e.data.removeEventListener("error",u,!1),e.data.removeEventListener("interruptend",u,!1),e.data.removeEventListener("interruptbegin",u,!1),e.data.onabort=e.data.onerror=null,t.fileComplete(e)};e.data.addEventListener("canplaythrough",o,!1),e.data.addEventListener("abort",r,!1),e.data.addEventListener("error",r,!1),e.data.addEventListener("interruptend",r,!1),e.data.addEventListener("interruptbegin",r,!1),e.data.src=t.transformUrl(e.url,e),navigator.userAgent.indexOf("Firefox")>-1&&(e.data.preload="auto",a=setTimeout(function(){a&&clearTimeout(a),t.fileComplete(e)},3e3));try{e.data.load()}catch(s){a&&clearTimeout(a),t.fileComplete(e)}}},s=function(e){return t.game.device.android?void r(e):void t.xhrLoad(e,t.transformUrl(e.url,e),"arraybuffer",function(e,t){e.url=URL.createObjectURL(new Blob([t.response],{type:"audio/mp3"})),e.isDatFile=!0,r(e)})};o?s(e):r(e)}},{key:"tintWithMultiply",value:function(e,t,n){var a=n.getContext("2d"),o=e.crop,r=o.width,i=o.height;e.rotated&&(r=i,i=o.width),n.width===r&&n.height===i||(n.width=r,n.height=i),a.clearRect(0,0,r,i),a.drawImage(e.baseTexture.source,o.x,o.y,r,i,0,0,r,i),a.globalCompositeOperation="source-atop",a.fillStyle="#"+("00000"+(0|t).toString(16)).substr(-6),
a.fillRect(0,0,r,i)}}]),e}();e["default"]=l,function(){PIXI.CanvasTinter.tintWithMultiply=l.tintWithMultiply,Phaser.Game.prototype.destroyComponent=new Phaser.Signal;var e=Phaser.Sprite.prototype.destroy;Phaser.Sprite.prototype.destroy=function(){var t=this.game;e.apply(this,arguments),t&&t.destroyComponent&&t.destroyComponent.dispatch(this.key||null)};var t=Phaser.Sprite.prototype._renderCanvas;Phaser.Sprite.prototype._renderCanvas=function(){try{t.apply(this,arguments)}catch(e){}};var n=Phaser.Image.prototype.destroy;Phaser.Image.prototype.destroy=function(){var e=this.game;n.apply(this,arguments),e&&e.destroyComponent&&e.destroyComponent.dispatch(this.key||null)};var a=Phaser.Button.prototype.destroy;Phaser.Button.prototype.destroy=function(){var e=this;Object.keys(this).forEach(function(t){e.hasOwnProperty(t)&&e[t]instanceof Phaser.Sound&&e[t].destroy()}),a.apply(this,arguments)};var o=new Set;Phaser.Loader.prototype.forceRemoveFile=function(e,t){var n=this,a=this.getAsset(e,t);if(a)if(a.loaded||a.loading){forceRemoveFileKeys.add(t);var r=function(){o.has(t)&&("audio"===e&&n.cache.checkSoundKey(t)&&n.cache.removeSound(t),"image"===e&&n.cache.checkImageKey(t)&&n.cache.removeImage(t),o["delete"](t))},i=function s(e,a,o,i,l){a==t&&(r(),n.onFileComplete.remove(s))};a.loaded&&r(),a.loading&&this.onFileComplete.add(i)}else this._fileList.splice(a.index,1)},Phaser.Loader.prototype.cancelForceRemoveFile=function(e,t){o["delete"](t)},Phaser.Loader.prototype.loadAudioTag=l.loadAudioTag;var r=Phaser.Sound.prototype.destroy;Phaser.Sound.prototype.destroy=function(){if(r.apply(this,arguments),this.usingWebAudio){this.game.sound.context&&!this.game.sound.scratchBuffer&&(this.game.sound.scratchBuffer=this.game.sound.context.createBuffer(1,1,22050));try{this._sound.buffer=this.game.sound.scratchBuffer}catch(e){}}this._sound=null},Phaser.Cache.prototype.reloadSound=function(e){var t=this,n=this.getSound(e);if(n&&!i.AudioTagPool.exist(n.data)){var a=i.AudioTagPool.get();if(!i.AudioTagPool.exist(a))return;n.data=a,n.data.src=n.url,n.data.addEventListener("canplaythrough",function(){return t.reloadSoundComplete(e)},!1),n.data.load()}},Phaser.Device.canPlayAudio=function(e){return!("mp3"!==e||!this.mp3)||(!("ogg"!==e||!this.ogg&&!this.opus)||(!("m4a"!==e||!this.m4a)||(!("opus"!==e||!this.opus)||(!("wav"!==e||!this.wav)||(!("webm"!==e||!this.webm)||(!("mp4"!==e||!this.dolby)||"dat"===e))))))},Phaser.SoundManager.prototype.setMute=function(){if(!this._muted){this._muted=!0,this.usingWebAudio&&(this._muteVolume=this.masterGain.gain.value,this.masterGain.gain.value=0);for(var e=0;e<this._sounds.length;e++)this._sounds[e].usingAudioTag&&(this.game.device.iOS&&this._sounds[e].pause(),this._sounds[e].mute=!0);this.onMute.dispatch()}},Phaser.SoundManager.prototype.unsetMute=function(){if(this._muted&&!this._codeMuted){this._muted=!1,this.usingWebAudio&&(this.masterGain.gain.value=this._muteVolume);for(var e=0;e<this._sounds.length;e++)this._sounds[e].usingAudioTag&&(this.game.device.iOS&&this._sounds[e].resume(),this._sounds[e].mute=!1);this.onUnMute.dispatch()}}}()}),require.register("js/common/ShanyiMenu.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"showSyMenu",value:function(){!this.isShow&&(this.isShow=!0);var e=this;return new Promise(function(t,n){var a=function(){document.body.removeChild(r),e.isShow=!1,t(1)},o=function(n){document.body.removeChild(r),e.isShow=!1,t(n)};gameCallback.syMenuBack=a,gameCallback.syMenuExit=o;var r=document.createElement("div");r.classList.add("syModalContainer");var i=document.createElement("div");i.classList.add("syModalPortal"),document.body.clientWidth<=document.body.clientHeight&&(i.style.transform=flashvars.vertical?"rotate(0)":"rotate(90deg)"),window.onresize=function(){document.body.clientWidth<=document.body.clientHeight?i.style.transform=flashvars.vertical?"rotate(0)":"rotate(90deg)":i.style.transform=flashvars.vertical?"rotate(90deg)":"rotate(0)"},r.appendChild(i);var s=document.createElement("div");s.classList.add("syContent"),i.appendChild(s),flashvars.vertical&&(s.style.width="320px",s.style.height="510px");var l=document.createElement("iframe");l.src="https://www.3000.com/popup.html?uuid="+flashvars.uuid+"&wap="+flashvars.wap+"&vertical="+(flashvars.vertical?1:0),l.scrolling="no",l.width="100%",l.height="100%",l.frameBorder="0",s.appendChild(l),document.body.appendChild(r)})}}]),e}();e["default"]=r}),require.register("js/common/Utils.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e,t){var n={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(n[a]=e[a]);return n}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.AudioTagPool=e.ResourcesManager=void 0;var l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),c=t("./XmlHttpRequest.js"),d=o(c),h=t("./Version.js"),f=(a(h),t("js-base64")),m=t("crypto-js"),p=a(m),y=t("spark-md5"),g=a(y),v=t("./PhoneUtils.js"),x=a(v),P=function(){function e(){s(this,e)}return u(e,null,[{key:"getWeatherFilePathName",value:function(e){return flashvars.vertical?e+"_1":e}},{key:"getWeatherOfflinePathName",value:function(){return"1"===flashvars.offline,"weather"}},{key:"convertToAllowAccessControlOriginUrl",value:function(e){if(!e)return Promise.resolve("");if("http://f1.img4399.com/ma~217_20160518155234_573c1f42bb260.jpeg"===e)return Promise.resolve("https://apppic.3000test.com/m~web/41/2017/02/08/09_j1sGyq.960x540.jpg");if("/"===e[0]&&(e=e.substring(1)),/blob:/i.test(e))return Promise.reject(e);var t=void 0,n=e.indexOf("://");if(n>-1){var a=e.split("/");a.shift(),a.shift(),a.shift(),t="https://apppic.3000test.com/"+a.join("/")}else t="https://apppic.3000test.com/"+e;return"1"===flashvars.offline&&(t="game"+flashvars.gid+"/"+t.substring(28)),Promise.resolve(t)}},{key:"convertSingleJsonPath",value:function(e){var t="";return"1"===flashvars.offline&&flashvars.single&&(t="game"+flashvars.gid+"/json/"+e+".json"),t}},{key:"spliceGif",value:function(e){var t=this;return new Promise(function(n,a){var o=void 0,r=0,s=void 0,l=document.createElement("canvas"),u=document.createElement("canvas"),c=void 0,d=void 0,h=null,f=null,m=null,p=null,y=null,g=1,v=[],x=function(e){return e.reduce(function(e,t){return 2*e+t},0)},P=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},w=function(e){o=e,r=0,this.readByte=function(){if(r>=e.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[r++]:255&e.charCodeAt(r++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},b=function(e,t){var n=0,a=function(e){for(var a=0,o=0;o<e;o++)t[n>>3]&1<<(7&n)&&(a|=1<<o),n++;return a},o=1<<e,r=o+1,i=e+1,s=4096,l=4096,u=new Uint8Array(s),c=new Uint8Array(l),d=[],h=0,f=0,m=function(){for(var e=0;e<o;e++)d[e]=new Uint8Array(1),d[e][0]=e;d[o]=new Uint8Array(0),d[r]=null},p=function(){var t=o+2;d.splice(t,d.length-t),i=e+1,h=0},y=function(){var e=u.length+s,t=new Uint8Array(e);t.set(u),u=t,s<<=1},g=function(){var e=c.length+l,t=new Uint8Array(e);t.set(c),c=t,l<<=1},v=function(e,t){for(var n=d[t].byteLength+1;h+n>c.length;)g();var a=c.subarray(h,h+n);a.set(d[t]),a[n-1]=d[e][0],h+=n,d.push(a)},x=void 0,P=void 0;for(m();;)if(P=x,x=a(i),x!==o){if(x===r)break;if(x<d.length)P!==o&&v(x,P);else{if(x!==d.length)throw new Error("Invalid LZW code.");v(P,P)}for(var w=d[x].length;f+w>u.length;)y();u.set(d[x],f),f+=w,d.length===1<<i&&i<12&&i++}else p();return u.subarray(0,f)},k=function(e,t){l.width=e,l.height=t,l.style.width=e+"px",l.style.height=t+"px",l.getContext("2d").setTransform(1,0,0,1,0,0),u.width=e,u.height=e},C=function(){h=null,f=null,d=m,m=null,c=null},_=function(e){s=e,k(s.width,s.height)},S=function(e){I(),C(),h=e.transparencyGiven?e.transparencyIndex:null,f=e.delayTime,m=e.disposalMethod},I=function(){if(c){var e=l.toDataURL("image/png"),n=t.dataURLtoBlob(e);v.push({blobUrl:n?URL.createObjectURL(n):e,delay:Math.max(f,10)})}},L=function(e){c||(c=l.getContext("2d"));var t=v.length,n=e.lctFlag?e.lct:s.gct;t>0&&(3===d?null!==p?v[p].data&&c.putImageData(v[p].data,0,0):c.clearRect(y.leftPos,y.topPos,y.width,y.height):p=t-1,2===d&&c.clearRect(y.leftPos,y.topPos,y.width,y.height));for(var a=c.getImageData(e.leftPos,e.topPos,e.width,e.height),o=0;o<e.pixels.length;o++){var r=e.pixels[o];if(r!==h){var i=n[r],u=4*o;a.data[u]=i[0],a.data[u+1]=i[1],a.data[u+2]=i[2],a.data[u+3]=255}}c.putImageData(a,e.leftPos,e.topPos),y=e},E=function(){},T=function(e){g=e.iterations},M={hdr:_,gce:S,com:E,app:{NETSCAPE:T},img:L,eof:function(){I()}},O=function(e,t){t||(t={});var a=function(t){for(var n=[],a=0;a<t;a++)n.push(e.readBytes(3));return n},o=function(){var t=void 0,n=void 0,a=0,o=8192;n=new Uint8Array(o);var r=function(){var e=new Uint8Array(n.length+o);e.set(n),n=e};do{for(t=e.readByte();a+t>n.length;)r();n.set(e.readBytes(t),a),a+=t}while(0!==t);return n.subarray(0,a)},r=function(){var n={};if(n.sig=e.read(3),n.ver=e.read(3),"GIF"!==n.sig)throw new Error("Not a GIF file.");n.width=e.readUnsigned(),n.height=e.readUnsigned();var o=P(e.readByte());n.gctFlag=o.shift(),n.colorRes=x(o.splice(0,3)),n.sorted=o.shift(),n.gctSize=x(o.splice(0,3)),n.bgColor=e.readByte(),n.pixelAspectRatio=e.readByte(),n.gctFlag&&(n.gct=a(1<<n.gctSize+1)),t.hdr&&t.hdr(n)},s=function(n){var a=function(n){var a=(e.readByte(),P(e.readByte()));n.reserved=a.splice(0,3),n.disposalMethod=x(a.splice(0,3)),n.userInput=a.shift(),n.transparencyGiven=a.shift(),n.delayTime=e.readUnsigned(),n.transparencyIndex=e.readByte(),n.terminator=e.readByte(),t.gce&&t.gce(n)},r=function(e){e.comment=o(),t.com&&t.com(e)},i=function(n){e.readByte();n.ptHeader=e.readBytes(12),n.ptData=o(),t.pte&&t.pte(n)},s=function(n){var a=function(n){e.readByte();n.unknown=e.readByte(),n.iterations=e.readUnsigned(),n.terminator=e.readByte(),t.app&&t.app.NETSCAPE&&t.app.NETSCAPE(n)},r=function(e){e.appData=o(),t.app&&t.app[e.identifier]&&t.app[e.identifier](e)};e.readByte();switch(n.identifier=e.read(8),n.authCode=e.read(3),n.identifier){case"NETSCAPE":a(n);break;default:r(n)}},l=function(e){e.data=o(),t.unknown&&t.unknown(e)};switch(n.label=e.readByte(),n.label){case 249:n.extType="gce",a(n);break;case 254:n.extType="com",r(n);break;case 1:n.extType="pte",i(n);break;case 255:n.extType="app",s(n);break;default:n.extType="unknown",l(n)}},l=function(n){var r=function(e,t){for(var n=new Array(e.length),a=e.length/t,o=function(a,o){var r,s=e.slice(o*t,(o+1)*t);n.splice.apply(n,(r=[a*t,t]).concat.apply(r,i(s)))},r=[0,4,2,1],s=[8,8,4,2],l=0,u=0;u<4;u++)for(var c=r[u];c<a;c+=s[u])o(c,l),l++;return n};n.leftPos=e.readUnsigned(),n.topPos=e.readUnsigned(),n.width=e.readUnsigned(),n.height=e.readUnsigned();var s=P(e.readByte());n.lctFlag=s.shift(),n.interlaced=s.shift(),n.sorted=s.shift(),n.reserved=s.splice(0,2),n.lctSize=x(s.splice(0,3)),n.lctFlag&&(n.lct=a(1<<n.lctSize+1)),n.lzwMinCodeSize=e.readByte();var l=o();n.pixels=b(n.lzwMinCodeSize,l),n.interlaced&&(n.pixels=r(n.pixels,n.width)),t.img&&t.img(n)},u=function d(){var a={};switch(a.sentinel=e.readByte(),String.fromCharCode(a.sentinel)){case"!":a.type="ext",s(a);break;case",":a.type="img",l(a);break;case";":a.type="eof",t.eof&&t.eof(a);break;default:throw new Error("Unknown block: 0x"+a.sentinel.toString(16))}"eof"!==a.type?setTimeout(d,0):n({loopCount:g,frames:v})},c=function(){r(),setTimeout(u,0)};c()};try{var A=new Uint8Array(e),V=new w(A);setTimeout(O(V,M),0)}catch(B){a(B),console.error("parseGIF ERROR!!"+B)}})}},{key:"isObject",value:function(e){return"[object Object]"===Object.prototype.toString.apply(e)}},{key:"fixColorValue",value:function(e){var t=e.match(/rgb\([\s]*(\d+)[\s]*,[\s]*(\d+)[\s]*,[\s]*(\d+)[\s]*\)/i),n=function(e){var t=parseInt(e,10).toString(16);return 2!==t.length?"0"+t:t};return t?e="#"+n(t[1])+n(t[2])+n(t[3]):(e&&"#"!==e[0]&&(e="#"+e),isNaN(parseInt(e.slice(1),16))&&(e="#ffffff"),e?e:"#ffffff")}},{key:"timeout",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=null,n=new Promise(function(n,a){return t=setTimeout(n,e)});return n.cancel=function(){return clearTimeout(t)},n}},{key:"getTimeOffset",value:function(){var e=this;if(flashvars.single&&"1"===flashvars.offline)return this.timeStamp=this.curLocalTime(),this.timeOffset=0,Promise.resolve(this.timeOffset);var t="https://my.3000.com/?m=timestamp&op=index&ac=get&api_v=1.0.0&api_from=webpc";return d.xhrGetServerTime(t).then(function(t){if(0===t.responseText.length)return Promise.reject("Get file failed, no response data");var n=JSON.parse(t.responseText);return 0===n.status?(e.timeStamp=n.data.timestamp,e.timeOffset=e.timeStamp-e.curLocalTime(),Promise.resolve(e.timeOffset)):Promise.reject(n.msg+": "+n.status)},function(e){return Promise.reject(e)})}},{key:"localUpdateTime",value:function(){e.localTime===-1&&(e.localTime=this.curLocalTime()),setInterval(function(){e.localTime++},1e3)}},{key:"curLocalTime",value:function(){return Math.floor((new Date).getTime()/1e3)}},{key:"updateContextTimeValues",value:function(t){if(-1!==this.timeStamp){t.systemValues[2].value=e.localTime+this.timeOffset;var n=new Date(1e3*t.systemValues[2].value);t.systemValues[3].value=n.getFullYear(),t.systemValues[4].value=n.getMonth()+1,t.systemValues[5].value=n.getDate(),t.systemValues[6].value=n.getHours(),t.systemValues[7].value=n.getMinutes(),t.systemValues[8].value=n.getSeconds(),t.systemValues[10].value=n.getDay()}}},{key:"getCurrentDateTime",value:function(e){var t=new Date(e),n="-",a=":",o=function(e,t,n){return e>=n&&e<=t?"0"+e:""+e},r=t.getFullYear()+n+o(t.getMonth()+1,9,1)+n+o(t.getDate(),9,0)+" "+o(t.getHours(),9,0)+a+o(t.getMinutes(),9,0)+a+o(t.getSeconds(),9,0);return r}},{key:"createBlob",value:function(e,t){var n=void 0,a=void 0;try{return new Blob([e])}catch(o){if(n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)return a=new n,a.append(e),a.getBlob(t);throw new Error("Unable to create blob")}}},{key:"dataURLtoBlob",value:function(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]),o=a.length,r=new Uint8Array(o);o--;)r[o]=a.charCodeAt(o);var i=null;try{i=new Blob([r],{type:n})}catch(s){console.error(s.name+"  "+s.message)}return i}},{key:"encodeBase64",value:function(e){return""===e?"":f.Base64.encode(e)}},{key:"decryptBase64",value:function(e){return""===e?"":f.Base64.decode(e)}},{key:"aesEncrypt",value:function(e,t){if(""===e)return"";var n="de3kt|jq|fdcgj_|",a="ff_|pf|#%@fw_j+q";1===t?(n="WDF#$H*#SJN*&G$&",a="JH&$GF$DR%*K@SC%"):2===t?(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf"):3===t&&(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf");var o=p["default"].enc.Utf8.parse(n),r=p["default"].enc.Utf8.parse(a),i=p["default"].AES.encrypt(e+"",o,{iv:r,mode:p["default"].mode.CBC,padding:p["default"].pad.ZeroPadding}),s=i.toString();return s}},{key:"aesDecrypt",value:function(e,t){if(""===e)return"";var n="de3kt|jq|fdcgj_|",a="ff_|pf|#%@fw_j+q";1===t?(n="WDF#$H*#SJN*&G$&",a="JH&$GF$DR%*K@SC%"):2===t?(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf"):4===t&&(n="xiamenshanyi4399",a="");var o=p["default"].enc.Utf8.parse(n),r=p["default"].enc.Utf8.parse(a),i=p["default"].AES.decrypt(e,o,{iv:r,mode:4!==t?p["default"].mode.CBC:p["default"].mode.ECB,padding:p["default"].pad.ZeroPadding}),s=i.toString(p["default"].enc.Utf8);return s}},{key:"getCookie",value:function(e){var t=void 0,n=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(n))?decodeURI(t[2]):null}},{key:"getUidByCookie",value:function(){var e=this.getCookie("SYPauth");if(e){var t=e.indexOf("|");e=e.substring(0,t)}return e?e:""}},{key:"generateUUID",value:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)});return t}},{key:"localStorageGetItem",value:function(e){if(flashvars.app_version<"1.2.0")return window.localStorage.getItem(e);if("android"===flashvars.client&&window.app){var t=window.app.localStorage_getItem(e);return""===t?null:t}if("ios"===flashvars.client){var n=null;return n="1"===flashvars.offline?localStorage_getItem(e):window.localStorage.getItem(e),""===n&&(n=null),n}return""===flashvars.client?window.localStorage.getItem(e):null}},{key:"localStorageSetItem",value:function(e,t){if(flashvars.app_version<"1.2.0")return void window.localStorage.setItem(e,t);if("android"===flashvars.client)window.app&&window.app.localStorage_setItem(e,t);else if("ios"===flashvars.client){var n={key:e,value:t};"1"===flashvars.offline?localStorage_setItem(JSON.stringify(n)):(window.webkit&&window.webkit.messageHandlers.localStorage_setItem.postMessage(JSON.stringify(n)),window.localStorage.setItem(e,t))}else window.localStorage.setItem(e,t)}},{key:"localStorageRemoveItem",value:function(e){return flashvars.app_version<"1.2.0"?void window.localStorage.removeItem(e):void("android"===flashvars.client?window.app&&window.app.removeLocalStorage(e):"ios"===flashvars.client?"1"===flashvars.offline?removeLocalStorage(e):(window.webkit&&window.webkit.messageHandlers.removeLocalStorage.postMessage(e),window.localStorage.removeItem(e)):window.localStorage.removeItem(e))}},{key:"localStorageClear",value:function(){window.localStorage.clear()}},{key:"getSensitiveWords",value:function(){var t=this,n="https://mapi.3000api.com/apis/soft/v1.0/game-GetSensitiveStr.html",a="action=all";return d.xhrSend(n,a).then(function(n){if(0===n.responseText.length)return Promise.reject("getSensitiveWords failed, no response data");var a=JSON.parse(n.responseText);if(100==a.code){if("[object Array]"==Object.prototype.toString.call(a.result))t.sensitiveWords=a.result.concat();else{var o=JSON.parse(e.aesDecrypt(a.result,4));t.sensitiveWords=o.concat()}return Promise.resolve()}return Promise.reject()},function(e){return Promise.reject(e)})}},{key:"getDeviceId",value:function(){if("android"===flashvars.client){var e=navigator.userAgent.match(/[0-9A-Za-z]{8}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{12}/g);return e?e[0]:""}if("ios"===flashvars.client){var t=navigator.userAgent.match(/[0-9A-Za-z]{40}/g);return t?t[0]:""}return""}},{key:"formatNum",value:function(e){return 0===e?"00000":e<10?"0000"+e:e<100?"000"+e:"00"+e}},{key:"sendStatistics",value:function(){if("android"!==flashvars.client&&"ios"!==flashvars.client)return Promise.resolve();var e=this.getDeviceId(),t=Math.floor((new Date).getTime()/1e3)+this.timeOffset,n="mac_name="+e+"&time="+t+"&uid="+flashvars.uid+"&v_key=shanyi_WDF#$H*#SJN*&G$&**";n=this.aesEncrypt(g["default"].hash(g["default"].hash(n)),1),t=this.aesEncrypt(t,1);var a="https://app.3000.com/?m=statistics&op=start&ac=h5&v="+flashvars.v+"&client="+flashvars.client,o="mac_name="+encodeURIComponent(this.aesEncrypt(e,1))+"&uid="+encodeURIComponent(this.aesEncrypt(flashvars.uid,1))+"&sign="+encodeURIComponent(n)+"&time="+encodeURIComponent(t);return d.xhrSend(a,o)}},{key:"sendSelOptions",value:function(){var e=this,t=function(){if(0===e.selOptions.length)return setTimeout(n(),3e4),Promise.resolve();var t="https://www.3000.com/apis/client/v1.0/trace-optionClick.html?",a="from=h5&uuid="+flashvars.uuid+"&optionid="+JSON.stringify(e.selOptions);return d.xhrLoad(t+a,"").then(function(){return e.selOptions.splice(0,e.selOptions.length),setTimeout(n(),3e4),Promise.resolve()},function(){return setTimeout(n(),3e4),Promise.reject()})},n=function(){return function(){t()}};setTimeout(n(),3e4)}},{key:"searchChapterByUUID",value:function(e,t){for(var n=function r(e){if(e.uuid===t)return e;for(var n=0;n<e.subchapters.length;++n){var a=r(e.subchapters[n]);if(a)return a}},a=null,o=0;o<e.chapters.length;++o)if(a=n(e.chapters[o]))return a;return a}}]),e}();e["default"]=P,P.timeStamp=-1,P.timeOffset=0,P.sensitiveWords=[],P.selOptions=[],P.soundVolume=1,P.musicVolume=1,P.localTime=-1;var w=function(){function e(){s(this,e),this.gifList=[],this.imgList=[]}return u(e,[{key:"popGif",value:function(){var e=this.gifList.findIndex(function(e){return 1===b.getCount("img",e.key)});if(~e){var t=this.gifList[e].key;this.gifList.splice(e,1),b.removeFromCache("img",t,!0)}}},{key:"popImg",value:function(){var e=this.imgList.findIndex(function(e){return 1===b.getCount("img",e.key)});if(~e){var t=this.imgList[e].key;this.imgList.splice(e,1),b.removeFromCache("img",t,!0)}}},{key:"push",value:function(e,t){t?(this.gifList.push({key:e,timestamp:Date.now()}),b.addRefCount("img",e,"cache"),this.gifList.length>20&&this.popGif()):(this.imgList.push({key:e,timestamp:Date.now()}),b.addRefCount("img",e,"cache"),this.imgList.length>100&&this.popImg())}}]),e}(),b=e.ResourcesManager=function(){function e(){s(this,e)}return u(e,null,[{key:"pushInLoader",value:function(e,t,n,a){var o=this,r=n||e;return!("img"===t&&this.cache.checkImageKey(r)||"audio"===t&&this.cache.checkSoundKey(r))||"ios"===flashvars.client&&"audio"===t&&flashvars.app_version>="1.5.0"?P.convertToAllowAccessControlOriginUrl(e).then(function(e){if(!e)return!1;var n=!o.load.getAsset("img"===t?"image":"audio",r);if("img"===t)n&&o.load.image(r,e),!a&&o.addRefCount("img",r,"global");else if("audio"===t){var i=o.forceDecode.music===r||o.forceDecode.sounds.some(function(e){return e===r});if("ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var s=!x["default"].isAudioInCache(r)&&!x["default"].isLoadingAudio(r);return s&&x["default"].loadAudioUrl(r,e,flashvars.offline),s}n&&o.load.audio(r,e,i),!a&&o.addRefCount("audio",r,"global")}return n},function(e){return console.error("Invalid URL: "+e)}):Promise.resolve(!1)}},{key:"forEachReCount",value:function(e){var t=this;Object.keys(this.refCount.audio).forEach(function(n){return e&&e("audio",n,t.getCount("audio",n))}),Object.keys(this.refCount.img).forEach(function(n){return e&&e("img",n,t.getCount("img",n))})}},{key:"resetReCount",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];[this.refCount.img,this.refCount.audio].forEach(function(t,n){Object.keys(t).forEach(function(n){var a=t[n],o=a.global,r=void 0===o?0:o,i=a.cache,s=void 0===i?0:i,l={global:r,cache:s},u=Object.keys(t[n]);e.forEach(function(e){return u.forEach(function(t){return~t.indexOf(e)?l[t]=a[t]:void 0})}),t[n]=l})})}},{key:"updateRefTypePrefix",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];[this.refCount.img,this.refCount.audio].forEach(function(o,r){Object.keys(o).forEach(function(i){o.hasOwnProperty(i)&&Object.keys(o[i]).forEach(function(s){if(s.startsWith(e)){var l=s.replace(e,"");n&&l&&(o[i][l]=(o[i][l]||0)+(o[i][s]||0)),delete o[i][s],a&&t.removeFromCache(r?"audio":"img",i)}})})})}},{key:"transferRefCount",value:function(e,t,n,a,o){this.refCount[e][a]=this.refCount[e][a]||{},this.refCount[e][a][o]=this.refCount[e][a][o]||0,this.refCount[e][t]&&(this.refCount[e][a][o]+=this.refCount[e][t][n],this.refCount[e][t][n]=0,this.removeFromCache(e,t))}},{key:"transferByRefCount",value:function(e,t){[this.refCount.img,this.refCount.audio].forEach(function(n){Object.keys(n).forEach(function(a){var o=n[a];o[t]=(o[t]||0)+(o[e]||0),delete o[e]})})}},{key:"transferByRefCountByPrefix",value:function(e,t){[this.refCount.img,this.refCount.audio].forEach(function(n){Object.keys(n).forEach(function(a){var o=n[a],r=0;Object.keys(o).forEach(function(t){t.startsWith(e)&&(r+=o[t],delete o[t])}),o[t]=(o[t]||0)+r})})}},{key:"addRefCount",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"play",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e&&t&&(this.load.cancelForceRemoveFile(e,t),this.refCount[e][t]=this.refCount[e][t]||{},this.refCount[e][t][n]=(this.refCount[e][t][n]||0)+a)}},{key:"subRefCount",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"play";if(this.refCount[e][t]){for(var a=Object.keys(this.refCount[e][t]),o=0;o<a.length;o++)if(/^\$([A-Za-z0-9]*-){4}([A-Za-z0-9]*)l\d/.test(a[o]))return;var r=this.refCount[e][t];r[n]=(r[n]||0)-1,r[n]=r[n]<0?0:r[n],this.removeFromCache(e,t)}else"audio"===e&&"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version&&!!t&&x["default"].removeAudioUrl(t)}},{key:"delRefTypeCount",value:function(e,t,n){if(this.refCount[e][t]){var a=this.refCount[e][t];a[n]=0,this.removeFromCache(e,t)}}},{key:"delByRefType",value:function(e){var t=this;[this.refCount.img,this.refCount.audio].forEach(function(e,n){Object.keys(e).forEach(function(a){delete e[a],t.removeFromCache(n?"audio":"img",a)})})}},{key:"getCount",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return this.refCount[e][t]?a?this.refCount[e][t][a]||0:Object.keys(this.refCount[e][t]).reduce(function(a,o){return a+n.refCount[e][t][o]},0):0}},{key:"isGlobal",value:function(e,t){return this.refCount[e][t].global>0}},{key:"removeFromCache",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.refCount[e][t]&&(!this.getCount(e,t)||n)){var a=this.usingKeyMap,o=a.background,r=a.music,i=a.sounds,s=a.preBackground;if(o===t||s===t||r===t)return void this.addRefCount(e,t);for(var l=0;l<i.length;l++)if(i[l]===t)return void this.addRefCount(e,t);if("audio"===e&&this.cache){if("ios"===flashvars.client&&flashvars.app_version>="1.5.0")x["default"].removeAudioUrl(t);else{var u=this.cache.getSound(t);u&&u.audioTag&&u.data&&(u.data.free=!0),u&&/blob:/i.test(u.url)&&URL.revokeObjectURL(u.url),this.cache.checkSoundKey(t)&&this.cache.removeSound(t),this.load.forceRemoveFile(e,t)}this.PreloadState.size+=2e6}if("img"===e&&this.cache){t.indexOf("?")>=0&&(t=t.substr(0,t.indexOf("?")));var c=t.substr((Math.max(0,t.lastIndexOf("."))||1/0)+1).toLowerCase();if(!n)return this.delayRemoveManager.push(t,"gif"===c),this.PreloadState.size+=2e5,void this.startPreloadResources();var d=this.cache.getImage(t,!0);if(d){var h=d.data.frames;h&&h.forEach(function(e){URL.revokeObjectURL(e.blobUrl),e.blobUrl=null}),/blob:/i.test(d.url)&&URL.revokeObjectURL(d.url),this.cache.checkImageKey(t)&&this.cache.removeImage(t),this.load.forceRemoveFile("image",t)}this.PreloadState.size+=2e5}delete this.refCount[e][t],this.startPreloadResources()}}},{key:"startPreloadResources",value:function(){var e=this;if(!(this.PreloadState.loading||this.PreloadState.size<=0)){this.PreloadState.loading=!0;var t=function(e){var t=e.context,n=e.chapter,a=e.pIndex,o=e.cmdInfo,s=e.cIndex,l=e.preloadType,u=e.preloadedCount,c=e.lock,d=r(t,[]);return d.stack=[].concat(i(d.stack||[])),d.cmdStack=[].concat(i(d.cmdStack||[])),{context:d,chapter:n,pIndex:a,cmdInfo:o,cIndex:s,preloadType:l,preloadedCount:u,lock:c}},n=function(n,a,o){for(var r=(o.context,o.chapter),i=(o.pIndex,o.cmdInfo,o.cIndex,o.preloadType),s=[],l=n[a]||[],u=0;u<l.length;u++){var c=l[u];if(c.plots.length){var d=t(o);d.chapter={plots:c.plots,uuid:r.uuid},d.pIndex=0;var h="options"===a?"o":"branch"!==c.type&&e.checkCondOptionResources(c)<=50?"l":"c";d.preloadType=("play"===i?"":i)+"$"+n.uuid+h+u+"-",c.plots[0].commands&&(d.cmdInfo={commands:c.plots[0].commands},d.cIndex=0),s.push(d)}}return s},a=function(n,a){for(var o=(a.context,a.chapter,a.pIndex,a.cmdInfo),r=a.cIndex,i=void 0===r?0:r,s=a.preloadType,l=[],u=n.args,c=0;c<u.length;c++){var d=u[c];if(d.commands.length){var h=t(a);h.cmdInfo={commands:d.commands,parentInfo:o,parentCmdIndex:i},h.cIndex=0;var f="options"===n.type?"o":"branch"!==d.type&&e.checkCondOptionResources(d,"command")<=50?"l":"c";h.preloadType=("play"===s?"":s)+"$"+n.uuid+f+c+"-",l.push(h)}}return l},o=function(e){!e.cmdInfo&&e.chapter.plots.length>e.pIndex&&e.chapter.plots[e.pIndex].commands&&(e.cmdInfo={commands:e.chapter.plots[e.pIndex].commands},e.cIndex=0)},s=function(n,a,r){n=t(n);var i=n,s=i.context,l=i.chapter,u=i.cmdInfo,c=i.preloadType,d=i.pIndex,h=void 0===d?0:d,f=i.cIndex,m=void 0===f?0:f,p=null;switch(a){case"pop":p=s.stack[0],s.stack=s.stack.slice(1),n.chapter=l.parent.pChapter,n.pIndex=l.parent.pnPlot+1,n.preloadType="play",n.cmdInfo=null,p&&"insert"===p.type&&(s.cmdStack=s.cmdStack.slice(1),n.cmdInfo=p.cmdInfo,n.cIndex=p.cmdIndex+1,n.preloadType=p.preloadType||"play",n.pIndex--),o(n);break;case"jump":case"command-jump":s._preMark={stack:[],cmdStack:[],chapter:l,cmdInfo:u,pIndex:h,cIndex:m,preloadType:c},s.stack=[],s.cmdStack=[],n.cmdInfo=null,n.chapter=P.searchChapterByUUID(e.gameData,r),n.pIndex=0,n.preloadType=("play"===c?"":c)+"$"+n.chapter.uuid+"j",o(n);break;case"insert":case"command-insert":s._preMark={stack:s.stack,cmdStack:s.cmdStack,chapter:l,cmdInfo:u,pIndex:h,cIndex:m,preloadType:c},s.stack=[],s.cmdStack=[],n.cmdInfo=null,n.chapter=P.searchChapterByUUID(e.gameData,r),n.pIndex=0,n.preloadType=("play"===c?"":c)+"$"+n.chapter.uuid+"i",o(n);break;case"command-pop":n.cmdInfo=u&&u.parentInfo||null,n.cIndex=(u&&u.parentCmdIndex||0)+1,u.parentInfo?(n.preloadType="play",s.cmdStack=s.cmdStack.slice(1)):(n.cmdInfo=null,n.pIndex++,o(n));break;case"command-break":n.cmdInfo=null,n.pIndex++,o(n)}return n},l=function(){for(var t=["jump","insert","back","options","conditionOptions","addImage","showDialog","playMusic","playSound","weather"],r=0,i=e.LoadedMark.length;e.LoadedMark&&r<i;r++)for(var l=0;e.LoadedMark[r]&&l<e.LoadedMark[r].length;l++){var u=e.LoadedMark[r][l],c=u,h=c.context,f=c.chapter,m=c.pIndex,p=void 0===m?0:m,y=c.cmdInfo,g=c.cIndex,v=void 0===g?0:g,x=(c.preloadType,d(u));if(x){var P=0;if(y){var w=y.commands[v]||{},b=w.type,k=w.args;P="options"===b||"conditionOptions"===b?k.length:0}else{var C=f.plots[p]||{},_=C.options,S=void 0===_?[]:_,I=C.condition_options,L=void 0===I?[]:I;P=Math.max(S.length,L.length)}if(u.preloadedCount=u.preloadedCount||0,u.preloadedCount>10||2===x&&u.preloadedCount>1||P>8){u.lock=!0;continue}u.preloadedCount++}if(u.lock)u.lock=!1,u.preloadedCount=0;else if(y)if(y.commands.length<=v)e.LoadedMark[r].splice(l--,1),(h.stack.length||h.cmdStack.length)&&y.parentInfo?e.pushLoadMarks([s(u,"command-pop")]):y.parentInfo||e.pushLoadMarks([s(u,"command-break")]);else{var E=y.commands[v]||{},T=E.type,M=E.args;if("options"===T||"conditionOptions"===T){var O=a(E,u);u.cIndex++,O.length&&e.pushLoadMarks(O)}else"back"===T||"jump"===T||"insert"===T?("insert"!==T&&e.LoadedMark[r].splice(l--,1),"jump"===T&&e.pushLoadMarks([s(u,"command-jump",M[0])]),"insert"===T&&e.pushLoadMarks([s(u,"command-insert",M[0])]),u.cIndex++):!function(){for(var e=y.commands[++u.cIndex]||{},n=e.type;n&&!t.some(function(e){return e===n});){var a=y.commands[++u.cIndex]||{};n=a.type}}()}else if(f.plots.length<=p)e.LoadedMark[r].splice(l--,1),h.stack.length&&(u=s(u,"pop"),e.pushLoadMarks([u]));else{var A=f.plots[p]||{},V=A.options,B=void 0===V?[]:V,N=A.condition_options,j=void 0===N?[]:N;if(B.length||j.length){var R=n(A,"options",u),D=n(A,"condition_options",u);
u.pIndex++,o(u),R.length&&e.pushLoadMarks(R),D.length&&e.pushLoadMarks(D)}else A.back||A.jump||A.insert?(A.insert||e.LoadedMark[r].splice(l--,1),A.jump&&e.pushLoadMarks([s(u,"jump",A.jump)]),A.insert&&e.pushLoadMarks([s(u,"insert",A.insert)]),u.pIndex++,o(u)):(u.pIndex++,o(u))}}for(var F=0;e.LoadedMark&&F<e.LoadedMark.length;F++)e.LoadedMark[F]&&!e.LoadedMark[F].length&&e.LoadedMark.splice(F--,1)},u=function(e){if(e.context._preMark){var t=e.context._preMark,n=t.stack,a=t.cmdStack,r=t.chapter;e.context.stack=n,e.context.cmdStack=a,e.chapter=r,e.pIndex=0,o(e),delete e.context._preMark}},c=function(t){var n=t.chapter;if(n.md5&&0===n.plots.length&&"1"!==flashvars.offline&&!n.chapter){var a=n.downloadUuid?n.downloadUuid:n.uuid,o=null,r=function(o){var r=o.type,s=o.plots,l=void 0===s?[]:s;if("revert"===r)u(t);else if("succes"===r){var c;0===n.plots.length&&(c=n.plots).push.apply(c,i(l)),e.PreloadState.loadingChapterMap[a]=null}return t};return e.PreloadState.loadingChapterMap[a]?e.PreloadState.loadingChapterMap[a].then(r):(o=e.sceneProxy.checkIfChapterFree(a,n.md5,!1).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return{type:"succes",plots:e}},function(e){console.warn(e)}),e.PreloadState.loadingChapterMap[a]=o,o.then(r))}return Promise.resolve(t)},d=function(e){for(var t=e.preloadType,n=void 0===t?"play":t,a=n.split("$").slice(1).map(function(e){var t=e.slice(36);return/j$/.test(t)?"jump":/i$/.test(t)?"insert":/o\d-$/.test(t)?"option":/(c|l)\d-$/.test(t)?"condOption":void 0}),o=[],r=[],i=[],s=0,l=0;l<a.length;l++){switch(a[l]){case"option":if(o.push(l),i.length)return 2;if(o.length>2)return 2;2===o.length&&(s=1);break;case"condOption":if(r.push(l),r.length>2&&i.length>=1)return 2;r.length>2&&(s=1);break;case"jump":case"insert":if(i.push(l),s=1,o.length>1)return 2;if(i.length>1)return 2}if(i.length&&r.length+o.length>2)return 2;if(4===l)return 1;if(l>4)return 2}return s},h=function f(){l();for(var t=[],n=0,a=function(a){for(var o=[],r=function(t){var r=e.LoadedMark[a][t];if(r.lock)return"continue";var i=P.timeout(0).then(function(){return e.LoadedMark[a]&&e.LoadedMark[a][t]&&r===e.LoadedMark[a][t]?c(e.LoadedMark[a][t]):Promise.reject()}).then(function(t){return e.preloadResources(t)}).then(function(t){return Promise.all(t.data.map(function(t){return e.pushInLoader(t.key,t.type,t.key,!0).then(function(e){return Object.assign(t,{pushed:e})})}))}).then(function(t){var a=t.filter(function(e){return e.pushed}),o=a.reduce(function(e,t){return e+("img"===t.type?2e5:2e6)},0);e.PreloadState.size-=o,a.length&&o&&n++,a.length&&e.load.start()}).then(function(){return P.timeout(15)});o.push(i)},i=0;e.LoadedMark[a]&&i<e.LoadedMark[a].length;i++){r(i)}o.length&&t.push(Promise.all(o).then(null,function(e){return console.warn(e)}))},o=0;e.LoadedMark&&o<e.LoadedMark.length&&e.PreloadState.preloaded<200;o++)a(o);var r=function(){n&&e.PreloadState.preloaded++,e.PreloadState.size<=0||!e.LoadedMark.length||e.PreloadState.preloaded>=200?e.PreloadState.loading=!1:setTimeout(f,0)};t.length?Promise.all(t).then(r,r):e.PreloadState.loading=!1};setTimeout(h,0)}}},{key:"resetInsertPreload",value:function(e){var t="$"+e.uuid+"i";this.transferByRefCount(t,"play"),this.updateRefTypePrefix(t),this.updateLoadMarkByPrefix(t),this.startPreloadResources()}},{key:"resetInsertBack",value:function(t,n){var a=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=r.cmdInfo,s=r.cmdIndex,l=void 0===s?0:s;e.LoadedMark=[],this.resetReCount();var u=this.sceneProxy.usingResourceCountMap();this.forEachReCount(function(e,t,n){u[t]&&a.addRefCount(e,t,u[t])}),this.getResourcesByContext(t,n,o,i,l).then(function(){return a.startPreloadResources()})}},{key:"resetJumpPreload",value:function(e){var t=this,n="$"+e.uuid+"j";this.resetReCount([n]),this.transferByRefCount(n,"play"),this.updateRefTypePrefix(n,!0,!1);var a=this.sceneProxy.usingResourceCountMap();this.forEachReCount(function(e,n,o){a[n]?t.addRefCount(e,n,a[n]):0===o&&t.removeFromCache(e,n)}),this.updateLoadMarkByPrefix(n,!1),this.startPreloadResources()}},{key:"resetCmdPOptionPreload",value:function(e,t,n){var a=this,o=e[t];if(o){for(var r="options"===o.type?"o":"c",i="$"+o.uuid+r+n+"-",s=[],l=0;l<this.LoadedMark.length;l++)for(var u=0;u<this.LoadedMark[l].length;u++){var c=this.LoadedMark[l][u];c.preloadType.startsWith(i)&&s.push(c)}var d=s.length&&s.every(function(e){return/^\$.{36}j/.test(e.preloadType.substring(i.length))});this.transferByRefCount(i,"play"),o.args.forEach(function(e,t){var i="$"+o.uuid+r+t+"-",s=t===n;!s&&a.updateRefTypePrefix(i),!s&&a.clearLoadMarkByPrefix(i)}),this.updateLoadMarkByPrefix(i,!d,!1),this.updateRefTypePrefix(i,!0),this.startPreloadResources()}}},{key:"clearPreCmdResources",value:function(e,t){var n=this;this.startPreloadResources();var a=e[t-1],o=["jump","insert","back","options","conditionOptions","addImage","showDialog","playMusic","playSound","weather"];a&&o.some(function(e){return e===a.type})&&this.PreloadState.preloaded--,a&&"conditionOptions"===a.type&&a.args.forEach(function(e,t){return n.updateRefTypePrefix("$"+a.uuid+"l"+t+"-",!1)})}},{key:"resetPlotOptionPreload",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,o="options"===n?"o":"condition_options"===n?"c":"",r=e.options,i=void 0===r?[]:r,s=e.condition_options,l=void 0===s?[]:s;if(i.length||l.length){for(var u="$"+e.uuid+o+a+"-",c=[],d=0;d<this.LoadedMark.length;d++)for(var h=0;h<this.LoadedMark[d].length;h++){var f=this.LoadedMark[d][h];f.preloadType.startsWith(u)&&c.push(f)}this.transferByRefCount(u,"play");var m=c.length&&c.every(function(e){return/^\$.{36}j/.test(e.preloadType.substring(u.length))});i.forEach(function(o,r){var i="$"+e.uuid+"o"+r+"-",s=r===a&&"options"===n;!s&&t.updateRefTypePrefix(i,s),!s&&t.clearLoadMarkByPrefix(i)}),l.forEach(function(o,r){var i="$"+e.uuid+"c"+r+"-",s=r===a&&"condition_options"===n;!s&&t.updateRefTypePrefix(i,s),!s&&t.clearLoadMarkByPrefix(i)}),this.updateLoadMarkByPrefix(u,!m,!1),this.updateRefTypePrefix(u,!0),this.startPreloadResources()}}},{key:"clearPrePlotResources",value:function(e,t){var n=this;this.startPreloadResources(),this.PreloadState.preloaded--;var a=e[t-1];if(a&&!a.commands&&(a.condition_options||a.condition_options.length)){var o=a.condition_options,r=void 0===o?[]:o;r.forEach(function(e,t){return n.updateRefTypePrefix("$"+a.uuid+"l"+t+"-",!1)})}}},{key:"preloadResources",value:function(e){var t=this,n=(e.context,e.chapter),a=e.pIndex,o=void 0===a?0:a,r=e.cmdInfo,i=e.cIndex,s=void 0===i?0:i,l=e.preloadType,u={data:[],size:0};if(!n||!n.plots||!n.plots[o]||r&&!r.commands[s])return Promise.resolve(u);var c=function(e,n,a){return t.addRefCount(e,n,a)},h=function(e,t,n){return c(t,e,n),u.data.some(function(t){return t.key===e})?Promise.resolve(!1):d.getResourceSize(e,t).then(function(n){return u.data.push({key:e,type:t,size:n}),u.size+=n,!0})},f=function(e,n,a){return n>=e.commands.length?Promise.resolve():Promise.all(t.getCommandResources(e.commands[n]).map(function(e){return h(e.url,e.type,a)}))},m=function(n,a,o){var r=n.plots[a];return!r||r.commands&&!r.commands.length?Promise.resolve():r.commands?(e.cmdInfo={commands:r.commands},e.cIndex=0,f(r,0,o)):Promise.all(t.getPlotResources(r).map(function(e){return h(e.url,e.type,o)}))};return r?f(r,s,l).then(function(){return u}):m(n,o,l).then(function(){return u})}},{key:"pushLoadMarks",value:function(e){if(e.length){this.LoadedMark.push(e)}}},{key:"updateLoadMarkByPrefix",value:function(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=0;a<this.LoadedMark.length;a++){for(var o=0;o<this.LoadedMark[a].length;o++){var r=this.LoadedMark[a][o],i=r.preloadType,s=r.context;if(i.startsWith(e)){if(i=i.substring(e.length),r.preloadType=i?i:"play",n){var l=s.stack.pop();l&&"insert"===l.type&&s.cmdStack.pop()}}else t||(this.updateRefTypePrefix(i,!1),this.LoadedMark[a].splice(o--,1))}this.LoadedMark[a].length||this.LoadedMark.splice(a--,1)}}},{key:"clearLoadMarkByPrefix",value:function(e){for(var t=0;t<this.LoadedMark.length;t++){for(var n=0;n<this.LoadedMark[t].length;n++){var a=this.LoadedMark[t][n],o=a.preloadType;o.startsWith(e)&&this.LoadedMark[t].splice(n--,1)}this.LoadedMark[t].length||this.LoadedMark.splice(t--,1)}}},{key:"getWeatherResources",value:function(e){var t=[];if("snowy"===e)for(var n=0;n<120;n++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("snow")+"/xuehua_"+P.formatNum(n)+".png",type:"img"});else if("windy"===e){if(flashvars.vertical)for(var a=0;a<20;a++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("wind")+"/feng_"+P.formatNum(a)+".png",type:"img"})}else if("rainy"===e)for(var o=0;o<50;o++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("rain")+"/xiayu_"+P.formatNum(o)+".png",type:"img"});else if("defoliation"===e)for(var r=0;r<90;r++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("mapleLeaves")+"/fengye_"+P.formatNum(r)+".png",type:"img"});else if("fallingPeach"===e)for(var i=0;i<90;i++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("beachBlossom")+"/taohua_"+P.formatNum(i)+".png",type:"img"});else if("fallingFlower"===e)for(var s=0;s<90;s++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("blossom")+"/yinghua_"+P.formatNum(s)+".png",type:"img"});else if("lightning"===e)for(var l=0;l<50;l++)t.push({url:"/"+P.getWeatherOfflinePathName()+"/"+P.getWeatherFilePathName("lightning")+"/shandian_"+P.formatNum(l)+".png",type:"img"});return t}},{key:"getCommandResources",value:function(e){var t=[];switch(e.type){case"addImage":e.args[0].url&&"inherit"!==e.args[0].url&&t.push({type:"img",url:e.args[0].url,isBackground:1===e.args[0].index});break;case"showDialog":t.push({type:"img",url:e.args[0].avatar.url});break;case"playMusic":e.args[0].url&&"inherit"!==e.args[0].url&&t.push({type:"audio",url:e.args[0].url,isMusic:!0});break;case"playSound":e.args[0].url&&"inherit"!==e.args[0].url&&t.push({type:"audio",url:e.args[0].url,isSound:!0,index:e.args[0].index});break;case"options":var n=!0,a=!1,o=void 0;try{for(var r,s=e.args[Symbol.iterator]();!(n=(r=s.next()).done);n=!0){var l=r.value,u=l.background,c=l.sound;if(u){var d=u.normal,h=u.active,f=u.disable;d&&d.url&&t.push({type:"img",url:d.url}),h&&h.url&&t.push({type:"img",url:h.url}),f&&f.url&&t.push({type:"img",url:f.url})}c&&c.url&&t.push({type:"audio",url:c.url})}}catch(m){a=!0,o=m}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw o}}break;case"weather":"1"!==flashvars.offline&&t.push.apply(t,i(this.getWeatherResources(e.args[0])));break;case"showBubble":e.args[0].url&&t.push({type:"img",url:e.args[0].url});break;case"emitBubble":var p=e.args[0],y=p.avatar,g=p.content;y.url&&t.push({type:"img",url:y.url}),g.url&&t.push({type:"img",url:g.url})}return t}},{key:"getPlotResources",value:function(e){var t=[];if("[object Array]"==Object.prototype.toString.call(e.plot_sound))for(var n in e.plot_sound){var a=e.plot_sound[n];a&&"inherit"!==a.url&&t.push({url:a.url,type:"audio",isSound:!0,index:n})}else e.plot_sound.url&&"inherit"!==e.plot_sound.url&&t.push({url:item.url,type:"audio",isSound:!0,index:0});e.background.url&&"inherit"!==e.background.url&&t.push({url:e.background.url,type:"img",isBackground:!0}),e.avatar.url&&t.push({url:e.avatar.url,type:"img"}),e.music.url&&"inherit"!==e.music.url&&t.push({url:e.music.url,type:"audio",isMusic:!0});var o=!0,r=!1,s=void 0;try{for(var l,u=e.characters[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){var c=l.value;c.url&&t.push({url:c.url,type:"img"})}}catch(d){r=!0,s=d}finally{try{!o&&u["return"]&&u["return"]()}finally{if(r)throw s}}var h=!0,f=!1,m=void 0;try{for(var p,y=e.props[Symbol.iterator]();!(h=(p=y.next()).done);h=!0){var g=p.value;g.url&&t.push({url:g.url,type:"img"})}}catch(d){f=!0,m=d}finally{try{!h&&y["return"]&&y["return"]()}finally{if(f)throw m}}var v=!0,x=!1,P=void 0;try{for(var w,b=e.options[Symbol.iterator]();!(v=(w=b.next()).done);v=!0){var k=w.value,C=k.background,_=k.sound;if(C){var S=C.normal,I=C.active,L=C.disable;S&&S.url&&t.push({type:"img",url:S.url}),I&&I.url&&t.push({type:"img",url:I.url}),L&&L.url&&t.push({type:"img",url:L.url})}_&&_.url&&t.push({type:"audio",url:_.url})}}catch(d){x=!0,P=d}finally{try{!v&&b["return"]&&b["return"]()}finally{if(x)throw P}}return e.weather.value&&"1"!==flashvars.offline&&t.push.apply(t,i(this.getWeatherResources(e.weather.value))),t}},{key:"checkCondOptionResources",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"general",a=this.OptionResourcesCountMap.get(e)||0;if(a)return a;var o={},r=function(e){o[e.url]||(a++,o[e.url]=!0)},s=function(e){for(var n=0;n<e.plots.length&&a<=50;n++){var o=e.plots[n],s=[];o.commands?s=o.commands.map(function(e){return"options"!==e.type&&"conditionOptions"!==e.type||c(e.args),t.getCommandResources(e)}).reduce(function(e,t){return[].concat(i(t),[e])},[]):(o.options.length&&l(o.options),o.condition_options.length&&l(o.condition_options),s=t.getPlotResources(o)),s.forEach(function(e){return r(e)})}},l=function(e){return e.forEach(function(e){return s(e)})},u=function(e){for(var n=0;n<e.commands.length&&a<=50;n++){var o=e.commands[n];t.getCommandResources(o).forEach(function(e){return r(e)}),"options"!==o.type&&"conditionOptions"!==o.type||c(o.args)}},c=function(e){return e.forEach(function(e){return u(e)})};return"general"===n?s(e):u(e),a}},{key:"getResourcesByContext",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments[3],o=this,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],u={data:[],size:0};if(e=l({},e),e.stack=[].concat(i(e.stack||[])),e.cmdStack=[].concat(i(e.cmdStack||[])),!t||!t.plots||!t.plots[n]||a&&!a.commands[r])return Promise.resolve(u);var c=function(){return u.size>o.MaxSize/5||u.data.length>30},h=function(e,t,n){return s&&o.addRefCount(e,t,n)},f=function(e,t,n){return h(t,e,n),u.data.some(function(t){return t.key===e})?Promise.resolve():d.getResourceSize(e,t).then(function(n){u.data.push({key:e,type:t,size:n}),u.size+=n})},m=function(e){var t=e.context,n=e.chapter,a=e.pIndex,o=e.cmdInfo,r=e.cIndex,i=e.preloadType,s=l({},t,{stack:[],cmdStack:[]}),u=n.plots||[];return!o&&u.length>a&&u[a]&&u[a].commands&&(o={commands:u[a].commands},r=-1),{context:s,chapter:n,pIndex:a,cmdInfo:o,cIndex:r,preloadType:i}},p=function(e,t){var n=e,a=n.context,r=n.preloadType,i=P.searchChapterByUUID(o.gameData,t);if(i)return r=("play"===r?"":r)+"$"+i.uuid+"j",e={context:a,cmdInfo:null,chapter:i,pIndex:-1,preloadType:r},m(e)},y=function(e,t){var n=e,a=n.context,r=n.preloadType,i=P.searchChapterByUUID(o.gameData,t);if(i)return r=("play"===r?"":r)+"$"+i.uuid+"i",e={context:a,cmdInfo:null,chapter:i,pIndex:-1,preloadType:r},m(e)},g=function(e,t){var n=o.getCommandResources(e);return n.forEach(function(e){var t=(e.type,e.url),n=e.isMusic,a=e.isSound,r=e.index;n&&o.forceDecode.musics.length<o.MaxForceDecodeMusic&&o.forceDecode.musics.push(t),a&&!o.forceDecode.sounds[r]&&(o.forceDecode.sounds[r]=t)}),Promise.all(n.map(function(e){return f(e.url,e.type,t)}))},v=function S(e){for(var t=e.context,n=e.preloadType,a=(e.chapter,e.pIndex,e.cmdInfo),r=e.cIndex,i=a.commands[r],s=i.args,u=[],d=[],h=function(a){for(var r=s[a],h="options"===i.type?"o":"branch"!==r.type&&o.checkCondOptionResources(r,"command")<=50?"l":"c",f={commands:r.commands},v=("play"===n?"":n)+"$"+i.uuid+h+a+"-",x=function(t){var n=m(l({},e,{cmdInfo:f,cIndex:t,preloadType:v}));d.push(n)},P=l({},e,{cmdInfo:f,cIndex:0,preloadType:v}),w=Promise.resolve(),b=function(e){var n=r.commands[e],a=n.type,i=n.args;if(w=w.then(function(){return g(n,v).then(function(){if(c(!0))return Promise.reject(e);if("options"===a||"conditionOptions"===a){var n=l({},P,{cIndex:e});return n.context=l({},t,{cmdStack:[]}),S(n)}return"jump"===a?(o.pushLoadMarks([p(l({},P,{cIndex:e}),i[0])]),Promise.reject(-1)):"insert"===a?(o.pushLoadMarks([y(l({},P,{cIndex:e}),i[0])]),Promise.reject(-1)):"back"===a?Promise.reject(-1):Promise.resolve()})}),"options"===a||"conditionOptions"===a)return e+1<r.commands.length&&(w=w.then(function(){return Promise.reject(e)})),"break"},k=0;k<r.commands.length&&k<10;k++){var C=b(k);if("break"===C)break}w=w.then(function(){r.commands.length>10&&x(9)},function(e){e>=0&&r.commands.length>e&&x(e)}),u.push(w)},f=0;s&&f<s.length;f++)h(f);return Promise.all(u).then(function(){return d.length&&o.pushLoadMarks(d),Promise.resolve()})},x=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=e.context,a=e.chapter,r=e.pIndex,i=e.cmdInfo,s=e.cIndex;e.preloadType;if(c(!0))return o.pushLoadMarks([m(e)]),Promise.resolve();var u=i.commands[s]||{},d=u.type,h=u.args;if("jump"===d)return o.pushLoadMarks([p(e,h[0])]),Promise.resolve();if("insert"===d)return o.pushLoadMarks([y(e,h[0])]),w(l({},e,{cIndex:s+1}));if("back"===d)return Promise.resolve();if("options"===d||"conditionOptions"===d)return v(e,t).then(function(){return w(l({},e,{cIndex:s+1}),t)});if(i.commands.length>s+1)return w(l({},e,{cIndex:s+1}),t);if(t&&n.cmdStack.length){if(n.cmdStack=n.cmdStack.splice(1),s=i.parentCmdIndex+1,i=i.parentInfo,i&&Number.isInteger(s))return w(l({},e,{cmdInfo:i,cIndex:s}),t)}else if(t&&n.stack.length&&(n.stack=n.stack.slice(1),a.parent&&(r=a.parent.pnPlot+1,a=a.parent.pChapter),a&&Number.isInteger(r)))return k(l({},e,{chapter:a,pIndex:r}));return t?k(l({},e,{pIndex:r+1})):Promise.resolve()},w=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=(e.chapter,e.pIndex,e.cmdInfo),a=e.cIndex,o=e.preloadType;return a>=n.commands.length?x(e,t):g(n.commands[a],o).then(function(){return x(e,t)})},b=function(e){for(var t=0,n=0;e.options&&n<e.options.length;n++)t+=e.options[n].plots.length;for(var a=0;e.condition_options&&a<e.condition_options.length;a++)t+=e.condition_options[a].plots.length;return t},k=function I(e){var t=e.chapter,n=e.pIndex,a=e.preloadType,r=t.plots[n];if(!r||r.commands&&!r.commands.length)return Promise.resolve();if(r.commands)return w(l({},e,{cmdInfo:r,cIndex:0}));var i=function(e,t){var n=o.getPlotResources(e);return n.forEach(function(e){var t=(e.type,e.url),n=e.isMusic,a=e.isSound,r=e.index;n&&o.forceDecode.musics.length<o.MaxForceDecodeMusic&&o.forceDecode.musics.push(t),a&&!o.forceDecode.sounds[r]&&(o.forceDecode.sounds[r]=t)}),Promise.all(n.map(function(e){return f(e.url,e.type,t)}))},s=function d(e){for(var t=e.chapter,n=e.pIndex,a=e.preloadType,r=e.context,s=t.plots[n],u=[],h=[],f=[],g=[],v=function(e,t){return t.push(m(e))},x=function(e,t,n){return e=e.then(function(){return t.commands?(n.cmdInfo={commands:t.commands},n.cIndex=0,w(n,!1)):i(t,n.preloadType)}).then(function(){return c(!0)?Promise.reject(n.pIndex):b(t)?d(n):t.jump?(o.pushLoadMarks([p(n,t.jump)]),Promise.reject(-1)):t.insert?(o.pushLoadMarks([y(n,t.insert)]),Promise.reject(-1)):t.back?Promise.reject(-1):Promise.resolve()})},P=function(n){for(var o=s.options[n],i=("play"===a?"":a)+"$"+s.uuid+"o"+n+"-",c={plots:o.plots,uuid:t.uuid},d=l({},e,{chapter:c,pIndex:0,preloadType:i}),h=Promise.resolve(),m=0;m<o.plots.length&&m<5;m++){var p=l({},d,{pIndex:m});p.context=l({},r),h=x(h,o.plots[m],p)}h=h.then(function(){o.plots.length>5&&v(l({},d,{pIndex:4}),u)},function(e){return e>=0&&o.plots.length>e&&!o.plots[e].commands&&v(l({},d,{pIndex:e}),u),Promise.resolve()}),f.push(h)},k=0;s.options&&k<s.options.length;k++)P(k);for(var C=function(i){for(var u=s.condition_options[i],c={plots:u.plots,parent:{pChapter:t,pnPlot:n},uuid:t.uuid},d="branch"!==u.type&&o.checkCondOptionResources(u)<=50?"l":"c",f=("play"===a?"":a)+"$"+s.uuid+d+i+"-",m=l({},e,{chapter:c,pIndex:0,preloadType:f}),p=Promise.resolve(),y=0;y<u.plots.length&&y<5;y++){var P=l({},m,{pIndex:y});P.context=l({},r),p=x(p,u.plots[y],P)}p=p.then(function(){u.plots.length>5&&v(l({},m,{pIndex:4}),h)},function(e){return e>=0&&u.plots.length>e&&!u.plots[e].commands&&v(l({},m,{pIndex:e}),h),Promise.resolve()}),g.push(p)},k=0;s.condition_options&&k<s.condition_options.length;k++)C(k);var _=Promise.all(f).then(function(){return u.length&&o.pushLoadMarks(u)}),S=Promise.all(g).then(function(){return h.length&&o.pushLoadMarks(h)});return Promise.all([_,S])},u=function(e){var t=e.context,n=e.chapter,a=e.pIndex,r=n.plots[a];if(c()){var i=m(e);return o.pushLoadMarks([i]),Promise.resolve()}return r.back?Promise.resolve():r.jump?(o.pushLoadMarks([p(e,r.jump)]),Promise.resolve()):r.insert?(o.pushLoadMarks([y(e,r.insert)]),I(l({},e,{pIndex:a+1}))):b(r)?s(e).then(function(){return I(l({},e,{pIndex:a+1}))}):n.plots.length>a+1?I(l({},e,{pIndex:a+1})):t.stack.length&&(t.stack=t.stack.slice(1),n.parent&&(a=n.parent.pnPlot+1,n=n.parent.pChapter),n&&Number.isInteger(a))?I(l({},e,{chapter:n,pIndex:a})):Promise.resolve()};return i(r,a).then(function(){return u(e)})},C=function(e){return e.size<o.MaxSize&&(o.PreloadState.size=o.MaxSize-e.size),o.PreloadState.size>0&&o.startPreloadResources(),e},_={context:e,chapter:t,pIndex:n,cmdInfo:a,cIndex:r,preloadType:"play"};return a?w(_).then(function(){return C(u)}):k(_).then(function(){return C(u)})}},{key:"getResourcesSize",value:function(e){var t=[];return e.forEach(function(e){t.push(d.getResourceSize(e.key,e.type))}),Promise.all(t).then(function(e){return e.reduce(function(e,t){return e+t},0)})}},{key:"updateUsingKey",value:function(e){var t=e.type,n=e.key,a=e.index,o="";switch(t){case"background":this.usingKeyMap.background=n;break;case"preBackground":this.usingKeyMap.preBackground=n;break;case"music":o=this.usingKeyMap.music,this.usingKeyMap.music=n,o&&this.subRefCount("audio",o);break;case"sound":o=this.usingKeyMap.sounds[a],this.usingKeyMap.sounds[a]=n,o&&this.subRefCount("audio",o)}}},{key:"isUsingKey",value:function(e){var t=this.usingKeyMap,n=t.background,a=t.music,o=t.sounds,r=t.preBackground;return n===e||r===e||a===e||o.some(function(t){return t===e})}}]),e}();b.delayRemoveManager=new w,b.OptionResourcesCountMap=new Map,b.PreloadState={size:0,loading:!1,preloaded:0,loadingChapterMap:{}},b.LoadedMark=[],b.MaxSize=1e8,b.MaxForceDecodeMusic=3,b.refCount={audio:{},img:{}},b.usingKeyMap={background:"",sounds:new Array(10).fill(""),music:"",preBackground:""},b.forceDecode={musics:[],sounds:new Array(10).fill("")};var k=e.AudioTagPool=function(){function e(){s(this,e)}return u(e,null,[{key:"get",value:function(){var t=e.pool.find(function(e){return e.free});return t?(t.pause(),t.free=!1):(t=document.createElement("audio"),t.crossOrigin="anonymous"),t}},{key:"exist",value:function(t){return e.pool.some(function(e){return e===t})}},{key:"fill",value:function(){var t=function(t){for(var n=0;n<t;n++){var a=document.createElement("audio");a.crossOrigin="anonymous",a.free=!0,a.loop=!1,a.play(),e.pool.push(a)}};if(e.pool.length){var n=e.pool.reduce(function(e,t){return e+(t&&t.free?1:0)},0);n<10&&t(50)}else t(100)}}]),e}();k.pool=[]}),require.register("js/common/Version.js",function(e,t,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a="894585118a172a4668ad020852df74275ba0e8dd";e["default"]=a;var o="1.0.0";e.version=o}),require.register("js/common/XmlHttpRequest.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){return e._=Date.now(),"?"+Object.keys(e).map(function(t){var n=e[t];return n?encodeURIComponent(t)+"="+encodeURIComponent(n):""}).join("&")}function r(e){return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onload=function(){try{return 4===a.readyState&&a.status>=400&&a.status<=599?n("error readyState: "+a.readyState+", status: "+a.status):t(a)}catch(e){n(e)}},a.onerror=n,a.send()})}function i(e,t,n,a){return new Promise(function(o,r){var i=new XMLHttpRequest;i.ontimeout=function(){console.log(e+" time out")},i.onreadystatechange=function(){switch(i.readyState){case 4:return i.status>=200&&i.status<300||304==i.status?o(i):r("error readyState: "+i.readyState+", status: "+i.status)}},i.open("post",e,!0),i.withCredentials=!0,a&&(i.timeout=a),n&&i.addEventListener("progress",n,!1),i.setRequestHeader("CONTENT-TYPE","application/x-www-form-urlencoded"),i.send(t),i.onerror=r})}function s(e,t,n){var a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return new Promise(function(o,r){var i=new XMLHttpRequest;i.ontimeout=function(){if(console.log(e+" time out"),a)return r("get time out")},i.onload=function(){try{return 4===i.readyState&&i.status>=400&&i.status<=599?r("error readyState: "+i.readyState+", status: "+i.status):o(i)}catch(e){return r(e)}},i.open("GET",e,!0),i.responseType=t,n&&i.addEventListener("progress",n,!1),a&&(i.timeout=5e3),i.onerror=r,i.send()})}function l(e,t){return s(e,"",t,!1).then(function(e){return JSON.parse(e.response)})}function u(e){return l(y.materialRedirect+o({url:e})).then(function(e){return"100"==e.code?e.result:Promise.reject(e.message)})}function c(e,t){var n=y.getGame+"?uuid="+e;return"1"===flashvars.offline&&flashvars.single&&"1"===flashvars.offline&&flashvars.single&&(n=p["default"].convertSingleJsonPath(e)),l(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function d(e,t){var n=y.getTestGame+"?uuid="+e;return"1"===flashvars.offline&&flashvars.single&&(n=p["default"].convertSingleJsonPath(e)),l(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function h(e,t){var n=y.getOtherGame+"?uuid="+e;return"1"===flashvars.offline&&flashvars.single&&(n=p["default"].convertSingleJsonPath(e)),l(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function f(e,t){return"img"===t?Promise.resolve(2e5):"audio"===t?Promise.resolve(2e6):void 0}Object.defineProperty(e,"__esModule",{value:!0}),e.xhrGetServerTime=r,e.xhrSend=i,e.xhrLoad=s,e.getJson=l,e.getMaterialRedirect=u,e.getGame=c,e.getTestGame=d,e.getOtherGame=h,e.getResourceSize=f;var m=t("./Utils"),p=a(m),y={getGame:"https://mapi.3000api.com/apis/soft/v1.0/game-info.html",getTestGame:"https://mapi.3000api.com/apis/soft/v1.0/game-test.html",getOtherGame:"https://mapi.3000api.com/apis/soft/v1.0/game-external.html",materialRedirect:"https://mapi.3000api.com/client/material-redirect.html"}}),require.register("js/controller/command/PrepareControllerCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareControllerCommand",parent:r["default"].SimpleCommand},{execute:function(e){}})}),require.register("js/controller/command/PrepareModelCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareModelCommand",parent:r["default"].SimpleCommand},{execute:function(e){this.facade.registerProxy(new diygamePlayer.model.proxy.SceneProxy)}})}),require.register("js/controller/command/PrepareViewCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareViewCommand",parent:r["default"].SimpleCommand},{execute:function(e){this.facade.registerMediator(new diygamePlayer.view.mediator.SceneMediator)}})}),require.register("js/controller/command/StartupCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.StartupCommand",parent:r["default"].MacroCommand},{initializeMacroCommand:function(){this.addSubCommand(diygamePlayer.controller.command.PrepareControllerCommand),this.addSubCommand(diygamePlayer.controller.command.PrepareModelCommand),this.addSubCommand(diygamePlayer.controller.command.PrepareViewCommand)}})}),require.register("js/main.js",function(t,n,a){"use strict";n("babel-polyfill"),n("./AppConstants.js"),n("./ApplicationFacade.js"),n("./controller/command/PrepareControllerCommand.js"),n("./controller/command/PrepareModelCommand.js"),n("./controller/command/PrepareViewCommand.js"),n("./controller/command/StartupCommand.js"),n("./model/proxy/SceneProxy.js"),n("./view/component/Scene.js"),n("./view/mediator/SceneMediator.js"),document.addEventListener("DOMContentLoaded",function(){e.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,e.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,diygamePlayer.ApplicationFacade.getInstance(diygamePlayer.ApplicationFacade.NAME).startup(),console.log("Initialized")})}),require.register("js/model/proxy/SceneProxy.js",function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=t("puremvc"),c=o(u),d=t("../../common/Utils.js"),h=o(d),f=t("spark-md5"),m=o(f),p=t("./../../common/Dialog.js"),y=o(p),g=t("./../../common/ShanyiMenu.js"),v=o(g),x=t("./../../common/XmlHttpRequest.js"),P=a(x),w=t("../../common/PhoneUtils.js"),b=o(w),k=t("../../common/FontUtils.js"),C=o(k),_=t("../../common/OtherWap"),S=o(_),I=t("copy-to-clipboard"),L=o(I),E=t("jsonp"),T=o(E);c["default"].define({name:"diygamePlayer.model.proxy.SceneProxy",parent:c["default"].Proxy},{chargeMsgReceive:function(e){if("msgCharged"===e.originalEvent.key){var t=JSON.parse(e.originalEvent.newValue);t&&"doit"==t.command&&alert(t.data)}},resumeAudio:function(){this.bk_music&&this.bk_music.play(),this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.resume()})},pauseAudio:function(){this.bk_music&&this.bk_music.pause(),this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.pause()})},preloadingBegin:function(){this.stringMap={},this.stringMap.loadMenu="读档",this.stringMap.overMenu="结束",this.stringMap.settingsMenu="设置",this.stringMap.startMenu="开始",this.stringMap.menu="菜单",this.stringMap.mainMenu="菜单",this.stringMap.save="保存进度",this.stringMap.load="读取进度",this.stringMap.playback="剧情回放",this.stringMap.autoplay="自动播放",this.stringMap.manualPlay="手动播放",this.stringMap.settings="设置",this.stringMap.displayHeader="显示设定",this.stringMap.displayCaption="画面模式",this.stringMap.volumeHeader="音量",this.stringMap.musicCaption="音乐音量",this.stringMap.soundCaption="音效音量",this.stringMap.textHeader="文字设定",this.stringMap.textCaption="自动进行",this.stringMap.autoOn="开",this.stringMap.autoOff="关",this.stringMap.windowMode="窗口模式",this.stringMap.fullMode="全屏模式",this.stringMap.back="返回",this.progressTips=["手指右滑就可召唤退出按钮，退出作品时，记得存档哦","收藏作品，更新会第一时间通知你","把作品下载到本地，随时随地任性玩","感觉作品很棒，和你的好友分享吧~","引战、刷屏、作品无关的评论会被删除哦","素材库为全站通用，可能发生人物走错片场的情况，请不要慌张","在当前作品的评论中对比其他作品容易给作者大大招黑哦~","制作辛苦，写下精彩长评支持喜欢的作者吧","长按屏幕可以快进剧情"],this.recordTipCount=0,this.isShowGuide=!0,this.plotSounds=[],this.playbackData=[],this.plotViews=[],this.prgsViews=[],this.plotViewKeys=[],this.bViewLoaded=!1,this.bSignedIn=!1,this.bCloudSel=!1,this.visibleLayout=[],this.resourceManager={
plotIndex:0,resourceList:[],baseList:[]},this.lstDialogInfo=[],this.menuInfo=[],this.quickPlay=!1,this.isScreenHold=!1,this.bCmdAutoText=!1,this.isGameStarted=!1,this.usedStarCount=0,this.gameStarLimit=0,this.lstPlotTweens=[],this.twinkleTimer=null,this.uiOnLoadQueue=[],this.timerCounts=[],this.menuTimer=[],this.recUidBelongTo=flashvars.uid,this.gameUidBelongTo=flashvars.uid,this.bSwitchAccInPlot=!0,this.payValueUid=flashvars.uid,this.unlockChapterCallBack=null,this.mallPayCallback=null,this.isPaying=!1,this.isGettingNext=!0,this.isPreferentialFinished=!1,this.preferentialVector=[],this.isSetValues=!1,this.isPaySuccess=!1,this.isGoToCommand=!0,this.shakeLoopObj={level:0,duration:0,delay:0,loop:!1,commands:null},this.prePlotBkKey=null,this.isQuickPlay=!0,this.hasCountDown=!1,this.saveBubbleVector=[],this.saveBubbleDataVector=[],this.bubbleArchivalCount=[],this.dialogNext=null,this.setValueAfterPay=!1,this.isInputFocus=!1,this.z_key=null,this.isLineUpdatePaySuccess=!1,this.playAdCallBack=null,this.playAdPayStatus=0,this.isWapOther()&&(S["default"].sendQHData(),S["default"].initQHSdk().then(function(e){console.log("--->>>>> "+e)})),audioMgr.pause=this.pauseAudio.bind(this),audioMgr.resume=this.resumeAudio.bind(this),audioMgr.audioCanPlayCallBack=b["default"].audioCanPlayCallBack.bind(b["default"]),audioMgr.audioErrorCallBack=b["default"].audioErrorCallBack.bind(b["default"]),gameCallback.updateAccInfo=this.updateAccInfo.bind(this),gameCallback.unlockChapterFinished=this.unlockChapterFinished.bind(this),gameCallback.mallPay=this.mallPay.bind(this),gameCallback.preferentialFinished=this.preferentialFinished.bind(this),gameCallback.showSave=this.showSaveInterface.bind(this),gameCallback.playadBack=this.playadBackInterface.bind(this),h["default"].getTimeOffset().then(function(){h["default"].localUpdateTime()},function(){h["default"].localUpdateTime()}),h["default"].sendSelOptions(),this.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN)},playadBackInterface:function(e){null!==this.playAdCallBack&&this.playAdCallBack(e)},showSaveInterface:function(){this.recordLayer.visible&&(this.recordLayer.visible=!1),this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),this.menuLayer.visible=!0,this.getSnap(),this.menuLayer.visible=!1,this.showSave()},preferentialFinished:function(e){var t=this.curChapter&&(this.curChapter.downloadUuid?this.curChapter.downloadUuid:this.curChapter.uuid);this.preferentialVector.push(e.uuid?e.uuid:e),t===(e.uuid?e.uuid:e)&&(this.isPreferentialFinished=!0)},unlockChapterFinished:function(e,t){this.unlockChapterCallBack&&this.unlockChapterCallBack(e,t)},dislodgePreferentVector:function(e){for(var t=0;t<this.preferentialVector.length;t++)e===this.preferentialVector[t]&&this.preferentialVector.splice(t,1)},mallPay:function(e){this.mallPayCallback&&this.mallPayCallback(e),this.mallPayCallback=null},checkIfMallPaySuccess:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=function(t,n){return P.xhrSend(t,n).then(function(t){if(0===t.responseText.length)return Promise.resolve(!1);var n=JSON.parse(t.responseText);return"wap"===flashvars.client?100===n.status?Promise.resolve(n.data.serial_num===e&&"1"==n.data.c_status):200===n.status?Promise.resolve(!1):102===n.status?Promise.resolve(!1):101===n.status?Promise.resolve(!1):Promise.resolve(!1):0===n.status?Promise.resolve(n.data.serial_num===e&&"1"==n.data.c_status):100===n.status?Promise.resolve(!1):Promise.resolve(!1)},function(e){return Promise.resolve(!1)})},a="https://app.3000.com/?m=consume&op=index&ac=market_order_status&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,o="u="+encodeURIComponent(h["default"].aesEncrypt(flashvars.u,1))+"&token="+encodeURIComponent(h["default"].aesEncrypt(flashvars.token,1))+"&serial_num="+encodeURIComponent(h["default"].aesEncrypt(e,1));return"wap"===flashvars.client?""===flashvars.uid?this.getUserInfoFromWap().then(function(){return""===flashvars.uid?Promise.resolve(!1):(a="https://pay.3000.com/?m=consume&op=h5_flash_request",o="type="+encodeURIComponent(h["default"].aesEncrypt(t,3))+"&serial_num="+encodeURIComponent(h["default"].aesEncrypt(e,3)),n(a,o))}):(a="https://pay.3000.com/?m=consume&op=h5_flash_request",o="type="+encodeURIComponent(h["default"].aesEncrypt(t,3))+"&serial_num="+encodeURIComponent(h["default"].aesEncrypt(e,3)),n(a,o)):n(a,o)},addAssets:function(e,t,n,a){return d.ResourcesManager.pushInLoader(e,t,n,a)},addImage:function(e,t,n){this.viewComponent.game.cache.addImage(e,t||null,n)},addImageUrl:function(e,t){var n=this;return new Promise(function(a,o){var r=new Image;r.src=e,r.onload=function(o){n.viewComponent.game.load.cache.checkImageKey(t)||(n.viewComponent.game.cache.addImage(t,e,o.target),a())},r.onerror=r.onabort=function(e){return o(e)}})},parseJsonFile:function(e){var t=this;this.json_data=e;var n=[];return this.json_data.template&&this.json_data.template.json&&(n.push(this.parseTemplateCoverAssets()),n.push(this.parseTemplateDialogAssets()),n.push(this.parseTemplateMenuAssets()),n.push(this.parseTemplateSyMenuAssets()),n.push(this.parseTemplateMainMenuAssets()),n.push(this.parseTemplateSettingsAssets()),n.push(this.parseTemplateOptionAssets()),n.push(this.parseTemplatePlaybackAssets()),n.push(this.parseTemplateRecordAssets()),n.push(this.parseTemplateSoundAssets())),Promise.all(n).then(function(){return Promise.resolve()}).then(function(){if(n.length=0,C["default"].fontImage&&t.viewComponent.game.load.image(C["default"].fontFamily,C["default"].fontImage),t.json_data.logo&&t.json_data.logo.background&&t.json_data.logo.background.url&&n.push(t.addAssets(t.json_data.logo.background.url,"img")),t.json_data.cover.background&&t.json_data.cover.background.url&&n.push(t.addAssets(t.json_data.cover.background.url,"img")),t.json_data.cover.music&&t.json_data.cover.music.url){var e=t.json_data.cover.music.url;n.push(t.addAssets(e,"audio"))}var a=function(e){"[object Array]"==Object.prototype.toString.call(e)&&e.forEach(function(e){e.events.forEach(function(e){"playMusic"===e.type&&e.handle.music.url?n.push(t.addAssets(e.handle.music.url,"audio")):"playSound"===e.type&&e.handle.sounds.forEach(function(e){e&&"inherit"!=e.url&&n.push(t.addAssets(e.url,"audio"))})})})};for(var o in t.json_data.viewMap)if("timer"!==t.json_data.viewMap[o].type){var r=t.json_data.viewMap[o].content.background,i=t.json_data.viewMap[o].content.sound;r&&(r.url&&n.push(t.addAssets(r.url,"img")),r.normal&&r.normal.url&&n.push(t.addAssets(r.normal.url,"img")),r.active&&r.active.url&&n.push(t.addAssets(r.active.url,"img")),r.progress&&r.progress.url&&n.push(t.addAssets(r.progress.url,"img")),i&&i.url&&n.push(t.addAssets(i.url,"audio")),a(t.json_data.viewMap[o].events),t.json_data.viewMap[o].children.forEach(function(e){a(e.events)}))}else a(t.json_data.viewMap[o].events);return Promise.all(n).then(function(){return Promise.resolve()},function(e){return Promise.reject(e)})})},parseTemplateCoverAssets:function(){var e=[],t=this.json_data.template.json.cover,n=t.titleContainer,a=t.startMenu,o=t.loadMenu,r=t.settingsMenu,i=t.overMenu;return n.background.url&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.normal.background.url&&a.normal.background.url&&e.push(this.addAssets(a.normal.background.url,"img")),a.active.background.url&&a.active.background.url&&e.push(this.addAssets(a.active.background.url,"img")),o.normal.background.url&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),r.normal.background.url&&r.normal.background.url&&e.push(this.addAssets(r.normal.background.url,"img")),r.active.background.url&&r.active.background.url&&e.push(this.addAssets(r.active.background.url,"img")),i.normal.background.url&&i.normal.background.url&&e.push(this.addAssets(i.normal.background.url,"img")),i.active.background.url&&i.active.background.url&&e.push(this.addAssets(i.active.background.url,"img")),Promise.all(e)},parseTemplateDialogAssets:function(){var e=[],t=this.json_data.template.json.dialog,n=t.background,a=t.avatarContainer,o=t.titleContainer;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background.url&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.background.url&&o.background.url&&e.push(this.addAssets(o.background.url,"img")),Promise.all(e)},parseTemplateMenuAssets:function(){var e=[],t=this.json_data.template.json.menu,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)},parseTemplateSyMenuAssets:function(){if(this.json_data.template.json.shanyiMenu){var e=[],t=this.json_data.template.json.shanyiMenu,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)}},parseTemplateMainMenuAssets:function(){var e=[],t=this.json_data.template.json.mainMenu,n=t.background,a=t.header,o=t.save,r=t.load,i=t.playback,s=t.autoplay,l=t.settings,u=t.back;return n.url&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),r.normal.background&&r.normal.background.url&&e.push(this.addAssets(r.normal.background.url,"img")),r.active.background&&r.active.background.url&&e.push(this.addAssets(r.active.background.url,"img")),i.normal.background&&i.normal.background.url&&e.push(this.addAssets(i.normal.background.url,"img")),i.active.background&&i.active.background.url&&e.push(this.addAssets(i.active.background.url,"img")),s.normal.background&&s.normal.background.url&&e.push(this.addAssets(s.normal.background.url,"img")),s.active.background&&s.active.background.url&&e.push(this.addAssets(s.active.background.url,"img")),l.normal.background&&l.normal.background.url&&e.push(this.addAssets(l.normal.background.url,"img")),l.active.background&&l.active.background.url&&e.push(this.addAssets(l.active.background.url,"img")),u.normal.background&&u.normal.background.url&&e.push(this.addAssets(u.normal.background.url,"img")),u.active.background&&u.active.background.url&&e.push(this.addAssets(u.active.background.url,"img")),Promise.all(e)},parseTemplateSettingsAssets:function(){var e=[],t=this.json_data.template.json.settings,n=t.background,a=t.header,o=t.displayHeader,r=t.textHeader,i=t.displayCaption,s=t.textCaption,l=t.fullMode,u=t.windowMode,c=t.autoOn,d=t.autoOff,h=t.back;if(this.json_data.template.json.settings.musicCaption){var f=this.json_data.template.json.settings.musicCaption;f.background&&f.background.url&&e.push(this.addAssets(f.background.url,"img"))}if(this.json_data.template.json.settings.musicVolume){var m=this.json_data.template.json.settings.musicVolume;m.normal&&m.normal.background&&m.normal.background.url&&e.push(this.addAssets(m.normal.background.url,"img")),m.progress&&m.progress.background&&m.progress.background.url&&e.push(this.addAssets(m.progress.background.url,"img"))}if(this.json_data.template.json.settings.soundCaption){var p=this.json_data.template.json.settings.soundCaption;p.background&&p.background.url&&e.push(this.addAssets(p.background.url,"img"))}if(this.json_data.template.json.settings.soundVolume){var y=this.json_data.template.json.settings.soundVolume;y.normal&&y.normal.background&&y.normal.background.url&&e.push(this.addAssets(y.normal.background.url,"img")),y.progress&&y.progress.background&&y.progress.background.url&&e.push(this.addAssets(y.progress.background.url,"img"))}if(this.json_data.template.json.settings.volumeHeader){var g=this.json_data.template.json.settings.volumeHeader;g.background&&g.background.url&&e.push(this.addAssets(g.background.url,"img"))}return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.background&&o.background.url&&e.push(this.addAssets(o.background.url,"img")),r.background&&r.background.url&&e.push(this.addAssets(r.background.url,"img")),i.background&&i.background.url&&e.push(this.addAssets(i.background.url,"img")),s.background.url&&s.background.url&&e.push(this.addAssets(s.background.url,"img")),l.unchecked.background&&l.unchecked.background.url&&e.push(this.addAssets(l.unchecked.background.url,"img")),l.checked.background&&l.checked.background.url&&e.push(this.addAssets(l.checked.background.url,"img")),u.unchecked.background&&u.unchecked.background.url&&e.push(this.addAssets(u.unchecked.background.url,"img")),u.checked.background&&u.checked.background.url&&e.push(this.addAssets(u.checked.background.url,"img")),c.unchecked.background&&c.unchecked.background.url&&e.push(this.addAssets(c.unchecked.background.url,"img")),c.checked.background&&c.checked.background.url&&e.push(this.addAssets(c.checked.background.url,"img")),d.unchecked.background&&d.unchecked.background.url&&e.push(this.addAssets(d.unchecked.background.url,"img")),d.checked.background&&d.checked.background.url&&e.push(this.addAssets(d.checked.background.url,"img")),h.normal.background&&h.normal.background.url&&e.push(this.addAssets(h.normal.background.url,"img")),h.active.background&&h.active.background.url&&e.push(this.addAssets(h.active.background.url,"img")),Promise.all(e)},parseTemplateOptionAssets:function(){var e=[],t=this.json_data.template.json.option,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)},parseTemplatePlaybackAssets:function(){var e=[],t=this.json_data.template.json.playback,n=t.background,a=t.scrollBox,o=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),a.item.background&&a.item.background.url&&e.push(this.addAssets(a.item.background.url,"img")),a.item.content.background&&a.item.content.background.url&&e.push(this.addAssets(a.item.content.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),Promise.all(e)},parseTemplateRecordAssets:function(){var e=[],t=this.json_data.template.json.record,n=t.background,a=t.scrollBox,o=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),a.item.background&&a.item.background.url&&e.push(this.addAssets(a.item.background.url,"img")),a.item.content.background&&a.item.content.background.url&&e.push(this.addAssets(a.item.content.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),Promise.all(e)},parseTemplateSoundAssets:function(){var e=[];return this.json_data.template.json.sound&&this.json_data.template.json.sound.url&&e.push(this.addAssets(this.json_data.template.json.sound.url,"audio")),Promise.all(e)},getUserInfoFromWap:function(){return new Promise(function(e,t){(0,T["default"])("https://ptlogin.3000.com/?m=ptlogin&ac=cookieuid",{},function(t,n){return t?(flashvars.uid="",e()):(n&&(flashvars.uid=n.data.uid?n.data.uid:""),e())})})},showLogo:function(){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_LOGO)},showCover:function(){this.json_data.cover.music;this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU)},showMainMenu:function(e){this.onPause(),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU,e)},showSettings:function(e,t){var n=this;this.onPause(),h["default"].timeout(200).then(function(){n.mainMenuLayer.visible&&(n.mainMenuLayer.visible=!1,n.visibleLayout=[n.mainMenuLayer].concat(i(n.visibleLayout)))}),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS,{context:e,callbackInfo:t})},showPlayback:function(e){var t=this;this.onPause(),h["default"].timeout(200).then(function(){t.mainMenuLayer.visible&&(t.mainMenuLayer.visible=!1,t.visibleLayout=[t.mainMenuLayer].concat(i(t.visibleLayout)))}),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK,e)},showSave:function(e,t){this.menuLayer.visible=!1,this.bToSaveFile=!0,this.loadData(e),this.showRecord(t)},showLoad:function(e,t){var n=this;this.menuLayer.visible=!1,""===flashvars.u&&""===flashvars.token&&""===flashvars.client&&(flashvars.uid=h["default"].getUidByCookie()),"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){n.getPayInfo().then(function(){n.bToSaveFile=!1,n.loadData(e),n.showRecord(t)})}):this.getPayInfo().then(function(){n.bToSaveFile=!1,n.loadData(e),n.showRecord(t)})},showRecord:function(e){var t=this;this.onPause(),h["default"].timeout(200).then(function(){t.mainMenuLayer.visible&&(t.mainMenuLayer.visible=!1,t.visibleLayout=[t.mainMenuLayer].concat(i(t.visibleLayout)))}),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_RECORD,e)},showEnd:function(){"ios"===flashvars.client?1===flashvars.offline?workFinished("1"):window.webkit&&window.webkit.messageHandlers.workFinished.postMessage("1"):"android"===flashvars.client&&window.app&&window.app.workFinished("1"),this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!1),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_END)},isPlotResourceExist:function(e){var t="ios"===flashvars.client&&"1.5.0">=flashvars.app_versionl,n=this.usingResourceCountMap(),a=0,o=function(e,t){var o=d.ResourcesManager.getCount(e,t);return!o||o==n[t]&&!d.ResourcesManager.isGlobal(e,t)&&!d.ResourcesManager.isUsingKey(t)||(a++,!1)},r=function(e){if("addImage"===e.type){var t=e.args[0],n=(t.index,t.url);return"inherit"===n||!o("img",n)}if("playMusic"===e.type||"playSound"===e.type)return"inherit"===e.args[0].url||!o("audio",e.args[0].url);if("showDialog"===e.type)return!o("img",e.args[0].avatar.url);if("options"===e.type||"conditionOptions"===e.type){var a=!0,r=!1,i=void 0;try{for(var s,l=e.args[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var u=s.value;if(u.background&&u.background.normal&&u.background.normal.url&&o("img",u.background.normal.url))return!1;if(u.background&&u.background.active&&u.background.active.url&&o("img",u.background.active.url))return!1;if(u.background&&u.background.disable&&u.background.disable.url&&o("img",u.background.disable.url))return!1;if(u.sound&&u.sound.url&&o("audio",u.sound.url))return!1}}catch(d){r=!0,i=d}finally{try{!a&&l["return"]&&l["return"]()}finally{if(r)throw i}}}else if("weather"===e.type&&"1"!==flashvars.offline&&!c(e.args[0].value))return!1;return!0},s={autotext:!1,showDialog:!1,hasOption:!1},l=function(){return!!(s.hasOption&&a>10)||(!!(s.showDialog&&!s.autotext&&a>10)||a>20)},u=function _(e){for(var t=0;t<e.length&&!l();t++){var n=e[t];if(!r(n))return!1;if("options"===n.type&&(s.hasOption=!0),"showDialog"===n.type&&(s.showDialog=!0),"autotext"===n.type&&(s.autotext=!0),"options"===n.type||"conditionOptions"===n.type)for(var a=0;a<n.args.length&&!l();a++)if(!_(n.args[a].commands))return!1}return!0},c=function(e){return("snowy"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("snow")+"/xuehua_00119.png"))&&(("rainy"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("rain")+"/xiayu_00049.png"))&&(("defoliation"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_00089.png"))&&(("fallingPeach"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("beachBlossom")+"/taohua_00089.png"))&&(("fallingFlower"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("blossom")+"/yinghua_00089.png"))&&(("lightning"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("lightning")+"/shandian_00049.png"))&&(!flashvars.vertical||"windy"!==e||!o("img","/"+h["default"].getWeatherOfflinePathName()+"/"+h["default"].getWeatherFilePathName("wind")+"/feng_00019.png")))))))};if(e.commands)return u(e.commands);if(e.background.url&&"inherit"!==e.background.url&&o("img",e.background.url))return!1;if(e.avatar.url&&o("img",e.avatar.url))return!1;if(e.music.url&&"inherit"!==e.music.url&&o("audio",e.music.url)&&!t)return!1;if(e.options.length){var f=!0,m=!1,p=void 0;try{for(var y,g=e.options[Symbol.iterator]();!(f=(y=g.next()).done);f=!0){var v=y.value;if(v.background&&v.background.normal&&v.background.normal.url&&o("img",v.background.normal.url))return!1;if(v.background&&v.background.active&&v.background.active.url&&o("img",v.background.active.url))return!1;if(v.background&&v.background.disable&&v.background.disable.url&&o("img",v.background.disable.url))return!1;if(v.sound&&v.sound.url&&o("audio",v.sound.url))return!1}}catch(x){m=!0,p=x}finally{try{!f&&g["return"]&&g["return"]()}finally{if(m)throw p}}}if(e.characters.length||e.props.length)for(var P=[].concat(i(e.characters),i(e.props)),w=0;w<P.length;w++){var b=P[w];if(o("img",b.url))return!1}if(e.weather&&"1"!==flashvars.offline&&!c(e.weather.value))return!1;for(var k in e.plot_sound)if(e.plot_sound[k]){var C=e.plot_sound[k].url;if(C&&"inherit"!==C&&!t&&o("audio",e.plot_sound[k].url))return!1}return!0},getLoadingPlotResource:function(e){var t=[];if(e.commands){var n=0,a=[],o=function s(e){for(var t=0;t<e.length&&n<20;t++){var o=e[t],r=d.ResourcesManager.getCommandResources(o);if(r.length&&(a.push.apply(a,i(r)),n++),"options"===o.type||"conditionOptions"===o.type)for(var l=0;l<o.args.length&&n<20;l++)s(o.args[l].commands)}};o(e.commands)}else t.push.apply(t,i(d.ResourcesManager.getPlotResources(e)));var r=this.viewComponent.game.load;return t.filter(function(e){var t=e.type,n=e.url;return r.getAsset("img"===t?"image":"audio",n)}).map(function(e){return Object.assign(e,{key:e.url})})},usingResourceCountMap:function(e){var t=this,n={},a=function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.viewComponent.game.world;return e.children.forEach(function(e){n[e.key]=(n[e.key]||0)+1,r(e)})},o=function(){return t.viewComponent.game.sound._sounds.forEach(function(e){return n[e.key]=(n[e.key]||0)+1})};return a(),o(),n},resetResources:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.usingResourceCountMap();d.ResourcesManager.forEachReCount(function(n,a,o){var r=t[a];r>0&&d.ResourcesManager.addRefCount(n,a,"play",r),e.some(function(e){return e.key===a})?(a===d.ResourcesManager.usingKeyMap.music&&d.ResourcesManager.addRefCount(n,a),a===d.ResourcesManager.usingKeyMap.background&&d.ResourcesManager.addRefCount(n,a),d.ResourcesManager.usingKeyMap.sounds.some(function(e){return e===a})&&d.ResourcesManager.addRefCount(n,a)):!o&&d.ResourcesManager.removeFromCache(n,a)})},getResources:function(e,t,n){var a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=arguments[4],i=o.cmdInfo,s=o.cmdIndex,l=o.cmdScreenSnap,u=t.plots,c=d.ResourcesManager.usingKeyMap,h=c.music,f=c.sounds,m=c.background;return r&&(h=r.music.url,f=r.sounds.map(function(e){return e&&e.url}),m=r.background),d.ResourcesManager.forceDecode={musics:[],sounds:new Array(10).fill("")},t.parent||n||d.ResourcesManager.resetReCount(),d.ResourcesManager.LoadedMark=[],d.ResourcesManager.gameData=this.json_data,d.ResourcesManager.sceneProxy=this,d.ResourcesManager.getResourcesByContext(e,t,n,i,s).then(function(e){var i=function(t){e.data.some(function(e){return e.key===t.key})||e.data.push(t),d.ResourcesManager.addRefCount(t.type,t.key)};if(void 0!==n&&u[n]&&!u[n].commands&&"inherit"===u[n].music.url){var s=a.getMusic(t,n);s&&i({key:s,type:"audio"})}if(r){var c=r.music,h=r.sounds,f=r.charsAndProps,m=r.background,p=r.images,y=r.bubble;if(m&&!e.data.some(function(e){return e.key===m})&&i({key:m,type:"img"}),c&&!e.data.some(function(e){return e.key===c.url})&&(d.ResourcesManager.forceDecode.musics.push(c.url),i({key:c.url,type:"audio"})),h&&h.forEach(function(t,n){t&&!e.data.some(function(e){return e.key===t.url})&&(d.ResourcesManager.forceDecode.sounds[n]=t.url,i({key:t.url,type:"audio"}))}),f&&f.forEach(function(t){e.data.some(function(e){return e.key===t.url})||i({key:t.url,type:"img"})}),p&&p.forEach(function(t){e.data.some(function(e){return e.key===t.url})||i({key:t.url,type:"img"})}),y){var g=function(e){e.forEach(function(e,t){var n=e.args[0],a=n.avatar,o=n.content;a.url&&i({type:"img",key:a.url}),o.url&&i({type:"img",key:o.url})})};y.forEach(function(t,n){t.bubbleMode.args[0].url&&e.push({type:"img",key:t.bubbleMode.args[0].url}),g(t.bubble)})}}if(l){var v=o.cmdScreenSnap,x=v.music,P=v.sounds,w=v.charsAndProps,b=v.dialogInfo,k=v.bk;b&&b[0]&&b[0].avatar.url&&i({key:b[0].avatar.url,type:"img"}),k&&k.url&&i({key:k.url,type:"img"}),x&&x.url&&i({key:x.url,type:"audio"}),P&&P.forEach(function(e,t){return e&&e.url&&i({key:e.url,type:"audio"})}),w&&w.forEach(function(e){return e&&e.url&&i({key:e.url,type:"img"})}),""!==l.weatherType&&d.ResourcesManager.getWeatherResources(l.weatherType).forEach(function(e){e&&i({key:e.url,type:e.type})})}return e})},preloadCommandsAssets:function(e,t,n,a,o,r){var i=this;return this.getResources(e,t,n,{cmdInfo:a,cmdIndex:o},r).then(function(e){d.ResourcesManager.PreloadState.preloaded=0;var t=[];return r&&i.resetResources(e.data),e.data.forEach(function(e){t.push(i.addAssets(e.key,e.type,e.key,!0).then(function(t){return Object.assign({needLoad:t},e)}))}),Promise.all(t).then(function(e){return e.filter(function(e){return e.needLoad})})})},preloadChapterAssets:function(e,t,n,a,o,r){var i=this;return this.curChapter=t,this.curPlotIndex=n||0,this.cmdPlotSnap=a,this.getResources(e,t,n,a,o).then(function(t){d.ResourcesManager.PreloadState.preloaded=0;var n=[];return(o||r)&&i.resetResources(t.data),t.data.forEach(function(e){n.push(i.addAssets(e.key,e.type,e.key,!0).then(function(t){return Object.assign({needLoad:t},e)}))}),Promise.all(n).then(function(t){var n=t.filter(function(e){return e.needLoad});i.sendNotification(diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY,{context:e,loadData:o,needLoadList:n})})})},enableLayerInput:function(e,t){var n=function o(e,t){if(e.inputEnabled!=!t||e.text||(e.inputEnabled=t),e.children.length>0)for(var n in e.children)o(e.children[n],t)};if("recordLayer"===e.name)return void(e.visible=t);if("menuLayer"===e.name)e.children[0].inputEnabled=t;else for(var a in e.children)n(e.children[a],t)},apToFinalState:function(){if(this.charsAndPropsLayer&&this.charsAndPropsLayer.exists)for(var e=0;e<this.charsAndPropsLayer.children.length;e++){var t=this.charsAndPropsLayer.children[e],n=t.children[0];n&&n.finalState&&(n.alpha=n.finalState.alpha,n.angle=n.finalState.angle,n.x=n.finalState.x,n.y=n.finalState.y,t.x=0,t.y=0,t.scale.x=t.finalState.scale.x,t.scale.y=t.finalState.scale.y)}},removePlotTweens:function(){for(this.twinkleTimer&&this.twinkleTimer.cancel()&&(this.twinkleTimer=null);this.lstPlotTweens.length;){var e=this.lstPlotTweens.splice(0,1);e[0].stop(!0),e[0].target&&"twinkle"===e[0].target.name&&e[0].target.destroy()}this.apToFinalState()},onPause:function(){this.playPause=!0;for(var e=this.viewComponent.game.tweens._tweens.length-1;e>=0;e--){var t=this.viewComponent.game.tweens._tweens[e];t.name&&"toast"===t.name||t.pause()}this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!1)},onResume:function(){this.isQuickPlay=!0,this.playPause=!1,this.viewComponent.game.tweens.resumeAll(),this.hasCountDown&&this.viewComponent.game.time.events.start(),this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!0)},onCoverStartBtnClicked:function(){var e=this,t=this.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length){if(this.isWapOther()){var a=function(n){null===n?y["default"].error("获取付费章节信息失败"):"fail"===n?y["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,L["default"])("819786897",{debug:!1,message:"复制成功"})},function(){}):(t.plots=n?n:[],e.preloadChapterAssets(e.context,t))};return void this.unlockChapterByWapOther(n,t.charge,t.md5,a)}if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)this.checkIfChapterFree(n,t.md5).then(function(n){var a;(a=t.plots).push.apply(a,i(n)),e.preloadChapterAssets(e.context,t)},function(t){-1===t.indexOf("code=87")?y["default"].error(t):"zxwwap"===flashvars.wap?y["default"].info("当前为收费章节，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid}):y["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买"),e.coverLayer.visible=!0});else{var o=function(a,o){a?e.checkIfChapterFree(n,t.md5).then(function(n){var a;e.unlockChapterCallBack=null,(a=t.plots).push.apply(a,i(n)),e.preloadChapterAssets(e.context,t)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():y["default"].error("获取付费章节信息失败"),e.coverLayer.visible=!0}):o&&(e.coverLayer.visible=!0)};this.unlockChapter(n,t.charge,t.md5,o)}}else this.preloadChapterAssets(this.context,t);this.coverLayer.visible=!1},onCoverLoadBtnClicked:function(){this.showLoad()},onCoverSettingBtnClicked:function(){this.showSettings(this.context)},onCoverOverBtnClicked:function(){(!flashvars.app_version||"ios"!==flashvars.client&&"android"!==flashvars.client)&&(navigator.userAgent.indexOf("MSIE")>0?navigator.userAgent.indexOf("MSIE 6.0")>0?(window.opener=null,window.close()):(window.open("","_top"),window.top.close()):navigator.userAgent.indexOf("Firefox")>0?window.location.href="about:blank ":(window.opener=null,window.open("","_self"),window.close()))},onMenuBtnClicked:function(){this.getSnap(),this.showMainMenu(this.context)},onMenuBtnMoreClicked:function(){flashvars.single===!0&&"1"===flashvars.offline&&(this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),window.app&&window.app.moreWorks())},onSyMenuBtnClicked:function(){if("wap"===flashvars.client)return this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),void(window.parent&&window.parent.closGame());if("ios"===flashvars.client||"android"===flashvars.client){if(this.isWapOther())return this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),void v["default"].showSyMenu().then(function(e){1!==e&&"string"==typeof e&&-1!==e.indexOf("http")&&(window.location.href=e)});flashvars.app_version<"1.2.0"?y["default"].info("版本过低，不支持该功能"):window.location.href="lzj3000://menu"}else this.context.fullScreen&&this.onSettingsWindowModeBtnClicked(),v["default"].showSyMenu().then(function(e){1!==e&&"string"==typeof e&&-1!==e.indexOf("http")&&(window.location.href=e)})},onMainMenuSaveBtnClicked:function(){this.context.disableSaveOrLoad&&this.context.disableSaveOrLoad.save?this.showToast(1,"抱歉，作者在此设置了禁用存档"):this.showSave()},onMainMenuLoadBtnClicked:function(){this.context.disableSaveOrLoad&&this.context.disableSaveOrLoad.load?this.showToast(1,"抱歉，作者在此设置了禁用读档"):this.showLoad()},onMainMenuPlaybackBtnClicked:function(){this.showPlayback()},onMainMenuAutoplayBtnClicked:function(){this.context.auto=!this.context.auto,this.onMainMenuBackBtnClicked()},onMainMenuSettingsBtnClicked:function(){this.showSettings(this.context)},onMainMenuBackBtnClicked:function(){this.mainMenuLayer.visible=!1,this.onResume(),this.context.auto&&this.curPlotLayer.onChildInputDown.dispatch("auto")},onSettingsFullModeBtnClicked:function(){this.viewComponent.game.scale.startFullScreen(!1),this.context.fullScreen=!0},onSettingsWindowModeBtnClicked:function(){
this.viewComponent.game.scale.stopFullScreen(),this.context.fullScreen=!1},onSettingsAutoOnBtnClicked:function(){this.context.auto=!0},onSettingsAutoOffBtnClicked:function(){this.context.auto=!1},onSettingsBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.visibleLayout=this.visibleLayout.slice(1),this.settingsLayer.visible=!1},onRecordBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.visibleLayout=this.visibleLayout.slice(1),this.recordLayer.visible=!1,this.showMenu()},onRecordLocalBtnClicked:function(){this.bCloudSel=!1,this.bToSaveFile?this.showSave(!0):this.showLoad(!0)},onRecordCloudBtnClicked:function(){this.bCloudSel=!0,this.bToSaveFile?this.showSave(!0):this.showLoad(!0)},showMenu:function(){this.menuLayer.visible=!0,this.curPlotInfo&&this.curPlotInfo.menu&&(this.menuLayer.visible=!this.curPlotInfo.menu.hidden)},showGuideTip:function(e){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_GUIDE,{id:e})},isSignedIn:function(){var e=this;return this.loadCloudRecord(99).then(function(t){var n=function(e){for(var t=JSON.parse(e),n=Array(12),a=0;a<t.length;a++)if(t[a].plotUuid){var o=""+t[a].time_stamp;n[a]={},n[a].plotUuid=t[a].plotUuid,n[a].timestamp=o.length>10?t[a].time_stamp:1e3*t[a].time_stamp,n[a].plotSnap="data:image/jpeg;base64,"+t[a].plot_snap}else n[a]={};return n};return e.bSignedIn=!0,e.cloudPlotsData=""===t?Array(12).fill({}):n(t),e.getPayInfo().then(function(){return e.getAccountInfo()}).then(function(){return Promise.resolve()})},function(t){return e.bSignedIn=!1,Promise.reject(t)})},findFirstChapter:function(){for(var e=function a(e){if(e.plots.length>0||e.md5)return e.isFirst=!0,e;for(var t=0;t<e.subchapters.length;t++){var n=a(e.subchapters[t]);if(n)return n}return null},t=0;t<this.json_data.chapters.length;t++){var n=e(this.json_data.chapters[t]);if(n)return n}return this.json_data.chapters[0]},notifyGameStarted:function(){return flashvars.app_version&&flashvars.app_version<"1.3.0"?void(this.isGameStarted=!0):(this.isGameStarted=!0,void("ios"===flashvars.client?1==flashvars.offline?gameStart("1"):window.webkit&&window.webkit.messageHandlers.gameStart.postMessage("1"):"android"===flashvars.client?window.app&&window.app.gameStart("1"):this.isWap3000()&&P.xhrLoad("https://www.3000.com/apis/client/v1.0/trace-play.html?id="+flashvars.gid+"&from=wap","",null)))},updateAccInfo:function(e,t){var n=this;if(flashvars.single&&"1"===flashvars.offline)return this.context||(this.context={}),void this.getPayInfo().then(function(e){n.getAccountInfo().then(function(){t&&n.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS)})});if(e)return flashvars.u="",flashvars.token="",this.context.systemValues[0].value=0,void this.getPayInfo();this.context||(this.context={});var a=function(){n.localRecFileToUidRecFile(!1);var e=function a(){n.getPayInfo().then(function(e){if("[object String]"!==Object.prototype.toString.apply(e)||""===e||t){if(""===e&&flashvars.uid&&n.json_data.payValues){n.payValueUid=flashvars.uid;var o=function(e){return e?JSON.parse(JSON.stringify(e)):e};n.context.payValues=o(n.json_data.payValues),n.context.payValues.forEach(function(e){e.value=e.init.value}),n.savePayInfo()}t&&n.getAccountInfo().then(function(){n.getFansInfo().then(function(){t&&n.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS)})})}else setTimeout(function(){return a()},1)})};e()};flashvars.uid||flashvars.client||(flashvars.uid=h["default"].getUidByCookie()),"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){a()}):a()},localRecFileToUidRecFile:function(e){var t=flashvars.uuid+flashvars.uid,n=h["default"].localStorageGetItem(t),a=h["default"].localStorageGetItem(flashvars.uuid);!n&&a&&(h["default"].localStorageSetItem(t,a),h["default"].localStorageRemoveItem(flashvars.uuid)),e||(this.recordLayer&&this.recordLayer.visible?this.bSwitchAccInPlot=!1:this.bSwitchAccInPlot=!0),""===this.gameUidBelongTo&&""!==flashvars.uid&&(this.gameUidBelongTo=flashvars.uid)},getFansInfo:function(){var e=this;"ios"!==flashvars.client&&"android"!==flashvars.client&&"wap"!==flashvars.client&&(flashvars.uid=h["default"].getUidByCookie());var t=function(t){return P.xhrLoad(t,"",null,!1).then(function(t){if(0===t.responseText.length)return Promise.resolve("Get Fans Count failed, no response data");var n=JSON.parse(t.responseText);return e.context.systemValues[9].value=n.data.fans_total,Promise.resolve(e.context.systemValues)},function(e){return Promise.resolve("跨域了("+e+")")})},n="https://pay.3000.com/?m=payinterface&op=player_one_opus_fans&opus_id="+flashvars.gid+"&uid="+flashvars.uid;return"wap"===flashvars.client?this.getUserInfoFromWap().then(function(){return n="https://pay.3000.com/?m=payinterface&op=player_one_opus_fans&opus_id="+flashvars.gid+"&uid="+flashvars.uid,t(n)}):t(n)},saveAccountInfo:function(){var e=function(e){return new Promise(function(t,n){return window.app&&window.app.saveGameValue(flashvars.uuid+"systemInfo",e),h["default"].localStorageSetItem(flashvars.uuid+"systemInfo",e),t()})},t=JSON.stringify(this.context.systemValues),n=h["default"].encodeBase64(t);return e(n)},getAccountInfo:function(){var e=this;if(flashvars.single&&"1"===flashvars.offline)return new Promise(function(t,n){var a=null;if(window.app&&(a=window.app.readGameValue(flashvars.uuid+"systemInfo")),null===a&&(a=h["default"].localStorageGetItem(flashvars.uuid+"systemInfo")),a){var o=JSON.parse(h["default"].decryptBase64(a));if(!e.context.systemValues)return e.context.systemValues=o,t(e.context.systemValues);for(var r=0;r<o.length;r++)for(var i=0;i<e.context.systemValues.length;i++)if(e.context.systemValues[i].uuid===o[r].uuid){e.context.systemValues[i].value=void 0===o[r].value?e.context.systemValues[i].init.value:o[r].value;break}return t(e.context.systemValues)}e.context.systemValues||(e.context.systemValues=[{name:"闪币余额",uuid:"",key:"coinTotal",init:{type:"system",value:0}},{name:"星星余额",uuid:"",key:"starTotal",init:{type:"system",value:0}},{name:"时间戳",uuid:"",key:"timestamp",init:{type:"system",value:-1}},{name:"当前年",uuid:"",key:"year",init:{type:"system",value:-1}},{name:"当前月",uuid:"",key:"month",init:{type:"system",value:-1}},{name:"当前日",uuid:"",key:"day",init:{type:"system",value:-1}},{name:"当前小时",uuid:"",key:"hour",init:{type:"system",value:-1}},{name:"当前分钟",uuid:"",key:"minute",init:{type:"system",value:-1}},{name:"当前秒",uuid:"",key:"second",init:{type:"system",value:-1}},{name:"贡献值",uuid:"",key:"contribution",init:{type:"system",value:0}},{name:"星期",uuid:"",key:"weekday",init:{type:"system",value:0}}]);for(var s=0;s<e.context.systemValues.length;s++)e.context.systemValues[s].value=e.context.systemValues[s].init.value;return t("失败")});var t=function(t,n){arguments.length>2&&void 0!==arguments[2]&&arguments[2];return P.xhrSend(t,n,null,4e3).then(function(t){if(0===t.responseText.length)return Promise.resolve("Get AccountInfo failed, no response data");var n={};try{n=JSON.parse(t.responseText)}catch(a){return Promise.resolve("Get AccountInfo failed, no response data")}return 0===n.status?(e.context.systemValues[0].value=n.data.payment_available,e.context.systemValues[1].value=n.data.game_coin_available?n.data.game_coin_available:0,e.usedStarCount=n.data.single_game_star_use?n.data.single_game_star_use:0,e.gameStarLimit=n.data.single_game_star?n.data.single_game_star:0,Promise.resolve(e.context.systemValues)):(e.context.systemValues[0].value=0,e.context.systemValues[1].value=0,e.usedStarCount=0,e.gameStarLimit=0,Promise.resolve(n))},function(t){return e.context.systemValues[0].value=0,e.context.systemValues[1].value=0,Promise.resolve("获取用户信息权限错误("+t+")")})},n=function(){var n="https://pay.3000.com/?m=player&op=h5_get_account_info",a="gid="+flashvars.gid;return"ios"!==flashvars.client&&"android"!==flashvars.client||(n="https://app.3000.com/?m=user&op=index&ac=my_account&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,a="u="+encodeURIComponent(h["default"].aesEncrypt(flashvars.u,1))+"&token="+encodeURIComponent(h["default"].aesEncrypt(flashvars.token,1))+"&game_id="+encodeURIComponent(h["default"].aesEncrypt(flashvars.gid,1))),e.bSignedIn!==!0&&"ios"!==flashvars.client&&"android"!==flashvars.client&&"wap"!==flashvars.client?e.loadCloudRecord(99).then(function(e){return t(n,a)},function(t){return e.context.systemValues[0].value=0,e.context.systemValues[1].value=0,Promise.resolve("pc端未登入，无法同步闪币信息！")}):t(n,a)};return this.context.systemValues||(this.context.systemValues=[{name:"闪币余额",uuid:"",key:"coinTotal",init:{type:"system",value:0}},{name:"星星余额",uuid:"",key:"starTotal",init:{type:"system",value:0}},{name:"时间戳",uuid:"",key:"timestamp",init:{type:"system",value:-1}},{name:"当前年",uuid:"",key:"year",init:{type:"system",value:-1}},{name:"当前月",uuid:"",key:"month",init:{type:"system",value:-1}},{name:"当前日",uuid:"",key:"day",init:{type:"system",value:-1}},{name:"当前小时",uuid:"",key:"hour",init:{type:"system",value:-1}},{name:"当前分钟",uuid:"",key:"minute",init:{type:"system",value:-1}},{name:"当前秒",uuid:"",key:"second",init:{type:"system",value:-1}},{name:"贡献值",uuid:"",key:"contribution",init:{type:"system",value:0}},{name:"星期",uuid:"",key:"weekday",init:{type:"system",value:0}}]),"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){return""===flashvars.uid?(e.context.systemValues[0].value=0,e.context.systemValues[1].value=0,e.usedStarCount=0,e.gameStarLimit=0,Promise.resolve({status:1,message:"您还没有登入！"})):n()}):n()},getPayInfo:function(e){var t=this;if(this.context.payValues||(this.context.payValues=[{name:"消费数值1",uuid:"",init:{type:"const",value:0},value:0}]),flashvars.single&&"1"===flashvars.offline)return new Promise(function(e,n){var a=null;if(window.app&&(a=window.app.readGameValue(flashvars.uuid+"payInfo")),null===a&&(a=h["default"].localStorageGetItem(flashvars.uuid+"payInfo")),a){for(var o=JSON.parse(h["default"].decryptBase64(a)),r=0;r<o.length;r++)for(var i=0;i<t.json_data.payValues.length;i++)if(t.json_data.payValues[i].uuid===o[r].uuid){void 0===o[r].value&&(o[r].value=o[r].init.value||0),t.context.payValues[i]=o[r];break}return e(t.context.payValues)}return e("失败")});var n=function(n,a){return P.xhrSend(n,a,null,4e3).then(function(n){if(0===n.responseText.length)return Promise.resolve("Get AccountInfo failed, no response data");var a=JSON.parse(n.responseText);if(0===a.status||a.status===-1){if(a.status===-1){var o=h["default"].localStorageGetItem(flashvars.uuid+"payInfo");if(a.data.content=null===o?"":o,e&&a.msg&&a.msg.indexOf("您还没有登录")!==-1)return flashvars.uid="",Promise.resolve(a.msg)}else if(0===a.status&&!a.data.content){var r=h["default"].localStorageGetItem(flashvars.uuid+"payInfo"+flashvars.uid);h["default"].localStorageRemoveItem(flashvars.uuid+"payInfo"+flashvars.uid),r||(r=h["default"].localStorageGetItem(flashvars.uuid+"payInfo"),h["default"].localStorageRemoveItem(flashvars.uuid+"payInfo")),a.data.content=null===r?"":r}if(""!==a.data.content&&t.json_data.payValues){t.payValueUid=flashvars.uid;for(var i=JSON.parse(h["default"].decryptBase64(a.data.content)),s=0;s<i.length;s++)for(var l=0;l<t.json_data.payValues.length;l++)if(t.json_data.payValues[l].uuid===i[s].uuid){void 0===i[s].value&&(i[s].value=i[s].init.value||0),t.context.payValues[l]=i[s];break}return 0===a.status&&-1!==n.responseText.indexOf('{"content":""}')?t.savePayInfo():Promise.resolve(t.context.payValues)}return t.payValueUid!==flashvars.uid&&t.context.payValues.forEach(function(e){e.value=0}),Promise.resolve("")}return Promise.resolve("获取用户信息失败("+a.msg+":"+a.status+")")},function(e){return Promise.resolve("获取用户信息权限错误("+e+")")})},a=flashvars.u&&flashvars.token?1:0,o=h["default"].localTime+h["default"].timeOffset,r=""===flashvars.gid?1:parseInt(flashvars.gid),i="";i=a?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+r+"&time="+o+"&token="+flashvars.token+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"gid="+r+"&time="+o+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M",r=h["default"].aesEncrypt(r,a),i=h["default"].aesEncrypt(m["default"].hash(m["default"].hash(i)),a),o=h["default"].aesEncrypt(o,a);var s="https://my.3000.com/?m=pay_value&op=index&ac=info&api_v=1.0.0&api_from=webpc",l="gid="+encodeURIComponent(r)+"&sign="+encodeURIComponent(i)+"&time="+encodeURIComponent(o);return""!==flashvars.u&&""!==flashvars.token&&(s="https://app.3000.com/?m=pay_value&op=index&ac=info&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,l+=this.getPhoneData()),n(s,l)},savePayInfo:function(){var e=this;if(flashvars.single&&"1"===flashvars.offline){var t=function(e){return new Promise(function(t,n){return window.app&&window.app.saveGameValue(flashvars.uuid+"payInfo",e),h["default"].localStorageSetItem(flashvars.uuid+"payInfo",e),t()})},n=JSON.stringify(this.context.payValues),a=h["default"].encodeBase64(n);return t(a)}var o=function(t,n,a){return P.xhrSend(t,n,null,4e3).then(function(t){if(0===t.responseText.length)return e.showToast(1,"用户数据无法保存，请在网络恢复后重新操作"),Promise.reject("Save file failed, no response data");var n=JSON.parse(t.responseText);return 0===n.status?Promise.resolve():n.status===-1?(h["default"].localStorageSetItem(flashvars.uuid+"payInfo"+flashvars.uid,a),e.showToast(2,"温馨提醒：登录后才可以同步用户数据哦～"),Promise.resolve()):2===n.status?(e.showToast(1,"用户数据保存失败，账号已在其他设备登录"),Promise.reject(n.msg+": "+n.status)):(e.showToast(1,"用户数据无法保存，请在网络恢复后重新操作"),Promise.reject(n.msg+": "+n.status))},function(t){return h["default"].localStorageSetItem(flashvars.uuid+"payInfo",a),e.showToast(1,"用户数据无法保存，请在网络恢复后重新操作"),Promise.reject(t)})},r=flashvars.u&&flashvars.token?1:0,i=JSON.stringify(this.context.payValues),s=h["default"].encodeBase64(i),l=h["default"].localTime+h["default"].timeOffset,u=""===flashvars.gid?1:parseInt(flashvars.gid),c="";c=r?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&content="+s+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+u+"&progress=1&time="+l+"&token="+flashvars.token+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"content="+s+"&gid="+u+"&progress=1&time="+l+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M";var d="https://my.3000.com/?m=pay_value&op=index&ac=save&api_v=1.0.0&api_from=webpc",f="content="+encodeURIComponent(h["default"].aesEncrypt(s,r))+"&gid="+encodeURIComponent(h["default"].aesEncrypt(u,r))+"&progress="+encodeURIComponent(h["default"].aesEncrypt(1,r))+"&sign="+encodeURIComponent(h["default"].aesEncrypt(m["default"].hash(m["default"].hash(c)),r))+"&time="+encodeURIComponent(h["default"].aesEncrypt(l,r));return""!==flashvars.u&&""!==flashvars.token&&(d="https://app.3000.com/?m=pay_value&op=index&ac=save&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,f+=this.getPhoneData()),o(d,f,s)},getPayGoodsInfo:function(e){var t=this;return this.loadCloudRecord(99).then(function(t){var n=function(e,t){return P.xhrSend(e,t,null,4e3).then(function(e){if(0===e.responseText.length)return Promise.resolve({status:"error",msg:"获取商品支付信息失败",count:0});var t=JSON.parse(e.responseText);return 0===t.status&&t.success&&t.data?Promise.resolve({status:"success",msg:t.msg,count:t.data.count}):Promise.resolve({status:"fail",msg:t.msg,count:0})},function(e){return Promise.resolve({status:"error",msg:"获取商品支付信息失败",count:0})})},a=function(e){var t=[],n=0;for(var a in e)t[n]=encodeURIComponent(a)+"="+encodeURIComponent(e[a]),n++;return t.join("&")},o="https://pay.3000.com/?m=player&op=h5_purchase_market_count",r={event_id:h["default"].aesEncrypt(e,3),game_id:h["default"].aesEncrypt(flashvars.gid,3)};return"ios"!==flashvars.client&&"android"!==flashvars.client||(o="https://app.3000.com/?m=consume&op=index&ac=h5_purchase_market_count&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,r={u:h["default"].aesEncrypt(flashvars.u,1),token:h["default"].aesEncrypt(flashvars.token,1),event_id:h["default"].aesEncrypt(e,1),game_id:h["default"].aesEncrypt(flashvars.gid,1)}),n(o,a(r))},function(e){var n=e.indexOf("- status:-1");return n=n>=0?n:e.indexOf("- status:2"),n>=0?"ios"!==flashvars.client&&"android"!==flashvars.client&&"wap"!==flashvars.client?Promise.resolve({status:"success",msg:"pc端未登入，直接提示去购买！",count:-1}):(e.indexOf("- status:-110")>0?y["default"].error(e.substr(0,n)).then(function(){return t.isPaying=!1,Promise.reject()},function(){return t.isPaying=!1,Promise.reject()}):(flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),"wap"===flashvars.client?(t.isPaying=!1,window.parent&&window.parent.playLogin()):y["default"].error(e.substr(0,n)).then(function(){t.isPaying=!1,window.location.href="lzj3000://login"},function(){t.isPaying=!1})),Promise.reject()):void(0<=e.indexOf("error")&&y["default"].error("网络异常，请检查您的网络！").then(function(){return t.isPaying=!1,Promise.reject()},function(){return t.isPaying=!1,Promise.reject()}))})},getDiscounts:function(e,t,n,a){var o=function(e){return P.xhrLoad(e,"").then(function(e){if(0===e.responseText.length)return Promise.resolve("Get Discounts failed, no response data");var t=JSON.parse(e.responseText);return Promise.resolve(t.result)},function(e){return Promise.resolve("获取商品价格失败！")})},r="uuid="+e+(t?"&chapter_uuid="+t:"&product_id="+n)+"&platform="+a;this.isWapOther()&&(r+="&key=external");var i="https://mapi.3000api.com/apis/soft/v1.0/game-getCharge.html?"+r;return o(i)},payOperation:function(e,t,n,a,o){var r=this;this.isPaySuccess=!1;var i=-1,s=function(){var s={gid:flashvars.gid,eid:t,charge:e,special_price:i,balance:o.systemValues[0].value,starsNeed:100*e,stars:o.systemValues[1].value,starsUsed:r.usedStarCount,starsLimited:r.gameStarLimit,payValues:h["default"].encodeBase64(JSON.stringify(o.payValues)),indentId:n};"ios"===flashvars.client?(r.mallPayCallback=a,"1"===flashvars.offline?worksmall(JSON.stringify(s)):window.webkit&&window.webkit.messageHandlers.worksmall.postMessage(JSON.stringify(s))):"android"===flashvars.client?(r.mallPayCallback=a,window.app&&window.app.worksmall(JSON.stringify(s))):"wap"===flashvars.client&&(r.mallPayCallback=a,s.consume_falg="mall",s.uuid=flashvars.uuid,window.parent&&window.parent.get_account_info(JSON.stringify(s)))};return"android"===flashvars.client||"ios"===flashvars.client||"wap"===flashvars.client?flashvars.app_version<"1.2.0"&&"wap"!==flashvars.client?(y["default"].info("版本过低不支持改功能，请先更新版本~").then(null,null),this.isPaying=!1,a(0),Promise.resolve(i)):this.getAccountInfo().then(function(n){if("string"==typeof n)y["default"].error("网络异常，请检查您的网络！"),a(0);else if(n.status&&n.status>0&&n.status<9)flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),"wap"===flashvars.client?window.parent&&window.parent.playLogin():y["default"].info(n.msg).then(function(){window.location.href="lzj3000://login"}),a(0);else{if(100!==n.status||n.success)return r.getDiscounts(flashvars.uuid,null,t,"app").then(function(t){return"string"==typeof t?(y["default"].error(t),a(0)):(e=t.charge,i=t.special_price,s()),Promise.resolve(i)});a(0)}return Promise.resolve(i)}):(y["default"].info("请前往APP或电脑端购买~").then(null,null),this.isPaying=!1,a(0),Promise.resolve(i))},chapterInfoProgress:function(e){var t=this.viewComponent.game.world.getByName("chapterInfoProgress");if(!t){t=this.viewComponent.game.add.group(),t.name="chapterInfoProgress";var n=this.viewComponent.game.add.graphics(0,0,t);n.beginFill(0,.5),n.drawRect(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),n.endFill(),n.name="background",n.inputEnabled=!0;var a={font:"16px 宋体",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"},o=this.viewComponent.game.add.text(0,0,"",a,t);o.setTextBounds(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),o.name="chapterInfoProgressText"}var r=t.getByName("chapterInfoProgressText");r&&(r.text="章节信息获取中..."+e)},checkIfChapterFree:function(e,t){var n=this,a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if("1"===flashvars.offline&&flashvars.single){var o=h["default"].convertSingleJsonPath(e),r=function(e){a&&n.chapterInfoProgress(e.loaded)};return P.getJson(o,r).then(function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");return t&&t.destroy(),"100"===e.code?Promise.resolve(e.result.plots):"1"===flashvars.offline?Promise.resolve(e.plots):Promise.reject(e.message+" code="+e.code)})}var i=function(e,t){var o=function(e){a&&n.chapterInfoProgress(e.loaded)};return P.xhrSend(e,t,o).then(function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");if(t&&t.destroy(),0===e.responseText.length)return Promise.reject("Get chapterInfo failed, no response data");var a=JSON.parse(e.responseText);return"100"===a.code?Promise.resolve(a.result.plots):1==flashvars.offline?Promise.resolve(a.plots):Promise.reject(a.message+" code="+a.code)},function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");return t&&t.destroy(),Promise.reject(e)})},s=function(){flashvars.u||flashvars.token||"wap"===flashvars.client||(flashvars.uid=h["default"].getUidByCookie());var a="uuid="+flashvars.uuid+"&uid="+flashvars.uid+"&chapter_uuid="+e+"&md5="+t+"&platform="+(flashvars.client?"app":"pc");n.isWapOther()&&(a+="&key=external");var o="https://mapi.3000api.com/apis/soft/v1.0/chapter-chapterInfo.html?"+a;return i(o,a)};return"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){return s()}):s()},unlockChapterByWapOther:function(e,t,n,a){var o=this;if(this.isWapOther()){var r=0,i=function(e,t,n,a){var r=-1;o.getDiscounts(e,t,null,"app").then(function(e){"string"!=typeof e&&(n=e.charge,r=e.special_price);var o=h["default"].generateUUID();h["default"].timeout(100).then(function(){y["default"].custom("Info","当前为收费章节，需支付"+n+"元解锁观看","章节收费提示","支付","取消",!1).then(function(e){S["default"].pay(n,t,o,t,null,0,function(e){a&&a(e)})},function(e){a&&a("cancel")})})})},s=function(o){"success"===o?l(e,n,t):"cancel"===o?a&&a(null):"fail"===o&&y["default"].custom("Info","未查询到你的付费信息哦，请确认已支付再点击刷新。如未购买请退出或重新购买~","提示","重试","退出",!1,3,0).then(function(){l(e,n,t)},function(){a&&a(null)})},l=function(e,t,n){r++,o.checkIfChapterFree(e,t).then(function(e){a&&a(e)},function(t){-1===t.indexOf("code=87")?y["default"].error(t).then(function(){a&&a(null)},function(){a&&a(null)}):r<=1?i(flashvars.uuid,e,n,s):r<4?s("fail"):a&&a("fail")})};l(e,n,t,a)}},unlockChapter:function(e,t,n,a){var o=this,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(flashvars.app_version<"1.2.0"&&"wap"!==flashvars.client)return r&&y["default"].info("该章节为付费章节，当前版本过低，不支持该功能"),void a(!1,!0);var i=-1;this.getDiscounts(flashvars.uuid,e,null,"app").then(function(r){if("string"!=typeof r&&(t=r.charge,i=r.special_price),"ios"===flashvars.client){var s={gid:flashvars.gid,uuid:e,charge:t,md5:n,special_price:i};o.unlockChapterCallBack=a,1==flashvars.offline?unlock(JSON.stringify(s)):window.webkit&&window.webkit.messageHandlers.unlock.postMessage(JSON.stringify(s))}else if("android"===flashvars.client)window.app&&window.app.unlock(flashvars.gid,e,t,n),o.unlockChapterCallBack=a;else if("wap"===flashvars.client){o.unlockChapterCallBack=a;var l=function(){var a={uuid:flashvars.uuid,gid:flashvars.gid,chapter_uuid:e,charge:t,md5:n,special_price:i,author_id:flashvars.uid,consume_falg:"chapter"};window.parent&&window.parent.get_account_info(JSON.stringify(a))};""===flashvars.uid?o.getUserInfoFromWap().then(function(){""===flashvars.uid?y["default"].info("该章节为付费章节，需登录后查看~").then(function(){a(!1,!0,!0),window.parent&&window.parent.playLogin()},function(){a(!1,!0,!0)}):l()}):l()}})},getPhoneData:function(){var e=encodeURIComponent(h["default"].aesEncrypt(flashvars.u,1)),t=encodeURIComponent(h["default"].aesEncrypt(flashvars.token,1)),n=encodeURIComponent(h["default"].aesEncrypt(""===flashvars.app_name?"shanyi":flashvars.app_name,1)),a=encodeURIComponent(h["default"].aesEncrypt(""===flashvars.device_name?"Google Nexus S":flashvars.device_name,1)),o=encodeURIComponent(h["default"].aesEncrypt(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer,1));return"&u="+e+"&token="+t+"&app_name="+n+"&device_name="+a+"&device_system_version="+o},loadCloudRecord:function(e){var t=function(e,t){return P.xhrSend(e,t).then(function(e){if(0===e.responseText.length)return Promise.reject("Get file failed, no response data");var t=JSON.parse(e.responseText);if(0===t.status){var n=t.data.content||"",a=h["default"].decryptBase64(n);return Promise.resolve(a)}return Promise.reject(t.msg+" - status:"+t.status)},function(e){return Promise.reject(e)})},n=flashvars.u&&flashvars.token?1:0,a=h["default"].localTime+h["default"].timeOffset,o=""===flashvars.gid?1:parseInt(flashvars.gid),r="",i=e+"";r=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+o+"&time="+a+"&token="+flashvars.token+"&type="+i+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"gid="+o+"&time="+a+"&type="+i+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M",o=h["default"].aesEncrypt(o,n),r=h["default"].aesEncrypt(m["default"].hash(m["default"].hash(r)),n),a=h["default"].aesEncrypt(a,n),i=h["default"].aesEncrypt(i,n);var s="https://my.3000.com/?m=cloud_save&op=index&ac=info&client_type=1&api_v=1.0.0&api_from=webpc",l="gid="+encodeURIComponent(o)+"&sign="+encodeURIComponent(r)+"&time="+encodeURIComponent(a)+"&type="+encodeURIComponent(i);return""!==flashvars.u&&""!==flashvars.token&&(s="https://app.3000.com/?m=cloud_save&op=index&ac=info&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,l+=this.getPhoneData()),t(s,l)},saveCloudRecord:function(e){var t=function(e,t){return P.xhrSend(e,t).then(function(e){if(0===e.responseText.length)return Promise.reject("Save file failed, no response data");var t=JSON.parse(e.responseText);return 0===t.status?Promise.resolve():Promise.reject(t.msg+": "+t.status)},function(e){return Promise.reject(e)})},n=flashvars.u&&flashvars.token?1:0,a=JSON.stringify(this.savedPlotsData[e]),o=h["default"].encodeBase64(a),r=h["default"].localTime+h["default"].timeOffset,i=""===flashvars.gid?1:parseInt(flashvars.gid),s="";s=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&content="+o+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+i+"&progress=1&time="+r+"&token="+flashvars.token+"&type="+e+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"content="+o+"&gid="+i+"&progress=1&time="+r+"&type="+e+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M";var l="https://my.3000.com/?m=cloud_save&op=index&ac=save&client_type=1&api_v=1.0.0&api_from=webpc",u="content="+encodeURIComponent(h["default"].aesEncrypt(o,n))+"&gid="+encodeURIComponent(h["default"].aesEncrypt(i,n))+"&progress="+encodeURIComponent(h["default"].aesEncrypt(1,n))+"&sign="+encodeURIComponent(h["default"].aesEncrypt(m["default"].hash(m["default"].hash(s)),n))+"&time="+encodeURIComponent(h["default"].aesEncrypt(r,n))+"&type="+encodeURIComponent(h["default"].aesEncrypt(e+"",n));return""!==flashvars.u&&""!==flashvars.token&&(l="https://app.3000.com/?m=cloud_save&op=index&ac=save&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,u+=this.getPhoneData()),t(l,u)},getViewData:function(e,t){for(var n={},a=function r(e,t){for(var a=0;a<e.length;a++)if(e[a].xInfo&&e[a].yInfo){var o={name:e[a].name,instanceUuid:e[a].instanceUuid,xInfo:e[a].xInfo,yInfo:e[a].yInfo,eventsInfo:e[a].eventsInfo,scale:e[a].scale,visible:e[a].visible};o.children=[],"TIMER"===e[a].viewType&&(n.currentCount=e[a].currentCount),r(e[a].children,o),t.children.push(o)}},o=0;e&&o<e.length;o++)e[o].parent&&(n={name:e[o].name,instanceUuid:e[o].instanceUuid,xInfo:e[o].xInfo,yInfo:e[o].yInfo,eventsInfo:e[o].eventsInfo,scale:e[o].scale,parent:e[o].parent.name,x:e[o].x,y:e[o].y,visible:e[o].visible},n.children=[],"TIMER"===e[o].viewType&&(n.currentCount=e[o].currentCount),e[o].generateType&&(n.generateType=e[o].generateType),a(e[o].children,n),t.push(n))},getViewParentEvents:function(e){var t=this.json_data.viewMap;for(var n in t){if(n===e)return t[n].events.concat();for(var a in t.children)if(t.children[a].ref===e)return t.children[a].events.concat()}},copyFlashViewData:function(e,t){var n=!0;if(t&&t.historyCommand&&t.historyCommand.hideGlobalViews)for(var a=0;a<t.historyCommand.hideGlobalViews.length;a++)if(e.instanceUuid===t.historyCommand.hideGlobalViews[a]){n=!1;break}var o={name:e.ref,instanceUuid:e.instanceUuid,xInfo:"[object Object]"===Object.prototype.toString.apply(e.x)?e.x:{type:"literal",value:e.x},yInfo:"[object Object]"===Object.prototype.toString.apply(e.y)?e.y:{type:"literal",value:e.y},scale:{x:e.scale,y:e.scale,type:25},visible:n};e.currentCount&&(o.currentCount=e.currentCount),o.children=[];for(var r=0;r<e.children.length;r++)o.children[r]=this.copyFlashViewData(e.children[r],t),o.children[r].eventsInfo=this.getViewParentEvents(e.ref);return o},getWeatherType:function(){if(!this.weatherLayer.visible)return"";var e=this.weatherLayer.getByName("wind");return e&&e.visible?"windy":(e=this.weatherLayer.getByName("snow"),e&&e.visible?"snowy":(e=this.weatherLayer.getByName("rain"),e&&e.visible?"rainy":(e=this.weatherLayer.getByName("beachBlossom"),e&&e.visible?"fallingPeach":(e=this.weatherLayer.getByName("blossom"),e&&e.visible?"fallingFlower":(e=this.weatherLayer.getByName("lightning"),e&&e.visible?"lightning":(e=this.weatherLayer.getByName("fallingLeaves"),e&&e.visible?"defoliation":""))))))},getScreenAnime:function(){return this.shakeLoopObj.loop===!0?JSON.parse(JSON.stringify(this.shakeLoopObj)):{level:0,duration:0,delay:0,loop:!1,commands:null}},getBubbleData:function(e){var t=[];if(this.saveBubbleVector.length>0)for(var n=0;n<this.saveBubbleVector.length;n++){var a=this.saveBubbleVector[n];e&&this.clearBubbleData(n);for(var o=[],r=0;r<a.savebubble.length;r++)o.push(a.savebubble[r]);for(var i=[],s=0;s<a.curbubble.length;s++)i.push(a.curbubble[s]);t.push({bubbleMode:a.commands,bubble:o,curbubble:i,ishide:a.ishide,iscurrent:a.iscurrent})}return t},bubbleUpper:function(){for(var e=this,t=function(){var t=e.bubbleArchivalCount.shift(),n=function(e,t){for(var n=0;n<e.length;n++)if(e[n].uuid===t){e.splice(n,1);break}};e.saveBubbleVector.forEach(function(e,a){n(e.savebubble,t),n(e.curbubble,t)})};this.bubbleArchivalCount.length>1e3;)t()},clearBubbleData:function(e){var t=this,n=function(e){var n=function(e){for(var n=0;n<t.bubbleArchivalCount.length;n++)if(t.bubbleArchivalCount[n]===e)return n;return-1},a=n(e);a!==-1&&t.bubbleArchivalCount.splice(a,1)};if(e!==-1)if(2===this.saveBubbleVector[e].remove){for(var a=this.saveBubbleVector[e],o=0;o<a.savebubble.length;o++)n(a.savebubble[o].uuid);this.bubbleLayer.removeChild(a),this.saveBubbleVector.splice(e,1),a.destroy()}else if(1===this.saveBubbleVector[e].remove){var r=function(n){for(var a=0;a<t.saveBubbleVector[e].savebubble.length;a++)if(t.saveBubbleVector[e].savebubble[a].uuid===n.uuid)return a;return-1};this.saveBubbleVector[e].curbubble.forEach(function(a,o){var i=r(a);n(a.uuid),i!==-1&&t.saveBubbleVector[e].savebubble.splice(i,1)}),this.saveBubbleVector[e].curbubble=[]}},saveRecord:function(e,t){var n=this;if(0===e&&this.json_data.default_settings.autoSaveOrLoad&&!t)return Promise.resolve(null);var a=function(){!n.savedPlotsData&&n.loadData();var a=Date.now(),o=[],r=[],i=[];n.getViewData(n.globalViews,o),n.getViewData(n.plotViews,r),
n.bubbleUpper();var s={};if(s.plotUuid=n.curChapter.plots[n.curPlotIndex].uuid,s.chapterUuid=n.curChapter.uuid,s.bkKey=n.lstPlotBkKey,s.bkOpacity=n.lstPlotBkOpacity,s.bkFlex=n.lstPlotBkFlex,s.cmdUuid=n.curCmdUuid,s.bCmdAutoText=n.bCmdAutoText,s.timestamp=a,s.context=JSON.parse(JSON.stringify(n.context)),s.plotSnap=n.plotSnap,s.weatherType=n.getWeatherType(),s.globalViews=o.concat(),s.plotViews=r.concat(),s.playbackData=n.playbackData.concat(),s.animateScene={shake:null},s.animateScene.shake=n.getScreenAnime().commands,s.bubble=[],s.bubble=n.getBubbleData().concat(),s.bubbleCount=[],s.bubbleCount=n.bubbleArchivalCount&&n.bubbleArchivalCount.concat(),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(s.music={url:b["default"].musicInfo.key,volume:b["default"].musicInfo.prevolume||b["default"].musicInfo.volume,inheritvolume:b["default"].musicInfo.inheritvolume},s.sounds=b["default"].soundsInfo.map(function(e){return e.key?{url:e.key,volume:e.prevolume||e.volume,time:e.loop?0:1,inheritvolume:e.inheritvolume}:null})):(s.music={url:n.bk_music&&n.bk_music.key,volume:n.bk_music&&(n.bk_music.prevolume||n.bk_music.volume),inheritvolume:n.bk_music&&n.bk_music.inheritvolume},s.sounds=n.plotSounds.map(function(e){return e?{url:e.key,volume:e.prevolume||e.volume,time:e.loop?0:1,inheritvolume:e.inheritvolume}:null})),""!==n.curCmdUuid){n.charsAndPropsLayer&&n.charsAndPropsLayer.children.forEach(function(e){var t=e.children[0],n={url:t.key,x:t.x,y:t.y,width:t.width,height:t.height,opacity:t.alpha,pivotX:t.pivot.x,pivotY:t.pivot.y,scaleX:t.scale.x,scaleY:t.scale.y,rotate:t.angle,cmdUuid:t.cmdUuid,index:e.zIndex,parentScale:e.scale.x,mirrorH:!!t.mirrorH&&t.mirrorH,mirrorV:!!t.mirrorV&&t.mirrorV};t.finalState&&(n.x=t.finalState.x,n.y=t.finalState.y,n.opacity=t.finalState.alpha,n.rotate=t.finalState.angle),e.finalState&&(n.parentScale=e.finalState.scale.x),i.push(n)});var l=n.curPlotLayer.children[1];s.bk={},l&&(s.bk={url:l.key,opacity:l.alpha},l.finalState&&(s.bk.opacity=l.finalState.alpha))}return s.charsAndProps=i.concat(),s.dialogInfo=n.lstDialogInfo.concat(),s.menuInfo=n.menuInfo.concat(),n.savedPlotsData[e]=JSON.parse(JSON.stringify(s)),n.bSignedIn&&n.bCloudSel&&(n.cloudPlotsData[e]=JSON.parse(JSON.stringify(s))),n.saveData(e,t).then(function(e){return Promise.resolve(s)},function(e){return Promise.resolve(null)})};return t!==!0||this.bSignedIn===!0?a():void this.isSignedIn().then(function(){return n.bCloudSel=!0,a()},function(){return a()})},loadRecord:function(e){var t=this;!this.savedPlotsData&&this.loadData();var n=this.savedPlotsData[e],a=n.plotUuid,o=n.chapterUuid,r=n.context,s=n.playbackData,l=function(n,a){t.destroyAll(),t.saveBubbleDataVector=[],t.lstPlotBkKey=t.savedPlotsData[e].bkKey,t.lstPlotBkOpacity=t.savedPlotsData[e].bkOpacity,t.lstPlotBkFlex=t.savedPlotsData[e].bkFlex,t.globalViews=t.savedPlotsData[e].globalViews.concat(),t.plotViews=t.savedPlotsData[e].plotViews.concat(),t.charsAndPropsInfo=t.savedPlotsData[e].charsAndProps.concat(),t.lstDialogInfo=t.savedPlotsData[e].dialogInfo?t.savedPlotsData[e].dialogInfo.concat():[],t.menuInfo=t.savedPlotsData[e].menuInfo?t.savedPlotsData[e].menuInfo.concat():[],t.curCmdUuid=t.savedPlotsData[e].cmdUuid,t.bCmdAutoText=t.savedPlotsData[e].bCmdAutoText,t.saveBubbleDataVector=t.savedPlotsData[e].bubble?t.savedPlotsData[e].bubble.concat():[],t.bubbleArchivalCount=t.savedPlotsData[e].bubbleCount?t.savedPlotsData[e].bubbleCount.concat():[],t.visibleLayout[0]&&(t.visibleLayout[0].visible=!0),t.visibleLayout=t.visibleLayout.slice(1),t.recordLayer.visible=!1,t.mainMenuLayer.visible=!1,t.endLayer.visible=!1,t.onResume(),t.removePlotTweens(),t.playbackData=[],s.forEach(function(e){return t.addPlayBackContent(e)});var o={};t.curCmdUuid&&(""!==t.savedPlotsData[e].weatherType&&("snow"!==t.savedPlotsData[e].weatherType&&"wind"!==t.savedPlotsData[e].weatherType&&"rain"!==t.savedPlotsData[e].weatherType||(t.savedPlotsData[e].weatherType+="y")),o=t.getCommandByCommandUuid(d.plots[a],t.curCmdUuid),o.cmdScreenSnap={charsAndProps:JSON.parse(JSON.stringify(t.savedPlotsData[e].charsAndProps)),sounds:t.savedPlotsData[e].sounds,music:t.savedPlotsData[e].music,plotViews:t.plotViews,dialogInfo:t.lstDialogInfo,menuInfo:t.menuInfo,bk:t.savedPlotsData[e].bk,weatherType:t.savedPlotsData[e].weatherType,autoText:t.bCmdAutoText},o.animateScene={shake:null},t.savedPlotsData[e].animateScene&&t.savedPlotsData[e].animateScene.shake&&(o.animateScene.shake=Object.assign(t.savedPlotsData[e].animateScene.shake,{}))),t.initContext(r,!0),r.commandInserts&&(t.context.commandInserts=r.commandInserts.concat()),r.inserts&&(t.context.inserts=r.inserts.concat());var i={music:t.savedPlotsData[e].music,sounds:t.savedPlotsData[e].sounds,charsAndProps:t.charsAndPropsInfo,background:t.lstPlotBkKey,images:[t.lstDialogInfo&&t.lstDialogInfo[0]?{url:t.lstDialogInfo[0].avatar.url}:{}],bubble:t.saveBubbleDataVector};t.preloadChapterAssets(t.context,n,a,o,i),t.coverLayer.visible=!1,!t.isGameStarted&&t.notifyGameStarted()},u=function(e,n){if(n<0){var r=t.getChapterByPlotUuid(t.json_data,a,o),i=r.chapter,s=r.index;l(i,s)}else l(e,n)};if(!a)return!1;var c=this.getChapterByPlotUuid(this.json_data,a,o),d=c.chapter,h=c.index,f=d.downloadUuid?d.downloadUuid:d.uuid,m=function(){var e=function(e){e&&t.checkIfChapterFree(f,d.md5).then(function(e){var n;t.isPreferentialFinished=!1,t.unlockChapterCallBack=null,(n=d.plots).push.apply(n,i(e)),u(d,h)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():y["default"].error("获取付费章节信息失败")})};t.unlockChapter(f,d.charge,d.md5,e)};if(this.isPreferentialFinished===!1||"android"!==flashvars.client&&"ios"!==flashvars.client||this.checkIfChapterFree(f,d.md5).then(function(e){e.length<=0?m():t.isPreferentialFinished=!1},function(e){m()}),d&&d.md5&&0===d.plots.length){if(this.isWapOther()){var p=function(e){if(null===e)y["default"].error("获取付费章节信息失败");else if("fail"===e)y["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,L["default"])("819786897",{debug:!1,message:"复制成功"})},function(){});else{var t;(t=d.plots).push.apply(t,i(e?e:[])),u(d,h)}};return void this.unlockChapterByWapOther(f,d.charge,d.md5,p)}!d.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client?this.checkIfChapterFree(f,d.md5).then(function(e){var t;(t=d.plots).push.apply(t,i(e)),u(d,h)},function(e){-1===e.indexOf("code=87")?y["default"].error(e):"zxwwap"===flashvars.wap?y["default"].info("当前为收费章节，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid}):y["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")}):""!==flashvars.uid&&"wap"===flashvars.client?this.checkIfChapterFree(f,d.md5).then(function(e){var t;(t=d.plots).push.apply(t,i(e)),u(d,h)},function(){m()}):m()}else d&&-4!==h&&l(d,h);return!0},onRecordItemClicked:function(e,t){var n=this,a=4*t+e,o=function(){return n.bToSaveFile?n.gameUidBelongTo!==n.recUidBelongTo&&""!==n.gameUidBelongTo||n.recUidBelongTo!==flashvars.uid?y["default"].info("存档失败，请登录正确的账号后重新尝试"):n.saveRecord(a).then(function(e){if(!e)return!1;var t=n.recordLayer.getByName("scrollPane").children.find(function(e){return e.name==="recordItem_"+a}),o=t.getByName("content"),r=t.getByName("textTime"),i=function(e){var t=o.width,n=o.height;o.loadTexture(e),o.width=t,o.height=n},s=m["default"].hash(e.plotSnap);n.viewComponent.game.load.cache.checkImageKey(s)?i(s):n.addImageUrl(e.plotSnap,s).then(function(){return i(s)});var l=h["default"].getCurrentDateTime(e.timestamp);if(C["default"].fontFamily){var u=n.json_data.font.size?n.toRealImageFontHeight(r.fontSize):r.fontSize,c=n.json_data.font.size?n.toRealImageFontWidth(r.fontSize):r.fontSize;n.addImageFontText([{data:l}],c,u,r,n.context),r.text=" "}else r.text=l}):n.recUidBelongTo===flashvars.uid?(n.gameUidBelongTo=n.recUidBelongTo,n.savedPlotsData&&n.savedPlotsData[a].plotUuid&&!n.savedPlotsData[a].context?n.loadCloudRecord(a).then(function(e){var t=function(e){var t=JSON.parse(e);if(t.context)n.savedPlotsData[a]=t;else{n.savedPlotsData[a].plotUuid=t.plotUuid,n.savedPlotsData[a].chapterUuid=t.chapterUuid?t.chapterUuid:void 0,n.savedPlotsData[a].bkKey=t.backgroundObject?t.backgroundObject.url:null,n.savedPlotsData[a].context={},n.savedPlotsData[a].context.auto=!1,n.savedPlotsData[a].context.fullScreen=!1,n.savedPlotsData[a].context.values=[],n.savedPlotsData[a].context.savedValues=[],n.savedPlotsData[a].context.stringValues=[],n.savedPlotsData[a].context.indexValues=[];for(var o=0;o<t.values.length;o++)if(t.values[o].saved){for(var r=n.savedPlotsData[a].context.savedValues.length,i=0;i<n.json_data.savedValues.length;i++)if(n.json_data.savedValues[i].uuid===t.values[o].key){r=i;break}n.savedPlotsData[a].context.savedValues[r]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].index){for(var s=n.savedPlotsData[a].context.indexValues.length,l=0;l<n.json_data.indexValues.length;l++)if(n.json_data.indexValues[l].uuid===t.values[o].key){s=l;break}n.savedPlotsData[a].context.indexValues[s]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].init&&"string"===t.values[o].init.type){for(var u=n.savedPlotsData[a].context.stringValues.length,c=0;c<n.json_data.stringValues.length;c++)if(n.json_data.stringValues[c].uuid===t.values[o].key){u=c;break}n.savedPlotsData[a].context.stringValues[u]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].key&&"_"!==t.values[o].key[2]&&!t.values[o].pay){for(var d=n.savedPlotsData[a].context.values.length,h=0;h<n.json_data.values.length;h++)if(n.json_data.values[h].uuid===t.values[o].key){d=h;break}n.savedPlotsData[a].context.values[d]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}n.savedPlotsData[a].context.stack=(t.stack||[]).concat(),n.savedPlotsData[a].context.cmdStack=(t.cmdStack||[]).concat(),n.savedPlotsData[a].globalViews=[],n.savedPlotsData[a].plotViews=[];for(var f=0;f<t.globalViewsData.length;f++)n.savedPlotsData[a].globalViews[f]=n.copyFlashViewData(t.globalViewsData[f],t.commandObj),n.savedPlotsData[a].globalViews[f].x=n.Expression.safeEval(t.globalViewsData[f].x,n.savedPlotsData[a].context)*(1-t.globalViewsData[f].scale),n.savedPlotsData[a].globalViews[f].y=n.Expression.safeEval(t.globalViewsData[f].y,n.savedPlotsData[a].context)*(1-t.globalViewsData[f].scale),n.savedPlotsData[a].globalViews[f].parent="__world";for(var m=0;m<t.viewsData.length;m++)n.savedPlotsData[a].plotViews[m]=n.copyFlashViewData(t.viewsData[m],t.commandObj),n.savedPlotsData[a].plotViews[m].x=n.Expression.safeEval(t.viewsData[m].x,n.savedPlotsData[a].context)*(1-t.viewsData[m].scale),n.savedPlotsData[a].plotViews[m].y=n.Expression.safeEval(t.viewsData[m].y,n.savedPlotsData[a].context)*(1-t.viewsData[m].scale),n.savedPlotsData[a].plotViews[m].parent="plotViewsLayer";n.savedPlotsData[a].music=t.musics[0]?{url:t.musics[0].url,volume:t.musics[0].volume}:{},n.savedPlotsData[a].sounds=t.sounds.concat(),n.savedPlotsData[a].playbackData=t.speakings.concat(),n.savedPlotsData[a].bk={},n.savedPlotsData[a].charsAndProps=[],n.savedPlotsData[a].dialogInfo=[],n.savedPlotsData[a].cmdUuid="",n.savedPlotsData[a].weatherType="",n.savedPlotsData[a].bCmdAutoText=!1;var p=function(e){for(var t=0;t<e.length;t++){var o=e[t],r={args:o.args,type:o.type,uuid:o.uuid},i=[],s=[],l=!o.show,u=t===e.length-1;if(o.bubble&&o.bubble.length>0){for(var c=0;c<o.bubble.length;c++)i.push(o.bubble[c]);s=o.bubble.slice(o.bubble.length-o.currentCount)}n.savedPlotsData[a].bubble.push({bubbleMode:r,bubble:i,curbubble:s,ishide:l,iscurrent:u})}};if(t.commandObj&&t.commandObj.historyCommand){var y=t.commandObj.historyCommand,g=y.images,v=y.dialog,x=y.autotext,P=y.weather;if(n.savedPlotsData[a].cmdUuid=t.commandObj.commandUuid,n.savedPlotsData[a].bCmdAutoText=!!x&&x.args[0],n.savedPlotsData[a].dialogInfo=v&&v.command?v.command.args:[],n.savedPlotsData[a].weatherType=P&&P.args[0],t.commandObj.historyCommand.animateScene?n.savedPlotsData[a].animateScene=t.commandObj.historyCommand.animateScene:n.savedPlotsData[a].animateScene=null,g)for(var w=0;w<g.length;w++)if(g[w].index>1){var b={url:g[w].url,x:g[w].x,y:g[w].y,width:g[w].width,height:g[w].height,opacity:g[w].opacity,rotate:g[w].rotate,index:g[w].index,mirrorH:!!g[w].mirrorH&&g[w].mirrorH,mirrorV:!!g[w].mirrorV&&g[w].mirrorV};n.savedPlotsData[a].charsAndProps.push(b)}else 1===g[w].index&&(n.savedPlotsData[a].bk={url:g[w].url,opacity:g[w].opacity});n.savedPlotsData[a].bubble=[],t.commandObj.historyCommand.bubbleMode&&p(t.commandObj.historyCommand.bubbleMode),n.savedPlotsData[a].bubbleCount=[],t.commandObj.historyCommand.bubbleCount&&(n.savedPlotsData[a].bubbleCount=t.commandObj.historyCommand.bubbleCount.concat())}else n.savedPlotsData[a].bubble=[],t.bubbleMode&&p(t.bubbleMode),n.savedPlotsData[a].bubbleCount=[],n.savedPlotsData[a].bubbleCount=t.bubbleCount&&t.bubbleCount.concat();t.commandInserts&&t.commandInserts.length&&(n.savedPlotsData[a].context.commandInserts=t.commandInserts.concat()),t.inserts&&t.inserts.length&&(n.savedPlotsData[a].context.inserts=t.inserts.concat()),n.cloudPlotsData[a]=JSON.parse(JSON.stringify(n.savedPlotsData[a]))}};t(e),n.loadRecord(a),n.showMenu()},function(){y["default"].error("获取存档数据失败")}):(n.loadRecord(a),n.showMenu())):y["default"].info("读档失败，请登录正确的账号后重新尝试"),!0};if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var r=h["default"].getUidByCookie();flashvars.uid=r}return"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){return o()}):o()},onPlaybackBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.playBackLayer.removeAll(!0),this.visibleLayout=this.visibleLayout.slice(1),this.playBackLayer.visible=!1},addPlayBackContent:function(e){this.sendNotification(diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT,e)},showLoadingToast:function(e){1===e?(this.loadingToastLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.loadingToastLayer)):0===e&&(this.loadingToastLayer.visible=!1)},showToast:function(e,t){var n=this.toastLayer.getByName("typeSuccess"),a=this.toastLayer.getByName("typeError");n&&(0===e?(n.visible=!0,n.children[2].text=t,n.children[0].width=n.children[2].width+36,n.x=(this.viewComponent.game.world.width-n.children[0].width)/2,n.y=flashvars.vertical?100:252):n.visible=!1),a&&(1===e?(a.visible=!0,a.children[2].text=t,a.children[0].width=a.children[2].width+36,a.children[1].visible=!0,a.children[2].x=30,a.x=(this.viewComponent.game.world.width-a.children[0].width)/2,a.y=flashvars.vertical?100:252):2===e?(a.visible=!0,a.children[2].text=t,a.children[0].width=a.children[2].width+20,a.children[1].visible=!1,a.children[2].x=10,a.x=(this.viewComponent.game.world.width-a.children[0].width)/2,a.y=flashvars.vertical?100:252):a.visible=!1),this.toastLayer.alpha=0,this.viewComponent.game.world.bringToTop(this.toastLayer),this.viewComponent.game.add.tween(this.toastLayer).from({alpha:1},2500,null,!0).name="toast"},addRetroText:function(e,t,n,a,o){var r=this.viewComponent.game.add.retroFont(C["default"].fontFamily,C["default"].charWidth,C["default"].charHeight,C["default"].fontChars,C["default"].countPerRow),i=this.viewComponent.game.add.image(e?e:0,t?t:0,r);return i.fontImg=r,document.body.clientWidth<document.body.clientHeight&&(r.stamp.angle=-90),o&&(r.setText(o,!0,0,0,"center",!0),n&&(i.width=n),a&&(i.height=a)),i},addImageFontTextColors:function(e,t,n){t.colors.splice(0,t.colors.length);var a=0,o=this.json_data.default_settings.color;t.fill=o;for(var r=0;r<e.length;r++){var i="";if(!e[r].lineBreak){if(i=e[r].placeholder&&"\\"===e[r].data[0]?this.Expression.parseWaitTime(e[r].data):this.Expression.parseValue(e[r].data,n),o=e[r].color?e[r].color:this.json_data.default_settings.color,"#"===o[0]&&4===o.length){var s="#"+o[1]+o[1]+o[2]+o[2]+o[3]+o[3];o=s}t.addColor(o,a),a+=i.length}}},addImageFontText:function(e,t,n,a,o,r,i){var s=this,l=this.Expression;if(a.children.length){for(var u=a.children[0],c=a.children[1],d=0;d<u.children.length;d++){var h=u.getChildAt(d),f=h.fontImg;f.destroy(),h.destroy()}u.destroy(),c&&c.destroy(),a.removeChildren()}var m=0,p=0,y="#fffffe",g=0,v=0,x=parseFloat(n),P=parseFloat(t),w=this.json_data.font.size?this.json_data.font.size.target.height?this.json_data.font.size.target.height:this.json_data.font.size.target:this.json_data.default_settings.font_size,b=this.json_data.font.size?x*this.json_data.font.size.source/w:x,k=this.json_data.font.size?1.5*b-x:.5*b,_=[],S={content:"",color:"#fffffe",x:0,y:0,space:0},I=0,L=[];p+=.5*k;for(var E=0;E<e.length;E++){var T="";if(e[E].lineBreak){if(E===e.length-1)break;p+=x+k,m=0}else{T=e[E].placeholder&&"\\"===e[E].data[0]?l.parseWaitTime(e[E].data):l.parseValue(e[E].data,o);for(var M=0;M<T.length;M++){a.colors[I]&&(y=a.colors[I],"#ffffff"===y&&(y="#fefefe"));var O=C["default"].getLeftMargin(T[M],P),A=C["default"].getCharSpace(T[M],P),V=m+O;V+A>a.style.wordWrapWidth&&(g<V+A&&(g=V+A),m=0,V=m+O,p+=x+k,v=O),0===S.space&&(S.space=A,S.color=y,S.x=V,S.y=p,0===v&&(v=O)),32===T[M].charCodeAt(0)||160===T[M].charCodeAt(0)||" "===T[M]||"　"===T[M]||8195===T[M].charCodeAt(0)?(S.content&&_.push(S),_.push({content:T[M],color:y,x:V,y:p,space:A}),S={content:"",color:"#fffffe",x:0,y:0,space:0}):S.space!==A||S.color!==y||S.y!==p||P!==A?(S.content&&_.push(S),S={content:T[M],color:y,x:V,y:p,space:A}):S.content+=T[M],L.push({x:V,y:p,space:A,bottomInText:p+x}),I++,m+=A}}}if(e.length){S.content&&(_[_.length-1]!==S&&_.push(S),g<m&&(g=m));var B=this.viewComponent.game.add.sprite(0,0);if(_.forEach(function(e){if(32!==e.content.charCodeAt(0)&&160!==e.content.charCodeAt(0)&&" "!==e.content&&"　"!==e.content&&8195!==e.content.charCodeAt(0)){var t=s.addRetroText(e.x,e.y,P*e.content.length,x,e.content);t.tint=parseInt(e.color.replace("#","0x")),B.addChild(t)}}),B.extWidth=g,B.extMargin=v,a.addChild(B),a.posInfo=L,_.length&&(a.imgFBottom=_[_.length-1].y+x),r){var N=this.viewComponent.game.add.graphics(0,0),j=a.style.wordWrapWidth,R=i?540:this.json_data.template.json.dialog.rect.height;N.beginFill(16777215),N.drawRect(-j,-R,2*j,R),N.drawRect(-j,0,j,x),N.endFill(),B.mask=N,a.addChild(N)}}},saveData:function(e,t){var n=this;return new Promise(function(a,o){flashvars.uuid&&!n.bCloudSel?(h["default"].localStorageSetItem(flashvars.uuid+flashvars.uid,JSON.stringify(n.savedPlotsData)),!t&&n.showToast(0,"存档成功，下次可以从这里读档继续哦~"),a()):flashvars.gid&&n.bCloudSel&&(n.showLoadingToast(1),n.saveCloudRecord(e).then(function(e){n.showLoadingToast(0),!t&&n.showToast(0,"存档成功，下次可以从这里读档继续哦~"),a()},function(e){n.showLoadingToast(0),!t&&n.showToast(1,"存档失败，请检查您的网络哦~"),o()}))})},loadData:function(e){var t=this,n=function(){if(t.bCloudSel?""===t.recUidBelongTo&&(t.recUidBelongTo=flashvars.uid):t.recUidBelongTo=flashvars.uid,flashvars.uuid)if(t.bSignedIn&&t.bCloudSel)t.savedPlotsData=JSON.parse(JSON.stringify(t.cloudPlotsData));else{var e=h["default"].localStorageGetItem(flashvars.uuid+flashvars.uid);e&&"ios"===flashvars.client&&(e=e.replace(/\n/g,""),e=e.replace(/\r/g,"")),t.savedPlotsData=JSON.parse(e)}t.savedPlotsData||(t.savedPlotsData=Array(12).fill({}))};if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var a=h["default"].getUidByCookie();""!==a&&flashvars.uid!==a?(flashvars.uid=a,this.localRecFileToUidRecFile(e)):flashvars.uid=a}"wap"===flashvars.client&&""===flashvars.uid?this.getUserInfoFromWap().then(function(){n()}):n()},getSnap:function(){var e=document.createElement("canvas");e.width=this.viewComponent.game.world.width/3,e.height=this.viewComponent.game.world.height/3,this.viewComponent.game.updateRender(1);var t=e.getContext("2d"),n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;n>a?(flashvars.vertical?(t.save(),t.translate(0,e.height),t.rotate(-90*Math.PI/180),t.drawImage(this.viewComponent.game.canvas,0,0),t.restore()):t.drawImage(this.viewComponent.game.canvas,0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height,0,0,e.width,e.height),this.plotSnap=e.toDataURL("image/jpeg",.3)):(flashvars.vertical?t.drawImage(this.viewComponent.game.canvas,0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height,0,0,e.width,e.height):(t.save(),t.translate(0,e.height),t.rotate(-90*Math.PI/180),t.drawImage(this.viewComponent.game.canvas,0,0),t.restore()),this.plotSnap=e.toDataURL("image/jpeg",.3))},getChapterByPlotUuid:function(e,t,n){var a=function(e,t,n,a){var r=null;return a&&t.uuid!==a?r:(a&&t.uuid===a&&0===t.plots.length&&(r={chapter:t,index:-4}),e.find(function(e,a){return e.uuid===n?r={chapter:t,index:a}:t.plots[a].options&&(r=o(t,a,n)),null!==r}),r)},o=function(e,t,n){var o=null,r=e.plots[t];return r.options.find(function(r,i){return o=a(r.plots,{plots:r.plots,parent:{pChapter:e,pnPlot:t},uuid:e.uuid,md5:e.md5,downloadUuid:e.downloadUuid},n),null!==o}),o?o:(r.condition_options&&r.condition_options.find(function(r,i){return o=a(r.plots,{plots:r.plots,parent:{pChapter:e,pnPlot:t},uuid:e.uuid,md5:e.md5,downloadUuid:e.downloadUuid},n),null!==o}),o)},r=function s(e,t,n){var o=null;return(o=a(e.plots,e,t,n))?o:(e.subchapters.find(function(a,r){return o=s(e.subchapters[r],t,n),null!==o}),o)},i=null;return e.chapters.find(function(a,o){return i=r(e.chapters[o],t,n),null!==i}),i&&(-4!==i.index||i.chapter.md5)||y["default"].error("该剧情已被作者删除啦！\r\n无法从该剧情继续哦~"),i},getCommandByCommandUuid:function(e,t){var n=function(e,t,n){for(var o=0;o<e.length;o++){var r=null;if(r=a({commands:e[o].commands,parentInfo:t,parentCmdIndex:n}),null!==r.cmdInfo)return r}return null},a=function(e){var a=null;return e.commands.find(function(o,r){return o.uuid===t?a={cmdIndex:r,uuid:t,cmdInfo:{commands:e.commands,parentInfo:e.parentInfo,parentCmdIndex:e.parentCmdIndex}}:"options"!==o.type&&"conditionOptions"!==o.type||(a=n(o.args,e,r)),null!==a}),null===a?{cmdIndex:-1,cmdInfo:null}:a},o={commands:e.commands,parentInfo:null,parentCmdIndex:-1};return a(o)},getMusic:function(e,t){for(var n=null,a=t;a>=0;a--){var o=e.plots[a];o.music&&"inherit"!==o.music.url&&(n=o.music.url)}return!n&&e.parent?this.getMusic(e.parent.pChapter,e.parent.pnPlot):!n&&e.isFirst&&this.json_data.cover.music&&"inherit"!==this.json_data.cover.music.url?this.json_data.cover.music.url:n},getCmdScreenSnap:function(){var e=this.bk_music,t=this.plotSounds,n=this.curPlotLayer,a=n.children[1],o=[],r=[],i=this.lstDialogInfo.concat(),s=this.menuInfo.concat(),l=e?{url:e.key,volume:e.volume}:null,u=t.map(function(e){return e?{url:e.key,volume:e.volume,time:e.loop?0:1}:null}),c=a?{url:a.key,opacity:a.alpha,width:a.width,height:a.height}:null;this.saveBubbleDataVector=[];var d=this.getBubbleData().concat();return this.apToFinalState(),this.charsAndPropsLayer&&this.charsAndPropsLayer.children.forEach(function(e){var t=e.children[0],n={url:t.key,x:t.x,y:t.y,width:t.width,height:t.height,opacity:t.alpha,pivotX:t.pivot.x,pivotY:t.pivot.y,scaleX:t.scale.x,scaleY:t.scale.y,rotate:t.angle,cmdUuid:t.cmdUuid,index:e.zIndex,parentScale:e.scale.x};o.push(n)}),this.getViewData(this.plotViews,r),{bk:c,charsAndProps:o,sounds:u,music:l,plotViews:r,dialogInfo:i,menuInfo:s,autoText:this.bCmdAutoText,weatherType:this.getWeatherType(),bubble:d}},getNextPlot:function(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=h["default"].searchChapterByUUID,l=this.json_data,u=this.Expression,c=l,d={cmdIndex:0,cmdInfo:null,cmdScreenSnap:null,animateScene:{shake:null}},f=n,m=t,p=void 0,y=void 0,g=t.plots[n];if(f++,"option"===a){if(g.options[o]){var v={};v.type="options",v.index=o,v.loopCondition=null,v.loopCount=1,e.stack=[v].concat(i(e.stack)),m={plots:g.options[o].plots,parent:{pChapter:m,pnPlot:n},uuid:t.uuid},f=0}}else if(g&&!g.insert&&!g.jump&&!g.back&&!a){var x=(g.condition_options||[]).findIndex(function(t){return u.safeEval(t.expression,e)&&(!t.count||parseInt(u.safeEval(t.count,e))>0)}),P=x<0?null:g.condition_options[x];if(P){var w={};w.type="condition_options",w.index=x,w.loopCondition="loop"===P.type||"countLoop"===P.type?P.expression:null,w.loopCount=1,w.loopCountExpr=P.count,e.stack=[w].concat(i(e.stack)),f=0,m={plots:P.plots,parent:{pChapter:t,pnPlot:n},uuid:t.uuid}}}if(!g||g.back!==!0&&"back"!==a||(void 0===a||"insertPlot"===a)&&void 0!==a||(f=-2,e.stack=[]),g&&(g.jump&&!a||g.jump&&"nextPlot"===a||"jump"===a)){var b="jump"===a?o:g.jump,k=s(c,b);k&&(m=k,f=0,e.stack=[],e.cmdStack=[])}if(g&&"jumpOption"===a){e=JSON.parse(JSON.stringify(this.context));for(var C=0;C<o&&m.parent&&(e.stack[0]&&"insert"!==e.stack[0].type);C++)e.stack=e.stack.splice(1),f=m.parent.pnPlot,m=m.parent.pChapter;-1!==f&&(this.context=e,f++)}if(g&&"backOption"===a){e=JSON.parse(JSON.stringify(this.context));for(var _=0;_<o&&m.parent&&(e.stack[0]&&"insert"!==e.stack[0].type);_++)e.stack=e.stack.splice(1),f=m.parent.pnPlot,m=m.parent.pChapter;if(-1<f)return this.context=e,{chapter:m,nIndex:f,context:e}}if(g&&(g.insert&&!a||"insertPlot"===a&&o)){var S=o||g.insert,I=s(c,S);if(I){var L={};L.type="insert",L.isCommand=!!t.plots[n].commands,L.cmdInfo=L.isCommand?this.curCmdInfo:null,L.cmdIndex=L.isCommand?this.curCmdIndex:null,L.isView=r,L.cmdScreenSnap=L.isCommand?this.getCmdScreenSnap():null,L.isCommand&&(e.cmdStack=[{type:"insert"}].concat(i(e.cmdStack))),L.loopCondition=null,L.loopCount=1,L.pPlotUuid=m.plots[f-1].uuid,L.chapterUuid=m.uuid,L.animateScene={shake:null},L.animateScene.shake=this.getScreenAnime().commands,e.stack=[L].concat(i(e.stack)),m={plots:I.plots,md5:I.md5,uuid:I.uuid,downloadUuid:I.downloadUuid,charge:I.charge,parent:{pChapter:m,pnPlot:f-1}},f=0,this.mainMenuLayer.visible&&(this.mainMenuLayer.children[1]&&this.mainMenuLayer.children[1].isMenu&&this.sendNotification(diygamePlayer.AppConstants.SCENE_DESTROY_VIEW,{name:this.mainMenuLayer.children[1].name,isMainMenu:!0}),this.onMainMenuBackBtnClicked())}}for(;!m.plots[f]&&0!==f&&m.plots.length&&e.stack&&0<e.stack.length||!m.plots[f]&&0===f&&!m.plots.length&&!m.md5&&e.stack&&0<e.stack.length;){var E=e.stack[0];if(E.loopCondition&&u.safeEval(E.loopCondition,e)){if(f=0,E.loopCount&&E.loopCount++,!E.loopCountExpr)break;var T=parseInt(u.safeEval(E.loopCountExpr,e));if(E.loopCount<=T)break}if(e.stack=e.stack.splice(1),"insert"===E.type&&e.cmdStack.length&&e.cmdStack[0].type&&"insert"===e.cmdStack[0].type&&(y=e.cmdStack[0],e.cmdStack=e.cmdStack.splice(1),this.saveBubbleDataVector=this.getBubbleData(!0).concat(),e.commandInserts))for(var M=0;M<e.commandInserts.length;M++)if(E.pPlotUuid===e.commandInserts[M].uuid){var O=this.getChapterByPlotUuid(this.json_data,E.pPlotUuid,E.chapterUuid);if(null===O||O.chapter&&O.index===-4)break;var A=this.getCommandByCommandUuid(O.chapter.plots[O.index],e.commandInserts[M].data.commandUuid);if(E.cmdInfo=A.cmdInfo,E.cmdIndex=A.cmdIndex,e.commandInserts[M].data.historyCommand){var V={charsAndProps:[],sounds:Array(12),music:null,plotViews:[],menuInfo:[]},B=e.commandInserts[M].data.historyCommand,N=B.images,j=B.dialog,R=B.autoText,D=B.weather,F=B.viewsData;if(V.autoText=!!R&&R.args[0],V.dialogInfo=j&&j.command?j.command.args:[],V.weatherType=D?D.args[0]:"",N)for(var U=0;U<N.length;U++)if(N[U].index>1){var W={url:N[U].url,x:N[U].x,y:N[U].y,width:N[U].width,height:N[U].height,opacity:N[U].opacity,rotate:N[U].rotate,index:N[U].index};V.charsAndProps.push(W)}else 1===N[U].index&&(V.bk={url:N[U].url,opacity:N[U].opacity});if(F&&F.length)for(var G=0;G<F.length;G++)V.plotViews[G]=this.copyFlashViewData(F[G]),V.plotViews[G].x=0,V.plotViews[G].y=0,V.plotViews[G].parent="plotViewsLayer";E.cmdScreenSnap=V}break}if(m.parent&&"insert"!==E.type){if(d.cmdIndex=E.isCommand?E.cmdIndex+1:-1,d.cmdInfo=E.cmdInfo,d.cmdScreenSnap=E.cmdScreenSnap,f=E.isCommand?m.parent.pnPlot:m.parent.pnPlot+1,m=m.parent.pChapter,e.inserts&&e.inserts.length&&!m.plots[f]&&e.stack.length<=0){var H=e.inserts.pop(),z=H.chapterUuid,K=H.plotUuid,q=s(c,z);if(!q)break;m=q,f=K}this.saveBubbleDataVector=this.getBubbleData(!0).concat()}else if(E.pPlotUuid&&"insert"===E.type){d.cmdIndex=E.isCommand?E.cmdIndex+1:-1,d.cmdInfo=E.cmdInfo,d.cmdScreenSnap=E.cmdScreenSnap,d.bubble=E.bubble?E.bubble.concat():[],E.animateScene&&null!==E.animateScene.shake&&(d.animateScene.shake=Object.assign(E.animateScene.shake,{}));var J=this.getChapterByPlotUuid(this.json_data,E.pPlotUuid,E.chapterUuid),$=J.chapter,Y=J.index;f=E.isCommand?Y:Y+1,E.isView&&!E.isCommand&&(f=Y),m=$,p=E,this.saveBubbleDataVector=this.getBubbleData(!0).concat()}}return{chapter:m,nIndex:f,cmdPlotSnap:d,context:e,preStackFrame:p,preCmdStackFrame:y}},getNextCommand:function(e,t,n,a){var o=this.Expression,r=t,s=n;if(s++,"options"===a.type){var l=t.commands[n].args;if(a.index>=0&&l[a.index].commands.length>0){var u={};u.loopCondition=null,u.loopCount=1,e.cmdStack=[u].concat(i(e.cmdStack)),s=0,r={commands:l[a.index].commands,parentInfo:t,parentCmdIndex:n}}else this.optionLayer.destroy()}else if("cdtOptions"===a.type){var c=t.commands[n].args,d=c.findIndex(function(t){return o.safeEval(t.expression,e)&&(!t.count||parseInt(o.safeEval(t.count,e))>0)}),h=d<0?null:c[d];if(h){var f={};f.loopCondition="loop"===h.type||"countLoop"===h.type?h.expression:null,f.loopCount=1,f.loopCountExpr=h.count,e.cmdStack=[f].concat(i(e.cmdStack)),s=0,r={commands:h.commands,parentInfo:t,parentCmdIndex:n}}}else if("backOption"===a.type){for(var m=0;m<a.eArg&&r.parentInfo&&(e.cmdStack[0]&&"insert"!==e.cmdStack[0].type);m++)e.cmdStack=e.cmdStack.splice(1),s=r.parentCmdIndex,r=r.parentInfo;if(s>-1&&r.commands)return{info:r,index:s}}else if("jumpOption"===a.type){for(var p=0;p<a.eArg&&r.parentInfo&&(e.cmdStack[0]&&"insert"!==e.cmdStack[0].type);p++)e.cmdStack=e.cmdStack.splice(1),s=r.parentCmdIndex,r=r.parentInfo;s++}for(;r&&!r.commands[s]&&e.cmdStack&&0<e.cmdStack.length;){var y=e.cmdStack[0];if(y.loopCondition&&o.safeEval(y.loopCondition,e)){if(s=0,y.loopCount&&y.loopCount++,!y.loopCountExpr)break;var g=parseInt(o.safeEval(y.loopCountExpr,e));if(y.loopCount<=g)break}y.type&&"insert"===y.type||(e.cmdStack=e.cmdStack.splice(1)),y.type&&"insert"===y.type?(s=-1,r=null):r.parentInfo&&(s=r.parentCmdIndex+1,r=r.parentInfo)}return{info:r,index:s}},removeInputView:function(e){if(e.inputElement)e.inputElement.destroy();else if(e.children&&e.children.length)for(var t=0;t<e.children.length;t++)this.removeInputView(e.children[t])},removeViewTimer:function(e){var t=this;return"TIMER"===e.viewType?void("timeOut"===e.timerType?clearTimeout(e.timerHandler):clearInterval(e.timerHandler)):void e.children.forEach(function(e){return t.removeViewTimer(e)})},filterInexistentPlotViews:function(e,t){if(t.commands&&0!==t.commands.length)for(var n=function r(e,t){for(var n=0;n<t.length;n++){if(t[n].uuid===e)return!0;if("options"===t[n].type||"conditionOptions"===t[n].type)for(var a=0;a<t[n].args.length;a++)if(r(e,t[n].args[a].commands))return!0}return!1},a=0;a<e.length;a++)if(e[a].generateType){var o=e[a].generateType;n(o,t.commands)||(e.splice(a,1),a--)}},destroyAll:function(){var e=this;if(this.playBackLayer.removeAll(!0),this.globalViews&&this.globalViews.forEach(function(t){e.removeInputView(t),t.destroy&&t.destroy()}),this.globalViews=null,this.plotViewsLayer.children.forEach(function(t){e.removeViewTimer(t),e.removeInputView(t)}),this.plotViewsLayer.removeAll(!0),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version){b["default"].stopMusic(),b["default"].removeAudioUrl(b["default"].musicInfo.key);for(var t=0;t<10;t++)b["default"].soundsInfo[t].key&&(b["default"].stopSound(t),b["default"].removeAudioUrl(b["default"].soundsInfo[t].key))}else this.bk_music&&this.bk_music.destroy(),this.bk_music=null,this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.destroy()}),this.plotSounds=[];this.lstPlotLayer&&(this.lstPlotLayer.destroy(),this.lstPlotLayer=null);
},reStart:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.dialogLayer.visible=!1,this.unlockChapterCallBack=null,this.mallPayCallback=null,this.destroyAll(),this.bubbleLayer.children.length>0&&this.bubbleLayer.removeAll(!0),this.saveBubbleVector=[],this.bubbleArchivalCount=[],this.initContext(this.context);var n=function(){if(!e.json_data.cover.hidden)return e.showCover();var t=e.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(e.isWapOther())return void e.checkIfChapterFree(n,t.md5).then(function(n){var a;(a=t.plots).push.apply(a,i(n)),e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)},function(a){-1===a.indexOf("code=87")?y["default"].error(a):e.unlockChapterByWapOther(n,t.charge,t.md5,null)});if(t.md5&&0===t.plots.length)if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)e.checkIfChapterFree(n,t.md5).then(function(n){t.plots=n,e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)},function(e){-1===e.indexOf("code=87")?y["default"].error(e):"zxwwap"===flashvars.wap?y["default"].info("当前为收费章节，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid}):y["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var a=function(a){a&&e.checkIfChapterFree(n,t.md5).then(function(n){e.unlockChapterCallBack=null,t.plots=n,e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():y["default"].error("获取付费章节信息失败")})};e.unlockChapter(n,t.charge,t.md5,a)}else e.preloadChapterAssets(e.context,t,void 0,void 0,void 0,!0)};t!==!1?y["default"].custom("Info","没体验够？下载闪艺APP，继续玩！","提示","下载闪艺","取消").then(function(){window.location.href="http://app.3000.com/"},function(e){n()}):n()},updatePayValue:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(a===!0||o===!0)return Promise.resolve(!0);var r=function(){if(t&&t.length>0)for(var n=function(n){var a=-1;return e.payValues.findIndex(function(e){return e.uuid===t[n].uuid})!==-1?{v:!0}:e.indexValues&&(a=e.indexValues.findIndex(function(e){return e.uuid===t[n].uuid}))!==-1&&"payValue"===e.indexValues[a].init.type?{v:!0}:void 0},a=0;a<t.length;a++){var o=n(a);if("object"===("undefined"==typeof o?"undefined":l(o)))return o.v}return!1};return new Promise(function(t,a){return r()?void n.getPayInfo().then(function(a){return"[object String]"!==Object.prototype.toString.apply(a)&&""!==flashvars.uid?(n.isLineUpdatePaySuccess=!0,e.payValues=JSON.parse(JSON.stringify(n.context.payValues)),t(!0)):(n.isLineUpdatePaySuccess=!1,a.indexOf("获取用户信息权限错误")!==-1?(y["default"].info("当前网络信号差，商城、成就等账号功能无法正常使用，请检查网络设置后，重新打开作品").then(null,null),t(!1)):t(!0))}):t(!0)})},valueOperation:function(e,t,n){var a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.isSetValues=!0;var i=!1,s=[],u=[],c=[],d=[],f=function(){for(var t=0;t<e.values.length;t++)s[t]=e.values[t].value;for(var n=0;n<e.savedValues.length;n++)u[n]=e.savedValues[n].value;for(var a=0;a<e.stringValues.length;a++)c[a]=e.stringValues[a].value;for(var o=0;o<e.payValues.length;o++)d[o]=e.payValues[o].value},m=function(){for(var t=0;t<s.length;t++)e.values[t].value=s[t];for(var n=0;n<u.length;n++)e.savedValues[n].value=u[n];for(var a=0;a<c.length;a++)e.stringValues[a].value=c[a];for(var o=0;o<d.length;o++)e.payValues[o].value=d[o]},p=function(){if(flashvars.single&&"1"===flashvars.offline)return a.savePayInfo().then(function(){return a.saveAccountInfo()});if(!i)return Promise.reject();if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var e=h["default"].getUidByCookie();return e!==flashvars.uid&&""!==e?(flashvars.uid=e,a.localRecFileToUidRecFile(!1),a.getPayInfo().then(function(){a.getAccountInfo()}),Promise.reject()):n?Promise.reject():a.savePayInfo()}return"wap"===flashvars.client&&""===flashvars.uid?a.getUserInfoFromWap().then(function(){return n?Promise.reject():a.savePayInfo()}):n?Promise.reject():a.savePayInfo()},g=function(t,n,a){if(!a)return n<1?y["default"].info("出现未知数值操作，请联系作者检查修改"):"value"===e.indexValues[t].init.type&&n>e.values.length?y["default"].info("出现未知数值操作，请联系作者检查修改"):"savedValue"===e.indexValues[t].init.type&&n>e.savedValues.length?y["default"].info("出现未知数值操作，请联系作者检查修改"):"stringValue"===e.indexValues[t].init.type&&n>e.stringValues.length?y["default"].info("出现未知数值操作，请联系作者检查修改"):"payValue"===e.indexValues[t].init.type&&n>e.payValues.length&&y["default"].info("出现未知数值操作，请联系作者检查修改"),void(e.indexValues[t].value=n);var o=void 0===e.indexValues[t].value?e.indexValues[t].init.value-1:e.indexValues[t].value-1;if("value"===e.indexValues[t].init.type){if(o<0||o>=e.values.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");e.values[o].value=n}else if("savedValue"===e.indexValues[t].init.type){if(o<0||o>=e.savedValues.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");e.savedValues[o].value=n}else if("stringValue"===e.indexValues[t].init.type){if(o<0||o>=e.stringValues.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");e.stringValues[o].value=n}else if("payValue"===e.indexValues[t].init.type){if(o<0||o>=e.payValues.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");i=!0,e.payValues[o].value=n}},v=function(){if(t&&t.length>0)for(var n=function(n){var a=-1;return e.payValues.findIndex(function(e){return e.uuid===t[n].uuid})!==-1?{v:!0}:e.indexValues&&(a=e.indexValues.findIndex(function(e){return e.uuid===t[n].uuid}))!==-1&&"payValue"===e.indexValues[a].init.type?{v:!0}:void 0},a=0;a<t.length;a++){var o=n(a);if("object"===("undefined"==typeof o?"undefined":l(o)))return o.v}return!1};if(t&&t.length>0){var x=0,P=function(s){return s>=t.length-1&&p().then(function(){a.isSetValues=!1,o&&o(e)},function(){!i||r||n||m(),a.isSetValues=!1,o&&o(e)}),s<t.length-1},w=function b(n){var o=t[n],r=a.Expression.safeEval(o.expression,a.context),s=o.uuid,l=void 0;(l=a.context.values.findIndex(function(e){return e.uuid===s}))!==-1?(e.values[l].value=r,P(n)&&b(n+=1)):(l=a.context.savedValues.findIndex(function(e){return e.uuid===s}))!==-1?(e.savedValues[l].value=r,h["default"].localStorageSetItem(flashvars.uuid+"savedValues"+flashvars.uid,JSON.stringify(e.savedValues)),P(n)&&b(n+=1)):(l=a.context.stringValues.findIndex(function(e){return e.uuid===s}))!==-1?(e.stringValues[l].value=r,P(n)&&b(n+=1)):(l=a.context.payValues.findIndex(function(e){return e.uuid===s}))!==-1?(e.payValues[l].value=r,i=!0,P(n)&&b(n+=1)):(l=a.context.indexValues.findIndex(function(e){return e.uuid===s}))!==-1?(g(l,r,o.reference),P(n)&&b(n+=1)):(console.error("Cannot find value/savedValue with uuid = ",s),P(n)&&b(n+=1))};flashvars.single&&"1"===flashvars.offline?w(x):v()?n||r?(n&&(e=JSON.parse(JSON.stringify(e))),r&&f(),w(x)):(f(),w(x)):w(x)}else null!==o&&(this.isSetValues=!1,o(e))},updateValues:function(e){for(var t=JSON.parse(JSON.stringify(this.json_data.values)),n=0;n<e.values.length;n++)for(var a=0;a<t.length;a++)if(t[a].uuid===e.values[n].uuid){t[a].value=e.values[n].value;break}e.values=t.concat(),t=JSON.parse(JSON.stringify(this.json_data.savedValues));for(var o=0;o<e.savedValues.length;o++)for(var r=0;r<t.length;r++)if(t[r].uuid===e.savedValues[o].uuid){t[r].value=e.savedValues[o].value;break}e.savedValues=t.concat(),t=JSON.parse(JSON.stringify(this.json_data.stringValues));for(var i=0;i<e.stringValues.length;i++)for(var s=0;s<t.length;s++)if(t[s].uuid===e.stringValues[i].uuid){t[s].value=e.stringValues[i].value;break}if(e.stringValues=t.concat(),this.json_data.payValues){if(t=JSON.parse(JSON.stringify(this.json_data.payValues)),e.payValues)for(var l=0;l<e.payValues.length;l++)for(var u=0;u<t.length;u++)if(t[u].uuid===e.payValues[l].uuid){t[u].value=e.payValues[l].value;break}e.payValues=t.concat()}if(this.json_data.indexValues){if(t=JSON.parse(JSON.stringify(this.json_data.indexValues)),e.indexValues)for(var c=0;c<e.indexValues.length;c++)for(var d=0;d<t.length;d++)if(t[d].uuid===e.indexValues[c].uuid){t[d].value=e.indexValues[c].value;break}e.indexValues=t.concat()}},initContext:function(e,t){var n=function(e){return e?JSON.parse(JSON.stringify(e)):e},a={};if(t&&this.updateValues(e),a.auto=this.context&&this.context.auto||!1,a.fullScreen=this.context&&this.context.fullScreen||!1,a.savedValues=n(e&&e.savedValues||this.json_data.savedValues),!e&&!t){var o=h["default"].localStorageGetItem(flashvars.uuid+"savedValues"+flashvars.uid);if(o)for(var r=JSON.parse(o),i=0;i<r.length;i++)for(var s=0;s<a.savedValues.length;s++)if(a.savedValues[s].uuid===r[i].uuid){a.savedValues[s].value=r[i].value;break}}if(t)a.values=n(e.values),a.stringValues=n(e.stringValues),a.payValues=n(this.context.payValues),a.indexValues=n(e.indexValues);else{a.values=n(this.json_data.values),a.stringValues=n(this.json_data.stringValues),a.payValues=n(this.json_data.payValues?this.json_data.payValues:this.context.payValues),a.indexValues=n(this.json_data.indexValues?this.json_data.indexValues:this.context.indexValues);for(var l=0;l<a.payValues.length;l++)for(var u=0;u<this.context.payValues.length;u++)if(a.payValues[l].uuid===this.context.payValues[u].uuid){a.payValues[l].value=this.context.payValues[u].value;break}}if(this.json_data.systemValues?(a.systemValues=n(this.json_data.systemValues),1===a.systemValues.length?a.systemValues=a.systemValues.concat([{},{},{},{},{},{},{},{},{},{}]):9===a.systemValues.length?a.systemValues=a.systemValues.concat([{},{}]):10===a.systemValues.length&&(a.systemValues=a.systemValues.concat([{}])),a.systemValues[0].value=this.context.systemValues[0].value,a.systemValues[1].value=this.context.systemValues[1].value,a.systemValues[9].value=this.context.systemValues[9].value):a.systemValues=n(this.context.systemValues),-1===h["default"].timeStamp)h["default"].getTimeOffset().then(function(){h["default"].updateContextTimeValues(a)},null);else{var c=new Date(1e3*h["default"].timeStamp);a.systemValues[2].value=h["default"].timeStamp,a.systemValues[3].value=c.getFullYear(),a.systemValues[4].value=c.getMonth()+1,a.systemValues[5].value=c.getDate(),a.systemValues[6].value=c.getHours(),a.systemValues[7].value=c.getMinutes(),a.systemValues[8].value=c.getSeconds(),a.systemValues[10].value=c.getDay()}t&&e&&e.stack?(a.stack=n(e.stack),a.cmdStack=n(e.cmdStack)):(a.stack=[],a.cmdStack=[]),this.context=a},doInCT:function(e,t){return e!==this.context?Promise.reject("timeline changed"):t()},txtLineSpace:function(e){var t=0;return t=12==e||14==e||16==e||18==e?-4+e/2:e<19?-5+e/2:e<28?-6+e/2:e<37?-7+e/2:e<46?-9+e/2:e<56?-10+e/2:-Math.ceil(e/5)+e/2,!this.viewComponent.game.device.desktop&&(t-=2),t},updateMusicVolume:function(e){if(h["default"].musicVolume=e,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)b["default"].updateMusicVolume("music",e);else if(this.bk_music){0===this.bk_music.prevolume&&0!==this.bk_music.volume&&(this.bk_music.prevolume=this.bk_music.volume);var t=void 0!==this.bk_music.inheritvolume&&this.bk_music.inheritvolume!==-1?this.bk_music.inheritvolume*e:this.bk_music.prevolume*e;this.bk_music.volume=t;for(var n=0;n<this.lstPlotTweens.length;n++){var a=this.lstPlotTweens[n];a.target&&"music"===a.target.animateMusic&&(a.pause(),a.stop(!0))}}},updateSoundVolume:function(e){if(h["default"].soundVolume=e,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)b["default"].updateSoundVolume("sound",e);else{if(this.plotSounds&&this.plotSounds.length>0)for(var t=0;t<this.plotSounds.length;t++){var n=this.plotSounds[t];if(n){0===n.prevolume&&0!==n.volume&&(n.prevolume=n.volume);var a=void 0!==n.inheritvolume&&n.inheritvolume!==-1?n.inheritvolume*e:n.prevolume*e;n.volume=a}}for(var o=0;o<this.lstPlotTweens.length;o++){var r=this.lstPlotTweens[o];r.target&&"sound"===r.target.animateMusic&&(r.pause(),r.stop(!0))}}},stopMusic:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].stopMusic(!t):e&&this.bk_music&&e===this.bk_music.key?this.bk_music.stop():this.bk_music&&(this.bk_music.destroy(),this.bk_music=null,this.decodeCacheAudio(e)),!t&&d.ResourcesManager.updateUsingKey({type:"music",key:""})},playMusic:function(e,t,n){arguments.length>3&&void 0!==arguments[3]&&arguments[3];d.ResourcesManager.updateUsingKey({type:"music",key:e}),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playMusic(e,t,n,h["default"].musicVolume):(this.bk_music&&e===this.bk_music.key||(this.bk_music=this.viewComponent.game.add.sound(e,t,n),this.bk_music.prevolume=t,this.bk_music.inheritvolume=-1),this.bk_music.play(),this.bk_music.volume=this.bk_music.prevolume*h["default"].musicVolume)},playInheritMusic:function(e){"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playInheritMusic(e,h["default"].musicVolume):this.bk_music&&void 0!==e&&(this.bk_music.inheritvolume=e,this.bk_music.volume=e*h["default"].musicVolume)},stopSound:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==e&&void 0!==e){if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)b["default"].stopSound(e);else if(e===-1)for(var a=0;a<this.plotSounds.length;a++){var o=this.plotSounds[a];o&&o.stop()}else t&&this.plotSounds[e]&&t===this.plotSounds[e].key?this.plotSounds[e].stop():this.plotSounds[e]&&(this.plotSounds[e].destroy(),this.plotSounds[e]=null,this.decodeCacheAudio(t));!n&&d.ResourcesManager.updateUsingKey({type:"sound",key:"",index:e})}},playSound:function(e,t,n,a){arguments.length>4&&void 0!==arguments[4]&&arguments[4];d.ResourcesManager.updateUsingKey({type:"sound",key:t,index:e}),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playSound(e,t,n,a,h["default"].soundVolume):(this.plotSounds[e]&&this.plotSounds[e].key===t||(this.plotSounds[e]=this.viewComponent.game.add.sound(t,n,a),this.plotSounds[e].prevolume=n,this.plotSounds[e].inheritvolume=-1,this.plotSounds[e].volume*=h["default"].soundVolume),this.plotSounds[e].play())},playInheritSound:function(e,t){"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playInheritSound(e,t,h["default"].soundVolume):this.plotSounds[e]&&void 0!==t&&(this.plotSounds[e].inheritvolume=t,this.plotSounds[e].volume*=h["default"].soundVolume)},decodeCacheAudio:function(e){var t=this;if(e){var n=this.viewComponent.game.load.cache.getSound(e);return void(!n||n.decoded||n.isDecoding||this.viewComponent.game.sound.decode(e))}var a=0,o=this.viewComponent.game.load.cache.getKeys(Phaser.Cache.SOUND);for(var r in o){var i=this.viewComponent.game.load.cache.getSound(o[r]);if((i.decoded||i.isDecoding)&&a++,a>4)return}o.some(function(e){var n=t.viewComponent.game.load.cache.getSound(e);return!n.decoded&&!n.isDecoding&&(t.viewComponent.game.sound.decode(e),!0)})},toRealImageFontHeight:function(e){var t=this.json_data.font.size.target.height?this.json_data.font.size.target.height:this.json_data.font.size.target;return parseFloat(e)*t/this.json_data.font.size.source},toRealImageFontWidth:function(e){var t=this.json_data.font.size.target.width?this.json_data.font.size.target.width:this.json_data.font.size.target;return parseFloat(e)*t/this.json_data.font.size.source},isWap3000:function(){return"3000"===flashvars.wap},isWapOther:function(){return"3000"!==flashvars.wap&&"zxwwap"!==flashvars.wap&&"4399"!==flashvars.wap&&""!==flashvars.wap},isExtend:function(){return""!==flashvars.extend},isShowLocalBtn:function(){return!this.isWapOther()},isShowCloudBtn:function(){return!(this.isExtend()||"zxwwap"===flashvars.wap||this.isWapOther()||flashvars.single)},Expression:function(){function e(){r(this,e)}return s(e,null,[{key:"isString",value:function(e){return"[object String]"===Object.prototype.toString.apply(e)}},{key:"isArray",value:function(e){return"[object Array]"===Object.prototype.toString.apply(e)}},{key:"toN",value:function(e){var t=Number(e);return isNaN(t)?(console.warn(e+" is not a number"),0):t}},{key:"toInt",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=parseInt(e,t);return isNaN(n)?(console.warn(e+" is not a int"),0):n}},{key:"toWeek",value:function(e){switch(e){case 0:return 7;default:return e}}},{key:"safeEval",value:function(e,t){var n=this,a=function r(e,t){var a=void 0,o=void 0,s=void 0;switch(e.type){case"arg1":return r(e.arg1,t);case"+":return a=r(e.arg1,t),o=r(e.arg2,t),n.isString(a)||n.isString(o)?("#"+a+o).slice(1):n.add(r(e.arg1,t),r(e.arg2,t));case"-":return a=r(e.arg1,t),o=r(e.arg2,t),n.isString(a)||n.isString(o)?(a+"").split(o+"").join(""):n.sub(r(e.arg1,t),r(e.arg2,t));case"*":return n.mul(r(e.arg1,t),r(e.arg2,t));case"/":return n.div(r(e.arg1,t),r(e.arg2,t));case"%":return a=parseInt(r(e.arg1,t)),o=parseInt(r(e.arg2,t)),0===o?(y["default"].error("求余除数不能为 0"),0):n.mod(a,o);case"==":return r(e.arg1,t)===r(e.arg2,t);case"!=":return r(e.arg1,t)!==r(e.arg2,t);case">":return r(e.arg1,t)>r(e.arg2,t);case"<":return r(e.arg1,t)<r(e.arg2,t);case">=":return r(e.arg1,t)>=r(e.arg2,t);case"<=":return r(e.arg1,t)<=r(e.arg2,t);case"min":return Math.min.apply(null,e.args.map(function(e){return r(e,t)}));case"max":return Math.max.apply(null,e.args.map(function(e){return r(e,t)}));case"all":return e.args.map(function(e){return r(e,t)}).every(function(e){return e});case"any":return e.args.map(function(e){return r(e,t)}).some(function(e){return e});case"literal":return Number(e.value);case"int":return parseInt(n.toN(r(e.arg1,t)));case"random":var l=n.toInt(e.range[0]),u=n.toInt(e.range[1]);return~~(Math.random()*(u-l+1)+l);case"value":case"savedValue":case"payValue":return s=[].concat(i(t.values),i(t.savedValues),i(t.payValues)).find(function(t){return t.uuid===e.arg1}),void 0!==s.value?n.toN(s.value):n.safeInitValue(s);case"systemValue":return s=t.systemValues.find(function(t){return t.uuid===e.arg1}),void 0!==s.value?(s.uuid!==t.systemValues[0].uuid&&s.uuid!==t.systemValues[1].uuid&&s.uuid!==t.systemValues[9].uuid&&h["default"].updateContextTimeValues(t),s.uuid===t.systemValues[10].uuid?n.toWeek(s.value):n.toN(s.value)):n.safeInitValue(s);case"indexValue":return s=t.indexValues.find(function(t){return t.uuid===e.arg1}),void 0!==s.value?n.toN(s.value):n.safeInitValue(s);case"string":return e.value+"";case"stringValue":return s=t.stringValues.find(function(t){return t.uuid===e.arg1}),void 0!==s.value?s.value+"":n.safeInitValue(s);case"reference":if(s=t.indexValues.find(function(t){return t.uuid==e.arg1})){var c=(void 0===s.value?n.safeInitValue(s):n.toN(s.value))-1;if("value"===s.init.type)return c<0||c>=t.values.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.values[c].value?n.toN(t.values[c].value):n.safeInitValue(t.values[c]);if("savedValue"===s.init.type)return c<0||c>=t.savedValues.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.savedValues[c].value?n.toN(t.savedValues[c].value):n.safeInitValue(t.savedValues[c]);if("payValue"===s.init.type)return c<0||c>=t.payValues.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.payValues[c].value?n.toN(t.payValues[c].value):n.safeInitValue(t.payValues[c]);if("stringValue"===s.init.type)return c<0||c>=t.stringValues.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.stringValues[c].value?t.stringValues[c].value+"":n.safeInitValue(t.stringValues[c])}case"contain":return a=r(e.arg1,t),o=r(e.arg2,t),(a+"").indexOf(o+"")>-1;case"stringLength":return a=r(e.arg1,t),a?a.length:0;default:throw new error("expr type  is  error")}};try{return a(e,t)}catch(o){return console.error(o),NaN}}},{key:"safeInitValue",value:function(e){function t(e){if("const"===e.init.type||"system"===e.init.type)return e.value=e.init.value,e.value;if("random"===e.init.type){var t=Number(e.init.range[0]),n=Number(e.init.range[1]);return e.value=~~(Math.random()*(n-t+1)+t),e.value}return"string"===e.init.type?(e.value=e.init.value+"",e.value):e.init.onlyRead?(e.value=e.init.value,e.value):(console.error("unknown init type"),0)}try{return t(e)}catch(n){return console.error(n),0}}},{key:"fix",value:function(e,t){var n=this,a=e.type,o=e.arg1,r=e.arg2,s=e.args,l=e.value,u={type:a},c=void 0;switch(a){case"arg1":case"stringLength":var d=this.fix(o,t);return d?(u.arg1=d,u):null;case"+":case"-":case"*":case"/":case"%":case"==":case"!=":case">":case"<":case">=":case"<=":case"contain":return u.arg1=this.fix(o,t),u.arg2=this.fix(r,t),u.arg1&&u.arg2?u:null;case"min":case"max":case"all":case"any":var h=s.map(function(e){return n.fix(e,t)});return u.args=h.filter(function(e){return null!==e}),u;case"literal":return u.value=Number(l),u;case"random":return u.range=(e.range||[0,100]).map(function(e){return n.toInt(e)}),u.range.sort(),u;case"value":case"savedValue":case"payValue":case"systemValues":case"indexValue":return c=[].concat(i(t.values),i(t.savedValues),i(t.payValues),i(t.systemValues),i(t.indexValues)).find(function(t){return t.uuid===e.arg1}),void 0===c?null:(u.arg1=o,u);case"string":return u.value=l+""||"",u;case"stringValue":return c=t.stringValues.find(function(t){return t.uuid===e.arg1}),void 0===c?null:(u.arg1=o,u);default:return null}}},{key:"parseValue",value:function(e,t,n){for(var a=/([\s\S]*)&(s|v|sv|p|x|i|iv)\[(\d+)\]([\s\S]*)/,o=a.exec(e),r=void 0,i=e;o;){var s=o[2],l=parseInt(o[3]),u="[未知数值]";if("s"===s&&t.savedValues[l])r="[Y"+(l+1)+":"+t.savedValues[l].name+"]",u=void 0===t.savedValues[l].value?this.safeInitValue(t.savedValues[l]):t.savedValues[l].value,u=n?r:this.toFixed(u,2);else if("v"===s&&t.values[l])r="[P"+(l+1)+":"+t.values[l].name+"]",u=void 0===t.values[l].value?this.safeInitValue(t.values[l]):t.values[l].value,u=n?r:this.toFixed(u,2);else if("sv"===s&&t.stringValues[l])r="[Z"+(l+1)+":"+t.stringValues[l].name+"]",u=void 0===t.stringValues[l].value?this.safeInitValue(t.stringValues[l]):t.stringValues[l].value,n&&(u=r);else if("p"===s&&t.payValues[l])r="[X"+(l+1)+":"+t.payValues[l].name+"]",u=void 0===t.payValues[l].value?this.safeInitValue(t.payValues[l]):t.payValues[l].value,u=n?r:this.toFixed(u,2);else if("x"===s&&t.systemValues[l])-1===h["default"].timeStamp?h["default"].getTimeOffset().then(function(){h["default"].updateContextTimeValues(t)},function(){y["default"].info("当前网络不佳，获取系统时间失败")}):h["default"].updateContextTimeValues(t),r="[S"+(l+1)+":"+t.systemValues[l].name+"]",u=void 0===t.systemValues[l].value?this.safeInitValue(t.systemValues[l]):10===l?this.toWeek(t.systemValues[10].value):t.systemValues[l].value,u=n?r:this.toFixed(u,2);else if("i"===s&&t.indexValues[l])r="[I"+(l+1)+":"+t.indexValues[l].name+"]",u=void 0===t.indexValues[l].value?this.safeInitValue(t.indexValues[l]):t.indexValues[l].value,u=n?r:this.toFixed(u,2);else if("iv"===s)if(l>=t.indexValues.length)u="[未知数值]";else{r="[IV"+(l+1)+":"+t.indexValues[l].name+"]";var c=(void 0===t.indexValues[l].value?this.safeInitValue(t.indexValues[l]):t.indexValues[l].value)-1;if(n)u=r;else{var d=this.toFixed(c,2);"value"===t.indexValues[l].init.type?c<0||c>=t.values.length?u="[未知数值]":(u=void 0===t.values[d].value?this.safeInitValue(t.values[d]):t.values[d].value,u=this.toFixed(u,2)):"savedValue"===t.indexValues[l].init.type?c<0||c>=t.savedValues.length?u="[未知数值]":(u=void 0===t.savedValues[d].value?this.safeInitValue(t.savedValues[d]):t.savedValues[d].value,u=this.toFixed(u,2)):"payValue"===t.indexValues[l].init.type?c<0||c>=t.payValues.length?u="[未知数值]":(u=void 0===t.payValues[d].value?this.safeInitValue(t.payValues[d]):t.payValues[d].value,u=this.toFixed(u,2)):"stringValue"===t.indexValues[l].init.type&&(u=c<0||c>=t.stringValues.length?"[未知数值]":void 0===t.stringValues[d].value?this.safeInitValue(t.stringValues[d]):t.stringValues[d].value)}}i=o[1]+u+o[4],o=a.exec(i)}return i}},{key:"parseWaitTime",value:function(e,t){for(var n=/([\s\S]*)\\(\d+)\s([\s\S]*)/,a=n.exec(e);a;)e=t?a[1]+("[停顿:"+a[2]+"ms]")+a[3]:a[1]+a[3],a=n.exec(e);return e}},{key:"getGameValueByTimer",value:function(e,t){var n={};if(!e)return-1;var a=e.time,o=a.type,r=a.arg1;if("value"===o)n=t.values.find(function(e){return e.uuid===r});else if("savedValue"===o)n=t.savedValues.find(function(e){return e.uuid===r});else{if("literal"!==o)return-1;n.value=e.time.value}var i=n&&void 0===n.value?this.safeInitValue(n):n.value;return Math.max(i,0)}},{key:"add",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.max(n,a),e=parseInt(e.toString().replace(".",""))*Math.pow(10,o-n),t=parseInt(t.toString().replace(".",""))*Math.pow(10,o-a),(e+t)/Math.pow(10,o)}},{key:"sub",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.max(n,a),e=parseInt(e.toString().replace(".",""))*Math.pow(10,o-n),t=parseInt(t.toString().replace(".",""))*Math.pow(10,o-a),(e-t)/Math.pow(10,o)}},{key:"div",value:function(e,t){if(!t)return y["default"].error("除数不能为 0"),0;var n=0,a=0,o=void 0;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=parseInt(e.toString().replace(".",""))/parseInt(t.toString().replace(".","")),a-n<0||o!==parseInt(o)?this.mul(o,Math.pow(10,a-n)):o*Math.pow(10,a-n)}},{key:"mul",value:function(e,t){var n=0,a=e.toString(),o=t.toString();try{n+=a.includes("1e-")?parseInt(a.split("1e-")[1]):a.split(".")[1].length}catch(r){}try{n+=o.includes("1e-")?parseInt(o.split("1e-")[1]):o.split(".")[1].length}catch(r){}return parseInt(a.replace(".",""))*parseInt(o.replace(".",""))/Math.pow(10,n)}},{key:"mod",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.pow(10,Math.max(n,a)),e*o%(t*o)/o}},{key:"toFixed",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=0;try{n=e.toString().split(".")[1].length}catch(a){}var o=e.toString();return n>t&&t>=0&&(o=o.substring(0,o.indexOf(".")+t+1),n=t),e=parseInt(o.replace(".","")),e/Math.pow(10,n)}}]),e}()},{NAME:"SceneProxy",guideLayer:null,logo:null,coverLayer:null,progressLayer:null,dialogLayer:null,menuLayer:null,mainMenuLayer:null,settingsLayer:null,recordLayer:null,playBackLayer:null,weatherLayer:null,charsAndPropsLayer:null,optionLayer:null,plotViewsLayer:null,globalViews:null,plotViews:null,prgsViews:null,endLayer:null,toastLayer:null,loadingToastLayer:null,quickPlayLayer:null,bubbleLayer:null,bk_music:null,plotSounds:null,btn_sound:null,audioDecodedCount:0,lstPlotBkKey:null,prePlotBkKey:null,lstPlotBkOpacity:0,lstPlotBkFlex:1,lstGameBk:null,curPlotLayer:null,lstPlotLayer:null,viewComponent:null,json_data:{},Template:{},stringMap:{},progressTips:[],unlockChapterCallBack:null,mallPayCallback:null,context:{},plotSnap:null,savedPlotsData:null,cloudPlotsData:null,recUidBelongTo:"",gameUidBelongTo:"",bSwitchAccInPlot:!0,payValueUid:"",playPause:!1,bViewLoaded:!1,bSignedIn:!1,bCloudSel:!1,curChapter:null,curPlotInfo:null,curPlotIndex:0,cmdPlotSnap:null,curCmdUuid:"",bCmdAutoText:!1,lstDialogInfo:null,menuInfo:null,charsAndPropsInfo:[],bToSaveFile:!0,space_key:null,z_key:null,globalViewKeys:null,plotViewKeys:null,quickPlay:!1,isScreenHold:!1,isQuickPlay:!0,isShowGuide:!0,recordTipCount:0,visibleLayout:[],resourceManager:{},lstPlotTweens:[],twinkleTimer:null,uiOnLoadQueue:[],timerCounts:[],menuTimer:[],cmdPlotNextPromise:null,cmdPlayHandlerFun:null,curCmdInfo:null,curCmdIndex:0,preWaitCmdUuid:"",isGameStarted:!1,usedStarCount:0,gameStarLimit:0,isPaying:!1,isGettingNext:!1,isPreferentialFinished:!1,preferentialVector:[],isSetValues:!1,isPaySuccess:!1,isGoToCommand:!0,shakeLoopObj:null,hasCountDown:null,saveBubbleVector:[],saveBubbleDataVector:[],bubbleArchivalCount:[],dialogNext:null,setValueAfterPay:!1,isInputFocus:!1,isLineUpdatePaySuccess:!1,playAdCallBack:null,playAdPayStatus:0})}),require.register("js/view/component/Scene.js",function(t,n,a){"use strict";function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){return e&&e.__esModule?e:{"default":e}}var i=n("puremvc"),s=r(i),l=n("../../common/XmlHttpRequest.js"),u=o(l),c=n("../../common/RePhaser.js"),d=r(c),h=n("../../common/Utils.js"),f=r(h),m=n("../../common/Version.js"),p=r(m),y=n("../../common/PhoneUtils.js"),g=r(y),v=n("../../common/FontUtils.js"),x=r(v),P=n("../../common/OtherWap.js");s["default"].define({name:"diygamePlayer.view.component.Scene",constructor:function(){var t=this,n=function(){var n=t,a=flashvars.vertical?540:960,o=flashvars.vertical?960:540,r={init:function l(){!n.game.device.desktop&&(n.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL),!flashvars.wap||"qh"!==flashvars.wap&&"4399"!==flashvars.wap||(n.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL),n.game.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL,n.game.scale.pageAlignVertically=!0,n.game.scale.pageAlignHorizontally=!0,n.game.stage.disableVisibilityChange=!0;var t=function(){return navigator.userAgent.indexOf("iPhone")>-1&&window.orientation&&0===window.orientation};n.game.scale.setResizeCallback(function(a,o){var r=document.getElementById("game"),i=t()?e.width:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,s=t()?e.height:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t()&&i>s&&(i=e.height,s=e.width),r.style.width=i+"px",r.style.height=s+"px",i>s?flashvars.vertical?90!==n.game.world.angle&&(n.game.scale.setGameSize(960,540),n.game.world.angle=90,n.game.world.setBounds(-960,0,540,960),n.game.scale.refresh()):0!==n.game.world.angle&&(n.game.scale.setGameSize(960,540),n.game.world.angle=0,n.game.world.setBounds(0,0,960,540),n.game.scale.refresh()):flashvars.vertical?0!==n.game.world.angle&&(n.game.scale.setGameSize(540,960),n.game.world.angle=0,n.game.world.setBounds(0,0,540,960),n.game.scale.refresh()):90!==n.game.world.angle&&(n.game.scale.setGameSize(540,960),n.game.world.angle=90,n.game.world.setBounds(-960,0,960,540),n.game.scale.refresh())}),n.game.load.loadImageTag=d["default"].loadImageTag,n.game.load.onSoundExtendLoad=new Phaser.Signal,n.game.load.onSoundExtendLoadError=new Phaser.Signal,g["default"].load=n.game.load,n.game.renderer.renderSession.roundPixels=!0,n.game.sound.decode=d["default"].soundDecode,n.game.sound.onSoundDecodeError=new Phaser.Signal;var l=function(){n.game.sound.touchLocked=!1,h.AudioTagPool.fill();var e=n.game.cache.getKeys(Phaser.Cache.SOUND);e.forEach(function(e){var t=n.game.cache.getSound(e);t&&!h.AudioTagPool.exist(t.data)&&n.game.cache.reloadSound(e)})};n.game.device.iOS?n.game.device.iOSVersion>8?n.game.input.touch.addTouchLockCallback(l,n.game,!0):n.game.input.touch.addTouchLockCallback(l,n.game):"wap"!==flashvars.client||!n.game.device.android||navigator.userAgent.indexOf("vivo Y66")===-1&&navigator.userAgent.indexOf("DIG-AL00")===-1?l():n.game.input.touch.addTouchLockCallback(l,n.game,!0),h.ResourcesManager.cache=n.game.cache,h.ResourcesManager.load=n.game.load,n.game.destroyComponent.add(function(e){h.ResourcesManager.subRefCount("img",e,"play")}),window.ResourcesManager=h.ResourcesManager},preload:function(){},create:function(){this.game.canvas.oncontextmenu=function(e){return e.preventDefault()};var e=n.game.add.graphics(0,0);e.name="startBk",e.beginFill(6476757),e.drawRect(0,0,a,o),e.endFill(),n.onRendered&&n.onRendered()},update:function(){}},i=Phaser.CANVAS,s=navigator.userAgent.match(/chrome\/((([0-9]*)+(\.))*)+([0-9]*)/gi);s&&("Chrome/50.0.2661.86"==s[0]||"Chrome/51.0.2704.81"==s[0]?-1===navigator.userAgent.indexOf("Android 6.0.1; MI 4LTE")&&-1===navigator.userAgent.indexOf("vivo Y67")&&(i=Phaser.AUTO):"Chrome/46.0.2490.76"==s[0]&&-1!==navigator.userAgent.indexOf("OPPO R9s")&&(i=Phaser.AUTO)),n.game=new Phaser.Game(a,o,i,"game",r),n.game.preserveDrawingBuffer=!0,window.game=n.game,window.AudioContext=null,
window.webkitAudioContext=null,console.log("versionCommit: ",p["default"])};u.getJson("config.json","",null).then(function(e){flashvars.uuid=e.uuid,flashvars.type=0,flashvars.offline=e.offline,flashvars.gid=e.gid,flashvars.vertical="1"===e.vertical,flashvars.name=e.name,flashvars.wap=e.wap,flashvars.single="1"===e.single,n()},function(e){n()})}},{showLogo:function(){var e=this.game.world.getByName("logo_preloader");e||(e=this.game.add.image(this.game.world.width/2,this.game.world.height/2,"logo_preloader"),e.name="logo_preloader",e.anchor.setTo(.5,.5)),e.visible=!0},showLoading:function(){var e=this.game.world.getByName("logo_preloader"),t=this.game.world.getByName("loading_gif");return t||(t=this.game.add.image(this.game.world.width/2,flashvars.vertical?this.game.world.height/2-100:this.game.world.height,"loading_gif"),t.anchor.set(.5,.5),t.x=this.game.world.width/2,t.y=flashvars.vertical?this.game.world.height/2-t.height/2:this.game.world.height/2-80,t.name="loading_gif",this.addGifAnimation(t)),e&&(e.scale.setTo(.35,.35),e.x=this.game.world.width-e.width+25,e.y=this.game.world.height-e.height+12),t.visible=!0,!0},showOfflineBg:function(){var e=this.game.world.getByName("offlinebg");e||(e=this.game.add.image(this.game.world.width/2,this.game.world.height/2,"OfflineBg"),e.name="offlinebg",e.inputEnabled=!0,e.anchor.setTo(.5,.5),this.game.world.setChildIndex(e,1)),e.visible=!0},destroyLogo:function(){var e=this.game.world.getByName("startBk"),t=this.game.world.getByName("logo_preloader"),n=this.game.world.getByName("loading_gif"),a=this.game.world.getByName("logInfo"),o=this.game.world.getByName("offlinebg"),r=this.game.world.getByName("Continue");o&&o.destroy(),r&&r.destroy(),e&&e.destroy(),t&&t.destroy(),n&&n.destroy(),a&&a.destroy()},preLoadCertainAssets:function(){flashvars.vertical||this.game.load.spritesheet("wind","./img/wind.png",960,540),this.game.load.image("icon_back","./img/icon_back.png"),this.game.load.image("icon_back_over_pressed","./img/icon_back_over_pressed.png"),this.game.load.image("icon_candy","./img/icon_candy.png"),this.game.load.image("icon_candy_over_pressed","./img/icon_candy_over_pressed.png"),this.game.load.image("icon_get","./img/icon_get.png"),this.game.load.image("icon_get_hover_pressed","./img/icon_get_hover_pressed.png"),this.game.load.image("icon_save","./img/icon_save.png"),this.game.load.image("icon_save_over_pressed","./img/icon_save_over_pressed.png"),this.game.load.image("cloud","./img/cloud.png"),this.game.load.image("cloud_hover","./img/cloud_hover.png"),this.game.load.image("local","./img/local.png"),this.game.load.image("local_hover","./img/local_hover.png"),this.game.load.image("icon_success","./img/icon_success.png"),this.game.load.image("icon_error","./img/icon_error.png"),this.game.load.image("light","./img/light.png"),this.game.load.image("toast_loading","./img/toast_loading.gif"),this.game.load.image("app_button_speed","./img/app_button_speed.png"),this.game.load.image("app_icon_speed","./img/app_icon_speed.png"),"wap"===flashvars.client&&this.game.load.image("wapback","./img/wapback.png"),flashvars.single&&"1"===flashvars.offline?(this.game.load.image("OfflineBg",flashvars.vertical?"./img/offlinebg_1.png":"./img/offlinebg.png"),this.game.load.image("Continue","./img/Continue.png"),this.game.load.image("menuMore","./img/more.png"),this.game.load.image("menuMoreHover","./img/more_hover.png")):(this.game.load.image("Operation_tip",flashvars.vertical?"./img/Operation_tip_1.gif":"./img/Operation_tip.png"),this.game.load.image("Cloud_record_tip",flashvars.vertical?"./img/Cloud_record_tip_1.png":"./img/Cloud_record_tip.png"),this.game.load.image("logo_preloader","./img/logo_preloader.png"),this.game.load.image("loading_gif","./img/loading_gif.gif"))},preLoadWeatherAssets:function(){if("1"===flashvars.offline){if(flashvars.vertical)for(var e=0;e<20;e++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("wind")+"/feng_"+f["default"].formatNum(e)+".png","./img/"+f["default"].getWeatherFilePathName("wind")+"/feng_"+f["default"].formatNum(e)+".png");for(var t=0;t<50;t++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("rain")+"/xiayu_"+f["default"].formatNum(t)+".png","./img/"+f["default"].getWeatherFilePathName("rain")+"/xiayu_"+f["default"].formatNum(t)+".png");for(var n=0;n<120;n++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("snow")+"/xuehua_"+f["default"].formatNum(n)+".png","./img/"+f["default"].getWeatherFilePathName("snow")+"/xuehua_"+f["default"].formatNum(n)+".png");for(var a=0;a<90;a++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_"+f["default"].formatNum(a)+".png","./img/"+f["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_"+f["default"].formatNum(a)+".png");for(var o=0;o<90;o++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("beachBlossom")+"/taohua_"+f["default"].formatNum(o)+".png","./img/"+f["default"].getWeatherFilePathName("beachBlossom")+"/taohua_"+f["default"].formatNum(o)+".png");for(var r=0;r<90;r++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("blossom")+"/yinghua_"+f["default"].formatNum(r)+".png","./img/"+f["default"].getWeatherFilePathName("blossom")+"/yinghua_"+f["default"].formatNum(r)+".png");for(var i=0;i<50;i++)this.game.load.image("/weather/"+f["default"].getWeatherFilePathName("lightning")+"/shandian_"+f["default"].formatNum(i)+".png","./img/"+f["default"].getWeatherFilePathName("lightning")+"/shandian_"+f["default"].formatNum(i)+".png")}},preLoad:function(){var e=this,t=function(){return new Promise(function(t,n){e.preLoadCertainAssets(),e.game.load.onLoadStart.addOnce(function(){e.addLog("正在准备播放..")}),e.game.load.onFileComplete.add(function(t,n,a,o,r){flashvars.single&&"1"===flashvars.offline?"offlinebg"===n&&e.showOfflineBg():"logo_preloader"===n&&e.showLogo(),e.addLog("正在准备播放.. "+t+"%",!0)}),e.game.load.onLoadComplete.addOnce(function(){return e.game.load.onFileComplete.removeAll(),e.addLog("正在准备播放..【成功】",!0),t()}),e.game.load.start()})};return flashvars.single&&"1"===flashvars.offline&&"4399"===flashvars.wap?P.H54399Api.init4399Api().then(function(e){return console.log("4399API",e),t()}):t()},getGameJson:function(e){var t=this;flashvars.uuid=flashvars.uuid||"41138941-7f1c-4701-9a94-394893483662";var n=flashvars.uuid;document.title=flashvars.name&&decodeURI(flashvars.name)||"测试";var a=function(e){if(e.lengthComputable){var n=e.loaded/e.total;t.addLog("加载用户配置.. "+~~n+"%",!0)}else t.addLog("加载用户配置.. "+e.loaded,!0)};this.addLog("加载用户配置..");var o=e?u.getOtherGame:1==flashvars.type?u.getTestGame:u.getGame;return o(n,a).then(function(e){return t.addLog("加载用户配置..【成功】",!0),e},function(e){return t.addLog("发生错误："+e),Promise.reject(e)})},addLog:function(e,t){if(e){var n=this.game.world.getByName("logInfo");if(!n){var a={font:"16px 宋体",fill:"#fff"};n=this.game.add.text(18,this.game.world.height-36,"",a),n.name="logInfo"}var o=n.text,r=o.split(/\r?\n/gi).filter(function(e){return!!e});t?r[r.length-1]=e:r.push(e),n.text="",r.slice(-4).map(function(e){return n.text+=e+"\n"}),n.y=this.game.world.height-26*r.length}},addButton:function(e,t,n,a,o,r,i,s,l,u,c,d){var h=this,m=function(e,t,n,a,o){var r=o.children[0],i=t?t:r?r.text:"";if(i){var s=e.fontSize?parseInt(e.fontSize):25,l=e.color?e.color:"#fefefe",u=h.sceneProxy.json_data.font.size?h.sceneProxy.toRealImageFontHeight(s):s,c=h.sceneProxy.json_data.font.size?h.sceneProxy.toRealImageFontWidth(s):s;if(l.indexOf("rgb")!==-1){var d=l.replace("rgb(","").replace(")","").split(",");o.addColor("#"+("00000"+(parseInt(d[0])<<16|parseInt(d[1])<<8|parseInt(d[2])).toString(16)).substr(-6),0)}else o.addColor("#ffffff"===l?"#fefefe":l,0);o.wordWrapWidth=540,h.sceneProxy.addImageFontText([{data:i}],c,u,o,h.sceneProxy.context);var f=o.children[0].extWidth?o.children[0].extWidth:c*i.length,m=(n-f)/2-(o.children[0].extMargin?o.children[0].extMargin:0),p=(a-u)/2;o.children[0].x=m,o.children[0].y=p,o.children[0].text=i,r&&(r.children.forEach(function(e){return e.fontImg.destroy()}),r.destroy()),o.text=" "}},p=function(e,t,o,r){var i=e.getByName("background"),s=e.getByName("button"),l=e.getByName("text"),u=h.game.load.cache.checkImageKey(t)?t:null;if(s)if(l&&o&&(x["default"].fontFamily?m(o,"",n,a,l):(l.font=o.fontFamily||l.font,l.fontSize=o.fontSize||l.fontSize,l.fontWeight=o.fontWeight||l.fontWeight,l.fill=o.color||l.fill),l.visible=!o.hidden),u){var c=1,d=s.width,f=s.height,p=h.game.cache.getImage(u);p.delay?i.key!==u&&h.addGifAnimation(i,u):(c=Math.min(d/p.width,f/p.height),i.loadTexture(u),i.scale.setTo(c,c),i.x=(d-i.width)/2,i.y=(f-i.height)/2)}else r||i.loadTexture(null)},y=this.game.add.group();y.name=u,c&&c.add(y),y.x=e,y.y=t;var g=this.game.load.cache.checkImageKey(o)?o:null,v=this.game.load.cache.checkImageKey(r)?r:null,P=this.game.add.image(0,0,g,null,y);P.name="background";var w=Math.min(n/P.width,a/P.height);P.scale.setTo(w,w),P.x=(n-P.width)/2,P.y=(a-P.height)/2,this.addGifAnimation(P,g);var b=!1,k=null,C=null,_=function(e,t){k=e,C=t},S=this.game.add.button(0,0,null,d?i:_,this,0,0,0,0,y);S.width=n,S.height=a,S.name="button",l&&(l.prevolume=void 0!==l.prevolume?l.prevolume:l.volume,this.game.device.desktop?S.setOverSound(l):S.setDownSound(l),this.game.device.desktop?S.onInputOut.add(function(){return l.stop()}):S.onInputUp.add(function(){}));var I=null;if(s){var L={},E="";E+=s.normal.fontWeight?s.normal.fontWeight+" ":"normal ",E+=s.normal.fontSize?parseInt(s.normal.fontSize)+"px ":"",E+=s.normal.fontFamily?s.normal.fontFamily:this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:"",L.font=E,L.fill=s.normal.color,L.stroke=s.normal.stroke,L.strokeThickness=s.normal.stroke?2:0,L.boundsAlignH="center",L.boundsAlignV="middle",I=this.game.add.text(0,0,s.text,L,y),I.name="text",x["default"].fontFamily?m(s.normal,s.text,n,a,I):I.setTextBounds(0,(I.height-parseInt(s.normal.fontSize||12))/2,n,a),s.normal.hidden&&(I.visible=!1)}return S.input.mouseOut=function(){if(null!==this.sprite&&this.sprite.inputEnabled){var e=this._pointerData[0];e.isOver=!1,e.isOut=!0,e.timeOut=this.game.time.time,this.useHandCursor&&e.isDragged===!1&&(this.game.canvas.style.cursor="default",this._setHandCursor=!1),this.sprite&&this.sprite.events&&(this.sprite.events.onInputOut$dispatch(this.sprite,null),this.sprite&&this.sprite.parent&&this.sprite.parent.type===Phaser.GROUP&&this.sprite.parent.onChildInputOut.dispatch(this.sprite,null))}},!d&&S.onInputOver.add(function(){S.onOverSound&&(S.onOverSound.volume=(void 0!==S.onOverSound.prevolume?S.onOverSound.prevolume:S.onOverSound.volume)*f["default"].soundVolume),p(y,v,s&&s.normal)}),!d&&S.onInputOut.add(function(){b=!1,p(y,g,s&&s.normal)}),!d&&S.onInputDown.add(function(){b=!0,S.onDownSound&&(S.onDownSound.volume=(null!==S.onDownSound.prevolume?S.onDownSound.prevolume:S.onDownSound.volume)*f["default"].soundVolume),p(y,v,s&&s.active)}),!d&&S.onInputUp.add(function(){b=!1,p(y,g,s&&s.normal),i&&i(k,C)}),y.changeBackground=function(e,t,n){p(this,e,t,n)},y.button=S,y.text=I,y},addGifAnimation:function(e,t){var n=this.game.cache.getImage(e.key,!0),a=n.data,o=a.frames,r=a.loopCount;if(o){var i=1,s=function(t){if(o[t]&&o[t].blobUrl){var n=new Image;n.onload=function(t){var n=new PIXI.BaseTexture(t.target),a=new PIXI.Texture(n);e&&e.parent&&e.setTexture(a)},n.src=o[t].blobUrl}},l=function u(t){f["default"].timeout(10*o[t].delay).then(function(){if(s(t),t++,t>=o.length){if(r&&i>=r||!e||!e.parent)return;i++,u(0)}else u(t)})};l(0)}},addFitImageSprint:function(e,t,n,a,o,r,i){var s=this.game.load.cache.checkImageKey(o)?o:null,l=this.game.add.sprite(e,t,s);if(s){var u=Math.min(n/l.width,a/l.height);l.pivot.x=l.width/2,l.pivot.y=l.height/2,l.scale.setTo(u,u),l.x+=l.width/2,l.y+=l.height/2}if(i>0){var c=0;for(c=0;c<r.children.length;c++){var d=r.getAt(c);if(-1===d)break;if(d.zIndex===i){r.removeChildAt(c),d.destroy();break}if(d.zIndex>i)break}var h=this.game.add.group();h.add(l),h.zIndex=i,r.add(h,!1,c)}else r.add(l);return l},game:null,onRendered:null,sceneProxy:null},{TEXT_CHANGED:"textChanged"})}),require.register("js/view/mediator/CoverMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i),l=t("../../common/PhoneUtils.js"),u=a(l);r["default"].define({name:"diygamePlayer.view.mediator.CoverMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU:this.showCoverLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},addCover:function(){var e=this,t=this.sceneProxy.json_data,n=t.template,a=t.cover,o=n.json.cover,r=o.titleContainer,i=o.startMenu,l=o.loadMenu,u=o.settingsMenu,c=o.overMenu,d=this.game.world.width,h=this.game.world.height,f=function(t,n,a,o,r,i,l,u){var c={},h="";h+=i.fontWeight?i.fontWeight+" ":"normal ",h+=i.fontSize?parseInt(i.fontSize)+"px ":"",h+=i.fontFamily?i.fontFamily:"",c.font=h,c.fill=i.color,c.stroke=i.stroke,c.strokeThickness=i.stroke?2:0,c.boundsAlignH="center",c.boundsAlignV=u?"bottom":"middle";var f=e.game.add.text(0,0,r,c,e.sceneProxy.coverLayer);if(f.name=l,s["default"].fontFamily){var m=("#ffffff"===i.color?"#fefefe":i.color).replace("#","0x"),p=i.fontSize?parseInt(i.fontSize):25;f.colors.splice(0,f.colors.length),f.text=" ",f.fill=m,f.addColor(m,0),f.x=(d-p*r.length)/2,f.y=n,f.wordWrapWidth=d;var y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(p):p,g=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(p):p;e.sceneProxy.addImageFontText([{data:r}],g,y,f,e.sceneProxy.context)}else f.setTextBounds(t,n+(f.height-parseInt(i.fontSize))/2,a,o);return i.hidden&&(f.visible=!1),f},m=function(t,n,a){var o={};o.normal=t.normal.text,o.active=t.active.text,o.text=a;var r=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,t.normal.background.url,t.active.background.url,p,o,e.sceneProxy.btn_sound,n,e.sceneProxy.coverLayer);r.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})},p=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("cover_button_start"===t.parent.name?e.sceneProxy.onCoverStartBtnClicked():"cover_button_load"===t.parent.name?e.sceneProxy.onCoverLoadBtnClicked():"cover_button_settings"===t.parent.name?e.sceneProxy.onCoverSettingBtnClicked():"cover_button_over"===t.parent.name&&e.sceneProxy.onCoverOverBtnClicked())},y=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.coverLayer);y.beginFill(0),y.drawRect(0,0,d,h),y.endFill();var g=a.background.url;if(this.game.load.cache.checkImageKey(g)&&(y=this.sceneProxy.coverLayer.create(0,0,g)),this.sceneProxy.prePlotBkKey=this.sceneProxy.lstPlotBkKey,this.sceneProxy.lstPlotBkKey=a.background.url,this.sceneProxy.lstPlotBkFlex=a.background.flex,this.sceneProxy.lstPlotBkOpacity=a.background.opacity,this.sceneProxy.lstGameBk=this.viewComponent.game.add.sprite(0,0,this.game.load.cache.checkImageKey(g)&&g),y.inputEnabled=!0,3===a.background.flex){var v=y.width/y.height<d/h?d/y.width:h/y.height;y.width*=v,y.height*=v,y.x=-(y.width-d)/2,y.y=-(y.height-h)/2}else if(5===a.background.flex){var x=0;y.width/y.height>d/h?(x=d/y.width,y.width*=x,y.height*=x,y.y=(h-y.height)/2):(x=h/y.height,y.width*=x,y.height*=x,y.x=(d-y.width)/2)}else y.width=d,y.height=h;this.sceneProxy.lstGameBk.x=y.x,this.sceneProxy.lstGameBk.y=y.y,this.sceneProxy.lstGameBk.width=y.width,this.sceneProxy.lstGameBk.height=y.height,a.title.data&&!r.title.text.hidden&&this.viewComponent.addFitImageSprint(r.rect.x,r.rect.y,r.rect.width,r.rect.height,r.background.url,this.sceneProxy.coverLayer);var P=a.title,w=P.font_size,b=P.color,k=P.bold,C=P.fontFamily,_=P.hidden,S=r.title.text;w&&(S.fontSize=w),b&&(S.color=b),void 0!==k&&(S.fontWeight=k?"bold":"normal"),S.fontFamily=this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:C?C:"",void 0!==_&&(S.hidden=_),f(r.title.rect.x+r.rect.x,r.title.rect.y+r.rect.y,r.title.rect.width,r.title.rect.height,a.title.data,S,"cover_text_title",!0),i.hidden||m(i,"cover_button_start",this.sceneProxy.stringMap.startMenu),l.hidden||m(l,"cover_button_load",this.sceneProxy.stringMap.loadMenu),u.hidden||m(u,"cover_button_settings",this.sceneProxy.stringMap.settingsMenu),c.hidden||m(c,"cover_button_over",this.sceneProxy.stringMap.overMenu),this.sceneProxy.coverLayer.visible=!1},showCoverLayer:function(){this.sceneProxy.lstPlotLayer&&this.sceneProxy.lstPlotLayer.destroy(),this.sceneProxy.curPlotLayer&&this.sceneProxy.curPlotLayer.destroy(),this.sceneProxy.dialogLayer.visible=!1,this.sceneProxy.menuLayer.visible=!1,this.sceneProxy.lstGameBk&&(this.sceneProxy.lstGameBk.visible=!0),0===this.sceneProxy.coverLayer.children.length&&this.addCover();var e=this.sceneProxy.json_data.cover,t=e.music,n=e.background;this.sceneProxy.bk_music&&this.sceneProxy.stopMusic(),t&&(this.game.load.cache.checkSoundKey(t.url)||u["default"].isAudioInCache(t.url)&&"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&this.sceneProxy.playMusic(t.url,t.volume,!0),this.sceneProxy.lstPlotBkKey=n.url,this.sceneProxy.lstPlotBkOpacity=n.opacity,this.sceneProxy.lstPlotBkFlex=n.flex,this.sceneProxy.coverLayer.visible=!0,this.game.world.bringToTop(this.sceneProxy.coverLayer)}},{NAME:"CoverMediator"})}),require.register("js/view/mediator/EndMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var r=t("puremvc"),i=a(r);i["default"].define({name:"diygamePlayer.view.mediator.EndMediator",parent:i["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_END]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_END:this.showEndLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game},btnStatesChanged:function(e,t,n,a,o,r,i){a&&(a.font=r.fontFamily,a.fontSize=r.fontSize,a.fontWeight=r.fontWeight,a.fill=r.color,a.visible=!r.hidden,void 0!==i&&(a.inputEnabled=i)),this.loadTexture(n,o)},loadTexture:function(e,t){if(e){var n=e.width,a=e.height,o=this.game.cache.checkImageKey(t)?t:null;e.loadTexture(o),e.width=n,e.height=a}},addEnd:function(){var e=this,t=function(t,n,o,r,i,s){var l=e.game.cache.checkImageKey(o)?o:null,u=e.game.add.button(t,n,l,a,e,0,0,0,0,e.sceneProxy.endLayer);return u.width=r,u.height=i,u.name=s,u},n=function(t,n,a,o,r,i,s){var l={},u="";u+=i.fontWeight?i.fontWeight+" ":"normal ",u+=i.fontSize?parseInt(i.fontSize)+"px ":"",u+=i.fontFamily?i.fontFamily:"",l.font=u,l.fill=i.color,l.boundsAlignH="center",l.boundsAlignV="middle";var c=e.game.add.text(0,0,r,l,e.sceneProxy.endLayer);return c.name=s,c.setTextBounds(t,n+(c.height-parseInt(i.fontSize))/2,a,o),i.hidden&&(c.visible=!1),c},a=function(t,n){if(n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)switch(t.name){case"end_button_get":e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_gte"),"icon_get",s),e.sceneProxy.endLayer.visible=!1,e.sceneProxy.visibleLayout=[e.sceneProxy.endLayer].concat(o(e.sceneProxy.visibleLayout)),e.sceneProxy.showLoad();break;case"end_button_back":e.sceneProxy.reStart(e.sceneProxy.isExtend()),e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_back"),"icon_back",s),e.sceneProxy.endLayer.visible=!1;break;case"end_button_save":e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_save"),"icon_save",s),e.sceneProxy.showSave()}},r=this.game.add.bitmapData(this.game.world.width,this.game.world.height);r.fill(0,0,0,.8);var i=this.game.add.sprite(0,0,r);i.width=this.game.world.width,i.height=this.game.world.height,i.inputEnabled=!0,this.sceneProxy.endLayer.add(i);var s={fontFamily:"",fontSize:"14px",color:"#ffffff"},l={fontFamily:"",fontSize:"14px",color:"#ef7297"},u=t(flashvars.vertical?55:168,flashvars.vertical?427:100,"icon_get",96,96,"end_button_get"),c=n(flashvars.vertical?55:168,flashvars.vertical?527:200,96,30,"读取进度",s,"end_text_get");u.onInputOver.add(this.btnStatesChanged,this,0,u,c,"icon_get_hover_pressed",l),u.onInputDown.add(this.btnStatesChanged,this,0,u,c,"icon_get_hover_pressed",l),u.onInputOut.add(this.btnStatesChanged,this,0,u,c,"icon_get",s);var d=t(flashvars.vertical?216:432,flashvars.vertical?427:100,"icon_back",96,96,"end_button_back"),h=n(flashvars.vertical?216:432,flashvars.vertical?527:200,96,30,"返回封面",s,"end_text_back");d.onInputOver.add(this.btnStatesChanged,this,0,d,h,"icon_back_over_pressed",l),d.onInputDown.add(this.btnStatesChanged,this,0,d,h,"icon_back_over_pressed",l),d.onInputOut.add(this.btnStatesChanged,this,0,d,h,"icon_back",s);var f=t(flashvars.vertical?377:696,flashvars.vertical?427:100,"icon_save",96,96,"end_button_save"),m=n(flashvars.vertical?377:696,flashvars.vertical?527:200,96,30,"存个档，下次玩",s,"end_text_save");f.onInputOver.add(this.btnStatesChanged,this,0,f,m,"icon_save_over_pressed",l),f.onInputDown.add(this.btnStatesChanged,this,0,f,m,"icon_save_over_pressed",l),f.onInputOut.add(this.btnStatesChanged,this,0,f,m,"icon_save",s),this.sceneProxy.endLayer.visible=!1},showEndLayer:function(){this.sceneProxy.getSnap(),0===this.sceneProxy.endLayer.children.length&&this.addEnd(),this.game.world.bringToTop(this.sceneProxy.endLayer),this.sceneProxy.endLayer.visible=!0}},{NAME:"EndMediator"})}),require.register("js/view/mediator/HtmlTextBox.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t,n,a,o,r,i,s,l,u){Phaser.Group.call(this,e),this.game=e,this.name="input",this.parentElement=e.canvas.parentNode,this.textBoxElement=document.createElement("input"),this.textBoxElement.style.position="absolute",this.textBoxElement.style.margin="0",this.textBoxElement.style.border="0",this.textBoxElement.style.padding="0",this.textBoxElement.style.left=t+"px",this.textBoxElement.style.top=n+"px",this.textBoxElement.style.width=a+"px",this.textBoxElement.style.height=o+"px",this.textBoxElement.style.color=i,this.textBoxElement.style.backgroundColor="transparent",this.textBoxElement.style.borderColor="transparent transparent transparent transparent",this.textBoxElement.style.outline="none",this.textBoxElement.style.fontSize=s+"px",this.textBoxElement.style.fontFamily=l,this.textBoxElement.style.fontWeight=u?"bold":"normal",this.parentElement.insertBefore(this.textBoxElement,e.canvas),this._x=t,this._y=n,this._width=a,this._height=o,this._fontSize=s,this.text=r,this.isValue=!1,e.add.existing(this),this.onDestroy.add(function(e){this.parentElement.removeChild(this.textBoxElement)},this)}Object.defineProperty(e,"__esModule",{value:!0}),e.HtmlTextBox=o;var r=t("../../common/Utils.js"),i=a(r);o.prototype=Object.create(Phaser.Group.prototype),o.prototype.constructor=o,o.prototype.update=function(){var e=this.game.canvas,t=e.offsetLeft,n=e.offsetTop,a=e.offsetWidth,o=e.offsetHeight;if(this.oldCanvasWidth!=a||this.oldCanvasHeight!=o||this.oldCanvasX!=t||this.oldCanvasY!=n){var r=this.game.world.width,i=this.game.world.height;if(e.offsetWidth>e.offsetHeight){var s=(flashvars.vertical?o:a)/r,l=(flashvars.vertical?a:o)/i,u=this._x/r,c=this._y/i,d=flashvars.vertical?t+a-a*c:t+a*u,h=flashvars.vertical?n+o*u:n+o*c,f=this._width*s,m=this._height*l,p=this._fontSize*l;this.setLeft(flashvars.vertical?d-f/2-m/2:d),this.setTop(flashvars.vertical?h+f/2-m/2:h),this.setWidth(f),this.setHeight(m),this.setFontSize(p),this.textBoxElement.style.transform=flashvars.vertical?"rotate(90deg)":"rotate(0deg)"}else{var y=(flashvars.vertical?a:o)/r,g=(flashvars.vertical?o:a)/i,v=this._x/r,x=this._y/i,P=flashvars.vertical?t+a*v:t+a-a*x,w=flashvars.vertical?n+o*x:n+o*v,b=this._width*y,k=this._height*g,C=this._fontSize*g;this.setLeft(flashvars.vertical?P:P-b/2-k/2),this.setTop(flashvars.vertical?w:w+b/2-k/2),this.setWidth(b),this.setHeight(k),this.setFontSize(C),this.textBoxElement.style.transform=flashvars.vertical?"rotate(0deg)":"rotate(90deg)"}this.oldCanvasWidth=a,this.oldCanvasHeight=o,this.oldCanvasX=t,this.oldCanvasY=n}},o.prototype.destroy=function(){this.parentElement.removeChild(this.textBoxElement)},o.prototype.show=function(e){this.textBoxElement.style.visibility=e?"visible":"hidden"},o.prototype.setInputCallback=function(e){var t=this,n=function(){t._text=t.textBoxElement.value,i["default"].sensitiveWords.forEach(function(e){if(0!==e.length){var n=t._text.indexOf(e);if(n!==-1){var a="*".repeat(e.length);t._text=t._text.replace(new RegExp(e,"gi"),a),t.textBoxElement.value=t._text}}}),e(t._text)};if("ios"===flashvars.client||navigator.userAgent.indexOf("iPhone")>-1){var a=navigator.userAgent.match(/CPU\siPhone\sOS\s((([0-9]*)+(_))*)+([0-9]*)/gi);a&&(a[0]>="CPU iPhone OS 10_3_1"||"CPU iPhone OS 10_0_2"===a[0])?this.textBoxElement.addEventListener("input",n,!1):this.textBoxElement.addEventListener("compositionend",function(){t.textBoxElement.removeEventListener("input",n,!1),t.textBoxElement.addEventListener("input",n,!1)},!1)}else this.textBoxElement.addEventListener("input",n,!1);this.textBoxElement.onblur=function(){if(t.isValue){var e=parseFloat(t._text);e?t.text=e+"":t.text="0"}}},o.prototype.setClickCallback=function(e){var t=this;this.textBoxElement.addEventListener("click",function(){e(t)},!1)},o.prototype.setLeft=function(e){this.textBoxElement.style.left=e+"px"},o.prototype.setTop=function(e){this.textBoxElement.style.top=e+"px"},o.prototype.setWidth=function(e){this.textBoxElement.style.width=e+"px"},o.prototype.setHeight=function(e){this.textBoxElement.style.height=e+"px"},o.prototype.setFontSize=function(e){this.textBoxElement.style.fontSize=e+"px"},o.prototype.setEnable=function(e){this.textBoxElement.readOnly=(!!e).toString()},Object.defineProperty(o.prototype,"x",{get:function(){return this._x},set:function(e){this.setLeft(e),this._x=e}}),Object.defineProperty(o.prototype,"y",{get:function(){return this._y},set:function(e){this.setTop(e),this._y=e}}),Object.defineProperty(o.prototype,"width",{get:function(){return this._width},set:function(e){this.setWidth(e),this._width=e}}),Object.defineProperty(o.prototype,"height",{get:function(){return this._height},set:function(e){this.setHeight(e),this._height=e}}),Object.defineProperty(o.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){this.setFontSize(e),this._fontSize=e}}),Object.defineProperty(o.prototype,"style",{get:function(){return this._style},set:function(e){for(var t in e)this.textBoxElement.style[t]=e[t];this._style=e}}),Object.defineProperty(o.prototype,"text",{get:function(){return this._text},set:function(e){this.textBoxElement.value=e,this._text=e}}),Object.defineProperty(o.prototype,"readOnly",{get:function(){return this.readOnly},set:function(e){this.setEnable(e),this.textBoxElement.readOnly=(!!e).toString()}})}),require.register("js/view/mediator/MainMenuMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i);r["default"].define({name:"diygamePlayer.view.mediator.MainMenuMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU]},handleNotification:function(e){var t=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU:this.showMainMenuLayer(t)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME),this.sceneMediator=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME),this.game=this.sceneMediator.viewComponent&&this.sceneMediator.viewComponent.game,this.viewComponent=this.sceneMediator.viewComponent,this.isAllHide=!1},addMainMenu:function(){var e=this,t=this.sceneProxy.json_data.template.json.mainMenu,n=t.background,a=t.header,o=t.save,r=t.load,i=t.playback,l=t.settings,u=t.autoplay,c=t.back,d=function(t,n,a,o,r,i,s){var l=t.fontSize?parseInt(t.fontSize):25,u=t.color?t.color:"#fefefe",c=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(l):l,d=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(l):l,h=d*i.length,f=n+(o-h)/2,m=a+(r-c)/2,p=e.sceneProxy.addRetroText(f,m,h,c,i);p.tint=("#ffffff"===u?"#fefefe":u).replace("#","0x"),s.addChild(p),s.text=" "},h=function(t,n,a,o,r,i,l){var u={},c="";c+=i.fontWeight?i.fontWeight+" ":"normal ",c+=i.fontSize?parseInt(i.fontSize)+"px ":"",c+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",u.font=c,u.fill=i.color,u.boundsAlignH="center",u.boundsAlignV="middle",u.stroke=i.stroke,u.strokeThickness=i.stroke?2:0;var h=e.viewComponent.game.add.text(0,0,r,u,e.sceneProxy.mainMenuLayer);return h.name=l,s["default"].fontFamily?d(i,t,n,a,o,r,h):h.setTextBounds(t,n+(h.height-parseInt(i.fontSize))/2,a,o),i.hidden&&(h.visible=!1),h},f=function(t,n,a){var o={};o.normal=t.normal.text,o.active=t.active.text,o.text=a;var r=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,t.normal.background.url,t.active.background.url,m,o,e.sceneProxy.btn_sound,n,e.sceneProxy.mainMenuLayer);r.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})},m=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("mainMenu_button_save"===t.parent.name?e.sceneProxy.onMainMenuSaveBtnClicked():"mainMenu_button_load"===t.parent.name?e.sceneProxy.onMainMenuLoadBtnClicked():"mainMenu_button_playback"===t.parent.name?e.sceneProxy.onMainMenuPlaybackBtnClicked():"mainMenu_button_autoplay"===t.parent.name?e.sceneProxy.onMainMenuAutoplayBtnClicked():"mainMenu_button_settings"===t.parent.name?e.sceneProxy.onMainMenuSettingsBtnClicked():"mainMenu_button_back"===t.parent.name&&e.sceneProxy.onMainMenuBackBtnClicked())},p=this.viewComponent.game.add.image(0,0,this.viewComponent.game.load.cache.checkImageKey(n.url)&&n.url);if(p.width=this.viewComponent.game.world.width,p.height=this.viewComponent.game.world.height,p.inputEnabled=!0,this.sceneProxy.mainMenuLayer.add(p),this.viewComponent.game.load.cache.checkImageKey(a.background.url)){var y=this.sceneProxy.mainMenuLayer.create(a.rect.x,a.rect.y,a.background.url);y.width=a.rect.width,y.height=a.rect.height}a.title.text.hidden||h(a.title.rect.x+a.rect.x,a.title.rect.y+a.rect.y,a.title.rect.width,a.title.rect.height,this.sceneProxy.stringMap.mainMenu,a.title.text,"mainMenu_text_header"),o.hidden||f(o,"mainMenu_button_save",this.sceneProxy.stringMap.save),r.hidden||f(r,"mainMenu_button_load",this.sceneProxy.stringMap.load),i.hidden||f(i,"mainMenu_button_playback",this.sceneProxy.stringMap.playback),u.hidden||f(u,"mainMenu_button_autoplay",this.sceneProxy.stringMap.autoplay),l.hidden||f(l,"mainMenu_button_settings",this.sceneProxy.stringMap.settings),c.hidden||f(c,"mainMenu_button_back",this.sceneProxy.stringMap.back),this.sceneProxy.mainMenuLayer.visible=!1,o.hidden&&r.hidden&&i.hidden&&l.hidden&&c.hidden&&(this.isAllHide=!0)},addDiyMainMenuenu:function(){var e=this,t=this.sceneProxy.json_data.default_settings.mainMenu,n=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.mainMenuLayer);n.beginFill(0,0),n.drawRect(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),n.endFill(),n.inputEnabled=!0,this.sceneMediator.registerViewKey(t.ref,t.events,this.sceneProxy.plotViewKeys);var a=this.sceneMediator.addView(this.sceneProxy.mainMenuLayer,t.ref,t.instanceUuid,t.x,t.y,t.events,!1,!1,!0);
a.isMenu=!0;var o=function(){var t=function n(t){"TIMER"===t.viewType&&(e.sceneProxy.menuTimer[e.sceneProxy.menuTimer.length]=t.name),t.children.forEach(function(e){n(e)})};a.children.forEach(function(e){t(e)})};o(),this.sceneMediator.uiOnLoadInvoker()},showMainMenuLayer:function(e){this.sceneProxy.mainMenuLayer.children.length>0&&this.sceneProxy.json_data.default_settings.mainMenu&&this.sceneProxy.mainMenuLayer.removeAll(!0),0===this.sceneProxy.mainMenuLayer.children.length&&(this.sceneProxy.json_data.default_settings.mainMenu?this.addDiyMainMenuenu():this.addMainMenu());var t=this.sceneProxy.mainMenuLayer.getByName("mainMenu_button_autoplay"),n=t?t.getByName("text"):void 0;if(e.auto){if(n)if(s["default"].fontFamily){var a=n.children[0];if(a){var o=this.sceneProxy.json_data.template.json.mainMenu.autoplay,r=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(o.normal.text.fontSize):o.normal.text.fontSize,i=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(o.normal.text.fontSize):o.normal.text.fontSize,l=i*this.sceneProxy.stringMap.manualPlay.length,u=(o.rect.width-l)/2,c=(o.rect.height-r)/2;this.sceneProxy.addImageFontText([{data:this.sceneProxy.stringMap.manualPlay}],i,r,n,e),n.children[0].x=u,n.children[0].y=c,a.children.forEach(function(e){return e.fontImg.destroy()}),a.destroy(),n.text=" "}}else n.text=this.sceneProxy.stringMap.manualPlay}else if(n)if(s["default"].fontFamily){var d=n.children[0];if(d){var h=this.sceneProxy.json_data.template.json.mainMenu.autoplay,f=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(h.normal.text.fontSize):h.normal.text.fontSize,m=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(h.normal.text.fontSize):h.normal.text.fontSize,p=m*this.sceneProxy.stringMap.autoplay.length,y=(h.rect.width-p)/2,g=(h.rect.height-f)/2;this.sceneProxy.addImageFontText([{data:this.sceneProxy.stringMap.autoplay}],m,f,n,e),n.children[0].x=y,n.children[0].y=g,d.children.forEach(function(e){return e.fontImg.destroy()}),d.destroy(),n.text=" "}}else n.text=this.sceneProxy.stringMap.autoplay;this.viewComponent.game.world.bringToTop(this.sceneProxy.mainMenuLayer),this.sceneProxy.mainMenuLayer.visible=!0,this.isAllHide!==!1&&this.sceneProxy.onMainMenuBackBtnClicked()}},{NAME:"MainMenuMediator",isAllHide:!1})}),require.register("js/view/mediator/PlaybackMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/RePhaser.js"),s=a(i),l=t("../../common/FontUtils.js");a(l);r["default"].define({name:"diygamePlayer.view.mediator.PlaybackMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK,diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK:this.callbackInfo=e.getBody(),this.showPlaybackLayer();break;case diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT:var t=e.getBody();this.addPlaybackContent(t)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},addTextContent:function(e,t,n,a,o,r){var i={boundsAlignH:"center",boundsAlignV:"middle",wordWrap:!0},s="";s+=r.fontWeight?r.fontWeight+" ":"normal ",s+=r.fontSize?parseInt(r.fontSize)+"px ":"",s+=r.fontFamily?r.fontFamily:"黑体",i.font=s,i.fill=r.color,i.wordWrapWidth=n,this.sceneProxy.stringMap.back===o?(i.boundsAlignH="center",i.boundsAlignV="middle"):(i.boundsAlignH="left",i.boundsAlignV="top");var l=this.game.add.text(0,0,o,i,this.sceneProxy.playBackLayer);return l.setTextBounds(e,t+(l.height-parseInt(r.fontSize||12))/2,n,a),l},addPlayback:function(){var e=this,t=this.sceneProxy.json_data.template.json.playback,n=t.scrollBox,a=t.back,o=t.background,r=this.sceneProxy.playBackLayer.create(0,0,this.game.load.cache.checkImageKey(o.url)&&o.url);r.width=this.game.world.width,r.height=this.game.world.height,r.inputEnabled=!0;var i=n.rect.x,s=n.rect.y,l=n.rect.width,u=n.rect.height,c=Object.assign({x:0,y:0,width:l,height:u},n.background.rect),d=this.sceneProxy.playBackLayer.create(i+c.x,s+c.y,this.game.load.cache.checkImageKey(n.background.url)&&n.background.url);d.width=c.width,d.height=c.height;var h=this.game.add.sprite(0,0),f=i,m=s;h.x=f,h.y=m,h.name="scrollPane",this.sceneProxy.playBackLayer.add(h);var p=(n.item.rect.width,n.item.rect.height),y=Math.max(p-n.item.content.rect.height,0),g=0,v=null,x=!1,P=function(e,t,n){var a=k(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?x||(document.addEventListener(o,_),x=!0):x&&(document.removeEventListener(o,_),x=!1)},w=function(e,t){var n=h.children.length*p-y;return n<u?void(h.y=s):(e!==i&&(h.x=i),void(t>s?h.y=s:t+n<s+u?h.y=s+u-n:h.y=t))},b=function(e,t,n,a,o,r){var i=n,s=a;r&&(g=n),v=h.y,document.body.clientWidth<document.body.clientHeight&&null!==v&&(s=v-n+g),w(i,s)},k=function(e){var t=void 0,n=void 0,a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,o=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return a>o?flashvars.vertical?(t=e.worldY,n=-e.worldX):(t=e.worldX,n=e.worldY):flashvars.vertical?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),n<m||n>m+u||t<f||t>f+l?null:{x:t,y:n}},C=function(e,t,n,a){return k(t)?e.input.enableDrag():e.input.disableDrag()},_=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;w(0,h.y+100*t)};h.inputEnabled=!0,h.input.enableDrag(),h.input.allowHorizontalDrag=!1,h.events.onDragUpdate.add(b,this),h.events.onInputDown.add(C,this),this.game.input.addMoveCallback(P,this);var S=this.game.add.graphics(0,0);S.beginFill(16777215),S.drawRect(i,s,l,u),this.sceneProxy.playBackLayer.add(S),h.mask=S;var I=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||(e.sceneProxy.onPlaybackBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null))};if(!a.hidden){var L={};L.normal=a.normal.text,L.active=a.active.text,L.text=this.sceneProxy.stringMap.back;var E=null;if(this.sceneProxy.json_data.template.json.sound){var T=this.sceneProxy.json_data.template.json.sound;this.sceneProxy.viewComponent.game.load.cache.checkSoundKey(T.url)&&(E=this.sceneProxy.viewComponent.game.add.sound(T.url,T.volume))}var M=this.viewComponent.addButton(a.rect.x,a.rect.y,a.rect.width,a.rect.height,a.normal.background.url,a.active.background.url,I,L,E,"playBack_button_back",this.sceneProxy.playBackLayer);M.button.onInputUp.add(function(){return E&&E.stop()})}this.sceneProxy.playBackLayer.visible=!1},addPlaybackContent:function(e){this.sceneProxy.playbackData.push(e),this.sceneProxy.playbackData.length>100&&this.sceneProxy.playbackData.splice(0,1)},addPlaybackItem:function(e){var t=this.sceneProxy.playBackLayer.getByName("scrollPane"),n=this.sceneProxy.json_data.template.json.playback.scrollBox,a=this.game.load.cache.checkImageKey(n.item.background.url)?n.item.background.url:null,o=this.game.load.cache.checkImageKey(n.item.content.background.url)?n.item.content.background.url:null,r=n.item.rect.x+n.item.content.rect.x,i=n.item.rect.y+n.item.content.rect.y,l=this.game.add.group();l.x=n.item.rect.x,l.y=n.item.rect.y+n.item.rect.height*t.children.length;var u=this.game.add.sprite(0,0,a);u.width=n.item.rect.width,u.height=n.item.rect.height;var c=this.game.add.sprite(r,i,o);c.width=n.item.content.rect.width,c.height=n.item.content.rect.height;var d=this.addTextContent(r+10,i,n.item.content.rect.width-10,n.item.content.rect.height,"",n.item.content.text);d.useAdvancedWrap=!0,d.updateText=s["default"].updateText,d.advancedWordWrap=s["default"].advancedWordWrap,d.lineSpacing=-parseInt(n.item.content.text.fontSize||12)/5,d.text=e,d.name="text";var h=this.game.add.graphics(0,0);h.beginFill(16777215),h.drawRect(r,i,c.width,c.height),d.mask=h,l.addChild(h),l.add(u),l.add(c),l.add(d),t.addChild(l)},showPlaybackLayer:function(){var e=this;this.sceneProxy.playBackLayer.removeAll(!0),this.addPlayback(),this.sceneProxy.playbackData.forEach(function(t){e.addPlaybackItem(t)}),this.game.world.bringToTop(this.sceneProxy.playBackLayer),this.sceneProxy.playBackLayer.visible=!0;var t=this.sceneProxy.json_data.template.json.playback.scrollBox,n=t.rect,a=t.item,o=this.sceneProxy.playBackLayer.getByName("scrollPane"),r=Math.max(a.rect.height-a.content.rect.height,0),i=o.children.length*a.rect.height-r,s=n.y+a.rect.y;i<n.height?o.y=s:o.y=s-i+n.height}},{NAME:"PlaybackMediator"})}),require.register("js/view/mediator/RecordMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("spark-md5"),s=a(i),l=t("./../../common/Dialog.js"),u=a(l),c=t("./../../common/Utils.js"),d=a(c),h=t("../../common/FontUtils.js"),f=a(h);r["default"].define({name:"diygamePlayer.view.mediator.RecordMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_RECORD]},handleNotification:function(e){var t=e.getBody();switch(this.callbackInfo=t?t:this.sceneProxy.recordLayer?this.callbackInfo:null,e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_RECORD:this.showRecordLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent,this.localMode=!0,this.isChangeClick=!1,this.clicktime=0,this.clickchangetime=0},onLocalBtnClicked:function(){if(this.clickInterval(800)===!0&&!this.localMode){this.localMode=!0,this.isChangeClick=!0;var e=this.sceneProxy.recordLayer.getByName("local_btn"),t=this.sceneProxy.recordLayer.getByName("cloud_btn");e&&e.changeBackground("local_hover"),t&&t.changeBackground("cloud"),this.sceneProxy.onRecordLocalBtnClicked()}},onCloudBtnClicked:function(){var e=this;this.clickInterval(800)===!0&&this.localMode&&this.sceneProxy.isSignedIn().then(function(){e.localMode=!1,e.isChangeClick=!0;var t=e.sceneProxy.recordLayer.getByName("local_btn"),n=e.sceneProxy.recordLayer.getByName("cloud_btn");t&&t.changeBackground("local"),n&&n.changeBackground("cloud_hover"),e.sceneProxy.onRecordCloudBtnClicked()},function(t){var n=t.indexOf("- status:-1");if(n=n>=0?n:t.indexOf("- status:2"),n>=0){if(e.sceneProxy.context.fullScreen&&e.sceneProxy.onSettingsWindowModeBtnClicked(),t.indexOf("- status:-110")>0){var a=e.sceneProxy.recordLayer.getByName("local_btn"),o=e.sceneProxy.recordLayer.getByName("cloud_btn");return a&&a.changeBackground("local_hover","local_btn"),o&&o.changeBackground("cloud","cloud_btn"),e.sceneProxy.onRecordLocalBtnClicked(),e.localMode=!0,void u["default"].error(t.substr(0,n)).then(function(){},function(){})}flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),"wap"===flashvars.client?window.parent&&window.parent.playLogin():u["default"].error(t.substr(0,n)).then(function(){window.location.href="lzj3000://login"})}else 0<=t.indexOf("error")&&(e.sceneProxy.context.fullScreen&&e.sceneProxy.onSettingsWindowModeBtnClicked(),u["default"].error("网络异常，请检查您的网络！"))})},addRecord:function(){var e=this,t=this.sceneProxy.json_data.template.json.record,n=t.background,a=t.scrollBox,o=t.back,r=a.rect,i=a.item,s=a.itemsOffsetX,l=a.itemsOffsetY,u=a.itemSpaceX,c=a.itemSpaceY,d=i.rect,h=i.hint,m=i.content,p=h.rect,y=h.text,g=m.rect,v=r.x,x=r.y,P=r.width,w=r.height,b=d.x,k=d.y,C=d.width,_=d.height,S=p.x,I=p.y,L=p.width,E=p.height,T=g.x,M=g.y,O=g.width,A=g.height;u=void 0===u?20:u,c=void 0===c?12:c,s=void 0===s?0:s,l=void 0===l?0:l;var V={boundsAlignH:"center",boundsAlignV:"middle"},B=function(t,n,a,o,r,i){var s=void 0,l="";if(l+=i.fontWeight?i.fontWeight+" ":"normal ",l+=i.fontSize?parseInt(i.fontSize)+"px ":"",l+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",V.font=l,V.fill=i.color,s=e.game.add.text(0,0,r,V,e.sceneProxy.recordLayer),f["default"].fontFamily){var u=(i.color?i.color:e.json_data.default_settings.color).replace("#","0x");if(u.indexOf("rgb")!==-1){var c=u.replace("rgb(","").replace(")","").split(",");s.addColor("#"+("00000"+(parseInt(c[0])<<16|parseInt(c[1])<<8|parseInt(c[2])).toString(16)).substr(-6),0)}else s.addColor(u,0);var d=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(s.fontSize):s.fontSize;s.x=t+(a-196*d/25-21-22*d/25)/2,s.y=n+(s.height-parseInt(s.fontSize))/2,s.wordWrapWidth=260*d/25}else s.setTextBounds(t,n+(s.height-parseInt(i.fontSize))/2,a,o);return s},N=this.sceneProxy.recordLayer.create(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);N.width=this.game.world.width,N.height=this.game.world.height,N.inputEnabled=!0;var j=this.game.add.sprite(0,0),R=Object.assign({x:0,y:0,width:P,height:w},n.rect),D=this.sceneProxy.recordLayer.create(v+R.x,x+R.y,this.game.load.cache.checkImageKey(a.background.url)&&a.background.url);D.width=R.width,D.height=R.height;var F=v+s,U=x+l;j.x=F,j.y=U,j.name="scrollPane",this.sceneProxy.recordLayer.add(j);var W=flashvars.vertical?12:3,G=flashvars.vertical?1:4,H=0,z=0,K=void 0,q={x:0,y:0},J=this.game.add.sprite(0,0);J.width=(C+u)*G,J.height=(_+c)*W,j.addChild(J);var $=0,Y=null,Q=!0,X=function(e,t){(Math.abs(j.y-Y)>2||Math.abs(j.x-$)>2)&&Y&&(Q=!1);var n=_*W+c*(W-1);t>U||n<=w?j.y=U:t+n<x+w?j.y=x+w-(_*W+c*(W-1)):j.y=t},Z=function(e,t,n,a,o,r){var i=n,s=a,l=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,u=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;l<u&&null!==Y&&!flashvars.vertical&&(s=Y-n+$),X(i,s)},ee=function(e,t,n,a,o,r){$=n,Y=j.y},te=function(e,t,n,a,o,r){Y=j.y},ne=function(e){var t=void 0,n=void 0,a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,o=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return a>o?flashvars.vertical?(t=e.worldY,n=-e.worldX):(t=e.worldX,n=e.worldY):flashvars.vertical?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),n<U||n>U+w||t<F||t>F+P?null:{x:t,y:n}},ae=function(e,t,n,a){return Q=!0,ne(t)?e.input.enableDrag():e.input.disableDrag()},oe=function(t,n){if(Q===!0){var a=ne(n);if(a&&(n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)){if(0===e.clicktime)e.clicktime=e.game.time.now;else{if(!(e.game.time.now-e.clicktime>=800))return;e.clicktime=0}q.x=0,q.y=0;var o=a.x-j.x,r=a.y-j.y,i=C+u,s=_+c;if(o%i<C&&r%s<_){var l=Math.floor(o/i),d=Math.floor(r/s);flashvars.vertical?e.sceneProxy.onRecordItemClicked(d,l):e.sceneProxy.onRecordItemClicked(l,d),e.sceneProxy.bToSaveFile||(e.callbackInfo=null)}}}},re=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;X(0,j.y+100*t)},ie=!1,se=function(e,t,n){var a=ne(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?ie||(document.addEventListener(o,re),ie=!0):ie&&(document.removeEventListener(o,re),ie=!1)};K=this.game.load.cache.checkImageKey(i.background.url)?i.background.url:null;for(var le=0;le<W;le++)for(var ue=0;ue<G;ue++){var ce=this.game.add.group();ce.x=ue*(C+u)+b,ce.y=le*(_+c)+k,ce.name="recordItem_"+(le*G+ue);var de=this.game.add.sprite(H,z,K);de.width=C,de.height=_;var he=this.sceneProxy.recordLayer.create(T,M,this.game.load.cache.checkImageKey(m.background.url)&&m.background.url);he.name="content",he.width=O,he.height=A;var fe=B(S,I,L,E,"",y);fe.name="textTime";var me=this.game.add.graphics(0,0);if(me.beginFill(),me.drawRect(0,0,C,_),me.endFill(),ce.addChild(me),ce.mask=me,ce.add(de),ce.add(he),ce.add(fe),this.sceneProxy.json_data.default_settings.autoSaveOrLoad&&0===le&&0===ue){var pe=this.game.add.bitmapData(C,_);pe.fill(0,0,0,.4);var ye=this.game.add.sprite(0,0,pe);ye.width=C,ye.height=_;var ge={font:"16px Microsoft YaHei",fill:"white",boundsAlignH:"center",boundsAlignV:"middle"},ve=this.game.add.text(0,0,"自动存档",ge,this.sceneProxy.coverLayer);ve.setTextBounds(0,(ve.height-16)/2,C,_),ce.add(ye),ce.add(ve)}j.addChild(ce)}j.inputEnabled=!0,j.input.enableDrag(),j.input.allowHorizontalDrag=!1,j.events.onDragUpdate.add(Z,this),j.events.onDragStart.add(ee,this),j.events.onDragStop.add(te,this),j.events.onInputUp.add(oe,this),j.events.onInputDown.add(ae,this),this.game.input.addMoveCallback(se,this);var xe=this.game.add.graphics(0,0);xe.beginFill(),xe.drawRect(j.x,j.y,P-s,w-l),xe.endFill(),this.sceneProxy.recordLayer.add(xe),j.mask=xe;var Pe={};Pe.normal=o.normal.text,Pe.active=o.active.text,Pe.text=this.sceneProxy.stringMap.back;var we=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("record_button_back"===t.parent.name?(e.sceneProxy.onRecordBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null)):"local_btn"===t.parent.name?e.onLocalBtnClicked():"cloud_btn"===t.parent.name&&e.onCloudBtnClicked())};if(!o.hidden){var be=this.viewComponent.addButton(o.rect.x,o.rect.y,o.rect.width,o.rect.height,o.normal.background.url,o.active.background.url,we,Pe,this.sceneProxy.btn_sound,"record_button_back",this.sceneProxy.recordLayer);be.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}if(Pe.text="",this.sceneProxy.isShowLocalBtn()){var ke=this.sceneProxy.viewComponent.game.world.width-74,Ce=25;this.viewComponent.addButton(ke,Ce,68,68,"local_hover",null,we,Pe,null,"local_btn",this.sceneProxy.recordLayer,!0)}if(this.sceneProxy.isShowCloudBtn()){var _e=this.sceneProxy.viewComponent.game.world.width-74,Se=107;this.viewComponent.addButton(_e,Se,68,68,"cloud",null,we,Pe,null,"cloud_btn",this.sceneProxy.recordLayer,!0)}this.sceneProxy.recordLayer.visible=!1},updateItems:function(){var e=this;this.sceneProxy.savedPlotsData.forEach(function(t,n){var a=function(t){var n=e.game.load.cache.checkImageKey(t)?t:null,a=l.getByName("content"),o=a.width,r=a.height;a.loadTexture(n),a.width=o,a.height=r},o=t?t:{},r=o.timestamp,i=o.plotSnap,l=e.sceneProxy.recordLayer.getByName("scrollPane").children.find(function(e){return e.name==="recordItem_"+n});if(l){if(!r)return a(e.sceneProxy.json_data.template.json.record.scrollBox.item.content.background.url),void(l.getByName("textTime").text="");var u=l.getByName("textTime"),c=s["default"].hash(i);if(e.game.load.cache.checkImageKey(c))a(c);else{var h=new Image;h.src=i,h.onload=function(t){e.game.load.cache.checkImageKey(c)||e.game.cache.addImage(c,i,t.target),a(c)}}var m=d["default"].getCurrentDateTime(r);if(f["default"].fontFamily){var p=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(u.fontSize):u.fontSize,y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(u.fontSize):u.fontSize;e.sceneProxy.addImageFontText([{data:m}],y,p,u,e.sceneProxy.context),u.text=" "}else u.text=m}})},showRecordLayer:function(){var e=this;this.clicktime=0,0===this.sceneProxy.recordLayer.children.length&&this.addRecord(),this.sceneProxy.isShowCloudBtn()&&this.sceneProxy.isShowLocalBtn()&&this.isChangeClick!==!0||this.isChangeClick!==!0&&this.sceneProxy.isWapOther()?this.sceneProxy.isSignedIn().then(function(){e.localMode=!1,e.isChangeClick=!0;var t=e.sceneProxy.recordLayer.getByName("local_btn"),n=e.sceneProxy.recordLayer.getByName("cloud_btn");t&&t.changeBackground("local"),n&&n.changeBackground("cloud_hover"),e.sceneProxy.onRecordCloudBtnClicked()},function(t){e.updateItems(),e.game.world.bringToTop(e.sceneProxy.recordLayer),e.showGuide(),e.sceneProxy.recordLayer.visible=!0}):(this.updateItems(),this.game.world.bringToTop(this.sceneProxy.recordLayer),this.showGuide(),this.sceneProxy.recordLayer.visible=!0)},showGuide:function(){this.sceneProxy.isShowGuide!==!0||this.sceneProxy.recordLayer.visible===!0||this.sceneProxy.isExtend()||Boolean(flashvars.wap&&"zxwwap"===flashvars.wap)||this.sceneProxy.isWapOther()||this.sceneProxy.showGuideTip(1)},clickInterval:function(e){return 0===this.clickchangetime?(this.clickchangetime=this.game.time.now,!0):this.game.time.now-this.clickchangetime>=e&&(this.clickchangetime=0,!0)}},{NAME:"RecordMediator",localMode:!0,isChangeClick:!1,clicktime:0,clickchangetime:0})}),require.register("js/view/mediator/SceneMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t("./CoverMediator.js"),t("./MainMenuMediator.js"),t("./SettingsMediator.js"),t("./PlaybackMediator.js"),t("./RecordMediator.js"),t("./EndMediator.js");var s=t("./HtmlTextBox.js"),l=o(s),u=t("./../../common/Dialog.js"),c=a(u),d=t("../../common/RePhaser.js"),h=a(d),f=t("../../common/Utils.js"),m=a(f),p=t("../../common/PhoneUtils.js"),y=a(p),g=t("../../common/FontUtils.js"),v=a(g),x=t("../../common/OtherWap.js"),P=a(x),w=t("copy-to-clipboard"),b=a(w),k=t("puremvc"),C=a(k);C["default"].define({name:"diygamePlayer.view.mediator.SceneMediator",parent:C["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_SHOW_AD,diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN,diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS,diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE,diygamePlayer.AppConstants.SCENE_LOADING_BEGIN,diygamePlayer.AppConstants.SCENE_LOADING_PROGRESS,diygamePlayer.AppConstants.SCENE_LOADING_COMPLETE,diygamePlayer.AppConstants.SCENE_SHOW_LOGO,diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY,diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED,diygamePlayer.AppConstants.SCENE_DESTROY_VIEW,diygamePlayer.AppConstants.SCENE_SHOW_GUIDE,diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW]},handleNotification:function(e){var t=this,n=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_SHOW_AD:break;case diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN:this.sceneProxy.viewComponent=this.viewComponent,this.generateLayers(),this.sceneProxy.space_key=this.viewComponent.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.addKeyBoardZ(),this.viewComponent.game.input.onHold.add(function(){t.screenCaptured()}),this.viewComponent.game.input.onUp.add(function(){t.screenReleased()}),this.viewComponent.game.load.crossOrigin="anonymous",this.viewComponent.preLoad().then(function(){return m["default"].getSensitiveWords(),t.addToastLayer(),t.addLoadingToastLayer(),t.viewComponent.getGameJson(t.sceneProxy.isWapOther())}).then(function(e){return 0===Object.keys(e).length?Promise.reject("链接已过期"):(t.viewComponent.addLog("解析用户配置..."),flashvars.single&&"1"===flashvars.offline?t.viewComponent.showOfflineBg():t.viewComponent.showLoading(),t.sceneProxy.parseJsonFile(e).then(function(){return t.viewComponent.addLog("解析用户配置..【成功】",!0),new Promise(function(e,n){if(!flashvars.single||"1"!==flashvars.offline)return e();var a=function(n,a){if(!a||a.pointerMode!==Phaser.PointerMode.CURSOR||0===a.button){t.viewComponent.game.input.onDown.dispose();var o=t.viewComponent.game.world.getByName("Continue");return o&&o.destroy(),e()}};if(!t.viewComponent.game.cache.checkImageKey("Continue"))return e();var o=t.viewComponent.game.add.image(0,0,"Continue");o.name="Continue",o.x=(t.viewComponent.game.world.width-o.width)/2,o.y=flashvars.vertical?(t.viewComponent.game.world.height-o.height)/2:t.viewComponent.game.world.height-30,t.viewComponent.game.input.onDown.addOnce(a)})},function(e){return t.viewComponent.addLog("用户配置解析错误:"+e),Promise.reject(e||"解析Json错误")}))}).then(function(){t.sceneProxy.updateAccInfo(!1,!0),m["default"].sendStatistics()},function(e){return Promise.reject(e)}).then(function(){return null},function(e){flashvars.client&&""!==flashvars.client?c["default"].warn(e+"关闭播放器吗？").then(function(){window.location.href="lzj3000://quit"},function(){return null}):c["default"].warn(e+"，返回闪艺首页吗？").then(function(){return window.location.href="http:\\\\www.3000.com"},function(){return null})});break;case diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS:this.assetsLoaderStart(diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE);break;case diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE:this.viewComponent.destroyLogo();var a=this.sceneProxy.json_data;this.sceneProxy.initContext();var o=this.sceneProxy.json_data.template.json.sound;this.viewComponent.game.load.cache.checkSoundKey(o.url)&&(this.sceneProxy.btn_sound=this.viewComponent.game.add.sound(o.url,o.volume)),this.showGuideTip(0).then(function(){if(a.logo&&!a.logo.background.hidden)t.sceneProxy.showLogo();else if(a.cover.hidden){var e=t.sceneProxy.findFirstChapter(),n=e.downloadUuid?e.downloadUuid:e.uuid;if(e.md5&&0===e.plots.length){if(t.sceneProxy.isWapOther()){var o=function(n){null===n?c["default"].error("获取付费章节信息失败"):"fail"===n?c["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,b["default"])("819786897",{debug:!1,message:"复制成功"})},function(){}):(e.plots=n?n:[],t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,e))};return void t.sceneProxy.unlockChapterByWapOther(n,e.charge,e.md5,o)}if(!e.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)t.sceneProxy.checkIfChapterFree(n,e.md5).then(function(n){var a;(a=e.plots).push.apply(a,r(n)),t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,e)},function(e){-1===e.indexOf("code=87")?c["default"].error(e):"zxwwap"===flashvars.wap?c["default"].info("当前为收费章节，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid}):c["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var i=function(a){a?t.sceneProxy.checkIfChapterFree(n,e.md5).then(function(n){var a;t.sceneProxy.unlockChapterCallBack=null,(a=e.plots).push.apply(a,r(n)),t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,e)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():c["default"].error("获取付费章节信息失败")}):c["default"].error("章节解锁失败")};t.sceneProxy.unlockChapter(n,e.charge,e.md5,i)}}else t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,e)}else t.sceneProxy.showCover()});break;case diygamePlayer.AppConstants.SCENE_LOADING_BEGIN:break;case diygamePlayer.AppConstants.SCENE_LOADING_PROGRESS:break;case diygamePlayer.AppConstants.SCENE_LOADING_COMPLETE:break;case diygamePlayer.AppConstants.SCENE_SHOW_LOGO:this.showLogo();break;case diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY:this.assetsLoaderStart(diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED,n);break;case diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED:this.showPlot(n.context,this.sceneProxy.curChapter,this.sceneProxy.curPlotIndex,this.sceneProxy.cmdPlotSnap,n.loadData);break;case diygamePlayer.AppConstants.SCENE_DESTROY_VIEW:this.destroyView(n.name,n.isMainMenu);break;case diygamePlayer.AppConstants.SCENE_SHOW_GUIDE:this.showGuideTip(n.id);break;case diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW:this.showInputView(this.sceneProxy.plotViewsLayer,!!n)}},addKeyBoardZ:function(){var e=this;null===this.sceneProxy.z_key&&(this.sceneProxy.z_key=this.viewComponent.game.input.keyboard.addKey(Phaser.Keyboard.Z),this.sceneProxy.z_key.onDown.add(function(){e.sceneProxy.quickPlay=!0}),this.sceneProxy.z_key.onUp.add(function(){e.sceneProxy.quickPlay=!1}))},removeKeyBoardZ:function(){this.viewComponent.game.input.keyboard.removeKey(Phaser.Keyboard.Z),this.sceneProxy.z_key=null},generateLayers:function(){this.sceneProxy.coverLayer=this.viewComponent.game.add.group(),this.sceneProxy.coverLayer.name="coverLayer",this.sceneProxy.progressLayer=this.viewComponent.game.add.group(),this.sceneProxy.progressLayer.name="progressLayer",this.sceneProxy.dialogLayer=this.viewComponent.game.add.group(),this.sceneProxy.dialogLayer.name="dialogLayer",this.sceneProxy.dialogLayer.animateTweens=[],this.sceneProxy.menuLayer=this.viewComponent.game.add.group(),this.sceneProxy.menuLayer.name="menuLayer",this.sceneProxy.mainMenuLayer=this.viewComponent.game.add.group(),this.sceneProxy.mainMenuLayer.name="mainMenuLayer",this.sceneProxy.mainMenuLayer.visible=!1,this.sceneProxy.settingsLayer=this.viewComponent.game.add.group(),this.sceneProxy.settingsLayer.name="settingsLayer",this.sceneProxy.settingsLayer.visible=!1,this.sceneProxy.recordLayer=this.viewComponent.game.add.group(),this.sceneProxy.recordLayer.name="recordLayer",this.sceneProxy.recordLayer.visible=!1,this.sceneProxy.playBackLayer=this.viewComponent.game.add.group(),this.sceneProxy.playBackLayer.name="playBackLayer",this.sceneProxy.playBackLayer.visible=!1,this.sceneProxy.weatherLayer=this.viewComponent.game.add.group(),this.sceneProxy.weatherLayer.name="weatherLayer",this.sceneProxy.plotViewsLayer=this.viewComponent.game.add.group(),this.sceneProxy.plotViewsLayer.name="plotViewsLayer",this.sceneProxy.endLayer=this.viewComponent.game.add.group(),this.sceneProxy.endLayer.name="endLayer",this.sceneProxy.toastLayer=this.viewComponent.game.add.group(),this.sceneProxy.toastLayer.name="toastLayer",this.sceneProxy.loadingToastLayer=this.viewComponent.game.add.group(),this.sceneProxy.loadingToastLayer.name="loadToastLayer",this.sceneProxy.quickPlayLayer=this.viewComponent.game.add.group(),this.sceneProxy.quickPlayLayer.name="quickPlayLayer",this.sceneProxy.guideLayer=this.viewComponent.game.add.group(),this.sceneProxy.guideLayer.name="guideLayer",this.sceneProxy.bubbleLayer=this.viewComponent.game.add.group(),this.sceneProxy.bubbleLayer.name="bubbleLayer",this.sceneProxy.bubbleLayer.animateTweens=[]},screenCaptured:function(){var e=this;if(this.sceneProxy.isGameStarted&&this.sceneProxy.isQuickPlay===!0){if(0===this.sceneProxy.quickPlayLayer.children.length){var t=this.sceneProxy.quickPlayLayer.create(0,0,"app_button_speed"),n=this.sceneProxy.quickPlayLayer.create(0,0,"app_icon_speed"),a={font:"25px PingFang-SC-Regular",fill:"#333333"},o=this.viewComponent.game.add.text(0,0,"快进中...",a,this.sceneProxy.quickPlayLayer),r={font:"20px PingFang-SC-Regular",fill:"#aaadb3"},i=this.viewComponent.game.add.text(0,0,"松开手指恢复播放",r,this.sceneProxy.quickPlayLayer);t.x=(this.viewComponent.game.world.width-t.width)/2,t.y=(this.viewComponent.game.world.height-t.height)/2,n.x=t.x+90,n.y=t.y+25,o.x=n.x-10,o.y=n.y+n.height+14,i.x=t.x+39,i.y=o.y+33}this.sceneProxy.isScreenHold=!0,this.sceneProxy.quickPlay=!0,this.sceneProxy.removePlotTweens();var s=function l(){var t=e.sceneProxy,n=e.viewComponent.game;return function(){var e=t.plotViewsLayer.children.length>0;if(!e&&t.playPause!==!0){var a=new Phaser.Pointer(n,1,Phaser.PointerMode.CURSOR);a.button=0,t.curPlotLayer.onChildInputDown.dispatch("quickPlayHandler",a)}t.isScreenHold&&setTimeout(l(),500)}};setTimeout(s(),20),this.sceneProxy.quickPlayLayer.alpha=1,this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)}},screenReleased:function(){this.sceneProxy.isScreenHold&&(this.sceneProxy.isScreenHold=!1,this.sceneProxy.quickPlay=!1,this.sceneProxy.quickPlayLayer.alpha=0)},cmdPlotLoadResources:function(e,t,n,a,o){var i=this,s=this.viewComponent.game.load,l=s.cache,u=a.commands[o],c=f.ResourcesManager.getCommandResources(u),d="ios"===flashvars.client&&flashvars.app_version>="1.5.0",h=0,m=[];c.forEach(function(e){var t=e.type,n=e.url;if(n){if("audio"===t&&d)return void(!y["default"].isAudioInCache(n)&&h++);var a="img"===t?l.checkImageKey(n):l.checkSoundKey(n);a||(h++,a=s.getAsset("img"===t?"image":"audio",n),a&&m.push({type:t,key:n}))}});var p=0,g=[],v=function x(e){for(var t=0;t<e.length&&p<5;t++){var n=e[t],a=f.ResourcesManager.getCommandResources(n);
if(a.length&&(g.push.apply(g,r(a)),p++),"options"===n.type||"conditionOptions"===n.type)for(var o=0;o<n.args.length&&p<5;o++)x(n.args[o].commands)}};return f.ResourcesManager.clearPreCmdResources(a.commands,o),h!==m.length?this.sceneProxy.preloadCommandsAssets(e,t,n,a,o).then(function(e){return i.assetsLoader(e,!0,!0)}):h?(v(a.commands.slice(o)),m=g.filter(function(e){var t=e.type,n=e.url;return s.getAsset("img"===t?"image":"audio",n)}).map(function(e){return Object.assign(e,{key:e.url})}),this.assetsLoader(m,!0)):Promise.resolve()},showGuideTip:function(e){var t=this;return flashvars.single&&"1"===flashvars.offline?Promise.resolve():new Promise(function(n,a){if("android"!==flashvars.client&&"ios"!==flashvars.client)return t.sceneProxy.isShowGuide=!1,t.sceneProxy.guideLayer.visible=!1,n();var o=function(e){if(t.sceneProxy.isShowGuide===!0){var a=t.sceneProxy.guideLayer.getByName("Operation_tip"),o=t.sceneProxy.guideLayer.getByName("Cloud_record_tip");if(t.sceneProxy.guideLayer.children.length<=0){if(t.sceneProxy.guideLayer.inputEnableChildren=!0,t.sceneProxy.guideLayer.inputEnabled=!0,!t.viewComponent.game.load.cache.checkImageKey("Operation_tip")&&0===e||!t.viewComponent.game.load.cache.checkImageKey("Cloud_record_tip")&&1===e)return n();a=t.sceneProxy.guideLayer.create(t.viewComponent.game.world.width/2,t.viewComponent.game.world.height/2,"Operation_tip"),a.name="Operation_tip",a.anchor.setTo(.5,.5),a.visible=!1,o=t.sceneProxy.guideLayer.create(t.viewComponent.game.world.width/2,t.viewComponent.game.world.height/2,"Cloud_record_tip"),o.name="Cloud_record_tip",o.anchor.setTo(.5,.5),o.visible=!1}t.sceneProxy.guideLayer.alpha=1,t.sceneProxy.guideLayer.visible=!0,a.visible=0===e,o.visible=0!==e,t.viewComponent.game.world.bringToTop(t.sceneProxy.guideLayer);var i=function s(a,o){o&&o.pointerMode===Phaser.PointerMode.CURSOR&&0!==o.button||(t.sceneProxy.guideLayer.onChildInputDown.remove(s),t.tweenToPromise(t.sceneProxy.guideLayer,{alpha:0},1e3,null,!0,0,0,!1).then(function(){return t.sceneProxy.guideLayer.visible=!1,t.sceneProxy.guideLayer.alpha=0,0!==e&&(t.sceneProxy.isShowGuide=!1),m["default"].localStorageSetItem(r,JSON.stringify({count:t.sceneProxy.recordTipCount})),n()}))};t.sceneProxy.guideLayer.onChildInputDown.add(i)}},r="shanyi3000guide",i=JSON.parse(m["default"].localStorageGetItem(r));if(null!==i&&void 0!==i){if(t.sceneProxy.recordTipCount=i.count,1===e){if(t.sceneProxy.recordTipCount>=10)return t.sceneProxy.isShowGuide=!1,t.sceneProxy.guideLayer.visible=!1,n();t.sceneProxy.recordTipCount++,console.log("引导层次数："+t.sceneProxy.recordTipCount),o(e)}else if(0===e)return t.sceneProxy.guideLayer.visible=!1,n()}else t.sceneProxy.isShowGuide=!0,o(e)})},addLoadingToastLayer:function(){if(0===this.sceneProxy.loadingToastLayer.children.length){var e=this.viewComponent.game.add.group();this.sceneProxy.loadingToastLayer.add(e);var t=this.viewComponent.game.add.graphics(0,0,e);t.beginFill(4048076),t.drawRect(0,0,135,36),t.endFill();var n=e.create(8,9,"toast_loading");this.viewComponent.addGifAnimation(n,"toast_loading");var a={font:"16px 微软雅黑",fill:"#ffffff"},o=this.viewComponent.game.add.text(33,8,"保存档案中~",a,e);o.name="toastText",e.x=(this.viewComponent.game.world.width-o.width)/2,e.y=flashvars.vertical?100:252,e.alpha=.8,this.sceneProxy.loadingToastLayer.visible=!1}},addToastLayer:function(){if(0===this.sceneProxy.toastLayer.children.length){var e=this.viewComponent.game.add.group(),t=this.viewComponent.game.add.group();e.name="typeSuccess",t.name="typeError",this.sceneProxy.toastLayer.add(e),this.sceneProxy.toastLayer.add(t);var n=this.viewComponent.game.add.graphics(0,0,e),a=this.viewComponent.game.add.graphics(0,0,t);n.beginFill(4048076),n.drawRect(0,0,320,36),n.endFill(),a.beginFill(4048076),a.drawRect(0,0,260,36),a.endFill(),e.create(10,10,"icon_success"),t.create(10,10,"icon_error");var o={font:"16px 微软雅黑",fill:"#ffffff"},r=this.viewComponent.game.add.text(30,8,"存档成功，下次可以从这里读档继续哦~",o,e);r.name="toastText",r=this.viewComponent.game.add.text(30,8,"存档失败，请检查您的网络哦~",o,t),r.name="toastText",e.visible=!1,t.visible=!1,this.sceneProxy.toastLayer.alpha=0}},assetsLoaderStart:function(e,t){var n=this,a=t||{},o=a.needLoadList,r=void 0===o?[]:o;return t||this.viewComponent.preLoadWeatherAssets(),this.assetsLoader(r,!!t).then(function(){return n.sceneProxy.sendNotification(e,t)})},assetsLoader:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=Object.create(null),r=[],i=this.viewComponent.game,s=0,l=i.load,u=i.sound,c=i.cache,d="ios"===flashvars.client&&"1.5.0"<=flashvars.app_version;e=e.filter(function(e){var t=e.type,n=e.key;return"img"===t?!c.checkImageKey(n)&&l.getAsset("image",n):"audio"===t?d?!y["default"].isAudioInCache(n)&&y["default"].isLoadingAudio(n):!c.checkSoundKey(n)&&l.getAsset("audio",n):void 0});var h="";!n&&this.sceneProxy.json_data.cover.music&&this.sceneProxy.json_data.cover.music.url&&d&&""===flashvars.offline&&(h=this.sceneProxy.json_data.cover.music.url,y["default"].isAudioInCache(h)||y["default"].isAudioError(h)?h="":l._totalFileCount+=1);var f=n?e.length:l._totalFileCount,m=!1;return f?new Promise(function(i,p){var g=""===h,v=function(t){e.length?e.forEach(function(e){e.key===t&&e&&!e.loaded&&(e.loaded=!0,s++)}):s++},x=function(){var a=d?""===h||n?e.every(function(e){return e.loaded}):g:r.every(function(e){return e.decoded});m&&a&&(y["default"].audioCountLoadByPhone.total=0,y["default"].audioCountLoadByPhone.loaded=0,u.onSoundDecode.removeAll(o),u.onSoundDecodeError.removeAll(o),l.onSoundExtendLoad.removeAll(o),l.onSoundExtendLoadError.removeAll(o),t.sceneProxy.progressLayer.visible=!1,i()),l.onFileComplete.removeAll(o)},P=function(o){if(""!==h&&!n){if(o!==h)return;g=!0}if(!e.every(function(e){return e.loaded})||m!==!0||""!==h){v(o);var r=parseInt(100*s/f);a&&t.showProgress(r,s,f,n),e.every(function(e){return e.loaded})&&(m=!0)&&x()}},w=function(e){var t=-1,n=c.getSound(e);(t=r.findIndex(function(e){return e===n}))!==-1&&(r.splice(t,1),c.removeSound(e)),x()};u.onSoundDecode.add(function(){return x()},o),u.onSoundDecodeError.add(w,o),l.onSoundExtendLoad.add(P,o),l.onSoundExtendLoadError.add(P,o),l.onFileComplete.add(function(o,i,l,u,d){if(v(i),o=parseInt(100*s/f),a&&t.showProgress(o,s,f,n),c.checkKey(Phaser.Cache.SOUND,i)){var h=c.getSound(i);h&&h.autoDecode&&h.isDecoding&&!h.decoded&&r.push(h)}e.length&&e.every(function(e){return e.loaded})&&(m=!0,x())},o,0),l.onLoadComplete.addOnce(function(){m||(m=!0,x())},o,0),f&&t.showProgress(0,0,0,n),l.start()}):Promise.resolve()},showLogo:function(){var e=this,t=this.sceneProxy,n=t.json_data,a=t.context,o=n.logo,i=(n.chapters,n.cover);if(o&&o.background&&!o.background.hidden&&this.viewComponent.game.load.cache.checkImageKey(o.background.url)){var s=o.background,l=s.flex,u=s.opacity;this.sceneProxy.prePlotBkKey=this.sceneProxy.lstPlotBkKey,this.sceneProxy.lstPlotBkKey=o.background.url,this.sceneProxy.lstPlotBkOpacity=o.background.opacity,this.sceneProxy.lstPlotBkFlex=l;var d=this.viewComponent.game.add.image(0,0,o.background.url);this.backgroundFlex(d,l),d.bringToTop(),d.alpha=0,this.tweenToPromise(d,{alpha:u},1e3,null,!0,0).then(function(){return m["default"].timeout(1e3)}).then(function(){return e.tweenToPromise(d,{alpha:0},1e3,null,!0,0).then(function(){if(i.hidden){var t=e.sceneProxy.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length){if(e.sceneProxy.isWapOther()){var o=function(n){null===n?c["default"].error("获取付费章节信息失败"):"fail"===n?c["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,b["default"])("819786897",{debug:!1,message:"复制成功"})},function(){}):(t.plots=n?n:[],e.sceneProxy.preloadChapterAssets(e.sceneProxy.context,t))};return void e.sceneProxy.unlockChapterByWapOther(n,t.charge,t.md5,o)}if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)e.sceneProxy.checkIfChapterFree(n,t.md5).then(function(n){var o;(o=t.plots).push.apply(o,r(n)),e.sceneProxy.preloadChapterAssets(a,t)},function(e){-1===e.indexOf("code=87")?c["default"].error(e):"zxwwap"===flashvars.wap?c["default"].info("当前为收费章节，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid}):c["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var s=function(o){o?e.sceneProxy.checkIfChapterFree(n,t.md5).then(function(n){var o;e.sceneProxy.unlockChapterCallBack=null,(o=t.plots).push.apply(o,r(n)),e.sceneProxy.preloadChapterAssets(a,t)},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():c["default"].error("获取付费章节信息失败")}):c["default"].error("章节解锁失败")};e.sceneProxy.unlockChapter(n,t.charge,t.md5,s)}}else e.sceneProxy.preloadChapterAssets(a,t)}else e.sceneProxy.showCover()})})}},showProgress:function(e,t,n,a){var o=this.sceneProxy.progressLayer.getByName("background"),r=this.sceneProxy.progressLayer.getByName("type0"),i=this.sceneProxy.progressLayer.getByName("type1"),s=this.viewComponent.game.world.width,l=this.viewComponent.game.world.height;if(o||(o=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.progressLayer),o.beginFill(0),o.drawRect(0,0,s,l),o.endFill(),o.name="background",o.inputEnabled=!0),a){o.alpha=.5,i||(i=this.viewComponent.game.add.group(),i.name="type1",this.sceneProxy.progressLayer.add(i));var u=i.getByName("progressText");if(!u){var c={font:"24px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle"};u=this.viewComponent.game.add.text(0,0,"",c,i),u.name="progressText",u.setTextBounds(s/2-90,l/2-20,180,30)}u.text="加载中..."+e+"%",r&&(r.visible=!1),i&&(i.visible=!0),this.sceneProxy.progressLayer.bringToTop(i)}else{o.alpha=0,r||(r=this.viewComponent.game.add.group(),r.name="type0",this.sceneProxy.progressLayer.add(r));var d=r.getByName("progressText"),h=r.getByName("tipText"),f=(r.getByName("progressBar"),r.getByName("tipLight"));if(!d){var m={font:"18px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle",align:"center",wordWrap:!0};d=this.viewComponent.game.add.text(0,0,"",m,r),d.name="progressText",d.setTextBounds(28,flashvars.vertical?l/2+50:390,s-25,18)}var p="小贴士："+this.sceneProxy.progressTips[Math.floor(Math.random()*this.sceneProxy.progressTips.length)];if(flashvars.vertical&&p.length>22){var y=p.split("");y.splice(20,0,"\n"),p=y.join("").toString()}flashvars.single&&"1"===flashvars.offline&&(d.visible=!1),""==d.text&&(d.text=p),f||(f=this.viewComponent.game.add.image((s-d.width-28)/2,flashvars.vertical?p.length>22?l/2+33:l/2+46:385,"light",0,r),f.name="tipLight"),flashvars.single&&"1"===flashvars.offline&&(f.visible=!1),h||(h=this.viewComponent.game.add.text(0,0,"",{font:"28px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle"},r),h.anchor.set(.3,.5),h.name="tipText"),h.visible=e>0,h.setTextBounds(s/2,flashvars.vertical?l/2+20:350,40,22),h.text=e+"%",r&&(r.visible=!0),i&&(i.visible=!1),this.sceneProxy.progressLayer.bringToTop(r)}this.sceneProxy.progressLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.sceneProxy.progressLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},addDialogLayer:function(){var e=this.sceneProxy.json_data.template.json.dialog,t=e.background,n=e.rect,a=e.avatarContainer,o=e.titleContainer,r=e.content;if(0===this.sceneProxy.dialogLayer.children.length){var i=void 0,s=void 0,l=void 0;if(this.viewComponent.game.load.cache.checkImageKey(t.url)){var u=this.sceneProxy.dialogLayer.create(0,0,t.url);u.width=n.width,u.height=n.height,u.name="dialog_bk"}if(i=o.rect.x,s=o.rect.y,this.viewComponent.game.load.cache.checkImageKey(o.background.url)){var c=this.sceneProxy.dialogLayer.create(i,s,o.background.url);c.width=o.rect.width,c.height=o.rect.height,c.name="dialog_bk_title"}var d=void 0;i=o.rect.x+o.title.rect.x,s=o.rect.y+o.title.rect.y,d=this.viewComponent.game.add.text(0,0,"",{fill:"#fff"},this.sceneProxy.dialogLayer),d.name="dialog_text_title",d.setTextBounds(i+(o.title.rect.width-o.rect.width)/2,s,o.rect.width,o.rect.height),this.viewComponent.game.load.cache.checkImageKey(a.background.url)&&(i=a.rect.x,s=a.rect.y,l=this.sceneProxy.dialogLayer.create(i,s,a.background.url),l.width=a.rect.width,l.height=a.rect.height,l.name="dialog_bk_avatar"),i=a.rect.x+a.avatar.x,s=a.rect.y+a.avatar.y;var f=this.sceneProxy.dialogLayer.create(i,s);f.name="dialog_avatar",f.width=a.avatar.width,f.height=a.avatar.height,d=this.viewComponent.game.add.text(r.rect.x,r.rect.y,"",{fill:"#fff",boundsAlignH:"left",boundsAlignV:"top",wordWrap:!0,wordWrapWidth:r.rect.width},this.sceneProxy.dialogLayer),d.name="dialog_text_content",d.useAdvancedWrap=!0,d.updateText=h["default"].updateText,d.advancedWordWrap=h["default"].advancedWordWrap}this.sceneProxy.dialogLayer.x=n.x,this.sceneProxy.dialogLayer.y=n.y,this.sceneProxy.dialogLayer.alpha=1,this.sceneProxy.dialogLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.sceneProxy.dialogLayer),this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},addMenuLayer:function(e){var t=this;if(0===this.sceneProxy.menuLayer.children.length){var n=this.sceneProxy.json_data.template.json.menu,a=n.rect,o=n.normal,r=n.active,i=function(e,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("menu_button"===e.parent.name?t.sceneProxy.onMenuBtnClicked():"shanyi_menu_button"===e.parent.name?t.sceneProxy.onSyMenuBtnClicked():"menu_button_more"===e.parent.name&&t.sceneProxy.onMenuBtnMoreClicked())},s={};s.normal=o.text,s.active=r.text,s.text="菜单";var l=this.viewComponent.addButton(e?a.x:0,e?a.y:0,a.width,a.height,o.background.url,r.background.url,i,s,this.sceneProxy.btn_sound,"menu_button",this.sceneProxy.menuLayer);if(flashvars.single&&"1"===flashvars.offline)l.x=flashvars.vertical?442:866,l.y=26,"android"===flashvars.client&&this.viewComponent.addButton(flashvars.vertical?450:874,100,56,56,"menuMore","menuMoreHover",i,s,this.sceneProxy.btn_sound,"menu_button_more",this.sceneProxy.menuLayer);else if(this.sceneProxy.json_data.template.json.shanyiMenu){var u=this.sceneProxy.json_data.template.json.shanyiMenu,c=u.rect,d=u.normal,h=u.active;s.normal=d.text,s.active=h.text,s.text="闪艺",this.viewComponent.addButton(c.x,c.y,c.width,c.height,"wap"===flashvars.client?"wapback":d.background.url,"wap"===flashvars.client?"wapback":h.background.url,i,"wap"===flashvars.client?"":s,this.sceneProxy.btn_sound,"shanyi_menu_button",this.sceneProxy.menuLayer)}else"wap"===flashvars.client&&this.viewComponent.addButton(flashvars.vertical?442:886,flashvars.client?30:26,68,68,"wapback","wapback",i,"",this.sceneProxy.btn_sound,"shanyi_menu_button",this.sceneProxy.menuLayer)}this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.menuLayer.visible=!0},doEffectsAnimation:function(e){var t=function n(t){m["default"].timeout(40).then(function(){if(0!==e.children.length){if(!e.visible)return void n(t);0===t?e.children[e.children.length-1].visible=!1:e.children[t-1].visible=!1,e.children[t].visible=!0,n(++t%e.children.length)}})};t(0)},addRainEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("rain");if(!e){e=this.viewComponent.game.add.group(),e.name="rain",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<50;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("rain")+"/xiayu_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addSnowEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("snow");if(!e){e=this.viewComponent.game.add.group(),e.name="snow",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<120;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("snow")+"/xuehua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addWindEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("wind");if(!e)if(e=this.viewComponent.game.add.group(),e.name="wind",this.sceneProxy.weatherLayer.add(e),flashvars.vertical){for(var t=[],n=0;n<20;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("wind")+"/feng_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}else this.viewComponent.game.add.tileSprite(0,0,960,540,"wind",1,e).autoScroll(-360,0);this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addFallingLeavesEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("fallingLeaves");if(!e){e=this.viewComponent.game.add.group(),e.name="fallingLeaves",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addBeachBlossomEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("beachBlossom");if(!e){e=this.viewComponent.game.add.group(),e.name="beachBlossom",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("beachBlossom")+"/taohua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addBlossomEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("blossom");if(!e){e=this.viewComponent.game.add.group(),e.name="blossom",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("blossom")+"/yinghua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addLightningEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("lightning");if(!e){e=this.viewComponent.game.add.group(),e.name="lightning",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<50;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("lightning")+"/shandian_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},registerViewKey:function(e,t,n){var a=this,o=this.sceneProxy.json_data.viewMap,r=function(e){for(var t in e)"onKeyUp"===e[t].type&&(a.viewComponent.game.input.keyboard.removeKey(e[t].keyCode),n[e[t].keyCode]=a.viewComponent.game.input.keyboard.addKey(e[t].keyCode))},i=function s(e){r(o[e].events);for(var t in o[e].children)s(o[e].children[t].ref),r(o[e].children[t].events)};i(e),r(t)},removeViewKey:function(e){for(var t in e)this.viewComponent.game.input.keyboard.removeKey(t),e.splice(t,1)},removeViewKeyByInstance:function(e,t){var n=this,a=this.sceneProxy.json_data.viewMap,o=function(e){for(var a in e)"onKeyUp"===e[a].type&&(n.viewComponent.game.input.keyboard.removeKey(e[a].keyCode),t.splice(e[a].keyCode,1))},r=function i(e){e.name&&a[e.name]&&o(a[e.name].events);for(var t in e.children)i(e.children[t])};r(e)},addGlobalView:function(e){if(!this.sceneProxy.globalViews){this.sceneProxy.globalViews=[],this.sceneProxy.globalViewKeys=[];var t=this.sceneProxy.json_data.views;for(var n in t)this.registerViewKey(t[n].ref,t[n].events,this.sceneProxy.globalViewKeys),this.sceneProxy.globalViews[n]=this.addView(null,t[n].ref,t[n].instanceUuid,t[n].x,t[n].y,t[n].events),this.sceneProxy.globalViews[n].isGlobal=!0,t[n].scale&&(this.sceneProxy.globalViews[n].scale.set(t[n].scale,t[n].scale),this.sceneProxy.globalViews[n].x+=t[n].x.value*(1-t[n].scale),this.sceneProxy.globalViews[n].y+=t[n].y.value*(1-t[n].scale),this.scaleInputView(this.sceneProxy.globalViews[n],t[n].scale));this.uiOnLoadInvoker()}for(var a in this.sceneProxy.globalViews)e[this.sceneProxy.globalViews[a].name]?(this.sceneProxy.globalViews[a].visible=!1,this.showInputView(this.sceneProxy.globalViews[a],!1)):(this.sceneProxy.globalViews[a].visible=!0,this.showInputView(this.sceneProxy.globalViews[a],!0),this.viewComponent.game.world.bringToTop(this.sceneProxy.globalViews[a]));this.closePlayAdButton()},addView:function(e,t,n,a,o,s){var u=arguments.length>6&&void 0!==arguments[6]&&arguments[6],d=this,f=arguments.length>7&&void 0!==arguments[7]&&arguments[7],p=arguments.length>8&&void 0!==arguments[8]&&arguments[8];if(!t)return!1;var g=!0,w=this.sceneProxy.json_data.viewMap[t];if(!w)return null;var b=this.viewComponent.game.add.group();b.name=t,b.instanceUuid=n,b.xInfo=a,b.yInfo=o,b.eventsInfo=s,b.inputEnableChildren=!0,b.viewInfoName=w.name,e&&e.add(b);var k=this.sceneProxy,C=k.Expression,_=k.curChapter,S=k.uiOnLoadQueue,I=this.sceneProxy.context,L=C.safeEval(a,I),E=C.safeEval(o,I),T=function(){p&&(d.sceneProxy.mainMenuLayer.children.length>0&&d.sceneProxy.json_data.default_settings.mainMenu&&d.sceneProxy.mainMenuLayer.removeAll(!0),d.sceneProxy.onResume())},M=function(t,n,a,o){var r=(arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5&&void 0!==arguments[5]&&arguments[5]),i=0,s=function(s){return new Promise(function(l,u){if("jump"===s.type)return d.sceneProxy.isGettingNext||(d.sceneProxy.uiOnLoadQueue=[],d.sceneProxy.mainMenuLayer.visible&&d.sceneProxy.onMainMenuBackBtnClicked(),d.sceneProxy.context=JSON.parse(JSON.stringify(I)),d.showNextPlot(d.sceneProxy.context,d.sceneProxy.curChapter,d.sceneProxy.curPlotIndex,s.type,s.handle.uuid)),l(!1);if("playMusic"===s.type)return(d.viewComponent.game.load.cache.checkSoundKey(s.handle.music.url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&(d.sceneProxy.stopMusic(s.handle.music.url,!0),d.sceneProxy.playMusic(s.handle.music.url,s.handle.music.volume,!0,!0)),l(!0);if("stopMusic"===s.type)return d.sceneProxy.stopMusic(null,!0),l(!0);if("playSound"===s.type){for(var h=0;h<s.handle.sounds.length;h++)if(s.handle.sounds[h]){var f=s.handle.sounds[h]?s.handle.sounds[h].url:"";if("inherit"===f)continue;if(d.viewComponent.game.load.cache.checkSoundKey(f)){var g="inherit"===s.handle.sounds[h].volume?d.sceneProxy.plotSounds[h].volume:s.handle.sounds[h].volume;d.sceneProxy.stopSound(h,f,!0),d.sceneProxy.playSound(h,f,g,!s.handle.sounds[h].time,!0)}else if("ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var v="inherit"===s.handle.sounds[h].volume?y["default"].soundsInfo[h].volume:s.handle.sounds[h].volume;d.sceneProxy.stopSound(h,f,!0),d.sceneProxy.playSound(h,f,v,!s.handle.sounds[h].time,!0)}else d.sceneProxy.stopSound(h)}return l(!0)}if("stopSound"===s.type)return d.sceneProxy.stopSound(-1,null,!0),l(!0);if("callUI"===s.type){if("save-record"===s.handle.id&&"system"===s.handle.type){var w=d.sceneProxy.context.disableSaveOrLoad;return w&&w.save?(d.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用存档"),l(!1)):(!d.sceneProxy.mainMenuLayer.visible&&d.sceneProxy.getSnap(),d.sceneProxy.showSave(),l(!1))}if("load-record"===s.handle.id&&"system"===s.handle.type){var b=d.sceneProxy.context.disableSaveOrLoad;return b&&b.load?(d.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用读档"),l(!1)):(d.sceneProxy.showLoad(),l(!1))}if("playback"===s.handle.id&&"system"===s.handle.type)return d.sceneProxy.showPlayback(),l(!1);if("settings"===s.handle.id&&"system"===s.handle.type)return d.sceneProxy.showSettings(d.sceneProxy.context),l(!1);if(s.handle.uuid){for(var k=Object.assign({},s.handle.position.x),L=Object.assign({},s.handle.position.y),E=s.handle.count?C.safeEval(s.handle.count,d.sceneProxy.context):1,M=0;M<E;M++){d.registerViewKey(s.handle.uuid,[],d.sceneProxy.plotViewKeys);var O=d.addView(e,s.handle.uuid,"",k,L,{},!1,!1,p);O&&(e?"plotViewsLayer"===e.name?d.sceneProxy.plotViews.push(O):e.xInfo&&e.yInfo&&(O.x+=C.safeEval(e.xInfo,d.sceneProxy.context),O.y+=C.safeEval(e.yInfo,d.sceneProxy.context)):(O.isGlobal=!0,d.sceneProxy.globalViews.push(O)),e&&e.parent&&"mainMenuLayer"===e.parent.name||d.sceneProxy.mainMenuLayer.visible||d.viewComponent.game.world.bringToTop(d.sceneProxy.menuLayer),"onLoad"!==a&&d.uiOnLoadInvoker())}return d.closePlayAdButton(),l(!0)}}else{if("refreshUI"===s.type){d.refreshView(s.handle.uuid);return l(!0)}if("reload"===s.type){var A=d.refreshView(s.handle.uuid,!0);if(s.handle.uuid===e.name)for(var V=0;V<A.length;V++)if(A[V].name===e.name){e=A[V];break}d.uiOnLoadInvoker().then(function(){return l(!0)})}else{if("closeUI"===s.type){var B=s.handle.uuid,N=t,j=!1,R=function(e){for(N=N&&N.parent;;){if(!N)break;if(N.viewType)return e&&(N.name+="_1"),N.name;N=N.parent}};if("system"===s.handle.type&&"diyMainMenu"===s.handle.id){if(d.sceneProxy.json_data.default_settings.mainMenu){var D=d.sceneProxy.mainMenuLayer.children[1];D?(B=D.name,j=!0):(B=null,d.sceneProxy.onMainMenuBackBtnClicked(),d.sceneProxy.mainMenuLayer.removeAll(!0,!1,!0))}}else B||(t.viewType?B=t.name:(B=R(N,!0),s.isParent&&(B=R(N,!0))));if(B){var F=B.indexOf("_1")>-1,U=B.substring(0,36);if(!F)for(var W=0;W<S.length;W++)S[W].name!==U&&S[W].instanceUuid!==U||S.splice(W--,1);d.destroyView(B,j)}return l(!0)}if("back"===s.type)return T(),d.sceneProxy.uiOnLoadQueue=[],d.sceneProxy.mainMenuLayer.visible&&d.sceneProxy.onResume(),d.sceneProxy.context=JSON.parse(JSON.stringify(I)),d.showNextPlot(d.sceneProxy.context,_,d.sceneProxy.curPlotIndex,s.type),l(!1);if("nextPlot"===s.type)return T(),d.sceneProxy.uiOnLoadQueue=[],_.plots[d.sceneProxy.curPlotIndex].commands?(d.sceneProxy.optionLayer.destroy(),d.sceneProxy.cmdPlotNextPromise&&d.sceneProxy.cmdPlotNextPromise({type:""}),l(!1)):(d.sceneProxy.context=JSON.parse(JSON.stringify(I)),_.plots[d.sceneProxy.curPlotIndex].condition_options.length>0?(d.showNextPlot(d.sceneProxy.context,_,d.sceneProxy.curPlotIndex),l(!1)):(d.showNextPlot(d.sceneProxy.context,_,d.sceneProxy.curPlotIndex,s.type),l(!1)));if("jumpOption"===s.type){T(),d.sceneProxy.uiOnLoadQueue=[];var G=C.safeEval(s.handle.value,I);if(_.plots[d.sceneProxy.curPlotIndex].commands){var H=d.sceneProxy.getNextCommand(I,d.sceneProxy.curCmdInfo,-1,{eArg:G,type:"jumpOption"}),z=H.info,K=H.index;return K!==-1&&d.sceneProxy.cmdPlayHandlerFun(z,K),l(!1)}return d.showNextPlot(d.sceneProxy.context,_,d.sceneProxy.curPlotIndex,s.type,G),l(!1)}if("backOption"===s.type){T(),d.sceneProxy.uiOnLoadQueue=[];var q=C.safeEval(s.handle.value,I);if(_.plots[d.sceneProxy.curPlotIndex].commands){var J=d.sceneProxy.getNextCommand(I,d.sceneProxy.curCmdInfo,-1,{eArg:q,type:"backOption"}),$=J.info,Y=J.index;return Y!==-1&&d.sceneProxy.cmdPlayHandlerFun($,Y),l(!1)}return d.showNextPlot(d.sceneProxy.context,_,d.sceneProxy.curPlotIndex,s.type,q),l(!1)}if("insertPlot"===s.type){T(),d.sceneProxy.uiOnLoadQueue=[];var Q=new Phaser.Pointer(d.viewComponent.game,1,Phaser.PointerMode.CURSOR);return Q.button=0,d.sceneProxy.curPlotLayer.onChildInputDown.dispatch("insertPlot",Q),d.sceneProxy.removeViewTimer(d.sceneProxy.plotViewsLayer),d.sceneProxy.removeInputView(d.sceneProxy.plotViewsLayer),d.sceneProxy.plotViewsLayer.removeAll(!0),d.sceneProxy.plotViews.splice(0,d.sceneProxy.plotViews.length),d.removeViewKey(d.sceneProxy.plotViewKeys),d.showNextPlot(d.sceneProxy.context,d.sceneProxy.curChapter,d.sceneProxy.curPlotIndex,s.type,s.handle.uuid,!0),l(!1)}if("setValue"===s.type)o&&(o.paused=!0),d.sceneProxy.updatePayValue(I,s.handle.values,r,d.sceneProxy.setValueAfterPay).then(function(e){return e!==!0?l(!0):void d.sceneProxy.valueOperation(I,s.handle.values,!1,function(e){return l(!0)},d.sceneProxy.setValueAfterPay)});else if("pay"===s.type){if(d.sceneProxy.isPaying!==!1)return l(!1);if(d.sceneProxy.isPaying=!0,flashvars.single&&"1"===flashvars.offline){var X=C.safeEval(n[i].handle.price,I);if(I.systemValues[0].value>=X)return d.sceneProxy.playAdPayStatus=1,I.systemValues[0].value=I.systemValues[0].value-X,d.sceneProxy.saveAccountInfo(),d.sceneProxy.isPaying=!1,l(!0);d.sceneProxy.context.fullScreen&&d.sceneProxy.onSettingsWindowModeBtnClicked();var Z=function(e){return new Promise(function(t,n){var a=function(e){return d.sceneProxy.playAdPayStatus=-1,d.sceneProxy.playAdCallBack=null,"1"!==e&&1!==e||(I.systemValues[0].value+=1),d.sceneProxy.saveAccountInfo(),"4399"===flashvars.wap&&d.closePlayAdButton(),d.sceneProxy.isPaying=!1,t(!1)};e===!0?c["default"].custom("Info","当前闪币余额不足，观看广告可获得更多闪币哟！","提示","立即获得","取消",!1).then(function(){window.app&&"android"===flashvars.client&&(d.sceneProxy.playAdCallBack=a,o&&(o.paused=!0),window.app.playAdVideo())},function(){return d.sceneProxy.isPaying=!1,t(!1)}):"4399"===flashvars.wap&&x.H54399Api.playAd().then(function(e){e.success===!0?a(1):(c["default"].info("广告次数已用完，请明日再来！"),a(0))})})};"4399"===flashvars.wap?x.H54399Api.canPlayAd().then(function(e){e.canplay===!0?c["default"].custom("Info","当前闪币余额不足，观看广告可获得闪币哦！","提示","看广告","取消",!1).then(function(){Z(!1).then(function(e){return l(e)})},function(){return d.sceneProxy.isPaying=!1,l(!1)}):c["default"].custom("Info","当前闪币余额不足！","提示","知道了","取消",!1,0,0,!1).then(function(){return d.sceneProxy.isPaying=!1,l(!1)},function(){return d.sceneProxy.isPaying=!1,l(!1)})}):Z(!0).then(function(e){return l(e)})}else{if("zxwwap"===flashvars.wap)return c["default"].info("商城功能尚未开启，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid}),d.sceneProxy.isPaying=!1,l(!1);d.sceneProxy.getPayInfo(!0).then(function(e){if("[object String]"===Object.prototype.toString.apply(e)||""===flashvars.uid){if(e.indexOf("您还没有登录")!==-1&&""===flashvars.uid||e.indexOf("获取用户信息失败")!==-1)if("wap"===flashvars.client)window.parent&&window.parent.playLogin();else{var t=e.indexOf("(")!==-1?e.indexOf("(")+1:0,a=e.indexOf(":")!==-1?e.indexOf(":"):e.length;c["default"].error(e.substr(t,Math.floor(a-t))).then(function(){e.indexOf("您还没有登录")!==-1&&(window.location.href="lzj3000://login")})}else c["default"].info("当前网络信号差，商城、成就等账号功能无法正常使用，请检查网络设置后，重新打开作品");return d.sceneProxy.isLineUpdatePaySuccess=!1,d.sceneProxy.isPaying=!1,l(!1)}d.sceneProxy.isLineUpdatePaySuccess=!0,I.payValues=JSON.parse(JSON.stringify(d.sceneProxy.context.payValues));var o=C.safeEval(s.handle.price,I),r=n[i].handle.uuid,u=n[i].handle.count||-1,h=m["default"].generateUUID(),f=flashvars.client+h,p=-1,y=function(e){return"ios"!==flashvars.client&&"android"!==flashvars.client&&"wap"!==flashvars.client?Promise.resolve():d.sceneProxy.getPayGoodsInfo(e).then(function(e){if(e&&e.status)return"success"===e.status?u===-1||1===u&&e.count<1?Promise.resolve():Promise.reject():(c["default"].error("网络不稳定，请重试~"),Promise.resolve("retry"))},function(e){return Promise.resolve("error")})};y(r).then(function(e){if("retry"===e||"error"===e)return d.sceneProxy.isPaying=!1,l(!1);var t=JSON.parse(JSON.stringify(I)),a=function(){var e=parseInt(i)+1,a=function(e){return new Promise(function(n,a){return"setValue"!==e.type?n():void d.sceneProxy.valueOperation(t,e.handle.values,!0,function(e){return t=JSON.parse(JSON.stringify(e)),n()})})},o=function r(){return e>=n.length?Promise.resolve():a(n[e]).then(function(){return e++,r()})};return o()},s=function(){return Promise.resolve()},u=function(e){var t=p===-1?o:p;return 2===e||"2"===e?d.sceneProxy.context.systemValues[1].value-=100*t:d.sceneProxy.context.systemValues[0].value-=t,
d.sceneProxy.getAccountInfo(),d.sceneProxy.isPaying=!1,l(!0)},y=function(e){d.sceneProxy.mallPayCallback=null,d.sceneProxy.isPaying=!1,s().then(function(){if(d.sceneProxy.checkIfMallPaySuccess(f),0!==e&&"0"!==e)d.sceneProxy.setValueAfterPay=!0,d.sceneProxy.isPaySuccess=!0,u(e);else{d.sceneProxy.isPaySuccess=!1;var t=function n(e){return m["default"].timeout(e).then(function(){return d.sceneProxy.getPayInfo().then(function(e){return"[object String]"!==Object.prototype.toString.call(e)?Promise.resolve():n(1e3)})})};t(100).then(function(){return l(!1)})}})};d.sceneProxy.isWapOther()?m["default"].timeout(100).then(function(){c["default"].custom("Info","支付过程将导致作品重启。请确保您已存档。选择已存档将继续支付，未存档将前往存档界面","作品存档提示","已存档","未存档",!0).then(function(e){a().then(function(){P["default"].pay(o,r,h,d.sceneProxy.curChapter.uuid,t,1,function(){y()})})},function(e){return"cancel"===e&&d.sceneProxy.showSave(),l(!1)})}):a().then(function(){d.sceneProxy.payOperation(o,r,f,y,t).then(function(e){return p=e})})},function(e){return c["default"].info("该商品只可购买一次！"),d.sceneProxy.isPaying=!1,l(!1)})})}}else if("playad"===s.type){if(!flashvars.single||"1"!==flashvars.offline)return l(!0);var ee=function(e){return d.sceneProxy.playAdCallBack=null,"1"!==e&&1!==e||(I.systemValues[0].value+=1),d.sceneProxy.saveAccountInfo(),"4399"===flashvars.wap&&d.closePlayAdButton(),l(!0)};window.app&&"android"===flashvars.client?(d.sceneProxy.playAdCallBack=ee,o&&(o.paused=!0),window.app.playAdVideo()):"4399"===flashvars.wap&&x.H54399Api.playAd().then(function(e){e.success===!0?ee(1):(c["default"].info("广告播放失败！"+e.msg),ee(0))})}}}})},l=function u(){return i>=n.length?Promise.resolve(!0):s(n[i]).then(function(e){return e===!0?(i++,u()):Promise.resolve(!1)})};return l().then(function(e){return Promise.resolve(e)})},O=function(e,t){C.safeEval(t.expression,I)&&M(e,t.events,"onKeyUp")},A=function(e,t,n){d.sceneProxy.setValueAfterPay=!1,e.parent&&e.parent.isGlobal&&(I=d.sceneProxy.context);var a=[],o=void 0;if(o=w.events,e.viewInfoName&&"g6Hsa9WoK8"===e.viewInfoName&&(o.length>0&&"g6Hsa9WoK8"!==o[0].name||0===o.length)&&o.unshift({events:[{type:"playad",handle:{uuid:"g6Hsa9WoK8"}}],expression:{type:"playad",value:"ad"},name:"g6Hsa9WoK8",type:"onClick"}),s){var r=Object.assign([],s);r.forEach(function(e){return e.events.forEach(function(e){return e.isParent=!0})}),o=r.concat(o)}var i=function(n){if(o[n].type===t&&"onKeyUp"!=o[n].type)a[a.length]=o[n];else if(o[n].type===t&&"onKeyUp"===o[n].type){var r=o[n].keyCode,i=d.sceneProxy.plotViewKeys&&d.sceneProxy.plotViewKeys[r]?d.sceneProxy.plotViewKeys[r]:d.sceneProxy.globalViewKeys&&d.sceneProxy.globalViewKeys[r]?d.sceneProxy.globalViewKeys[r]:void 0;i&&i.onUp.add(function(){return O(e,o[n])})}};for(var l in o)i(l);var u=!0,c=function(n){var a=0,o=function r(){return d.sceneProxy.playAdPayStatus=0,a>=n.length?Promise.resolve(!1):"playad"===n[a].expression.type||"playad"!==n[a].expression.type&&C.safeEval(n[a].expression,I)?M(e,n[a].events,t,null,!1,"onStep"===t).then(function(o){return o===!0?(a++,r()):(d.sceneProxy.playAdPayStatus===-1&&flashvars.single===!0&&"1"===flashvars.offline&&n.length>1&&(d.sceneProxy.playAdPayStatus=0,M(e,n[n.length-1].events,t,null,!1,!1)),u=!1,Promise.resolve(!1))}):(a++,r())};return o()};return c(a).then(function(){return n&&n(),Promise.resolve()})},V=function(e,t){if(!(e.isHanding||d.sceneProxy.isPaying||t&&t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button)){d.sceneProxy.isInputFocus=!1,"input"===e.name&&(d.sceneProxy.isInputFocus=!0,d.removeKeyBoardZ());var n=d.sceneProxy.plotViewsLayer.children.length>0,a=d.sceneProxy.optionLayer.children.length>0;if((e.viewInfoName&&("getD30A87"===e.viewInfoName||"g3Hsa5WoK7"===e.viewInfoName)||e.parent&&("getD30A87"===e.parent.viewInfoName||"g3Hsa5WoK7"===e.parent.viewInfoName))&&(d.sceneProxy.quickPlay||I.auto)&&!n&&!a&&!d.sceneProxy.playPause)return void d.sceneProxy.showToast(0,"请先设置关闭自动播放，再使用此功能哦！");e.isHanding=!0,m["default"].timeout(200).then(function(){A(e,"onClick",function(){e.isHanding=!1})})}},B=function(e){e.events.onInputDown.add(V,d,0,e)},N=function(e){return u?Promise.resolve():A(e,"onLoad")},j=function(e){A(e,"onKeyUp")};if("button"===w.type){var R=null;w.content.sound&&w.content.sound.url&&(R=this.viewComponent.game.add.sound(w.content.sound.url,w.content.sound.volume,!1));var D=this.viewComponent.addButton(L,E,w.width,w.height,w.content.background.normal.url,w.content.background.active.url,function(e,t){return V(e.parent,t)},null,R,null,b);j(D.parent),b.viewType="BUTTON",b.onLoadBack={name:t,instanceUuid:n,object:D.parent,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:D.parent,callBack:N})}else if("image"===w.type){var F=this.viewComponent.game.add.image(L,E,w.content.background.url);F.width=w.width,F.height=w.height,b.add(F),B(F),j(F),this.viewComponent.addGifAnimation(F,w.content.background.url),b.viewType="IMAGE",F.viewInfoName=w.name,b.onLoadBack={name:t,instanceUuid:n,object:F,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:F,callBack:N})}else if("text"===w.type){var U=void 0,W={boundsAlignH:"left",boundsAlignV:"bottom",wordWrap:!0};U=w.content.font_size+"",U.indexOf("px")<0&&(U+="px"),w.content.bold===!0?U="bold "+U+" "+w.content.fontFamily:w.content.fontFamily?U=U+" "+w.content.fontFamily:this.sceneProxy.json_data.font&&(U=U+" "+this.sceneProxy.json_data.font.fontFamily),W.font=U,W.fill=w.content.color,W.wordWrapWidth=this.viewComponent.game.device.desktop?w.width:w.width+2;var G=this.viewComponent.game.add.text(L,E,"",W,b),H="";if(C.isArray(w.content.value)){if(w.content.value.forEach(function(e){return H+=C.parseValue(e.data,I)}),this.sceneProxy.addImageFontTextColors(w.content.value,G,I),v["default"].fontFamily){var z=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(w.content.font_size):w.content.font_size,K=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(w.content.font_size):w.content.font_size;this.sceneProxy.addImageFontText(w.content.value,K,z,G,I)}}else H=C.parseValue(w.content.value,I);G.inputEnabled=!0,G.input.useHandCursor=!0,G.useAdvancedWrap=!0,G.lineSpacing=this.sceneProxy.txtLineSpace(w.content.font_size),G.updateText=h["default"].updateText,G.advancedWordWrap=h["default"].advancedWordWrap,v["default"].fontFamily?(G.children.forEach(function(e){e.visible=!0}),G.text=" "):G.text=H,B(G),j(G),b.viewType="TEXT",b.onLoadBack={name:t,instanceUuid:n,object:G,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:G,callBack:N});var q=s?s:[],J=[].concat(r(w.events),r(q)).filter(function(e){return"onClick"===e.type});!J.length&&(G.inputEnabled=!1)}else if("bar"===w.type){var $=this.viewComponent.game.add.sprite(L,E,w.content.background.normal.url);$.width=w.width,$.height=w.height,b.add($),B($),this.viewComponent.addGifAnimation($,w.content.background.normal.url);var Y=this.viewComponent.game.add.sprite(L,E,w.content.background.progress.url);Y.width=w.width,Y.height=w.height,b.add(Y),B(Y),this.viewComponent.addGifAnimation(Y,w.content.background.progress.url);var Q=this.viewComponent.game.add.graphics(L,E);Q.beginFill(16777215),Q.drawRect(0,0,w.width,w.height),Q.endFill(),b.add(Q),Y.mask=Q,B(Q),j(Q);var X="",Z="";X=0===w.content.basePoint.x?"left":w.content.basePoint.x===w.width?"right":"middle",Z=0===w.content.basePoint.y?"top":w.content.basePoint.y===w.height?"bottom":"center";for(var ee=this.sceneProxy.prgsViews,te=0;te<ee.length&&(ee[te].uuid!==w.uuid||0!==ee[te].layer.children.length);te++);ee[te]={uuid:w.uuid,layer:b,type:X+"-"+Z,content:w.content},this.updateProgressView(),b.viewType="BAR",b.onLoadBack={name:t,instanceUuid:n,object:Q,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:Q,callBack:N})}else if("input"===w.type){var ne=C.safeEval(w.content.value,I),ae=new l.HtmlTextBox(this.viewComponent.game,L,E,w.width,w.height,ne,w.content.color,w.content.font_size,w.content.fontFamily?w.content.fontFamily:this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:"",w.content.bold?w.content.bold:null);"[未知数值]"===ne&&ae.setEnable(!1);var oe=function(e){var t=e,n=w.content.value.arg1,a=function(e,t,n){for(var a="",o=0;o<t.length;o++)(t[o]>="0"&&t[o]<="9"||"."===t[o]&&0!==o)&&(a+=t[o]);var r=parseFloat(a);r=r?r:0,r<-99999999999999?r=-99999999999999:r>99999999999999&&(r=99999999999999),"value"===n?d.sceneProxy.context.values[e].value=r:"savedValue"===n&&(d.sceneProxy.context.savedValues[e].value=r),ae.isValue=!0,parseFloat(a)!==r&&0!==r?ae.text=r+"":a!==t&&(ae.text=a)},o=void 0;if((o=I.values.findIndex(function(e){return e.uuid===n}))!==-1)a(o,t,"value");else if((o=I.savedValues.findIndex(function(e){return e.uuid===n}))!==-1)a(o,t,"savedValue");else if((o=I.stringValues.findIndex(function(e){return e.uuid===n}))!==-1)I.stringValues[o].value=t;else if((o=I.indexValues.findIndex(function(e){return e.uuid===n}))!==-1){var r=(void 0===I.indexValues[o].value?C.safeInitValue(I.indexValues[o],I):I.indexValues[o].value)-1;"value"===I.indexValues[o].init.type?a(r,t,"value"):"savedValue"===I.indexValues[o].init.type?a(r,t,"savedValue"):"stringValue"===I.indexValues[o].init.type&&(I.stringValues[r].value=t)}};ae.setInputCallback(oe),ae.setClickCallback(V),ae.mgrParent=b,b.inputElement=ae,j(ae),b.viewType="INPUT",b.onLoadBack={name:t,instanceUuid:n,object:ae,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ae,callBack:N})}else if("timer"===w.type){var re=this.sceneProxy,ie=this.viewComponent.game.add.image(0,0,null);b.add(ie),b.currentCount=0;var se=function(){if(re.playPause){for(var e=0;e<re.menuTimer.length;e++)if(re.menuTimer[e]===b.name)return!1;return!0}for(var t=0;t<re.menuTimer.length;t++)if(re.menuTimer[t]===b.name)return!0;return!1},le=function ye(){return function(){return se()?void(b.timerHandler=setTimeout(ye(),w.content.step.value)):void(b.currentCount++<w.content.count.value&&(A(ie,"onStep"),b.timerHandler=setTimeout(ye(),w.content.step.value)))}},ue=function(){return function(){se()||A(ie,"onStep")}};0===w.content.count.value?(b.timerHandler=setInterval(ue(),w.content.step.value),b.timerType="timeInterval"):(b.timerHandler=setTimeout(le(),w.content.step.value),b.timerType="timeOut");for(var ce=0;ce<this.sceneProxy.timerCounts.length;ce++){var de=this.sceneProxy.timerCounts[ce];if(b.name===de.name&&de.parent===e.name){b.currentCount=de.currentCount,this.sceneProxy.timerCounts.splice(ce,1);break}}this.sceneProxy.mainMenuLayer.visible&&(this.sceneProxy.menuTimer[this.sceneProxy.menuTimer.length]=t),b.viewType="TIMER",b.onLoadBack={name:t,instanceUuid:n,object:ie,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ie,callBack:N})}else if("container"===w.type){var he=null;w.content.background.url?(he=this.viewComponent.game.add.image(L,E,w.content.background.url),he.width=w.width,he.height=w.height):(he=this.viewComponent.game.add.graphics(0,0),he.beginFill(0,1),he.drawRect(L,E,w.width,w.height),he.endFill(),he.alpha=0),b.add(he),B(he),j(he),b.viewType="CONTAINER",b.onLoadBack={name:t,instanceUuid:n,object:he,callBack:N},!f&&this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:he,callBack:N});var fe=function(e){var t=d.addView(b,w.children[e].ref,w.children[e].instanceUuid,w.children[e].x,w.children[e].y,w.children[e].events,u,f,p),n=function(){if(t.x+=L,t.y+=E,w.children[e].scale&&(t.scale.set(w.children[e].scale,w.children[e].scale),t.x+=C.safeEval(w.children[e].x,I)*(1-w.children[e].scale),t.y+=C.safeEval(w.children[e].y,I)*(1-w.children[e].scale)),t.inputElement){var n=b.parent&&b.parent.xInfo?C.safeEval(b.parent.xInfo,d.sceneProxy.context)+L:L,a=b.parent&&b.parent.yInfo?C.safeEval(b.parent.yInfo,d.sceneProxy.context)+E:E;t.inputElement.x+=n,t.inputElement.y+=a,w.children[e].scale?(t.inputElement.fontSize*=w.children[e].scale,t.inputElement.width*=w.children[e].scale,t.inputElement.height=t.inputElement.fontSize):t.inputElement.update()}};return t?void n():{v:!1}};for(var me in w.children){var pe=fe(me);if("object"===("undefined"==typeof pe?"undefined":i(pe)))return pe.v}}return g?b:g},closePlayAdButton:function(){var e=this;if(flashvars.single&&"1"===flashvars.offline&&"4399"===flashvars.wap){var t=function n(t){var a="";if("getD30A87"===t.viewInfoName&&(a=t.name),(t.name&&t.name===a||t.instanceUuid&&t.instanceUuid===a)&&""!==a)return e.removeViewKeyByInstance(t,e.sceneProxy.plotViewKeys),e.sceneProxy.removeInputView(t),e.sceneProxy.removeViewTimer(t),t.destroy(),!0;if(t.children&&t.children.length>0)for(var o=0;o<t.children.length;o++)n(t.children[o])&&o--;return!1};x.H54399Api.canPlayAd().then(function(n){n.canplay!==!0&&n.remain<=0&&t(e.viewComponent.game.world)})}},uiOnLoadInvoker:function(){var e=this,t=function n(){if(e.sceneProxy.uiOnLoadQueue.length>0){var t=e.sceneProxy.uiOnLoadQueue[0];return e.sceneProxy.uiOnLoadQueue.splice(0,1),t.callBack(t.object).then(function(){return n()})}return Promise.resolve()};return t().then(function(){return e.closePlayAdButton(),Promise.resolve()})},updateProgressView:function(){for(var e=this,t=function(t){var n=e.sceneProxy.prgsViews[t];if(!n.layer.children.length)return"continue";var a=n.layer.children[0],o=n.layer.children[1],r=n.layer.children[2],i=e.sceneProxy.Expression.safeEval(n.content.value.normal.width,e.sceneProxy.context),s=e.sceneProxy.Expression.safeEval(n.content.value.normal.height,e.sceneProxy.context),l=e.sceneProxy.Expression.safeEval(n.content.value.progress.width,e.sceneProxy.context),u=e.sceneProxy.Expression.safeEval(n.content.value.progress.height,e.sceneProxy.context),c=function(t,a,r,i,s){t.isMask?(t.destroy(),t=e.viewComponent.game.add.graphics(a,r),t.beginFill(16777215),t.drawRect(0,0,i,s),t.endFill(),t.inputEnabled=!1,n.layer.add(t),o.mask=t):(t.x=a,t.y=r,t.width=i,t.height=s)},d="clip"===n.content.style?r:o,h=Math.min(l*a.width/i,a.width),f=Math.min(u*a.height/s,a.height);switch(n.type){case"left-top":c(d,a.x,a.y,h,f);break;case"middle-top":c(d,a.x+(a.width-h)/2,a.y,h,f);break;case"right-top":c(d,a.x+a.width-h,a.y,h,f);break;case"left-center":c(d,a.x,a.y+(a.height-f)/2,h,f);break;case"middle-center":c(d,a.x+(a.width-h)/2,a.y+(a.height-f)/2,h,f);break;case"right-center":c(d,a.x+a.width-h,a.y+(a.height-f)/2,h,f);break;case"left-bottom":c(d,a.x,a.y+a.height-f,h,f);break;case"middle-bottom":c(d,a.x+(a.width-h)/2,a.y+a.height-f,h,f);break;case"right-bottom":c(d,a.x+a.width-h,a.y+a.height-f,h,f)}},n=0;n<this.sceneProxy.prgsViews.length;n++){t(n)}},destroyView:function(e,t){var n=this,a=function o(e,a){if(e.name&&e.name===a||e.instanceUuid&&e.instanceUuid===a)return n.removeViewKeyByInstance(e,n.sceneProxy.plotViewKeys),n.sceneProxy.removeInputView(e),n.sceneProxy.removeViewTimer(e),e.destroy(),e.isMenu&&t&&(n.sceneProxy.onMainMenuBackBtnClicked(),n.sceneProxy.mainMenuLayer.removeAll(!0,!1,!0)),!0;if(e.children&&e.children.length>0)for(var r=0;r<e.children.length;r++)o(e.children[r],a)&&r--;return!1};a(this.viewComponent.game.world,e)},hasInputView:function(e){if(e.inputElement)return e.inputElement;if(!e.children||!e.children.length)return null;for(var t=0;t<e.children.length;t++){var n=this.hasInputView(e.children[t]);if(null!==n&&void 0!==n)return n}},showInputView:function(e,t){if(e.inputElement)e.inputElement.show(t);else if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)this.showInputView(e.children[n],t)},scaleInputView:function(e,t){if(e.inputElement)e.inputElement.fontSize*=t,e.inputElement.width*=t,e.inputElement.height=e.inputElement.fontSize+6,e.inputElement.update();else if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)this.scaleInputView(e.children[n],t)},refreshView:function(e,t){var n=this,a=function u(e,t){var n=[];return e.name&&e.name===t?n.push(e):n=e.children.reduce(function(e,n){return e.concat(u(n,t))},[]),n},o=[],r=a(this.viewComponent.game.world,e);if(t){if(r.length>0){var i=this.sceneProxy.json_data.viewMap,s=i[e].events;for(var l in s)"onKeyUp"===s[l].type&&this.sceneProxy.plotViewKeys[s[l].keyCode].onUp.removeAll()}r.forEach(function(a){var r=a.xInfo,i=a.yInfo,s=a.scale,l=a.isGlobal,u=a.children,c=a.instanceUuid;for(var d in a.eventsInfo)"onKeyUp"===a.eventsInfo[d].type&&n.sceneProxy.plotViewKeys[a.eventsInfo[d].keyCode].onUp.removeAll();var h=n.addView(a.parent,e,c,r,i,a.eventsInfo,!t);if(h){n.viewComponent.game.world.add(h);for(var f=0;f<u.length;f++){var m=!1;for(var p in h.children)if(h.children[p].name===u[f].name){m=!0;break}m||t||(h.addChild(u[f]),f-=1)}if("CONTAINER"===a.parent.viewType&&(h.x+=n.sceneProxy.Expression.safeEval(a.parent.xInfo,n.sceneProxy.context),h.y+=n.sceneProxy.Expression.safeEval(a.parent.yInfo,n.sceneProxy.context)),s&&(h.scale.set(s.x,s.y),h.x+=n.sceneProxy.Expression.safeEval(r,n.sceneProxy.context)*(1-s.x),h.y+=n.sceneProxy.Expression.safeEval(i,n.sceneProxy.context)*(1-s.y),n.scaleInputView(h,s.x)),l){h.isGlobal=!0;var y=n.sceneProxy.globalViews.findIndex(function(t){return t.name===e});n.sceneProxy.globalViews.splice(y,1,h)}if(a.isMenu&&(h.isMenu=!0),a.parent&&"plotViewsLayer"===a.parent.name){var g=n.sceneProxy.plotViews.indexOf(a);n.sceneProxy.plotViews.splice(g,1,h)}n.sceneProxy.removeViewTimer(a),a.parent.replace(a,h).destroy(),o.push(h)}})}else r.forEach(function(e){var t={sx:0,sy:0},a=function r(e,a){o.push(e);var i={sx:0,sy:0},s=function(e){var t={sx:0,sy:0};return e.scale&&e.xInfo&&e.yInfo&&(t.sx=n.sceneProxy.Expression.safeEval(e.xInfo,n.sceneProxy.context)*(1-e.scale.x),t.sy=n.sceneProxy.Expression.safeEval(e.yInfo,n.sceneProxy.context)*(1-e.scale.y)),t};a&&(t=s(e));var l=n.sceneProxy.json_data.viewMap[e.parent.name];if(e.parent){var u=0,c=0;if(e.parent.xInfo&&e.parent.yInfo?(u=n.sceneProxy.Expression.safeEval(e.parent.xInfo,n.sceneProxy.context),c=n.sceneProxy.Expression.safeEval(e.parent.yInfo,n.sceneProxy.context),("CONTAINER"===e.parent.viewType&&!a||e.scale&&(1!==e.scale.x||1!==e.scale.y))&&(i=s(e),u+=i.sx,c+=i.sy),e.x=u,e.y=c):a&&(e.x=t.sx,e.y=t.sy),"BAR"===e.parent.viewType){var d="",h="";d=0===l.content.basePoint.x?"left":l.content.basePoint.x===l.width?"right":"middle",h=0===l.content.basePoint.y?"top":l.content.basePoint.y===l.height?"bottom":"center";var f=d+"-"+h,m=e.parent.children[0],p=e.parent.children[1],y=e.parent.children[2],g=e.parent,x=n.sceneProxy.Expression.safeEval(l.content.value.normal.width,n.sceneProxy.context),P=n.sceneProxy.Expression.safeEval(l.content.value.normal.height,n.sceneProxy.context),w=n.sceneProxy.Expression.safeEval(l.content.value.progress.width,n.sceneProxy.context),b=n.sceneProxy.Expression.safeEval(l.content.value.progress.height,n.sceneProxy.context),k=function(e,t,a,o,r){e.isMask?(e.destroy(),e=n.viewComponent.game.add.graphics(t,a),e.beginFill(16777215),e.drawRect(0,0,o,r),e.endFill(),e.inputEnabled=!1,g.add(e),p.mask=e):(e.x=t,e.y=a,e.width=o,e.height=r)},C="clip"===l.content.style?y:p;if(!C)return;var _=Math.min(w*m.width/x,m.width),S=Math.min(b*m.height/P,m.height);switch(f){case"left-top":k(C,m.x,m.y,_,S);break;case"middle-top":k(C,m.x+(m.width-_)/2,m.y,_,S);break;case"right-top":k(C,m.x+m.width-_,m.y,_,S);break;case"left-center":k(C,m.x,m.y+(m.height-S)/2,_,S);break;case"middle-center":k(C,m.x+(m.width-_)/2,m.y+(m.height-S)/2,_,S);break;case"right-center":k(C,m.x+m.width-_,m.y+(m.height-S)/2,_,S);break;case"left-bottom":k(C,m.x,m.y+m.height-S,_,S);break;case"middle-bottom":k(C,m.x+(m.width-_)/2,m.y+m.height-S,_,S);break;case"right-bottom":k(C,m.x+m.width-_,m.y+m.height-S,_,S)}}else if("INPUT"===e.parent.viewType){var I=n.sceneProxy.Expression.safeEval(l.content.value,n.sceneProxy.context);e.parent.inputElement.text=I}else if("TEXT"===e.parent.viewType){var L=e.parent.children[0],E="";if(n.sceneProxy.Expression.isArray(l.content.value)){if(l.content.value.forEach(function(e){return E+=n.sceneProxy.Expression.parseValue(e.data,n.sceneProxy.context)}),n.sceneProxy.addImageFontTextColors(l.content.value,L,n.sceneProxy.context),v["default"].fontFamily){var T=n.sceneProxy.json_data.font.size?n.sceneProxy.toRealImageFontHeight(l.content.font_size):l.content.font_size,M=n.sceneProxy.json_data.font.size?n.sceneProxy.toRealImageFontWidth(l.content.font_size):l.content.font_size;n.sceneProxy.addImageFontText(l.content.value,M,T,L,n.sceneProxy.context)}}else E=n.sceneProxy.Expression.parseValue(l.content.value,n.sceneProxy.context);v["default"].fontFamily?(L.children.forEach(function(e){e.visible=!0}),L.text=" "):L.text=E}}if(e.children&&e.children.length>0)for(var O=0;O<e.children.length;O++)r(e.children[O],!1)};a(e,!0)});return o},backgroundFlex:function(e,t){if(3===t){var n=e.width/e.height<this.viewComponent.game.world.width/this.viewComponent.game.world.height?this.viewComponent.game.world.width/e.width:this.viewComponent.game.world.height/e.height;e.width*=n,e.height*=n,e.x=-(e.width-this.viewComponent.game.world.width)/2,e.y=-(e.height-this.viewComponent.game.world.height)/2}else if(5===t){var a=0;e.width/e.height>this.viewComponent.game.world.width/this.viewComponent.game.world.height?(a=this.viewComponent.game.world.width/e.width,e.width*=a,e.height*=a,e.y=(this.viewComponent.game.world.height-e.height)/2):(a=this.viewComponent.game.world.height/e.height,e.width*=a,e.height*=a,e.x=(this.viewComponent.game.world.width-e.width)/2)}else e.width=this.viewComponent.game.world.width,e.height=this.viewComponent.game.world.height},tweenToPromise:function(e,t,n,a,o,r,i,s){var l=this;return n=Math.max(n,1),new Promise(function(u,c){var d=l.viewComponent.game.add.tween(e).to(t,n,a,o,r,i,s);d.onComplete.add(function(){return u()}),l.sceneProxy.lstPlotTweens.push(d),!e.animateTweens&&(e.animateTweens=[]),e.animateTweens.push(d),e.parent&&e.parent.parent&&e.parent.parent.parent&&"bubbleLayer"===e.parent.parent.parent.name&&e.parent.parent.parent.animateTweens.push(d)})},tweenFromPromise:function(e,t,n,a,o,r,i,s){var l=this;return n=Math.max(n,1),new Promise(function(u,c){var d=l.viewComponent.game.add.tween(e).from(t,n,a,o,r,i,s);d.onComplete.add(function(){return u()}),l.sceneProxy.lstPlotTweens.push(d),!e.animateTweens&&(e.animateTweens=[]),e.animateTweens.push(d),e.parent&&e.parent.parent&&e.parent.parent.parent&&"bubbleLayer"===e.parent.parent.parent.name&&e.parent.parent.parent.animateTweens.push(d)})},addBubbleBorder:function(e,t){var n=this;if(!t)return null;var a=t.args[0],o=this.viewComponent.game.add.group();o.uuid=a.uuid,o.remove=a.remove,o.remark=a.remark,o.index=a.index,o.width=a.rect.width,o.height=a.rect.height,o.origialH=a.rect.height,o.itemlength=0,o.bubbley=0,o.savebubble=[],o.curbubble=[],o.ishide=!1,o.iscurrent=!0,o.commands=t,o.isdown=!1,o.x=a.rect.x,o.y=a.rect.y,e&&e.addChild(o);var r=null;""!==a.url&&this.viewComponent.game.load.cache.checkImageKey(a.url)?this.viewComponent.addFitImageSprint(0,0,a.rect.width,a.rect.height,a.url,o,a.index):(r=this.viewComponent.game.add.graphics(0,0),r.beginFill(16777215,0),r.drawRect(0,0,a.rect.width,a.rect.height),r.endFill(),o.addChild(r));var i=this.viewComponent.game.add.sprite(0,0);i.name="borderScrollPane",o.addChild(i);var s=this.viewComponent.game.add.graphics();s.name="scrollgraphics",s.beginFill(16773120,0),s.drawRect(0,0,0,0),s.endFill(),i.addChild(s);var l=0,u=null,c=!1,d=0,h=0,f=0,m=0,p=function(e){var t=void 0,n=void 0,a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,o=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return a>o?flashvars.vertical?(t=e.worldY,n=-e.worldX):(t=e.worldX,n=e.worldY):flashvars.vertical?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),{x:t,y:n}},y=function(e,t){if(o.itemlength<a.rect.height)try{i.input.disableDrag()}catch(n){}else t>0?i.y=0:t<-(o.itemlength-a.rect.height)?i.y=-(o.itemlength-a.rect.height):i.y=t},g=function(e,t,n){var a=p(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?c||(document.addEventListener(o,v),c=!0):c&&(document.removeEventListener(o,v),c=!1)},v=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;y(0,i.y+100*t)},x=function(e,t,n,a,o,r){var s=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,d=n,h=a;r&&(l=n),u=i.y,s<c&&null!==u&&(h=u-n+l),y(d,h)},P=function(e,t,n,a,o,r){l=n,u=i.y},w=function(e,t,n,a,o,r){u=i.y},b=function(e,t){f=n.viewComponent.game.input.x,m=n.viewComponent.game.input.y,(Math.abs(d-f)<=1||Math.abs(h-m)<=1)&&o.isdown&&(o.isdown=!1,null!==n.sceneProxy.dialogNext&&n.sceneProxy.dialogNext(),o.gonext&&o.gonext(o)),d=0,h=0,f=0,m=0,o.isdown=!1},k=function(e,t){return o.isdown=!0,d=n.viewComponent.game.input.x,h=n.viewComponent.game.input.y,p(t)?e.input.enableDrag():e.input.disableDrag()};i.inputEnabled=!0,i.input.enableDrag(),i.input.allowHorizontalDrag=!1,i.events.onDragUpdate.add(x,this),i.events.onDragStart.add(P,this),i.events.onDragStop.add(w,this),i.events.onInputDown.add(k,this),i.events.onInputUp.add(b,this),this.viewComponent.game.input.addMoveCallback(g,this);var C=this.viewComponent.game.add.graphics();return C.beginFill(0,0),C.drawRect(0,0,a.rect.width,a.rect.height),C.endFill(),o.addChild(C),o.mask=C,o.scorllfun=y,e&&this.viewComponent.game.world.bringToTop(e),!this.sceneProxy.dialogLayer.isbottom&&this.viewComponent.game.world.bringToTop(this.sceneProxy.dialogLayer),this.viewComponent.game.world.bringToTop(this.sceneProxy.plotViewsLayer),this.sceneProxy.menuLayer.children.length>0&&this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer),o},createBubble:function(e,t){var n=this;return new Promise(function(a,o){var r=n.viewComponent.game.add.group();r.commands=e;var i=e.args[0],s=i.type,l=i.content,u=i.avatar,c=i.role,d=i.position,f=t.getByName("borderScrollPane"),m=f&&f.getChildAt(0),p=!1,y=16777215,g=0,v=0;switch(d){case"left":g=0,v=t.itemlength,y=16777215;break;case"center":p=!0,g=t.width/2,v=t.itemlength,y=14342874;break;case"right":g=t.width,v=t.itemlength,y=10019173}if(r.x=g,r.y=v,n.viewComponent.game.load.cache.checkImageKey(u.url)&&"center"!==d){var x=r.create(u.rect.x,u.rect.y,u.url),P=Math.min(u.rect.width/x.width,u.rect.height/x.height);x.width*=P,x.height*=P,x.x=(u.rect.width-x.width)/2+u.rect.x,x.y=(u.rect.height-x.height)/2+u.rect.y}if("center"!==d){var w={fill:c.color,font:c.font_size+"px "+c.fontFamily},b=n.sceneProxy.Expression.parseValue(c.data,n.sceneProxy.context),k=n.viewComponent.game.add.text(0,0,b,w,r);k.setTextBounds(c.rect.x,c.rect.y,c.rect.width,c.rect.height)}if("image"===s){if(n.viewComponent.game.load.cache.checkImageKey(l.url)){var C=r.create(l.rect.x,p?0:l.rect.y,l.url);C.width=l.rect.width,C.height=l.rect.height}}else if("text"===s){var _={fill:l.color,font:l.font_size+"px "+l.fontFamily,boundsAlignH:"center",boundsAlignV:"middle",wordWrap:!0,wordWrapWidth:l.rect.width},S=n.viewComponent.game.add.text(l.rect.x+4,p?2:l.rect.y+2,"",_,r);S.useAdvancedWrap=!0,S.updateText=h["default"].updateText,S.lineSpacing=n.sceneProxy.txtLineSpace(l.font_size);var I="";if(n.sceneProxy.Expression.isArray(l.data))for(var L=0;L<l.data.length;L++)I+=n.sceneProxy.Expression.parseValue(l.data[L].data,n.sceneProxy.context),n.sceneProxy.addImageFontTextColors(l.data,S,n.sceneProxy.context);else I=n.sceneProxy.Expression.parseValue(l.data,n.sceneProxy.context),l.data.color&&(S.style.fill=l.data.color);for(;I.length&&"\n"===I[I.length-1];)I=I.substring(0,I.length-1);if(S.text=I,""!==I){var E=n.viewComponent.game.add.graphics(),T=S.height>l.rect.height?S.height:l.rect.height;if(E.beginFill(y),E.drawRoundedRect(l.rect.x,p?0:l.rect.y,l.rect.width,T,6,6),E.endFill(),r.addChildAt(E,0),"center"!==d){var M=0,O=0,A=l.rect.x,V=l.rect.y+5;"left"===d?(M=-10,O=10,A+=2):"right"===d&&(M=10,O=10,A+=l.rect.width-2);var B=n.viewComponent.game.add.graphics();B.beginFill(y),B.moveTo(A,V),B.lineTo(A+M,V+O),B.lineTo(A,V+25),B.endFill(),r.addChildAt(B,0)}}}return t.itemlength+=r.height+20,m&&(m.clear(),m.beginFill(0,0),m.drawRect(0,0,t.width,t.itemlength),m.endFill()),f.addChild(r),t.itemlength>t.origialH&&(f.y=-(t.itemlength-t.origialH)),a(r)})},showPlot:function(e,t,n,a,o){var s=this,l=this.sceneProxy.Expression,u=t.plots[n],d=null,h=null,p=null,g=!1;this.addKeyBoardZ(),this.sceneProxy.isQuickPlay!==!0&&appCanBack(flashvars.client,flashvars.app_version,!1,"1"===flashvars.offline),this.sceneProxy.isQuickPlay=!0,!this.sceneProxy.isGameStarted&&t.isFirst&&0===n&&this.sceneProxy.notifyGameStarted();var x=function X(e,a,o){var r=e,i=s.sceneProxy,l={x:i.dialogLayer.x-r,y:i.dialogLayer.y-r},c=[];if(i.curPlotLayer.isShaking=!0,u.speaking&&"bottom"===u.speaking.coverage&&(i.dialogLayer.snakename="shake",c.push(s.tweenToPromise(i.dialogLayer,l,40,null,!0,o,0,!0))),i.charsAndPropsLayer&&i.charsAndPropsLayer.visible){var d=i.charsAndPropsLayer.x,h=i.charsAndPropsLayer.y;i.charsAndPropsLayer.snakename="shake",c.push(s.tweenToPromise(i.charsAndPropsLayer,{x:i.charsAndPropsLayer.x-r,y:i.charsAndPropsLayer.y-r},40,null,!0,o,0,!0).then(function(){i.charsAndPropsLayer.x=d,i.charsAndPropsLayer.y=h}))}return i.curPlotLayer.snakename="shake",c.push(s.tweenToPromise(i.curPlotLayer,{x:-r,y:-r},40,null,!0,o,0,!0).then(function(){return i.curPlotLayer.x=0,i.curPlotLayer.y=0,0===s.sceneProxy.shakeLoopObj.duration?(i.curPlotLayer.isShaking=!1,Promise.resolve()):0<a&&!i.quickPlay&&t===i.curChapter&&n===i.curPlotIndex?X(r,a-100,0):(i.curPlotLayer.isShaking=!1,Promise.resolve())})),Promise.all(c)},P=function(){s.sceneProxy.curPlotLayer&&(s.sceneProxy.curPlotLayer.isShaking=!1),s.sceneProxy.shakeLoopObj.loop=!1,s.sceneProxy.shakeLoopObj.duration=0;for(var e=0;e<s.sceneProxy.lstPlotTweens.length;e++){var t=s.sceneProxy.lstPlotTweens[e];t.target&&"shake"===t.target.snakename&&(t.pause(),t.stop(!0))}},w=function(e,t,n){return s.sceneProxy.twinkleTimer=m["default"].timeout(t||0),s.sceneProxy.twinkleTimer.then(function(){var t=s.viewComponent.game.add.graphics(0,0);return t.beginFill(m["default"].fixColorValue(n).replace("#","0x")),t.moveTo(0,0),t.lineTo(s.viewComponent.game.world.width,0),t.lineTo(s.viewComponent.game.world.width,s.viewComponent.game.world.height),t.lineTo(0,s.viewComponent.game.world.height),t.lineTo(0,0),t.endFill(),t.name="twinkle",s.sceneProxy.twinkleTimer=null,s.tweenToPromise(t,{alpha:0},e,null,!0,0).then(function(){return t.destroy()})})},b=function(e,t){return d?s.tweenFromPromise(d,{alpha:0},e,null,!0,t):Promise.resolve()},k=function(e,t){var n=s.viewComponent.game.world.getByName("curtainscreen1"),a=s.viewComponent.game.world.getByName("curtainscreen2");n||(n=s.viewComponent.game.add.graphics(0,0),n.beginFill(0),n.drawRect(0,0,s.viewComponent.game.width/2,s.viewComponent.game.height),n.endFill(),n.name="curtainscreen1"),a||(a=s.viewComponent.game.add.graphics(0,0),a.beginFill(0),a.drawRect(0,0,s.viewComponent.game.width/2,s.viewComponent.game.height),a.endFill(),a.name="curtainscreen2"),n.x=0,a.x=s.viewComponent.game.width/2,s.viewComponent.game.world.bringToTop(n),s.viewComponent.game.world.bringToTop(a),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var o=[];return o.push(s.tweenToPromise(n,{x:-(s.viewComponent.game.width/2)},e,null,!0,t)),o.push(s.tweenToPromise(a,{x:s.viewComponent.game.width},e,null,!0,t)),Promise.all(o)},C=function(e,t){var n=s.viewComponent.game.world.getByName("interlacingscreen1"),a=s.viewComponent.game.world.getByName("interlacingscreen2"),o=function(e){var t=s.viewComponent.game.add.graphics(0,0);t.beginFill(0,0),t.drawRect(0,0,s.viewComponent.game.width,s.viewComponent.game.height),t.endFill();var n=s.viewComponent.game.height/6,a=function(e,t){var a=s.viewComponent.game.add.graphics(0,0);return a.beginFill(0),a.drawRect(0,0,s.viewComponent.game.width,n),a.endFill(),a.x=e,a.y=t,a};return t.addChild(a(0,n*(1===e?0:1))),t.addChild(a(0,n*(1===e?2:3))),t.addChild(a(0,n*(1===e?4:5))),t.name="interlacingscreen"+e,t};n||(n=o(1)),
a||(a=o(2)),n.x=0,a.x=0,s.viewComponent.game.world.bringToTop(n),s.viewComponent.game.world.bringToTop(a),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var r=[];return r.push(s.tweenToPromise(n,{x:-s.viewComponent.game.width},e,null,!0,t)),r.push(s.tweenToPromise(a,{x:s.viewComponent.game.width},e,null,!0,t)),Promise.all(r)},_=function(e,t){var n=s.viewComponent.game.world.getByName("coverblackscreen");n||(n=s.viewComponent.game.add.graphics(0,0),n.beginFill(0),n.drawRect(0,0,s.viewComponent.game.width,s.viewComponent.game.height),n.endFill(),n.name="coverblackscreen"),n.x=-s.viewComponent.game.width;var a=0,o=0;d&&(a=d.x,o=d.y),s.sceneProxy.prePlotBkKey&&s.viewComponent.game.load.cache.checkImageKey(s.sceneProxy.prePlotBkKey)&&d&&(d=s.sceneProxy.curPlotLayer.create(d.x,d.y,s.sceneProxy.prePlotBkKey),d.alpha=void 0===s.sceneProxy.lstPlotBkOpacity?1:s.sceneProxy.lstPlotBkOpacity,s.backgroundFlex(d,s.sceneProxy.lstPlotBkFlex),s.viewComponent.addGifAnimation(d,s.sceneProxy.lstPlotBkKey)),s.viewComponent.game.world.bringToTop(n),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var r=[];return r.push(s.tweenToPromise(n,{x:0},e/2,null,!0,t).then(function(){d=s.sceneProxy.curPlotLayer.create(a,o,s.sceneProxy.lstPlotBkKey),d.alpha=void 0===s.sceneProxy.lstPlotBkOpacity?1:s.sceneProxy.lstPlotBkOpacity,s.backgroundFlex(d,s.sceneProxy.lstPlotBkFlex),s.viewComponent.addGifAnimation(d,s.sceneProxy.lstPlotBkKey),s.tweenToPromise(n,{x:s.viewComponent.game.width},e/2,null,!0,t)})),Promise.all(r)},S=function(e,t){var n=s.sceneProxy,a=[],o=!1,r=s.viewComponent.game.world.getChildIndex(n.curPlotLayer),i=s.viewComponent.game.world.getChildIndex(n.charsAndPropsLayer),l=s.viewComponent.game.world.getChildIndex(n.dialogLayer);s.sceneProxy.weatherLayer.visible&&(s.sceneProxy.weatherLayer.visible=!1,o=!0);var u=s.viewComponent.game.add.group();n.curPlotLayer.snakename="spread",u.add(n.curPlotLayer),n.charsAndPropsLayer&&n.charsAndPropsLayer.visible?(n.charsAndPropsLayer.visible=!0,u.add(n.charsAndPropsLayer)):i=-1,u.add(n.dialogLayer),s.sceneProxy.curPlotLayer.isSpreading=!0;var c=s.viewComponent.game.add.graphics(0,0);c.beginFill(0),c.drawRect(0,0,s.viewComponent.game.world.width,s.viewComponent.game.world.height),c.endFill(),u.add(c),u.mask=c;var d=u.x,h=u.y,f=u.width,m=u.height;return u.x=s.viewComponent.game.world.centerX,u.y=s.viewComponent.game.world.centerY,u.width=0,u.height=0,s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer),a.push(s.tweenToPromise(u,{x:d,y:h,width:f,height:m},e,null,!0,t,0,!1).then(function(){u.x=d,u.y=h,c&&c.destroy(),r!==-1&&s.viewComponent.game.world.addChildAt(n.curPlotLayer,r),i!==-1&&s.viewComponent.game.world.addChildAt(n.charsAndPropsLayer,i),l!==-1&&s.viewComponent.game.world.addChildAt(n.dialogLayer,l),o&&(s.sceneProxy.weatherLayer.visible=!0),u.destroy(),s.sceneProxy.curPlotLayer.isSpreading=!1})),Promise.all(a)},I=function(t){var n=[];return t.forEach(function(t){var a=s.sceneProxy.quickPlay?0:t.delay,o=s.sceneProxy.quickPlay?100:t.duration;"twinkle"===t.type&&n.push(w(o,a,t.color)),"shake"===t.type&&o&&n.push(x(t.level?5*t.level:18,o,a)),"fadein"===t.type&&n.push(b(o,a).then(function(){return s.sceneProxy.doInCT(e,function(){s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=null,s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer})})),"curtain"===t.type&&n.push(k(o,a)),"interlacing"===t.type&&n.push(C(o,a)),"coverblack"===t.type&&n.push(_(o,a)),"spread"===t.type&&n.push(S(o,a))}),Promise.all(n)},L=function(t){var n=s.sceneProxy.dialogLayer;s.addDialogLayer();var a=s.sceneProxy.json_data.template.json.dialog,o=a.avatarContainer,r=a.titleContainer,i=a.content,u=n.getByName("dialog_bk"),c=n.getByName("dialog_bk_avatar"),d=n.getByName("dialog_avatar"),f=n.getByName("dialog_bk_title");if(h=n.getByName("dialog_text_title"),p=n.getByName("dialog_text_content"),u&&(u.visible=!t.speaking.hidden),c&&(c.visible=!t.avatar.hidden),f&&(f.visible=!t.dialogtitle.hidden),d.visible=!t.avatar.hidden,h.visible=!t.dialogtitle.hidden,s.sceneProxy.dialogLayer.x=t.speaking.x,s.sceneProxy.dialogLayer.y=t.speaking.y,s.sceneProxy.dialogLayer.alpha=void 0===t.speaking.opacity?1:t.speaking.opacity,s.viewComponent.game.load.cache.checkImageKey(t.avatar.url)){var m=o.avatar,y=m.x,g=m.y,x=m.width,P=m.height,w=m.clip;y+=o.rect.x,g+=o.rect.y,d.loadTexture(t.avatar.url);var b=Math.min(x*d.scale.x/d.width,P*d.scale.y/d.height);x=d.width/d.scale.x*b,P=d.height/d.scale.y*b,y=o.avatar.x+o.rect.x+(o.avatar.width-x)/2,g=o.avatar.y+o.rect.y+(o.avatar.height-P)/2,d.x=y,d.y=g,d.width=x,d.height=P,d.mask&&d.mask.destroy();var k=s.viewComponent.game.add.graphics(0,0);switch(k.beginFill(),w){case"square":k.drawRect(y,g,x,P);break;case"hexagon":var C=new Phaser.Polygon;C.setTo([new Phaser.Point(x/2+y,g),new Phaser.Point(x/2+P/4*Math.pow(3,.5)+y,P/4+g),new Phaser.Point(x/2+P/4*Math.pow(3,.5)+y,P/4*3+g),new Phaser.Point(x/2+y,P+g),new Phaser.Point(x/2-P/4*Math.pow(3,.5)+y,P/4*3+g),new Phaser.Point(x/2-P/4*Math.pow(3,.5)+y,P/4+g)]),k.drawPolygon(C.points);break;case"heart":k.moveTo(x/2+y,x/4+g),k.bezierCurveTo(3*x/4+y,-x/4+g,3*x/2+y,x/4+g,x/2+y,x+g),k.bezierCurveTo(-x/2+y,x/4+g,x/4+y,-x/4+g,x/2+y,x/4+g);break;case"round":default:k.drawCircle(y+x/2,g+P/2,x)}k.endFill(),s.sceneProxy.dialogLayer.add(k),d.mask=k}var _=t.dialogtitle,S=_.font_size,I=_.color,L=_.bold,E=_.fontFamily,T=_.hidden,M=r.title.text;S&&(M.fontSize=S),I&&(M.color=I),void 0!==L&&(M.fontWeight=L?"bold":"normal"),E?M.fontFamily=E:s.sceneProxy.json_data.font?M.fontFamily=s.sceneProxy.json_data.font.fontFamily:"",void 0!==T&&(M.hidden=T);var O="";if(v["default"].fontFamily){var A=h.children[0],V=l.parseValue(t.dialogtitle.data,e);("#ffffff"===I||"#fff"===I)&&(M.color="#fefefe"),A&&(A.fontImg.destroy(),A.destroy()),A=s.sceneProxy.addRetroText(),h.addChild(A),A.fontImg.setText(V?V:" ",!0,0,0,"left",!0),A.tint=parseInt(M.color.replace("#","0x"));var B=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(M.fontSize):M.fontSize,N=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(M.fontSize):M.fontSize;A.width=N*A.fontImg.text.length,A.height=B;var j=r.rect.x+r.title.rect.x+(r.title.rect.width-A.width)/2,R=r.rect.y+r.title.rect.y;h.setTextBounds(j,R,r.title.rect.width,r.title.rect.height),h.text=" "}else{O+=M.fontWeight?M.fontWeight+" ":"normal ",O+=M.fontSize?parseInt(M.fontSize)+"px ":"",O+=M.fontFamily?M.fontFamily:"",h.setStyle({font:O,fill:M.color,boundsAlignH:"center",boundsAlignV:"middle"}),h.text=l.parseValue(t.dialogtitle.data,e);var D=r.rect.x+r.title.rect.x,F=r.rect.y+r.title.rect.y;h.setTextBounds(D,F+(h.height-parseInt(M.fontSize||12))/2,r.title.rect.width,r.title.rect.height)}O=t.speaking.font_size+"",O.indexOf("px")<0&&(O+="px"),t.speaking.bold===!0&&(O="bold "+O),O=O+" "+(s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:t.speaking.fontFamily?t.speaking.fontFamily:""),p.style.font=O,p.style.fill=t.speaking.color,p.text="",p.top=i.rect.y,p.lineSpacing=s.sceneProxy.txtLineSpace(t.speaking.font_size),p.mask&&p.mask.destroy();var U=s.viewComponent.game.add.graphics(0,0);return U.beginFill(),U.drawRect(i.rect.x,i.rect.y,i.rect.width,t.speaking.hidden?s.viewComponent.game.world.height:i.rect.height),U.endFill(),s.sceneProxy.dialogLayer.add(U),p.mask=U,t&&t.speaking&&t.speaking.animations&&t.speaking.animations.length>0&&(s.sceneProxy.dialogLayer.visible=!1),Promise.resolve()},E=function(){var e=u.plot_sound;if(o&&(e=o.sounds),"[object Array]"===Object.prototype.toString.call(e))for(var t in e)e[t]?"inherit"===e[t].url?s.sceneProxy.playInheritSound(t,e[t].volume):(s.viewComponent.game.load.cache.checkSoundKey(e[t].url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&(s.sceneProxy.stopSound(t,e[t].url,!0),s.sceneProxy.playSound(t,e[t].url,e[t].volume,0===e[t].time)):s.sceneProxy.stopSound(t);else(s.viewComponent.game.load.cache.checkSoundKey(u.plot_sound.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&s.sceneProxy.playSound(0,u.plot_sound.url,u.plot_sound.volume,!1)},T=function(e){if(e.url&&""!==e.url){if("inherit"===e.url)s.sceneProxy.playInheritMusic(e.volume);else if(s.viewComponent.game.load.cache.checkSoundKey(e.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var t=e.volume;void 0!==e.inheritvolume&&e.inheritvolume!==-1&&(t=e.inheritvolume),s.sceneProxy.stopMusic(e.url,!0),s.sceneProxy.playMusic(e.url,t,1!==e.time,!1)}}else s.sceneProxy.stopMusic()},M=function(e){if(d=s.viewComponent.game.add.graphics(0,0,e),d.beginFill(0,1),d.drawRect(0,0,s.viewComponent.game.world.width,s.viewComponent.game.world.height),d.endFill(),!u.commands){s.sceneProxy.lstGameBk&&s.sceneProxy.lstGameBk.visible&&!u.animations.filter(function(e){return"fadein"===e.type}).length&&(s.sceneProxy.lstGameBk.visible=!1);var t="inherit"===u.background.url,n=t?s.sceneProxy.lstPlotBkOpacity:u.background.opacity,a=t?s.sceneProxy.lstPlotBkFlex:u.background.flex,o=t?s.sceneProxy.lstPlotBkKey:u.background.url;!t&&f.ResourcesManager.updateUsingKey({type:"background",key:o}),o&&(s.sceneProxy.prePlotBkKey=s.sceneProxy.lstPlotBkKey,s.sceneProxy.lstPlotBkKey=o,s.sceneProxy.lstPlotBkOpacity=n,s.sceneProxy.lstPlotBkFlex=a),s.viewComponent.game.load.cache.checkImageKey(o)&&(d.alpha=0,d=e.create(u.background.x,u.background.y,o),d.alpha=void 0===n?1:n,s.backgroundFlex(d,a),s.viewComponent.addGifAnimation(d,o))}},O=function(e,t,n){for(var a=[].concat(r(e),r(t)),o=0;o<a.length;o++){var i=a[o],l=s.viewComponent.addFitImageSprint(i.x,i.y,i.width,i.height,i.url,s.sceneProxy.charsAndPropsLayer,i.index);l.alpha=void 0===i.opacity?1:i.opacity,l.angle=180===parseInt(i.rotate)?179.9:i.rotate||0,l.data.animations=i.animations,l.cmdUuid=n,s.viewComponent.addGifAnimation(l,i.url),i.mirrorH&&(l.angle=-l.angle,l.scale.x=-l.scale.x,l.mirrorH=!0),i.mirrorV&&(l.angle=-l.angle,l.scale.y=-l.scale.y,l.mirrorV=!0)}s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.sceneProxy.dialogLayer.visible&&!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),s.sceneProxy.weatherLayer.visible&&s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer),s.sceneProxy.menuLayer.visible!==!1&&s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer)},A=function(){var e=[],t=!0,n=!1,a=void 0;try{for(var o,r=s.sceneProxy.charsAndPropsLayer.children[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var i=o.value,l=!0,u=!1,c=void 0;try{for(var d,h=i.data.animations[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var f=d.value;if(("in"===f.trigger||"animateIn"===f.trigger)&&!s.sceneProxy.quickPlay)if("fadein"===f.type)e.push(s.tweenFromPromise(i,{alpha:0},f.duration,null,!0,f.delay,0,!1));else if("moveFrom"===f.type){var m=i.mirrorH?f.x-i.width/2:f.x+i.width/2,p=i.mirrorV?f.y-i.height/2:f.y+i.height/2;e.push(s.tweenFromPromise(i,{x:m,y:p},f.duration,null,!0,f.delay,0,!1))}}}catch(y){u=!0,c=y}finally{try{!l&&h["return"]&&h["return"]()}finally{if(u)throw c}}}}catch(y){n=!0,a=y}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw a}}return Promise.all(e)},V=function(a,o){var r=!1;return new Promise(function(i,c){if(u.jump||u.back||u.insert)return i({type:0});var d=(o||[]).findIndex(function(t){return l.safeEval(t.expression,e)}),h=d<0?null:o[d];if(h)return i({type:2,index:d});for(var f=[],p=[],y=function(o){var u=s.sceneProxy.json_data.template.json.option,c=u.rect,d=u.normal,h=u.active,y=c.x,g=c.y,x=c.width,P=c.height,w=d.background.url,b=h.background.url,k=null,C=a[o],_=C.font,S=C.timer,I=C.disable;void 0!==a[o].x&&(y=a[o].x),void 0!==a[o].y&&(g=a[o].y),void 0!==a[o].width&&a[o].hasOwnProperty("background")&&(x=a[o].width),void 0!==a[o].height&&a[o].hasOwnProperty("background")&&(P=a[o].height),a[o].background&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.normal.url)&&(w=a[o].background.normal.url),a[o].background&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.active.url)&&(b=a[o].background.active.url),a[o].background&&a[o].background.disable&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.disable.url)&&(k=a[o].background.disable.url);var L=function(e,t){var n=!0,r=!1,l=void 0;try{for(var u,c=f[Symbol.iterator]();!(n=(u=c.next()).done);n=!0){var d=u.value;d.close()}}catch(h){r=!0,l=h}finally{try{!n&&c["return"]&&c["return"]()}finally{if(r)throw l}}t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button||(e.chapter.plots.length>0?(i({type:1,index:o}),s.sceneProxy.optionLayer.destroy()):(i({type:3}),s.sceneProxy.optionLayer.destroy()),m["default"].selOptions.push(a[o].uuid))},E={fontFamily:_.normal.fontFamily?_.normal.fontFamily:s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:"",fontSize:_.normal.font_size,fontWeight:_.normal.bold?"bold":"normal",color:_.normal.color,hidden:_.normal.hidden},T={fontFamily:_.disable.fontFamily?_.disable.fontFamily:s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:"",fontSize:_.disable.font_size,fontWeight:_.disable.bold?"bold":"normal",color:_.disable.color,hidden:_.disable.hidden},M={};M.normal=E,M.active=E,M.text=a[o].name;var O=void 0;a[o].sound&&s.viewComponent.game.load.cache.checkSoundKey(a[o].sound.url)&&(O=s.viewComponent.game.add.sound(a[o].sound.url,a[o].sound.volume,!1));var A=s.viewComponent.addButton(y,g,x,P,w,b,L,M,O,"option",s.sceneProxy.optionLayer),V=A.getByName("button"),B=A.getByName("text");if(V.chapter={plots:a[o].plots?a[o].plots:a[o].commands,parent:{pChapter:t,pnPlot:n}},I&&(V.inputEnabled=!1,A.changeBackground(k||w,T)),S){s.sceneProxy.hasCountDown=!0;var N=function(){return new Promise(function(t,n){var r=l.getGameValueByTimer(S,e);if(!a[o].hideTimer&&(B.text=a[o].name+("("+r+")"),v["default"].fontFamily)){var i=B.children[0];if(i){var u=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(E.fontSize):E.fontSize,c=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(E.fontSize):E.fontSize,d=c*B.text.length,h=(x-d)/2,m=(P-u)/2;s.sceneProxy.addImageFontText([{data:B.text}],c,u,B,e),B.children[0].x=h,B.children[0].y=m,i.children.forEach(function(e){return e.fontImg.destroy()}),i.destroy(),B.text=" "}}var p=s.viewComponent.game.time.events.loop(Phaser.Timer.SECOND,function(){if(r--,!a[o].hideTimer&&(B.text=a[o].name+("("+r+")"),v["default"].fontFamily)){var n=B.children[0];if(n){var i=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(E.fontSize):E.fontSize,l=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(E.fontSize):E.fontSize,u=l*B.text.length,c=(x-u)/2,d=(P-i)/2;s.sceneProxy.addImageFontText([{data:B.text}],l,i,B,e),B.children[0].x=c,B.children[0].y=d,n.children.forEach(function(e){return e.fontImg.destroy()}),n.destroy(),B.text=" "}}if(r<=0){if(B.text=a[o].name,v["default"].fontFamily){var h=B.children[0];if(h){var f=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(E.fontSize):E.fontSize,m=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(E.fontSize):E.fontSize,y=m*B.text.length,g=(x-y)/2,b=(P-f)/2;s.sceneProxy.addImageFontText([{data:B.text}],m,f,B,e),B.children[0].x=g,B.children[0].y=b,h.children.forEach(function(e){return e.fontImg.destroy()}),h.destroy(),B.text=" "}}s.viewComponent.game.time.events.remove(p),"disable"===S.type?(V.alive&&(V.inputEnabled=!1,A.changeBackground(k||w,T)),t(!1)):(V.alive&&(V.inputEnabled=!0,V.input.useHandCursor=!0,A.changeBackground(w,E)),t(!0))}}),y=function(){s.viewComponent.game.time.events.remove(p),t(!0)};f.push({close:y}),s.viewComponent.game.time.events.start()})};p.push(N())}else p.push(Promise.resolve(!I));r=!0},g=0;g<a.length;g++)y(g);r||(i({type:0}),s.sceneProxy.optionLayer.destroy()),Promise.all(p).then(function(e){s.sceneProxy.hasCountDown=!1,e.some(function(e){return!!e})||i({type:3})})})},B=function(e){s.sceneProxy.weatherLayer.visible=!1;for(var t=0;t<s.sceneProxy.weatherLayer.children.length;t++){var n=s.sceneProxy.weatherLayer.children[t],a=n.visible,o=n.name;a&&o!==e?(s.sceneProxy.weatherLayer.children[t].destroy(),t--):s.sceneProxy.weatherLayer.children[t].visible=!1}"windy"===e?flashvars.vertical?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("wind")+"/feng_00019.png")&&s.addWindEffect():s.addWindEffect():"snowy"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("snow")+"/xuehua_00119.png")&&s.addSnowEffect():"rainy"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("rain")+"/xiayu_00049.png")&&s.addRainEffect():"defoliation"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("mapleLeaves")+"/fengye_00089.png")&&s.addFallingLeavesEffect():"fallingPeach"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("beachBlossom")+"/taohua_00089.png")&&s.addBeachBlossomEffect():"fallingFlower"===e?s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("blossom")+"/yinghua_00089.png")&&s.addBlossomEffect():"lightning"===e&&s.viewComponent.game.load.cache.checkImageKey("/"+m["default"].getWeatherOfflinePathName()+"/"+m["default"].getWeatherFilePathName("lightning")+"/shandian_00049.png")&&s.addLightningEffect(),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer)},N=function(t,n,a){if(n){for(var o=[],r=0;r<s.sceneProxy.plotViews.length;r++)if("plotInfo"===s.sceneProxy.plotViews[r].generateType){var i=function(e){for(var n=0;n<t.length;n++)if(e.name===t[n].ref)return!0;return!1};i(s.sceneProxy.plotViews[r])||o.push(s.sceneProxy.plotViews[r])}for(var u=0;u<o.length;u++){var c=s.sceneProxy.plotViews.indexOf(o[u]);s.sceneProxy.plotViews.splice(c,1)}return R(s.sceneProxy.plotViews,!0),s.sceneProxy.uiOnLoadQueue.splice(0),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),void(s.sceneProxy.plotViewsLayer.visible=!1)}for(var d in t){s.registerViewKey(t[d].ref,t[d].events,s.sceneProxy.plotViewKeys);var h=s.addView(s.sceneProxy.plotViewsLayer,t[d].ref,t[d].instanceUuid,t[d].x,t[d].y,t[d].events);if(!h)return;t[d].scale&&(h.scale.set(t[d].scale,t[d].scale),h.x+=l.safeEval(t[d].x,e)*(1-t[d].scale),h.y+=l.safeEval(t[d].y,e)*(1-t[d].scale),s.scaleInputView(h,t[d].scale)),h.generateType=a?a:"plotInfo",s.sceneProxy.plotViews.push(h)}s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),s.uiOnLoadInvoker(),s.updateProgressView(),s.sceneProxy.plotViewsLayer.visible=!1},j=function(e,t){var n=[];for(var a in t)for(var o in s.sceneProxy.json_data.views)if(t[a]===s.sceneProxy.json_data.views[o].instanceUuid){n[s.sceneProxy.json_data.views[o].ref]=s.sceneProxy.json_data.views[o].ref;break}if(e&&s.sceneProxy.globalViews){for(var r=function(e){for(var t=0;t<s.sceneProxy.json_data.views.length;t++)if(e===s.sceneProxy.json_data.views[t].instanceUuid)return!0;return!1},i=[],l=0;l<s.sceneProxy.globalViews.length;l++)r(s.sceneProxy.globalViews[l].instanceUuid)||i.push(s.sceneProxy.globalViews[l]);for(var u=0;u<i.length;u++)if(i[u].isGlobal===!0){var c=s.sceneProxy.globalViews.indexOf(i[u]);s.sceneProxy.globalViews.splice(c,1)}R(s.sceneProxy.globalViews,!0);for(var d in s.sceneProxy.globalViews)s.viewComponent.game.world.bringToTop(s.sceneProxy.globalViews[d]),n[s.sceneProxy.globalViews[d].name]&&(s.sceneProxy.globalViews[d].visible=!1,s.showInputView(s.sceneProxy.globalViews[d],!1))}else s.addGlobalView(n);s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer)},R=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];s.sceneProxy.timerCounts=[];var n=function i(e){for(var t=0;t<e.length;t++){var n=e[t];n.currentCount&&(s.sceneProxy.timerCounts[s.sceneProxy.timerCounts.length]={name:n.name,parent:n.parent,currentCount:n.currentCount}),i(n.children)}},a=function(e){for(var t=0;t<e.length;t++){if(e[t].eventsInfo)return;for(var n=0;n<u.views.length;n++)if(u.views[n].ref===e[t].name){e[t].eventsInfo=u.views[n].events.concat();break}}};n(e),!u.commands&&a(e);for(var o=function(n){var a=e[n],o="__world"===a.parent?null:s.viewComponent.game.world.getByName(a.parent),i=s.addView(o,a.name,a.instanceUuid,a.xInfo,a.yInfo,a.eventsInfo,!1,t),l=function(e,t){for(var n=[],a=function(e,t){for(var n=t.children?t.children.concat():[],a=0;a<n.length;a++)if(n[a]&&e.name===n[a].name&&e.instanceUuid===n[a].instanceUuid)return!0;return!1},o=t.children?t.children.concat():[],r=0;r<o.length;r++)a(o[r],e)||n.push(s.destroyView(o[r].name));return Promise.all(n)},u=function c(e,n){l(e,n).then(function(){if(!(e&&e.children.length<=0))for(var a=n.children?n.children.concat():[],o=function(e,t){for(var n=0;n<t.length;n++)if(e.name&&t[n].name&&e.name===t[n].name&&e.instanceUuid&&t[n].instanceUuid&&e.instanceUuid===t[n].instanceUuid)return t[n];return!1},r=function(e){var a=s.addView(n,e.name,e.instanceUuid,e.xInfo,e.yInfo,e.eventsInfo,!1,t);n.xInfo&&n.yInfo&&a&&(a.x+=s.sceneProxy.Expression.safeEval(n.xInfo,s.sceneProxy.context),a.y+=s.sceneProxy.Expression.safeEval(n.yInfo,s.sceneProxy.context)),a&&c(e,a)},i=0;i<e.children.length;i++){var l=e.children[i],u=o(e.children[i],a);u===!1?r(l):c(l,u)}})};return i?(u(a,i),i.scale.set(a.scale.x,a.scale.y),i.x=a.x,i.y=a.y,s.scaleInputView(i,a.scale.x),i.visible=a.visible,e[n]=i,o?o.add(i):i.isGlobal=!0,void(r=n)):(e.splice(n--,1),"continue")},r=0;r<e.length;r++){o(r)}s.closePlayAdButton()},D=function(){if(u.music.animation&&("fadeinfadeout"===u.music.animation.type||"fadein"===u.music.animation.type)){if(s.sceneProxy.bk_music)return 0===s.sceneProxy.bk_music.prevolume&&(s.sceneProxy.bk_music.prevolume=s.sceneProxy.bk_music.volume,s.sceneProxy.bk_music.inheritvolume=s.sceneProxy.bk_music.volume),s.sceneProxy.bk_music.volume=s.sceneProxy.bk_music.prevolume*m["default"].musicVolume,s.tweenFromPromise(s.sceneProxy.bk_music,{volume:0},s.sceneProxy.quickPlay?10:1e3,null,!0,0,0,!1);if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)return y["default"].tweenFromMusic(0,s.sceneProxy.quickPlay?10:1e3,0)}return Promise.resolve()},F=function(e){if(u.music.animation&&("fadeinfadeout"===u.music.animation.type||"fadeout"===u.music.animation.type)){if(s.sceneProxy.bk_music)return new Promise(function(t,n){var a=s.viewComponent.game.add.tween(s.sceneProxy.bk_music).to({volume:0},s.sceneProxy.quickPlay?10:1e3,null,!0,0,0,!1);a.onComplete.add(function(){s.sceneProxy.bk_music.volume*=m["default"].musicVolume,t(e)})});if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)return y["default"].tweenToMusic(0,s.sceneProxy.quickPlay?10:1e3,0)}return Promise.resolve(e)},U=function(e){if(s.sceneProxy.dialogLayer.visible=!0,!e.length)return Promise.resolve();var t=e.filter(function(e){return"fadein"===e.type}),n=e.filter(function(e){return"moveFrom"===e.type}),a=function(){if(t.length)return s.tweenFromPromise(s.sceneProxy.dialogLayer,{alpha:0},t[0].duration,null,!0,t[0].delay,0,!1)},o=function(){if(n.length)return s.tweenFromPromise(s.sceneProxy.dialogLayer,{x:n[0].x,y:n[0].y},n[0].duration,null,!0,n[0].delay,0,!1)};return Promise.all([a(),o()])},W=function(e){if(!e.length)return Promise.resolve();var t=e.filter(function(e){return"fadeout"===e.type}),n=e.filter(function(e){return"moveTo"===e.type}),a=function(){if(t.length)return s.tweenToPromise(s.sceneProxy.dialogLayer,{alpha:0},t[0].duration,null,!0,t[0].delay,0,!1)},o=function(){if(n.length)return s.tweenToPromise(s.sceneProxy.dialogLayer,{x:n[0].x,y:n[0].y},n[0].duration,null,!0,n[0].delay,0,!1)};return Promise.all([a(),o()])},G=function(){return s.sceneProxy.doInCT(e,function(){return I(u.animations.filter(function(e){return"in"===e.trigger}))}).then(function(){return s.sceneProxy.charsAndPropsLayer&&(s.sceneProxy.charsAndPropsLayer.visible=!0),s.sceneProxy.plotViewsLayer.visible=!0,s.sceneProxy.doInCT(e,function(){return Promise.all([A(),I(u.animations.filter(function(e){return"animateIn"===e.trigger})),U(u.speaking.animations.filter(function(e){return"animateIn"===e.trigger}))])})}).then(function(){return s.sceneProxy.doInCT(e,function(){return I(u.animations.filter(function(e){return"animateInEnd"===e.trigger}))})})},H=function(t){var n=[],a=!0,o=!1,r=void 0;try{for(var i,l=s.sceneProxy.charsAndPropsLayer.children[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var u=i.value,c=!0,d=!1,h=void 0;try{for(var f,m=u.data.animations[Symbol.iterator]();!(c=(f=m.next()).done);c=!0){var p=f.value;if(("out"===p.trigger||"animateOut"===p.trigger)&&!s.sceneProxy.quickPlay)if("fadeout"===p.type)n.push(s.tweenToPromise(u,{alpha:0},p.duration,null,!0,p.delay,0,!1));else if("moveTo"===p.type){var y=u.scale.x<0?-u.width/2:u.width/2,g=u.scale.y<0?-u.height/2:u.height/2;n.push(s.tweenToPromise(u,{x:p.x+y,y:p.y+g},p.duration,null,!0,p.delay,0,!1))}}}catch(v){d=!0,h=v}finally{try{!c&&m["return"]&&m["return"]()}finally{if(d)throw h}}}}catch(v){o=!0,r=v}finally{try{!a&&l["return"]&&l["return"]()}finally{if(o)throw r}}return s.sceneProxy.doInCT(e,function(){return Promise.all(n)})},z=function Z(e){if("\\"===e[0]){var t=/\\(\d+)\s([\s\S]*)/.exec(e);if(t)return m["default"].timeout(s.sceneProxy.quickPlay?0:t[1]).then(function(){return Z(e.slice(t[1].length+2))})}return s.sceneProxy.playPause?m["default"].timeout(1e3).then(function(){return Z(e)}):Promise.resolve(e)},K=function(e,t){var n=s.sceneProxy.json_data.template.json.dialog.content,a=e?s.viewComponent.game.world.height:n.rect.height,o=t-a;o>0&&(p.top=-o+n.rect.y)},q=function ee(e,t,n,a,o){if(v["default"].fontFamily){var r=e,i=0;if(e.replace(/[\n]/g,function(e,t){i++}),r.length&&r.length-i>0){var l=r.length-i-1,u=p.children[1],c=p.posInfo;c[l]&&(u.x=c[l].x+c[l].space,u.y=c[l].y,K(o,c[l].bottomInText),p.setText(" ",!0))}}else{var d=s.viewComponent.game.device.desktop?e:e.replace(new RegExp(" ","gm"),"  ");p.setText(d,!0),K(o,p.height)}return z(t).then(function(t){return s.sceneProxy.doInCT(n,function(){return m["default"].timeout(a).then(function(){return g?Promise.reject():t?s.sceneProxy.doInCT(n,function(){return ee(e+(t[0]?t[0]:""),t.slice(1),n,a,o)}):Promise.resolve()})})})},J=function(t,n){var a="";if(l.isArray(t.data)){for(var o=0;o<t.data.length;o++)a+=l.parseValue(t.data[o].data,e);s.sceneProxy.addImageFontTextColors(t.data,p,e)}else a=l.parseValue(t.data,e);if(a.length&&"\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),v["default"].fontFamily){var r=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(t.font_size):t.font_size,i=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(t.font_size):t.font_size;s.sceneProxy.addImageFontText(t.data,i,r,p,e,!0,t.hidden)}if(n||t.immediate){if(v["default"].fontFamily)p.children[1]&&(p.children[1].y=p.imgFBottom),p.text=" ",K(t.hidden,p.imgFBottom);else{var u=l.parseWaitTime(a);p.text=s.viewComponent.game.device.desktop?u:u.replace(new RegExp(" ","gm"),"  ")}return Promise.resolve()}g=!1;var c=new Promise(function(e,t){s.sceneProxy.curPlotLayer.onChildInputDown.add(function(t,n){"auto"===t||n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||e()})}),d=new Promise(function(e,t){s.sceneProxy.space_key.onDown.add(function(){e()})});return s.sceneProxy.doInCT(e,function(){return Promise.race([q("",a,e,s.sceneProxy.quickPlay?0:parseInt(t.speed),t.hidden),c,d])}).then(function(){if(g=!0,s.sceneProxy.curPlotLayer.onChildInputDown.removeAll(),s.sceneProxy.space_key.onDown.removeAll(),v["default"].fontFamily)p.children[1]&&(p.children[1].y=p.imgFBottom),K(t.hidden,p.imgFBottom),p.setText(" ",!0);else{var e=l.parseWaitTime(a);p.text=s.viewComponent.game.device.desktop?e:e.replace(new RegExp(" ","gm"),"  "),K(t.hidden,p.height)}})},$=function te(e,t){var n=s.sceneProxy.quickPlay?10:e<10?10:e;return m["default"].timeout(n).then(function(){return s.sceneProxy.playPause?te(500,t):Promise.resolve(t)})},Y=function(t){var n="";if("[object Array]"===Object.prototype.toString.call(t.speaking.data))for(var a=0;a<t.speaking.data.length;a++)n+=t.speaking.data[a].data;else n=t.speaking.data;n=n.replace(/\n/g,"");var o=t.dialogtitle.hidden||""===t.dialogtitle.data?n:t.dialogtitle.data+":"+n;o&&s.sceneProxy.addPlayBackContent(l.parseWaitTime(l.parseValue(o,e)))},Q=function(){if(!u)return s.showNextPlot(e,t,n);var r=function(){s.sceneProxy.curCmdUuid="",s.sceneProxy.context.disableSaveOrLoad=u.disableSaveOrLoad?u.disableSaveOrLoad:{save:!1,load:!1};var a={avatar:u.avatar,dialogtitle:u.dialogtitle,speaking:u.speaking};u.speaking.data&&!o&&Y(u),u.menu.hidden||(s.sceneProxy.json_data.template.json.shanyiMenu?s.addMenuLayer(!0):(s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=u.menu.x,s.sceneProxy.menuLayer.y=u.menu.y)),u.animations.find(function(e){return"fadein"===e.type})||(s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer,f.ResourcesManager.updateUsingKey({type:"preBackground",key:s.sceneProxy.lstPlotBkKey})),E(),T(o?o.music:u.music),M(s.sceneProxy.curPlotLayer);var r=function(){return"bottom"===u.speaking.coverage?(L(a),O(u.characters,u.props),B(u.weather.value),s.sceneProxy.dialogLayer.isbottom=!0):(O(u.characters,u.props),B(u.weather.value),L(a),s.sceneProxy.dialogLayer.isbottom=!1),s.sceneProxy.optionLayer&&s.viewComponent.game.world.bringToTop(s.sceneProxy.optionLayer),s.sceneProxy.charsAndPropsLayer&&(s.sceneProxy.charsAndPropsLayer.visible=!1),N(u.views,o),j(null!==o&&void 0!==o,u.hideGlobalViews),s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad&&u.autoSaveOrLoad&&1===u.autoSaveOrLoad.type&&!o?s.sceneProxy.loadRecord(0)?void 0:c["default"].warn("Sorry~读不到存档内容，即将返回封面").then(function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend())},function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend())}):(s.sceneProxy.shakeLoopObj.duration=-1,Promise.all([G(),D()]).then(function(){return s.sceneProxy.lstGameBk&&(s.sceneProxy.lstGameBk.visible=!1),J(u.speaking)}).then(function(){return s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad&&u.autoSaveOrLoad&&0===u.autoSaveOrLoad.type&&(s.sceneProxy.getSnap(),s.sceneProxy.saveRecord(0,!0)),V(u.options,u.condition_options)}).then(function(t){var n=s.sceneProxy.plotViewsLayer.children.length>0;return new Promise(function(a,o){if(0===t.type||2===t.type)if(!u.autotext&&(n||!s.sceneProxy.quickPlay&&!e.auto)||s.sceneProxy.playPause){var r=function i(e,r){r&&r.pointerMode===Phaser.PointerMode.CURSOR&&0!==r.button||"auto"===e&&n||(s.sceneProxy.curPlotLayer.onChildInputDown.remove(i),"insertPlot"===e?o():a(t))};s.sceneProxy.curPlotLayer.onChildInputDown.dispose(),s.sceneProxy.curPlotLayer.onChildInputDown.add(r),!n&&s.sceneProxy.space_key.onDown.addOnce(function(){return a(t)})}else a(t);else a(t)})}).then(function(e){return $(u.wait.value,e)}).then(function(t){return Promise.all([H(t),F(t),W(u.speaking.animations.filter(function(e){return"animateOut"===e.trigger}))]).then(function(){return s.sceneProxy.doInCT(e,function(){return Promise.resolve(t)})})}).then(function(a){1===a.type?s.showNextPlot(e,t,n,"option",a.index):s.showNextPlot(e,t,n)},function(e){Promise.reject(e)}))};s.sceneProxy.updatePayValue(e,u.values).then(function(t){t===!0?s.sceneProxy.valueOperation(e,u.values,!1,function(){r()}):r()})},l=function(){var r=!1,l=[],h=null;s.sceneProxy.isGoToCommand=!0;var p=function(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new Promise(function(o,i){if(a&&a.shake){var c=a.shake;s.sceneProxy.shakeLoopObj.loop=c.args[0].loop,s.sceneProxy.shakeLoopObj.level=c.args[0].level,s.sceneProxy.shakeLoopObj.duration=c.args[0].duration,s.sceneProxy.shakeLoopObj.delay=c.args[0].delay,s.sceneProxy.shakeLoopObj.commands=c;var m=function V(){
return s.sceneProxy.curPlotLayer.isShaking=!0,x(c.args[0].level?5*c.args[0].level:18,c.args[0].duration,c.args[0].delay).then(function(){return s.sceneProxy.curPlotLayer.isShaking=!1,c.args[0].loop&&c.args[0].level>0&&s.sceneProxy.shakeLoopObj.loop?(c.args[0].delay=0,V()):Promise.resolve()})};m().then(function(){s.sceneProxy.curPlotLayer.isShaking=!1})}if(e.music&&""!==f.ResourcesManager.usingKeyMap.music||s.sceneProxy.stopMusic(),e.music&&(s.viewComponent.game.load.cache.checkSoundKey(e.music.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")){var p=e.music.volume;void 0!==e.music.inheritvolume&&e.music.inheritvolume!==-1&&(p=e.music.inheritvolume),s.sceneProxy.stopMusic(e.music.url),s.sceneProxy.playMusic(e.music.url,p,!0)}for(var y in e.sounds)if(e.sounds[y]&&""!==f.ResourcesManager.usingKeyMap.sounds[y]){if(s.viewComponent.game.load.cache.checkSoundKey(e.sounds[y].url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var v=e.sounds[y].volume;void 0!==e.sounds[y].inheritvolume&&e.sounds[y].inheritvolume!==-1&&(v=e.sounds[y].inheritvolume),s.sceneProxy.stopSound(y,e.sounds[y].url,!0),s.sceneProxy.playSound(y,e.sounds[y].url,v,0===e.sounds[y].time)}}else s.sceneProxy.stopSound(y);!e.bk&&(e.bk={opacity:0}),d=s.sceneProxy.curPlotLayer.create(0,0,e.bk.url),d.alpha=e.bk.opacity,d.width=s.viewComponent.game.world.width,d.height=s.viewComponent.game.world.height,s.viewComponent.addGifAnimation(d,e.bk.url),s.sceneProxy.charsAndPropsLayer&&s.sceneProxy.charsAndPropsLayer.exists||(s.sceneProxy.charsAndPropsLayer=s.viewComponent.game.add.group(),s.sceneProxy.charsAndPropsLayer.name="charactersAndProps");var P=!0,w=!1,b=void 0;try{for(var k,C=e.charsAndProps[Symbol.iterator]();!(P=(k=C.next()).done);P=!0){var _=k.value,S=_.x,I=_.y;_.width=Math.abs(_.width),_.height=Math.abs(_.height),_.pivotX&&_.pivotY&&(_.x-=_.width/2,_.y-=_.height/2);var E=s.viewComponent.addFitImageSprint(_.x,_.y,Math.abs(_.width),_.height,_.url,s.sceneProxy.charsAndPropsLayer,_.index);E.alpha=_.opacity,E.angle=_.rotate,_.pivotX?(E.scale.x=_.scaleX,E.scale.y=_.scaleY,E.x=S,E.y=I,_.mirrorH&&(E.mirrorH=!0),_.mirrorV&&(E.mirrorV=!0)):(_.mirrorH&&(E.angle=-E.angle,E.scale.x=-E.scale.x,E.mirrorH=!0),_.mirrorV&&(E.angle=-E.angle,E.scale.y=-E.scale.y,E.mirrorV=!0)),E.cmdUuid=_.cmdUuid,_.parentScale&&E.parent.scale.setTo(_.parentScale,_.parentScale),s.viewComponent.addGifAnimation(E,_.url)}}catch(T){w=!0,b=T}finally{try{!P&&C["return"]&&C["return"]()}finally{if(w)throw b}}""!==s.sceneProxy.weatherType&&B(e.weatherType),s.sceneProxy.bCmdAutoText=e.autoText,e.dialogInfo[0]&&(n>=t.length||n<t.length&&"showDialog"!==t[n].type)?(L(e.dialogInfo[0]),J(e.dialogInfo[0].speaking,!0)):s.sceneProxy.dialogLayer.visible=!1;var M=function(){return r=!0,s.sceneProxy.bubbleLayer.children.length>0&&s.sceneProxy.bubbleLayer.removeAll(!0),new Promise(function(e,t){var n=function(e){if(s.sceneProxy.saveBubbleVector[e]){var t=s.sceneProxy.saveBubbleVector[e].commands,n=g(t.args[0].index),a=s.addBubbleBorder(s.sceneProxy.bubbleLayer,t);if(n!==-1){var o=s.sceneProxy.saveBubbleVector[n].savebubble.concat(),r=s.sceneProxy.saveBubbleVector[n].curbubble.concat(),i=s.sceneProxy.saveBubbleVector[e].ishide,l=s.sceneProxy.saveBubbleVector[e].iscurrent;s.sceneProxy.saveBubbleVector[n]=a,a.savebubble=o.concat(),a.curbubble=r.concat(),a.ishide=i,a.iscurrent=l,a.itemlength=0,a.visible=a.ishide===!1}else s.sceneProxy.saveBubbleVector.push(a),a.savebubble=[],a.curbubble=[],a.itemlength=0;return a.iscurrent&&(h=a),Promise.resolve(a)}return Promise.reject()},a=function l(e,t){if(t.savebubble[e]){var n=t.savebubble[e];return s.createBubble(n,t).then(function(n){return e++,l(e,t)})}return Promise.resolve()},o=0,r=0,i=function u(t){return n(t).then(function(e){return r=0,a(r,e).then(function(){return t++,u(t)})},function(){return e()})};return i(o)})},O=function(){s.sceneProxy.removeViewTimer(s.sceneProxy.plotViewsLayer),s.sceneProxy.removeInputView(s.sceneProxy.plotViewsLayer),s.sceneProxy.plotViewsLayer.removeAll(!0),s.sceneProxy.filterInexistentPlotViews(e.plotViews,u),s.removeViewKey(s.sceneProxy.plotViewKeys),R(e.plotViews),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer);for(var t in s.sceneProxy.globalViews)if(!s.sceneProxy.globalViews[t].visible)for(var n in s.sceneProxy.json_data.views)if(s.sceneProxy.json_data.views[n].ref===s.sceneProxy.globalViews[t].name){l[t]=s.sceneProxy.json_data.views[n].instanceUuid;break}j(!0,l)},A=function(){e.menuInfo[0]&&(s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=e.menuInfo[0].x,s.sceneProxy.menuLayer.y=e.menuInfo[0].y)};return M().then(function(){return O(),A(),o()})})},g=function(e){if(s.sceneProxy.saveBubbleVector.length>0)for(var t=0;t<s.sceneProxy.saveBubbleVector.length;t++)if(parseInt(s.sceneProxy.saveBubbleVector[t].index)===parseInt(e)&&s.sceneProxy.saveBubbleVector[t])return t;return-1},v=function(){s.sceneProxy.saveBubbleVector.forEach(function(e,t){e.iscurrent=!1})},b=function(a,u){var p={type:""};return s.sceneProxy.curCmdInfo=a,s.sceneProxy.curCmdIndex=u,new Promise(function(b,C){if("systemUI"===a.commands[u].type||"jump"===a.commands[u].type||"back"===a.commands[u].type||"insert"===a.commands[u].type)s.sceneProxy.cmdPlotNextPromise=null;else if("showDialog"===a.commands[u].type){var _=function(e){var t=new Phaser.Pointer(s.viewComponent.game,1,Phaser.PointerMode.CURSOR);t.button=0,s.sceneProxy.curPlotLayer.onChildInputDown.dispatch("nextCmd",t),s.sceneProxy.curPlotLayer.onChildInputDown.dispatch("nextCmd",t),b(e)};s.sceneProxy.cmdPlotNextPromise=_}else s.sceneProxy.cmdPlotNextPromise=b;var I=a.commands,E=I[u].args;s.sceneProxy.curCmdUuid=I[u].uuid;var M=function(){switch(I[u].type){case"addView":if(N(E,null,I[u].uuid),s.sceneProxy.plotViewsLayer.visible=!0,s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer),s.sceneProxy.isScreenHold||s.sceneProxy.quickPlay){s.sceneProxy.isScreenHold=!1,s.sceneProxy.quickPlay=!1,s.sceneProxy.quickPlayLayer.alpha=0;var i=function xe(e,t){t&&t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button||"auto"===e||(s.sceneProxy.quickPlayLayer.alpha=0,s.sceneProxy.curPlotLayer.onChildInputDown.remove(xe),k(s.sceneProxy.curCmdInfo,s.sceneProxy.curCmdIndex+1))};return s.sceneProxy.curPlotLayer.onChildInputDown.dispose(),s.sceneProxy.curPlotLayer.onChildInputDown.add(i),s.sceneProxy.space_key.onDown.addOnce(function(){k(s.sceneProxy.curCmdInfo,s.sceneProxy.curCmdIndex+1)}),{v:C()}}break;case"delView":s.destroyView(E[0]);break;case"systemUI":if("save-record"===E[0]){var _=s.sceneProxy.context.disableSaveOrLoad;return _&&_.save?(s.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用存档"),{v:b(p)}):(!s.sceneProxy.mainMenuLayer.visible&&s.sceneProxy.getSnap(),s.sceneProxy.showSave(!1,{callbackFun:b,callbackArgs:p}),{v:void 0})}if("load-record"===E[0]){var M=s.sceneProxy.context.disableSaveOrLoad;return M&&M.load?(s.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用读档"),{v:b(p)}):(s.sceneProxy.showLoad(!1,{callbackFun:b,callbackArgs:p}),{v:void 0})}if("settings"===E[0])return s.sceneProxy.showSettings(e,{callbackFun:b,callbackArgs:p}),{v:void 0};if("playback"===E[0])return s.sceneProxy.showPlayback({callbackFun:b,callbackArgs:p}),{v:void 0};case"addImage":if(1===E[0].index){var A="inherit"===E[0].url,R=A?s.sceneProxy.lstPlotBkKey:E[0].url,D=A?s.sceneProxy.lstPlotBkFlex:E[0].flex,F=A?s.sceneProxy.lstPlotBkOpacity:E[0].opacity;if(s.viewComponent.game.load.cache.checkImageKey(R)){var U=s.sceneProxy.curPlotLayer.children.splice(1,1);U.length&&U[0].destroy(),d=s.sceneProxy.curPlotLayer.create(E[0].x,E[0].y,R),d.alpha=void 0===F?1:F,s.backgroundFlex(d,D),s.sceneProxy.lstGameBk&&s.sceneProxy.lstGameBk.visible&&(s.sceneProxy.lstGameBk.visible=!1),s.sceneProxy.prePlotBkKey=s.sceneProxy.lstPlotBkKey,s.sceneProxy.lstPlotBkKey=R,s.sceneProxy.lstPlotBkOpacity=F,s.sceneProxy.lstPlotBkFlex=D,s.viewComponent.addGifAnimation(d,E[0].url)}}else O(E,[],I[u].uuid);s.viewComponent.game.world.bringToTop(s.sceneProxy.bubbleLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),j(!1,l),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer),s.sceneProxy.isScreenHold&&s.viewComponent.game.world.bringToTop(s.sceneProxy.quickPlayLayer);break;case"delImage":if(1===E[0]){var W=s.sceneProxy.curPlotLayer.children.splice(1,1);W.length&&W[0].destroy()}else for(var G=0;G<s.sceneProxy.charsAndPropsLayer.children.length;G++){var H=s.sceneProxy.charsAndPropsLayer.getAt(G);if(-1===H)break;if(H.zIndex===E[0]){s.sceneProxy.charsAndPropsLayer.removeChildAt(G),H.destroy();break}}break;case"showMenu":s.sceneProxy.menuInfo=E.concat(),s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=E[0].x,s.sceneProxy.menuLayer.y=E[0].y;break;case"hideMenu":s.sceneProxy.menuInfo=[],s.sceneProxy.menuLayer.visible=!1;break;case"showGlobalView":for(var z=0;z<l.length;z++)if(l[z]===E[0]){l.splice(z,1);break}j(!1,l);break;case"hideGlobalView":for(var K=0;K<l.length&&l[K]!==E[0];K++);K>=l.length&&(l[K]=E[0]),j(!1,l);break;case"showDialog":return s.sceneProxy.lstDialogInfo=E.concat(),s.sceneProxy.dialogLayer.animateTweens.forEach(function(e,t){e.stop()}),s.sceneProxy.dialogLayer.animateTweens.splice(0),Y(E[0]),{v:L(E[0]).then(function(){return E[0].speaking.coverage&&"bottom"===E[0].speaking.coverage?(s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.bubbleLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer),s.sceneProxy.dialogLayer.isbottom=!0):(s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer),s.sceneProxy.dialogLayer.isbottom=!1),E[0].speaking.animations&&E[0].speaking.animations.length>0&&(s.sceneProxy.dialogLayer.visible=!0),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),j(!1,l),J(E[0].speaking)}).then(function(){var e=s.sceneProxy.plotViewsLayer.children.length>0,t=s.sceneProxy.bubbleLayer.children.length>0;if((s.sceneProxy.bCmdAutoText||!e&&(s.sceneProxy.quickPlay||s.sceneProxy.context.auto))&&!s.sceneProxy.playPause)return b(p);var n=function a(t,n){if(!(n&&n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||"auto"===t&&e))return s.sceneProxy.curPlotLayer.onChildInputDown.remove(a),"insertPlot"===t?C():b(p)};s.sceneProxy.curPlotLayer.onChildInputDown.dispose(),s.sceneProxy.curPlotLayer.onChildInputDown.add(n),t&&(s.sceneProxy.dialogNext=function(){return s.sceneProxy.dialogNext=null,b(p)}),!e&&s.sceneProxy.space_key.onDown.addOnce(function(){return b(p)})})};case"hideDialog":s.sceneProxy.lstDialogInfo=[],s.sceneProxy.dialogLayer.visible=!1;break;case"playMusic":T(E[0]);break;case"stopMusic":s.sceneProxy.stopMusic();break;case"playSound":if("inherit"===E[0].url){s.sceneProxy.plotSounds[E[0].index]&&s.sceneProxy.playInheritSound(E[0].index,E[0].volume);break}(s.viewComponent.game.load.cache.checkSoundKey(E[0].url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&(s.sceneProxy.stopSound(E[0].index,E[0].url),s.sceneProxy.playSound(E[0].index,E[0].url,E[0].volume,0===E[0].time));break;case"stopSound":s.sceneProxy.stopSound(E[0]);break;case"animateImage":if(s.sceneProxy.dialogLayer.visible!==!1){var q=s.viewComponent.game.world.getChildIndex(s.sceneProxy.dialogLayer),Q=s.viewComponent.game.world.getChildIndex(s.sceneProxy.charsAndPropsLayer);q<Q&&!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer)}s.sceneProxy.menuLayer.visible!==!1&&s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);var X=s.sceneProxy.quickPlay?0:E[0].delay,Z=s.sceneProxy.quickPlay?0:E[0].duration;if(E[0].index>1&&s.sceneProxy.charsAndPropsLayer.exists)for(var ee=function(e){var t=s.sceneProxy.charsAndPropsLayer.children[e];if(t.zIndex===E[0].index){var n=t.children[0],a=function(){t.animateTweens&&(t.animateTweens.forEach(function(e,t){e.stop(!1)}),t.animateTweens.splice(0)),n.animateTweens&&(n.animateTweens.forEach(function(e,t){e.stop(!1)}),n.animateTweens.splice(0)),n.finalState&&(n.alpha=n.finalState.alpha,n.angle=n.finalState.angle,n.x=n.finalState.x,n.y=n.finalState.y,t.x=0,t.y=0,t.scale.x=t.finalState.scale.x,t.scale.y=t.finalState.scale.y);var e=E[0].opacity,a=180===parseInt(E[0].rotate)?179.9:E[0].rotate,o=void 0===E[0].scaleX?1:E[0].scaleX,r=void 0===E[0].scaleY?1:E[0].scaleY,i=E[0].x/o+n.width/2,l=E[0].y/r+n.height/2;if(n.mirrorH&&(a=-a,i-=n.width),n.mirrorV&&(a=-a,l-=n.height),(!n.lstAlpha&&n.alpha!==e||n.lstAlpha!==e)&&(n.lstAlpha=e,s.tweenToPromise(n,{alpha:e},Z,null,!0,X)),(!n.lstAngle&&n.angle!==a||n.lstAngle!==a)&&(n.lstAngle=a,s.tweenToPromise(n,{angle:a},Z,null,!0,X)),!n.lstX&&n.x!==i||n.lstX!==i){n.lstX=i;var u=n.mirrorH?(n.x+n.width/2)*t.scale.x:(n.x-n.width/2)*t.scale.x,c=E[0].x-u*(o/t.scale.x);s.tweenToPromise(t,{x:c},Z,null,!0,X).then(function(){t.x=0,n.x=n.lstX})}if(!n.lstY&&n.y!==l||n.lstY!==l){n.lstY=l;var d=n.mirrorV?(n.y+n.height/2)*t.scale.y:(n.y-n.height/2)*t.scale.y,h=E[0].y-d*(r/t.scale.y);s.tweenToPromise(t,{y:h},Z,null,!0,X).then(function(){t.y=0,n.y=n.lstY})}n.finalState={alpha:e,angle:a,x:i,y:l},(!t.lstScaleX&&t.scale.x!==o||t.lstScaleX!==o)&&(t.lstScaleX=o,s.tweenToPromise(t.scale,{x:o},Z,null,!0,X)),(!t.lstScaleY&&t.scale.y!==r||t.lstScaleY!==r)&&(t.lstScaleY=r,s.tweenToPromise(t.scale,{y:r},Z,null,!0,X)),t.finalState={scale:{x:o,y:r}}};return a(),"break"}},te=0;te<s.sceneProxy.charsAndPropsLayer.children.length;te++){var ne=ee(te);if("break"===ne)break}else 1===E[0].index&&s.sceneProxy.curPlotLayer.children[1]&&(s.tweenToPromise(s.sceneProxy.curPlotLayer.children[1],{alpha:E[0].opacity},Z,null,!0,X),s.sceneProxy.curPlotLayer.children[1].finalState={alpha:E[0].opacity},s.sceneProxy.lstPlotBkOpacity=E[0].opacity);break;case"animateDialog":if(s.sceneProxy.dialogLayer.visible){var ae=s.sceneProxy.quickPlay?0:E[0].delay,oe=s.sceneProxy.quickPlay?0:E[0].duration,re=function(){var e={alpha:E[0].opacity,angle:E[0].rotate,x:parseFloat(E[0].x),y:parseFloat(E[0].y)};return s.sceneProxy.lstDialogInfo[0]&&(s.sceneProxy.lstDialogInfo[0].opacity=E[0].opacity,s.sceneProxy.lstDialogInfo[0].rotate=E[0].rotate,s.sceneProxy.lstDialogInfo[0].x=E[0].x,s.sceneProxy.lstDialogInfo[0].y=E[0].y),s.tweenToPromise(s.sceneProxy.dialogLayer,e,oe,null,!0,ae).then(function(){s.sceneProxy.dialogLayer.visible=!0,!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer)})},ie=function(){return s.tweenToPromise(s.sceneProxy.dialogLayer.scale,{x:E[0].scaleX,y:E[0].scaleY},oe,null,!0,ae).then(function(){s.sceneProxy.dialogLayer.visible=!0,!s.sceneProxy.dialogLayer.isbottom&&s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer)})};re()&&ie()}break;case"animateScene":if(!s.sceneProxy.quickPlay){if("twinkle"===E[0].type&&w(E[0].duration,E[0].delay,E[0].color),"shake"===E[0].type){var se=E[0].loop&&E[0].loop||!1;if(se&&!s.sceneProxy.shakeLoopObj.loop||s.sceneProxy.curPlotLayer.isShaking!==!0||P(),s.sceneProxy.shakeLoopObj.loop=se,s.sceneProxy.shakeLoopObj.level=E[0].level,s.sceneProxy.shakeLoopObj.duration=E[0].duration,s.sceneProxy.shakeLoopObj.delay=E[0].delay,s.sceneProxy.shakeLoopObj.commands=I[u],!s.sceneProxy.curPlotLayer.isShaking&&E[0].duration){var le=function Pe(){return s.sceneProxy.curPlotLayer.isShaking=!0,x(E[0].level?5*E[0].level:18,E[0].duration,E[0].delay).then(function(){return s.sceneProxy.curPlotLayer.isShaking=!1,s.sceneProxy.shakeLoopObj.loop&&E[0].level>0?(E[0].level!==s.sceneProxy.shakeLoopObj.level&&(E[0].level=s.sceneProxy.shakeLoopObj.level),E[0].duration!==s.sceneProxy.shakeLoopObj.duration&&(E[0].duration=s.sceneProxy.shakeLoopObj.duration),E[0].delay=0,Pe()):Promise.resolve()})};le().then(function(){s.sceneProxy.curPlotLayer.isShaking=!1})}}"spread"===E[0].type&&!s.sceneProxy.curPlotLayer.isSpreading&&S(E[0].duration,E[0].delay)}break;case"animateMusic":s.sceneProxy.bk_music&&(s.sceneProxy.bk_music.prevolume=E[0].volume,s.sceneProxy.bk_music.inheritvolume=E[0].volume),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(y["default"].musicInfo&&(y["default"].musicInfo.inheritvolume=E[0].volume,y["default"].musicInfo.prevolume=E[0].volume),E[0].volume*=m["default"].musicVolume,y["default"].tweenToMusic(E[0].volume,E[0].duration,E[0].delay)):(E[0].volume*=m["default"].musicVolume,s.sceneProxy.bk_music&&(s.sceneProxy.bk_music.animateMusic="music",s.tweenToPromise(s.sceneProxy.bk_music,{volume:E[0].volume},E[0].duration,null,!0,E[0].delay).then(function(){})));break;case"animateSound":s.sceneProxy.plotSounds[E[0].index]&&(s.sceneProxy.plotSounds[E[0].index].prevolume=E[0].volume,s.sceneProxy.plotSounds[E[0].index].inheritvolume=E[0].volume),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(y["default"].soundsInfo[E[0].index]&&(y["default"].soundsInfo[E[0].index].prevolume=E[0].volume,y["default"].soundsInfo[E[0].index].inheritvolume=E[0].volume),E[0].volume*=m["default"].soundVolume,y["default"].tweenToSound(E[0].index,E[0].volume,E[0].duration,E[0].delay)):(E[0].volume*=m["default"].soundVolume,s.sceneProxy.plotSounds[E[0].index]&&(s.sceneProxy.plotSounds[E[0].index].animateMusic="sound",s.tweenToPromise(s.sceneProxy.plotSounds[E[0].index],{volume:E[0].volume},E[0].duration,null,!0,E[0].delay).then(function(){s.sceneProxy.plotSounds[E[0].index].volume=s.sceneProxy.plotSounds[E[0].index].prevolume*m["default"].soundVolume})));break;case"setValues":s.sceneProxy.updatePayValue(e,E).then(function(t){return t!==!0?b(p):void s.sceneProxy.valueOperation(e,E,!1,function(){return b(p)})});break;case"wait":return s.sceneProxy.quickPlay&&s.sceneProxy.preWaitCmdUuid!==I[u].uuid?(s.sceneProxy.preWaitCmdUuid=I[u].uuid,{v:b(p)}):{v:$(E[0].value,{type:0}).then(function(){return s.sceneProxy.curCmdInfo!==a?(t={},Object.assign(t,s.sceneProxy.curChapter),n=s.sceneProxy.curPlotIndex,a={},Object.assign(a,s.sceneProxy.curCmdInfo),u=s.sceneProxy.curCmdIndex,b(!1)):b(p)})};case"jump":return s.sceneProxy.context=JSON.parse(JSON.stringify(s.sceneProxy.context)),s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"jump",E[0]),{v:b(!1)};case"back":return s.sceneProxy.context=JSON.parse(JSON.stringify(s.sceneProxy.context)),s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"back"),{v:b(!1)};case"insert":return s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"insertPlot",E[0]),{v:b(!1)};case"options":return r=!1,s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.exists||(s.sceneProxy.optionLayer=s.viewComponent.game.add.group()),s.viewComponent.game.world.bringToTop(s.sceneProxy.optionLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),j(!1,l),s.sceneProxy.isScreenHold&&s.viewComponent.game.world.bringToTop(s.sceneProxy.quickPlayLayer),{v:m["default"].timeout(200).then(function(){return V(E,null).then(function(e){return p.type="options",p.index=e.index,f.ResourcesManager.resetCmdPOptionPreload(I,u,p.index),b(p)})})};case"conditionOptions":return r=!1,s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.exists||(s.sceneProxy.optionLayer=s.viewComponent.game.add.group()),{v:V([],E).then(function(e){return 2===e.type&&(p.type="cdtOptions"),f.ResourcesManager.resetCmdPOptionPreload(I,u,2===e.type?e.index:-1),b(p)})};case"backOption":p.type="backOption",p.eArg=s.sceneProxy.Expression.safeEval(a.commands[u].args[0],e);break;case"jumpOption":p.type="jumpOption",p.eArg=s.sceneProxy.Expression.safeEval(a.commands[u].args[0],e);break;case"autoSaveOrLoad":if(s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad){if(1===E[0].type)return s.sceneProxy.loadRecord(E[0].index)?{v:Promise.resolve(-1)}:{v:c["default"].warn("Sorry~读不到存档内容，即将返回封面").then(function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend()),Promise.resolve(-1)},function(){return s.sceneProxy.reStart(s.sceneProxy.isExtend()),Promise.resolve(-1)})};0===E[0].type&&(s.sceneProxy.getSnap(),s.sceneProxy.saveRecord(E[0].index,!0))}break;case"autotext":s.sceneProxy.bCmdAutoText=E[0];break;case"weather":"none"===E[0]?s.sceneProxy.weatherLayer.visible=!1:B(E[0]);break;case"disableSaveOrLoad":s.sceneProxy.context.disableSaveOrLoad=E[0];break;case"showBubble":var ue=g(E[0].index);if(s.sceneProxy.clearBubbleData(ue),ue=g(E[0].index),v(),ue!==-1){var ce=s.sceneProxy.saveBubbleVector[ue].savebubble.concat();s.sceneProxy.bubbleLayer.removeChild(s.sceneProxy.saveBubbleVector[ue]),s.sceneProxy.saveBubbleVector[ue].destroy();var de=s.addBubbleBorder(s.sceneProxy.bubbleLayer,I[u]);s.sceneProxy.saveBubbleVector.splice(ue,1),s.sceneProxy.saveBubbleVector.push(de),de.savebubble=ce.concat(),de.visible=!0,de.itemlength=0,de.iscurrent=!0,h=de;var he=function we(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e>=h.savebubble.length?Promise.resolve():s.createBubble(h.savebubble[e],h).then(function(t){return e++,we(e)})};return{v:he().then(function(){return j(!1,l),b(p)})}}var fe=s.addBubbleBorder(s.sceneProxy.bubbleLayer,I[u]);return s.sceneProxy.saveBubbleVector.push(fe),fe.iscurrent=!0,h=fe,j(!1,l),{v:b(p)};case"emitBubble":if(h.ishide===!0){var me=function(){for(var e=s.sceneProxy.saveBubbleVector.length-1;e>=0;e--){var t=s.sceneProxy.saveBubbleVector[e];if(t&&t.ishide!==!0)return v(),t.iscurrent=!0,t}return null},pe=me();pe&&(h=pe)}var ye=s.sceneProxy.plotViewsLayer.children.length>0,ge=function(e){var t=function n(t,a){if(!(a&&a.pointerMode===Phaser.PointerMode.CURSOR&&0!==a.button||"auto"===t&&ye))return s.sceneProxy.curPlotLayer.onChildInputDown.remove(n),"insertPlot"===t?C():b(e?e:p)};s.sceneProxy.curPlotLayer.onChildInputDown.add(t),!ye&&s.sceneProxy.space_key.onDown.addOnce(function(){return b(p)})};return o&&r?(ge(p),h.gonext=function(e){return e&&e!==h?void(h.gonext&&h.gonext()):b(p)},r=!1,{v:void 0}):(s.viewComponent.game.world.bringToTop(s.sceneProxy.bubbleLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),j(!1,l),s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer),s.sceneProxy.isScreenHold&&s.viewComponent.game.world.bringToTop(s.sceneProxy.quickPlayLayer),s.sceneProxy.bubbleLayer.animateTweens.forEach(function(e,t){e.stop(!0)}),s.sceneProxy.bubbleLayer.animateTweens.splice(0),{v:s.createBubble(I[u],h).then(function(e){s.sceneProxy.bubbleArchivalCount.push(I[u].uuid),h.savebubble.push(I[u]),h.curbubble.push(I[u]);var t=function(){return new Promise(function(t,n){return E[0].animation?"fadein"===E[0].animation.type?s.tweenFromPromise(e,{alpha:0},E[0].animation.duration,null,!0,E[0].animation.delay).then(function(){return e.alpha=1,t()}):void 0:t()})};return h.gonext=function(e){if(e&&e!==h)h.gonext&&h.gonext();else if(!s.sceneProxy.bCmdAutoText&&(ye||!s.sceneProxy.quickPlay&&!s.sceneProxy.context.auto)||s.sceneProxy.playPause)return b(p)},(!s.sceneProxy.bCmdAutoText&&(ye||!s.sceneProxy.quickPlay&&!s.sceneProxy.context.auto)||s.sceneProxy.playPause)&&ge(),t().then(function(){!s.sceneProxy.bCmdAutoText&&(ye||!s.sceneProxy.quickPlay&&!s.sceneProxy.context.auto)||s.sceneProxy.playPause?ge(p):setTimeout(function(){return b(p)},1e3)})})});case"hideBubble":var ve=g(E[0]);ve!==-1&&(s.sceneProxy.saveBubbleVector[ve].visible=!1,s.sceneProxy.saveBubbleVector[ve].ishide=!0)}}();return"object"===("undefined"==typeof M?"undefined":i(M))?M.v:"setValues"!==I[u].type?b(p):void 0})},k=function E(a,o){return s.cmdPlotLoadResources(e,t,n,a,o).then(function(){return b(a,o).then(function(r){if(s.sceneProxy.cmdPlotNextPromise=null,r&&e===s.sceneProxy.context&&s.sceneProxy.isGoToCommand!==!1){var i=s.sceneProxy.getNextCommand(e,a,o,r),l=i.info,u=i.index;l&&l.commands[u]?E(l,u):s.showNextPlot(e,t,n)}})})};s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer,f.ResourcesManager.updateUsingKey({type:"preBackground",key:s.sceneProxy.lstPlotBkKey}),s.sceneProxy.bCmdAutoText=!1,s.sceneProxy.lstDialogInfo=[],s.sceneProxy.cmdPlayHandlerFun=k,M(s.sceneProxy.curPlotLayer);var C={commands:u.commands,parentInfo:null,parentCmdIndex:-1},_=0,I=function(){s.addMenuLayer(!!s.sceneProxy.json_data.template.json.shanyiMenu),C&&C.commands[_]?k(C,_):s.showNextPlot(e,t,n)};a&&a.cmdInfo?(s.sceneProxy.context.disableSaveOrLoad=u.disableSaveOrLoad?u.disableSaveOrLoad:s.sceneProxy.context.disableSaveOrLoad,C=a.cmdInfo,_=a.cmdIndex,C.commands[_]&&"systemUI"===C.commands[_].type&&_++,C.commands[_]&&"autoSaveOrLoad"===C.commands[_].type&&_++,p(a.cmdScreenSnap,C.commands,_,a.animateScene?a.animateScene:null).then(function(){if(r=!0,!C.commands[_]){var t=s.sceneProxy.getNextCommand(e,C,_-1,{type:"insert"}),n=t.info,a=t.index;C=n,_=a}I()})):(s.sceneProxy.context.disableSaveOrLoad=u.disableSaveOrLoad?u.disableSaveOrLoad:{save:!1,load:!1},I())};if(s.sceneProxy.isGettingNext=!1,s.sceneProxy.curPlotLayer=s.viewComponent.game.add.group(),s.sceneProxy.curPlotLayer.inputEnableChildren=!0,s.sceneProxy.curPlotLayer.isShaking=!1,s.sceneProxy.curPlotLayer.isSpreading=!1,s.sceneProxy.curPlotLayer.name="plotLayer",s.sceneProxy.charsAndPropsLayer&&s.sceneProxy.charsAndPropsLayer.destroy(),s.sceneProxy.charsAndPropsLayer=s.viewComponent.game.add.group(),s.sceneProxy.charsAndPropsLayer.name="charactersAndProps",s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.destroy(),s.sceneProxy.optionLayer=s.viewComponent.game.add.group(),s.viewComponent.game.world.bringToTop(s.sceneProxy.curPlotLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),P(),o||(s.sceneProxy.removeViewTimer(s.sceneProxy.plotViewsLayer),s.sceneProxy.removeInputView(s.sceneProxy.plotViewsLayer),s.sceneProxy.plotViewsLayer.removeAll(!0),s.sceneProxy.plotViews.splice(0,s.sceneProxy.plotViews.length),s.removeViewKey(s.sceneProxy.plotViewKeys)),(o||a&&a.cmdInfo)&&s.sceneProxy.saveBubbleDataVector.length>0){s.sceneProxy.saveBubbleVector=[];for(var h=0;h<s.sceneProxy.saveBubbleDataVector.length;h++){var p=s.sceneProxy.saveBubbleDataVector[h].bubbleMode,g=s.addBubbleBorder(null,p);g.savebubble=s.sceneProxy.saveBubbleDataVector[h].bubble.concat(),g.curbubble=s.sceneProxy.saveBubbleDataVector[h].curbubble.concat(),g.ishide=s.sceneProxy.saveBubbleDataVector[h].ishide,g.iscurrent=s.sceneProxy.saveBubbleDataVector[h].iscurrent,s.sceneProxy.saveBubbleVector.push(g)}s.sceneProxy.saveBubbleDataVector=[]}s.sceneProxy.curPlotInfo=u,s.sceneProxy.curChapter=t,s.sceneProxy.curPlotIndex=n,u.commands?l():r()};Q(),this.sceneProxy.isScreenHold&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},endPlot:function(e){var t=this;this.sceneProxy.saveBubbleVector.forEach(function(n,a){t.sceneProxy.clearBubbleData(a),!e&&(n.ishide=!0)}),this.sceneProxy.bubbleLayer.children.length>0&&this.sceneProxy.bubbleLayer.removeAll(!0),this.sceneProxy.coverLayer.visible=!1,this.viewComponent.game.input.onDown.removeAll(),this.sceneProxy.dialogLayer.visible=!1,this.sceneProxy.menuLayer.visible=!1,this.sceneProxy.space_key.onDown.removeAll(),this.sceneProxy.plotViews.splice(0,this.sceneProxy.plotViews.length),this.sceneProxy.removePlotTweens()},showNextPlot:function(e,t,n,a,o){var i=this,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this.sceneProxy.isGoToCommand=!1;var l=e.stack,u=this.sceneProxy.getNextPlot(e,t,n,a,o,s),d=u.chapter,h=u.nIndex,m=u.cmdPlotSnap,p=u.context,y=u.preStackFrame,g=u.preCmdStackFrame,v=function(){if(h.length>=36){var s=-2,u=function(e){return d.plots.find(function(t,n){t.uuid===e&&(s=n)}),s};h=u(h)}if(!d.plots[h]){if(h===-2)return i.endPlot(),i.sceneProxy.reStart(i.sceneProxy.isExtend());if(!(h<-2))return 0===h?(i.endPlot(m&&m.cmdInfo),void i.showNextPlot(e,d,h)):(i.sceneProxy.dialogLayer.visible=!0,i.sceneProxy.menuLayer.visible=!0,i.gameOver());y&&(p.stack=[y].concat(r(p.stack)),g&&(p.cmdStack=[g].concat(r(p.cmdStack))));var c=i.sceneProxy.getNextPlot(e,t,n,a,o),v=c.chapter,x=c.nIndex,P=c.cmdPlotSnap,w=c.context,b=c.preStackFrame,k=c.preCmdStackFrame;if(d=v,h=x,m=P,p=w,y=b,g=k,i.endPlot(m&&m.cmdInfo),h<-2)return y&&(e.stack=[y].concat(r(p.stack)),g&&(p.cmdStack=[g].concat(r(p.cmdStack)))),i.showNextPlot(e,t,n,a,o)}i.endPlot(m&&m.cmdInfo);var C=null,_=null,S=null;if(l!==p.stack){var I=p.stack[0]||{},L=I.type,E=I.index;"options"===L||"condition_options"===L?(C=L,_=E):"insert"===L?S="insert":p.stack.length||h||(S="jump")}if(f.ResourcesManager.resetPlotOptionPreload(t.plots[n],C,_),f.ResourcesManager.clearPrePlotResources(t.plots,n),"jump"!==S&&"insert"!==S||("jump"===S?f.ResourcesManager.resetJumpPreload(d):f.ResourcesManager.resetInsertPreload(d)),i.sceneProxy.isPlotResourceExist(d.plots[h])){var T=i.sceneProxy.getLoadingPlotResource(d.plots[h]);T.length?i.assetsLoader(T,!0,!0).then(function(){return i.showPlot(p,d,h,m)}):i.showPlot(p,d,h,m)}else i.sceneProxy.preloadChapterAssets(p,d,h,m)},x=function(){if(i.endPlot(),0===n)i.showPlot(e,t,0);else{y&&(c.stack=[y].concat(r(c.stack)),g&&(c.cmdStack=[g].concat(r(c.cmdStack))));var a=i.sceneProxy.getNextPlot(e,t,n-1,"",o),s=a.chapter,l=a.nIndex,u=a.cmdPlotSnap,c=a.context;i.sceneProxy.preloadChapterAssets(c,s,l,u)}};if(this.sceneProxy.isGettingNext=!0,this.sceneProxy.shakeLoopObj.loop=!1,d.md5&&0===d.plots.length){this.sceneProxy.isPreferentialFinished=!1;var P=d.downloadUuid?d.downloadUuid:d.uuid;if(this.sceneProxy.isWapOther()){var w=function(e){null===e?c["default"].error("获取付费章节信息失败").then(function(){x()},function(){x()}):"fail"===e?c["default"].custom("Error","仍未查询到您的支付信息哦，请确认已经支付~ 如有疑问请添加闪艺客服QQ：819786897 ~","提示","复制QQ","取消",!1).then(function(){(0,b["default"])("819786897",{debug:!1,message:"复制成功"}),x()},function(){x()}):(d.plots=e?e:[],v())};return void this.sceneProxy.unlockChapterByWapOther(P,d.charge,d.md5,w)}if(!d.charge||"android"!==flashvars.client&&"ios"!==flashvars.client&&"wap"!==flashvars.client)this.sceneProxy.checkIfChapterFree(P,d.md5).then(function(e){var t;(t=d.plots).push.apply(t,r(e)),v()},function(e){-1===e.indexOf("code=87")?c["default"].error(e):"zxwwap"===flashvars.wap?c["default"].info("当前为收费章节，是否前往闪艺抢先体验？").then(function(){window.location.href="https://wap.3000.com/?m=detail&op=index&ac=index&id="+flashvars.gid},function(){x()}):c["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买").then(function(){return x()},function(){return v()})});else{var k=function(){var e=function(e,t){e?i.sceneProxy.checkIfChapterFree(P,d.md5).then(function(e){var t;i.sceneProxy.unlockChapterCallBack=null,(t=d.plots).push.apply(t,r(e)),v()},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():c["default"].error("获取付费章节信息失败"),x()}):t?x():(c["default"].error("章节解锁失败"),v())};i.sceneProxy.unlockChapter(P,d.charge,d.md5,e)};""!==flashvars.uid&&"wap"===flashvars.client?this.sceneProxy.checkIfChapterFree(P,d.md5).then(function(e){var t;i.sceneProxy.unlockChapterCallBack=null,(t=d.plots).push.apply(t,r(e)),v()},function(){k()}):k()}}else{if(("android"===flashvars.client||"ios"===flashvars.client)&&d.charge){var C=d.downloadUuid?d.downloadUuid:d.uuid,_=function(e){for(var t=0;t<i.sceneProxy.preferentialVector.length;t++)if(e===i.sceneProxy.preferentialVector[t])return!0;return!1};if(this.sceneProxy.isPreferentialFinished!==!1||_(C)){var S=function(){var e=function(e,t){e?i.sceneProxy.checkIfChapterFree(C,d.md5).then(function(e){i.sceneProxy.isPreferentialFinished=!1,i.sceneProxy.dislodgePreferentVector(C),i.sceneProxy.unlockChapterCallBack=null,d.plots=e,v()},function(){"wap"===flashvars.client?window.parent&&window.parent.playLogin():c["default"].error("获取付费章节信息失败"),x()}):t?x():(c["default"].error("章节解锁失败"),v())};i.sceneProxy.unlockChapter(C,d.charge,d.md5,e)};return void this.sceneProxy.checkIfChapterFree(C,d.md5).then(function(e){i.sceneProxy.dislodgePreferentVector(C),v()},function(e){i.sceneProxy.isPreferentialFinished!==!1?c["default"].custom("Info","作品限免已结束，需要付费才能继续观看哦","限免提示","取消","去支付",!0).then(function(){x()},function(e){"cancel"===e?S():"close"===e&&x()}):_(C)&&S()})}}v()}},gameOver:function(){this.sceneProxy.showEnd()},onRegister:function(){this.setViewComponent(new diygamePlayer.view.component.Scene);
var e=this;this.viewComponent.onRendered=function(){e.viewComponent.sceneProxy=e.sceneProxy,e.facade.registerMediator(new diygamePlayer.view.mediator.CoverMediator),e.facade.registerMediator(new diygamePlayer.view.mediator.SettingsMediator),e.facade.registerMediator(new diygamePlayer.view.mediator.MainMenuMediator),e.facade.registerMediator(new diygamePlayer.view.mediator.RecordMediator),e.facade.registerMediator(new diygamePlayer.view.mediator.PlaybackMediator),e.facade.registerMediator(new diygamePlayer.view.mediator.EndMediator),e.sceneProxy.preloadingBegin()},this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME)},onRemove:function(){this.setViewComponent(null)},curChapter:null},{NAME:"SceneMediator"})}),require.register("js/view/mediator/SettingsMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i),l=t("../../common/Utils.js"),u=a(l);r["default"].define({name:"diygamePlayer.view.mediator.SettingsMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS]},handleNotification:function(e){var t=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS:this.callbackInfo=t.callbackInfo,this.showSettingsLayer(t.context)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},fullMode:function c(){var e=this.sceneProxy.json_data.template.json.settings,c=e.fullMode,t=e.windowMode,n=this.sceneProxy.settingsLayer.getByName("settings_button_fullMode"),a=this.sceneProxy.settingsLayer.getByName("settings_button_windowMode");n&&n.changeBackground(c.checked.background.url,c.checked.text),a&&a.changeBackground(t.unchecked.background.url,t.unchecked.text)},windowMode:function d(){var e=this.sceneProxy.json_data.template.json.settings,t=e.fullMode,d=e.windowMode,n=this.sceneProxy.settingsLayer.getByName("settings_button_fullMode"),a=this.sceneProxy.settingsLayer.getByName("settings_button_windowMode");n&&n.changeBackground(t.unchecked.background.url,t.unchecked.text),a&&a.changeBackground(d.checked.background.url,d.checked.text)},autoOn:function h(){var e=this.sceneProxy.json_data.template.json.settings,h=e.autoOn,t=e.autoOff,n=this.sceneProxy.settingsLayer.getByName("settings_button_autoOn"),a=this.sceneProxy.settingsLayer.getByName("settings_button_autoOff");n&&n.changeBackground(h.checked.background.url,h.checked.text),a&&a.changeBackground(t.unchecked.background.url,t.unchecked.text)},autoOff:function f(){var e=this.sceneProxy.json_data.template.json.settings,t=e.autoOn,f=e.autoOff,n=this.sceneProxy.settingsLayer.getByName("settings_button_autoOn"),a=this.sceneProxy.settingsLayer.getByName("settings_button_autoOff");n&&n.changeBackground(t.unchecked.background.url,t.unchecked.text),a&&a.changeBackground(f.checked.background.url,f.checked.text)},updateVolumeProgress:function(e,t){var n=this.sceneProxy.settingsLayer.getByName(e+"progGroup");if(n){var a=n.getByName("pk"),o=n.getByName("progbk"),r=o.width;t<=0?a.width=.01:a.width=t*r}},addSettings:function(){var e=this,t=this.sceneProxy.json_data.template.json.settings,n=t.background,a=t.header,o=t.displayHeader,r=t.textHeader,i=t.displayCaption,l=t.textCaption,u=t.fullMode,c=t.windowMode,d=t.autoOn,h=t.autoOff,f=t.back,m=function(t,n,a,o,r){var i=e.game.add.group();i.x=o.x,i.y=o.y,i.name=t+"progGroup",e.sceneProxy.settingsLayer.add(i);var s=e.game.load.cache.checkImageKey(n)?n:"",l=e.game.load.cache.checkImageKey(a)?a:"",u=e.game.add.image(0,0,s,null,i);u.width=o.width,u.height=o.height,u.name="progbk";var c=e.game.add.image(0,0,l,null,i);c.width=o.width,c.height=o.height,c.name="progpk";var d=e.game.add.graphics(0,0);d.beginFill(16773120,.5),d.drawRect(0,0,o.width,o.height),d.endFill(),d.name="pk",i.add(d),c.mask=d;var h=!1;u.inputEnabled=!0;var f=u.width,m=0;e.game.time.events.stop(!1);var p=function(e){e<=0?d.width=.01:d.width=e*f};u.events.onInputDown.add(function(t,n){h=!0,m=(n.x-o.x)/f,p(m),e.game.time.events.start()},e),e.game.time.events.loop(10,function(){h&&(m=(e.game.input.x-o.x)/f,m<=0&&(m=0),m>=1&&(m=1),p(m))},e),e.game.input.onUp.add(function(){h&&(r&&r(m),e.game.time.events.stop(!1)),h=!1},e)},p=function(t,n,a){var o=e.game.load.cache.checkImageKey(t)?t:"",r=e.sceneProxy.settingsLayer.create(n.x,n.y,o);r.width=n.width,r.height=n.height,r.name=a},y=function(t,n,a,o,r,i,l){var u={},c="";c+=i.fontWeight?i.fontWeight+" ":"normal ",c+=i.fontSize?parseInt(i.fontSize)+"px ":"",c+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",u.font=c,u.fill=i.color,u.boundsAlignH="center",u.boundsAlignV="middle",u.stroke=i.stroke,u.strokeThickness=i.stroke?2:0;var d=e.game.add.text(0,0,r,u,e.sceneProxy.settingsLayer);if(d.name=l,s["default"].fontFamily){var h=i.color?i.color:"#fefefe",f=i.fontSize?parseInt(i.fontSize):25,m="";if(h.indexOf("rgb")!==-1){var p=h.replace("rgb(","").replace(")","").split(",");m="0x"+parseInt(p[0],16)+parseInt(p[1],16)+parseInt(p[2],16),"0xffffff"===m&&(m="0xfefefe")}else m=("#ffffff"===h?"#fefefe":h).replace("#","0x");var y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(f):f,g=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(f):f;d.colors.splice(0,d.colors.length),d.text=" ",d.fill=m,d.addColor(m,0),d.x=t+(a-g*r.length)/2,d.y=n+(o-y)/2,d.wordWrapWidth=g*(r.length+1),e.sceneProxy.addImageFontText([{data:r}],g,y,d,e.sceneProxy.context)}else d.setTextBounds(t,n+(d.height-parseInt(i.fontSize))/2,a,o);return i.hidden&&(d.visible=!1),d},g=function(t,n,a,o){var r={};r.normal=o?t.unchecked.text:t.normal.text,r.active=o?null:t.active.text,r.text=a;var i=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,o?null:t.normal.background.url,o?null:t.active.background.url,v,r,e.sceneProxy.btn_sound,n,e.sceneProxy.settingsLayer,o);return o&&i.changeBackground(t.unchecked.background.url,a),i},v=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("settings_button_fullMode"===t.parent.name?(e.fullMode(),e.sceneProxy.onSettingsFullModeBtnClicked()):"settings_button_windowMode"===t.parent.name?(e.windowMode(),e.sceneProxy.onSettingsWindowModeBtnClicked()):"settings_button_autoOn"===t.parent.name?(e.autoOn(),e.sceneProxy.onSettingsAutoOnBtnClicked()):"settings_button_autoOff"===t.parent.name?(e.autoOff(),e.sceneProxy.onSettingsAutoOffBtnClicked()):"settings_button_back"===t.parent.name&&(e.sceneProxy.isQuickPlay=!0,appCanBack(flashvars.client,flashvars.app_version,!1,"1"===flashvars.offline),e.sceneProxy.onSettingsBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null)))},x=this.sceneProxy.settingsLayer.create(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);if(x.width=this.game.world.width,x.height=this.game.world.height,x.name="settings_bk_main",x.inputEnabled=!0,p(a.background.url,a.rect),1!=a.title.text.hidden&&y(a.title.rect.x,a.title.rect.y,a.title.rect.width,a.title.rect.height,this.sceneProxy.stringMap.settings,a.title.text,"settings_text_header"),o.hidden||(p(o.background.url,o.rect),o.title.text.hidden||y(o.title.rect.x+o.rect.x,o.title.rect.y+o.rect.y,o.title.rect.width,o.title.rect.height,this.sceneProxy.stringMap.displayHeader,o.title.text,"settings_text_displayHeader")),r.hidden||(p(r.background.url,r.rect),r.title.text.hidden||y(r.title.rect.x+r.rect.x,r.title.rect.y+r.rect.y,r.title.rect.width,r.title.rect.height,this.sceneProxy.stringMap.textHeader,r.title.text,"settings_text_textHeader")),p(i.background.url,i.rect),i.text.hidden||y(i.rect.x,i.rect.y,i.rect.width,i.rect.height,this.sceneProxy.stringMap.displayCaption,i.text,"settings_text_displayCaption"),p(l.background.url,l.rect),l.text.hidden||y(l.rect.x,l.rect.y,l.rect.width,l.rect.height,this.sceneProxy.stringMap.textCaption,l.text,"settings_text_textCaption"),u.hidden||g(u,"settings_button_fullMode",this.sceneProxy.stringMap.fullMode,!0),c.hidden||g(c,"settings_button_windowMode",this.sceneProxy.stringMap.windowMode,!0),d.hidden||g(d,"settings_button_autoOn",this.sceneProxy.stringMap.autoOn,!0),h.hidden||g(h,"settings_button_autoOff",this.sceneProxy.stringMap.autoOff,!0),!f.hidden){var P=g(f,"settings_button_back",this.sceneProxy.stringMap.back);P.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}if(this.sceneProxy.json_data.template.json.settings.musicCaption){var w=this.sceneProxy.json_data.template.json.settings.musicCaption;p(w.background.url,w.rect),w.text.hidden||y(w.rect.x,w.rect.y,w.rect.width,w.rect.height,this.sceneProxy.stringMap.musicCaption,w.text,"settings_text_musicCaption")}if(this.sceneProxy.json_data.template.json.settings.musicVolume){var b=this.sceneProxy.json_data.template.json.settings.musicVolume;m("music",b.normal.background.url,b.progress.background.url,b.rect,function(t){e.sceneProxy.updateMusicVolume(t)})}if(this.sceneProxy.json_data.template.json.settings.soundCaption){var k=this.sceneProxy.json_data.template.json.settings.soundCaption;p(k.background.url,k.rect),k.text.hidden||y(k.rect.x,k.rect.y,k.rect.width,k.rect.height,this.sceneProxy.stringMap.soundCaption,k.text,"settings_text_soundCaption")}if(this.sceneProxy.json_data.template.json.settings.soundVolume){var C=this.sceneProxy.json_data.template.json.settings.soundVolume;m("sound",C.normal.background.url,C.progress.background.url,C.rect,function(t){e.sceneProxy.updateSoundVolume(t)})}if(this.sceneProxy.json_data.template.json.settings.volumeHeader){var _=this.sceneProxy.json_data.template.json.settings.volumeHeader;p(_.background.url,_.rect),_.title.text.hidden||y(o.title.rect.x+o.rect.x,o.title.rect.y+o.rect.y,o.title.rect.width,o.title.rect.height,this.sceneProxy.stringMap.volumeHeader,o.title.text,"settings_text_displayHeader")}this.sceneProxy.settingsLayer.visible=!1},showSettingsLayer:function(e){var t=this;0===this.sceneProxy.settingsLayer.children.length&&this.addSettings();var n=function(){t.game.scale.isFullScreen?(t.fullMode(),e.fullScreen=!0):(t.windowMode(),e.fullScreen=!1)},a=function(){e.auto?t.autoOn():t.autoOff()};this.fullScreenHandler||(this.fullScreenHandler=this.game.scale.onFullScreenChange.add(function(e){return n()})),(this.sceneProxy.json_data.template.json.settings.musicVolume||this.sceneProxy.json_data.template.json.settings.soundVolume)&&(this.sceneProxy.isQuickPlay=!1,appCanBack(flashvars.client,flashvars.app_version,!0,"1"===flashvars.offline)),n(),a(),this.updateVolumeProgress("sound",u["default"].soundVolume),this.updateVolumeProgress("music",u["default"].musicVolume),this.sceneProxy.settingsLayer.visible=!0,this.game.world.bringToTop(this.sceneProxy.settingsLayer)}},{NAME:"SettingsMediator"})}),require.register("___globals___",function(e,t,n){})}(),require("___globals___");
//# sourceMappingURL=app.js.map