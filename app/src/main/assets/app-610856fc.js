!function(){"use strict";var e="undefined"==typeof global?self:global;if("function"!=typeof e.require){var t={},n={},a={},o={}.hasOwnProperty,r=/^\.\.?(\/|$)/,i=function(e,t){for(var n,a=[],o=(r.test(t)?e+"/"+t:t).split("/"),i=0,s=o.length;i<s;i++)n=o[i],".."===n?a.pop():"."!==n&&""!==n&&a.push(n);return a.join("/")},s=function(e){return e.split("/").slice(0,-1).join("/")},l=function(t){return function(n){var a=i(s(t),n);return e.require(a,t)}},u=function(e,t){var a=y&&y.createHot(e),o={id:e,exports:{},hot:a};return n[e]=o,t(o.exports,l(e),o),o.exports},c=function(e){return a[e]?c(a[e]):e},d=function(e,t){return c(i(s(e),t))},h=function(e,a){null==a&&(a="/");var r=c(e);if(o.call(n,r))return n[r].exports;if(o.call(t,r))return u(r,t[r]);throw new Error("Cannot find module '"+e+"' from '"+a+"'")};h.alias=function(e,t){a[t]=e};var f=/\.[^.\/]+$/,m=/\/index(\.[^\/]+)?$/,p=function(e){if(f.test(e)){var t=e.replace(f,"");o.call(a,t)&&a[t].replace(f,"")!==t+"/index"||(a[t]=e)}if(m.test(e)){var n=e.replace(m,"");o.call(a,n)||(a[n]=e)}};h.register=h.define=function(e,a){if(e&&"object"==typeof e)for(var r in e)o.call(e,r)&&h.register(r,e[r]);else t[e]=a,delete n[e],p(e)},h.list=function(){var e=[];for(var n in t)o.call(t,n)&&e.push(n);return e};var y=e._hmr&&new e._hmr(d,h,t,n);h._cache=n,h.hmr=y&&y.wrap,h.brunch=!0,e.require=h}}(),function(){"undefined"==typeof window?this:window;require.register("js/AppConstants.js",function(e,t,n){"use strict";window.diygamePlayer={AppConstants:{CMD_STARTUP:"CMD_STARTUP",CMD_FRAME_ENTER:"CMD_FRAME_ENTER",CMD_SVG_MENU:"CMD_SVG_MENU",CMD_LOAD_GAME:"CMD_LOAD_GAME",CMD_UPDATE_MUSIC_STATE:"CMD_UPDATE_MUSIC_STATE",APP_DEBUG_MODE:"APP_DEBUG_MODE",APP_LOG:"APP_LOG",APP_SHOW_INSPECTOR:"APP_SHOW_INSPECTOR",APP_SHOW_MENUBAR:"APP_SHOW_MENUBAR",APP_FPS_UPDATE:"APP_FPS_UPDATE",STAGE_TRAP_MOUSE:"STAGE_TRAP_MOUSE",SCENE_SHOW_ERROR:"SCENE_SHOW_ERROR",SCENE_SHOW_SAVE_ALERT:"SCENE_SHOW_SAVE_ALERT",SCENE_SHOW_AD:"SCENE_SHOW_AD",SCENE_TOOGLE_SCREEN_STATE:"SCENE_TOOGLE_SCREEN_STATE",SCENE_SKIPPING:"SCENE_SKIPPING",SCENE_PRELOADING_BEGIN:"SCENE_PRELOADING_BEGIN",SCENE_PRELOADING_PROGRESS:"SCENE_PRELOADING_PROGRESS",SCENE_PRELOADING_COMPLETE:"SCENE_PRELOADING_COMPLETE",SCENE_LOADING_BEGIN:"SCENE_LOADING_BEGIN",SCENE_LOADING_PROGRESS:"SCENE_LOADING_PROGRESS",SCENE_LOADING_COMPLETE:"SCENE_LOADING_COMPLETE",SCENE_TEMPLATE_LOADED:"SCENE_TEMPLATE_LOADED",SCENE_SHOW_LOGO:"SCENE_SHOW_LOGO",SCENE_GOTO_COVERMENU:"SCENE_GOTO_COVERMENU",SCENE_GOTO_MAINMENU:"SCENE_GOTO_MAINMENU",SCENE_GOTO_SETTINGS:"SCENE_GOTO_SETTINGS",SCENE_GOTO_PLAYBACK:"SCENE_GOTO_PLAYBACK",SCENE_GOTO_RECORD:"SCENE_GOTO_RECORD",SCENE_GOTO_END:"SCENE_GOTO_END",SCENE_CLOSE_MENU:"SCENE_CLOSE_MENU",SCENE_PLOT_ANIM_BEGIN:"SCENE_PLOT_ANIM_BEGIN",SCENE_PLOT_SKIP:"SCENE_PLOT_SKIP",SCENE_PLOT_CLOSED:"SCENE_PLOT_CLOSED",SCENE_PLOT_LOAD_BEGIN:"SCENE_PLOT_LOAD_BEGIN",SCENE_PLOT_LOAD_ASSETS_READY:"SCENE_PLOT_LOAD_ASSETS_READY",SCENE_PLOT_LOAD_ASSETS_LOADED:"SCENE_PLOT_LOAD_ASSETS_LOADED",SCENE_PLOT_LOAD_END:"SCENE_PLOT_LOAD_END",SCENE_BACKGROUND_COLOR_UPDATE:"SCENE_BACKGROUND_COLOR_UPDATE",SCENE_BACKGROUND_UPDATE:"SCENE_BACKGROUND_UPDATE",SCENE_BACKGROUND_ENTERED:"SCENE_BACKGROUND_ENTERED",SCENE_BACKGROUND_SWITCH:"SCENE_BACKGROUND_SWITCH",SCENE_MUSIC_UPDATE:"SCENE_MUSIC_UPDATE",SCENE_SOUND_UPDATE:"SCENE_SOUND_UPDATE",SCENE_CHARACTER_UPDATE:"SCENE_CHARACTER_UPDATE",SCENE_PROP_UPDATE:"SCENE_PROP_UPDATE",SCENE_VIEW_UPDATE:"SCENE_VIEW_UPDATE",SCENE_DIALOG_UPDATE:"SCENE_DIALOG_UPDATE",SCENE_DIALOG_COMPLETE:"SCENE_DIALOG_COMPLETE",SCENE_CHECK_IF_SKIP:"SCENE_CHECK_IF_SKIP",SCENE_CLICK_ON_SCENE:"SCENE_CLICK_ON_SCENE",SCENE_OPTION_UPDATE:"SCENE_OPTION_UPDATE",SCENE_MENUBUTTON_UPDATE:"SCENE_MENUBUTTON_UPDATE",SCENE_WEATHER_UPDATE:"SCENE_WEATHER_UPDATE",SCENE_EFFECT_SHAKE:"SCENE_EFFECT_SHAKE",SCENE_EFFECT_TWINKLE:"SCENE_EFFECT_TWINKLE",SCENE_CLEAR:"SCENE_CLEAR",SCENE_SHOW_GUIDE:"SCENE_SHOW_GUIDE",ADD_PLAYBACK_CONTENT:"ADD_PLAYBACK_CONTENT",SCENE_DESTROY_VIEW:"SCENE_DESTROY_VIEW",SCENE_SHOW_INPUT_VIEW:"SCENE_SHOW_INPUT_VIEW"}}}),require.register("js/ApplicationFacade.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.ApplicationFacade",parent:r["default"].Facade},{startup:function(){this.initialized||(this.initialized=!0,this.registerCommand(diygamePlayer.AppConstants.CMD_STARTUP,diygamePlayer.controller.command.StartupCommand),this.sendNotification(diygamePlayer.AppConstants.CMD_STARTUP))}},{getInstance:function(e){var t=r["default"].Facade.instanceMap,n=t[e];return n?n:t[e]=new diygamePlayer.ApplicationFacade(e)},NAME:"diygamePlayer"})}),require.register("js/common/Base64.js",function(e,t,n){"use strict";function a(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.encode=function(n){var a="",o=void 0,r=void 0,i=void 0,s=void 0,l=void 0,u=void 0,c=void 0,d=0;for(n=t(n);d<n.length;)o=n.charCodeAt(d++),r=n.charCodeAt(d++),i=n.charCodeAt(d++),s=o>>2,l=(3&o)<<4|r>>4,u=(15&r)<<2|i>>6,c=63&i,isNaN(r)?u=c=64:isNaN(i)&&(c=64),a=a+e.charAt(s)+e.charAt(l)+e.charAt(u)+e.charAt(c);return a},this.decode=function(t){var a="",o=void 0,r=void 0,i=void 0,s=void 0,l=void 0,u=void 0,c=void 0,d=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");d<t.length;)s=e.indexOf(t.charAt(d++)),l=e.indexOf(t.charAt(d++)),u=e.indexOf(t.charAt(d++)),c=e.indexOf(t.charAt(d++)),o=s<<2|l>>4,r=(15&l)<<4|u>>2,i=(3&u)<<6|c,a+=String.fromCharCode(o),64!=u&&(a+=String.fromCharCode(r)),64!=c&&(a+=String.fromCharCode(i));return a=n(a)};var t=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var a=e.charCodeAt(n);a<128?t+=String.fromCharCode(a):a>127&&a<2048?(t+=String.fromCharCode(a>>6|192),t+=String.fromCharCode(63&a|128)):(t+=String.fromCharCode(a>>12|224),t+=String.fromCharCode(a>>6&63|128),t+=String.fromCharCode(63&a|128))}return t},n=function(e){for(var t="",n=0,a=0,o=0,r=0;n<e.length;)a=e.charCodeAt(n),a<128?(t+=String.fromCharCode(a),n++):a>191&&a<224?(o=e.charCodeAt(n+1),t+=String.fromCharCode((31&a)<<6|63&o),n+=2):(o=e.charCodeAt(n+1),r=e.charCodeAt(n+2),t+=String.fromCharCode((15&a)<<12|(63&o)<<6|63&r),n+=3);return t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Base64=a}),require.register("js/common/Dialog.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"showDialog",value:function(e,t,n,a,o){!this.isShow&&(this.isShow=!0);var r=this;return new Promise(function(i,s){var l=function(){document.body.removeChild(c),r.isShow=!1,i("ok")},u=function(){document.body.removeChild(c),r.isShow=!1,s("cancel")},c=document.createElement("div");c.classList.add("ModalContainer");var d=document.createElement("div");d.classList.add("ModalPortal"),document.body.clientWidth<=document.body.clientHeight&&(d.style.transform="rotate(90deg)"),c.appendChild(d);var h=document.createElement("div");h.classList.add("Title");var f=document.createElement("span");f.innerText=e;var m=document.createElement("span");m.classList.add("spaceSpan");var p=document.createElement("span");p.classList.add("Close"),p.innerText="×",p.onclick=u,h.appendChild(f),h.appendChild(m),h.appendChild(p),d.appendChild(h);var y=document.createElement("div");y.classList.add("Content"),d.appendChild(y);var g=document.createElement("div");g.classList.add("ContentData"),n&&g.classList.add(n),g.innerText=t,y.appendChild(g);var v=document.createElement("div");v.classList.add("Buttons"),y.appendChild(v);var x=document.createElement("button"),P=document.createElement("button");x.classList.add("ButtonOk"),P.classList.add("ButtonsCancel"),x.innerText=a||"确定",P.innerText=o||"取消",v.appendChild(x),v.appendChild(P),x.onclick=l,P.onclick=u,document.body.appendChild(c)})}},{key:"info",value:function(e){if(!this.isShow)return this.showDialog("提示",e,"Info")}},{key:"warn",value:function(e){if(!this.isShow)return this.showDialog("警告",e,"Warn")}},{key:"error",value:function(e){if(!this.isShow)return this.showDialog("错误",e,"Error")}}]),e}();e["default"]=r}),require.register("js/common/FontUtils.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t("./Utils.js"),s=a(i),l=function(){function e(){o(this,e)}return r(e,null,[{key:"isFontExist",value:function(e){var t=["Microsoft YaHei","Helvetica","sans-serif","serif"],n="qwertyuiopasdfghjklzxcvbnm",a="72px",o=document.createElement("span");if(o.style.fontSize=a,o.innerHTML=n,!this.defaultWidth||!this.defaultHeight){this.defaultWidth={},this.defaultHeight={};for(var r in t)o.style.fontFamily=t[r],document.body.appendChild(o),this.defaultWidth[t[r]]=o.offsetWidth,this.defaultHeight[t[r]]=o.offsetHeight,document.body.removeChild(o)}var i=!1;for(var s in t){o.style.fontFamily=e+","+t[s],document.body.appendChild(o);var l=o.offsetWidth!=this.defaultWidth[t[s]]||o.offsetHeight!=this.defaultHeight[t[s]];document.body.removeChild(o),i=i||l}return i}},{key:"mergeFontImage",value:function(t,n){var a=this,o=[];return t.size?t.size.target.width?(this.charWidth=t.size.target.width,this.charHeight=t.size.target.height):(this.charWidth=t.size.target,this.charHeight=t.size.target):(this.charWidth=n,this.charHeight=n),this.widthImg=this.countPerRow*this.charWidth,this.heightImg=this.rowPerImg*this.charHeight,new Promise(function(n,r){if(!t)return n();if(a.isFontExist(t.fontFamily))return n();e.fontFamily=t.fontFamily;for(var i=0;i<t.images.length;i++)o[i]="https://apppic.3000test.com"+t.images[i].url,a.fontChars+=t.images[i].chars;var l=document.createElement("canvas"),u=l.getContext("2d"),c=o.length,d=Math.ceil(a.fontChars.length/a.countPerRow);l.width=a.widthImg,l.height=d*a.charHeight;var h=function f(t){if(!(t<c)){var r=l.toDataURL("image/png",1),i=s["default"].dataURLtoBlob(r),h=i?URL.createObjectURL(i):r;return a.fontImage=h,n()}var m=new Image,p=t===c-1?d%a.rowPerImg*a.charHeight:a.heightImg;m.src=o[t],m.onload=function(){return u.drawImage(m,0,0,e.widthImg,p,0,t*e.heightImg,e.widthImg,p),f(t+1)}};return h(0)})}},{key:"getCharSpace",value:function(e,t){return/[a-zA-Z0-9]/.test(e)?14*t/25:"("===e||")"===e?8*t/25:"-"===e?11*t/25:"."===e||":"===e?7:32===e.charCodeAt(0)||160===e.charCodeAt(0)||" "===e?t>>1:t}},{key:"getLeftMargin",value:function(e,t){return/[a-zA-Z0-9\.\)]/.test(e)?0:"("===e||":"===e?-(4*t/25):"-"===e?-(t/25):6*t/25}}]),e}();e["default"]=l,l.defaultWidth=void 0,l.defaultHeight=void 0,l.fontImage=void 0,l.fontChars="",l.fontFamily="",l.charWidth=25,l.charHeight=25,l.countPerRow=40,l.rowPerImg=20,l.widthImg=1e3,l.heightImg=500}),require.register("js/common/PhoneUtils.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"loadAudioUrl",value:function(e){function t(t,n,a){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,n){if("ios"===flashvars.client){var a={key:e,url:t,local:n};this.audioCountLoadByPhone.total++,1==flashvars.offline?loadAudioUrl(JSON.stringify(a)):window.webkit&&window.webkit.messageHandlers.loadAudioUrl.postMessage(JSON.stringify(a))}})},{key:"playMusic",value:function(e,t,n){var a=e?e:this.musicKey,o=void 0===t||null===t?1:t,r=void 0===n||null===n||n;this.musicInfo.key=a,this.musicInfo.volume=o,this.musicInfo.tweenId=parseInt(100*Math.random()),this.playAudioUrl(a,o,r,"music")}},{key:"stopMusic",value:function(){this.stopAudioUrl("music"),this.musicInfo.key=""}},{key:"playInheritMusic",value:function(e){this.musicInfo.volume=e,this.setAudioUrlVolume("music",e)}},{key:"tweenFromMusic",value:function(e,t,n){var a=this;return new Promise(function(o,r){if(t<=10)return a.musicInfo.volume=e,a.setAudioUrlVolume("music",e),o();var i=t/20,s=(a.musicInfo.volume-e)/i,l=e;a.musicInfo.tweenId=parseInt(100*Math.random());var u=a.musicInfo.tweenId,c=function d(){var t=a;return function(){return(t.musicInfo.volume>l&&s>0||t.musicInfo.volume<l&&s<0)&&u===t.musicInfo.tweenId?(l+=s,l>1?l=1:l<0&&(l=0),t.setAudioUrlVolume("music",l),t.musicInfo.volume=l,setTimeout(d(),20),void 0):(t.musicInfo.volume=e,o())}};setTimeout(c(),n)})}},{key:"tweenToMusic",value:function(e,t,n){var a=this;return new Promise(function(o,r){if(t<=10)return a.musicInfo.volume=e,a.setAudioUrlVolume("music",e),o();var i=t/20,s=(e-a.musicInfo.volume)/i,l=a.musicInfo.volume;a.musicInfo.tweenId=parseInt(100*Math.random());var u=a.musicInfo.tweenId,c=function d(){var t=a;return function(){return(l>e&&s<0||l<e&&s>0)&&u===t.musicInfo.tweenId?(l+=s,l<0?l=0:l>1&&(l=1),t.setAudioUrlVolume("music",l),t.musicInfo.volume=l,setTimeout(d(),20),void 0):(t.musicInfo.volume=e,o())}};setTimeout(c(),n)})}},{key:"tweenToSound",value:function(e,t,n,a){var o=this;return new Promise(function(r,i){if(!o.soundsInfo[e].key)return r();if(n<=10)return o.soundsInfo[e].volume=t,o.setAudioUrlVolume("sound"+e,t),r();var s=n/20,l=(t-o.soundsInfo[e].volume)/s,u=o.soundsInfo[e].volume;o.soundsInfo[e].tweenId=parseInt(100*Math.random());var c=o.soundsInfo[e].tweenId,d=function h(){var n=o;return function(){return(u>t&&l<0||u<t&&l>0)&&c===n.soundsInfo[e].tweenId?(u+=l,u<0?u=0:u>1&&(u=1),n.setAudioUrlVolume("sound"+e,u),n.soundsInfo[e].volume=u,setTimeout(h(),20),void 0):(n.soundsInfo[e].volume=t,r())}};setTimeout(d(),a)})}},{key:"stopSound",value:function(e){var t=this.soundsInfo[e].key;t&&this.stopAudioUrl("sound"+e),this.soundsInfo[e].key=""}},{key:"playSound",value:function(e,t,n,a){var o=t?t:this.soundsInfo[e].key,r=void 0===n||null===n?1:n,i=void 0===a||null===a||a;this.soundsInfo[e].key=o,this.soundsInfo[e].volume=r,this.soundsInfo[e].loop=i,this.soundsInfo[e].tweenId=parseInt(100*Math.random()),this.playAudioUrl(o,r,i,"sound"+e)}},{key:"playInheritSound",value:function(e,t){this.setAudioUrlVolume("sound"+e,t)}},{key:"playAudioUrl",value:function(e){function t(t,n,a,o){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,n,a){if("ios"===flashvars.client){var o={key:e,volume:t,loop:n?1:0,channel:a};1==flashvars.offline?playAudioUrl(JSON.stringify(o)):window.webkit&&window.webkit.messageHandlers.playAudioUrl.postMessage(JSON.stringify(o))}})},{key:"stopAudioUrl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if("ios"===flashvars.client){var t={channel:e};1==flashvars.offline?stopAudioUrl(JSON.stringify(t)):window.webkit&&window.webkit.messageHandlers.stopAudioUrl.postMessage(JSON.stringify(t))}})},{key:"setAudioUrlVolume",value:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){if("ios"===flashvars.client){var n={channel:e,volume:t};1==flashvars.offline?setAudioUrlVolume(JSON.stringify(n)):window.webkit&&window.webkit.messageHandlers.setAudioUrlVolume.postMessage(JSON.stringify(n))}})},{key:"removeAudioUrl",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if(e!==this.musicInfo.key&&!this.soundsInfo.some(function(t){return e===t})){var t={key:e};this.audioResourceRef[e]=0,1==flashvars.offline?removeAudioUrl(JSON.stringify(t)):window.webkit&&window.webkit.messageHandlers.removeAudioUrl.postMessage(JSON.stringify(t))}})},{key:"isAudioInCache",value:function(e){return!!this.audioResourceRef[e]}},{key:"audioCanPlayCallBack",value:function(e){this.audioCountLoadByPhone.loaded++,this.load.onSoundLoadExtend.dispatch(e),this.audioResourceRef[e]=1}}]),e}();e["default"]=r,r.audioCountLoadByPhone={loaded:0,total:0},r.load=null,r.musicInfo={key:"",volume:1,tweenId:0},r.soundsInfo=[{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0},{key:"",volume:1,loop:!1,tweenId:0}],r.audioResourceRef=[]}),require.register("js/common/RePhaser.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=t("./Utils.js"),s=a(i),l=function(){function e(){o(this,e)}return r(e,null,[{key:"updateText",value:function(){this.texture.baseTexture.resolution=this._res,this.context.font=this.style.font;var e=this.text;this.style.wordWrap&&(e=this.runWordWrap(this.text),this.realText=e);var t=e.split(/(?:\r\n|\r|\n)/),n=this.style.tabs,a=[],o=0,r=this.determineFontProperties(this.style.font),i=t.length;this.style.maxLines>0&&this.style.maxLines<t.length&&(i=this.style.maxLines),this._charCount=0;for(var s=0;s<i;s++){if(0===n){var l=this.style.strokeThickness+this.padding.x;l+=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(t[s]):this.context.measureText(t[s]).width}else{var u=t[s].split(/(?:\t)/),l=this.padding.x+this.style.strokeThickness;if(Array.isArray(n))for(var c=0,d=0;d<u.length;d++){var h=0;h=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(u[d]):Math.ceil(this.context.measureText(u[d]).width),d>0&&(c+=n[d-1]),l=c+h}else for(var d=0;d<u.length;d++){l+=this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.measureLine(u[d]):Math.ceil(this.context.measureText(u[d]).width);var f=this.game.math.snapToCeil(l,n)-l;l+=f}}a[s]=Math.ceil(l),o=Math.max(o,a[s])}this.canvas.width=o*this._res;var m=r.fontSize+this.style.strokeThickness+this.padding.y,p=m*i,y=this._lineSpacing;0>y&&Math.abs(y)>m&&(y=-m),0!==y&&(p+=y>0?y*t.length:y*(t.length-1)),this.canvas.height=(p-4)*this._res,this.context.scale(this._res,this._res),navigator.isCocoonJS&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.style.backgroundColor&&(this.context.fillStyle=this.style.backgroundColor,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)),this.context.fillStyle=this.style.fill,this.context.font=this.style.font,this.context.strokeStyle=this.style.stroke,this.context.textBaseline="alphabetic",this.context.lineWidth=this.style.strokeThickness,this.context.lineCap="round",this.context.lineJoin="round";var g,v,s;for(this._charCount=0,s=0;i>s;s++)g=this.style.strokeThickness/2,v=this.style.strokeThickness/2+s*m+r.ascent,s>0&&(v+=y*s),"right"===this.style.align?g+=o-a[s]:"center"===this.style.align&&(g+=(o-a[s])/2),this.autoRound&&(g=Math.round(g),v=Math.round(v)),this.colors.length>0||this.strokeColors.length>0||this.fontWeights.length>0||this.fontStyles.length>0?this.updateLine(t[s],g,v):(this.style.stroke&&this.style.strokeThickness&&(this.updateShadow(this.style.shadowStroke),0===n?this.context.strokeText(t[s],g,v):this.renderTabLine(t[s],g,v,!1)),this.style.fill&&(this.updateShadow(this.style.shadowFill),0===n?this.context.fillText(t[s],g,v):this.renderTabLine(t[s],g,v,!0)));this.updateTexture()}},{key:"advancedWordWrap",value:function(e){for(var t=this.context,n=this.style.wordWrapWidth,a="",o=e.split(/\r?\n/gi),r=o.length,i=0;i<r;i++){var s=o[i],l=t.measureText(s).width;if(l<n)a+=s+"\n";else for(var u=function(e,t){if(!e||!t||/\s/.test(e)||/\s/.test(t))return!1;var n=/[\u4E00-\u9FA5\uF900-\uFA2D]|\s/,a=new RegExp("[!！)）|}':;',\\].>》/?……）\\-|}】‘；：”“’。，、？]"),o=new RegExp("[!！?？:：;；.。》』\\-\\]】）]");return n.test(e)&&a.test(t)||!n.test(e)&&!n.test(t)&&!o.test(e)},c=s;;){var d=-1,h="",f=t.measureText(c).width;if(!(f>n)){c&&(a+=c+"\n");break}for(var m=0;c[m]&&(h+=c[m],f=t.measureText(h).width,d=u(c[m-1],c[m])?d:m-1,m++,f<n););d!==-1&&d!==h.length-1?(h&&(h=h.slice(0,d+1)),c=c.substr(h.length).trimLeft()):(h&&(h=h.slice(0,-1)),c=c.substr(h.length).trimLeft()),a+=h+"\n"}}return a=a.replace(/\n$/gi,"")}},{key:"loadImageTag",value:function(e){var t=this,n=function(n){var a=n.requestObject.response,o=void 0;a instanceof ArrayBuffer&&(o=new Uint8Array(a));var r=!1;o[0]!=="G".charCodeAt()||o[1]!=="I".charCodeAt()||o[2]!=="F".charCodeAt()||o[3]!=="8".charCodeAt()||o[4]!=="9".charCodeAt()&&!"7".charCodeAt()||o[5]!=="a".charCodeAt()||(r=!0),e.data=new Image,e.data.name=e.key,t.crossOrigin&&(e.data.crossOrigin=t.crossOrigin);var i=function(){e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))};e.data.onload=function(){URL.revokeObjectURL(e.url),i()},e.data.onerror=function(){URL.revokeObjectURL(e.url),e.data.onload&&(e.data.onload=null,e.data.onerror=null,t.fileError(e))},r?s["default"].spliceGif(a).then(function(n){e.data.frames=n.frames,e.data.loopCount=n.loopCount,e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)},function(){e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)}):(e.url=URL.createObjectURL(s["default"].createBlob(a,"")),e.data.src=t.transformUrl(e.url,e)),e.data.complete&&e.data.width&&e.data.height&&(e.data.onload=null,e.data.onerror=null,t.fileComplete(e))};this.xhrLoad(e,this.transformUrl(e.url,e),"arraybuffer",n)}},{key:"soundStop",value:function(){var e=this;if(this.isPlaying&&this._sound)if(this.usingWebAudio){if(this.externalNode){var t=this._sound.onended;this._sound.onended=function(){e._sound.disconnect(e.externalNode),t&&t()}}else if(this.gainNode){var n=this._sound.onended;this._sound.onended=function(){e._sound.disconnect(e.gainNode),n&&n()}}if(void 0===this._sound.stop)this._sound.noteOff(0);else try{this._sound.stop(0)}catch(a){alert(a)}}else this.usingAudioTag&&(this._sound.pause(),this._sound.currentTime=0);if(this.pendingPlayback=!1,this.isPlaying=!1,!this.paused){var o=this.currentMarker;""!==this.currentMarker&&this.onMarkerComplete.dispatch(this.currentMarker,this),this.currentMarker="",null!==this.fadeTween&&this.fadeTween.stop(),this.onStop.dispatch(this,o)}}},{key:"soundDecode",value:function(e,t){var n=this;t=t||null;var a=this.game.cache.getSoundData(e);if(a&&this.game.cache.isSoundDecoded(e)===!1){this.game.cache.updateSound(e,"isDecoding",!0);var o=this,r=function(){n.onSoundDecodeError.dispatch(e),console.warn("Unable to encode audio "+e)};try{this.context.decodeAudioData(a,function(n){n&&(o.game.cache.decodedSound(e,n),o.onSoundDecode.dispatch(e,t))})["catch"](r)}catch(i){r()}}}},{key:"loadAudioTag",value:function(e){var t=this,n=e.url;n.indexOf("?")>=0&&(n=n.substr(0,n.indexOf("?")));var a=n.substr((Math.max(0,n.lastIndexOf("."))||1/0)+1),o="dat"===a.toLowerCase(),r=function(e){if(t.game.sound.touchLocked)e.data=i.AudioTagPool.get(),e.data.name=e.key,e.data.src=t.transformUrl(e.url,e),t.fileComplete(e);else{var n=i.AudioTagPool.get();if(e.data=n,e.data.name=e.key,!i.AudioTagPool.exist(n))return t.game.sound.touchLocked=!0,e.data.src=t.transformUrl(e.url,e),void t.fileComplete(e);var a=function o(){e.data.removeEventListener("canplaythrough",o,!1),e.data.onerror=null,t.fileComplete(e)};e.data.onerror=function(){e.data.removeEventListener("canplaythrough",a,!1),e.data.onerror=null,t.fileComplete(e)},e.data.src=t.transformUrl(e.url,e),e.data.addEventListener("canplaythrough",a,!1),e.data.load()}},s=function(e){return t.game.device.android?void r(e):void t.xhrLoad(e,t.transformUrl(e.url,e),"arraybuffer",function(e,t){e.url=URL.createObjectURL(new Blob([t.response],{type:"audio/mp3"})),e.isDatFile=!0,r(e)})};o?s(e):r(e)}},{key:"tintWithMultiply",value:function(e,t,n){var a=n.getContext("2d"),o=e.crop,r=o.width,i=o.height;e.rotated&&(r=i,i=o.width),n.width===r&&n.height===i||(n.width=r,n.height=i),a.clearRect(0,0,r,i),a.drawImage(e.baseTexture.source,o.x,o.y,r,i,0,0,r,i),a.globalCompositeOperation="source-atop",a.fillStyle="#"+("00000"+(0|t).toString(16)).substr(-6),a.fillRect(0,0,r,i)}}]),e}();e["default"]=l,function(){PIXI.CanvasTinter.tintWithMultiply=l.tintWithMultiply,Phaser.Game.prototype.destroyComponent=new Phaser.Signal;var e=Phaser.Sprite.prototype.destroy;Phaser.Sprite.prototype.destroy=function(){var t=this.game;e.apply(this,arguments),t&&t.destroyComponent&&t.destroyComponent.dispatch(this.key||null)};var t=Phaser.Image.prototype.destroy;Phaser.Image.prototype.destroy=function(){var e=this.game;t.apply(this,arguments),e&&e.destroyComponent&&e.destroyComponent.dispatch(this.key||null)},Phaser.Loader.prototype.loadAudioTag=l.loadAudioTag;var n=Phaser.Sound.prototype.destroy;Phaser.Sound.prototype.destroy=function(){if(n.apply(this,arguments),this.usingWebAudio){this.game.sound.context&&!this.game.sound.scratchBuffer&&(this.game.sound.scratchBuffer=this.game.sound.context.createBuffer(1,1,22050));try{this._sound.buffer=this.game.sound.scratchBuffer}catch(e){}}this._sound=null},Phaser.Cache.prototype.reloadSound=function(e){var t=this,n=this.getSound(e);if(n&&!i.AudioTagPool.exist(n.data)){var a=i.AudioTagPool.get();if(!i.AudioTagPool.exist(a))return;n.data=a,n.data.src=n.url,n.data.addEventListener("canplaythrough",function(){return t.reloadSoundComplete(e)},!1),n.data.load()}},Phaser.Device.canPlayAudio=function(e){return!("mp3"!==e||!this.mp3)||(!("ogg"!==e||!this.ogg&&!this.opus)||(!("m4a"!==e||!this.m4a)||(!("opus"!==e||!this.opus)||(!("wav"!==e||!this.wav)||(!("webm"!==e||!this.webm)||(!("mp4"!==e||!this.dolby)||"dat"===e))))))},Phaser.SoundManager.prototype.setMute=function(){if(!this._muted){this._muted=!0,this.usingWebAudio&&(this._muteVolume=this.masterGain.gain.value,this.masterGain.gain.value=0);for(var e=0;e<this._sounds.length;e++)this._sounds[e].usingAudioTag&&(this.game.device.iOS&&this._sounds[e].pause(),this._sounds[e].mute=!0);this.onMute.dispatch()}},Phaser.SoundManager.prototype.unsetMute=function(){if(this._muted&&!this._codeMuted){this._muted=!1,this.usingWebAudio&&(this.masterGain.gain.value=this._muteVolume);for(var e=0;e<this._sounds.length;e++)this._sounds[e].usingAudioTag&&(this.game.device.iOS&&this._sounds[e].resume(),this._sounds[e].mute=!1);this.onUnMute.dispatch()}}}()}),require.register("js/common/ShanyiMenu.js",function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(){function e(){a(this,e)}return o(e,null,[{key:"showSyMenu",value:function(){!this.isShow&&(this.isShow=!0);var e=this;return new Promise(function(t,n){var a=function(){document.body.removeChild(r),e.isShow=!1,t(1)},o=function(n){document.body.removeChild(r),e.isShow=!1,t(n)};gameCallback.syMenuBack=a,gameCallback.syMenuExit=o;var r=document.createElement("div");r.classList.add("syModalContainer");var i=document.createElement("div");i.classList.add("syModalPortal"),document.body.clientWidth<=document.body.clientHeight&&(i.style.transform="rotate(90deg)"),r.appendChild(i);var s=document.createElement("div");s.classList.add("syContent"),i.appendChild(s);var l=document.createElement("iframe");l.src="https://www.3000.com/popup.html?uuid="+flashvars.uuid+"&wap="+flashvars.wap,l.scrolling="no",l.width="100%",l.height="100%",l.frameBorder="0",s.appendChild(l),document.body.appendChild(r)})}}]),e}();e["default"]=r}),require.register("js/common/Utils.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.AudioTagPool=e.ResourcesManager=void 0;var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),l=t("./XmlHttpRequest.js"),u=o(l),c=t("./Version.js"),d=(a(c),t("./Base64.js")),h=t("crypto-js"),f=a(h),m=t("spark-md5"),p=a(m),y=t("./PhoneUtils.js"),g=a(y),v=function(){function e(){i(this,e)}return s(e,null,[{key:"convertToAllowAccessControlOriginUrl",value:function(e){if(!e)return Promise.resolve("");if("http://f1.img4399.com/ma~217_20160518155234_573c1f42bb260.jpeg"===e)return Promise.resolve("https://apppic.3000test.com/m~web/41/2017/02/08/09_j1sGyq.960x540.jpg");if("/"===e[0]&&(e=e.substring(1)),/blob:/i.test(e))return Promise.reject(e);var t=void 0,n=e.indexOf("://");if(n>-1){var a=e.split("/");a.shift(),a.shift(),a.shift(),t="https://apppic.3000test.com/"+a.join("/")}else t="https://apppic.3000test.com/"+e;return"1"===flashvars.offline&&(t="game"+flashvars.gid+"/"+t.substring(28)),Promise.resolve(t)}},{key:"spliceGif",value:function(e){var t=this;return new Promise(function(n,a){var o=void 0,i=0,s=void 0,l=document.createElement("canvas"),u=document.createElement("canvas"),c=void 0,d=void 0,h=null,f=null,m=null,p=null,y=null,g=1,v=[],x=function(e){return e.reduce(function(e,t){return 2*e+t},0)},P=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},w=function(e){o=e,i=0,this.readByte=function(){if(i>=e.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[i++]:255&e.charCodeAt(i++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},b=function(e,t){var n=0,a=function(e){for(var a=0,o=0;o<e;o++)t[n>>3]&1<<(7&n)&&(a|=1<<o),n++;return a},o=1<<e,r=o+1,i=e+1,s=4096,l=4096,u=new Uint8Array(s),c=new Uint8Array(l),d=[],h=0,f=0,m=function(){for(var e=0;e<o;e++)d[e]=new Uint8Array(1),d[e][0]=e;d[o]=new Uint8Array(0),d[r]=null},p=function(){var t=o+2;d.splice(t,d.length-t),i=e+1,h=0},y=function(){var e=u.length+s,t=new Uint8Array(e);t.set(u),u=t,s<<=1},g=function(){var e=c.length+l,t=new Uint8Array(e);t.set(c),c=t,l<<=1},v=function(e,t){for(var n=d[t].byteLength+1;h+n>c.length;)g();var a=c.subarray(h,h+n);a.set(d[t]),a[n-1]=d[e][0],h+=n,d.push(a)},x=void 0,P=void 0;for(m();;)if(P=x,x=a(i),x!==o){if(x===r)break;if(x<d.length)P!==o&&v(x,P);else{if(x!==d.length)throw new Error("Invalid LZW code.");v(P,P)}for(var w=d[x].length;f+w>u.length;)y();
u.set(d[x],f),f+=w,d.length===1<<i&&i<12&&i++}else p();return u.subarray(0,f)},k=function(e,t){l.width=e,l.height=t,l.style.width=e+"px",l.style.height=t+"px",l.getContext("2d").setTransform(1,0,0,1,0,0),u.width=e,u.height=e},C=function(){h=null,f=null,d=m,m=null,c=null},_=function(e){s=e,k(s.width,s.height)},S=function(e){I(),C(),h=e.transparencyGiven?e.transparencyIndex:null,f=e.delayTime,m=e.disposalMethod},I=function(){if(c){var e=l.toDataURL("image/png"),n=t.dataURLtoBlob(e);v.push({blobUrl:n?URL.createObjectURL(n):e,delay:Math.max(f,10)})}},E=function(e){c||(c=l.getContext("2d"));var t=v.length,n=e.lctFlag?e.lct:s.gct;t>0&&(3===d?null!==p?v[p].data&&c.putImageData(v[p].data,0,0):c.clearRect(y.leftPos,y.topPos,y.width,y.height):p=t-1,2===d&&c.clearRect(y.leftPos,y.topPos,y.width,y.height));for(var a=c.getImageData(e.leftPos,e.topPos,e.width,e.height),o=0;o<e.pixels.length;o++){var r=e.pixels[o];if(r!==h){var i=n[r],u=4*o;a.data[u]=i[0],a.data[u+1]=i[1],a.data[u+2]=i[2],a.data[u+3]=255}}c.putImageData(a,e.leftPos,e.topPos),y=e},L=function(){},T=function(e){g=e.iterations},M={hdr:_,gce:S,com:L,app:{NETSCAPE:T},img:E,eof:function(){I()}},A=function(e,t){t||(t={});var a=function(t){for(var n=[],a=0;a<t;a++)n.push(e.readBytes(3));return n},o=function(){var t=void 0,n=void 0,a=0,o=8192;n=new Uint8Array(o);var r=function(){var e=new Uint8Array(n.length+o);e.set(n),n=e};do{for(t=e.readByte();a+t>n.length;)r();n.set(e.readBytes(t),a),a+=t}while(0!==t);return n.subarray(0,a)},i=function(){var n={};if(n.sig=e.read(3),n.ver=e.read(3),"GIF"!==n.sig)throw new Error("Not a GIF file.");n.width=e.readUnsigned(),n.height=e.readUnsigned();var o=P(e.readByte());n.gctFlag=o.shift(),n.colorRes=x(o.splice(0,3)),n.sorted=o.shift(),n.gctSize=x(o.splice(0,3)),n.bgColor=e.readByte(),n.pixelAspectRatio=e.readByte(),n.gctFlag&&(n.gct=a(1<<n.gctSize+1)),t.hdr&&t.hdr(n)},s=function(n){var a=function(n){var a=(e.readByte(),P(e.readByte()));n.reserved=a.splice(0,3),n.disposalMethod=x(a.splice(0,3)),n.userInput=a.shift(),n.transparencyGiven=a.shift(),n.delayTime=e.readUnsigned(),n.transparencyIndex=e.readByte(),n.terminator=e.readByte(),t.gce&&t.gce(n)},r=function(e){e.comment=o(),t.com&&t.com(e)},i=function(n){e.readByte();n.ptHeader=e.readBytes(12),n.ptData=o(),t.pte&&t.pte(n)},s=function(n){var a=function(n){e.readByte();n.unknown=e.readByte(),n.iterations=e.readUnsigned(),n.terminator=e.readByte(),t.app&&t.app.NETSCAPE&&t.app.NETSCAPE(n)},r=function(e){e.appData=o(),t.app&&t.app[e.identifier]&&t.app[e.identifier](e)};e.readByte();switch(n.identifier=e.read(8),n.authCode=e.read(3),n.identifier){case"NETSCAPE":a(n);break;default:r(n)}},l=function(e){e.data=o(),t.unknown&&t.unknown(e)};switch(n.label=e.readByte(),n.label){case 249:n.extType="gce",a(n);break;case 254:n.extType="com",r(n);break;case 1:n.extType="pte",i(n);break;case 255:n.extType="app",s(n);break;default:n.extType="unknown",l(n)}},l=function(n){var i=function(e,t){for(var n=new Array(e.length),a=e.length/t,o=function(a,o){var i,s=e.slice(o*t,(o+1)*t);n.splice.apply(n,(i=[a*t,t]).concat.apply(i,r(s)))},i=[0,4,2,1],s=[8,8,4,2],l=0,u=0;u<4;u++)for(var c=i[u];c<a;c+=s[u])o(c,l),l++;return n};n.leftPos=e.readUnsigned(),n.topPos=e.readUnsigned(),n.width=e.readUnsigned(),n.height=e.readUnsigned();var s=P(e.readByte());n.lctFlag=s.shift(),n.interlaced=s.shift(),n.sorted=s.shift(),n.reserved=s.splice(0,2),n.lctSize=x(s.splice(0,3)),n.lctFlag&&(n.lct=a(1<<n.lctSize+1)),n.lzwMinCodeSize=e.readByte();var l=o();n.pixels=b(n.lzwMinCodeSize,l),n.interlaced&&(n.pixels=i(n.pixels,n.width)),t.img&&t.img(n)},u=function d(){var a={};switch(a.sentinel=e.readByte(),String.fromCharCode(a.sentinel)){case"!":a.type="ext",s(a);break;case",":a.type="img",l(a);break;case";":a.type="eof",t.eof&&t.eof(a);break;default:throw new Error("Unknown block: 0x"+a.sentinel.toString(16))}"eof"!==a.type?setTimeout(d,0):n({loopCount:g,frames:v})},c=function(){i(),setTimeout(u,0)};c()};try{var O=new Uint8Array(e),V=new w(O);setTimeout(A(V,M),0)}catch(N){a(N),console.error("parseGIF ERROR!!"+N)}})}},{key:"isObject",value:function(e){return"[object Object]"===Object.prototype.toString.apply(e)}},{key:"fixColorValue",value:function(e){var t=e.match(/rgb\([\s]*(\d+)[\s]*,[\s]*(\d+)[\s]*,[\s]*(\d+)[\s]*\)/i),n=function(e){var t=parseInt(e,10).toString(16);return 2!==t.length?"0"+t:t};return t?e="#"+n(t[1])+n(t[2])+n(t[3]):(e&&"#"!==e[0]&&(e="#"+e),isNaN(parseInt(e.slice(1),16))&&(e="#ffffff"),e?e:"#ffffff")}},{key:"timeout",value:function(e){var t=null,n=new Promise(function(n,a){return t=setTimeout(n,e)});return n.cancel=function(){return clearTimeout(t)},n}},{key:"getTimeOffset",value:function(){var e=this,t="https://my.3000.com/?m=timestamp&op=index&ac=get&api_v=1.0.0&api_from=webpc";return u.xhrGetServerTime(t).then(function(t){if(0===t.responseText.length)return Promise.reject("Get file failed, no response data");var n=JSON.parse(t.responseText);return 0===n.status?(e.timeStamp=n.data.timestamp,e.timeOffset=e.timeStamp-Math.floor((new Date).getTime()/1e3),Promise.resolve(e.timeOffset)):Promise.reject(n.msg+": "+n.status)},function(e){return Promise.reject(e)})}},{key:"updateContextTimeValues",value:function(e){if(-1!==this.timeStamp){e.systemValues[2].value=Math.floor(Date.now()/1e3)+this.timeOffset;var t=new Date(1e3*e.systemValues[2].value);e.systemValues[3].value=t.getFullYear(),e.systemValues[4].value=t.getMonth()+1,e.systemValues[5].value=t.getDate(),e.systemValues[6].value=t.getHours(),e.systemValues[7].value=t.getMinutes(),e.systemValues[8].value=t.getSeconds(),e.systemValues[10].value=t.getDay()}}},{key:"getCurrentDateTime",value:function(e){var t=new Date(e),n="-",a=":",o=function(e,t,n){return e>=n&&e<=t?"0"+e:""+e},r=t.getFullYear()+n+o(t.getMonth()+1,9,1)+n+o(t.getDate(),9,0)+" "+o(t.getHours(),9,0)+a+o(t.getMinutes(),9,0)+a+o(t.getSeconds(),9,0);return r}},{key:"createBlob",value:function(e,t){var n=void 0,a=void 0;try{return new Blob([e])}catch(o){if(n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)return a=new n,a.append(e),a.getBlob(t);throw new Error("Unable to create blob")}}},{key:"dataURLtoBlob",value:function(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]),o=a.length,r=new Uint8Array(o);o--;)r[o]=a.charCodeAt(o);var i=null;try{i=new Blob([r],{type:n})}catch(s){console.error(s.name+"  "+s.message)}return i}},{key:"encodeBase64",value:function(e){if(""===e)return"";var t=new d.Base64;return t.encode(e)}},{key:"decryptBase64",value:function(e){if(""===e)return"";var t=new d.Base64;return t.decode(e)}},{key:"aesEncrypt",value:function(e,t){if(""===e)return"";var n="de3kt|jq|fdcgj_|",a="ff_|pf|#%@fw_j+q";1===t?(n="WDF#$H*#SJN*&G$&",a="JH&$GF$DR%*K@SC%"):2===t&&(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf");var o=f["default"].enc.Utf8.parse(n),r=f["default"].enc.Utf8.parse(a),i=f["default"].AES.encrypt(e+"",o,{iv:r,mode:f["default"].mode.CBC,padding:f["default"].pad.ZeroPadding}),s=i.toString();return s}},{key:"aesDecrypt",value:function(e,t){if(""===e)return"";var n="de3kt|jq|fdcgj_|",a="ff_|pf|#%@fw_j+q";1===t?(n="WDF#$H*#SJN*&G$&",a="JH&$GF$DR%*K@SC%"):2===t&&(n="aDF#$HGF$DN*&G$e",a="bH&$GF$DcF#$HSCf");var o=f["default"].enc.Utf8.parse(n),r=f["default"].enc.Utf8.parse(a),i=f["default"].AES.decrypt(e,o,{iv:r,mode:f["default"].mode.CBC,padding:f["default"].pad.ZeroPadding}),s=i.toString(f["default"].enc.Utf8);return s}},{key:"getCookie",value:function(e){var t=void 0,n=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(n))?decodeURI(t[2]):null}},{key:"getUidByCookie",value:function(){var e=this.getCookie("SYPauth");if(e){var t=e.indexOf("|");e=e.substring(0,t)}return e?e:""}},{key:"generateUUID",value:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)});return t}},{key:"localStorageGetItem",value:function(e){if(flashvars.app_version<"1.2.0")return window.localStorage.getItem(e);if("android"===flashvars.client&&window.app){var t=window.app.localStorage_getItem(e);return""===t?null:t}if("ios"===flashvars.client){var n=null;return n=1==flashvars.offline?localStorage_getItem(e):window.localStorage.getItem(e),""===n&&(n=null),n}return""===flashvars.client?window.localStorage.getItem(e):null}},{key:"localStorageSetItem",value:function(e,t){if(flashvars.app_version<"1.2.0")return void window.localStorage.setItem(e,t);if("android"===flashvars.client)window.app&&window.app.localStorage_setItem(e,t);else if("ios"===flashvars.client){var n={key:e,value:t};1==flashvars.offline?localStorage_setItem(JSON.stringify(n)):(window.webkit&&window.webkit.messageHandlers.localStorage_setItem.postMessage(JSON.stringify(n)),window.localStorage.setItem(e,t))}else window.localStorage.setItem(e,t)}},{key:"localStorageRemoveItem",value:function(e){return flashvars.app_version<"1.2.0"?void window.localStorage.removeItem(e):void("android"===flashvars.client?window.app&&window.app.removeLocalStorage(e):"ios"===flashvars.client?1==flashvars.offline?removeLocalStorage(e):(window.webkit&&window.webkit.messageHandlers.removeLocalStorage.postMessage(e),window.localStorage.removeItem(e)):window.localStorage.removeItem(e))}},{key:"localStorageClear",value:function(){window.localStorage.clear()}},{key:"getSensitiveWords",value:function(){var e=this,t="https://mapi.3000api.com/apis/soft/v1.0/game-GetSensitiveStr.html",n="action=all";return u.xhrSend(t,n).then(function(t){if(0===t.responseText.length)return Promise.reject("getSensitiveWords failed, no response data");var n=JSON.parse(t.responseText);return 100==n.code?(e.sensitiveWords=n.result.concat(),Promise.resolve()):Promise.reject()},function(e){return Promise.reject(e)})}},{key:"getDeviceId",value:function(){if("android"===flashvars.client){var e=navigator.userAgent.match(/[0-9A-Za-z]{8}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{12}/g);return e?e[0]:""}if("ios"===flashvars.client){var t=navigator.userAgent.match(/[0-9A-Za-z]{40}/g);return t?t[0]:""}return""}},{key:"formatNum",value:function(e){return 0===e?"00000":e<10?"0000"+e:e<100?"000"+e:"00"+e}},{key:"sendStatistics",value:function(){if("android"!==flashvars.client&&"ios"!==flashvars.client)return Promise.resolve();var e=this.getDeviceId(),t=Math.floor((new Date).getTime()/1e3)+this.timeOffset,n="mac_name="+e+"&time="+t+"&uid="+flashvars.uid+"&v_key=shanyi_WDF#$H*#SJN*&G$&**";n=this.aesEncrypt(p["default"].hash(p["default"].hash(n)),1),t=this.aesEncrypt(t,1);var a="https://app.3000.com/?m=statistics&op=start&ac=h5&v="+flashvars.v+"&client="+flashvars.client,o="mac_name="+encodeURIComponent(this.aesEncrypt(e,1))+"&uid="+encodeURIComponent(this.aesEncrypt(flashvars.uid,1))+"&sign="+encodeURIComponent(n)+"&time="+encodeURIComponent(t);return u.xhrSend(a,o)}},{key:"sendSelOptions",value:function(){var e=this,t=function(){if(0===e.selOptions.length)return setTimeout(n(),3e4),Promise.resolve();var t="https://www.3000.com/apis/client/v1.0/trace-optionClick.html?",a="from=h5&uuid="+flashvars.uuid+"&optionid="+JSON.stringify(e.selOptions);return u.xhrLoad(t+a,"").then(function(){return e.selOptions.splice(0,e.selOptions.length),setTimeout(n(),3e4),Promise.resolve()},function(){return setTimeout(n(),3e4),Promise.reject()})},n=function(){return function(){t()}};setTimeout(n(),3e4)}}]),e}();e["default"]=v,v.timeStamp=-1,v.timeOffset=0,v.sensitiveWords=[],v.selOptions=[];var x=e.ResourcesManager=function(){function e(){i(this,e)}return s(e,null,[{key:"forEachReCount",value:function(e){var t=this;Object.keys(this.refCount.audio).forEach(function(n){return e&&e("audio",n,t.getCount("audio",n))}),Object.keys(this.refCount.img).forEach(function(n){return e&&e("img",n,t.getCount("img",n))})}},{key:"resetReCount",value:function(){var e=this;Object.keys(this.refCount.audio).forEach(function(t){var n=e.refCount.audio[t].global,a=void 0===n?0:n;e.refCount.audio[t]={global:a}}),Object.keys(this.refCount.img).forEach(function(t){var n=e.refCount.img[t].global,a=void 0===n?0:n;e.refCount.img[t]={global:a}})}},{key:"removeFromCache",value:function(e,t){if(this.refCount[e][t]&&!this.getCount(e,t)){if("audio"===e&&this.cache){if("ios"===flashvars.client&&flashvars.app_version>="1.5.0")g["default"].removeAudioUrl(t);else{var n=this.cache.getSound(t);n&&n.audioTag&&n.data&&(n.data.free=!0),n&&/blob:/i.test(n.url)&&URL.revokeObjectURL(n.url),this.cache.checkSoundKey(t)&&this.cache.removeSound(t)}delete this.refCount[e][t]}if("img"===e&&this.cache){var a=this.cache.getImage(t,!0);if(a){var o=a.data.frames;o&&o.forEach(function(e){URL.revokeObjectURL(e.blobUrl),e.blobUrl=null}),/blob:/i.test(a.url)&&URL.revokeObjectURL(a.url),this.cache.removeImage(t)}delete this.refCount[e][t]}}}},{key:"transferRefCount",value:function(e,t,n,a,o){this.refCount[e][a]=this.refCount[e][a]||{},this.refCount[e][a][o]=this.refCount[e][a][o]||0,this.refCount[e][t]&&(this.refCount[e][a][o]+=this.refCount[e][t][n],this.refCount[e][t][n]=0,this.removeFromCache(e,t))}},{key:"transferByRefCount",value:function(e,t){var n=this;Object.keys(this.refCount.audio).forEach(function(a){var o=n.refCount.audio[a];o[t]=(o[t]||0)+(o[e]||0),o[e]=0}),Object.keys(this.refCount.img).forEach(function(a){var o=n.refCount.img[a];o[t]=(o[t]||0)+(o[e]||0),o[e]=0})}},{key:"addRefCount",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"play",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e&&t&&(this.refCount[e][t]=this.refCount[e][t]||{},this.refCount[e][t][n]=(this.refCount[e][t][n]||0)+a)}},{key:"subRefCount",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"play";if(this.refCount[e][t]){var a=this.refCount[e][t];a[n]=(a[n]||0)-1,a[n]=a[n]<0?0:a[n],this.removeFromCache(e,t)}else"audio"===e&&"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version&&!!t&&g["default"].removeAudioUrl(t)}},{key:"delRefTypeCount",value:function(e,t,n){if(this.refCount[e][t]){var a=this.refCount[e][t];a[n]=0,this.removeFromCache(e,t)}}},{key:"delByRefType",value:function(e){var t=this;Object.keys(this.refCount.audio).every(function(n){t.refCount.audio[n][e]=0,t.removeFromCache("audio",n)}),Object.keys(this.refCount.img).every(function(n){t.refCount.img[n][e]=0,t.removeFromCache("img",n)})}},{key:"getCount",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return this.refCount[e][t]?a?this.refCount[e][t][a]||0:Object.keys(this.refCount[e][t]).reduce(function(a,o){return a+n.refCount[e][t][o]},0):0}},{key:"getResourcesByContext",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=this,o=arguments[3],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=this.lastUsedKeyMap,l={data:[],size:0},c=e&&e.stack[0],d=e&&e.cmdStack[0];if(!t||!t.plots||!t.plots[n]||o&&!o.commands[i])return Promise.resolve(l);var h=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return l.size>a.MaxSize||!e&&l.data.length>a.MaxCount},f=function(e,t,n){return a.addRefCount(t,e,n),l.data.some(function(t){return t.key===e})?Promise.resolve():u.getResourceSize(e,t).then(function(n){l.data.push({key:e,type:t,size:n}),l.size+=n})},m=function(e,t){var n=[];if("snowy"===e)for(var a=0;a<120;a++)n.push(f("/weather/snow/xuehua_"+v.formatNum(a)+".png","img",t));else if("rainy"===e)for(var o=0;o<50;o++)n.push(f("/weather/rain/xiayu_"+v.formatNum(o)+".png","img",t));else if("defoliation"===e)for(var r=0;r<90;r++)n.push(f("/weather/mapleLeaves/fengye_"+v.formatNum(r)+".png","img",t));else if("fallingPeach"===e)for(var i=0;i<90;i++)n.push(f("/weather/beachBlossom/taohua_"+v.formatNum(i)+".png","img",t));else if("fallingFlower"===e)for(var s=0;s<90;s++)n.push(f("/weather/blossom/yinghua_"+v.formatNum(s)+".png","img",t));else if("lightning"===e)for(var l=0;l<50;l++)n.push(f("/weather/lightning/shandian_"+v.formatNum(l)+".png","img",t));return Promise.resolve(n)},p=function x(e,t,n,o){if(t>=e.commands.length)return Promise.resolve();var i=function(e,t){if("addImage"===e.type){var o=e.args[0],r=o.index,i=o.url;if(1===r){if("inherit"===i)return a.addRefCount("img",s.background,t),Promise.resolve();s.background=i}return f(i,"img",t)}if("addImage"===e.type&&"inherit"!==e.args[0].url)return f(e.args[0].url,"img",t);if(("playMusic"===e.type||"playSound"===e.type)&&"inherit"!==e.args[0].url){var l=e.args[0].url;return"playMusic"===e.type?(a.forceDecode.musics.length<a.MaxForceDecodeMusic&&a.forceDecode.musics.push(l),s.music=l):(s.sounds[e.args[0].index]=l,!a.forceDecode.sounds[e.args[0].index]&&(a.forceDecode.sounds[e.args[0].index]=l)),f(l,"audio",t,t)}if(("playMusic"===e.type||"playSound"===e.type)&&"inherit"===e.args[0].url)return"playMusic"===e.type?a.addRefCount("audio",s.music,t):a.addRefCount("audio",s.sounds[e.args[0].index],t),Promise.resolve();if("showDialog"===e.type)return f(e.args[0].avatar.url,"img",t);if(n&&("options"===e.type||"conditionOptions"===e.type)){var u=Promise.resolve(),c=!0,d=!1,h=void 0;try{for(var p,y=function(){var e=p.value;e.background&&(e.background.normal&&(u=u.then(function(){return f(e.background.normal.url,"img",t+"Option")})),e.background.active&&(u=u.then(function(){return f(e.background.active.url,"img",t+"Option")})),e.background.disable&&(u=u.then(function(){return f(e.background.disable.url,"img",t+"Option")}))),e.sound&&e.sound.url&&(u=u.then(function(){return f(e.sound.url,"audio",t+"Option")}))},g=e.args[Symbol.iterator]();!(c=(p=g.next()).done);c=!0)y()}catch(v){d=!0,h=v}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw h}}return u}return"weather"===e.type&&"1"!==flashvars.offline?m(e.args[0],t):Promise.resolve()},l=function c(e){for(var t=Promise.resolve(),o=a.lastUsedKeyMap,s=o.background,l=o.music,u=o.sounds,d=function(o){for(var d=function(d){t=t.then(function(){return a.lastUsedKeyMap={background:s,music:l,sounds:[].concat(r(u))},i(e[o].commands[d],"PreloadOption"+d).then(function(){if(h(!0))return Promise.resolve();var t=e[o].commands[d],a=t.type,r=t.args;return"options"===a||"conditionOptions"===a?n?c(r):Promise.resolve():void 0})}).then(function(){return a.lastUsedKeyMap={background:s,music:l,sounds:[].concat(r(u))},Promise.resolve()})},f=0;f<e[o].commands.length&&f<10;f++)d(f)},f=0;e&&f<e.length;f++)d(f);return t},u=function(e,t,n,a){return e.commands.length>t?x(e,t,n,a):d?"insert"===d.type?Promise.resolve():d.loopCondition?e.parentInfo?(t=e.parentCmdIndex+1,e=e.parentInfo,d=null,x(e,t,!1,a)):Promise.resolve():(d=null,x(e,0,!1,a)):Promise.resolve()};return i(e.commands[t],o).then(function(){if(h(!0))return Promise.resolve();var a=e.commands[t],r=a.type,i=a.args;return"back"===r||"jump"===r||"insert"===r?Promise.resolve():"options"===r||"conditionOptions"===r?n?l(i).then(function(){return u(e,t+1,!1,o)}):Promise.resolve():u(e,t+1,!0,o)})},y=function(e){for(var t=0,n=0;e.options&&n<e.options.length;n++)t+=e.options[n].plots.length;for(var a=0;e.condition_options&&a<e.condition_options.length;a++)t+=e.condition_options[a].plots.length;return t},g=function P(e,t,n,o){var i=[],l=e.plots[t];if(!l||l.commands&&!l.commands.length)return Promise.resolve();if(l.commands)return p(l,0,n,o);if("[object Array]"==Object.prototype.toString.call(l.plot_sound))for(var u in l.plot_sound){var d=l.plot_sound[u];d&&"inherit"!==d.url?(i.push(f(d.url,"audio",o)),s.sounds[u]=d.url,!a.forceDecode.sounds[u]&&(a.forceDecode.sounds[u]=d.url)):d&&"inherit"===d.url&&a.addRefCount("audio",s.sounds[u],o)}else l.plot_sound.url&&"inherit"!==l.plot_sound.url&&i.push(f(l.plot_sound.url,"audio"));l.background.url&&("inherit"!==l.background.url?(i.push(f(l.background.url,"img",o)),s.background=l.background.url):a.addRefCount("img",s.background,o));var g=!0,v=!1,x=void 0;try{for(var w,b=l.characters[Symbol.iterator]();!(g=(w=b.next()).done);g=!0){var k=w.value;k.url&&i.push(f(k.url,"img",o))}}catch(C){v=!0,x=C}finally{try{!g&&b["return"]&&b["return"]()}finally{if(v)throw x}}l.avatar.url&&i.push(f(l.avatar.url,"img",o)),l.music.url&&"inherit"!==l.music.url?(a.forceDecode.musics.length<a.MaxForceDecodeMusic&&a.forceDecode.musics.push(l.music.url),i.push(f(l.music.url,"audio",o)),s.music=l.music.url):"inherit"===l.music.url&&a.addRefCount("audio",s.music,o);var _=!0,S=!1,I=void 0;try{for(var E,L=l.props[Symbol.iterator]();!(_=(E=L.next()).done);_=!0){var T=E.value;T.url&&i.push(f(T.url,"img",o))}}catch(C){S=!0,I=C}finally{try{!_&&L["return"]&&L["return"]()}finally{if(S)throw I}}var M=!0,A=!1,O=void 0;try{for(var V,N=l.options[Symbol.iterator]();!(M=(V=N.next()).done);M=!0){var B=V.value;B.background&&(B.background.normal&&i.push(f(B.background.normal.url,"img",o+"Option")),B.background.active&&i.push(f(B.background.active.url,"img",o+"Option")),B.background.disable&&i.push(f(B.background.disable.url,"img",o+"Option"))),B.sound&&B.sound.url&&f(B.sound.url,"audio",o+"Option")}}catch(C){A=!0,O=C}finally{try{!M&&N["return"]&&N["return"]()}finally{if(A)throw O}}l.weather.value&&"1"!==flashvars.offline&&m(l.weather.value,o).then(function(e){return i.push.apply(i,r(e))});var R=function(){for(var e=Promise.resolve(),t=a.lastUsedKeyMap,n=t.background,o=t.music,i=t.sounds,s=function(t){for(var s={plots:l.options[t].plots},u=function(t){e=e.then(function(){return a.lastUsedKeyMap={background:n,music:o,sounds:[].concat(r(i))},P(s,t,!1,"PreloadOption"+t)}).then(function(){return a.lastUsedKeyMap={background:n,music:o,sounds:[].concat(r(i))},Promise.resolve()})},c=0;c<l.options[t].plots.length&&c<2;c++)u(c)},u=0;l.options&&u<l.options.length;u++)s(u);for(var c=function(t){for(var s={plots:l.condition_options[t].plots},u=function(t){e=e.then(function(){return a.lastUsedKeyMap={background:n,music:o,sounds:[].concat(r(i))},P(s,t,!1,"PreloadConOption"+t)}).then(function(){return a.lastUsedKeyMap={background:n,music:o,sounds:[].concat(r(i))},Promise.resolve()})},c=0;c<l.condition_options[t].plots.length&&c<3;c++)u(c)},u=0;l.condition_options&&u<l.condition_options.length;u++)c(u);return e},j=function(e,t,n,a){return e.plots.length>t?P(e,t,n,a):c?"insert"===c.type?Promise.resolve():c.loopCondition?e.parent?(t=c.isCommand?e.parent.pnPlot:e.parent.pnPlot+1,e=e.parent.pChapter,c=null,P(e,t,!1,a)):Promise.resolve():(c=null,P(e,0,!1,a)):Promise.resolve()};return Promise.all(i).then(function(){return h()||!n?Promise.resolve():y(l)?R().then(function(){return j(e,t+1,!1,o)}):j(e,t+1,!0,o)})};return o?p(o,i,!0,"play").then(function(){return l}):g(t,n,!0,"play").then(function(){return l})}},{key:"getResourcesSize",value:function(e){var t=[];return e.forEach(function(e){t.push(u.getResourceSize(e.key,e.type))}),Promise.all(t).then(function(e){return e.reduce(function(e,t){return e+t},0)})}}]),e}();x.MaxSize=2e8,x.MaxCount=64,x.MaxForceDecodeMusic=3,x.refCount={audio:{},img:{}},x.usingKeyMap={background:"",sounds:new Array(10).fill(""),music:""},x.forceDecode={musics:[],sounds:new Array(10).fill("")},x.lastUsedKeyMap={background:"",sounds:new Array(10).fill(""),music:""};var P=e.AudioTagPool=function(){function e(){i(this,e)}return s(e,null,[{key:"get",value:function(){var t=e.pool.find(function(e){return e.free});return t?(t.pause(),t.free=!1):t=document.createElement("audio"),t}},{key:"exist",value:function(t){return e.pool.some(function(e){return e===t})}},{key:"fill",value:function(){var t=function(t){for(var n=0;n<t;n++){var a=document.createElement("audio");a.free=!0,a.loop=!1,a.play(),e.pool.push(a)}};if(e.pool.length){var n=e.pool.reduce(function(e,t){return e+(t&&t.free?1:0)},0);n<10&&t(50)}else t(100)}}]),e}();P.pool=[]}),require.register("js/common/Version.js",function(e,t,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a="0a83f1fef94b8b9aa1ed36106131c9078d836ef4";e["default"]=a;var o="1.0.0";e.version=o}),require.register("js/common/XmlHttpRequest.js",function(e,t,n){"use strict";function a(e){return e._=Date.now(),"?"+Object.keys(e).map(function(t){var n=e[t];return n?encodeURIComponent(t)+"="+encodeURIComponent(n):""}).join("&")}function o(e){return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onload=function(){try{return 4===a.readyState&&a.status>=400&&a.status<=599?n("error readyState: "+a.readyState+", status: "+a.status):t(a)}catch(e){n(e)}},a.onerror=n,a.send()})}function r(e,t,n,a){return new Promise(function(o,r){var i=new XMLHttpRequest;i.ontimeout=function(){console.log(e+" time out")},i.onreadystatechange=function(){switch(i.readyState){case 4:return i.status>=200&&i.status<300||304==i.status?o(i):r("error readyState: "+i.readyState+", status: "+i.status)}},i.open("post",e,!0),i.withCredentials=!0,a&&(i.timeout=a),n&&i.addEventListener("progress",n,!1),i.setRequestHeader("CONTENT-TYPE","application/x-www-form-urlencoded"),i.send(t),i.onerror=r})}function i(e,t,n){return new Promise(function(a,o){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType=t,r.onload=function(){try{return 4===r.readyState&&r.status>=400&&r.status<=599?o("error readyState: "+r.readyState+", status: "+r.status):a(r)}catch(e){o(e)}},n&&r.addEventListener("progress",n,!1),r.onerror=o,r.send()})}function s(e,t){return i(e,"",t).then(function(e){return JSON.parse(e.response)})}function l(e){return s(h.materialRedirect+a({url:e})).then(function(e){return"100"==e.code?e.result:Promise.reject(e.message)})}function u(e,t){var n=h.getGame+"?uuid="+e;return s(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function c(e,t){var n=h.getTestGame+"?uuid="+e;return s(n,t).then(function(e){return"100"==e.code?e.result:"1"===flashvars.offline?e:Promise.reject(e.message)})}function d(e,t){return"img"===t?Promise.resolve(2e5):"audio"===t?Promise.resolve(2e6):void 0}Object.defineProperty(e,"__esModule",{value:!0}),e.xhrGetServerTime=o,e.xhrSend=r,e.xhrLoad=i,e.getJson=s,e.getMaterialRedirect=l,e.getGame=u,e.getTestGame=c,e.getResourceSize=d;var h={getGame:"https://mapi.3000api.com/apis/soft/v1.0/game-info.html",getTestGame:"https://mapi.3000api.com/apis/soft/v1.0/game-test.html",materialRedirect:"https://mapi.3000api.com/client/material-redirect.html"}}),require.register("js/controller/command/PrepareControllerCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareControllerCommand",parent:r["default"].SimpleCommand},{execute:function(e){}})}),require.register("js/controller/command/PrepareModelCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareModelCommand",parent:r["default"].SimpleCommand},{execute:function(e){this.facade.registerProxy(new diygamePlayer.model.proxy.SceneProxy)}})}),require.register("js/controller/command/PrepareViewCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.PrepareViewCommand",parent:r["default"].SimpleCommand},{execute:function(e){this.facade.registerMediator(new diygamePlayer.view.mediator.SceneMediator)}})}),require.register("js/controller/command/StartupCommand.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o);r["default"].define({name:"diygamePlayer.controller.command.StartupCommand",parent:r["default"].MacroCommand},{initializeMacroCommand:function(){this.addSubCommand(diygamePlayer.controller.command.PrepareControllerCommand),this.addSubCommand(diygamePlayer.controller.command.PrepareModelCommand),this.addSubCommand(diygamePlayer.controller.command.PrepareViewCommand)}})}),require.register("js/main.js",function(e,t,n){"use strict";t("babel-polyfill"),t("./AppConstants.js"),t("./ApplicationFacade.js"),t("./controller/command/PrepareControllerCommand.js"),t("./controller/command/PrepareModelCommand.js"),t("./controller/command/PrepareViewCommand.js"),t("./controller/command/StartupCommand.js"),t("./model/proxy/SceneProxy.js"),t("./view/component/Scene.js"),t("./view/mediator/SceneMediator.js"),document.addEventListener("DOMContentLoaded",function(){diygamePlayer.ApplicationFacade.getInstance(diygamePlayer.ApplicationFacade.NAME).startup(),console.log("Initialized")})}),require.register("js/model/proxy/SceneProxy.js",function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var l=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),u=t("puremvc"),c=o(u),d=t("../../common/Utils.js"),h=o(d),f=t("spark-md5"),m=o(f),p=t("./../../common/Dialog.js"),y=o(p),g=t("./../../common/ShanyiMenu.js"),v=o(g),x=t("./../../common/XmlHttpRequest.js"),P=a(x),w=t("../../common/PhoneUtils.js"),b=o(w),k=t("../../common/FontUtils.js"),C=o(k);c["default"].define({name:"diygamePlayer.model.proxy.SceneProxy",parent:c["default"].Proxy},{chargeMsgReceive:function(e){if("msgCharged"===e.originalEvent.key){var t=JSON.parse(e.originalEvent.newValue);t&&"doit"==t.command&&alert(t.data)}},resumeAudio:function(){this.bk_music&&this.bk_music.play(),this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.resume()})},pauseAudio:function(){this.bk_music&&this.bk_music.pause(),this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.pause()})},preloadingBegin:function(){this.stringMap={},this.stringMap.loadMenu="读档",this.stringMap.overMenu="结束",this.stringMap.settingsMenu="设置",this.stringMap.startMenu="开始",this.stringMap.menu="菜单",this.stringMap.mainMenu="菜单",this.stringMap.save="保存进度",this.stringMap.load="读取进度",this.stringMap.playback="剧情回放",this.stringMap.autoplay="自动播放",this.stringMap.manualPlay="手动播放",this.stringMap.settings="设置",this.stringMap.displayHeader="显示设定",this.stringMap.displayCaption="画面模式",this.stringMap.textHeader="文字设定",this.stringMap.textCaption="自动进行",this.stringMap.autoOn="开",this.stringMap.autoOff="关",this.stringMap.windowMode="窗口模式",this.stringMap.fullMode="全屏模式",this.stringMap.back="返回",this.progressTips=["手指右滑就可召唤退出按钮，退出作品时，记得存档哦","收藏作品，更新会第一时间通知你","把作品下载到本地，随时随地任性玩","感觉作品很棒，和你的好友分享吧~","引战、刷屏、作品无关的评论会被删除哦","素材库为全站通用，可能发生人物走错片场的情况，请不要慌张","在当前作品的评论中对比其他作品容易给作者大大招黑哦~","制作辛苦，写下精彩长评支持喜欢的作者吧","长按屏幕可以快进剧情"],this.recordTipCount=0,this.isShowGuide=!0,this.plotSounds=[],this.playbackData=[],this.plotViews=[],this.prgsViews=[],this.plotViewKeys=[],this.bViewLoaded=!1,this.bSignedIn=!1,this.bCloudSel=!1,this.visibleLayout=[],this.resourceManager={plotIndex:0,resourceList:[],baseList:[]},this.lstDialogInfo=[],this.menuInfo=[],this.quickPlay=!1,this.isScreenHold=!1,this.bCmdAutoText=!1,this.isGameStarted=!1,this.usedStarCount=0,this.gameStarLimit=0,this.lstPlotTweens=[],this.twinkleTimer=null,this.uiOnLoadQueue=[],this.timerCounts=[],this.menuTimer=[],this.recUidBelongTo=flashvars.uid,this.gameUidBelongTo=flashvars.uid,this.bSwitchAccInPlot=!0,this.payValueUid=flashvars.uid,this.unlockChapterCallBack=null,this.mallPayCallback=null,audioMgr.pause=this.pauseAudio.bind(this),audioMgr.resume=this.resumeAudio.bind(this),audioMgr.audioCanPlayCallBack=b["default"].audioCanPlayCallBack.bind(b["default"]),gameCallback.updateAccInfo=this.updateAccInfo.bind(this),gameCallback.unlockChapterFinished=this.unlockChapterFinished.bind(this),
gameCallback.mallPay=this.mallPay.bind(this),this.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN)},unlockChapterFinished:function(e,t){this.unlockChapterCallBack&&this.unlockChapterCallBack(e,t)},mallPay:function(e){this.mallPayCallback&&this.mallPayCallback(e),this.mallPayCallback=null},checkIfMallPaySuccess:function(e){var t=function(t,n){return P.xhrSend(t,n).then(function(t){if(0===t.responseText.length)return Promise.resolve(!1);var n=JSON.parse(t.responseText);return 0===n.status?Promise.resolve(n.data.serial_num===e&&"1"==n.data.c_status):100===n.status?Promise.resolve(!1):Promise.resolve(!1)},function(e){return Promise.resolve(!1)})},n="https://app.3000.com/?m=consume&op=index&ac=market_order_status&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,a="u="+encodeURIComponent(h["default"].aesEncrypt(flashvars.u,1))+"&token="+encodeURIComponent(h["default"].aesEncrypt(flashvars.token,1))+"&serial_num="+encodeURIComponent(h["default"].aesEncrypt(e,1));return t(n,a)},addAssets:function(e,t,n,a){var o=this,r=n||e;return!("img"===t&&this.viewComponent.game.load.cache.checkImageKey(r)||"audio"===t&&this.viewComponent.game.load.cache.checkSoundKey(r))||"ios"===flashvars.client&&"audio"===t&&flashvars.app_version>="1.5.0"?h["default"].convertToAllowAccessControlOriginUrl(e).then(function(e){if(e)if("img"===t)o.viewComponent.game.load.image(r,e),!a&&d.ResourcesManager.addRefCount("img",r,"global");else if("audio"===t){var n=d.ResourcesManager.forceDecode.music===r||d.ResourcesManager.forceDecode.sounds.some(function(e){return e===r});"ios"===flashvars.client&&flashvars.app_version>="1.5.0"?b["default"].loadAudioUrl(r,e,flashvars.offline):o.viewComponent.game.load.audio(r,e,n),"android"===flashvars.client?!a&&d.ResourcesManager.addRefCount("audio",r,"global"):!a&&d.ResourcesManager.addRefCount("audio",r,"global")}},function(e){return console.error("Invalid URL: "+e)}):Promise.resolve()},addImage:function(e,t,n){this.viewComponent.game.cache.addImage(e,t||null,n)},addImageUrl:function(e,t){var n=this;return new Promise(function(a,o){var r=new Image;r.src=e,r.onload=function(o){n.viewComponent.game.load.cache.checkImageKey(t)||(n.viewComponent.game.cache.addImage(t,e,o.target),a())},r.onerror=r.onabort=function(e){return o(e)}})},parseJsonFile:function(e){var t=this;this.json_data=e;var n=[];return this.json_data.template&&this.json_data.template.json&&(n.push(this.parseTemplateCoverAssets()),n.push(this.parseTemplateDialogAssets()),n.push(this.parseTemplateMenuAssets()),n.push(this.parseTemplateSyMenuAssets()),n.push(this.parseTemplateMainMenuAssets()),n.push(this.parseTemplateSettingsAssets()),n.push(this.parseTemplateOptionAssets()),n.push(this.parseTemplatePlaybackAssets()),n.push(this.parseTemplateRecordAssets()),n.push(this.parseTemplateSoundAssets())),Promise.all(n).then(function(){return Promise.resolve()}).then(function(){if(n.length=0,C["default"].fontImage&&t.viewComponent.game.load.image(C["default"].fontFamily,C["default"].fontImage),t.json_data.logo&&t.json_data.logo.background&&t.json_data.logo.background.url&&n.push(t.addAssets(t.json_data.logo.background.url,"img")),t.json_data.cover.background&&t.json_data.cover.background.url&&n.push(t.addAssets(t.json_data.cover.background.url,"img")),t.json_data.cover.music&&t.json_data.cover.music.url){var e=t.json_data.cover.music.url;n.push(t.addAssets(e,"audio"))}var a=function(e){"[object Array]"==Object.prototype.toString.call(e)&&e.forEach(function(e){e.events.forEach(function(e){"playMusic"===e.type&&e.handle.music.url?n.push(t.addAssets(e.handle.music.url,"audio")):"playSound"===e.type&&e.handle.sounds.forEach(function(e){e&&"inherit"!=e.url&&n.push(t.addAssets(e.url,"audio"))})})})};for(var o in t.json_data.viewMap)if("timer"!==t.json_data.viewMap[o].type){var r=t.json_data.viewMap[o].content.background,i=t.json_data.viewMap[o].content.sound;r&&(r.url&&n.push(t.addAssets(r.url,"img")),r.normal&&r.normal.url&&n.push(t.addAssets(r.normal.url,"img")),r.active&&r.active.url&&n.push(t.addAssets(r.active.url,"img")),r.progress&&r.progress.url&&n.push(t.addAssets(r.progress.url,"img")),i&&i.url&&n.push(t.addAssets(i.url,"audio")),a(t.json_data.viewMap[o].events),t.json_data.viewMap[o].children.forEach(function(e){a(e.events)}))}else a(t.json_data.viewMap[o].events);return Promise.all(n).then(function(){return Promise.resolve()},function(e){return Promise.reject(e)})})},parseTemplateCoverAssets:function(){var e=[],t=this.json_data.template.json.cover,n=t.titleContainer,a=t.startMenu,o=t.loadMenu,r=t.settingsMenu,i=t.overMenu;return n.background.url&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.normal.background.url&&a.normal.background.url&&e.push(this.addAssets(a.normal.background.url,"img")),a.active.background.url&&a.active.background.url&&e.push(this.addAssets(a.active.background.url,"img")),o.normal.background.url&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),r.normal.background.url&&r.normal.background.url&&e.push(this.addAssets(r.normal.background.url,"img")),r.active.background.url&&r.active.background.url&&e.push(this.addAssets(r.active.background.url,"img")),i.normal.background.url&&i.normal.background.url&&e.push(this.addAssets(i.normal.background.url,"img")),i.active.background.url&&i.active.background.url&&e.push(this.addAssets(i.active.background.url,"img")),Promise.all(e)},parseTemplateDialogAssets:function(){var e=[],t=this.json_data.template.json.dialog,n=t.background,a=t.avatarContainer,o=t.titleContainer;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background.url&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.background.url&&o.background.url&&e.push(this.addAssets(o.background.url,"img")),Promise.all(e)},parseTemplateMenuAssets:function(){var e=[],t=this.json_data.template.json.menu,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)},parseTemplateSyMenuAssets:function(){if(this.json_data.template.json.shanyiMenu){var e=[],t=this.json_data.template.json.shanyiMenu,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)}},parseTemplateMainMenuAssets:function(){var e=[],t=this.json_data.template.json.mainMenu,n=t.background,a=t.header,o=t.save,r=t.load,i=t.playback,s=t.autoplay,l=t.settings,u=t.back;return n.url&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),r.normal.background&&r.normal.background.url&&e.push(this.addAssets(r.normal.background.url,"img")),r.active.background&&r.active.background.url&&e.push(this.addAssets(r.active.background.url,"img")),i.normal.background&&i.normal.background.url&&e.push(this.addAssets(i.normal.background.url,"img")),i.active.background&&i.active.background.url&&e.push(this.addAssets(i.active.background.url,"img")),s.normal.background&&s.normal.background.url&&e.push(this.addAssets(s.normal.background.url,"img")),s.active.background&&s.active.background.url&&e.push(this.addAssets(s.active.background.url,"img")),l.normal.background&&l.normal.background.url&&e.push(this.addAssets(l.normal.background.url,"img")),l.active.background&&l.active.background.url&&e.push(this.addAssets(l.active.background.url,"img")),u.normal.background&&u.normal.background.url&&e.push(this.addAssets(u.normal.background.url,"img")),u.active.background&&u.active.background.url&&e.push(this.addAssets(u.active.background.url,"img")),Promise.all(e)},parseTemplateSettingsAssets:function(){var e=[],t=this.json_data.template.json.settings,n=t.background,a=t.header,o=t.displayHeader,r=t.textHeader,i=t.displayCaption,s=t.textCaption,l=t.fullMode,u=t.windowMode,c=t.autoOn,d=t.autoOff,h=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),o.background&&o.background.url&&e.push(this.addAssets(o.background.url,"img")),r.background&&r.background.url&&e.push(this.addAssets(r.background.url,"img")),i.background&&i.background.url&&e.push(this.addAssets(i.background.url,"img")),s.background.url&&s.background.url&&e.push(this.addAssets(s.background.url,"img")),l.unchecked.background&&l.unchecked.background.url&&e.push(this.addAssets(l.unchecked.background.url,"img")),l.checked.background&&l.checked.background.url&&e.push(this.addAssets(l.checked.background.url,"img")),u.unchecked.background&&u.unchecked.background.url&&e.push(this.addAssets(u.unchecked.background.url,"img")),u.checked.background&&u.checked.background.url&&e.push(this.addAssets(u.checked.background.url,"img")),c.unchecked.background&&c.unchecked.background.url&&e.push(this.addAssets(c.unchecked.background.url,"img")),c.checked.background&&c.checked.background.url&&e.push(this.addAssets(c.checked.background.url,"img")),d.unchecked.background&&d.unchecked.background.url&&e.push(this.addAssets(d.unchecked.background.url,"img")),d.checked.background&&d.checked.background.url&&e.push(this.addAssets(d.checked.background.url,"img")),h.normal.background&&h.normal.background.url&&e.push(this.addAssets(h.normal.background.url,"img")),h.active.background&&h.active.background.url&&e.push(this.addAssets(h.active.background.url,"img")),Promise.all(e)},parseTemplateOptionAssets:function(){var e=[],t=this.json_data.template.json.option,n=t.normal,a=t.active;return n.background&&n.background.url&&e.push(this.addAssets(n.background.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),Promise.all(e)},parseTemplatePlaybackAssets:function(){var e=[],t=this.json_data.template.json.playback,n=t.background,a=t.scrollBox,o=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),a.item.background&&a.item.background.url&&e.push(this.addAssets(a.item.background.url,"img")),a.item.content.background&&a.item.content.background.url&&e.push(this.addAssets(a.item.content.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),Promise.all(e)},parseTemplateRecordAssets:function(){var e=[],t=this.json_data.template.json.record,n=t.background,a=t.scrollBox,o=t.back;return n&&n.url&&e.push(this.addAssets(n.url,"img")),a.background&&a.background.url&&e.push(this.addAssets(a.background.url,"img")),a.item.background&&a.item.background.url&&e.push(this.addAssets(a.item.background.url,"img")),a.item.content.background&&a.item.content.background.url&&e.push(this.addAssets(a.item.content.background.url,"img")),o.normal.background&&o.normal.background.url&&e.push(this.addAssets(o.normal.background.url,"img")),o.active.background.url&&o.active.background.url&&e.push(this.addAssets(o.active.background.url,"img")),Promise.all(e)},parseTemplateSoundAssets:function(){var e=[];return this.json_data.template.json.sound&&this.json_data.template.json.sound.url&&e.push(this.addAssets(this.json_data.template.json.sound.url,"audio")),Promise.all(e)},showLogo:function(){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_LOGO)},showCover:function(){this.json_data.cover.music;this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU)},showMainMenu:function(e){this.onPause(),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU,e)},showSettings:function(e,t){this.onPause(),this.mainMenuLayer.visible&&(this.mainMenuLayer.visible=!1,this.visibleLayout=[this.mainMenuLayer].concat(s(this.visibleLayout))),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS,{context:e,callbackInfo:t})},showPlayback:function(e){this.onPause(),this.mainMenuLayer.visible&&(this.mainMenuLayer.visible=!1,this.visibleLayout=[this.mainMenuLayer].concat(s(this.visibleLayout))),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK,e)},showSave:function(e,t){this.menuLayer.visible=!1,this.bToSaveFile=!0,this.loadData(e),this.showRecord(t)},showLoad:function(e,t){var n=this;this.menuLayer.visible=!1,""===flashvars.u&&""===flashvars.token&&""===flashvars.client&&(flashvars.uid=h["default"].getUidByCookie()),this.getPayInfo().then(function(){n.bToSaveFile=!1,n.loadData(e),n.showRecord(t)})},showRecord:function(e){this.onPause(),this.mainMenuLayer.visible&&(this.mainMenuLayer.visible=!1,this.visibleLayout=[this.mainMenuLayer].concat(s(this.visibleLayout))),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_RECORD,e)},showEnd:function(){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!1),this.sendNotification(diygamePlayer.AppConstants.SCENE_GOTO_END)},getOneCommandResourceInfo:function(e){var t=[],n="";switch(e.type){case"addImage":n=1===e.args[0].index&&"inherit"===e.args[0].url?this.lstPlotBkKey:e.args[0].url,t.push({type:"img",url:n});break;case"showDialog":t.push({type:"img",url:e.args[0].avatar.url});break;case"playMusic":n="inherit"===e.args[0].url?d.ResourcesManager.usingKeyMap.music:e.args[0].url,t.push({type:"audio",url:n});break;case"playSound":n="inherit"===e.args[0].url?d.ResourcesManager.usingKeyMap.sounds[e.args[0].index]:e.args[0].url,t.push({type:"audio",url:n});break;case"options":var a=!0,o=!1,r=void 0;try{for(var i,s=e.args[Symbol.iterator]();!(a=(i=s.next()).done);a=!0){var l=i.value;l.background&&(l.background.normal&&t.push({type:"img",url:l.background.normal.url}),l.background.active&&t.push({type:"img",url:l.background.active.url}),l.background.disable&&t.push({type:"img",url:l.background.disable.url})),l.sound&&l.sound.url&&t.push({type:"audio",url:l.sound.url})}}catch(u){o=!0,r=u}finally{try{!a&&s["return"]&&s["return"]()}finally{if(o)throw r}}}return t},isPlotResourceExist:function(e){var t=this;if(e.commands)return!1;var n=function(e,n){var a=d.ResourcesManager.getCount(e,n,"play"),o=t.usingResourceCount(n);if(!a||a==o)return!0};if(""!==e.background.url&&"inherit"!==e.background.url&&n("img",e.background.url))return!1;if("inherit"===e.background.url&&n("img",this.lstPlotBkKey))return!1;if(""!==e.avatar.url&&n("img",e.avatar.url))return!1;if(""!==e.music.url&&"inherit"!==e.music.url&&(n("audio",e.music.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0"))return!1;if("inherit"===e.music.url&&this.bk_music&&n("audio",this.bk_music.key))return!1;if("inherit"===e.music.url&&"ios"===flashvars.client&&flashvars.app_version>="1.5.0")return!1;if(e.options.length){var a=!0,o=!1,r=void 0;try{for(var i,l=e.options[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var u=i.value;if(u.background&&u.background.normal&&u.background.normal.url&&n("img",u.background.normal.url))return!1;if(u.background&&u.background.active&&u.background.active.url&&n("img",u.background.active.url))return!1;if(u.background&&u.background.disable&&u.background.disable.url&&n("img",u.background.disable.url))return!1;if(u.sound&&u.sound.url&&n("audio",u.sound.url))return!1}}catch(c){o=!0,r=c}finally{try{!a&&l["return"]&&l["return"]()}finally{if(o)throw r}}}if(e.characters.length||e.props.length)for(var h=[].concat(s(e.characters),s(e.props)),f=0;f<h.length;f++){var m=h[f];if(n("img",m.url))return!1}if(e.weather){if("snowy"===e.weather.value&&!this.viewComponent.game.cache.checkImageKey("/weather/snow/xuehua_00119.png"))return!1;if("rainy"===e.weather.value&&!this.viewComponent.game.cache.checkImageKey("/weather/rain/xiayu_00049.png"))return!1;if("defoliation"===e.weather.value&&!this.viewComponent.game.cache.checkImageKey("/weather/mapleLeaves/fengye_00089.png"))return!1;if("fallingPeach"===e.weather.value&&!this.viewComponent.game.cache.checkImageKey("/weather/beachBlossom/taohua_00089.png"))return!1;if("fallingFlower"===e.weather.value&&!this.viewComponent.game.cache.checkImageKey("/weather/blossom/yinghua_00089.png"))return!1;if("lightning"===e.weather.value&&!this.viewComponent.game.cache.checkImageKey("/weather/lightning/shandian_00049.png"))return!1}for(var p in e.plot_sound)if(e.plot_sound[p]&&("inherit"!==e.plot_sound[p].url&&n("audio",e.plot_sound[p].url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version))return!1;return!0},usingResourceCount:function(e){var t=this,n=i({},this.lstPlotBkKey,1),a=function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.viewComponent.game.world;return e.children.forEach(function(e){n[e.key]=(n[e.key]||0)+1,r(e)})},o=function(){return t.viewComponent.game.sound._sounds.forEach(function(e){return n[e.key]=(n[e.key]||0)+1})};return a(),o(),n[e]||0},resetResources:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];d.ResourcesManager.forEachReCount(function(n,a,o){var r=e.usingResourceCount(a);r>0&&d.ResourcesManager.addRefCount(n,a,"play",r),t.some(function(e){return e.key===a})?(a===d.ResourcesManager.usingKeyMap.music&&d.ResourcesManager.addRefCount(n,a),a===d.ResourcesManager.usingKeyMap.background&&d.ResourcesManager.addRefCount(n,a),d.ResourcesManager.usingKeyMap.sounds.some(function(e){return e===a})&&d.ResourcesManager.addRefCount(n,a)):!o&&d.ResourcesManager.removeFromCache(n,a)})},getResources:function(e,t,n){var a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=arguments[4],i=o.cmdInfo,l=o.cmdIndex,u=o.cmdScreenSnap,c=t.plots,h=d.ResourcesManager.usingKeyMap,f=h.music,m=h.sounds,p=h.background;return r&&(f=r.music.url,m=r.sounds.map(function(e){return e&&e.url}),p=r.background),d.ResourcesManager.lastUsedKeyMap={music:f,background:p,sounds:[].concat(s(m))},d.ResourcesManager.forceDecode={musics:[],sounds:new Array(10).fill("")},d.ResourcesManager.resetReCount(),d.ResourcesManager.getResourcesByContext(e,t,n,i,l).then(function(e){var i=function(t){e.data.some(function(e){return e.key===t.key})||e.data.push(t),d.ResourcesManager.addRefCount(t.type,t.key)};if(void 0!==n&&c[n]&&!c[n].commands&&"inherit"===c[n].music.url){var s=a.getMusic(t,n);s&&i({key:s,type:"audio"})}if(r){var l=r.music,h=r.sounds,f=r.charsAndProps,m=r.background,p=r.images;m&&!e.data.some(function(e){return e.key===m})&&i({key:m,type:"img"}),l&&!e.data.some(function(e){return e.key===l.url})&&(d.ResourcesManager.forceDecode.musics.push(l.url),i({key:l.url,type:"audio"})),h&&h.forEach(function(t,n){t&&!e.data.some(function(e){return e.key===t.url})&&(d.ResourcesManager.forceDecode.sounds[n]=t.url,i({key:t.url,type:"audio"}))}),f&&f.forEach(function(t){e.data.some(function(e){return e.key===t.url})||i({key:t.url,type:"img"})}),p&&p.forEach(function(t){e.data.some(function(e){return e.key===t.url})||i({key:t.url,type:"img"})})}if(u){var y=o.cmdScreenSnap,g=y.music,v=y.sounds,x=y.charsAndProps,P=y.dialogInfo,w=y.bk;P&&P[0]&&P[0].avatar.url&&i({key:P[0].avatar.url,type:"img"}),w&&w.url&&i({key:w.url,type:"img"}),g&&g.url&&i({key:g.url,type:"audio"}),v&&v.forEach(function(e,t){return e&&e.url&&i({key:e.url,type:"audio"})}),x&&x.forEach(function(e){return e&&e.url&&i({key:e.url,type:"img"})})}return e})},preloadCommandsAssets:function(e,t,n,a,o,r){var i=this;return this.getResources(e,t,n,{cmdInfo:a,cmdIndex:o},r).then(function(e){var t=[];return i.resetResources(e.data),e.data.forEach(function(e){t.push(i.addAssets(e.key,e.type,e.key,!0))}),Promise.all(t)})},preloadChapterAssets:function(e,t,n,a,o){var r=this;return this.curChapter=t,this.curPlotIndex=n||0,this.cmdPlotSnap=a,this.getResources(e,t,n,a,o).then(function(t){var n=[];return r.resetResources(t.data),t.data.forEach(function(e){n.push(r.addAssets(e.key,e.type,e.key,!0))}),Promise.all(n).then(function(){r.sendNotification(diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY,{context:e,loadData:o})})})},enableLayerInput:function(e,t){var n=function o(e,t){if(e.inputEnabled!=!t||e.text||(e.inputEnabled=t),e.children.length>0)for(var n in e.children)o(e.children[n],t)};if("recordLayer"===e.name)return void(e.visible=t);if("menuLayer"===e.name)e.children[0].inputEnabled=t;else for(var a in e.children)n(e.children[a],t)},apToFinalState:function(){if(this.charsAndPropsLayer&&this.charsAndPropsLayer.exists)for(var e=0;e<this.charsAndPropsLayer.children.length;e++){var t=this.charsAndPropsLayer.children[e],n=t.children[0];n&&n.finalState&&(n.alpha=n.finalState.alpha,n.angle=n.finalState.angle,n.x=n.finalState.x,n.y=n.finalState.y,t.x=0,t.y=0,t.scale.x=t.finalState.scale.x,t.scale.y=t.finalState.scale.y)}},removePlotTweens:function(){for(this.twinkleTimer&&this.twinkleTimer.cancel()&&(this.twinkleTimer=null);this.lstPlotTweens.length;){var e=this.lstPlotTweens.splice(0,1);e[0].stop(!0),e[0].target&&"twinkle"===e[0].target.name&&e[0].target.destroy()}this.apToFinalState()},onPause:function(){this.playPause=!0;for(var e=this.viewComponent.game.tweens._tweens.length-1;e>=0;e--){var t=this.viewComponent.game.tweens._tweens[e];t.name&&"toast"===t.name||t.pause()}this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!1)},onResume:function(){this.playPause=!1,this.viewComponent.game.tweens.resumeAll(),this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW,!0)},onCoverStartBtnClicked:function(){var e=this,t=this.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length)if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client)this.checkIfChapterFree(n,t.md5).then(function(n){t.plots=n,e.preloadChapterAssets(e.context,t)},function(t){-1===t.indexOf("code=87")?y["default"].error(t):y["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买"),e.coverLayer.visible=!0});else{var a=function(a,o){a?e.checkIfChapterFree(n,t.md5).then(function(n){e.unlockChapterCallBack=null,t.plots=n,e.preloadChapterAssets(e.context,t)},function(){y["default"].error("获取付费章节信息失败"),e.coverLayer.visible=!0}):o&&(e.coverLayer.visible=!0)};this.unlockChapter(n,t.charge,t.md5,a)}else this.preloadChapterAssets(this.context,t);this.coverLayer.visible=!1},onCoverLoadBtnClicked:function(){this.showLoad()},onCoverSettingBtnClicked:function(){this.showSettings(this.context)},onCoverOverBtnClicked:function(){navigator.userAgent.indexOf("MSIE")>0?navigator.userAgent.indexOf("MSIE 6.0")>0?(window.opener=null,window.close()):(window.open("","_top"),window.top.close()):navigator.userAgent.indexOf("Firefox")>0?window.location.href="about:blank ":(window.opener=null,window.open("","_self"),window.close())},onMenuBtnClicked:function(){this.getSnap(),this.showMainMenu(this.context)},onSyMenuBtnClicked:function(){"ios"===flashvars.client||"android"===flashvars.client?flashvars.app_version<"1.2.0"?y["default"].info("版本过低，不支持该功能"):window.app&&window.app.moreWorks():v["default"].showSyMenu().then(function(e){1!==e&&"string"==typeof e&&-1!==e.indexOf("http")&&(window.location.href=e)})},onMainMenuSaveBtnClicked:function(){this.context.disableSaveOrLoad&&this.context.disableSaveOrLoad.save?this.showToast(1,"抱歉，作者在此设置了禁用存档"):this.showSave()},onMainMenuLoadBtnClicked:function(){this.context.disableSaveOrLoad&&this.context.disableSaveOrLoad.load?this.showToast(1,"抱歉，作者在此设置了禁用读档"):this.showLoad()},onMainMenuPlaybackBtnClicked:function(){this.showPlayback()},onMainMenuAutoplayBtnClicked:function(){this.context.auto=!this.context.auto,this.onMainMenuBackBtnClicked()},onMainMenuSettingsBtnClicked:function(){this.showSettings(this.context)},onMainMenuBackBtnClicked:function(){this.mainMenuLayer.visible=!1,this.onResume(),this.context.auto&&this.curPlotLayer.onChildInputDown.dispatch("auto")},onSettingsFullModeBtnClicked:function(){this.viewComponent.game.scale.startFullScreen(!1),this.context.fullScreen=!0},onSettingsWindowModeBtnClicked:function(){this.viewComponent.game.scale.stopFullScreen(),this.context.fullScreen=!1},onSettingsAutoOnBtnClicked:function(){this.context.auto=!0},onSettingsAutoOffBtnClicked:function(){this.context.auto=!1},onSettingsBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.visibleLayout=this.visibleLayout.slice(1),this.settingsLayer.visible=!1},onRecordBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.visibleLayout=this.visibleLayout.slice(1),this.recordLayer.visible=!1,this.showMenu()},onRecordLocalBtnClicked:function(){this.bCloudSel=!1,this.bToSaveFile?this.showSave(!0):this.showLoad(!0)},onRecordCloudBtnClicked:function(){this.bCloudSel=!0,this.bToSaveFile?this.showSave(!0):this.showLoad(!0)},showMenu:function(){this.menuLayer.visible=!0,this.curPlotInfo&&this.curPlotInfo.menu&&(this.menuLayer.visible=!this.curPlotInfo.menu.hidden)},showGuideTip:function(e){this.sendNotification(diygamePlayer.AppConstants.SCENE_SHOW_GUIDE,{id:e})},isSignedIn:function(){var e=this;return this.loadCloudRecord(99).then(function(t){var n=function(e){for(var t=JSON.parse(e),n=Array(12),a=0;a<t.length;a++)if(t[a].plotUuid){var o=""+t[a].time_stamp;n[a]={},n[a].plotUuid=t[a].plotUuid,n[a].timestamp=o.length>10?t[a].time_stamp:1e3*t[a].time_stamp,n[a].plotSnap="data:image/jpeg;base64,"+t[a].plot_snap}else n[a]={};return n};return e.bSignedIn=!0,e.cloudPlotsData=""===t?Array(12).fill({}):n(t),e.getPayInfo().then(function(){return e.getAccountInfo()}).then(function(){return Promise.resolve()})},function(t){return e.bSignedIn=!1,Promise.reject(t)})},findFirstChapter:function(){for(var e=function a(e){if(e.plots.length>0||e.md5)return e.isFirst=!0,e;for(var t=0;t<e.subchapters.length;t++){var n=a(e.subchapters[t]);if(n)return n}return null},t=0;t<this.json_data.chapters.length;t++){var n=e(this.json_data.chapters[t]);if(n)return n}return this.json_data.chapters[0]},notifyGameStarted:function(){return flashvars.app_version&&flashvars.app_version<"1.3.0"?void(this.isGameStarted=!0):(this.isGameStarted=!0,void("ios"===flashvars.client?1==flashvars.offline?gameStart("1"):window.webkit&&window.webkit.messageHandlers.gameStart.postMessage("1"):"android"===flashvars.client?window.app&&window.app.gameStart("1"):this.isWap3000()&&P.xhrLoad("https://www.3000.com/apis/client/v1.0/trace-play.html?id="+flashvars.gid+"&from=wap","",null)))},updateAccInfo:function(e,t){var n=this;if(e)return flashvars.u="",flashvars.token="",this.context.systemValues[0].value=0,void this.getPayInfo();this.context||(this.context={}),flashvars.uid||flashvars.client||(flashvars.uid=h["default"].getUidByCookie()),this.localRecFileToUidRecFile(!1);var a=function o(){n.getPayInfo().then(function(e){"[object String]"!==Object.prototype.toString.apply(e)||t?n.getAccountInfo().then(function(){n.getFansInfo().then(function(){t&&n.sendNotification(diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS)})}):setTimeout(function(){return o()},1)})};a()},localRecFileToUidRecFile:function(e){var t=flashvars.uuid+flashvars.uid,n=h["default"].localStorageGetItem(t),a=h["default"].localStorageGetItem(flashvars.uuid);!n&&a&&(h["default"].localStorageSetItem(t,a),h["default"].localStorageRemoveItem(flashvars.uuid)),e||(this.recordLayer&&this.recordLayer.visible?this.bSwitchAccInPlot=!1:this.bSwitchAccInPlot=!0),""===this.gameUidBelongTo&&""!==flashvars.uid&&(this.gameUidBelongTo=flashvars.uid)},getFansInfo:function(){var e=this;"ios"!==flashvars.client&&"android"!==flashvars.client&&(flashvars.uid=h["default"].getUidByCookie());var t="https://pay.3000.com/?m=payinterface&op=player_one_opus_fans&opus_id="+flashvars.gid+"&uid="+flashvars.uid;return P.xhrLoad(t,"").then(function(t){if(0===t.responseText.length)return Promise.resolve("Get Fans Count failed, no response data");var n=JSON.parse(t.responseText);return e.context.systemValues[9].value=n.data.fans_total,Promise.resolve(e.context.systemValues)},function(e){return Promise.resolve("跨域了("+e+")")})},getAccountInfo:function(){var e=this,t=function(t,n){return P.xhrSend(t,n,null,4e3).then(function(t){if(0===t.responseText.length)return Promise.resolve("Get AccountInfo failed, no response data");var n=JSON.parse(t.responseText);return 0===n.status?(e.context.systemValues[0].value=n.data.payment_available,e.context.systemValues[1].value=n.data.game_coin_available?n.data.game_coin_available:0,e.usedStarCount=n.data.single_game_star_use?n.data.single_game_star_use:0,e.gameStarLimit=n.data.single_game_star?n.data.single_game_star:0,Promise.resolve(e.context.systemValues)):(e.context.systemValues[0].value=0,e.context.systemValues[1].value=0,e.usedStarCount=0,e.gameStarLimit=0,Promise.resolve(n))},function(t){return e.context.systemValues[0].value=0,e.context.systemValues[1].value=0,Promise.resolve("获取用户信息权限错误("+t+")")})},n="https://pay.3000.com/?m=player&op=get_account_info",a="gid="+flashvars.gid;return"ios"!==flashvars.client&&"android"!==flashvars.client||(n="https://app.3000.com/?m=user&op=index&ac=my_account&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,a="u="+encodeURIComponent(h["default"].aesEncrypt(flashvars.u,1))+"&token="+encodeURIComponent(h["default"].aesEncrypt(flashvars.token,1))+"&game_id="+encodeURIComponent(h["default"].aesEncrypt(flashvars.gid,1))),this.context.systemValues||(this.context.systemValues=[{name:"闪币余额",uuid:"",key:"coinTotal",init:{type:"system",value:0}},{name:"星星余额",uuid:"",key:"starTotal",init:{type:"system",value:0}},{name:"时间戳",uuid:"",key:"timestamp",init:{type:"system",value:-1}},{name:"当前年",uuid:"",key:"year",init:{type:"system",value:-1}},{name:"当前月",uuid:"",key:"month",init:{type:"system",value:-1}},{name:"当前日",uuid:"",key:"day",init:{type:"system",value:-1}},{name:"当前小时",uuid:"",key:"hour",init:{type:"system",value:-1}},{name:"当前分钟",uuid:"",key:"minute",init:{type:"system",value:-1}},{name:"当前秒",uuid:"",key:"second",init:{type:"system",value:-1}},{name:"贡献值",uuid:"",key:"contribution",init:{type:"system",value:0}},{name:"星期",uuid:"",key:"weekday",init:{type:"system",value:0}}]),t(n,a)},getPayInfo:function(){var e=this,t=function(t,n){return P.xhrSend(t,n,null,4e3).then(function(t){if(0===t.responseText.length)return Promise.resolve("Get AccountInfo failed, no response data");var n=JSON.parse(t.responseText);if(0===n.status||n.status===-1){if(n.status===-1){var a=h["default"].localStorageGetItem(flashvars.uuid+"payInfo");n.data.content=null===a?"":a}else if(0===n.status&&!n.data.content){var o=h["default"].localStorageGetItem(flashvars.uuid+"payInfo"+flashvars.uid);o||(o=h["default"].localStorageGetItem(flashvars.uuid+"payInfo"),h["default"].localStorageRemoveItem(flashvars.uuid+"payInfo")),n.data.content=null===o?"":o}if(""!==n.data.content&&e.json_data.payValues){e.payValueUid=flashvars.uid;for(var r=JSON.parse(h["default"].decryptBase64(n.data.content)),i=0;i<r.length;i++)for(var s=0;s<e.json_data.payValues.length;s++)if(e.json_data.payValues[s].uuid===r[i].uuid){e.context.payValues[s]=r[i];break}return 0===n.status&&-1!==t.responseText.indexOf('{"content":""}')?e.savePayInfo():Promise.resolve(e.context.payValues)}return e.payValueUid!==flashvars.uid&&e.context.payValues.forEach(function(e){e.value=0}),Promise.resolve("")}return Promise.resolve("获取用户信息失败("+n.msg+":"+n.status+")")},function(e){return Promise.resolve("获取用户信息权限错误("+e+")")})},n=flashvars.u&&flashvars.token?1:0,a=Math.floor((new Date).getTime()/1e3)+h["default"].timeOffset,o=""===flashvars.gid?1:parseInt(flashvars.gid),r="";r=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+o+"&time="+a+"&token="+flashvars.token+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"gid="+o+"&time="+a+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M",
o=h["default"].aesEncrypt(o,n),r=h["default"].aesEncrypt(m["default"].hash(m["default"].hash(r)),n),a=h["default"].aesEncrypt(a,n);var i="https://my.3000.com/?m=pay_value&op=index&ac=info&api_v=1.0.0&api_from=webpc",s="gid="+encodeURIComponent(o)+"&sign="+encodeURIComponent(r)+"&time="+encodeURIComponent(a);return""!==flashvars.u&&""!==flashvars.token&&(i="https://app.3000.com/?m=pay_value&op=index&ac=info&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,s+=this.getPhoneData()),this.context.payValues||(this.context.payValues=[{name:"消费数值1",uuid:"",init:{type:"const",value:0},value:0}]),t(i,s)},savePayInfo:function(){var e=this,t=function(t,n,a){return P.xhrSend(t,n,null,4e3).then(function(t){if(0===t.responseText.length)return e.showToast(1,"用户数据无法保存，请在网络恢复后重新操作"),Promise.reject("Save file failed, no response data");var n=JSON.parse(t.responseText);return 0===n.status?Promise.resolve():n.status===-1?(h["default"].localStorageSetItem(flashvars.uuid+"payInfo"+flashvars.uid,a),e.showToast(2,"温馨提醒：登录后才可以同步用户数据哦～"),Promise.resolve()):2===n.status?(e.showToast(1,"用户数据保存失败，账号已在其他设备登录"),Promise.reject(n.msg+": "+n.status)):(e.showToast(1,"用户数据无法保存，请在网络恢复后重新操作"),Promise.reject(n.msg+": "+n.status))},function(t){return e.showToast(1,"用户数据无法保存，请在网络恢复后重新操作"),Promise.reject(t)})},n=flashvars.u&&flashvars.token?1:0,a=JSON.stringify(this.context.payValues),o=h["default"].encodeBase64(a),r=Math.floor((new Date).getTime()/1e3)+h["default"].timeOffset,i=""===flashvars.gid?1:parseInt(flashvars.gid),s="";s=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&content="+o+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+i+"&progress=1&time="+r+"&token="+flashvars.token+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"content="+o+"&gid="+i+"&progress=1&time="+r+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M";var l="https://my.3000.com/?m=pay_value&op=index&ac=save&api_v=1.0.0&api_from=webpc",u="content="+encodeURIComponent(h["default"].aesEncrypt(o,n))+"&gid="+encodeURIComponent(h["default"].aesEncrypt(i,n))+"&progress="+encodeURIComponent(h["default"].aesEncrypt(1,n))+"&sign="+encodeURIComponent(h["default"].aesEncrypt(m["default"].hash(m["default"].hash(s)),n))+"&time="+encodeURIComponent(h["default"].aesEncrypt(r,n));return""!==flashvars.u&&""!==flashvars.token&&(l="https://app.3000.com/?m=pay_value&op=index&ac=save&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,u+=this.getPhoneData()),t(l,u,o)},getDiscounts:function(e,t,n,a){var o=function(e){return P.xhrLoad(e,"").then(function(e){if(0===e.responseText.length)return Promise.resolve("Get Discounts failed, no response data");var t=JSON.parse(e.responseText);return Promise.resolve(t.result)},function(e){return Promise.resolve("获取商品价格失败！")})},r="uuid="+e+(t?"&chapter_uuid="+t:"&product_id="+n)+"&platform="+a,i="https://mapi.3000api.com/apis/soft/v1.0/game-getCharge.html?"+r;return o(i)},payOperation:function(e,t,n,a){var o=this,r=-1,i=function(){var i={gid:flashvars.gid,eid:t,charge:e,special_price:r,balance:o.context.systemValues[0].value,starsNeed:100*e,stars:o.context.systemValues[1].value,starsUsed:o.usedStarCount,starsLimited:o.gameStarLimit,payValues:h["default"].encodeBase64(JSON.stringify(o.context.payValues)),indentId:n};"ios"===flashvars.client?(o.mallPayCallback=a,1==flashvars.offline?worksmall(JSON.stringify(i)):window.webkit&&window.webkit.messageHandlers.worksmall.postMessage(JSON.stringify(i))):"android"===flashvars.client&&(o.mallPayCallback=a,window.app&&window.app.worksmall(JSON.stringify(i)))};return"android"===flashvars.client||"ios"===flashvars.client?flashvars.app_version<"1.2.0"?(y["default"].info("版本过低不支持改功能，请先更新版本~"),Promise.resolve(r)):this.getAccountInfo().then(function(n){if("string"==typeof n)y["default"].error("网络异常，请检查您的网络！"),a(!1);else if(n.status&&n.status>0&&n.status<9)flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),y["default"].info(n.msg).then(function(){window.location.href="lzj3000://login"}),a(!1);else{if(100!==n.status||n.success)return o.getDiscounts(flashvars.uuid,null,t,"app").then(function(t){return"string"==typeof t?(y["default"].error(t),a(!1)):(e=t.charge,r=t.special_price,i()),Promise.resolve(r)});a(!1)}return Promise.resolve(r)}):(y["default"].info("请前往APP或电脑端购买~"),Promise.resolve(r))},chapterInfoProgress:function(e){var t=this.viewComponent.game.world.getByName("chapterInfoProgress");if(!t){t=this.viewComponent.game.add.group(),t.name="chapterInfoProgress";var n=this.viewComponent.game.add.graphics(0,0,t);n.beginFill(0,.5),n.drawRect(0,0,960,540),n.endFill(),n.name="background",n.inputEnabled=!0;var a={font:"16px 宋体",fill:"#fff",boundsAlignH:"center",boundsAlignV:"middle"},o=this.viewComponent.game.add.text(0,0,"",a,t);o.setTextBounds(0,0,960,540),o.name="chapterInfoProgressText"}var r=t.getByName("chapterInfoProgressText");r&&(r.text="章节信息获取中..."+e)},checkIfChapterFree:function(e,t){var n=this,a=function(e,t){var a=function(e){n.chapterInfoProgress(e.loaded)};return P.xhrSend(e,t,a).then(function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");if(t&&t.destroy(),0===e.responseText.length)return Promise.reject("Get chapterInfo failed, no response data");var a=JSON.parse(e.responseText);return"100"===a.code?Promise.resolve(a.result.plots):1==flashvars.offline?Promise.resolve(a.plots):Promise.reject(a.message+" code="+a.code)},function(e){var t=n.viewComponent.game.world.getByName("chapterInfoProgress");return t&&t.destroy(),Promise.reject(e)})};flashvars.u||flashvars.token||(flashvars.uid=h["default"].getUidByCookie());var o="uuid="+flashvars.uuid+"&uid="+flashvars.uid+"&chapter_uuid="+e+"&md5="+t+"&platform="+(flashvars.client?"app":"pc"),r="https://mapi.3000api.com/apis/soft/v1.0/chapter-chapterInfo.html?"+o;return a(r,o)},unlockChapter:function(e,t,n,a){var o=this;if(flashvars.app_version<"1.2.0")return y["default"].info("该章节为付费章节，当前版本过低，不支持该功能"),void a(!1,!0);var r=-1;this.getDiscounts(flashvars.uuid,e,null,"app").then(function(i){if("string"!=typeof i&&(t=i.charge,r=i.special_price),"ios"===flashvars.client){var s={gid:flashvars.gid,uuid:e,charge:t,md5:n,special_price:r};o.unlockChapterCallBack=a,1==flashvars.offline?unlock(JSON.stringify(s)):window.webkit&&window.webkit.messageHandlers.unlock.postMessage(JSON.stringify(s))}else"android"===flashvars.client&&(window.app&&window.app.unlock(flashvars.gid,e,t,n),o.unlockChapterCallBack=a)})},getPhoneData:function(){var e=encodeURIComponent(h["default"].aesEncrypt(flashvars.u,1)),t=encodeURIComponent(h["default"].aesEncrypt(flashvars.token,1)),n=encodeURIComponent(h["default"].aesEncrypt(""===flashvars.app_name?"shanyi":flashvars.app_name,1)),a=encodeURIComponent(h["default"].aesEncrypt(""===flashvars.device_name?"Google Nexus S":flashvars.device_name,1)),o=encodeURIComponent(h["default"].aesEncrypt(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer,1));return"&u="+e+"&token="+t+"&app_name="+n+"&device_name="+a+"&device_system_version="+o},loadCloudRecord:function(e){var t=function(e,t){return P.xhrSend(e,t).then(function(e){if(0===e.responseText.length)return Promise.reject("Get file failed, no response data");var t=JSON.parse(e.responseText);if(0===t.status){var n=t.data.content||"",a=h["default"].decryptBase64(n);return Promise.resolve(a)}return Promise.reject(t.msg+" - status:"+t.status)},function(e){return Promise.reject(e)})},n=flashvars.u&&flashvars.token?1:0,a=Math.floor((new Date).getTime()/1e3)+h["default"].timeOffset,o=""===flashvars.gid?1:parseInt(flashvars.gid),r="",i=e+"";r=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+o+"&time="+a+"&token="+flashvars.token+"&type="+i+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"gid="+o+"&time="+a+"&type="+i+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M",o=h["default"].aesEncrypt(o,n),r=h["default"].aesEncrypt(m["default"].hash(m["default"].hash(r)),n),a=h["default"].aesEncrypt(a,n),i=h["default"].aesEncrypt(i,n);var s="https://my.3000.com/?m=cloud_save&op=index&ac=info&client_type=1&api_v=1.0.0&api_from=webpc",l="gid="+encodeURIComponent(o)+"&sign="+encodeURIComponent(r)+"&time="+encodeURIComponent(a)+"&type="+encodeURIComponent(i);return""!==flashvars.u&&""!==flashvars.token&&(s="https://app.3000.com/?m=cloud_save&op=index&ac=info&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,l+=this.getPhoneData()),t(s,l)},saveCloudRecord:function(e){var t=function(e,t){return P.xhrSend(e,t).then(function(e){if(0===e.responseText.length)return Promise.reject("Save file failed, no response data");var t=JSON.parse(e.responseText);return 0===t.status?Promise.resolve():Promise.reject(t.msg+": "+t.status)},function(e){return Promise.reject(e)})},n=flashvars.u&&flashvars.token?1:0,a=JSON.stringify(this.savedPlotsData[e]),o=h["default"].encodeBase64(a),r=Math.floor((new Date).getTime()/1e3)+h["default"].timeOffset,i=""===flashvars.gid?1:parseInt(flashvars.gid),s="";s=n?"app_name="+(""===flashvars.app_name?"shanyi":flashvars.app_name)+"&content="+o+"&device_name="+(""===flashvars.device_name?"Google Nexus S":flashvars.device_name)+"&device_system_version="+(""===flashvars.deviceOsVer?"4.1.1":flashvars.deviceOsVer)+"&gid="+i+"&progress=1&time="+r+"&token="+flashvars.token+"&type="+e+"&u="+flashvars.u+"&v_key=shanyi_WDF#$H*#SJN*&G$&**":"content="+o+"&gid="+i+"&progress=1&time="+r+"&type="+e+"&v_key=0GjRAtUUoK4BwJGUz73jBa2M";var l="https://my.3000.com/?m=cloud_save&op=index&ac=save&client_type=1&api_v=1.0.0&api_from=webpc",u="content="+encodeURIComponent(h["default"].aesEncrypt(o,n))+"&gid="+encodeURIComponent(h["default"].aesEncrypt(i,n))+"&progress="+encodeURIComponent(h["default"].aesEncrypt(1,n))+"&sign="+encodeURIComponent(h["default"].aesEncrypt(m["default"].hash(m["default"].hash(s)),n))+"&time="+encodeURIComponent(h["default"].aesEncrypt(r,n))+"&type="+encodeURIComponent(h["default"].aesEncrypt(e+"",n));return""!==flashvars.u&&""!==flashvars.token&&(l="https://app.3000.com/?m=cloud_save&op=index&ac=save&client="+flashvars.client+"&v="+flashvars.v+"&app_version="+flashvars.app_version,u+=this.getPhoneData()),t(l,u)},getViewData:function(e,t){for(var n={},a=function r(e,t){for(var a=0;a<e.length;a++)if(e[a].xInfo&&e[a].yInfo){var o={name:e[a].name,instanceUuid:e[a].instanceUuid,xInfo:e[a].xInfo,yInfo:e[a].yInfo,eventsInfo:e[a].eventsInfo,scale:e[a].scale,visible:e[a].visible};o.children=[],"TIMER"===e[a].viewType&&(n.currentCount=e[a].currentCount),r(e[a].children,o),t.children.push(o)}},o=0;e&&o<e.length;o++)e[o].parent&&(n={name:e[o].name,instanceUuid:e[o].instanceUuid,xInfo:e[o].xInfo,yInfo:e[o].yInfo,eventsInfo:e[o].eventsInfo,scale:e[o].scale,parent:e[o].parent.name,x:e[o].x,y:e[o].y,visible:e[o].visible},n.children=[],"TIMER"===e[o].viewType&&(n.currentCount=e[o].currentCount),e[o].generateType&&(n.generateType=e[o].generateType),a(e[o].children,n),t.push(n))},getViewParentEvents:function(e){var t=this.json_data.viewMap;for(var n in t){if(n===e)return t[n].events.concat();for(var a in t.children)if(t.children[a].ref===e)return t.children[a].events.concat()}},copyFlashViewData:function(e,t){var n=!0;if(t&&t.historyCommand&&t.historyCommand.hideGlobalViews)for(var a=0;a<t.historyCommand.hideGlobalViews.length;a++)if(e.instanceUuid===t.historyCommand.hideGlobalViews[a]){n=!1;break}var o={name:e.ref,instanceUuid:e.instanceUuid,xInfo:"[object Object]"===Object.prototype.toString.apply(e.x)?e.x:{type:"literal",value:e.x},yInfo:"[object Object]"===Object.prototype.toString.apply(e.y)?e.y:{type:"literal",value:e.y},scale:{x:e.scale,y:e.scale,type:25},visible:n};e.currentCount&&(o.currentCount=e.currentCount),o.children=[];for(var r=0;r<e.children.length;r++)o.children[r]=this.copyFlashViewData(e.children[r],t),o.children[r].eventsInfo=this.getViewParentEvents(e.ref);return o},getWeatherType:function(){if(!this.weatherLayer.visible)return"";var e=this.weatherLayer.getByName("wind");return e&&e.visible?"wind":(e=this.weatherLayer.getByName("snow"),e&&e.visible?"snow":(e=this.weatherLayer.getByName("rain"),e&&e.visible?"rain":""))},saveRecord:function(e,t){if(0===e&&this.json_data.default_settings.autoSaveOrLoad&&!t)return Promise.resolve(null);!this.savedPlotsData&&this.loadData();var n=Date.now(),a=[],o=[],r=[];this.getViewData(this.globalViews,a),this.getViewData(this.plotViews,o);var i={};if(i.plotUuid=this.curChapter.plots[this.curPlotIndex].uuid,i.chapterUuid=this.curChapter.uuid,i.bkKey=this.lstPlotBkKey,i.bkOpacity=this.lstPlotBkOpacity,i.bkFlex=this.lstPlotBkFlex,i.cmdUuid=this.curCmdUuid,i.bCmdAutoText=this.bCmdAutoText,i.timestamp=n,i.context=JSON.parse(JSON.stringify(this.context)),i.plotSnap=this.plotSnap,i.weatherType=this.getWeatherType(),i.globalViews=a.concat(),i.plotViews=o.concat(),i.playbackData=this.playbackData.concat(),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?(i.music={url:b["default"].musicInfo.key,volume:b["default"].musicInfo.volume},i.sounds=b["default"].soundsInfo.map(function(e){return e.key?{url:e.key,volume:e.value,time:e.loop?0:1}:null})):(i.music={url:this.bk_music&&this.bk_music.key,volume:this.bk_music&&this.bk_music.volume},i.sounds=this.plotSounds.map(function(e){return e?{url:e.key,volume:e.volume,time:e.loop?0:1}:null})),""!==this.curCmdUuid){this.charsAndPropsLayer&&this.charsAndPropsLayer.children.forEach(function(e){var t=e.children[0],n={url:t.key,x:t.x,y:t.y,width:t.width,height:t.height,opacity:t.alpha,pivotX:t.pivot.x,pivotY:t.pivot.y,scaleX:t.scale.x,scaleY:t.scale.y,rotate:t.angle,cmdUuid:t.cmdUuid,index:e.zIndex,parentScale:e.scale.x};t.finalState&&(n.x=t.finalState.x,n.y=t.finalState.y,n.opacity=t.finalState.alpha,n.rotate=t.finalState.angle),e.finalState&&(n.parentScale=e.finalState.scale.x),r.push(n)});var s=this.curPlotLayer.children[1];i.bk={},s&&(i.bk={url:s.key,opacity:s.alpha},s.finalState&&(i.bk.opacity=s.finalState.alpha))}return i.charsAndProps=r.concat(),i.dialogInfo=this.lstDialogInfo.concat(),i.menuInfo=this.menuInfo.concat(),this.savedPlotsData[e]=JSON.parse(JSON.stringify(i)),this.bSignedIn&&this.bCloudSel&&(this.cloudPlotsData[e]=JSON.parse(JSON.stringify(i))),this.saveData(e,t).then(function(e){return Promise.resolve(i)},function(e){return Promise.resolve(null)})},loadRecord:function(e){var t=this;!this.savedPlotsData&&this.loadData();var n=this.savedPlotsData[e],a=n.plotUuid,o=n.chapterUuid,r=n.context,i=n.playbackData,s=function(n,a){t.destroyAll(),t.lstPlotBkKey=t.savedPlotsData[e].bkKey,t.lstPlotBkOpacity=t.savedPlotsData[e].bkOpacity,t.lstPlotBkFlex=t.savedPlotsData[e].bkFlex,t.globalViews=t.savedPlotsData[e].globalViews.concat(),t.plotViews=t.savedPlotsData[e].plotViews.concat(),t.charsAndPropsInfo=t.savedPlotsData[e].charsAndProps.concat(),t.lstDialogInfo=t.savedPlotsData[e].dialogInfo?t.savedPlotsData[e].dialogInfo.concat():[],t.menuInfo=t.savedPlotsData[e].menuInfo?t.savedPlotsData[e].menuInfo.concat():[],t.curCmdUuid=t.savedPlotsData[e].cmdUuid,t.bCmdAutoText=t.savedPlotsData[e].bCmdAutoText,t.visibleLayout[0]&&(t.visibleLayout[0].visible=!0),t.visibleLayout=t.visibleLayout.slice(1),t.recordLayer.visible=!1,t.mainMenuLayer.visible=!1,t.endLayer.visible=!1,t.onResume(),t.removePlotTweens(),i.forEach(function(e){return t.addPlayBackContent(e)});var o={};t.curCmdUuid&&(o=t.getCommandByCommandUuid(c.plots[a],t.curCmdUuid),o.cmdScreenSnap={charsAndProps:t.charsAndPropsInfo,sounds:t.savedPlotsData[e].sounds,music:t.savedPlotsData[e].music,plotViews:t.plotViews,dialogInfo:t.lstDialogInfo,menuInfo:t.menuInfo,bk:t.savedPlotsData[e].bk,weatherType:t.savedPlotsData[e].weatherType}),t.initContext(r,!0),r.commandInserts&&(t.context.commandInserts=r.commandInserts.concat());var s={music:t.savedPlotsData[e].music,sounds:t.savedPlotsData[e].sounds,charsAndProps:t.charsAndPropsInfo,background:t.lstPlotBkKey,images:[t.lstDialogInfo&&t.lstDialogInfo[0]?{url:t.lstDialogInfo[0].avatar.url}:{}]};t.preloadChapterAssets(t.context,n,a,o,s),t.coverLayer.visible=!1,!t.isGameStarted&&t.notifyGameStarted()},l=function(e,n){if(n<0){var r=t.getChapterByPlotUuid(t.json_data,a,o),i=r.chapter,l=r.index;s(i,l)}else s(e,n)};if(!a)return!1;var u=this.getChapterByPlotUuid(this.json_data,a,o),c=u.chapter,d=u.index;if(c.md5&&0===c.plots.length){var h=c.downloadUuid?c.downloadUuid:c.uuid;if(!c.charge||"android"!==flashvars.client&&"ios"!==flashvars.client)this.checkIfChapterFree(h,c.md5).then(function(e){c.plots=e,l(c,d)},function(e){-1===e.indexOf("code=87")?y["default"].error(e):y["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var f=function(e){e&&t.checkIfChapterFree(h,c.md5).then(function(e){t.unlockChapterCallBack=null,c.plots=e,l(c,d)},function(){return y["default"].error("获取付费章节信息失败")})};this.unlockChapter(h,c.charge,c.md5,f)}}else s(c,d);return!0},onRecordItemClicked:function(e,t){var n=this,a=4*t+e;if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var o=h["default"].getUidByCookie();flashvars.uid=o}return this.bToSaveFile?this.gameUidBelongTo!==this.recUidBelongTo&&""!==this.gameUidBelongTo||this.recUidBelongTo!==flashvars.uid?y["default"].info("存档失败，请登录正确的账号后重新尝试"):this.saveRecord(a).then(function(e){if(!e)return!1;var t=n.recordLayer.getByName("scrollPane").children.find(function(e){return e.name==="recordItem_"+a}),o=t.getByName("content"),r=t.getByName("textTime"),i=function(e){var t=o.width,n=o.height;o.loadTexture(e),o.width=t,o.height=n},s=m["default"].hash(e.plotSnap);n.viewComponent.game.load.cache.checkImageKey(s)?i(s):n.addImageUrl(e.plotSnap,s).then(function(){return i(s)});var l=h["default"].getCurrentDateTime(e.timestamp);if(C["default"].fontFamily){var u=n.json_data.font.size?n.toRealImageFontHeight(r.fontSize):r.fontSize,c=n.json_data.font.size?n.toRealImageFontWidth(r.fontSize):r.fontSize;n.addImageFontText([{data:l}],c,u,r,n.context),r.text=" "}else r.text=l}):this.recUidBelongTo===flashvars.uid?(this.gameUidBelongTo=this.recUidBelongTo,this.savedPlotsData&&this.savedPlotsData[a].plotUuid&&!this.savedPlotsData[a].context?this.loadCloudRecord(a).then(function(e){var t=function(e){var t=JSON.parse(e);if(t.context)n.savedPlotsData[a]=t;else{n.savedPlotsData[a].plotUuid=t.plotUuid,n.savedPlotsData[a].chapterUuid=t.chapterUuid?t.chapterUuid:void 0,n.savedPlotsData[a].bkKey=t.backgroundObject?t.backgroundObject.url:null,n.savedPlotsData[a].context={},n.savedPlotsData[a].context.auto=!1,n.savedPlotsData[a].context.fullScreen=!1,n.savedPlotsData[a].context.values=[],n.savedPlotsData[a].context.savedValues=[],n.savedPlotsData[a].context.stringValues=[],n.savedPlotsData[a].context.indexValues=[];for(var o=0;o<t.values.length;o++)if(t.values[o].saved){for(var r=n.savedPlotsData[a].context.savedValues.length,i=0;i<n.json_data.savedValues.length;i++)if(n.json_data.savedValues[i].uuid===t.values[o].key){r=i;break}n.savedPlotsData[a].context.savedValues[r]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].index){for(var s=n.savedPlotsData[a].context.indexValues.length,l=0;l<n.json_data.indexValues.length;l++)if(n.json_data.indexValues[l].uuid===t.values[o].key){s=l;break}n.savedPlotsData[a].context.indexValues[s]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].init&&"string"===t.values[o].init.type){for(var u=n.savedPlotsData[a].context.stringValues.length,c=0;c<n.json_data.stringValues.length;c++)if(n.json_data.stringValues[c].uuid===t.values[o].key){u=c;break}n.savedPlotsData[a].context.stringValues[u]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}else if(t.values[o].key&&"_"!==t.values[o].key[2]&&!t.values[o].pay){for(var d=n.savedPlotsData[a].context.values.length,h=0;h<n.json_data.values.length;h++)if(n.json_data.values[h].uuid===t.values[o].key){d=h;break}n.savedPlotsData[a].context.values[d]={uuid:t.values[o].key,name:t.values[o].name,init:t.values[o].init,value:t.values[o].value}}n.savedPlotsData[a].context.stack=(t.stack||[]).concat(),n.savedPlotsData[a].context.cmdStack=(t.cmdStack||[]).concat(),n.savedPlotsData[a].globalViews=[],n.savedPlotsData[a].plotViews=[];for(var f=0;f<t.globalViewsData.length;f++)n.savedPlotsData[a].globalViews[f]=n.copyFlashViewData(t.globalViewsData[f],t.commandObj),n.savedPlotsData[a].globalViews[f].x=n.Expression.safeEval(t.globalViewsData[f].x,n.savedPlotsData[a].context)*(1-t.globalViewsData[f].scale),n.savedPlotsData[a].globalViews[f].y=n.Expression.safeEval(t.globalViewsData[f].y,n.savedPlotsData[a].context)*(1-t.globalViewsData[f].scale),n.savedPlotsData[a].globalViews[f].parent="__world";for(var m=0;m<t.viewsData.length;m++)n.savedPlotsData[a].plotViews[m]=n.copyFlashViewData(t.viewsData[m],t.commandObj),n.savedPlotsData[a].plotViews[m].x=n.Expression.safeEval(t.viewsData[m].x,n.savedPlotsData[a].context)*(1-t.viewsData[m].scale),n.savedPlotsData[a].plotViews[m].y=n.Expression.safeEval(t.viewsData[m].y,n.savedPlotsData[a].context)*(1-t.viewsData[m].scale),n.savedPlotsData[a].plotViews[m].parent="plotViewsLayer";if(n.savedPlotsData[a].music=t.musics[0]?{url:t.musics[0].url,volume:t.musics[0].volume}:{},n.savedPlotsData[a].sounds=t.sounds.concat(),n.savedPlotsData[a].playbackData=t.speakings.concat(),n.savedPlotsData[a].bk={},n.savedPlotsData[a].charsAndProps=[],n.savedPlotsData[a].dialogInfo=[],n.savedPlotsData[a].cmdUuid="",n.savedPlotsData[a].weatherType="",n.savedPlotsData[a].bCmdAutoText=!1,t.commandObj&&t.commandObj.historyCommand){var p=t.commandObj.historyCommand,y=p.images,g=p.dialog,v=p.autoText,x=p.weather;if(n.savedPlotsData[a].cmdUuid=t.commandObj.commandUuid,n.savedPlotsData[a].bCmdAutoText=!!v&&v.args[0],n.savedPlotsData[a].dialogInfo=g&&g.command?g.command.args:[],n.savedPlotsData[a].weatherType=x&&x.args[0],y)for(var P=0;P<y.length;P++)if(y[P].index>1){var w={url:y[P].url,x:y[P].x,y:y[P].y,width:y[P].width,height:y[P].height,opacity:y[P].opacity,rotate:y[P].rotate,index:y[P].index};n.savedPlotsData[a].charsAndProps.push(w)}else 1===y[P].index&&(n.savedPlotsData[a].bk={url:y[P].url,opacity:y[P].opacity})}t.commandInserts&&t.commandInserts.length&&(n.savedPlotsData[a].context.commandInserts=t.commandInserts.concat()),n.cloudPlotsData[a]=JSON.parse(JSON.stringify(n.savedPlotsData[a]))}};t(e),n.loadRecord(a),n.showMenu()},function(){y["default"].error("获取存档数据失败")}):(this.loadRecord(a),this.showMenu())):y["default"].info("读档失败，请登录正确的账号后重新尝试"),!0},onPlaybackBackBtnClicked:function(){this.visibleLayout[0]&&(this.visibleLayout[0].visible=!0),this.visibleLayout[0]!==this.mainMenuLayer&&this.onResume(),this.playBackLayer.removeAll(!0),this.visibleLayout=this.visibleLayout.slice(1),this.playBackLayer.visible=!1},addPlayBackContent:function(e){this.sendNotification(diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT,e)},showLoadingToast:function(e){1===e?(this.loadingToastLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.loadingToastLayer)):0===e&&(this.loadingToastLayer.visible=!1)},showToast:function(e,t){var n=this.toastLayer.getByName("typeSuccess"),a=this.toastLayer.getByName("typeError");n&&(0===e?(n.visible=!0,n.children[2].text=t,n.children[0].width=n.children[2].width+36,n.x=(960-n.children[0].width)/2,n.y=252):n.visible=!1),a&&(1===e?(a.visible=!0,a.children[2].text=t,a.children[0].width=a.children[2].width+36,a.children[1].visible=!0,a.children[2].x=30,a.x=(960-a.children[0].width)/2,a.y=252):2===e?(a.visible=!0,a.children[2].text=t,a.children[0].width=a.children[2].width+20,a.children[1].visible=!1,a.children[2].x=10,a.x=(960-a.children[0].width)/2,a.y=252):a.visible=!1),this.toastLayer.alpha=0,this.viewComponent.game.world.bringToTop(this.toastLayer),this.viewComponent.game.add.tween(this.toastLayer).from({alpha:1},2500,null,!0).name="toast"},addRetroText:function(e,t,n,a,o){var r=this.viewComponent.game.add.retroFont(C["default"].fontFamily,C["default"].charWidth,C["default"].charHeight,C["default"].fontChars,C["default"].countPerRow),i=this.viewComponent.game.add.image(e?e:0,t?t:0,r);return i.fontImg=r,document.body.clientWidth<document.body.clientHeight&&(r.stamp.angle=-90),o&&(r.setText(o,!0,0,0,"center",!0),n&&(i.width=n),a&&(i.height=a)),i},addImageFontTextColors:function(e,t,n){t.colors.splice(0,t.colors.length);var a=0,o=this.json_data.default_settings.color;t.fill=o;for(var r=0;r<e.length;r++){var i="";if(!e[r].lineBreak){if(i=e[r].placeholder&&"\\"===e[r].data[0]?this.Expression.parseWaitTime(e[r].data):this.Expression.parseValue(e[r].data,n),o=e[r].color?e[r].color:this.json_data.default_settings.color,"#"===o[0]&&4===o.length){var s="#"+o[1]+o[1]+o[2]+o[2]+o[3]+o[3];o=s}t.addColor(o,a),a+=i.length}}},addImageFontText:function(e,t,n,a,o,r,i){var s=this,l=this.Expression;if(a.children.length){for(var u=a.children[0],c=a.children[1],d=0;d<u.children.length;d++){var h=u.getChildAt(d),f=h.fontImg;f.destroy(),h.destroy()}u.destroy(),c&&c.destroy(),a.removeChildren()}var m=0,p=0,y="#fffffe",g=0,v=0,x=parseFloat(n),P=parseFloat(t),w=this.json_data.font.size?this.json_data.font.size.target.height?this.json_data.font.size.target.height:this.json_data.font.size.target:this.json_data.default_settings.font_size,b=this.json_data.font.size?x*this.json_data.font.size.source/w:x,k=this.json_data.font.size?1.5*b-x:.5*b,_=[],S={content:"",color:"#fffffe",x:0,y:0,space:0},I=0,E=[];p+=.5*k;for(var L=0;L<e.length;L++){var T="";if(e[L].lineBreak){if(L===e.length-1)break;p+=x+k,m=0}else{T=e[L].placeholder&&"\\"===e[L].data[0]?l.parseWaitTime(e[L].data):l.parseValue(e[L].data,o);for(var M=0;M<T.length;M++){a.colors[I]&&(y=a.colors[I],"#ffffff"===y&&(y="#fefefe"));var A=C["default"].getLeftMargin(T[M],P),O=C["default"].getCharSpace(T[M],P),V=m+A;V+O>a.style.wordWrapWidth&&(g<V+O&&(g=V+O),m=0,V=m+A,p+=x+k,v=A),0===S.space&&(S.space=O,S.color=y,S.x=V,S.y=p,0===v&&(v=A)),32===T[M].charCodeAt(0)||160===T[M].charCodeAt(0)||" "===T[M]||"　"===T[M]||8195===T[M].charCodeAt(0)?(S.content&&_.push(S),_.push({content:T[M],color:y,x:V,y:p,space:O}),S={content:"",color:"#fffffe",x:0,y:0,space:0}):S.space!==O||S.color!==y||S.y!==p||P!==O?(S.content&&_.push(S),S={content:T[M],color:y,x:V,y:p,space:O}):S.content+=T[M],E.push({x:V,y:p,space:O,bottomInText:p+x}),I++,m+=O}}}if(e.length){S.content&&(_[_.length-1]!==S&&_.push(S),g<m&&(g=m));var N=this.viewComponent.game.add.sprite(0,0);if(_.forEach(function(e){if(32!==e.content.charCodeAt(0)&&160!==e.content.charCodeAt(0)&&" "!==e.content&&"　"!==e.content&&8195!==e.content.charCodeAt(0)){var t=s.addRetroText(e.x,e.y,P*e.content.length,x,e.content);t.tint=parseInt(e.color.replace("#","0x")),N.addChild(t)}}),N.extWidth=g,N.extMargin=v,a.addChild(N),a.posInfo=E,_.length&&(a.imgFBottom=_[_.length-1].y+x),r){var B=this.viewComponent.game.add.graphics(0,0),R=a.style.wordWrapWidth,j=i?540:this.json_data.template.json.dialog.rect.height;B.beginFill(16777215),B.drawRect(-R,-j,2*R,j),B.drawRect(-R,0,R,x),B.endFill(),N.mask=B,a.addChild(B)}}},saveData:function(e,t){var n=this;return new Promise(function(a,o){flashvars.uuid&&!n.bCloudSel?(h["default"].localStorageSetItem(flashvars.uuid+flashvars.uid,JSON.stringify(n.savedPlotsData)),!t&&n.showToast(0,"存档成功，下次可以从这里读档继续哦~"),a()):flashvars.gid&&n.bCloudSel&&(n.showLoadingToast(1),n.saveCloudRecord(e).then(function(e){n.showLoadingToast(0),!t&&n.showToast(0,"存档成功，下次可以从这里读档继续哦~"),a()},function(e){n.showLoadingToast(0),!t&&n.showToast(1,"存档失败，请检查您的网络哦~"),o()}))})},loadData:function(e){if(""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var t=h["default"].getUidByCookie();""!==t&&flashvars.uid!==t?(flashvars.uid=t,this.localRecFileToUidRecFile(e)):flashvars.uid=t}if(this.bCloudSel?""===this.recUidBelongTo&&(this.recUidBelongTo=flashvars.uid):this.recUidBelongTo=flashvars.uid,flashvars.uuid)if(this.bSignedIn&&this.bCloudSel)this.savedPlotsData=JSON.parse(JSON.stringify(this.cloudPlotsData));else{var n=h["default"].localStorageGetItem(flashvars.uuid+flashvars.uid);n&&"ios"===flashvars.client&&(n=n.replace(/\n/g,""),n=n.replace(/\r/g,"")),this.savedPlotsData=JSON.parse(n)}this.savedPlotsData||(this.savedPlotsData=Array(12).fill({}))},getSnap:function(){var e=document.createElement("canvas");e.width=this.viewComponent.game.world.width/3,e.height=this.viewComponent.game.world.height/3;var t=e.getContext("2d");document.body.clientWidth>document.body.clientHeight?(t.drawImage(this.viewComponent.game.canvas,0,0,960,540,0,0,e.width,e.height),this.plotSnap=e.toDataURL("image/jpeg",.3)):(t.save(),t.translate(0,e.height),t.rotate(-90*Math.PI/180),t.drawImage(this.viewComponent.game.canvas,0,0),t.restore(),this.plotSnap=e.toDataURL("image/jpeg",.3))},searchChapterByUUID:function(e,t){for(var n=function r(e,t,n){if(e.uuid===n)return e;for(var a=0;a<e.subchapters.length;++a){var o=r(e.subchapters[a],[a,["subchapters",t]],n);if(o)return o}},a=null,o=0;o<e.chapters.length;++o)if(a=n(e.chapters[o],[o,["chapters",null]],t))return a},getChapterByPlotUuid:function(e,t,n){var a=function(e,t,n,a){var r=null;return a&&t.uuid!==a?r:(a&&t.uuid===a&&0===t.plots.length&&(r={chapter:t,index:-4}),e.find(function(e,a){return e.uuid===n?r={chapter:t,index:a}:t.plots[a].options&&(r=o(t,a,n)),null!==r}),r)},o=function(e,t,n){var o=null,r=e.plots[t];return r.options.find(function(r,i){return o=a(r.plots,{plots:r.plots,parent:{pChapter:e,pnPlot:t},uuid:e.uuid},n),null!==o}),o?o:(r.condition_options&&r.condition_options.find(function(r,i){return o=a(r.plots,{plots:r.plots,parent:{pChapter:e,pnPlot:t},uuid:e.uuid},n),null!==o}),o)},r=function s(e,t,n){var o=null;return(o=a(e.plots,e,t,n))?o:(e.subchapters.find(function(a,r){return o=s(e.subchapters[r],t,n),null!==o}),o)},i=null;return e.chapters.find(function(a,o){return i=r(e.chapters[o],t,n),null!==i}),i||y["default"].error("该剧情已被作者删除啦！\r\n无法从该剧情继续哦~"),i},getCommandByCommandUuid:function(e,t){var n=function(e,t,n){for(var o=0;o<e.length;o++){var r=null;if(r=a({commands:e[o].commands,parentInfo:t,parentCmdIndex:n}),null!==r.cmdInfo)return r}return null},a=function(e){var a=null;return e.commands.find(function(o,r){return o.uuid===t?a={cmdIndex:r,uuid:t,cmdInfo:{commands:e.commands,parentInfo:e.parentInfo,parentCmdIndex:e.parentCmdIndex}}:"options"!==o.type&&"conditionOptions"!==o.type||(a=n(o.args,e,r)),null!==a}),null===a?{cmdIndex:-1,cmdInfo:null}:a},o={commands:e.commands,parentInfo:null,parentCmdIndex:-1};return a(o)},getMusic:function(e,t){for(var n=null,a=t;a>=0;a--){var o=e.plots[a];o.music&&"inherit"!==o.music.url&&(n=o.music.url)}return!n&&e.parent?this.getMusic(e.parent.pChapter,e.parent.pnPlot):!n&&e.isFirst&&this.json_data.cover.music&&"inherit"!==this.json_data.cover.music.url?this.json_data.cover.music.url:n},getCmdScreenSnap:function(){var e=this.bk_music,t=this.plotSounds,n=this.curPlotLayer,a=n.children[1],o=[],r=[],i=this.lstDialogInfo.concat(),s=this.menuInfo.concat(),l=e?{url:e.key,volume:e.volume}:null,u=t.map(function(e){return e?{url:e.key,volume:e.volume,time:e.loop?0:1}:null}),c=a?{url:a.key,opacity:a.alpha,width:a.width,height:a.height}:null;return this.charsAndPropsLayer&&this.charsAndPropsLayer.children.forEach(function(e){var t=e.children[0],n={url:t.key,x:t.x,y:t.y,width:t.width,height:t.height,opacity:t.alpha,pivotX:t.pivot.x,pivotY:t.pivot.y,scaleX:t.scale.x,scaleY:t.scale.y,rotate:t.angle,cmdUuid:t.cmdUuid,index:e.zIndex,parentScale:e.scale.x};o.push(n)}),this.getViewData(this.plotViews,r),{bk:c,charsAndProps:o,sounds:u,music:l,plotViews:r,dialogInfo:i,menuInfo:s,autoText:this.bCmdAutoText,weatherType:this.getWeatherType()}},getNextPlot:function(e,t,n,a,o){var r=this.json_data,i=this.Expression,l=this.searchChapterByUUID,u=r,c={cmdIndex:0,cmdInfo:null,cmdScreenSnap:null},d=n,h=t,f=void 0,m=void 0,p=t.plots[n];if(d++,"option"===a){
if(p.options[o]){var y={};y.loopCondition=null,y.loopCount=1,e.stack=[y].concat(s(e.stack)),h={plots:p.options[o].plots,parent:{pChapter:h,pnPlot:n},uuid:t.uuid},d=0}}else if(p&&!p.insert&&!p.jump&&!p.back&&!a){var g=(p.condition_options||[]).findIndex(function(t){return i.safeEval(t.expression,e)&&(!t.count||parseInt(i.safeEval(t.count,e))>0)}),v=g<0?null:p.condition_options[g];if(v){var x={};x.loopCondition="loop"===v.type||"countLoop"===v.type?v.expression:null,x.loopCount=1,x.loopCountExpr=v.count,e.stack=[x].concat(s(e.stack)),d=0,h={plots:v.plots,parent:{pChapter:t,pnPlot:n},uuid:t.uuid}}}if(p&&(p.jump&&!a||p.jump&&"nextPlot"===a||"jump"===a)){var P="jump"===a?o:p.jump,w=l(u,P);w&&(h=w,d=0,e.stack=[],e.cmdStack=[])}if(p&&(p.back||"back"===a)&&(d=-2,e.stack=[]),p&&"jumpOption"===a){e=JSON.parse(JSON.stringify(this.context));for(var b=0;b<o&&h.parent&&(e.stack[0]&&"insert"!==e.stack[0].type);b++)e.stack=e.stack.splice(1),d=h.parent.pnPlot,h=h.parent.pChapter;-1!==d&&(this.context=e,d++)}if(p&&"backOption"===a){e=JSON.parse(JSON.stringify(this.context));for(var k=0;k<o&&h.parent&&(e.stack[0]&&"insert"!==e.stack[0].type);k++)e.stack=e.stack.splice(1),d=h.parent.pnPlot,h=h.parent.pChapter;if(-1<d)return this.context=e,{chapter:h,nIndex:d,context:e}}if(p&&(p.insert&&!a||"insertPlot"===a&&o)){var C=o||p.insert,_=l(u,C);if(_){var S={};S.type="insert",S.isCommand=!!t.plots[n].commands,S.cmdInfo=S.isCommand?this.curCmdInfo:null,S.cmdIndex=S.isCommand?this.curCmdIndex:null,S.cmdScreenSnap=S.isCommand?this.getCmdScreenSnap():null,S.isCommand&&(e.cmdStack=[{type:"insert"}].concat(s(e.cmdStack))),S.loopCondition=null,S.loopCount=1,S.pPlotUuid=h.plots[d-1].uuid,S.chapterUuid=h.uuid,e.stack=[S].concat(s(e.stack)),h={plots:_.plots,md5:_.md5,uuid:_.uuid,downloadUuid:_.downloadUuid,charge:_.charge,parent:{pChapter:h,pnPlot:d-1}},d=0,this.mainMenuLayer.visible&&(this.mainMenuLayer.children[1]&&this.mainMenuLayer.children[1].isMenu&&this.sendNotification(diygamePlayer.AppConstants.SCENE_DESTROY_VIEW,this.mainMenuLayer.children[1].name),this.onMainMenuBackBtnClicked())}}for(;!h.plots[d]&&(0!==d&&h.plots.length||0===d&&!h.plots.length&&!h.md5)&&e.stack&&0<e.stack.length;){var I=e.stack[0];if(I.loopCondition&&i.safeEval(I.loopCondition,e)){if(d=0,I.loopCount&&I.loopCount++,!I.loopCountExpr)break;var E=parseInt(i.safeEval(I.loopCountExpr,e));if(I.loopCount<=E)break}if(e.stack=e.stack.splice(1),"insert"===I.type&&e.cmdStack.length&&e.cmdStack[0].type&&"insert"===e.cmdStack[0].type&&(m=e.cmdStack[0],e.cmdStack=e.cmdStack.splice(1),e.commandInserts))for(var L=0;L<e.commandInserts.length;L++)if(I.pPlotUuid===e.commandInserts[L].uuid){var T=this.getChapterByPlotUuid(this.json_data,I.pPlotUuid,I.chapterUuid);if(null===T||T.chapter&&T.index===-4)break;var M=this.getCommandByCommandUuid(T.chapter.plots[T.index],e.commandInserts[L].data.commandUuid);if(I.cmdInfo=M.cmdInfo,I.cmdIndex=M.cmdIndex,e.commandInserts[L].data.historyCommand){var A={charsAndProps:[],sounds:Array(12),music:null,plotViews:[],menuInfo:[]},O=e.commandInserts[L].data.historyCommand,V=O.images,N=O.dialog,B=O.autoText,R=O.weather,j=O.viewsData;if(A.autoText=!!B&&B.args[0],A.dialogInfo=N&&N.command?N.command.args:[],A.weatherType=R?R.args[0]:"",V)for(var D=0;D<V.length;D++)if(V[D].index>1){var U={url:V[D].url,x:V[D].x,y:V[D].y,width:V[D].width,height:V[D].height,opacity:V[D].opacity,rotate:V[D].rotate,index:V[D].index};A.charsAndProps.push(U)}else 1===V[D].index&&(A.bk={url:V[D].url,opacity:V[D].opacity});if(j&&j.length)for(var F=0;F<j.length;F++)A.plotViews[F]=this.copyFlashViewData(j[F]),A.plotViews[F].x=0,A.plotViews[F].y=0,A.plotViews[F].parent="plotViewsLayer";I.cmdScreenSnap=A}break}if(h.parent&&"insert"!==I.type)c.cmdIndex=I.isCommand?I.cmdIndex+1:-1,c.cmdInfo=I.cmdInfo,c.cmdScreenSnap=I.cmdScreenSnap,d=I.isCommand?h.parent.pnPlot:h.parent.pnPlot+1,h=h.parent.pChapter;else if(I.pPlotUuid&&"insert"===I.type){c.cmdIndex=I.isCommand?I.cmdIndex+1:-1,c.cmdInfo=I.cmdInfo,c.cmdScreenSnap=I.cmdScreenSnap;var G=this.getChapterByPlotUuid(this.json_data,I.pPlotUuid,I.chapterUuid),z=G.chapter,W=G.index;d=I.isCommand?W:W+1,h=z,f=I}}return{chapter:h,nIndex:d,cmdPlotSnap:c,context:e,preStackFrame:f,preCmdStackFrame:m}},getNextCommand:function(e,t,n,a){var o=this.Expression,r=t,i=n;if(i++,"options"===a.type){var l=t.commands[n].args;if(a.index>=0&&l[a.index].commands.length>0){var u={};u.loopCondition=null,u.loopCount=1,e.cmdStack=[u].concat(s(e.cmdStack)),i=0,r={commands:l[a.index].commands,parentInfo:t,parentCmdIndex:n}}else this.optionLayer.destroy()}else if("cdtOptions"===a.type){var c=t.commands[n].args,d=c.findIndex(function(t){return o.safeEval(t.expression,e)&&(!t.count||parseInt(o.safeEval(t.count,e))>0)}),h=d<0?null:c[d];if(h){var f={};f.loopCondition="loop"===h.type||"countLoop"===h.type?h.expression:null,f.loopCount=1,f.loopCountExpr=h.count,e.cmdStack=[f].concat(s(e.cmdStack)),i=0,r={commands:h.commands,parentInfo:t,parentCmdIndex:n}}}else if("backOption"===a.type){for(var m=0;m<a.eArg&&r.parentInfo&&(e.cmdStack[0]&&"insert"!==e.cmdStack[0].type);m++)e.cmdStack=e.cmdStack.splice(1),i=r.parentCmdIndex,r=r.parentInfo;if(i>-1&&r.commands)return{info:r,index:i}}else if("jumpOption"===a.type){for(var p=0;p<a.eArg&&r.parentInfo&&(e.cmdStack[0]&&"insert"!==e.cmdStack[0].type);p++)e.cmdStack=e.cmdStack.splice(1),i=r.parentCmdIndex,r=r.parentInfo;i++}for(;r&&!r.commands[i]&&e.cmdStack&&0<e.cmdStack.length;){var y=e.cmdStack[0];if(y.loopCondition&&o.safeEval(y.loopCondition,e)){if(i=0,y.loopCount&&y.loopCount++,!y.loopCountExpr)break;var g=parseInt(o.safeEval(y.loopCountExpr,e));if(y.loopCount<=g)break}y.type&&"insert"===y.type||(e.cmdStack=e.cmdStack.splice(1)),y.type&&"insert"===y.type?(i=-1,r=null):r.parentInfo&&(i=r.parentCmdIndex+1,r=r.parentInfo)}return{info:r,index:i}},removeInputView:function(e){if(e.inputElement)e.inputElement.destroy();else if(e.children&&e.children.length)for(var t=0;t<e.children.length;t++)this.removeInputView(e.children[t])},removeViewTimer:function(e){var t=this;return"TIMER"===e.viewType?void("timeOut"===e.timerType?clearTimeout(e.timerHandler):clearInterval(e.timerHandler)):void e.children.forEach(function(e){return t.removeViewTimer(e)})},filterInexistentPlotViews:function(e,t){if(t.commands&&0!==t.commands.length)for(var n=function r(e,t){for(var n=0;n<t.length;n++){if(t[n].uuid===e)return!0;if("options"===t[n].type||"conditionOptions"===t[n].type)for(var a=0;a<t[n].args.length;a++)if(r(e,t[n].args[a].commands))return!0}return!1},a=0;a<e.length;a++)if(e[a].generateType){var o=e[a].generateType;n(o,t.commands)||(e.splice(a,1),a--)}},destroyAll:function(){var e=this;if(this.playBackLayer.removeAll(!0),this.globalViews&&this.globalViews.forEach(function(t){e.removeInputView(t),t.destroy()}),this.globalViews=null,this.plotViewsLayer.children.forEach(function(t){e.removeViewTimer(t),e.removeInputView(t)}),this.plotViewsLayer.removeAll(!0),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version){b["default"].stopMusic(),b["default"].removeAudioUrl(b["default"].musicInfo.key);for(var t=0;t<10;t++)b["default"].soundsInfo[t].key&&(b["default"].stopSound(t),b["default"].removeAudioUrl(b["default"].soundsInfo[t].key))}else this.bk_music&&this.bk_music.destroy(),this.bk_music=null,this.plotSounds&&this.plotSounds.forEach(function(e){return e&&e.destroy()}),this.plotSounds=[];this.lstPlotLayer&&(this.lstPlotLayer.destroy(),this.lstPlotLayer=null)},reStart:function(){var e=this;if("ios"===flashvars.client?1===flashvars.offline?workFinished("1"):window.webkit&&window.webkit.messageHandlers.workFinished.postMessage("1"):"android"===flashvars.client&&window.app&&window.app.workFinished("1"),this.dialogLayer.visible=!1,this.unlockChapterCallBack=null,this.mallPayCallback=null,this.destroyAll(),this.initContext(this.context),!this.json_data.cover.hidden)return this.showCover();var t=this.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length)if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client)this.checkIfChapterFree(n,t.md5).then(function(n){t.plots=n,e.preloadChapterAssets(e.context,t)},function(e){-1===e.indexOf("code=87")?y["default"].error(e):y["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var a=function(a){a&&e.checkIfChapterFree(n,t.md5).then(function(n){e.unlockChapterCallBack=null,t.plots=n,e.preloadChapterAssets(e.context,t)},function(){return y["default"].error("获取付费章节信息失败")})};this.unlockChapter(n,t.charge,t.md5,a)}else this.preloadChapterAssets(this.context,t)},valueOperation:function(e,t,n){var a=this;if(!this.isPaying){var o=function(t,o){if(e.payValues[t].value=o,""===flashvars.u&&""===flashvars.token&&""===flashvars.client){var r=h["default"].getUidByCookie();r!==flashvars.uid&&""!==r?(flashvars.uid=r,a.localRecFileToUidRecFile(!1),a.getPayInfo().then(function(){a.getAccountInfo()})):!n&&a.savePayInfo()}else!n&&a.savePayInfo()},r=function(t,n,a){if(!a)return n<1?y["default"].info("出现未知数值操作，请联系作者检查修改"):"value"===e.indexValues[t].init.type&&n>e.values.length?y["default"].info("出现未知数值操作，请联系作者检查修改"):"savedValue"===e.indexValues[t].init.type&&n>e.savedValues.length?y["default"].info("出现未知数值操作，请联系作者检查修改"):"stringValue"===e.indexValues[t].init.type&&n>e.stringValues.length?y["default"].info("出现未知数值操作，请联系作者检查修改"):"payValue"===e.indexValues[t].init.type&&n>e.payValues.length&&y["default"].info("出现未知数值操作，请联系作者检查修改"),void(e.indexValues[t].value=n);var r=void 0===e.indexValues[t].value?e.indexValues[t].init.value-1:e.indexValues[t].value-1;if("value"===e.indexValues[t].init.type){if(r<0||r>=e.values.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");e.values[r].value=n}else if("savedValue"===e.indexValues[t].init.type){if(r<0||r>=e.savedValues.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");e.savedValues[r].value=n}else if("stringValue"===e.indexValues[t].init.type){if(r<0||r>=e.stringValues.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");e.stringValues[r].value=n}else if("payValue"===e.indexValues[t].init.type){if(r<0||r>=e.payValues.length)return void y["default"].info("出现未知数值操作，请联系作者检查修改");o(r,n)}};t&&t.length>0&&t.forEach(function(t){var n=a.Expression.safeEval(t.expression,a.context),i=t.uuid,s=void 0;(s=a.context.values.findIndex(function(e){return e.uuid===i}))!==-1?e.values[s].value=n:(s=a.context.savedValues.findIndex(function(e){return e.uuid===i}))!==-1?(e.savedValues[s].value=n,h["default"].localStorageSetItem(flashvars.uuid+"savedValues"+flashvars.uid,JSON.stringify(e.savedValues))):(s=a.context.stringValues.findIndex(function(e){return e.uuid===i}))!==-1?e.stringValues[s].value=n:(s=a.context.payValues.findIndex(function(e){return e.uuid===i}))!==-1?o(s,n):(s=a.context.indexValues.findIndex(function(e){return e.uuid===i}))!==-1?r(s,n,t.reference):console.error("Cannot find value/savedValue with uuid = ",i)})}},updateValues:function(e){for(var t=JSON.parse(JSON.stringify(this.json_data.values)),n=0;n<e.values.length;n++)for(var a=0;a<t.length;a++)if(t[a].uuid===e.values[n].uuid){t[a].value=e.values[n].value;break}e.values=t.concat(),t=JSON.parse(JSON.stringify(this.json_data.savedValues));for(var o=0;o<e.savedValues.length;o++)for(var r=0;r<t.length;r++)if(t[r].uuid===e.savedValues[o].uuid){t[r].value=e.savedValues[o].value;break}e.savedValues=t.concat(),t=JSON.parse(JSON.stringify(this.json_data.stringValues));for(var i=0;i<e.stringValues.length;i++)for(var s=0;s<t.length;s++)if(t[s].uuid===e.stringValues[i].uuid){t[s].value=e.stringValues[i].value;break}if(e.stringValues=t.concat(),this.json_data.payValues){if(t=JSON.parse(JSON.stringify(this.json_data.payValues)),e.payValues)for(var l=0;l<e.payValues.length;l++)for(var u=0;u<t.length;u++)if(t[u].uuid===e.payValues[l].uuid){t[u].value=e.payValues[l].value;break}e.payValues=t.concat()}if(this.json_data.indexValues){if(t=JSON.parse(JSON.stringify(this.json_data.indexValues)),e.indexValues)for(var c=0;c<e.indexValues.length;c++)for(var d=0;d<t.length;d++)if(t[d].uuid===e.indexValues[c].uuid){t[d].value=e.indexValues[c].value;break}e.indexValues=t.concat()}},initContext:function(e,t){var n=function(e){return e?JSON.parse(JSON.stringify(e)):e},a={};if(t&&this.updateValues(e),a.auto=this.context&&this.context.auto||!1,a.fullScreen=this.context&&this.context.fullScreen||!1,a.savedValues=n(e&&e.savedValues||this.json_data.savedValues),!e&&!t){var o=h["default"].localStorageGetItem(flashvars.uuid+"savedValues"+flashvars.uid);if(o)for(var r=JSON.parse(o),i=0;i<r.length;i++)for(var s=0;s<a.savedValues.length;s++)if(a.savedValues[s].uuid===r[i].uuid){a.savedValues[s].value=r[i].value;break}}if(t)a.values=n(e.values),a.stringValues=n(e.stringValues),a.payValues=n(this.context.payValues),a.indexValues=n(e.indexValues);else{a.values=n(this.json_data.values),a.stringValues=n(this.json_data.stringValues),a.payValues=n(this.json_data.payValues?this.json_data.payValues:this.context.payValues),a.indexValues=n(this.json_data.indexValues?this.json_data.indexValues:this.context.indexValues);for(var l=0;l<a.payValues.length;l++)for(var u=0;u<this.context.payValues.length;u++)if(a.payValues[l].uuid===this.context.payValues[u].uuid){a.payValues[l].value=this.context.payValues[u].value;break}}if(this.json_data.systemValues?(a.systemValues=n(this.json_data.systemValues),1===a.systemValues.length?a.systemValues=a.systemValues.concat([{},{},{},{},{},{},{},{},{},{}]):9===a.systemValues.length?a.systemValues=a.systemValues.concat([{},{}]):10===a.systemValues.length&&(a.systemValues=a.systemValues.concat([{}])),a.systemValues[0].value=this.context.systemValues[0].value,a.systemValues[1].value=this.context.systemValues[1].value,a.systemValues[9].value=this.context.systemValues[9].value):a.systemValues=n(this.context.systemValues),-1===h["default"].timeStamp)h["default"].getTimeOffset().then(function(){h["default"].updateContextTimeValues(a)},null);else{var c=new Date(1e3*h["default"].timeStamp);a.systemValues[2].value=h["default"].timeStamp,a.systemValues[3].value=c.getFullYear(),a.systemValues[4].value=c.getMonth()+1,a.systemValues[5].value=c.getDate(),a.systemValues[6].value=c.getHours(),a.systemValues[7].value=c.getMinutes(),a.systemValues[8].value=c.getSeconds(),a.systemValues[10].value=c.getDay()}t&&e&&e.stack?(a.stack=n(e.stack),a.cmdStack=n(e.cmdStack)):(a.stack=[],a.cmdStack=[]),this.context=a},doInCT:function(e,t){return e!==this.context?Promise.reject("timeline changed"):t()},txtLineSpace:function(e){var t=0;return t=12==e||14==e||16==e||18==e?-4+e/2:e<19?-5+e/2:e<28?-6+e/2:e<37?-7+e/2:e<46?-9+e/2:e<56?-10+e/2:-Math.ceil(e/5)+e/2,!this.viewComponent.game.device.desktop&&(t-=2),t},stopMusic:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].stopMusic():e&&this.bk_music&&e===this.bk_music.key?this.bk_music.stop():this.bk_music&&(this.bk_music.destroy(),this.bk_music=null,this.decodeCacheAudio(e)),d.ResourcesManager.subRefCount("audio",d.ResourcesManager.usingKeyMap.music),d.ResourcesManager.usingKeyMap.music=""},playMusic:function(e,t,n){arguments.length>3&&void 0!==arguments[3]&&arguments[3];d.ResourcesManager.usingKeyMap.music=e,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playMusic(e,t,n):(this.bk_music&&e===this.bk_music.key||(this.bk_music=this.viewComponent.game.add.sound(e,t,n)),this.bk_music.play())},playInheritMusic:function(e){d.ResourcesManager.subRefCount("audio",d.ResourcesManager.usingKeyMap.music),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playInheritMusic(e):this.bk_music&&void 0!==e&&(this.bk_music.volume=e)},stopSound:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];null!==e&&void 0!==e&&("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].stopSound(e):t&&this.plotSounds[e]&&t===this.plotSounds[e].key?this.plotSounds[e].stop():this.plotSounds[e]&&(this.plotSounds[e].destroy(),this.plotSounds[e]=null,this.decodeCacheAudio(t)),d.ResourcesManager.subRefCount("audio",d.ResourcesManager.usingKeyMap.sounds[e]),d.ResourcesManager.usingKeyMap.sounds[e]="")},playSound:function(e,t,n,a){arguments.length>4&&void 0!==arguments[4]&&arguments[4];d.ResourcesManager.usingKeyMap.sounds[e]=t,"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playSound(e,t,n,a):(this.plotSounds[e]&&this.plotSounds[e].key===t||(this.plotSounds[e]=this.viewComponent.game.add.sound(t,n,a)),this.plotSounds[e].play())},playInheritSound:function(e,t){d.ResourcesManager.subRefCount("audio",d.ResourcesManager.usingKeyMap.sounds[e]),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?b["default"].playInheritSound(e,t):this.plotSounds[e]&&void 0!==t&&(this.plotSounds[e].volume=t)},decodeCacheAudio:function(e){var t=this;if(e){var n=this.viewComponent.game.load.cache.getSound(e);return void(!n||n.decoded||n.isDecoding||this.viewComponent.game.sound.decode(e))}var a=0,o=this.viewComponent.game.load.cache.getKeys(Phaser.Cache.SOUND);for(var r in o){var i=this.viewComponent.game.load.cache.getSound(o[r]);if((i.decoded||i.isDecoding)&&a++,a>4)return}o.some(function(e){var n=t.viewComponent.game.load.cache.getSound(e);return!n.decoded&&!n.isDecoding&&(t.viewComponent.game.sound.decode(e),!0)})},toRealImageFontHeight:function(e){var t=this.json_data.font.size.target.height?this.json_data.font.size.target.height:this.json_data.font.size.target;return parseFloat(e)*t/this.json_data.font.size.source},toRealImageFontWidth:function(e){var t=this.json_data.font.size.target.width?this.json_data.font.size.target.width:this.json_data.font.size.target;return parseFloat(e)*t/this.json_data.font.size.source},isWap3000:function(){return!flashvars.wap||flashvars.wap&&"3000"===flashvars.wap},Expression:function(){function e(){r(this,e)}return l(e,null,[{key:"isString",value:function(e){return"[object String]"===Object.prototype.toString.apply(e)}},{key:"isArray",value:function(e){return"[object Array]"===Object.prototype.toString.apply(e)}},{key:"toN",value:function(e){var t=Number(e);return isNaN(t)?(console.warn(e+" is not a number"),0):t}},{key:"toInt",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=parseInt(e,t);return isNaN(n)?(console.warn(e+" is not a int"),0):n}},{key:"toWeek",value:function(e){switch(e){case 0:return 7;default:return e}}},{key:"safeEval",value:function(e,t){var n=this,a=function r(e,t){var a=void 0,o=void 0,i=void 0;switch(e.type){case"arg1":return r(e.arg1,t);case"+":return a=r(e.arg1,t),o=r(e.arg2,t),n.isString(a)||n.isString(o)?("#"+a+o).slice(1):n.add(r(e.arg1,t),r(e.arg2,t));case"-":return a=r(e.arg1,t),o=r(e.arg2,t),n.isString(a)||n.isString(o)?(a+"").split(o+"").join(""):n.sub(r(e.arg1,t),r(e.arg2,t));case"*":return n.mul(r(e.arg1,t),r(e.arg2,t));case"/":return n.div(r(e.arg1,t),r(e.arg2,t));case"%":return a=parseInt(r(e.arg1,t)),o=parseInt(r(e.arg2,t)),0===o?(y["default"].error("求余除数不能为 0"),0):n.mod(a,o);case"==":return r(e.arg1,t)===r(e.arg2,t);case"!=":return r(e.arg1,t)!==r(e.arg2,t);case">":return r(e.arg1,t)>r(e.arg2,t);case"<":return r(e.arg1,t)<r(e.arg2,t);case">=":return r(e.arg1,t)>=r(e.arg2,t);case"<=":return r(e.arg1,t)<=r(e.arg2,t);case"min":return Math.min.apply(null,e.args.map(function(e){return r(e,t)}));case"max":return Math.max.apply(null,e.args.map(function(e){return r(e,t)}));case"all":return e.args.map(function(e){return r(e,t)}).every(function(e){return e});case"any":return e.args.map(function(e){return r(e,t)}).some(function(e){return e});case"literal":return Number(e.value);case"int":return parseInt(n.toN(r(e.arg1,t)));case"random":var l=n.toInt(e.range[0]),u=n.toInt(e.range[1]);return~~(Math.random()*(u-l+1)+l);case"value":case"savedValue":case"payValue":return i=[].concat(s(t.values),s(t.savedValues),s(t.payValues)).find(function(t){return t.uuid===e.arg1}),void 0!==i.value?n.toN(i.value):n.safeInitValue(i);case"systemValue":return i=t.systemValues.find(function(t){return t.uuid===e.arg1}),void 0!==i.value?(i.uuid!==t.systemValues[0].uuid&&i.uuid!==t.systemValues[1].uuid&&i.uuid!==t.systemValues[9].uuid&&h["default"].updateContextTimeValues(t),i.uuid===t.systemValues[10].uuid?n.toWeek(i.value):n.toN(i.value)):n.safeInitValue(i);case"indexValue":return i=t.indexValues.find(function(t){return t.uuid===e.arg1}),void 0!==i.value?n.toN(i.value):n.safeInitValue(i);case"string":return e.value+"";case"stringValue":return i=t.stringValues.find(function(t){return t.uuid===e.arg1}),void 0!==i.value?i.value+"":n.safeInitValue(i);case"reference":if(i=t.indexValues.find(function(t){return t.uuid==e.arg1})){var c=(void 0===i.value?n.safeInitValue(i):n.toN(i.value))-1;if("value"===i.init.type)return c<0||c>=t.values.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.values[c].value?n.toN(t.values[c].value):n.safeInitValue(t.values[c]);if("savedValue"===i.init.type)return c<0||c>=t.savedValues.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.savedValues[c].value?n.toN(t.savedValues[c].value):n.safeInitValue(t.savedValues[c]);if("payValue"===i.init.type)return c<0||c>=t.payValues.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.payValues[c].value?n.toN(t.payValues[c].value):n.safeInitValue(t.payValues[c]);if("stringValue"===i.init.type)return c<0||c>=t.stringValues.length?(y["default"].info("出现未知数值操作，请联系作者检查修改"),"[未知数值]"):void 0!==t.stringValues[c].value?t.stringValues[c].value+"":n.safeInitValue(t.stringValues[c])}case"contain":return a=r(e.arg1,t),o=r(e.arg2,t),(a+"").indexOf(o+"")>-1;case"stringLength":return a=r(e.arg1,t),a?a.length:0;default:throw new error("expr type  is  error")}};try{return a(e,t)}catch(o){return console.error(o),NaN}}},{key:"safeInitValue",value:function(e){function t(e){if("const"===e.init.type||"system"===e.init.type)return e.value=e.init.value,e.value;if("random"===e.init.type){var t=Number(e.init.range[0]),n=Number(e.init.range[1]);return e.value=~~(Math.random()*(n-t+1)+t),e.value}return"string"===e.init.type?(e.value=e.init.value+"",e.value):e.init.onlyRead?(e.value=e.init.value,e.value):(console.error("unknown init type"),0)}try{return t(e)}catch(n){return console.error(n),0}}},{key:"fix",value:function(e,t){var n=this,a=e.type,o=e.arg1,r=e.arg2,i=e.args,l=e.value,u={type:a},c=void 0;switch(a){case"arg1":case"stringLength":var d=this.fix(o,t);return d?(u.arg1=d,u):null;case"+":case"-":case"*":case"/":case"%":case"==":case"!=":case">":case"<":case">=":case"<=":case"contain":return u.arg1=this.fix(o,t),u.arg2=this.fix(r,t),u.arg1&&u.arg2?u:null;case"min":case"max":case"all":case"any":var h=i.map(function(e){return n.fix(e,t)});return u.args=h.filter(function(e){return null!==e}),u;case"literal":return u.value=Number(l),u;case"random":return u.range=(e.range||[0,100]).map(function(e){return n.toInt(e)}),u.range.sort(),u;case"value":case"savedValue":case"payValue":case"systemValues":case"indexValue":return c=[].concat(s(t.values),s(t.savedValues),s(t.payValues),s(t.systemValues),s(t.indexValues)).find(function(t){return t.uuid===e.arg1}),void 0===c?null:(u.arg1=o,u);case"string":return u.value=l+""||"",u;case"stringValue":return c=t.stringValues.find(function(t){return t.uuid===e.arg1}),void 0===c?null:(u.arg1=o,u);default:return null}}},{key:"parseValue",value:function(e,t,n){for(var a=/([\s\S]*)&(s|v|sv|p|x|i|iv)\[(\d+)\]([\s\S]*)/,o=a.exec(e),r=void 0,i=e;o;){var s=o[2],l=parseInt(o[3]),u="[未知数值]";if("s"===s&&t.savedValues[l])r="[Y"+(l+1)+":"+t.savedValues[l].name+"]",u=void 0===t.savedValues[l].value?this.safeInitValue(t.savedValues[l]):t.savedValues[l].value,u=n?r:this.toFixed(u,2);else if("v"===s&&t.values[l])r="[P"+(l+1)+":"+t.values[l].name+"]",u=void 0===t.values[l].value?this.safeInitValue(t.values[l]):t.values[l].value,u=n?r:this.toFixed(u,2);else if("sv"===s&&t.stringValues[l])r="[Z"+(l+1)+":"+t.stringValues[l].name+"]",u=void 0===t.stringValues[l].value?this.safeInitValue(t.stringValues[l]):t.stringValues[l].value,n&&(u=r);else if("p"===s&&t.payValues[l])r="[X"+(l+1)+":"+t.payValues[l].name+"]",u=void 0===t.payValues[l].value?this.safeInitValue(t.payValues[l]):t.payValues[l].value,u=n?r:this.toFixed(u,2);else if("x"===s&&t.systemValues[l])-1===h["default"].timeStamp?h["default"].getTimeOffset().then(function(){h["default"].updateContextTimeValues(t)},function(){y["default"].info("当前网络不佳，获取系统时间失败")}):h["default"].updateContextTimeValues(t),r="[S"+(l+1)+":"+t.systemValues[l].name+"]",u=void 0===t.systemValues[l].value?this.safeInitValue(t.systemValues[l]):10===l?this.toWeek(t.systemValues[10].value):t.systemValues[l].value,u=n?r:this.toFixed(u,2);else if("i"===s&&t.indexValues[l])r="[I"+(l+1)+":"+t.indexValues[l].name+"]",u=void 0===t.indexValues[l].value?this.safeInitValue(t.indexValues[l]):t.indexValues[l].value,u=n?r:this.toFixed(u,2);else if("iv"===s)if(l>=t.indexValues.length)u="[未知数值]";else{r="[IV"+(l+1)+":"+t.indexValues[l].name+"]";var c=(void 0===t.indexValues[l].value?this.safeInitValue(t.indexValues[l]):t.indexValues[l].value)-1;if(n)u=r;else{var d=this.toFixed(c,2);"value"===t.indexValues[l].init.type?c<0||c>=t.values.length?u="[未知数值]":(u=void 0===t.values[d].value?this.safeInitValue(t.values[d]):t.values[d].value,u=this.toFixed(u,2)):"savedValue"===t.indexValues[l].init.type?c<0||c>=t.savedValues.length?u="[未知数值]":(u=void 0===t.savedValues[d].value?this.safeInitValue(t.savedValues[d]):t.savedValues[d].value,u=this.toFixed(u,2)):"payValue"===t.indexValues[l].init.type?c<0||c>=t.payValues.length?u="[未知数值]":(u=void 0===t.payValues[d].value?this.safeInitValue(t.payValues[d]):t.payValues[d].value,u=this.toFixed(u,2)):"stringValue"===t.indexValues[l].init.type&&(u=c<0||c>=t.stringValues.length?"[未知数值]":void 0===t.stringValues[d].value?this.safeInitValue(t.stringValues[d]):t.stringValues[d].value)}}i=o[1]+u+o[4],o=a.exec(i)}return i}},{key:"parseWaitTime",value:function(e,t){for(var n=/([\s\S]*)\\(\d+)\s([\s\S]*)/,a=n.exec(e);a;)e=t?a[1]+("[停顿:"+a[2]+"ms]")+a[3]:a[1]+a[3],a=n.exec(e);return e}},{key:"getGameValueByTimer",value:function(e,t){var n={};if(!e)return-1;var a=e.time,o=a.type,r=a.arg1;if("value"===o)n=t.values.find(function(e){return e.uuid===r});else if("savedValue"===o)n=t.savedValues.find(function(e){return e.uuid===r});else{if("literal"!==o)return-1;n.value=e.time.value}var i=n&&void 0===n.value?this.safeInitValue(n):n.value;return Math.max(i,0)}},{key:"add",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.max(n,a),e=parseInt(e.toString().replace(".",""))*Math.pow(10,o-n),t=parseInt(t.toString().replace(".",""))*Math.pow(10,o-a),(e+t)/Math.pow(10,o)}},{key:"sub",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.max(n,a),e=parseInt(e.toString().replace(".",""))*Math.pow(10,o-n),t=parseInt(t.toString().replace(".",""))*Math.pow(10,o-a),(e-t)/Math.pow(10,o)}},{key:"div",value:function(e,t){if(!t)return y["default"].error("除数不能为 0"),0;var n=0,a=0,o=void 0;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=parseInt(e.toString().replace(".",""))/parseInt(t.toString().replace(".","")),a-n<0||o!==parseInt(o)?this.mul(o,Math.pow(10,a-n)):o*Math.pow(10,a-n)}},{key:"mul",value:function(e,t){var n=0,a=e.toString(),o=t.toString();try{n+=a.includes("1e-")?parseInt(a.split("1e-")[1]):a.split(".")[1].length}catch(r){}try{n+=o.includes("1e-")?parseInt(o.split("1e-")[1]):o.split(".")[1].length}catch(r){}return parseInt(a.replace(".",""))*parseInt(o.replace(".",""))/Math.pow(10,n)}},{key:"mod",value:function(e,t){var n=0,a=0,o=1;try{n=e.toString().split(".")[1].length}catch(r){}try{a=t.toString().split(".")[1].length}catch(r){}return o=Math.pow(10,Math.max(n,a)),e*o%(t*o)/o}},{key:"toFixed",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=0;try{n=e.toString().split(".")[1].length}catch(a){}var o=e.toString();return n>t&&t>=0&&(o=o.substring(0,o.indexOf(".")+t+1),n=t),e=parseInt(o.replace(".","")),e/Math.pow(10,n)}}]),e}()},{NAME:"SceneProxy",guideLayer:null,logo:null,coverLayer:null,progressLayer:null,dialogLayer:null,menuLayer:null,mainMenuLayer:null,settingsLayer:null,recordLayer:null,playBackLayer:null,weatherLayer:null,charsAndPropsLayer:null,optionLayer:null,plotViewsLayer:null,globalViews:null,plotViews:null,prgsViews:null,endLayer:null,toastLayer:null,loadingToastLayer:null,quickPlayLayer:null,bk_music:null,plotSounds:null,btn_sound:null,audioDecodedCount:0,lstPlotBkKey:null,lstPlotBkOpacity:0,lstPlotBkFlex:1,lstGameBk:null,curPlotLayer:null,lstPlotLayer:null,viewComponent:null,json_data:{},Template:{},stringMap:{},progressTips:[],unlockChapterCallBack:null,mallPayCallback:null,context:{},plotSnap:null,savedPlotsData:null,cloudPlotsData:null,recUidBelongTo:"",gameUidBelongTo:"",bSwitchAccInPlot:!0,payValueUid:"",playPause:!1,bViewLoaded:!1,bSignedIn:!1,bCloudSel:!1,curChapter:null,curPlotInfo:null,curPlotIndex:0,cmdPlotSnap:null,curCmdUuid:"",bCmdAutoText:!1,lstDialogInfo:null,menuInfo:null,charsAndPropsInfo:[],bToSaveFile:!0,space_key:null,globalViewKeys:null,plotViewKeys:null,quickPlay:!1,isScreenHold:!1,isShowGuide:!0,recordTipCount:0,visibleLayout:[],resourceManager:{},lstPlotTweens:[],twinkleTimer:null,uiOnLoadQueue:[],timerCounts:[],menuTimer:[],cmdPlotNextPromise:null,cmdPlayHandlerFun:null,curCmdInfo:null,curCmdIndex:0,isGameStarted:!1,usedStarCount:0,gameStarLimit:0,isPaying:!1})}),require.register("js/view/component/Scene.js",function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}var r=t("puremvc"),i=o(r),s=t("../../common/XmlHttpRequest.js"),l=a(s),u=t("../../common/RePhaser.js"),c=o(u),d=t("../../common/Utils.js"),h=o(d),f=t("../../common/Version.js"),m=o(f),p=t("../../common/PhoneUtils.js"),y=o(p),g=t("../../common/FontUtils.js"),v=o(g);i["default"].define({name:"diygamePlayer.view.component.Scene",constructor:function(){var e=this,t={init:function o(){!e.game.device.desktop&&(e.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL),e.game.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL,e.game.scale.pageAlignVertically=!0,e.game.scale.pageAlignHorizontally=!0,e.game.stage.disableVisibilityChange=!0,e.game.scale.setResizeCallback(function(t,n){var a=document.getElementById("game");a.style.width=document.body.clientWidth+"px",a.style.height=document.body.clientHeight+"px",document.body.clientWidth>document.body.clientHeight?0!==e.game.world.angle&&(e.game.scale.setGameSize(960,540),e.game.world.angle=0,e.game.world.setBounds(0,0,960,540),e.game.scale.refresh()):90!==e.game.world.angle&&(e.game.scale.setGameSize(540,960),e.game.world.angle=90,e.game.world.setBounds(-960,0,960,540),e.game.scale.refresh())}),e.game.load.loadImageTag=c["default"].loadImageTag,e.game.load.onSoundLoadExtend=new Phaser.Signal,y["default"].load=e.game.load,e.game.renderer.renderSession.roundPixels=!0,e.game.sound.decode=c["default"].soundDecode,e.game.sound.onSoundDecodeError=new Phaser.Signal;var o=function(){e.game.sound.touchLocked=!1,d.AudioTagPool.fill();var t=e.game.cache.getKeys(Phaser.Cache.SOUND);t.forEach(function(t){var n=e.game.cache.getSound(t);n&&!d.AudioTagPool.exist(n.data)&&e.game.cache.reloadSound(t)})};e.game.device.iOS?e.game.device.iOSVersion>8?e.game.input.touch.addTouchLockCallback(o,e.game,!0):e.game.input.touch.addTouchLockCallback(o,e.game):o(),d.ResourcesManager.cache=e.game.cache,e.game.destroyComponent.add(function(e){return d.ResourcesManager.subRefCount("img",e,"play")}),window.ResourcesManager=d.ResourcesManager},preload:function(){},create:function(){this.game.canvas.oncontextmenu=function(e){return e.preventDefault()};var t=e.game.add.graphics(0,0);
t.name="startBk",t.beginFill(6476757),t.drawRect(0,0,960,540),t.endFill(),e.onRendered&&e.onRendered()},update:function(){}},n=Phaser.CANVAS,a=navigator.userAgent.match(/chrome\/((([0-9]*)+(\.))*)+([0-9]*)/gi);a&&("Chrome/50.0.2661.86"==a[0]||"Chrome/51.0.2704.81"==a[0]?-1===navigator.userAgent.indexOf("Android 6.0.1; MI 4LTE")&&-1===navigator.userAgent.indexOf("vivo Y67")&&(n=Phaser.AUTO):"Chrome/46.0.2490.76"==a[0]&&-1!==navigator.userAgent.indexOf("OPPO R9s")&&(n=Phaser.AUTO)),e.game=new Phaser.Game(960,540,n,"game",t),e.game.preserveDrawingBuffer=!0,window.game=e.game,window.AudioContext=null,window.webkitAudioContext=null,console.log("versionCommit: ",m["default"])}},{showLogo:function(){var e=this.game.world.getByName("logo_preloader");e||(e=this.game.add.image(this.game.world.width/2,this.game.world.height/2,"logo_preloader"),e.name="logo_preloader",e.anchor.setTo(.5,.5)),e.visible=!0},showOfflineBg:function(){var e=this.game.world.getByName("offlinebg");if(!e){var t=h["default"].localStorageGetItem("shanyi3000opg");e=this.game.add.image(this.game.world.width/2,this.game.world.height/2,t?"offlinebg":"Operation_tip"),e.name="offlinebg",e.inputEnabled=!0,e.anchor.setTo(.5,.5),this.game.world.setChildIndex(e,1)}e.visible=!0},showLoading:function(){var e=this.game.world.getByName("logo_preloader"),t=this.game.world.getByName("loading_gif");return t||(t=this.game.add.image(this.game.world.width/2,this.game.world.height/2,"loading_gif"),t.x=369,t.y=80,t.name="loading_gif",this.addGifAnimation(t)),e&&(e.scale.setTo(.35,.35),e.x=this.game.world.width-e.width+25,e.y=this.game.world.height-e.height+12),t.visible=!0,!0},destroyLogo:function(){var e=this.game.world.getByName("startBk"),t=this.game.world.getByName("logo_preloader"),n=this.game.world.getByName("loading_gif"),a=this.game.world.getByName("logInfo");e&&e.destroy(),t&&t.destroy(),n&&n.destroy(),a&&a.destroy()},preLoadCertainAssets:function(){if(this.game.load.spritesheet("wind","./img/wind.png",960,540),this.game.load.image("icon_back","./img/icon_back.png"),this.game.load.image("icon_back_over_pressed","./img/icon_back_over_pressed.png"),this.game.load.image("icon_candy","./img/icon_candy.png"),this.game.load.image("icon_candy_over_pressed","./img/icon_candy_over_pressed.png"),this.game.load.image("icon_get","./img/icon_get.png"),this.game.load.image("icon_get_hover_pressed","./img/icon_get_hover_pressed.png"),this.game.load.image("icon_save","./img/icon_save.png"),this.game.load.image("icon_save_over_pressed","./img/icon_save_over_pressed.png"),this.game.load.image("cloud","./img/cloud.png"),this.game.load.image("cloud_hover","./img/cloud_hover.png"),this.game.load.image("local","./img/local.png"),this.game.load.image("local_hover","./img/local_hover.png"),this.game.load.image("icon_success","./img/icon_success.png"),this.game.load.image("icon_error","./img/icon_error.png"),this.game.load.image("light","./img/light.png"),this.game.load.image("toast_loading","./img/toast_loading.gif"),this.game.load.image("app_button_speed","./img/app_button_speed.png"),this.game.load.image("app_icon_speed","./img/app_icon_speed.png"),this.game.load.image("Operation_tip","./img/Operation_tip.png"),this.game.load.image("Cloud_record_tip","./img/Cloud_record_tip.png"),this.game.load.image("offlinebg","./img/offlinebg.png"),this.game.load.image("Continue","./img/Continue.png"),this.game.load.image("menuMore","./img/more.png"),this.game.load.image("menuMoreHover","./img/more_hover.png"),"1"===flashvars.offline){for(var e=0;e<50;e++)this.game.load.image("/weather/rain/xiayu_"+h["default"].formatNum(e)+".png","./img/rain/xiayu_"+h["default"].formatNum(e)+".png");for(var t=0;t<120;t++)this.game.load.image("/weather/snow/xuehua_"+h["default"].formatNum(t)+".png","./img/snow/xuehua_"+h["default"].formatNum(t)+".png");for(var n=0;n<90;n++)this.game.load.image("/weather/mapleLeaves/fengye_"+h["default"].formatNum(n)+".png","./img/mapleLeaves/fengye_"+h["default"].formatNum(n)+".png");for(var a=0;a<90;a++)this.game.load.image("/weather/beachBlossom/taohua_"+h["default"].formatNum(a)+".png","./img/beachBlossom/taohua_"+h["default"].formatNum(a)+".png");for(var o=0;o<90;o++)this.game.load.image("/weather/blossom/yinghua_"+h["default"].formatNum(o)+".png","./img/blossom/yinghua_"+h["default"].formatNum(o)+".png");for(var r=0;r<50;r++)this.game.load.image("/weather/lightning/shandian_"+h["default"].formatNum(r)+".png","./img/lightning/shandian_"+h["default"].formatNum(r)+".png")}},preLoad:function(){var e=this;return new Promise(function(t,n){e.preLoadCertainAssets(),e.game.load.onLoadStart.addOnce(function(){e.addLog("正在准备播放..")}),e.game.load.onFileComplete.add(function(t,n,a,o,r){"offlinebg"===n&&e.showOfflineBg(),e.addLog("正在准备播放.. "+t+"%",!0)}),e.game.load.onLoadComplete.addOnce(function(){return e.game.load.onFileComplete.removeAll(),e.addLog("正在准备播放..【成功】",!0),t()}),e.game.load.start()})},getGameJson:function(){var e=this;flashvars.uuid=flashvars.uuid||"41138941-7f1c-4701-9a94-394893483662";var t=flashvars.uuid;document.title=flashvars.name&&decodeURI(flashvars.name)||"测试";var n=function(t){if(t.lengthComputable){var n=t.loaded/t.total;e.addLog("加载剧情配置.. "+~~n+"%",!0)}else e.addLog("加载剧情配置.. "+t.loaded,!0)};this.addLog("加载剧情配置..");var a=1==flashvars.type?l.getTestGame:l.getGame;return a(t,n).then(function(t){return e.addLog("加载剧情配置..【成功】",!0),t},function(t){return e.addLog("发生错误："+t),Promise.reject(t)})},addLog:function(e,t){if(e){var n=this.game.world.getByName("logInfo");if(!n){var a={font:"16px 宋体",fill:"#fff"};n=this.game.add.text(18,504,"",a),n.name="logInfo"}var o=n.text,r=o.split(/\r?\n/gi).filter(function(e){return!!e});t?r[r.length-1]=e:r.push(e),n.text="",r.slice(-4).map(function(e){return n.text+=e+"\n"}),n.y=540-26*r.length+5}},addButton:function(e,t,n,a,o,r,i,s,l,u,c,d){var h=this,f=function(e,t,n,a,o){var r=o.children[0],i=t?t:r?r.text:"";if(i){var s=e.fontSize?parseInt(e.fontSize):25,l=e.color?e.color:"#fefefe",u=h.sceneProxy.json_data.font.size?h.sceneProxy.toRealImageFontHeight(s):s,c=h.sceneProxy.json_data.font.size?h.sceneProxy.toRealImageFontWidth(s):s;if(l.indexOf("rgb")!==-1){var d=l.replace("rgb(","").replace(")","").split(",");o.addColor("#"+("00000"+(parseInt(d[0])<<16|parseInt(d[1])<<8|parseInt(d[2])).toString(16)).substr(-6),0)}else o.addColor("#ffffff"===l?"#fefefe":l,0);o.wordWrapWidth=540,h.sceneProxy.addImageFontText([{data:i}],c,u,o,h.sceneProxy.context);var f=o.children[0].extWidth?o.children[0].extWidth:c*i.length,m=(n-f)/2-(o.children[0].extMargin?o.children[0].extMargin:0),p=(a-u)/2;o.children[0].x=m,o.children[0].y=p,o.children[0].text=i,r&&(r.children.forEach(function(e){return e.fontImg.destroy()}),r.destroy()),o.text=" "}},m=function(e,t,o,r){var i=e.getByName("background"),s=e.getByName("button"),l=e.getByName("text"),u=h.game.load.cache.checkImageKey(t)?t:null;if(s)if(l&&o&&(v["default"].fontFamily?f(o,"",n,a,l):(l.font=o.fontFamily||l.font,l.fontSize=o.fontSize||l.fontSize,l.fontWeight=o.fontWeight||l.fontWeight,l.fill=o.color||l.fill),l.visible=!o.hidden),u){var c=1,d=s.width,m=s.height,p=h.game.cache.getImage(u);p.delay?i.key!==u&&h.addGifAnimation(i,u):(c=Math.min(d/p.width,m/p.height),i.loadTexture(u),i.scale.setTo(c,c),i.x=(d-i.width)/2,i.y=(m-i.height)/2)}else r||i.loadTexture(null)},p=this.game.add.group();p.name=u,c&&c.add(p),p.x=e,p.y=t;var y=this.game.load.cache.checkImageKey(o)?o:null,g=this.game.load.cache.checkImageKey(r)?r:null,x=this.game.add.image(0,0,y,null,p);x.name="background";var P=Math.min(n/x.width,a/x.height);x.scale.setTo(P,P),x.x=(n-x.width)/2,x.y=(a-x.height)/2,this.addGifAnimation(x,y);var w=this.game.add.button(0,0,null,i,this,0,0,0,0,p);w.width=n,w.height=a,w.name="button",l&&(this.game.device.desktop?w.setOverSound(l):w.setDownSound(l),this.game.device.desktop?w.onInputOut.add(function(){return l.stop()}):w.onInputUp.add(function(){return l.stop()}));var b=null;if(s){var k={},C="";C+=s.normal.fontWeight?s.normal.fontWeight+" ":"normal ",C+=s.normal.fontSize?parseInt(s.normal.fontSize)+"px ":"",C+=s.normal.fontFamily?s.normal.fontFamily:this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:"",k.font=C,k.fill=s.normal.color,k.stroke=s.normal.stroke,k.strokeThickness=s.normal.stroke?2:0,k.boundsAlignH="center",k.boundsAlignV="middle",b=this.game.add.text(0,0,s.text,k,p),b.name="text",v["default"].fontFamily?f(s.normal,s.text,n,a,b):b.setTextBounds(0,(b.height-parseInt(s.normal.fontSize||12))/2,n,a),s.normal.hidden&&(b.visible=!1)}return w.input.mouseOut=function(){if(null!==this.sprite&&this.sprite.inputEnabled){var e=this._pointerData[0];e.isOver=!1,e.isOut=!0,e.timeOut=this.game.time.time,this.useHandCursor&&e.isDragged===!1&&(this.game.canvas.style.cursor="default",this._setHandCursor=!1),this.sprite&&this.sprite.events&&(this.sprite.events.onInputOut$dispatch(this.sprite,null),this.sprite&&this.sprite.parent&&this.sprite.parent.type===Phaser.GROUP&&this.sprite.parent.onChildInputOut.dispatch(this.sprite,null))}},!d&&w.onInputOver.add(function(){m(p,g,s&&s.normal)}),!d&&w.onInputOut.add(function(){return m(p,y,s&&s.normal)}),!d&&w.onInputDown.add(function(){return m(p,g,s&&s.active)}),!d&&w.onInputUp.add(function(){return m(p,y,s&&s.normal)}),p.changeBackground=function(e,t,n){m(this,e,t,n)},p.button=w,p.text=b,p},addGifAnimation:function(e,t){var n=this.game.cache.getImage(e.key,!0),a=n.data,o=a.frames,r=a.loopCount;if(o){var i=1,s=function(t){if(o[t]&&o[t].blobUrl){var n=new Image;n.onload=function(t){var n=new PIXI.BaseTexture(t.target),a=new PIXI.Texture(n);e&&e.parent&&e.setTexture(a)},n.src=o[t].blobUrl}},l=function u(t){h["default"].timeout(10*o[t].delay).then(function(){if(s(t),t++,t>=o.length){if(r&&i>=r||!e||!e.parent)return;i++,u(0)}else u(t)})};l(0)}},addFitImageSprint:function(e,t,n,a,o,r,i){var s=this.game.load.cache.checkImageKey(o)?o:null,l=this.game.add.sprite(e,t,s);if(s){var u=Math.min(n/l.width,a/l.height);l.pivot.x=l.width/2,l.pivot.y=l.height/2,l.scale.setTo(u,u),l.x+=l.width/2,l.y+=l.height/2}if(i>0){var c=0;for(c=0;c<r.children.length;c++){var d=r.getAt(c);if(-1===d)break;if(d.zIndex===i){r.removeChildAt(c),d.destroy();break}if(d.zIndex>i)break}var h=this.game.add.group();h.add(l),h.zIndex=i,r.add(h,!1,c)}else r.add(l);return l},game:null,onRendered:null,sceneProxy:null},{TEXT_CHANGED:"textChanged"})}),require.register("js/view/mediator/CoverMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i);r["default"].define({name:"diygamePlayer.view.mediator.CoverMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_COVERMENU:this.showCoverLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},addCover:function(){var e=this,t=this.sceneProxy.json_data,n=t.template,a=t.cover,o=n.json.cover,r=o.titleContainer,i=o.startMenu,l=o.loadMenu,u=o.settingsMenu,c=o.overMenu,d=function(t,n,a,o,r,i,l,u){var c={},d="";d+=i.fontWeight?i.fontWeight+" ":"normal ",d+=i.fontSize?parseInt(i.fontSize)+"px ":"",d+=i.fontFamily?i.fontFamily:"",c.font=d,c.fill=i.color,c.stroke=i.stroke,c.strokeThickness=i.stroke?2:0,c.boundsAlignH="center",c.boundsAlignV=u?"bottom":"middle";var h=e.game.add.text(0,0,r,c,e.sceneProxy.coverLayer);if(h.name=l,s["default"].fontFamily){var f=("#ffffff"===i.color?"#fefefe":i.color).replace("#","0x"),m=i.fontSize?parseInt(i.fontSize):25;h.colors.splice(0,h.colors.length),h.text=" ",h.fill=f,h.addColor(f,0),h.x=(960-m*r.length)/2,h.y=n,h.wordWrapWidth=960;var p=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(m):m,y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(m):m;e.sceneProxy.addImageFontText([{data:r}],y,p,h,e.sceneProxy.context)}else h.setTextBounds(t,n+(h.height-parseInt(i.fontSize))/2,a,o);return i.hidden&&(h.visible=!1),h},h=function(t,n,a){var o={};o.normal=t.normal.text,o.active=t.active.text,o.text=a;var r=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,t.normal.background.url,t.active.background.url,f,o,e.sceneProxy.btn_sound,n,e.sceneProxy.coverLayer);r.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})},f=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("cover_button_start"===t.parent.name?e.sceneProxy.onCoverStartBtnClicked():"cover_button_load"===t.parent.name?e.sceneProxy.onCoverLoadBtnClicked():"cover_button_settings"===t.parent.name?e.sceneProxy.onCoverSettingBtnClicked():"cover_button_over"===t.parent.name&&e.sceneProxy.onCoverOverBtnClicked())},m=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.coverLayer);m.beginFill(0),m.moveTo(0,0),m.lineTo(960,0),m.lineTo(960,540),m.lineTo(0,540),m.lineTo(0,0),m.endFill(),m.inputEnabled=!0;var p=a.background.url,y=this.sceneProxy.coverLayer.create(0,0,this.game.load.cache.checkImageKey(p)&&p);if(this.sceneProxy.lstPlotBkKey=a.background.url,this.sceneProxy.lstPlotBkFlex=a.background.flex,this.sceneProxy.lstPlotBkOpacity=a.background.opacity,this.sceneProxy.lstGameBk=this.viewComponent.game.add.sprite(0,0,this.game.load.cache.checkImageKey(p)&&p),y.inputEnabled=!0,3===a.background.flex){var g=y.width/y.height<960/540?960/y.width:540/y.height;y.width*=g,y.height*=g,y.x=-(y.width-960)/2,y.y=-(y.height-540)/2}else if(5===a.background.flex){var v=0;y.width/y.height>960/540?(v=960/y.width,y.width*=v,y.height*=v,y.y=(540-y.height)/2):(v=540/y.height,y.width*=v,y.height*=v,y.x=(960-y.width)/2)}else y.width=960,y.height=540;this.sceneProxy.lstGameBk.x=y.x,this.sceneProxy.lstGameBk.y=y.y,this.sceneProxy.lstGameBk.width=y.width,this.sceneProxy.lstGameBk.height=y.height,a.title.data&&!r.title.text.hidden&&this.viewComponent.addFitImageSprint(r.rect.x,r.rect.y,r.rect.width,r.rect.height,r.background.url,this.sceneProxy.coverLayer);var x=a.title,P=x.font_size,w=x.color,b=x.bold,k=x.fontFamily,C=x.hidden,_=r.title.text;P&&(_.fontSize=P),w&&(_.color=w),void 0!==b&&(_.fontWeight=b?"bold":"normal"),_.fontFamily=this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:k?k:"",void 0!==C&&(_.hidden=C),d(r.title.rect.x+r.rect.x,r.title.rect.y+r.rect.y,r.title.rect.width,r.title.rect.height,a.title.data,_,"cover_text_title",!0),i.hidden||h(i,"cover_button_start",this.sceneProxy.stringMap.startMenu),l.hidden||h(l,"cover_button_load",this.sceneProxy.stringMap.loadMenu),u.hidden||h(u,"cover_button_settings",this.sceneProxy.stringMap.settingsMenu),c.hidden||h(c,"cover_button_over",this.sceneProxy.stringMap.overMenu),this.sceneProxy.coverLayer.visible=!1},showCoverLayer:function(){this.sceneProxy.lstPlotLayer&&this.sceneProxy.lstPlotLayer.destroy(),this.sceneProxy.curPlotLayer&&this.sceneProxy.curPlotLayer.destroy(),this.sceneProxy.dialogLayer.visible=!1,this.sceneProxy.menuLayer.visible=!1,this.sceneProxy.lstGameBk&&(this.sceneProxy.lstGameBk.visible=!0),0===this.sceneProxy.coverLayer.children.length&&this.addCover();var e=this.sceneProxy.json_data.cover,t=e.music,n=e.background;this.sceneProxy.bk_music&&this.sceneProxy.stopMusic(),t&&(this.game.load.cache.checkSoundKey(t.url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&this.sceneProxy.playMusic(t.url,t.volume,!0),this.sceneProxy.lstPlotBkKey=n.url,this.sceneProxy.lstPlotBkOpacity=n.opacity,this.sceneProxy.lstPlotBkFlex=n.flex,this.sceneProxy.coverLayer.visible=!0,this.game.world.bringToTop(this.sceneProxy.coverLayer)}},{NAME:"CoverMediator"})}),require.register("js/view/mediator/EndMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var r=t("puremvc"),i=a(r);i["default"].define({name:"diygamePlayer.view.mediator.EndMediator",parent:i["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_END]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_END:this.showEndLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game},btnStatesChanged:function(e,t,n,a,o,r,i){a&&(a.font=r.fontFamily,a.fontSize=r.fontSize,a.fontWeight=r.fontWeight,a.fill=r.color,a.visible=!r.hidden,void 0!==i&&(a.inputEnabled=i)),this.loadTexture(n,o)},loadTexture:function(e,t){if(e){var n=e.width,a=e.height,o=this.game.load.cache.checkImageKey(t)?t:null;e.loadTexture(o),e.width=n,e.height=a}},addEnd:function(){var e=this,t=function(t,n,o,r,i,s){var l=e.game.load.cache.checkImageKey(o)?o:null,u=e.game.add.button(t,n,l,a,e,0,0,0,0,e.sceneProxy.endLayer);return u.width=r,u.height=i,u.name=s,u},n=function(t,n,a,o,r,i,s){var l={},u="";u+=i.fontWeight?i.fontWeight+" ":"normal ",u+=i.fontSize?parseInt(i.fontSize)+"px ":"",u+=i.fontFamily?i.fontFamily:"",l.font=u,l.fill=i.color,l.boundsAlignH="center",l.boundsAlignV="middle";var c=e.game.add.text(0,0,r,l,e.sceneProxy.endLayer);return c.name=s,c.setTextBounds(t,n+(c.height-parseInt(i.fontSize))/2,a,o),i.hidden&&(c.visible=!1),c},a=function(t,n){if(n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)switch(t.name){case"end_button_get":e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_gte"),"icon_get",s),e.sceneProxy.endLayer.visible=!1,e.sceneProxy.visibleLayout=[e.sceneProxy.endLayer].concat(o(e.sceneProxy.visibleLayout)),e.sceneProxy.showLoad();break;case"end_button_back":e.sceneProxy.reStart(),e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_back"),"icon_back",s),e.sceneProxy.endLayer.visible=!1;break;case"end_button_save":e.btnStatesChanged(null,null,t,e.sceneProxy.endLayer.getByName("end_text_save"),"icon_save",s),e.sceneProxy.showSave()}},r=this.game.add.bitmapData(960,540);r.fill(0,0,0,.8);var i=this.game.add.sprite(0,0,r);i.width=960,i.height=540,i.inputEnabled=!0,this.sceneProxy.endLayer.add(i);var s={fontFamily:"",fontSize:"14px",color:"#ffffff"},l={fontFamily:"",fontSize:"14px",color:"#ef7297"},u=t(168,100,"icon_get",96,96,"end_button_get"),c=n(168,200,96,30,"读取进度",s,"end_text_get");u.onInputOver.add(this.btnStatesChanged,this,0,u,c,"icon_get_hover_pressed",l),u.onInputDown.add(this.btnStatesChanged,this,0,u,c,"icon_get_hover_pressed",l),u.onInputOut.add(this.btnStatesChanged,this,0,u,c,"icon_get",s);var d=t(432,100,"icon_back",96,96,"end_button_back"),h=n(432,200,96,30,"返回封面",s,"end_text_back");d.onInputOver.add(this.btnStatesChanged,this,0,d,h,"icon_back_over_pressed",l),d.onInputDown.add(this.btnStatesChanged,this,0,d,h,"icon_back_over_pressed",l),d.onInputOut.add(this.btnStatesChanged,this,0,d,h,"icon_back",s);var f=t(696,100,"icon_save",96,96,"end_button_save"),m=n(696,200,96,30,"存个档，下次玩",s,"end_text_save");f.onInputOver.add(this.btnStatesChanged,this,0,f,m,"icon_save_over_pressed",l),f.onInputDown.add(this.btnStatesChanged,this,0,f,m,"icon_save_over_pressed",l),f.onInputOut.add(this.btnStatesChanged,this,0,f,m,"icon_save",s),this.sceneProxy.endLayer.visible=!1},showEndLayer:function(){this.sceneProxy.getSnap(),0===this.sceneProxy.endLayer.children.length&&this.addEnd(),this.game.world.bringToTop(this.sceneProxy.endLayer),this.sceneProxy.endLayer.visible=!0}},{NAME:"EndMediator"})}),require.register("js/view/mediator/HtmlTextBox.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e,t,n,a,o,r,i,s,l,u){Phaser.Group.call(this,e),this.game=e,this.name="input",this.parentElement=e.canvas.parentNode,this.textBoxElement=document.createElement("input"),this.textBoxElement.style.position="absolute",this.textBoxElement.style.margin="0",this.textBoxElement.style.border="0",this.textBoxElement.style.padding="0",this.textBoxElement.style.left=t+"px",this.textBoxElement.style.top=n+"px",this.textBoxElement.style.width=a+"px",this.textBoxElement.style.height=o+"px",this.textBoxElement.style.color=i,this.textBoxElement.style.backgroundColor="transparent",this.textBoxElement.style.borderColor="transparent transparent transparent transparent",this.textBoxElement.style.outline="none",this.textBoxElement.style.fontSize=s+"px",this.textBoxElement.style.fontFamily=l,this.textBoxElement.style.fontWeight=u?"bold":"normal",this.parentElement.insertBefore(this.textBoxElement,e.canvas),this._x=t,this._y=n,this._width=a,this._height=o,this._fontSize=s,this.text=r,this.isValue=!1,e.add.existing(this),this.onDestroy.add(function(e){this.parentElement.removeChild(this.textBoxElement)},this)}Object.defineProperty(e,"__esModule",{value:!0}),e.HtmlTextBox=o;var r=t("../../common/Utils.js"),i=a(r);o.prototype=Object.create(Phaser.Group.prototype),o.prototype.constructor=o,o.prototype.update=function(){var e=this.game.canvas,t=e.offsetLeft,n=e.offsetTop,a=e.offsetWidth,o=e.offsetHeight;if(this.oldCanvasWidth!=a||this.oldCanvasHeight!=o||this.oldCanvasX!=t||this.oldCanvasY!=n){var r=this.game.world.width,i=this.game.world.height;if(e.offsetWidth>e.offsetHeight){var s=a/r,l=o/i,u=this._x/r,c=this._y/i,d=t+a*u,h=n+o*c,f=this._width*s,m=this._height*l,p=this._fontSize*l;this.setLeft(d),this.setTop(h),this.setWidth(f),this.setHeight(m),this.setFontSize(p),this.textBoxElement.style.transform="rotate(0deg)"}else{var y=o/r,g=a/i,v=this._x/r,x=this._y/i,P=t+a-a*x,w=n+o*v,b=this._width*y,k=this._height*g,C=this._fontSize*g;this.setLeft(P-b/2-k/2),this.setTop(w+b/2-k/2),this.setWidth(b),this.setHeight(k),this.setFontSize(C),this.textBoxElement.style.transform="rotate(90deg)"}this.oldCanvasWidth=a,this.oldCanvasHeight=o,this.oldCanvasX=t,this.oldCanvasY=n}},o.prototype.destroy=function(){this.parentElement.removeChild(this.textBoxElement)},o.prototype.show=function(e){this.textBoxElement.style.visibility=e?"visible":"hidden"},o.prototype.setInputCallback=function(e){var t=this,n=function(){t._text=t.textBoxElement.value,i["default"].sensitiveWords.forEach(function(e){if(0!==e.length){var n=t._text.indexOf(e);if(n!==-1){var a="*".repeat(e.length);t._text=t._text.replace(new RegExp(e,"gi"),a),t.textBoxElement.value=t._text}}}),e(t._text)};if("ios"===flashvars.client||navigator.userAgent.indexOf("iPhone")>-1){var a=navigator.userAgent.match(/CPU\siPhone\sOS\s((([0-9]*)+(_))*)+([0-9]*)/gi);a&&(a[0]>="CPU iPhone OS 10_3_1"||"CPU iPhone OS 10_0_2"===a[0])?this.textBoxElement.addEventListener("input",n,!1):this.textBoxElement.addEventListener("compositionend",function(){t.textBoxElement.removeEventListener("input",n,!1),t.textBoxElement.addEventListener("input",n,!1)},!1)}else this.textBoxElement.addEventListener("input",n,!1);this.textBoxElement.onblur=function(){if(t.isValue){var e=parseFloat(t._text);e?t.text=e+"":t.text="0"}}},o.prototype.setClickCallback=function(e){var t=this;this.textBoxElement.addEventListener("click",function(){e(t)},!1)},o.prototype.setLeft=function(e){this.textBoxElement.style.left=e+"px"},o.prototype.setTop=function(e){this.textBoxElement.style.top=e+"px"},o.prototype.setWidth=function(e){this.textBoxElement.style.width=e+"px"},o.prototype.setHeight=function(e){this.textBoxElement.style.height=e+"px"},o.prototype.setFontSize=function(e){this.textBoxElement.style.fontSize=e+"px"},o.prototype.setEnable=function(e){this.textBoxElement.readOnly=(!!e).toString()},Object.defineProperty(o.prototype,"x",{get:function(){return this._x},set:function(e){this.setLeft(e),this._x=e}}),Object.defineProperty(o.prototype,"y",{get:function(){return this._y},set:function(e){this.setTop(e),this._y=e}}),Object.defineProperty(o.prototype,"width",{get:function(){return this._width},set:function(e){this.setWidth(e),this._width=e}}),Object.defineProperty(o.prototype,"height",{get:function(){return this._height},set:function(e){this.setHeight(e),this._height=e}}),Object.defineProperty(o.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){this.setFontSize(e),this._fontSize=e}}),Object.defineProperty(o.prototype,"style",{get:function(){return this._style},set:function(e){for(var t in e)this.textBoxElement.style[t]=e[t];this._style=e}}),Object.defineProperty(o.prototype,"text",{get:function(){return this._text},set:function(e){this.textBoxElement.value=e,this._text=e}}),Object.defineProperty(o.prototype,"readOnly",{get:function(){return this.readOnly},set:function(e){this.setEnable(e),this.textBoxElement.readOnly=(!!e).toString()}})}),require.register("js/view/mediator/MainMenuMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i);r["default"].define({name:"diygamePlayer.view.mediator.MainMenuMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU]},handleNotification:function(e){var t=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_MAINMENU:this.showMainMenuLayer(t)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME),this.sceneMediator=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME),this.game=this.sceneMediator.viewComponent&&this.sceneMediator.viewComponent.game,this.viewComponent=this.sceneMediator.viewComponent},addMainMenu:function(){var e=this,t=this.sceneProxy.json_data.template.json.mainMenu,n=t.background,a=t.header,o=t.save,r=t.load,i=t.playback,l=t.settings,u=t.autoplay,c=t.back,d=function(t,n,a,o,r,i,s){var l=t.fontSize?parseInt(t.fontSize):25,u=t.color?t.color:"#fefefe",c=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(l):l,d=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(l):l,h=d*i.length,f=n+(o-h)/2,m=a+(r-c)/2,p=e.sceneProxy.addRetroText(f,m,h,c,i);p.tint=("#ffffff"===u?"#fefefe":u).replace("#","0x"),s.addChild(p),s.text=" "},h=function(t,n,a,o,r,i,l){var u={},c="";c+=i.fontWeight?i.fontWeight+" ":"normal ",c+=i.fontSize?parseInt(i.fontSize)+"px ":"",c+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",u.font=c,u.fill=i.color,u.boundsAlignH="center",u.boundsAlignV="middle",u.stroke=i.stroke,u.strokeThickness=i.stroke?2:0;var h=e.game.add.text(0,0,r,u,e.sceneProxy.mainMenuLayer);return h.name=l,s["default"].fontFamily?d(i,t,n,a,o,r,h):h.setTextBounds(t,n+(h.height-parseInt(i.fontSize))/2,a,o),i.hidden&&(h.visible=!1),h},f=function(t,n,a){var o={};o.normal=t.normal.text,o.active=t.active.text,o.text=a;var r=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,t.normal.background.url,t.active.background.url,m,o,e.sceneProxy.btn_sound,n,e.sceneProxy.mainMenuLayer);r.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})},m=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("mainMenu_button_save"===t.parent.name?e.sceneProxy.onMainMenuSaveBtnClicked():"mainMenu_button_load"===t.parent.name?e.sceneProxy.onMainMenuLoadBtnClicked():"mainMenu_button_playback"===t.parent.name?e.sceneProxy.onMainMenuPlaybackBtnClicked():"mainMenu_button_autoplay"===t.parent.name?e.sceneProxy.onMainMenuAutoplayBtnClicked():"mainMenu_button_settings"===t.parent.name?e.sceneProxy.onMainMenuSettingsBtnClicked():"mainMenu_button_back"===t.parent.name&&e.sceneProxy.onMainMenuBackBtnClicked())},p=this.game.add.image(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);if(p.width=this.game.world.width,p.height=this.game.world.height,p.inputEnabled=!0,this.sceneProxy.mainMenuLayer.add(p),this.game.load.cache.checkImageKey(a.background.url)){var y=this.sceneProxy.mainMenuLayer.create(a.rect.x,a.rect.y,a.background.url);y.width=a.rect.width,y.height=a.rect.height}a.title.text.hidden||h(a.title.rect.x+a.rect.x,a.title.rect.y+a.rect.y,a.title.rect.width,a.title.rect.height,this.sceneProxy.stringMap.mainMenu,a.title.text,"mainMenu_text_header"),o.hidden||f(o,"mainMenu_button_save",this.sceneProxy.stringMap.save),r.hidden||f(r,"mainMenu_button_load",this.sceneProxy.stringMap.load),i.hidden||f(i,"mainMenu_button_playback",this.sceneProxy.stringMap.playback),u.hidden||f(u,"mainMenu_button_autoplay",this.sceneProxy.stringMap.autoplay),l.hidden||f(l,"mainMenu_button_settings",this.sceneProxy.stringMap.settings),c.hidden||f(c,"mainMenu_button_back",this.sceneProxy.stringMap.back),this.sceneProxy.mainMenuLayer.visible=!1},showMainMenuLayer:function(e){var t=this;if(0===this.sceneProxy.mainMenuLayer.children.length)if(this.sceneProxy.json_data.default_settings.mainMenu){var n=this.sceneProxy.json_data.default_settings.mainMenu,a=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.mainMenuLayer);a.beginFill(0,0),a.drawRect(0,0,this.viewComponent.game.world.width,this.viewComponent.game.world.height),a.endFill(),a.inputEnabled=!0,this.sceneMediator.registerViewKey(n.ref,n.events,this.sceneProxy.plotViewKeys);var o=this.sceneMediator.addView(this.sceneProxy.mainMenuLayer,n.ref,n.instanceUuid,n.x,n.y,n.events);o.isMenu=!0;var r=function(){var e=function n(e){"TIMER"===e.viewType&&(t.sceneProxy.menuTimer[t.sceneProxy.menuTimer.length]=e.name),e.children.forEach(function(e){n(e)})};o.children.forEach(function(t){e(t)})};r(),this.sceneMediator.uiOnLoadInvoker()}else this.addMainMenu();var i=this.sceneProxy.mainMenuLayer.getByName("mainMenu_button_autoplay"),l=i?i.getByName("text"):void 0;if(e.auto){if(l)if(s["default"].fontFamily){var u=l.children[0];if(u){var c=this.sceneProxy.json_data.template.json.mainMenu.autoplay,d=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(c.normal.text.fontSize):c.normal.text.fontSize,h=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(c.normal.text.fontSize):c.normal.text.fontSize,f=h*this.sceneProxy.stringMap.manualPlay.length,m=(c.rect.width-f)/2,p=(c.rect.height-d)/2;this.sceneProxy.addImageFontText([{data:this.sceneProxy.stringMap.manualPlay}],h,d,l,e),l.children[0].x=m,l.children[0].y=p,u.children.forEach(function(e){return e.fontImg.destroy()}),u.destroy(),l.text=" "}}else l.text=this.sceneProxy.stringMap.manualPlay}else if(l)if(s["default"].fontFamily){var y=l.children[0];if(y){var g=this.sceneProxy.json_data.template.json.mainMenu.autoplay,v=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(g.normal.text.fontSize):g.normal.text.fontSize,x=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(g.normal.text.fontSize):g.normal.text.fontSize,P=x*this.sceneProxy.stringMap.autoplay.length,w=(g.rect.width-P)/2,b=(g.rect.height-v)/2;this.sceneProxy.addImageFontText([{data:this.sceneProxy.stringMap.autoplay}],x,v,l,e),l.children[0].x=w,l.children[0].y=b,y.children.forEach(function(e){return e.fontImg.destroy()}),y.destroy(),l.text=" "}}else l.text=this.sceneProxy.stringMap.autoplay;this.game.world.bringToTop(this.sceneProxy.mainMenuLayer),this.sceneProxy.mainMenuLayer.visible=!0}},{NAME:"MainMenuMediator"})}),require.register("js/view/mediator/PlaybackMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/RePhaser.js"),s=a(i),l=t("../../common/FontUtils.js");a(l);r["default"].define({name:"diygamePlayer.view.mediator.PlaybackMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK,diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT]},handleNotification:function(e){switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_PLAYBACK:this.callbackInfo=e.getBody(),this.showPlaybackLayer();
break;case diygamePlayer.AppConstants.ADD_PLAYBACK_CONTENT:var t=e.getBody();this.addPlaybackContent(t)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},addTextContent:function(e,t,n,a,o,r){var i={boundsAlignH:"center",boundsAlignV:"middle",wordWrap:!0},s="";s+=r.fontWeight?r.fontWeight+" ":"normal ",s+=r.fontSize?parseInt(r.fontSize)+"px ":"",s+=r.fontFamily?r.fontFamily:"黑体",i.font=s,i.fill=r.color,i.wordWrapWidth=n,this.sceneProxy.stringMap.back===o?(i.boundsAlignH="center",i.boundsAlignV="middle"):(i.boundsAlignH="left",i.boundsAlignV="top");var l=this.game.add.text(0,0,o,i,this.sceneProxy.playBackLayer);return l.setTextBounds(e,t+(l.height-parseInt(r.fontSize||12))/2,n,a),l},addPlayback:function(){var e=this,t=this.sceneProxy.json_data.template.json.playback,n=t.scrollBox,a=t.back,o=t.background,r=this.sceneProxy.playBackLayer.create(0,0,this.game.load.cache.checkImageKey(o.url)&&o.url);r.width=this.game.world.width,r.height=this.game.world.height,r.inputEnabled=!0;var i=n.rect.x,s=n.rect.y,l=n.rect.width,u=n.rect.height,c=Object.assign({x:0,y:0,width:l,height:u},n.background.rect),d=this.sceneProxy.playBackLayer.create(i+c.x,s+c.y,this.game.load.cache.checkImageKey(n.background.url)&&n.background.url);d.width=c.width,d.height=c.height;var h=this.game.add.sprite(0,0);h.x=i,h.y=s,h.name="scrollPane",this.sceneProxy.playBackLayer.add(h);var f=(n.item.rect.width,n.item.rect.height),m=Math.max(f-n.item.content.rect.height,0),p=0,y=null,g=!1,v=function(e,t,n){var a=w(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?g||(document.addEventListener(o,k),g=!0):g&&(document.removeEventListener(o,k),g=!1)},x=function(e,t){var n=h.children.length*f-m;return n<u?void(h.y=s):(e!==i&&(h.x=i),void(t>s?h.y=s:t+n<s+u?h.y=s+u-n:h.y=t))},P=function(e,t,n,a,o,r){var i=n,s=a;r&&(p=n),y=h.y,document.body.clientWidth<document.body.clientHeight&&null!==y&&(s=y-n+p),x(i,s)},w=function(e){var t=void 0,n=void 0;return document.body.clientWidth>document.body.clientHeight?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),n<s||n>s+u||t<i||t>i+l?null:{x:t,y:n}},b=function(e,t,n,a){return w(t)?e.input.enableDrag():e.input.disableDrag()},k=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;x(0,h.y+100*t)};h.inputEnabled=!0,h.input.enableDrag(),h.input.allowHorizontalDrag=!1,h.events.onDragUpdate.add(P,this),h.events.onInputDown.add(b,this),this.game.input.addMoveCallback(v,this);var C=this.game.add.graphics(0,0);C.beginFill(16777215),C.drawRect(i,s,l,u),this.sceneProxy.playBackLayer.add(C),h.mask=C;var _=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||(e.sceneProxy.onPlaybackBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null))};if(!a.hidden){var S={};S.normal=a.normal.text,S.active=a.active.text,S.text=this.sceneProxy.stringMap.back;var I=this.viewComponent.addButton(a.rect.x,a.rect.y,a.rect.width,a.rect.height,a.normal.background.url,a.active.background.url,_,S,this.sceneProxy.btn_sound,"playBack_button_back",this.sceneProxy.playBackLayer);I.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}this.sceneProxy.playBackLayer.visible=!1},addPlaybackContent:function(e){this.sceneProxy.playbackData.push(e),this.sceneProxy.playbackData.length>100&&this.sceneProxy.playbackData.splice(0,1)},addPlaybackItem:function(e){var t=this.sceneProxy.playBackLayer.getByName("scrollPane"),n=this.sceneProxy.json_data.template.json.playback.scrollBox,a=this.game.load.cache.checkImageKey(n.item.background.url)?n.item.background.url:null,o=this.game.load.cache.checkImageKey(n.item.content.background.url)?n.item.content.background.url:null,r=n.item.rect.x+n.item.content.rect.x,i=n.item.rect.y+n.item.content.rect.y,l=this.game.add.group();l.x=n.item.rect.x,l.y=n.item.rect.y+n.item.rect.height*t.children.length;var u=this.game.add.sprite(0,0,a);u.width=n.item.rect.width,u.height=n.item.rect.height;var c=this.game.add.sprite(r,i,o);c.width=n.item.content.rect.width,c.height=n.item.content.rect.height;var d=this.addTextContent(r+10,i,n.item.content.rect.width-10,n.item.content.rect.height,"",n.item.content.text);d.useAdvancedWrap=!0,d.updateText=s["default"].updateText,d.advancedWordWrap=s["default"].advancedWordWrap,d.lineSpacing=-parseInt(n.item.content.text.fontSize||12)/5,d.text=e,d.name="text";var h=this.game.add.graphics(0,0);h.beginFill(16777215),h.drawRect(r,i,c.width,c.height),d.mask=h,l.addChild(h),l.add(u),l.add(c),l.add(d),t.addChild(l)},showPlaybackLayer:function(){var e=this;this.sceneProxy.playBackLayer.removeAll(!0),this.addPlayback(),this.sceneProxy.playbackData.forEach(function(t){e.addPlaybackItem(t)}),this.game.world.bringToTop(this.sceneProxy.playBackLayer),this.sceneProxy.playBackLayer.visible=!0;var t=this.sceneProxy.json_data.template.json.playback.scrollBox,n=t.rect,a=t.item,o=this.sceneProxy.playBackLayer.getByName("scrollPane"),r=Math.max(a.rect.height-a.content.rect.height,0),i=o.children.length*a.rect.height-r,s=n.y+a.rect.y;i<n.height?o.y=s:o.y=s-i+n.height}},{NAME:"PlaybackMediator"})}),require.register("js/view/mediator/RecordMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("spark-md5"),s=a(i),l=t("./../../common/Dialog.js"),u=a(l),c=t("./../../common/Utils.js"),d=a(c),h=t("../../common/FontUtils.js"),f=a(h);r["default"].define({name:"diygamePlayer.view.mediator.RecordMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_RECORD]},handleNotification:function(e){var t=e.getBody();switch(this.callbackInfo=t?t:this.sceneProxy.recordLayer?this.callbackInfo:null,e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_RECORD:this.showRecordLayer()}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent,this.localMode=!0,this.isChangeClick=!1},onLocalBtnClicked:function(){if(!this.localMode){this.localMode=!0,this.isChangeClick=!0;var e=this.sceneProxy.recordLayer.getByName("local_btn"),t=this.sceneProxy.recordLayer.getByName("cloud_btn");e.changeBackground("local_hover"),t.changeBackground("cloud"),this.sceneProxy.onRecordLocalBtnClicked()}},onCloudBtnClicked:function(e){var t=this;this.localMode&&this.sceneProxy.isSignedIn().then(function(){if(!t.sceneProxy.isWap3000())return t.updateItems(),t.game.world.bringToTop(t.sceneProxy.recordLayer),void(t.sceneProxy.recordLayer.visible=!0);t.localMode=!1,t.isChangeClick=!0;var e=t.sceneProxy.recordLayer.getByName("local_btn"),n=t.sceneProxy.recordLayer.getByName("cloud_btn");e.changeBackground("local"),n.changeBackground("cloud_hover"),t.sceneProxy.onRecordCloudBtnClicked()},function(n){if(e===!0)return t.updateItems(),t.game.world.bringToTop(t.sceneProxy.recordLayer),t.sceneProxy.isShowGuide===!0&&t.sceneProxy.recordLayer.visible!==!0&&t.sceneProxy.isWap3000()&&t.sceneProxy.showGuideTip(1),void(t.sceneProxy.recordLayer.visible=!0);var a=n.indexOf("- status:-1");a=a>=0?a:n.indexOf("- status:2"),a>=0?(t.sceneProxy.context.fullScreen&&t.sceneProxy.onSettingsWindowModeBtnClicked(),flashvars.app_version>="1.2.0"&&(window.location.href="lzj3000://logout"),u["default"].error(n.substr(0,a)).then(function(){window.location.href="lzj3000://login"})):0<=n.indexOf("error")&&(t.sceneProxy.context.fullScreen&&t.sceneProxy.onSettingsWindowModeBtnClicked(),u["default"].error("网络异常，请检查您的网络！"))})},addRecord:function(){var e=this,t=this.sceneProxy.json_data.template.json.record,n=t.background,a=t.scrollBox,o=t.back,r=a.rect,i=a.item,s=a.itemsOffsetX,l=a.itemsOffsetY,u=a.itemSpaceX,c=a.itemSpaceY,d=i.rect,h=i.hint,m=i.content,p=h.rect,y=h.text,g=m.rect,v=r.x,x=r.y,P=r.width,w=r.height,b=d.x,k=d.y,C=d.width,_=d.height,S=p.x,I=p.y,E=p.width,L=p.height,T=g.x,M=g.y,A=g.width,O=g.height;u=void 0===u?20:u,c=void 0===c?12:c,s=void 0===s?0:s,l=void 0===l?0:l;var V={boundsAlignH:"center",boundsAlignV:"middle"},N=function(t,n,a,o,r,i){var s=void 0,l="";if(l+=i.fontWeight?i.fontWeight+" ":"normal ",l+=i.fontSize?parseInt(i.fontSize)+"px ":"",l+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",V.font=l,V.fill=i.color,s=e.game.add.text(0,0,r,V,e.sceneProxy.recordLayer),f["default"].fontFamily){var u=(i.color?i.color:e.json_data.default_settings.color).replace("#","0x");if(u.indexOf("rgb")!==-1){var c=u.replace("rgb(","").replace(")","").split(",");s.addColor("#"+("00000"+(parseInt(c[0])<<16|parseInt(c[1])<<8|parseInt(c[2])).toString(16)).substr(-6),0)}else s.addColor(u,0);var d=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(s.fontSize):s.fontSize;s.x=t+(a-196*d/25-21-22*d/25)/2,s.y=n+(s.height-parseInt(s.fontSize))/2,s.wordWrapWidth=260*d/25}else s.setTextBounds(t,n+(s.height-parseInt(i.fontSize))/2,a,o);return s},B=this.sceneProxy.recordLayer.create(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);B.width=this.game.world.width,B.height=this.game.world.height,B.inputEnabled=!0;var R=this.game.add.sprite(0,0),j=Object.assign({x:0,y:0,width:P,height:w},n.rect),D=this.sceneProxy.recordLayer.create(v+j.x,x+j.y,this.game.load.cache.checkImageKey(a.background.url)&&a.background.url);D.width=j.width,D.height=j.height;var U=v+s,F=x+l;R.x=U,R.y=F,R.name="scrollPane",this.sceneProxy.recordLayer.add(R);var G=3,z=4,W=0,H=0,K=void 0,J={x:0,y:0},q=this.game.add.sprite(0,0);q.width=(C+u)*z,q.height=(_+c)*G,R.addChild(q);var Y=0,X=null,$=function(e,t){var n=_*G+c*(G-1);t>F||n<=w?R.y=F:t+n<x+w?R.y=x+w-(_*G+c*(G-1)):R.y=t},Q=function(e,t,n,a,o,r){var i=n,s=a;document.body.clientWidth<document.body.clientHeight&&null!==X&&(s=X-n+Y),$(i,s)},Z=function(e,t,n,a,o,r){Y=n,X=R.y},ee=function(e,t,n,a,o,r){X=R.y},te=function(e){var t=void 0,n=void 0;return document.body.clientWidth>document.body.clientHeight?(t=e.worldX,n=e.worldY):(t=e.worldY,n=-e.worldX),n<F||n>F+w||t<U||t>U+P?null:{x:t,y:n}},ne=function(e,t,n,a){return te(t)?e.input.enableDrag():e.input.disableDrag()},ae=function(t,n){var a=te(n);if(a&&(n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)){J.x=0,J.y=0;var o=a.x-R.x,r=a.y-R.y,i=C+u,s=_+c;if(o%i<C&&r%s<_){var l=Math.floor(o/i),d=Math.floor(r/s);e.sceneProxy.onRecordItemClicked(l,d),e.sceneProxy.bToSaveFile||(e.callbackInfo=null)}}},oe=function(e){var t=e.wheelDelta?e.wheelDelta/120:-e.detail/3;$(0,R.y+100*t)},re=!1,ie=function(e,t,n){var a=te(e),o=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a?re||(document.addEventListener(o,oe),re=!0):re&&(document.removeEventListener(o,oe),re=!1)};K=this.game.load.cache.checkImageKey(i.background.url)?i.background.url:null;for(var se=0;se<G;se++)for(var le=0;le<z;le++){var ue=this.game.add.group();ue.x=le*(C+u)+b,ue.y=se*(_+c)+k,ue.name="recordItem_"+(4*se+le);var ce=this.game.add.sprite(W,H,K);ce.width=C,ce.height=_;var de=this.sceneProxy.recordLayer.create(T,M,this.game.load.cache.checkImageKey(m.background.url)&&m.background.url);de.name="content",de.width=A,de.height=O;var he=N(S,I,E,L,"",y);he.name="textTime";var fe=this.game.add.graphics(0,0);if(fe.beginFill(),fe.drawRect(0,0,C,_),fe.endFill(),ue.addChild(fe),ue.mask=fe,ue.add(ce),ue.add(de),ue.add(he),this.sceneProxy.json_data.default_settings.autoSaveOrLoad&&0===se&&0===le){var me=this.game.add.bitmapData(C,_);me.fill(0,0,0,.4);var pe=this.game.add.sprite(0,0,me);pe.width=C,pe.height=_;var ye={font:"16px Microsoft YaHei",fill:"white",boundsAlignH:"center",boundsAlignV:"middle"},ge=this.game.add.text(0,0,"自动存档",ye,this.sceneProxy.coverLayer);ge.setTextBounds(0,(ge.height-16)/2,C,_),ue.add(pe),ue.add(ge)}R.addChild(ue)}R.inputEnabled=!0,R.input.enableDrag(),R.input.allowHorizontalDrag=!1,R.events.onDragUpdate.add(Q,this),R.events.onDragStart.add(Z,this),R.events.onDragStop.add(ee,this),R.events.onInputUp.add(ae,this),R.events.onInputDown.add(ne,this),this.game.input.addMoveCallback(ie,this);var ve=this.game.add.graphics(0,0);ve.beginFill(),ve.drawRect(R.x,R.y,P-s,w-l),ve.endFill(),this.sceneProxy.recordLayer.add(ve),R.mask=ve;var xe={};xe.normal=o.normal.text,xe.active=o.active.text,xe.text=this.sceneProxy.stringMap.back;var Pe=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("record_button_back"===t.parent.name?(e.sceneProxy.onRecordBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null)):"local_btn"===t.parent.name?e.onLocalBtnClicked():"cloud_btn"===t.parent.name&&e.onCloudBtnClicked())};if(!o.hidden){var we=this.viewComponent.addButton(o.rect.x,o.rect.y,o.rect.width,o.rect.height,o.normal.background.url,o.active.background.url,Pe,xe,this.sceneProxy.btn_sound,"record_button_back",this.sceneProxy.recordLayer);we.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}this.sceneProxy.recordLayer.visible=!1},updateItems:function(){var e=this;this.sceneProxy.savedPlotsData.forEach(function(t,n){var a=function(t){var n=e.game.load.cache.checkImageKey(t)?t:null,a=l.getByName("content"),o=a.width,r=a.height;a.loadTexture(n),a.width=o,a.height=r},o=t?t:{},r=o.timestamp,i=o.plotSnap,l=e.sceneProxy.recordLayer.getByName("scrollPane").children.find(function(e){return e.name==="recordItem_"+n});if(l){if(!r)return a(e.sceneProxy.json_data.template.json.record.scrollBox.item.content.background.url),void(l.getByName("textTime").text="");var u=l.getByName("textTime"),c=s["default"].hash(i);if(e.game.load.cache.checkImageKey(c))a(c);else{var h=new Image;h.src=i,h.onload=function(t){e.game.load.cache.checkImageKey(c)||e.game.cache.addImage(c,i,t.target),a(c)}}var m=d["default"].getCurrentDateTime(r);if(f["default"].fontFamily){var p=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(u.fontSize):u.fontSize,y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(u.fontSize):u.fontSize;e.sceneProxy.addImageFontText([{data:m}],y,p,u,e.sceneProxy.context),u.text=" "}else u.text=m}})},showRecordLayer:function(){0===this.sceneProxy.recordLayer.children.length&&this.addRecord(),this.updateItems(),this.game.world.bringToTop(this.sceneProxy.recordLayer),this.sceneProxy.recordLayer.visible=!0}},{NAME:"RecordMediator",localMode:!0,isChangeClick:!1})}),require.register("js/view/mediator/SceneMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t("./CoverMediator.js"),t("./MainMenuMediator.js"),t("./SettingsMediator.js"),t("./PlaybackMediator.js"),t("./RecordMediator.js"),t("./EndMediator.js");var s=t("./HtmlTextBox.js"),l=o(s),u=t("./../../common/Dialog.js"),c=a(u),d=t("../../common/RePhaser.js"),h=a(d),f=t("../../common/Utils.js"),m=a(f),p=t("../../common/PhoneUtils.js"),y=a(p),g=t("../../common/FontUtils.js"),v=a(g),x=t("puremvc"),P=a(x);P["default"].define({name:"diygamePlayer.view.mediator.SceneMediator",parent:P["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_SHOW_AD,diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN,diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS,diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE,diygamePlayer.AppConstants.SCENE_LOADING_BEGIN,diygamePlayer.AppConstants.SCENE_LOADING_PROGRESS,diygamePlayer.AppConstants.SCENE_LOADING_COMPLETE,diygamePlayer.AppConstants.SCENE_SHOW_LOGO,diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY,diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED,diygamePlayer.AppConstants.SCENE_DESTROY_VIEW,diygamePlayer.AppConstants.SCENE_SHOW_GUIDE,diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW]},handleNotification:function(e){var t=this,n=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_SHOW_AD:break;case diygamePlayer.AppConstants.SCENE_PRELOADING_BEGIN:this.sceneProxy.viewComponent=this.viewComponent,this.sceneProxy.space_key=this.viewComponent.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);var a=this.viewComponent.game.input.keyboard.addKey(Phaser.Keyboard.Z);a.onDown.add(function(){return t.sceneProxy.quickPlay=!0}),a.onUp.add(function(){return t.sceneProxy.quickPlay=!1}),this.viewComponent.game.input.onHold.add(function(){t.screenCaptured()}),this.viewComponent.game.input.onUp.add(function(){t.screenReleased()}),this.generateLayers(),this.viewComponent.game.load.crossOrigin="anonymous",this.viewComponent.preLoad().then(function(){return t.addToastLayer(),t.addLoadingToastLayer(),t.viewComponent.getGameJson()}).then(function(e){return 0===Object.keys(e).length?Promise.reject("链接已过期"):(t.viewComponent.addLog("解析剧情配置..."),t.viewComponent.showOfflineBg(),t.sceneProxy.parseJsonFile(e).then(function(){return t.viewComponent.addLog("解析剧情配置..【成功】",!0),new Promise(function(e,n){var a=t.viewComponent.game.world.getByName("offlinebg");if(!a||"Operation_tip"!==a.key)return e();var o=function r(t,n){if(!n||n.pointerMode!==Phaser.PointerMode.CURSOR||0===n.button)return a.events.onInputDown.remove(r),m["default"].localStorageSetItem("shanyi3000opg","showed"),e()};t.viewComponent.game.cache.checkImageKey("Continue")&&(t.viewComponent.game.add.image(409,508,"Continue").name="Continue"),a.events.onInputDown.addOnce(o)})},function(e){return t.viewComponent.addLog("剧情配置解析错误:"+e),Promise.reject(e||"解析Json错误")}))}).then(function(){t.sceneProxy.updateAccInfo(!1,!0)},function(e){return Promise.reject(e)}).then(function(){return null},function(e){flashvars.client&&""!==flashvars.client?c["default"].warn(e+"关闭播放器吗？").then(function(){window.location.href="lzj3000://quit"},function(){return null}):c["default"].warn(e+"，返回闪艺首页吗？").then(function(){return window.location.href="http:\\\\www.3000.com"},function(){return null})});break;case diygamePlayer.AppConstants.SCENE_PRELOADING_PROGRESS:this.assetsLoaderStart(diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE);break;case diygamePlayer.AppConstants.SCENE_PRELOADING_COMPLETE:this.viewComponent.destroyLogo();var o=this.sceneProxy.json_data;this.sceneProxy.initContext();var r=this.sceneProxy.json_data.template.json.sound,i=this.viewComponent.game.world.getByName("offlinebg"),s=this.viewComponent.game.world.getByName("Continue");if(i&&i.destroy(),s&&s.destroy(),this.viewComponent.game.load.cache.checkSoundKey(r.url)&&(this.sceneProxy.btn_sound=this.viewComponent.game.add.sound(r.url,r.volume)),o.logo&&!o.logo.background.hidden)this.sceneProxy.showLogo();else if(o.cover.hidden){var l=this.sceneProxy.findFirstChapter(),u=l.downloadUuid?l.downloadUuid:l.uuid;if(l.md5&&0===l.plots.length)if(!l.charge||"android"!==flashvars.client&&"ios"!==flashvars.client)this.sceneProxy.checkIfChapterFree(u,l.md5).then(function(e){l.plots=e,t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,l)},function(e){-1===e.indexOf("code=87")?c["default"].error(e):c["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var d=function(e){e?t.sceneProxy.checkIfChapterFree(u,l.md5).then(function(e){t.sceneProxy.unlockChapterCallBack=null,l.plots=e,t.sceneProxy.preloadChapterAssets(t.sceneProxy.context,l)},function(){return c["default"].error("获取付费章节信息失败")}):c["default"].error("章节解锁失败")};this.sceneProxy.unlockChapter(u,l.charge,l.md5,d)}else this.sceneProxy.preloadChapterAssets(this.sceneProxy.context,l)}else this.sceneProxy.showCover();break;case diygamePlayer.AppConstants.SCENE_LOADING_BEGIN:break;case diygamePlayer.AppConstants.SCENE_LOADING_PROGRESS:break;case diygamePlayer.AppConstants.SCENE_LOADING_COMPLETE:break;case diygamePlayer.AppConstants.SCENE_SHOW_LOGO:this.showLogo();break;case diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_READY:this.assetsLoaderStart(diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED,n);break;case diygamePlayer.AppConstants.SCENE_PLOT_LOAD_ASSETS_LOADED:this.showPlot(n.context,this.sceneProxy.curChapter,this.sceneProxy.curPlotIndex,this.sceneProxy.cmdPlotSnap,n.loadData);break;case diygamePlayer.AppConstants.SCENE_DESTROY_VIEW:this.destroyView(n);break;case diygamePlayer.AppConstants.SCENE_SHOW_GUIDE:this.showGuideTip(n.id);break;case diygamePlayer.AppConstants.SCENE_SHOW_INPUT_VIEW:this.showInputView(this.sceneProxy.plotViewsLayer,!!n)}},generateLayers:function(){this.sceneProxy.coverLayer=this.viewComponent.game.add.group(),this.sceneProxy.coverLayer.name="coverLayer",this.sceneProxy.progressLayer=this.viewComponent.game.add.group(),this.sceneProxy.progressLayer.name="progressLayer",this.sceneProxy.dialogLayer=this.viewComponent.game.add.group(),this.sceneProxy.dialogLayer.name="dialogLayer",this.sceneProxy.dialogLayer.animateTweens=[],this.sceneProxy.menuLayer=this.viewComponent.game.add.group(),this.sceneProxy.menuLayer.name="menuLayer",this.sceneProxy.mainMenuLayer=this.viewComponent.game.add.group(),this.sceneProxy.mainMenuLayer.name="mainMenuLayer",this.sceneProxy.mainMenuLayer.visible=!1,this.sceneProxy.settingsLayer=this.viewComponent.game.add.group(),this.sceneProxy.settingsLayer.name="settingsLayer",this.sceneProxy.settingsLayer.visible=!1,this.sceneProxy.recordLayer=this.viewComponent.game.add.group(),this.sceneProxy.recordLayer.name="recordLayer",this.sceneProxy.recordLayer.visible=!1,this.sceneProxy.playBackLayer=this.viewComponent.game.add.group(),this.sceneProxy.playBackLayer.name="playBackLayer",this.sceneProxy.playBackLayer.visible=!1,this.sceneProxy.weatherLayer=this.viewComponent.game.add.group(),this.sceneProxy.weatherLayer.name="weatherLayer",this.sceneProxy.plotViewsLayer=this.viewComponent.game.add.group(),this.sceneProxy.plotViewsLayer.name="plotViewsLayer",this.sceneProxy.endLayer=this.viewComponent.game.add.group(),this.sceneProxy.endLayer.name="endLayer",this.sceneProxy.toastLayer=this.viewComponent.game.add.group(),this.sceneProxy.toastLayer.name="toastLayer",this.sceneProxy.loadingToastLayer=this.viewComponent.game.add.group(),this.sceneProxy.loadingToastLayer.name="loadToastLayer",this.sceneProxy.quickPlayLayer=this.viewComponent.game.add.group(),this.sceneProxy.quickPlayLayer.name="quickPlayLayer",this.sceneProxy.guideLayer=this.viewComponent.game.add.group(),this.sceneProxy.guideLayer.name="guideLayer"},screenCaptured:function(){var e=this;if(this.sceneProxy.isGameStarted){if(0===this.sceneProxy.quickPlayLayer.children.length){var t=this.sceneProxy.quickPlayLayer.create(0,0,"app_button_speed"),n=this.sceneProxy.quickPlayLayer.create(0,0,"app_icon_speed"),a={font:"25px PingFang-SC-Regular",fill:"#333333"},o=this.viewComponent.game.add.text(0,0,"快进中...",a,this.sceneProxy.quickPlayLayer),r={font:"20px PingFang-SC-Regular",fill:"#aaadb3"},i=this.viewComponent.game.add.text(0,0,"松开手指恢复播放",r,this.sceneProxy.quickPlayLayer);t.x=(960-t.width)/2,t.y=(540-t.height)/2,n.x=t.x+90,n.y=t.y+25,o.x=n.x-10,o.y=n.y+n.height+14,i.x=t.x+39,i.y=o.y+33}this.sceneProxy.isScreenHold=!0,this.sceneProxy.quickPlay=!0,this.sceneProxy.removePlotTweens();var s=function l(){var t=e.sceneProxy,n=e.viewComponent.game;return function(){var e=t.plotViewsLayer.children.length>0;if(!e){var a=new Phaser.Pointer(n,1,Phaser.PointerMode.CURSOR);a.button=0,t.curPlotLayer.onChildInputDown.dispatch("quickPlayHandler",a)}t.isScreenHold&&setTimeout(l(),500)}};setTimeout(s(),20),this.sceneProxy.quickPlayLayer.alpha=1,this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)}},screenReleased:function(){this.sceneProxy.isScreenHold&&(this.sceneProxy.isScreenHold=!1,this.sceneProxy.quickPlay=!1,this.sceneProxy.quickPlayLayer.alpha=0)},cmdPlotLoadResources:function(e,t,n,a,o){var r=this,i=this.viewComponent.game.load.cache,s=a.commands[o],l=this.sceneProxy.getOneCommandResourceInfo(s),u=!1;return l.forEach(function(e){var t=e.type,n=e.url;if(n){var a="img"===t?i.checkImageKey(n):"ios"===flashvars.client&&flashvars.app_version>="1.5.0"?y["default"].isAudioInCache(n):i.checkSoundKey(n);if(a){var o=f.ResourcesManager.getCount(t,n,"play"),s=r.sceneProxy.usingResourceCount(n);s===o&&f.ResourcesManager.addRefCount(t,n)}else u=!0}}),u?this.sceneProxy.preloadCommandsAssets(e,t,n,a,o).then(function(){return r.assetsLoader()}):Promise.resolve()},showGuideTip:function(e){var t=this;return new Promise(function(n,a){if("android"!==flashvars.client&&"ios"!==flashvars.client)return t.sceneProxy.guideLayer.visible=!1,n();var o=function(e){if(t.sceneProxy.isShowGuide===!0){var a=t.sceneProxy.guideLayer.getByName("Cloud_record_tip");if(t.sceneProxy.guideLayer.children.length<=0){if(t.sceneProxy.guideLayer.inputEnableChildren=!0,t.sceneProxy.guideLayer.inputEnabled=!0,!t.viewComponent.game.load.cache.checkImageKey("Cloud_record_tip")&&1===e)return n();a=t.sceneProxy.guideLayer.create(t.viewComponent.game.world.width/2,t.viewComponent.game.world.height/2,"Cloud_record_tip"),a.name="Cloud_record_tip",a.anchor.setTo(.5,.5),a.visible=!1}t.sceneProxy.guideLayer.alpha=1,t.sceneProxy.guideLayer.visible=!0,a.visible=0!==e,t.viewComponent.game.world.bringToTop(t.sceneProxy.guideLayer);var o=function i(a,o){o&&o.pointerMode===Phaser.PointerMode.CURSOR&&0!==o.button||(t.sceneProxy.guideLayer.onChildInputDown.remove(i),t.tweenToPromise(t.sceneProxy.guideLayer,{alpha:0},1e3,null,!0,0,0,!1).then(function(){return t.sceneProxy.guideLayer.visible=!1,t.sceneProxy.guideLayer.alpha=0,0!==e&&(t.sceneProxy.isShowGuide=!1),m["default"].localStorageSetItem(r,JSON.stringify({count:t.sceneProxy.recordTipCount})),n()}))};t.sceneProxy.guideLayer.onChildInputDown.add(o)}},r="shanyi3000guide",i=JSON.parse(m["default"].localStorageGetItem(r));if(null!==i&&void 0!==i){if(t.sceneProxy.recordTipCount=i.count,1===e){if(t.sceneProxy.recordTipCount>=10)return t.sceneProxy.isShowGuide=!1,t.sceneProxy.guideLayer.visible=!1,n();t.sceneProxy.recordTipCount++,o(e)}else if(0===e)return t.sceneProxy.guideLayer.visible=!1,n()}else t.sceneProxy.isShowGuide=!0,o(e)})},addLoadingToastLayer:function(){if(0===this.sceneProxy.loadingToastLayer.children.length){var e=this.viewComponent.game.add.group();this.sceneProxy.loadingToastLayer.add(e);var t=this.viewComponent.game.add.graphics(0,0,e);t.beginFill(4048076),t.drawRect(0,0,135,36),t.endFill();var n=e.create(8,9,"toast_loading");this.viewComponent.addGifAnimation(n,"toast_loading");var a={font:"16px 微软雅黑",fill:"#ffffff"},o=this.viewComponent.game.add.text(33,8,"保存档案中~",a,e);o.name="toastText",e.x=(960-o.width)/2,e.y=252,e.alpha=.8,this.sceneProxy.loadingToastLayer.visible=!1}},addToastLayer:function(){if(0===this.sceneProxy.toastLayer.children.length){var e=this.viewComponent.game.add.group(),t=this.viewComponent.game.add.group();e.name="typeSuccess",t.name="typeError",this.sceneProxy.toastLayer.add(e),this.sceneProxy.toastLayer.add(t);var n=this.viewComponent.game.add.graphics(0,0,e),a=this.viewComponent.game.add.graphics(0,0,t);n.beginFill(4048076),n.drawRect(0,0,320,36),n.endFill(),a.beginFill(4048076),a.drawRect(0,0,260,36),a.endFill(),e.create(10,10,"icon_success"),t.create(10,10,"icon_error");var o={font:"16px 微软雅黑",fill:"#ffffff"},r=this.viewComponent.game.add.text(30,8,"存档成功，下次可以从这里读档继续哦~",o,e);r.name="toastText",r=this.viewComponent.game.add.text(30,8,"存档失败，请检查您的网络哦~",o,t),r.name="toastText",e.visible=!1,t.visible=!1,this.sceneProxy.toastLayer.alpha=0}},assetsLoaderStart:function(e,t){var n=this,a=void 0,o=[],r=this.viewComponent.game,i=r.load,s=r.sound,l=r.cache,u=0,c=i._totalFileCount,d=function(){"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?a&&y["default"].audioCountLoadByPhone.total===y["default"].audioCountLoadByPhone.loaded&&(y["default"].audioCountLoadByPhone.total=0,y["default"].audioCountLoadByPhone.loaded=0,s.onSoundDecode.remove(f),s.onSoundDecodeError.remove(m),i.onSoundLoadExtend.removeAll(),n.sceneProxy.progressLayer.visible=!1,a.sendNotification(e,t)):a&&o.every(function(e){return e.decoded})&&(s.onSoundDecode.remove(f),s.onSoundDecodeError.remove(m),n.sceneProxy.progressLayer.visible=!1,a.sendNotification(e,t))},h=function(e,o){var r=y["default"].audioCountLoadByPhone.loaded+u,i=y["default"].audioCountLoadByPhone.total+c,s=parseInt(100*r/i);n.showProgress(s,r,i,!!t),r===i&&u===c&&(a=o,d())},f=function(){return d()},m=function(e){var t=-1,n=l.getSound(e);(t=o.findIndex(function(e){return e===n}))!==-1&&(o.splice(t,1),l.removeSound(e)),d()};s.onSoundDecode.add(f),s.onSoundDecodeError.add(m),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version&&i.onSoundLoadExtend.add(h,this,0,this.sceneProxy),i.onLoadStart.addOnce(function(){},this,0),i.onFileComplete.add(function(e,t,n,a,r){if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version){var i=y["default"].audioCountLoadByPhone.loaded+a,s=y["default"].audioCountLoadByPhone.total+r;parseInt(100*i/s);u=a}var c=t.substring(t.length-3);if("png"!==c&&"jpg"!==c&&"gif"!==c&&"bmp"!==c){var d=l.getSound(t);d&&d.autoDecode&&d.isDecoding&&!d.decoded&&o.push(d)}},this,0),i.onLoadComplete.addOnce(function(e){i.onFileComplete.removeAll(),a=e,d()},this,0,this.sceneProxy),this.viewComponent.game.load.start()},assetsLoader:function(){var e=this,t=!1,n=[],a=this.viewComponent.game,o=a.load,r=a.sound,i=a.cache,s=0,l=o._totalFileCount;return new Promise(function(a,u){var c=function(){"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?t&&y["default"].audioCountLoadByPhone.total===y["default"].audioCountLoadByPhone.loaded&&(y["default"].audioCountLoadByPhone.total=0,y["default"].audioCountLoadByPhone.loaded=0,r.onSoundDecode.remove(h),r.onSoundDecodeError.remove(f),o.onSoundLoadExtend.removeAll(),e.sceneProxy.progressLayer.visible=!1,a()):t&&n.every(function(e){return e.decoded})&&(r.onSoundDecode.remove(h),r.onSoundDecodeError.remove(f),e.sceneProxy.progressLayer.visible=!1,a())},d=function(e){var t=y["default"].audioCountLoadByPhone.loaded+s,n=y["default"].audioCountLoadByPhone.total+l;parseInt(100*t/n);t===n&&s===l&&c()},h=function(){return c()},f=function(e){var t=-1,a=i.getSound(e);(t=n.findIndex(function(e){return e===a}))!==-1&&(n.splice(t,1),i.removeSound(e)),c()};r.onSoundDecode.add(h),r.onSoundDecodeError.add(f),"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version&&o.onSoundLoadExtend.add(d,e,0,e.sceneProxy),o.onLoadStart.addOnce(function(){},e,0),o.onFileComplete.add(function(e,t,a,o,r){if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version){var l=y["default"].audioCountLoadByPhone.loaded+o,u=y["default"].audioCountLoadByPhone.total+r;parseInt(100*l/u);s=o}var c=t.substring(t.length-3);if("png"!==c&&"jpg"!==c&&"gif"!==c&&"bmp"!==c){var d=i.getSound(t);d&&d.autoDecode&&d.isDecoding&&!d.decoded&&n.push(d)}},e,0),o.onLoadComplete.addOnce(function(e){o.onFileComplete.removeAll(),t=!0,c()},e,0,e.sceneProxy),e.viewComponent.game.load.start()})},showLogo:function(){var e=this,t=this.sceneProxy,n=t.json_data,a=t.context,o=n.logo,r=(n.chapters,n.cover);if(o&&o.background&&!o.background.hidden&&this.viewComponent.game.load.cache.checkImageKey(o.background.url)){var i=o.background,s=i.flex,l=i.opacity;this.sceneProxy.lstPlotBkKey=o.background.url,this.sceneProxy.lstPlotBkOpacity=o.background.opacity,this.sceneProxy.lstPlotBkFlex=s;var u=this.viewComponent.game.add.image(0,0,o.background.url);this.backgroundFlex(u,s),u.bringToTop(),u.alpha=0,this.tweenToPromise(u,{alpha:l},1e3,null,!0,0).then(function(){return m["default"].timeout(1e3)}).then(function(){return e.tweenToPromise(u,{alpha:0},1e3,null,!0,0).then(function(){if(r.hidden){
var t=e.sceneProxy.findFirstChapter(),n=t.downloadUuid?t.downloadUuid:t.uuid;if(t.md5&&0===t.plots.length)if(!t.charge||"android"!==flashvars.client&&"ios"!==flashvars.client)e.sceneProxy.checkIfChapterFree(n,t.md5).then(function(n){t.plots=n,e.sceneProxy.preloadChapterAssets(a,t)},function(e){-1===e.indexOf("code=87")?c["default"].error(e):c["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买")});else{var o=function(o){o?e.sceneProxy.checkIfChapterFree(n,t.md5).then(function(n){e.sceneProxy.unlockChapterCallBack=null,t.plots=n,e.sceneProxy.preloadChapterAssets(a,t)},function(){return c["default"].error("获取付费章节信息失败")}):c["default"].error("章节解锁失败")};e.sceneProxy.unlockChapter(n,t.charge,t.md5,o)}else e.sceneProxy.preloadChapterAssets(a,t)}else e.sceneProxy.showCover()})})}},showProgress:function(e,t,n,a){var o=function(e,t){var n=/^-?[\w\/]\d*$/;e.colors=[];for(var a=0;a<t.length;)n.test(t[a])?e.colors.push("#ffae00"):e.colors.push("#ffffff"),a++},r=this.sceneProxy.progressLayer.getByName("background"),i=this.sceneProxy.progressLayer.getByName("type0"),s=this.sceneProxy.progressLayer.getByName("type1"),l=this.viewComponent.game.world.width,u=this.viewComponent.game.world.height;if(r||(r=this.viewComponent.game.add.graphics(0,0,this.sceneProxy.progressLayer),r.beginFill(0),r.drawRect(0,0,l,u),r.endFill(),r.name="background",r.inputEnabled=!0),a){r.alpha=.5,s||(s=this.viewComponent.game.add.group(),s.name="type1",this.sceneProxy.progressLayer.add(s));var c=s.getByName("progressText"),d=s.getByName("progressText2"),h=s.getByName("progressBar"),f=s.getByName("tipText"),m=s.getByName("tipLight");if(!f){var p={font:"18px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle"};f=this.viewComponent.game.add.text(0,0,"",p,s),f.name="tipText",f.setTextBounds(25,510,l-25,22)}if(0===e){var y="小贴士："+this.sceneProxy.progressTips[Math.floor(Math.random()*this.sceneProxy.progressTips.length)];y="android"===flashvars.client||"ios"===flashvars.client?Math.random()>.7?y:"小贴士：如果加载停止，请右滑退出重新打开":Math.random()>.7?y:"小贴士：如果加载停止，请按F5刷新页面",o(f,y),f.text=y}if(m||(m=this.viewComponent.game.add.image((l-f.width-25)/2,508,"light",0,s),m.name="tipLight"),m.x=(l-f.width-25)/2,!h){h=this.viewComponent.game.add.group(),h.name="progressBar",s.add(h);var g=this.viewComponent.game.add.graphics(0,0,h);g.beginFill(837833),g.drawRoundedRect(0,0,.75*l,10,5),g.endFill(),g.name="progressBar",g.inputEnabled=!0,g.x=l/8,g.y=490}var v=h.getByName("progressBar_overlay");v||(v=this.viewComponent.game.add.graphics(0,0,h),v.beginFill(16777215),v.drawRect(0,0,.75*l,10),v.endFill(),v.name="progressBar_overlay",v.inputEnabled=!0,v.x=l/8,v.y=490),0===e&&(v.x=l/8);var x=h.getByName("progressBar_mask");x||(x=this.viewComponent.game.add.graphics(0,0,h),x.beginFill(0),x.drawRoundedRect(0,0,.75*l,10,5),x.endFill(),x.name="progressBar_mask",x.inputEnabled=!0,x.x=l/8,x.y=490,h.mask=x);var P=x.width*(e/100);if(v.x=l/8+P,!c){var w={font:"18px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle"};c=this.viewComponent.game.add.text(0,0,"",w,s),c.name="progressText",c.setTextBounds(0,465,l,22)}if(!d){var b={font:"24px 微软雅黑",fill:"#ffffff",boundsAlignH:"center",boundsAlignV:"middle"};d=this.viewComponent.game.add.text(0,0,"",b,s),d.name="progressText2",d.setTextBounds(.89*l,482,50,30)}d.text=e+"%";var k="正在加载"+t+"/"+n+"个资源";o(c,k),c.text=k,i&&(i.visible=!1),s&&(s.visible=!0),this.sceneProxy.progressLayer.bringToTop(s)}else{return}this.sceneProxy.progressLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.sceneProxy.progressLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},addDialogLayer:function(){var e=this.sceneProxy.json_data.template.json.dialog,t=e.background,n=e.rect,a=e.avatarContainer,o=e.titleContainer,r=e.content;if(0===this.sceneProxy.dialogLayer.children.length){var i=void 0,s=void 0,l=void 0;if(this.viewComponent.game.load.cache.checkImageKey(t.url)){var u=this.sceneProxy.dialogLayer.create(0,0,t.url);u.width=n.width,u.height=n.height,u.name="dialog_bk"}if(i=o.rect.x,s=o.rect.y,this.viewComponent.game.load.cache.checkImageKey(o.background.url)){var c=this.sceneProxy.dialogLayer.create(i,s,o.background.url);c.width=o.rect.width,c.height=o.rect.height,c.name="dialog_bk_title"}var d=void 0;i=o.rect.x+o.title.rect.x,s=o.rect.y+o.title.rect.y,d=this.viewComponent.game.add.text(0,0,"",{fill:"#fff"},this.sceneProxy.dialogLayer),d.name="dialog_text_title",d.setTextBounds(i+(o.title.rect.width-o.rect.width)/2,s,o.rect.width,o.rect.height),this.viewComponent.game.load.cache.checkImageKey(a.background.url)&&(i=a.rect.x,s=a.rect.y,l=this.sceneProxy.dialogLayer.create(i,s,a.background.url),l.width=a.rect.width,l.height=a.rect.height,l.name="dialog_bk_avatar"),i=a.rect.x+a.avatar.x,s=a.rect.y+a.avatar.y;var f=this.sceneProxy.dialogLayer.create(i,s);f.name="dialog_avatar",f.width=a.avatar.width,f.height=a.avatar.height,d=this.viewComponent.game.add.text(r.rect.x,r.rect.y,"",{fill:"#fff",boundsAlignH:"left",boundsAlignV:"top",wordWrap:!0,wordWrapWidth:r.rect.width},this.sceneProxy.dialogLayer),d.name="dialog_text_content",d.useAdvancedWrap=!0,d.updateText=h["default"].updateText,d.advancedWordWrap=h["default"].advancedWordWrap}this.sceneProxy.dialogLayer.x=n.x,this.sceneProxy.dialogLayer.y=n.y,this.sceneProxy.dialogLayer.alpha=1,this.sceneProxy.dialogLayer.visible=!0,this.viewComponent.game.world.bringToTop(this.sceneProxy.dialogLayer),this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.quickPlayLayer.alpha&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},addMenuLayer:function(e){var t=this;if(0===this.sceneProxy.menuLayer.children.length){var n=this.sceneProxy.json_data.template.json.menu,a=n.rect,o=n.normal,r=n.active,i=function(e,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("menu_button"===e.parent.name?t.sceneProxy.onMenuBtnClicked():t.sceneProxy.onSyMenuBtnClicked())},s={};s.normal=o.text,s.active=r.text,s.text="菜单",this.viewComponent.addButton(866,26,a.width,a.height,o.background.url,r.background.url,i,s,this.sceneProxy.btn_sound,"menu_button",this.sceneProxy.menuLayer),this.viewComponent.addButton(874,100,56,56,"menuMore","menuMoreHover",i,s,this.sceneProxy.btn_sound,"menu_button_more",this.sceneProxy.menuLayer)}this.viewComponent.game.world.bringToTop(this.sceneProxy.menuLayer),this.sceneProxy.menuLayer.visible=!0},doEffectsAnimation:function(e){var t=function n(t){m["default"].timeout(40).then(function(){if(0!==e.children.length){if(!e.visible)return void n(t);0===t?e.children[e.children.length-1].visible=!1:e.children[t-1].visible=!1,e.children[t].visible=!0,n(++t%e.children.length)}})};t(0)},addRainEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("rain");if(!e){e=this.viewComponent.game.add.group(),e.name="rain",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<50;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/weather/rain/xiayu_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addSnowEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("snow");if(!e){e=this.viewComponent.game.add.group(),e.name="snow",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<120;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/weather/snow/xuehua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addWindEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("wind");e||(e=this.viewComponent.game.add.group(),e.name="wind",this.sceneProxy.weatherLayer.add(e),this.viewComponent.game.add.tileSprite(0,0,960,540,"wind",1,e).autoScroll(-360,0)),this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addFallingLeavesEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("fallingLeaves");if(!e){e=this.viewComponent.game.add.group(),e.name="fallingLeaves",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/weather/mapleLeaves/fengye_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addBeachBlossomEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("beachBlossom");if(!e){e=this.viewComponent.game.add.group(),e.name="beachBlossom",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/weather/beachBlossom/taohua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addBlossomEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("blossom");if(!e){e=this.viewComponent.game.add.group(),e.name="blossom",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<90;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/weather/blossom/yinghua_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},addLightningEffect:function(){var e=this.sceneProxy.weatherLayer.getByName("lightning");if(!e){e=this.viewComponent.game.add.group(),e.name="lightning",this.sceneProxy.weatherLayer.add(e);for(var t=[],n=0;n<50;n++)t[n]=this.viewComponent.game.add.sprite(0,0,"/weather/lightning/shandian_"+m["default"].formatNum(n)+".png"),e.add(t[n]),t[n].visible=!1;this.doEffectsAnimation(e)}this.sceneProxy.weatherLayer.visible=!0,e.visible=!0,this.sceneProxy.weatherLayer.bringToTop(e)},registerViewKey:function(e,t,n){var a=this,o=this.sceneProxy.json_data.viewMap,r=function(e){for(var t in e)"onKeyUp"===e[t].type&&(a.viewComponent.game.input.keyboard.removeKey(e[t].keyCode),n[e[t].keyCode]=a.viewComponent.game.input.keyboard.addKey(e[t].keyCode))},i=function s(e){r(o[e].events);for(var t in o[e].children)s(o[e].children[t].ref),r(o[e].children[t].events)};i(e),r(t)},removeViewKey:function(e){for(var t in e)this.viewComponent.game.input.keyboard.removeKey(t),e.splice(t,1)},removeViewKeyByInstance:function(e,t){var n=this,a=this.sceneProxy.json_data.viewMap,o=function(e){for(var a in e)"onKeyUp"===e[a].type&&(n.viewComponent.game.input.keyboard.removeKey(e[a].keyCode),t.splice(e[a].keyCode,1))},r=function i(e){e.name&&a[e.name]&&o(a[e.name].events);for(var t in e.children)i(e.children[t])};r(e)},addGlobalView:function(e){if(!this.sceneProxy.globalViews){this.sceneProxy.globalViews=[],this.sceneProxy.globalViewKeys=[];var t=this.sceneProxy.json_data.views;for(var n in t)this.registerViewKey(t[n].ref,t[n].events,this.sceneProxy.globalViewKeys),this.sceneProxy.globalViews[n]=this.addView(null,t[n].ref,t[n].instanceUuid,t[n].x,t[n].y,t[n].events),this.sceneProxy.globalViews[n].isGlobal=!0,t[n].scale&&(this.sceneProxy.globalViews[n].scale.set(t[n].scale,t[n].scale),this.sceneProxy.globalViews[n].x+=t[n].x.value*(1-t[n].scale),this.sceneProxy.globalViews[n].y+=t[n].y.value*(1-t[n].scale),this.scaleInputView(this.sceneProxy.globalViews[n],t[n].scale));this.uiOnLoadInvoker()}for(var a in this.sceneProxy.globalViews)e[this.sceneProxy.globalViews[a].name]?(this.sceneProxy.globalViews[a].visible=!1,this.showInputView(this.sceneProxy.globalViews[a],!1)):(this.sceneProxy.globalViews[a].visible=!0,this.showInputView(this.sceneProxy.globalViews[a],!0),this.viewComponent.game.world.bringToTop(this.sceneProxy.globalViews[a]))},addView:function(e,t,n,a,o,s,u){var c=this;if(!t)return!1;var d=!0,f=this.viewComponent.game.add.group(),p=this.sceneProxy.json_data.viewMap[t];if(!p)return f.destroy(),null;f.name=t,f.instanceUuid=n,f.xInfo=a,f.yInfo=o,f.eventsInfo=s,f.inputEnableChildren=!0,e&&e.add(f);var g=this.sceneProxy,x=g.Expression,P=g.context,w=g.curChapter,b=g.uiOnLoadQueue,k=x.safeEval(a,P),C=x.safeEval(o,P),_=function ue(t,n,a,o){var r=0;for(r=0;r<n.length;r++){if("jump"===n[r].type)return c.sceneProxy.uiOnLoadQueue=[],c.sceneProxy.mainMenuLayer.visible&&c.sceneProxy.onMainMenuBackBtnClicked(),c.sceneProxy.context=JSON.parse(JSON.stringify(P)),c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex,n[r].type,n[r].handle.uuid),!1;if("playMusic"===n[r].type)(c.viewComponent.game.load.cache.checkSoundKey(n[r].handle.music.url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&(c.sceneProxy.stopMusic(n[r].handle.music.url,!0),c.sceneProxy.playMusic(n[r].handle.music.url,n[r].handle.music.volume,!0,!0));else if("stopMusic"===n[r].type)c.sceneProxy.stopMusic(null,!0);else if("playSound"===n[r].type)for(var s=0;s<n[r].handle.sounds.length;s++){var l=n[r].handle.sounds[s]?n[r].handle.sounds[s].url:"";if("inherit"!==l)if(c.viewComponent.game.load.cache.checkSoundKey(l)){var u="inherit"===n[r].handle.sounds[s].volume?c.sceneProxy.plotSounds[s].volume:n[r].handle.sounds[s].volume;c.sceneProxy.stopSound(s,l,!0),c.sceneProxy.playSound(s,l,u,!n[r].handle.sounds[s].time,!0)}else if("ios"===flashvars.client&&flashvars.app_version>="1.5.0"){var d="inherit"===n[r].handle.sounds[s].volume?y["default"].soundsInfo[s].volume:n[r].handle.sounds[s].volume;c.sceneProxy.stopSound(s,l,!0),c.sceneProxy.playSound(s,l,d,!n[r].handle.sounds[s].time,!0)}else c.sceneProxy.stopSound(s)}else if("stopSound"===n[r].type)c.sceneProxy.plotSounds.forEach(function(e,t){return c.sceneProxy.stopSound(t,null,!0)});else if("callUI"===n[r].type){if("save-record"===n[r].handle.id&&"system"===n[r].handle.type){var h=c.sceneProxy.context.disableSaveOrLoad;return h&&h.save?(c.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用存档"),!1):(!c.sceneProxy.mainMenuLayer.visible&&c.sceneProxy.getSnap(),c.sceneProxy.showSave(),!1)}if("load-record"===n[r].handle.id&&"system"===n[r].handle.type){var f=c.sceneProxy.context.disableSaveOrLoad;return f&&f.load?(c.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用读档"),!1):(c.sceneProxy.showLoad(),!1)}if("playback"===n[r].handle.id&&"system"===n[r].handle.type)return c.sceneProxy.showPlayback(),!1;if("settings"===n[r].handle.id&&"system"===n[r].handle.type)return c.sceneProxy.showSettings(c.sceneProxy.context),!1;if(n[r].handle.uuid)for(var p=Object.assign({},n[r].handle.position.x),g=Object.assign({},n[r].handle.position.y),v=n[r].handle.count?x.safeEval(n[r].handle.count,c.sceneProxy.context):1,k=0;k<v;k++){c.registerViewKey(n[r].handle.uuid,[],c.sceneProxy.plotViewKeys);var C=c.addView(e,n[r].handle.uuid,"",p,g);C&&(e?"plotViewsLayer"===e.name?c.sceneProxy.plotViews.push(C):e.xInfo&&e.yInfo&&(C.x+=x.safeEval(e.xInfo,c.sceneProxy.context),C.y+=x.safeEval(e.yInfo,c.sceneProxy.context)):(C.isGlobal=!0,c.sceneProxy.globalViews.push(C)),e&&e.parent&&"mainMenuLayer"===e.parent.name||c.sceneProxy.mainMenuLayer.visible||c.viewComponent.game.world.bringToTop(c.sceneProxy.menuLayer),"onLoad"!==a&&c.uiOnLoadInvoker())}}else if("refreshUI"===n[r].type){var _=c.refreshView(n[r].handle.uuid);if(e&&n[r].handle.uuid===e.name)for(var S=0;S<_.length;S++)if(_[S].name===e.name){e=_[S];break}}else if("reload"===n[r].type){var I=c.refreshView(n[r].handle.uuid,!0);if(n[r].handle.uuid===e.name)for(var E=0;E<I.length;E++)if(I[E].name===e.name){e=I[E];break}c.uiOnLoadInvoker()}else if("closeUI"===n[r].type){var L=function(){var e=n[r].handle.uuid,a=t,o=!1,i=function(e){for(a=a&&a.parent;;){if(!a)break;if(a.viewType)return e&&(a.name+="_1"),a.name;a=a.parent}};if("system"===n[r].handle.type&&"diyMainMenu"===n[r].handle.id){var s=c.sceneProxy.mainMenuLayer.children[1];s?(e=s.name,o=!0):(e=null,c.sceneProxy.onMainMenuBackBtnClicked(),c.sceneProxy.mainMenuLayer.removeAll(!0,!1,!0))}else e||(t.viewType?e=t.name:(e=i(a,!0),n[r].isParent&&(e=i(a,!0))));if(e){for(var l=e.substring(0,36),u=0;u<b.length;u++)b[u].name!==l&&b[u].instanceUuid!==l||b.splice(u--,1);c.destroyView(e,o)}if("system"===n[r].handle.type)return{v:void 0}}();if("object"===("undefined"==typeof L?"undefined":i(L)))return L.v}else{if("back"===n[r].type)return c.sceneProxy.uiOnLoadQueue=[],c.sceneProxy.mainMenuLayer.visible&&c.sceneProxy.onResume(),c.sceneProxy.context=JSON.parse(JSON.stringify(P)),c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex,n[r].type),!1;if("nextPlot"===n[r].type)return c.sceneProxy.uiOnLoadQueue=[],w.plots[c.sceneProxy.curPlotIndex].commands?(c.sceneProxy.optionLayer.destroy(),c.sceneProxy.cmdPlotNextPromise&&c.sceneProxy.cmdPlotNextPromise({type:""}),!1):(c.sceneProxy.context=JSON.parse(JSON.stringify(P)),w.plots[c.sceneProxy.curPlotIndex].condition_options.length>0?(c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex),!1):(c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex,n[r].type),!1));if("jumpOption"===n[r].type){c.sceneProxy.uiOnLoadQueue=[];var T=x.safeEval(n[r].handle.value,P);if(w.plots[c.sceneProxy.curPlotIndex].commands){var M=c.sceneProxy.getNextCommand(P,c.sceneProxy.curCmdInfo,-1,{eArg:T,type:"jumpOption"}),A=M.info,O=M.index;return O!==-1&&c.sceneProxy.cmdPlayHandlerFun(A,O),!1}return c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex,n[r].type,T),!1}if("backOption"===n[r].type){c.sceneProxy.uiOnLoadQueue=[];var V=x.safeEval(n[r].handle.value,P);if(w.plots[c.sceneProxy.curPlotIndex].commands){var N=c.sceneProxy.getNextCommand(P,c.sceneProxy.curCmdInfo,-1,{eArg:V,type:"backOption"}),B=N.info,R=N.index;return R!==-1&&c.sceneProxy.cmdPlayHandlerFun(B,R),!1}return c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex,n[r].type,V),!1}if("insertPlot"===n[r].type){c.sceneProxy.uiOnLoadQueue=[];var j=new Phaser.Pointer(c.viewComponent.game,1,Phaser.PointerMode.CURSOR);return j.button=0,c.sceneProxy.curPlotLayer.onChildInputDown.dispatch("insertPlot",j),c.sceneProxy.curPlotLayer.onChildInputDown.dispatch("insertPlot",j),c.showNextPlot(c.sceneProxy.context,w,c.sceneProxy.curPlotIndex,n[r].type,n[r].handle.uuid),!1}if("setValue"===n[r].type)c.sceneProxy.valueOperation(P,n[r].handle.values);else if("pay"===n[r].type){var D=function(){var e=x.safeEval(n[r].handle.price,P),a=n[r].handle.uuid,i=flashvars.client+m["default"].generateUUID(),s=-1,l=[],u=[],d=[],h=[],f=function(){if("ios"===flashvars.client||"android"===flashvars.client){for(var e=0;e<P.values.length;e++)l[e]=P.values[e].value;for(var t=0;t<P.savedValues.length;t++)u[t]=P.savedValues[t].value;for(var a=0;a<P.stringValues.length;a++)d[a]=P.stringValues[a].value;for(var o=0;o<P.payValues.length;o++)h[o]=P.payValues[o].value;for(var i=parseInt(r)+1;i<n.length;i++)if("setValue"===n[i].type)c.sceneProxy.valueOperation(P,n[i].handle.values,!0);else if("pay"===n[i].type)break;c.sceneProxy.isPaying=!0}},p=function(){for(var e=0;e<l.length;e++)P.values[e].value=l[e];for(var t=0;t<u.length;t++)P.savedValues[t].value=u[t];for(var n=0;n<d.length;n++)P.stringValues[n].value=d[n];for(var a=0;a<h.length;a++)P.payValues[a].value=h[a];c.sceneProxy.isPaying=!1},y=function(a){var i=s===-1?e:s;if(2==a?c.sceneProxy.context.systemValues[1].value-=100*i:c.sceneProxy.context.systemValues[0].value-=i,c.sceneProxy.getAccountInfo(),r<n.length-1)return ue(t,n.slice(r+1),a,o)},g=function(e){if(c.sceneProxy.mallPayCallback=null,p(),c.sceneProxy.checkIfMallPaySuccess(i),e)y(e);else{var t=function n(){m["default"].timeout(1e3).then(function(){c.sceneProxy.getPayInfo().then(function(e){"[object String]"===Object.prototype.toString.call(e)&&n()})})};t()}};return o&&(o.paused=!0),c.sceneProxy.isPaying||(f(),c.sceneProxy.payOperation(e,a,i,g).then(function(e){return s=e})),"break"}();if("break"===D)break}}}return o&&o.paused&&r>=n.length&&o.callback(),!0},S=function(e,t){x.safeEval(t.expression,P)&&_(e,t.events,"onKeyUp")},I=function(e,t){var n=[],a=void 0;if(a=p.events,s){var o=Object.assign([],s);o.forEach(function(e){return e.events.forEach(function(e){return e.isParent=!0})}),a=o.concat(a)}var r=function(o){if(a[o].type===t&&"onKeyUp"!=a[o].type)n[n.length]=a[o];else if(a[o].type===t&&"onKeyUp"===a[o].type){var r=a[o].keyCode,i=c.sceneProxy.plotViewKeys&&c.sceneProxy.plotViewKeys[r]?c.sceneProxy.plotViewKeys[r]:c.sceneProxy.globalViewKeys&&c.sceneProxy.globalViewKeys[r]?c.sceneProxy.globalViewKeys[r]:void 0;i&&i.onUp.add(function(){return S(e,a[o])})}};for(var i in a)r(i);var l=!0,u=function d(n){for(var a=function(a){if(x.safeEval(n[a].expression,P)){var o=function(){d(n.slice(a+1))},r={paused:!1,callback:o};if(!_(e,n[a].events,t,r))return l=!1,"break";if(r.paused)return"break"}},o=0;o<n.length;o++){var r=a(o);if("break"===r)break}};return u(n),l},E=function(e,t){e.isHanding||c.sceneProxy.isPaying||t&&t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button||(e.isHanding=!0,I(e,"onClick"),e.isHanding=!1)},L=function(e){e.events.onInputDown.add(E,c,0,e)},T=function(e){return!!u||I(e,"onLoad")},M=function(e){I(e,"onKeyUp")};if("button"===p.type){var A=null;p.content.sound&&p.content.sound.url&&(A=this.viewComponent.game.add.sound(p.content.sound.url,p.content.sound.volume,!1));var O=this.viewComponent.addButton(k,C,p.width,p.height,p.content.background.normal.url,p.content.background.active.url,function(e,t){return E(e.parent,t)},null,A,null,f);M(O.parent),f.viewType="BUTTON",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:O.parent,callBack:T})}else if("image"===p.type){var V=this.viewComponent.game.add.image(k,C,p.content.background.url);V.width=p.width,V.height=p.height,f.add(V),L(V),M(V),this.viewComponent.addGifAnimation(V,p.content.background.url),f.viewType="IMAGE",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:V,callBack:T})}else if("text"===p.type){var N=void 0,B={boundsAlignH:"left",boundsAlignV:"bottom",wordWrap:!0};N=p.content.font_size+"",N.indexOf("px")<0&&(N+="px"),p.content.bold===!0?N="bold "+N+" "+p.content.fontFamily:p.content.fontFamily?N=N+" "+p.content.fontFamily:this.sceneProxy.json_data.font&&(N=N+" "+this.sceneProxy.json_data.font.fontFamily),B.font=N,B.fill=p.content.color,B.wordWrapWidth=p.width;var R=this.viewComponent.game.add.text(k,C,"",B,f),j="";if(x.isArray(p.content.value)){if(p.content.value.forEach(function(e){return j+=x.parseValue(e.data,P)}),this.sceneProxy.addImageFontTextColors(p.content.value,R,P),v["default"].fontFamily){var D=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontHeight(p.content.font_size):p.content.font_size,U=this.sceneProxy.json_data.font.size?this.sceneProxy.toRealImageFontWidth(p.content.font_size):p.content.font_size;this.sceneProxy.addImageFontText(p.content.value,U,D,R,P)}}else j=x.parseValue(p.content.value,P);R.inputEnabled=!0,R.input.useHandCursor=!0,R.useAdvancedWrap=!0,R.lineSpacing=this.sceneProxy.txtLineSpace(p.content.font_size),R.updateText=h["default"].updateText,R.advancedWordWrap=h["default"].advancedWordWrap,v["default"].fontFamily?(R.children.forEach(function(e){e.visible=!0}),R.text=" "):R.text=j,L(R),M(R),f.viewType="TEXT",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:R,callBack:T});var F=s?s:[],G=[].concat(r(p.events),r(F)).filter(function(e){return"onClick"===e.type});!G.length&&(R.inputEnabled=!1)}else if("bar"===p.type){var z=this.viewComponent.game.add.sprite(k,C,p.content.background.normal.url);z.width=p.width,z.height=p.height,f.add(z),L(z),this.viewComponent.addGifAnimation(z,p.content.background.normal.url);var W=this.viewComponent.game.add.sprite(k,C,p.content.background.progress.url);W.width=p.width,W.height=p.height,f.add(W),L(W),this.viewComponent.addGifAnimation(W,p.content.background.progress.url);var H=this.viewComponent.game.add.graphics(k,C);H.beginFill(16777215),H.drawRect(0,0,p.width,p.height),H.endFill(),f.add(H),W.mask=H,L(H),M(H);var K="",J="";K=0===p.content.basePoint.x?"left":p.content.basePoint.x===p.width?"right":"middle",J=0===p.content.basePoint.y?"top":p.content.basePoint.y===p.height?"bottom":"center";for(var q=this.sceneProxy.prgsViews,Y=0;Y<q.length&&(q[Y].uuid!==p.uuid||0!==q[Y].layer.children.length);Y++);q[Y]={uuid:p.uuid,layer:f,type:K+"-"+J,content:p.content},this.updateProgressView(),f.viewType="BAR",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:H,callBack:T})}else if("input"===p.type){var X=x.safeEval(p.content.value,P),$=new l.HtmlTextBox(this.viewComponent.game,k,C,p.width,p.height,X,p.content.color,p.content.font_size,p.content.fontFamily?p.content.fontFamily:this.sceneProxy.json_data.font?this.sceneProxy.json_data.font.fontFamily:"",p.content.bold?p.content.bold:null);"[未知数值]"===X&&$.setEnable(!1);var Q=function(e){var t=e,n=p.content.value.arg1,a=function(e,t,n){for(var a="",o=0;o<t.length;o++)(t[o]>="0"&&t[o]<="9"||"."===t[o]&&0!==o)&&(a+=t[o]);var r=parseFloat(a);r=r?r:0,r<-99999999999999?r=-99999999999999:r>99999999999999&&(r=99999999999999),"value"===n?c.sceneProxy.context.values[e].value=r:"savedValue"===n&&(c.sceneProxy.context.savedValues[e].value=r),$.isValue=!0,parseFloat(a)!==r&&0!==r?$.text=r+"":a!==t&&($.text=a)},o=void 0;if((o=P.values.findIndex(function(e){return e.uuid===n}))!==-1)a(o,t,"value");else if((o=P.savedValues.findIndex(function(e){return e.uuid===n}))!==-1)a(o,t,"savedValue");else if((o=P.stringValues.findIndex(function(e){return e.uuid===n}))!==-1)P.stringValues[o].value=t;else if((o=P.indexValues.findIndex(function(e){return e.uuid===n}))!==-1){var r=(void 0===P.indexValues[o].value?x.safeInitValue(P.indexValues[o],P):P.indexValues[o].value)-1;"value"===P.indexValues[o].init.type?a(r,t,"value"):"savedValue"===P.indexValues[o].init.type?a(r,t,"savedValue"):"stringValue"===P.indexValues[o].init.type&&(P.stringValues[r].value=t)}};$.setInputCallback(Q),$.setClickCallback(E),$.mgrParent=f,f.inputElement=$,M($),f.viewType="INPUT",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:$,callBack:T})}else if("timer"===p.type){var Z=this.sceneProxy,ee=this.viewComponent.game.add.image(0,0,null);f.add(ee),f.currentCount=0;var te=function(){if(Z.playPause){for(var e=0;e<Z.menuTimer.length;e++)if(Z.menuTimer[e]===f.name)return!1;return!0}for(var t=0;t<Z.menuTimer.length;t++)if(Z.menuTimer[t]===f.name)return!0;return!1},ne=function ce(){return function(){return te()?void(f.timerHandler=setTimeout(ce(),p.content.step.value)):void(f.currentCount++<p.content.count.value&&(I(ee,"onStep"),f.timerHandler=setTimeout(ce(),p.content.step.value)))}},ae=function(){return function(){te()||I(ee,"onStep")}};0===p.content.count.value?(f.timerHandler=setInterval(ae(),p.content.step.value),f.timerType="timeInterval"):(f.timerHandler=setTimeout(ne(),p.content.step.value),f.timerType="timeOut");for(var oe=0;oe<this.sceneProxy.timerCounts.length;oe++){var re=this.sceneProxy.timerCounts[oe];if(f.name===re.name&&re.parent===e.name){f.currentCount=re.currentCount,this.sceneProxy.timerCounts.splice(oe,1);break}}this.sceneProxy.mainMenuLayer.visible&&(this.sceneProxy.menuTimer[this.sceneProxy.menuTimer.length]=t),f.viewType="TIMER",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ee,callBack:T})}else if("container"===p.type){var ie=null;p.content.background.url?(ie=this.viewComponent.game.add.image(k,C,p.content.background.url),ie.width=p.width,ie.height=p.height):(ie=this.viewComponent.game.add.graphics(0,0),ie.beginFill(0,1),ie.drawRect(k,C,p.width,p.height),ie.endFill(),ie.alpha=0),f.add(ie),L(ie),M(ie),f.viewType="CONTAINER",this.sceneProxy.uiOnLoadQueue.push({name:t,instanceUuid:n,object:ie,callBack:T});for(var se in p.children){var le=this.addView(f,p.children[se].ref,p.children[se].instanceUuid,p.children[se].x,p.children[se].y,p.children[se].events,u);if(!le)return!1;le.x+=k,le.y+=C,p.children[se].scale&&(le.scale.set(p.children[se].scale,p.children[se].scale),le.x+=x.safeEval(p.children[se].x,P)*(1-p.children[se].scale),le.y+=x.safeEval(p.children[se].y,P)*(1-p.children[se].scale)),le.inputElement&&(le.inputElement.x+=k,le.inputElement.y+=C,p.children[se].scale?(le.inputElement.fontSize*=p.children[se].scale,le.inputElement.width*=p.children[se].scale,le.inputElement.height=le.inputElement.fontSize):le.inputElement.update())}}return d?f:d},uiOnLoadInvoker:function(){for(;0<this.sceneProxy.uiOnLoadQueue.length;){var e=this.sceneProxy.uiOnLoadQueue[0];this.sceneProxy.uiOnLoadQueue.splice(0,1),e.callBack(e.object)}},updateProgressView:function(){for(var e=this,t=function(t){var n=e.sceneProxy.prgsViews[t];if(!n.layer.children.length)return"continue";var a=n.layer.children[0],o=n.layer.children[1],r=n.layer.children[2],i=e.sceneProxy.Expression.safeEval(n.content.value.normal.width,e.sceneProxy.context),s=e.sceneProxy.Expression.safeEval(n.content.value.normal.height,e.sceneProxy.context),l=e.sceneProxy.Expression.safeEval(n.content.value.progress.width,e.sceneProxy.context),u=e.sceneProxy.Expression.safeEval(n.content.value.progress.height,e.sceneProxy.context),c=function(t,a,r,i,s){t.isMask?(t.destroy(),t=e.viewComponent.game.add.graphics(a,r),t.beginFill(16777215),t.drawRect(0,0,i,s),t.endFill(),t.inputEnabled=!1,n.layer.add(t),o.mask=t):(t.x=a,t.y=r,t.width=i,t.height=s)},d="clip"===n.content.style?r:o,h=Math.min(l*a.width/i,a.width),f=Math.min(u*a.height/s,a.height);switch(n.type){case"left-top":c(d,a.x,a.y,h,f);break;case"middle-top":c(d,a.x+(a.width-h)/2,a.y,h,f);break;case"right-top":c(d,a.x+a.width-h,a.y,h,f);break;case"left-center":c(d,a.x,a.y+(a.height-f)/2,h,f);break;case"middle-center":c(d,a.x+(a.width-h)/2,a.y+(a.height-f)/2,h,f);break;case"right-center":c(d,a.x+a.width-h,a.y+(a.height-f)/2,h,f);break;case"left-bottom":c(d,a.x,a.y+a.height-f,h,f);break;case"middle-bottom":c(d,a.x+(a.width-h)/2,a.y+a.height-f,h,f);break;case"right-bottom":c(d,a.x+a.width-h,a.y+a.height-f,h,f)}},n=0;n<this.sceneProxy.prgsViews.length;n++){t(n)}},destroyView:function(e,t){var n=this,a=function o(e,a){if(e.name&&e.name===a||e.instanceUuid&&e.instanceUuid===a)return n.removeViewKeyByInstance(e,n.sceneProxy.plotViewKeys),n.sceneProxy.removeInputView(e),n.sceneProxy.removeViewTimer(e),e.destroy(),e.isMenu&&t&&(n.sceneProxy.onMainMenuBackBtnClicked(),n.sceneProxy.mainMenuLayer.removeAll(!0,!1,!0)),!0;if(e.children&&e.children.length>0)for(var r=0;r<e.children.length;r++)o(e.children[r],a)&&r--;return!1};a(this.viewComponent.game.world,e)},showInputView:function(e,t){if(e.inputElement)e.inputElement.show(t);else if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)this.showInputView(e.children[n],t)},scaleInputView:function(e,t){if(e.inputElement)e.inputElement.fontSize*=t,e.inputElement.width*=t,e.inputElement.height=e.inputElement.fontSize+6,e.inputElement.update();else if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)this.scaleInputView(e.children[n],t)},refreshView:function(e,t){var n=this,a=function u(e,t){var n=[];return e.name&&e.name===t?n.push(e):n=e.children.reduce(function(e,n){return e.concat(u(n,t))},[]),n},o=[],r=a(this.viewComponent.game.world,e);if(r.length>0){var i=this.sceneProxy.json_data.viewMap,s=i[e].events;for(var l in s)"onKeyUp"===s[l].type&&this.sceneProxy.plotViewKeys[s[l].keyCode].onUp.removeAll()}return r.forEach(function(a){var r=a.xInfo,i=a.yInfo,s=a.scale,l=a.isGlobal,u=a.children,c=a.instanceUuid;for(var d in a.eventsInfo)"onKeyUp"===a.eventsInfo[d].type&&n.sceneProxy.plotViewKeys[a.eventsInfo[d].keyCode].onUp.removeAll();var h=n.addView(a.parent,e,c,r,i,a.eventsInfo,!t);if(h){n.viewComponent.game.world.add(h);for(var f=0;f<u.length;f++){var m=!1;for(var p in h.children)if(h.children[p].name===u[f].name){m=!0;break}m||t||(h.addChild(u[f]),f-=1)}if("CONTAINER"===a.parent.viewType&&(h.x+=n.sceneProxy.Expression.safeEval(a.parent.xInfo,n.sceneProxy.context),h.y+=n.sceneProxy.Expression.safeEval(a.parent.yInfo,n.sceneProxy.context)),s&&(h.scale.set(s.x,s.y),h.x+=n.sceneProxy.Expression.safeEval(r,n.sceneProxy.context)*(1-s.x),h.y+=n.sceneProxy.Expression.safeEval(i,n.sceneProxy.context)*(1-s.y),n.scaleInputView(h,s.x)),l){h.isGlobal=!0;var y=n.sceneProxy.globalViews.findIndex(function(t){
return t.name===e});n.sceneProxy.globalViews.splice(y,1,h)}if(a.isMenu&&(h.isMenu=!0),a.parent&&"plotViewsLayer"===a.parent.name){var g=n.sceneProxy.plotViews.indexOf(a);n.sceneProxy.plotViews.splice(g,1,h)}n.sceneProxy.removeViewTimer(a),a.parent.replace(a,h).destroy(),o.push(h)}}),o},backgroundFlex:function(e,t){if(3===t){var n=e.width/e.height<960/540?960/e.width:540/e.height;e.width*=n,e.height*=n,e.x=-(e.width-960)/2,e.y=-(e.height-540)/2}else if(5===t){var a=0;e.width/e.height>960/540?(a=960/e.width,e.width*=a,e.height*=a,e.y=(540-e.height)/2):(a=540/e.height,e.width*=a,e.height*=a,e.x=(960-e.width)/2)}else e.width=960,e.height=540},tweenToPromise:function(e,t,n,a,o,r,i,s){var l=this;return n=Math.max(n,1),new Promise(function(u,c){var d=l.viewComponent.game.add.tween(e).to(t,n,a,o,r,i,s);d.onComplete.add(function(){return u()}),l.sceneProxy.lstPlotTweens.push(d),!e.animateTweens&&(e.animateTweens=[]),e.animateTweens.push(d)})},tweenFromPromise:function(e,t,n,a,o,r,i,s){var l=this;return n=Math.max(n,1),new Promise(function(u,c){var d=l.viewComponent.game.add.tween(e).from(t,n,a,o,r,i,s);d.onComplete.add(function(){return u()}),l.sceneProxy.lstPlotTweens.push(d),!e.animateTweens&&(e.animateTweens=[]),e.animateTweens.push(d)})},showPlot:function(e,t,n,a,o){var s=this,l=this.sceneProxy.Expression,u=t.plots[n],d=null,h=null,p=null,g=!1;!this.sceneProxy.isGameStarted&&t.isFirst&&0===n&&this.sceneProxy.notifyGameStarted();var x=function q(e,a,o){var r=e,i=s.sceneProxy,l={x:i.dialogLayer.x-r,y:i.dialogLayer.y-r},c=[];return u.speaking&&"bottom"===u.speaking.coverage&&c.push(s.tweenToPromise(i.dialogLayer,l,50,null,!0,o,0,!0)),i.charsAndPropsLayer&&(i.charsAndPropsLayer.visible=!0,c.push(s.tweenToPromise(i.charsAndPropsLayer,{x:i.charsAndPropsLayer.x-r,y:i.charsAndPropsLayer.y-r},50,null,!0,o,0,!0))),c.push(s.tweenToPromise(i.curPlotLayer,{x:-r,y:-r},50,null,!0,o,0,!0).then(function(){return 0<a&&!i.quickPlay&&t===i.curChapter&&n===i.curPlotIndex?q(r,a-120,0):(i.curPlotLayer.isShaking=!1,Promise.resolve())})),Promise.all(c)},P=function(e,t,n){return s.sceneProxy.twinkleTimer=m["default"].timeout(t||0),s.sceneProxy.twinkleTimer.then(function(){var t=s.viewComponent.game.add.graphics(0,0);return t.beginFill(m["default"].fixColorValue(n).replace("#","0x")),t.moveTo(0,0),t.lineTo(s.viewComponent.game.world.width,0),t.lineTo(s.viewComponent.game.world.width,s.viewComponent.game.world.height),t.lineTo(0,s.viewComponent.game.world.height),t.lineTo(0,0),t.endFill(),t.name="twinkle",s.sceneProxy.twinkleTimer=null,s.tweenToPromise(t,{alpha:0},e,null,!0,0).then(function(){return t.destroy()})})},w=function(e,t){return d?s.tweenFromPromise(d,{alpha:0},e,null,!0,t):Promise.resolve()},b=function(t){var n=[];return t.forEach(function(t){var a=s.sceneProxy.quickPlay?0:t.delay,o=s.sceneProxy.quickPlay?100:t.duration;"twinkle"===t.type&&n.push(P(o,a,t.color)),"shake"===t.type&&o&&n.push(x(18,o,a)),"fadein"===t.type&&n.push(w(o,a).then(function(){return s.sceneProxy.doInCT(e,function(){s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=null,s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer})}))}),Promise.all(n)},k=function(t){var n=s.sceneProxy.dialogLayer;s.addDialogLayer();var a=s.sceneProxy.json_data.template.json.dialog,o=a.avatarContainer,r=a.titleContainer,i=a.content,u=n.getByName("dialog_bk"),c=n.getByName("dialog_bk_avatar"),d=n.getByName("dialog_avatar"),f=n.getByName("dialog_bk_title");if(h=n.getByName("dialog_text_title"),p=n.getByName("dialog_text_content"),u&&(u.visible=!t.speaking.hidden),c&&(c.visible=!t.avatar.hidden),f&&(f.visible=!t.dialogtitle.hidden),d.visible=!t.avatar.hidden,h.visible=!t.dialogtitle.hidden,s.sceneProxy.dialogLayer.x=t.speaking.x,s.sceneProxy.dialogLayer.y=t.speaking.y,s.sceneProxy.dialogLayer.alpha=void 0===t.speaking.opacity?1:t.speaking.opacity,s.viewComponent.game.load.cache.checkImageKey(t.avatar.url)){var m=o.avatar,y=m.x,g=m.y,x=m.width,P=m.height,w=m.clip;y+=o.rect.x,g+=o.rect.y,d.loadTexture(t.avatar.url);var b=Math.min(x*d.scale.x/d.width,P*d.scale.y/d.height);x=d.width/d.scale.x*b,P=d.height/d.scale.y*b,y=o.avatar.x+o.rect.x+(o.avatar.width-x)/2,g=o.avatar.y+o.rect.y+(o.avatar.height-P)/2,d.x=y,d.y=g,d.width=x,d.height=P,d.mask&&d.mask.destroy();var k=s.viewComponent.game.add.graphics(0,0);switch(k.beginFill(),w){case"square":k.drawRect(y,g,x,P);break;case"hexagon":var C=new Phaser.Polygon;C.setTo([new Phaser.Point(x/2+y,g),new Phaser.Point(x/2+P/4*Math.pow(3,.5)+y,P/4+g),new Phaser.Point(x/2+P/4*Math.pow(3,.5)+y,P/4*3+g),new Phaser.Point(x/2+y,P+g),new Phaser.Point(x/2-P/4*Math.pow(3,.5)+y,P/4*3+g),new Phaser.Point(x/2-P/4*Math.pow(3,.5)+y,P/4+g)]),k.drawPolygon(C.points);break;case"heart":k.moveTo(x/2+y,x/4+g),k.bezierCurveTo(3*x/4+y,-x/4+g,3*x/2+y,x/4+g,x/2+y,x+g),k.bezierCurveTo(-x/2+y,x/4+g,x/4+y,-x/4+g,x/2+y,x/4+g);break;case"round":default:k.drawCircle(y+x/2,g+P/2,x)}k.endFill(),s.sceneProxy.dialogLayer.add(k),d.mask=k}var _=t.dialogtitle,S=_.font_size,I=_.color,E=_.bold,L=_.fontFamily,T=_.hidden,M=r.title.text;S&&(M.fontSize=S),I&&(M.color=I),void 0!==E&&(M.fontWeight=E?"bold":"normal"),L?M.fontFamily=L:s.sceneProxy.json_data.font?M.fontFamily=s.sceneProxy.json_data.font.fontFamily:"",void 0!==T&&(M.hidden=T);var A="";if(v["default"].fontFamily){var O=h.children[0],V=l.parseValue(t.dialogtitle.data,e);("#ffffff"===I||"#fff"===I)&&(M.color="#fefefe"),O&&(O.fontImg.destroy(),O.destroy()),O=s.sceneProxy.addRetroText(),h.addChild(O),O.fontImg.setText(V?V:" ",!0,0,0,"left",!0),O.tint=parseInt(M.color.replace("#","0x"));var N=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(M.fontSize):M.fontSize,B=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(M.fontSize):M.fontSize;O.width=B*O.fontImg.text.length,O.height=N;var R=r.rect.x+r.title.rect.x+(r.title.rect.width-O.width)/2,j=r.rect.y+r.title.rect.y;h.setTextBounds(R,j,r.title.rect.width,r.title.rect.height),h.text=" "}else{A+=M.fontWeight?M.fontWeight+" ":"normal ",A+=M.fontSize?parseInt(M.fontSize)+"px ":"",A+=M.fontFamily?M.fontFamily:"",h.setStyle({font:A,fill:M.color,boundsAlignH:"center",boundsAlignV:"middle"}),h.text=l.parseValue(t.dialogtitle.data,e);var D=r.rect.x+r.title.rect.x,U=r.rect.y+r.title.rect.y;h.setTextBounds(D,U+(h.height-parseInt(M.fontSize||12))/2,r.title.rect.width,r.title.rect.height)}A=t.speaking.font_size+"",A.indexOf("px")<0&&(A+="px"),t.speaking.bold===!0&&(A="bold "+A),A=A+" "+(s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:t.speaking.fontFamily?t.speaking.fontFamily:""),p.style.font=A,p.style.fill=t.speaking.color,p.text="",p.top=i.rect.y,p.lineSpacing=s.sceneProxy.txtLineSpace(t.speaking.font_size),p.mask&&p.mask.destroy();var F=s.viewComponent.game.add.graphics(0,0);return F.beginFill(),F.drawRect(i.rect.x,i.rect.y,i.rect.width,t.speaking.hidden?540:i.rect.height),F.endFill(),s.sceneProxy.dialogLayer.add(F),p.mask=F,Promise.resolve()},C=function(){var e=u.plot_sound;if(o&&(e=o.sounds),"[object Array]"===Object.prototype.toString.call(e))for(var t in e)e[t]?"inherit"===e[t].url?s.sceneProxy.playInheritSound(t,e[t].volume):(s.viewComponent.game.load.cache.checkSoundKey(e[t].url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&(s.sceneProxy.stopSound(t,e[t].url),s.sceneProxy.playSound(t,e[t].url,e[t].volume,0===e[t].time)):s.sceneProxy.stopSound(t);else(s.viewComponent.game.load.cache.checkSoundKey(u.plot_sound.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&s.sceneProxy.playSound(0,u.plot_sound.url,u.plot_sound.volume,!1)},_=function(e){e.url&&""!==e.url?"inherit"===e.url?s.sceneProxy.playInheritMusic(e.volume):(s.viewComponent.game.load.cache.checkSoundKey(e.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&(s.sceneProxy.stopMusic(e.url),s.sceneProxy.playMusic(e.url,e.volume,1!==e.time)):s.sceneProxy.stopMusic()},S=function(e){if(d=s.viewComponent.game.add.graphics(0,0,e),d.beginFill(0,1),d.drawRect(0,0,s.viewComponent.game.world.width,s.viewComponent.game.world.height),d.endFill(),!u.commands){s.sceneProxy.lstGameBk&&s.sceneProxy.lstGameBk.visible&&!u.animations.filter(function(e){return"fadein"===e.type}).length&&(s.sceneProxy.lstGameBk.visible=!1);var t="inherit"===u.background.url,n=t?s.sceneProxy.lstPlotBkOpacity:u.background.opacity,a=t?s.sceneProxy.lstPlotBkFlex:u.background.flex,o=t?s.sceneProxy.lstPlotBkKey:u.background.url;f.ResourcesManager.delRefTypeCount("img",f.ResourcesManager.usingKeyMap.background),f.ResourcesManager.usingKeyMap.background=t?f.ResourcesManager.usingKeyMap.background:o,o&&(s.sceneProxy.lstPlotBkKey=o,s.sceneProxy.lstPlotBkOpacity=n,s.sceneProxy.lstPlotBkFlex=a),s.viewComponent.game.load.cache.checkImageKey(o)&&(d.alpha=0,d=e.create(u.background.x,u.background.y,o),d.alpha=void 0===n?1:n,s.backgroundFlex(d,a),s.viewComponent.addGifAnimation(d,o))}},I=function(e,t,n){for(var a=[].concat(r(e),r(t)),o=0;o<a.length;o++){var i=a[o],l=s.viewComponent.addFitImageSprint(i.x,i.y,i.width,i.height,i.url,s.sceneProxy.charsAndPropsLayer,i.index);l.alpha=void 0===i.opacity?1:i.opacity,l.angle=180===parseInt(i.rotate)?179.9:i.rotate||0,l.data.animations=i.animations,l.cmdUuid=n,s.viewComponent.addGifAnimation(l,i.url),i.mirrorH&&(l.angle=-l.angle,l.scale.x=-l.scale.x,l.mirrorH=!0),i.mirrorV&&(l.angle=-l.angle,l.scale.y=-l.scale.y,l.mirrorV=!0)}s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer)},E=function(){var e=[],t=!0,n=!1,a=void 0;try{for(var o,r=s.sceneProxy.charsAndPropsLayer.children[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var i=o.value,l=!0,u=!1,c=void 0;try{for(var d,h=i.data.animations[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var f=d.value;if(("in"===f.trigger||"animateIn"===f.trigger)&&!s.sceneProxy.quickPlay)if("fadein"===f.type)e.push(s.tweenFromPromise(i,{alpha:0},f.duration,null,!0,f.delay,0,!1));else if("moveFrom"===f.type){var m=i.mirrorH?f.x-i.width/2:f.x+i.width/2,p=i.mirrorV?f.y-i.height/2:f.y+i.height/2;e.push(s.tweenFromPromise(i,{x:m,y:p},f.duration,null,!0,f.delay,0,!1))}}}catch(y){u=!0,c=y}finally{try{!l&&h["return"]&&h["return"]()}finally{if(u)throw c}}}}catch(y){n=!0,a=y}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw a}}return Promise.all(e)},L=function(a,o){var r=!1;return new Promise(function(i,c){if(u.jump||u.back||u.insert)return i({type:0});var d=(o||[]).findIndex(function(t){return l.safeEval(t.expression,e)}),h=d<0?null:o[d];if(h)return i({type:2});for(var f=[],p=[],y=function(o){var u=s.sceneProxy.json_data.template.json.option,c=u.rect,d=u.normal,h=u.active,y=c.x,g=c.y,x=c.width,P=c.height,w=d.background.url,b=h.background.url,k=null,C=a[o],_=C.font,S=C.timer,I=C.disable;void 0!==a[o].x&&(y=a[o].x),void 0!==a[o].y&&(g=a[o].y),void 0!==a[o].width&&a[o].hasOwnProperty("background")&&(x=a[o].width),void 0!==a[o].height&&a[o].hasOwnProperty("background")&&(P=a[o].height),a[o].background&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.normal.url)&&(w=a[o].background.normal.url),a[o].background&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.active.url)&&(b=a[o].background.active.url),a[o].background&&a[o].background.disable&&s.viewComponent.game.load.cache.checkImageKey(a[o].background.disable.url)&&(k=a[o].background.disable.url);var E=function(e,t){var n=!0,r=!1,l=void 0;try{for(var u,c=f[Symbol.iterator]();!(n=(u=c.next()).done);n=!0){var d=u.value;d.close()}}catch(h){r=!0,l=h}finally{try{!n&&c["return"]&&c["return"]()}finally{if(r)throw l}}t.pointerMode===Phaser.PointerMode.CURSOR&&0!==t.button||(e.chapter.plots.length>0?(i({type:1,index:o}),s.sceneProxy.optionLayer.destroy()):(i({type:3}),s.sceneProxy.optionLayer.destroy()),m["default"].selOptions.push(a[o].uuid))},L={fontFamily:_.normal.fontFamily?_.normal.fontFamily:s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:"",fontSize:_.normal.font_size,fontWeight:_.normal.bold?"bold":"normal",color:_.normal.color,hidden:_.normal.hidden},T={fontFamily:_.disable.fontFamily?_.disable.fontFamily:s.sceneProxy.json_data.font?s.sceneProxy.json_data.font.fontFamily:"",fontSize:_.disable.font_size,fontWeight:_.disable.bold?"bold":"normal",color:_.disable.color,hidden:_.disable.hidden},M={};M.normal=L,M.active=L,M.text=a[o].name;var A=void 0;a[o].sound&&s.viewComponent.game.load.cache.checkSoundKey(a[o].sound.url)&&(A=s.viewComponent.game.add.sound(a[o].sound.url,a[o].sound.volume,!1));var O=s.viewComponent.addButton(y,g,x,P,w,b,E,M,A,"option",s.sceneProxy.optionLayer),V=O.getByName("button"),N=O.getByName("text");if(V.chapter={plots:a[o].plots?a[o].plots:a[o].commands,parent:{pChapter:t,pnPlot:n}},I&&(V.inputEnabled=!1,O.changeBackground(k||w,T)),S){var B=function(){return new Promise(function(t,n){var r=l.getGameValueByTimer(S,e);if(!a[o].hideTimer&&(N.text=a[o].name+("("+r+")"),v["default"].fontFamily)){var i=N.children[0];if(i){var u=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(L.fontSize):L.fontSize,c=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(L.fontSize):L.fontSize,d=c*N.text.length,h=(x-d)/2,m=(P-u)/2;s.sceneProxy.addImageFontText([{data:N.text}],c,u,N,e),N.children[0].x=h,N.children[0].y=m,i.children.forEach(function(e){return e.fontImg.destroy()}),i.destroy(),N.text=" "}}var p=s.viewComponent.game.time.events.loop(Phaser.Timer.SECOND,function(){if(r--,!a[o].hideTimer&&(N.text=a[o].name+("("+r+")"),v["default"].fontFamily)){var n=N.children[0];if(n){var i=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(L.fontSize):L.fontSize,l=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(L.fontSize):L.fontSize,u=l*N.text.length,c=(x-u)/2,d=(P-i)/2;s.sceneProxy.addImageFontText([{data:N.text}],l,i,N,e),N.children[0].x=c,N.children[0].y=d,n.children.forEach(function(e){return e.fontImg.destroy()}),n.destroy(),N.text=" "}}if(r<=0){if(N.text=a[o].name,v["default"].fontFamily){var h=N.children[0];if(h){var f=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(L.fontSize):L.fontSize,m=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(L.fontSize):L.fontSize,y=m*N.text.length,g=(x-y)/2,b=(P-f)/2;s.sceneProxy.addImageFontText([{data:N.text}],m,f,N,e),N.children[0].x=g,N.children[0].y=b,h.children.forEach(function(e){return e.fontImg.destroy()}),h.destroy(),N.text=" "}}s.viewComponent.game.time.events.remove(p),"disable"===S.type?(V.alive&&(V.inputEnabled=!1,O.changeBackground(k||w,T)),t(!1)):(V.alive&&(V.inputEnabled=!0,V.input.useHandCursor=!0,O.changeBackground(w,L)),t(!0))}}),y=function(){s.viewComponent.game.time.events.remove(p),t(!0)};f.push({close:y}),s.viewComponent.game.time.events.start()})};p.push(B())}else p.push(Promise.resolve(!I));r=!0},g=0;g<a.length;g++)y(g);r||(i({type:0}),s.sceneProxy.optionLayer.destroy()),Promise.all(p).then(function(e){e.some(function(e){return!!e})||i({type:3})})}).then(function(e){return f.ResourcesManager.delByRefType("playOption"),2===e.type&&a&&a.length&&a.forEach(function(e,t){return f.ResourcesManager.delByRefType("PreloadOption"+t)}),void 0!==e.index&&o&&o&&a.forEach(function(e,t){return f.ResourcesManager.delByRefType("PreloadCondOption"+t)}),e})},T=function(e){s.sceneProxy.weatherLayer.visible=!1;for(var t=0;t<s.sceneProxy.weatherLayer.children.length;t++){var n=s.sceneProxy.weatherLayer.children[t],a=n.visible,o=n.name;a&&o!==e?(s.sceneProxy.weatherLayer.children[t].destroy(),t--):s.sceneProxy.weatherLayer.children[t].visible=!1}"windy"===e?s.addWindEffect():"snowy"===e?s.viewComponent.game.load.cache.checkImageKey("/weather/snow/xuehua_00119.png")&&s.addSnowEffect():"rainy"===e?s.viewComponent.game.load.cache.checkImageKey("/weather/rain/xiayu_00049.png")&&s.addRainEffect():"defoliation"===e?s.viewComponent.game.load.cache.checkImageKey("/weather/mapleLeaves/fengye_00089.png")&&s.addFallingLeavesEffect():"fallingPeach"===e?s.viewComponent.game.load.cache.checkImageKey("/weather/beachBlossom/taohua_00089.png")&&s.addBeachBlossomEffect():"fallingFlower"===e?s.viewComponent.game.load.cache.checkImageKey("/weather/blossom/yinghua_00089.png")&&s.addBlossomEffect():"lightning"===e&&s.viewComponent.game.load.cache.checkImageKey("/weather/lightning/shandian_00049.png")&&s.addLightningEffect(),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer)},M=function(t,n,a){if(n){for(var o=0;o<s.sceneProxy.plotViews.length;o++)if("plotInfo"===s.sceneProxy.plotViews[o].generateType){for(var r=!1,i=0;i<t.length;i++)if(t[i].ref===s.sceneProxy.plotViews[o].name){r=!0;break}r||(s.sceneProxy.plotViews.splice(o,1),o--)}return O(s.sceneProxy.plotViews),s.sceneProxy.uiOnLoadQueue.splice(0),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),void(s.sceneProxy.plotViewsLayer.visible=!1)}for(var u in t){s.registerViewKey(t[u].ref,t[u].events,s.sceneProxy.plotViewKeys);var c=s.addView(s.sceneProxy.plotViewsLayer,t[u].ref,t[u].instanceUuid,t[u].x,t[u].y,t[u].events);if(!c)return;t[u].scale&&(c.scale.set(t[u].scale,t[u].scale),c.x+=l.safeEval(t[u].x,e)*(1-t[u].scale),c.y+=l.safeEval(t[u].y,e)*(1-t[u].scale),s.scaleInputView(c,t[u].scale)),c.generateType=a?a:"plotInfo",s.sceneProxy.plotViews.push(c)}s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),s.uiOnLoadInvoker(),s.updateProgressView(),s.sceneProxy.plotViewsLayer.visible=!1},A=function(e,t){var n=[];for(var a in t)for(var o in s.sceneProxy.json_data.views)if(t[a]===s.sceneProxy.json_data.views[o].instanceUuid){n[s.sceneProxy.json_data.views[o].ref]=s.sceneProxy.json_data.views[o].ref;break}if(e&&s.sceneProxy.globalViews){for(var r=0,i=0;r<s.sceneProxy.globalViews.length;r++){for(;i<s.sceneProxy.json_data.views.length&&s.sceneProxy.json_data.views[i].instanceUuid!==s.sceneProxy.globalViews[r].instanceUuid;i++);i>=s.sceneProxy.json_data.views.length&&s.sceneProxy.globalViews.splice(r--,1)}O(s.sceneProxy.globalViews);for(var l in s.sceneProxy.globalViews)s.viewComponent.game.world.bringToTop(s.sceneProxy.globalViews[l]),n[s.sceneProxy.globalViews[l].name]&&(s.sceneProxy.globalViews[l].visible=!1,s.showInputView(s.sceneProxy.globalViews[l],!1))}else s.addGlobalView(n);s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer)},O=function(e){s.sceneProxy.timerCounts=[];var t=function r(e){for(var t=0;t<e.length;t++){var n=e[t];n.currentCount&&(s.sceneProxy.timerCounts[s.sceneProxy.timerCounts.length]={name:n.name,parent:n.parent,currentCount:n.currentCount}),r(n.children)}},n=function(e){for(var t=0;t<e.length;t++){if(e[t].eventsInfo)return;for(var n=0;n<u.views.length;n++)if(u.views[n].ref===e[t].name){e[t].eventsInfo=u.views[n].events.concat();break}}};t(e),!u.commands&&n(e);for(var a=function(t){var n=e[t],a="__world"===n.parent?null:s.viewComponent.game.world.getByName(n.parent),r=s.addView(a,n.name,n.instanceUuid,n.xInfo,n.yInfo,n.eventsInfo),i=function l(e,t){for(var n=t.children.concat(),a=0;a<e.children.length;a++){for(var o=!1,r=0;r<n.length;r++)if(e.children[a].name===n[r].name){o=!0,n.splice(r,1);break}if(!o){var i=s.addView(t,e.children[a].name,e.children[a].instanceUuid,e.children[a].xInfo,e.children[a].yInfo,e.children[a].eventsInfo);t.xInfo&&t.yInfo&&(i.x+=s.sceneProxy.Expression.safeEval(t.xInfo,s.sceneProxy.context),i.y+=s.sceneProxy.Expression.safeEval(t.yInfo,s.sceneProxy.context)),l(e.children[a],i)}}};return r?(i(n,r),r.scale.set(n.scale.x,n.scale.y),r.x=n.x,r.y=n.y,s.scaleInputView(r,n.scale.x),r.visible=n.visible,e[t]=r,a?a.add(r):r.isGlobal=!0,void(o=t)):(e.splice(t--,1),"continue")},o=0;o<e.length;o++){a(o)}},V=function(){if(u.music.animation&&("fadeinfadeout"===u.music.animation.type||"fadein"===u.music.animation.type)){if(s.sceneProxy.bk_music)return s.tweenFromPromise(s.sceneProxy.bk_music,{volume:0},s.sceneProxy.quickPlay?10:1e3,null,!0,0,0,!1);if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)return y["default"].tweenFromMusic(0,s.sceneProxy.quickPlay?10:1e3,0)}return Promise.resolve()},N=function(e){if(u.music.animation&&("fadeinfadeout"===u.music.animation.type||"fadeout"===u.music.animation.type)){if(s.sceneProxy.bk_music)return new Promise(function(t,n){var a=s.viewComponent.game.add.tween(s.sceneProxy.bk_music).to({volume:0},s.sceneProxy.quickPlay?10:1e3,null,!0,0,0,!1);a.onComplete.add(function(){return t(e)})});if("ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)return y["default"].tweenToMusic(0,s.sceneProxy.quickPlay?10:1e3,0)}return Promise.resolve(e)},B=function(e){if(!e.length)return Promise.resolve();var t=e.filter(function(e){return"fadein"===e.type}),n=e.filter(function(e){return"moveFrom"===e.type}),a=function(){if(t.length)return s.tweenFromPromise(s.sceneProxy.dialogLayer,{alpha:0},t[0].duration,null,!0,t[0].delay,0,!1)},o=function(){if(n.length)return s.tweenFromPromise(s.sceneProxy.dialogLayer,{x:n[0].x,y:n[0].y},n[0].duration,null,!0,n[0].delay,0,!1)};return Promise.all([a(),o()])},R=function(e){if(!e.length)return Promise.resolve();var t=e.filter(function(e){return"fadeout"===e.type}),n=e.filter(function(e){return"moveTo"===e.type}),a=function(){if(t.length)return s.tweenToPromise(s.sceneProxy.dialogLayer,{alpha:0},t[0].duration,null,!0,t[0].delay,0,!1)},o=function(){if(n.length)return s.tweenToPromise(s.sceneProxy.dialogLayer,{x:n[0].x,y:n[0].y},n[0].duration,null,!0,n[0].delay,0,!1)};return Promise.all([a(),o()])},j=function(){return s.sceneProxy.doInCT(e,function(){return b(u.animations.filter(function(e){return"in"===e.trigger}))}).then(function(){return s.sceneProxy.charsAndPropsLayer&&(s.sceneProxy.charsAndPropsLayer.visible=!0),s.sceneProxy.plotViewsLayer.visible=!0,s.sceneProxy.doInCT(e,function(){return Promise.all([E(),b(u.animations.filter(function(e){return"animateIn"===e.trigger}))])})}).then(function(){return s.sceneProxy.doInCT(e,function(){return b(u.animations.filter(function(e){return"animateInEnd"===e.trigger}))})})},D=function(t){var n=[],a=!0,o=!1,r=void 0;try{for(var i,l=s.sceneProxy.charsAndPropsLayer.children[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var u=i.value,c=!0,d=!1,h=void 0;try{for(var f,m=u.data.animations[Symbol.iterator]();!(c=(f=m.next()).done);c=!0){var p=f.value;if(("out"===p.trigger||"animateOut"===p.trigger)&&!s.sceneProxy.quickPlay)if("fadeout"===p.type)n.push(s.tweenToPromise(u,{alpha:0},p.duration,null,!0,p.delay,0,!1));else if("moveTo"===p.type){var y=u.scale.x<0?-u.width/2:u.width/2,g=u.scale.y<0?-u.height/2:u.height/2;n.push(s.tweenToPromise(u,{x:p.x+y,y:p.y+g},p.duration,null,!0,p.delay,0,!1))}}}catch(v){d=!0,h=v}finally{try{!c&&m["return"]&&m["return"]()}finally{if(d)throw h}}}}catch(v){o=!0,r=v}finally{try{!a&&l["return"]&&l["return"]()}finally{if(o)throw r}}return s.sceneProxy.doInCT(e,function(){return Promise.all(n)})},U=function Y(e){if("\\"===e[0]){var t=/\\(\d+)\s([\s\S]*)/.exec(e);if(t)return m["default"].timeout(s.sceneProxy.quickPlay?0:t[1]).then(function(){return Y(e.slice(t[1].length+2))})}return s.sceneProxy.playPause?m["default"].timeout(1e3).then(function(){return Y(e)}):Promise.resolve(e)},F=function(e,t){var n=s.sceneProxy.json_data.template.json.dialog.content,a=e?540:n.rect.height,o=t-a;o>0&&(p.top=-o+n.rect.y)},G=function X(e,t,n,a,o){if(v["default"].fontFamily){var r=e,i=0;if(e.replace(/[\n]/g,function(e,t){i++}),r.length&&r.length-i>0){var l=r.length-i-1,u=p.children[1],c=p.posInfo;c[l]&&(u.x=c[l].x+c[l].space,u.y=c[l].y,F(o,c[l].bottomInText),p.setText(" ",!0))}}else{var d=s.viewComponent.game.device.desktop?e:e.replace(new RegExp(" ","gm"),"  ");p.setText(d,!0),F(o,p.height)}return U(t).then(function(t){return s.sceneProxy.doInCT(n,function(){return m["default"].timeout(a).then(function(){return g?Promise.reject():t?s.sceneProxy.doInCT(n,function(){return X(e+(t[0]?t[0]:""),t.slice(1),n,a,o)}):Promise.resolve()})})})},z=function(t,n){var a="";if(l.isArray(t.data)){for(var o=0;o<t.data.length;o++)a+=l.parseValue(t.data[o].data,e);s.sceneProxy.addImageFontTextColors(t.data,p,e)}else a=l.parseValue(t.data,e);if(a.length&&"\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),v["default"].fontFamily){var r=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontHeight(t.font_size):t.font_size,i=s.sceneProxy.json_data.font.size?s.sceneProxy.toRealImageFontWidth(t.font_size):t.font_size;s.sceneProxy.addImageFontText(t.data,i,r,p,e,!0,t.hidden)}if(n||t.immediate){if(v["default"].fontFamily)p.children[1]&&(p.children[1].y=p.imgFBottom),p.text=" ",F(t.hidden,p.imgFBottom);else{var u=l.parseWaitTime(a);p.text=s.viewComponent.game.device.desktop?u:u.replace(new RegExp(" ","gm"),"  ")}return Promise.resolve()}g=!1;var c=new Promise(function(e,t){s.sceneProxy.curPlotLayer.onChildInputDown.add(function(t,n){"auto"===t||n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||e()})}),d=new Promise(function(e,t){s.sceneProxy.space_key.onDown.add(function(){e()})});return s.sceneProxy.doInCT(e,function(){return Promise.race([G("",a,e,s.sceneProxy.quickPlay?0:parseInt(t.speed),t.hidden),c,d])}).then(function(){if(g=!0,s.sceneProxy.curPlotLayer.onChildInputDown.removeAll(),s.sceneProxy.space_key.onDown.removeAll(),v["default"].fontFamily)p.children[1]&&(p.children[1].y=p.imgFBottom),F(t.hidden,p.imgFBottom),p.setText(" ",!0);else{var e=l.parseWaitTime(a);p.text=s.viewComponent.game.device.desktop?e:e.replace(new RegExp(" ","gm"),"  "),F(t.hidden,p.height)}})},W=function $(e,t){var n=s.sceneProxy.quickPlay?10:e;return m["default"].timeout(n).then(function(){return s.sceneProxy.playPause?$(500,t):Promise.resolve(t)})},H=function(t){var n="";if("[object Array]"===Object.prototype.toString.call(t.speaking.data))for(var a=0;a<t.speaking.data.length;a++)n+=t.speaking.data[a].data;else n=t.speaking.data;n=n.replace(/\n/g,"");var o=t.dialogtitle.hidden||""===t.dialogtitle.data?n:t.dialogtitle.data+":"+n;o&&s.sceneProxy.addPlayBackContent(l.parseWaitTime(l.parseValue(o,e)))},K=function(t,n,a,o){if(t)a.forEach(function(e,t){t===n?f.ResourcesManager.transferByRefCount("PreloadOption"+t,"play"):f.ResourcesManager.delByRefType("PreloadOption"+t)});else{var r=(o||[]).findIndex(function(t){return l.safeEval(t.expression,e)&&(!t.count||parseInt(l.safeEval(t.count,e))>0)});o.forEach(function(e,t){t===r?f.ResourcesManager.transferByRefCount("PreloadCondOption"+t,"play"):f.ResourcesManager.delByRefType("PreloadCondOption"+t)})}},J=function(){if(!u)return s.showNextPlot(e,t,n);var r=function(){s.sceneProxy.curCmdUuid="";var a={avatar:u.avatar,dialogtitle:u.dialogtitle,speaking:u.speaking};return u.speaking.data&&!o&&H(u),u.menu.hidden||(s.sceneProxy.json_data.template.json.shanyiMenu?s.addMenuLayer(!0):(s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=u.menu.x,s.sceneProxy.menuLayer.y=u.menu.y)),u.animations.find(function(e){return"fadein"===e.type})||(s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer),!o&&s.sceneProxy.valueOperation(e,u.values),C(),_(o?o.music:u.music),S(s.sceneProxy.curPlotLayer),"bottom"===u.speaking.coverage?(k(a),I(u.characters,u.props),T(u.weather.value)):(I(u.characters,u.props),T(u.weather.value),k(a)),s.sceneProxy.optionLayer&&s.viewComponent.game.world.bringToTop(s.sceneProxy.optionLayer),s.sceneProxy.charsAndPropsLayer&&(s.sceneProxy.charsAndPropsLayer.visible=!1),M(u.views,o),A(null!==o&&void 0!==o,u.hideGlobalViews),s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad&&u.autoSaveOrLoad&&1===u.autoSaveOrLoad.type&&!o?s.sceneProxy.loadRecord(0)?void 0:c["default"].warn("Sorry~读不到存档内容，即将返回封面").then(function(){return s.sceneProxy.reStart()},function(){return s.sceneProxy.reStart()}):Promise.all([j(),V(),B(u.speaking.animations.filter(function(e){return"animateIn"===e.trigger}))]).then(function(){return s.sceneProxy.lstGameBk&&(s.sceneProxy.lstGameBk.visible=!1),z(u.speaking)}).then(function(){return L(u.options,u.condition_options)}).then(function(t){var n=s.sceneProxy.plotViewsLayer.children.length>0;return new Promise(function(a,o){if(0===t.type||2===t.type)if(!u.autotext&&(n||!s.sceneProxy.quickPlay&&!e.auto)||s.sceneProxy.playPause){var r=function i(e,r){r&&r.pointerMode===Phaser.PointerMode.CURSOR&&0!==r.button||"auto"===e&&n||(s.sceneProxy.curPlotLayer.onChildInputDown.remove(i),"insertPlot"===e?o():a(t))};s.sceneProxy.curPlotLayer.onChildInputDown.add(r),!n&&s.sceneProxy.space_key.onDown.addOnce(function(){return a(t)})}else a(t);else a(t)})}).then(function(e){return s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad&&u.autoSaveOrLoad&&0===u.autoSaveOrLoad.type&&(s.sceneProxy.getSnap(),s.sceneProxy.saveRecord(0,!0)),e}).then(function(e){return W(u.wait.value,e)}).then(function(t){return Promise.all([D(t),N(t),R(u.speaking.animations.filter(function(e){return"animateOut"===e.trigger}))]).then(function(){return s.sceneProxy.doInCT(e,function(){return Promise.resolve(t)})})}).then(function(a){K(1===a.type,a.index,u.options,u.condition_options),1===a.type?s.showNextPlot(e,t,n,"option",a.index):s.showNextPlot(e,t,n)},function(e){Promise.reject(e)})},l=function(){var o=[],r=function(e,t,n){e.music?(s.viewComponent.game.load.cache.checkSoundKey(e.music.url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&(s.sceneProxy.stopMusic(e.music.url),s.sceneProxy.playMusic(e.music.url,e.music.volume,!0)):s.sceneProxy.stopMusic();for(var a in e.sounds)e.sounds[a]?(s.viewComponent.game.load.cache.checkSoundKey(e.sounds[a].url)||"ios"===flashvars.client&&flashvars.app_version>="1.5.0")&&(s.sceneProxy.stopSound(a,e.sounds[a].url),s.sceneProxy.playSound(a,e.sounds[a].url,e.sounds[a].volume,0===e.sounds[a].time)):s.sceneProxy.stopSound(a);!e.bk&&(e.bk={opacity:0}),d=s.sceneProxy.curPlotLayer.create(0,0,e.bk.url),d.alpha=e.bk.opacity,d.width=960,d.height=540,s.viewComponent.addGifAnimation(d,e.bk.url),s.sceneProxy.charsAndPropsLayer&&s.sceneProxy.charsAndPropsLayer.exists||(s.sceneProxy.charsAndPropsLayer=s.viewComponent.game.add.group(),s.sceneProxy.charsAndPropsLayer.name="charactersAndProps");var r=!0,i=!1,l=void 0;try{for(var c,h=e.charsAndProps[Symbol.iterator]();!(r=(c=h.next()).done);r=!0){var f=c.value,m=f.x,p=f.y;f.pivotX&&f.pivotY&&(f.x-=f.width/2,f.y-=f.height/2);var y=s.viewComponent.addFitImageSprint(f.x,f.y,f.width,f.height,f.url,s.sceneProxy.charsAndPropsLayer,f.index);y.alpha=f.opacity,y.angle=f.rotate,f.pivotX&&(y.scale.x=f.scaleX,y.scale.y=f.scaleY,y.x=m,y.y=p),y.cmdUuid=f.cmdUuid,f.parentScale&&y.parent.scale.setTo(f.parentScale,f.parentScale),s.viewComponent.addGifAnimation(y,f.url)}}catch(g){i=!0,l=g}finally{try{!r&&h["return"]&&h["return"]()}finally{if(i)throw l}}""!==s.sceneProxy.weatherType&&T(e.weatherType),s.sceneProxy.bCmdAutoText=e.autoText,e.dialogInfo[0]&&(n>=t.length||n<t.length&&"showDialog"!==t[n].type)?(k(e.dialogInfo[0]),z(e.dialogInfo[0].speaking,!0)):s.sceneProxy.dialogLayer.visible=!1,s.sceneProxy.removeViewTimer(s.sceneProxy.plotViewsLayer),s.sceneProxy.removeInputView(s.sceneProxy.plotViewsLayer),s.sceneProxy.plotViewsLayer.removeAll(!0),s.sceneProxy.filterInexistentPlotViews(e.plotViews,u),s.removeViewKey(s.sceneProxy.plotViewKeys),O(e.plotViews),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer);for(var v in s.sceneProxy.globalViews)if(!s.sceneProxy.globalViews[v].visible)for(var x in s.sceneProxy.json_data.views)if(s.sceneProxy.json_data.views[x].ref===s.sceneProxy.globalViews[v].name){o[v]=s.sceneProxy.json_data.views[x].instanceUuid;break}A(!0,o),e.menuInfo[0]&&(s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=e.menuInfo[0].x,s.sceneProxy.menuLayer.y=e.menuInfo[0].y)},l=function(t,n){var a={type:""};return s.sceneProxy.curCmdInfo=t,s.sceneProxy.curCmdIndex=n,new Promise(function(r,l){if("systemUI"===t.commands[n].type||"jump"===t.commands[n].type||"back"===t.commands[n].type||"insert"===t.commands[n].type)s.sceneProxy.cmdPlotNextPromise=null;else if("showDialog"===t.commands[n].type){var u=function(e){var t=new Phaser.Pointer(game,1,Phaser.PointerMode.CURSOR);t.button=0,s.sceneProxy.curPlotLayer.onChildInputDown.dispatch("nextCmd",t),
s.sceneProxy.curPlotLayer.onChildInputDown.dispatch("nextCmd",t),r(e)};s.sceneProxy.cmdPlotNextPromise=u}else s.sceneProxy.cmdPlotNextPromise=r;var h=t.commands,f=h[n].args;s.sceneProxy.curCmdUuid=h[n].uuid;var m=function(){switch(h[n].type){case"addView":M(f,null,h[n].uuid),s.sceneProxy.plotViewsLayer.visible=!0,s.viewComponent.game.world.bringToTop(s.sceneProxy.menuLayer);break;case"delView":s.destroyView(f[0]);break;case"systemUI":if("save-record"===f[0]){var i=s.sceneProxy.context.disableSaveOrLoad;return i&&i.save?(s.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用存档"),{v:r(a)}):(!s.sceneProxy.mainMenuLayer.visible&&s.sceneProxy.getSnap(),s.sceneProxy.showSave(!1,{callbackFun:r,callbackArgs:a}),{v:void 0})}if("load-record"===f[0]){var u=s.sceneProxy.context.disableSaveOrLoad;return u&&u.load?(s.sceneProxy.showToast(1,"抱歉，作者在此设置了禁用读档"),{v:r(a)}):(s.sceneProxy.showLoad(!1,{callbackFun:r,callbackArgs:a}),{v:void 0})}if("settings"===f[0])return s.sceneProxy.showPlayback({callbackFun:r,callbackArgs:a}),{v:void 0};if("playback"===f[0])return s.sceneProxy.showSettings(e,{callbackFun:r,callbackArgs:a}),{v:void 0};case"addImage":if(1===f[0].index){var m="inherit"===f[0].url,p=m?s.sceneProxy.lstPlotBkKey:f[0].url,g=m?s.sceneProxy.lstPlotBkFlex:f[0].flex,v=m?s.sceneProxy.lstPlotBkOpacity:f[0].opacity;if(s.viewComponent.game.load.cache.checkImageKey(p)){var w=s.sceneProxy.curPlotLayer.children.splice(1,1);w.length&&w[0].destroy(),d=s.sceneProxy.curPlotLayer.create(f[0].x,f[0].y,p),d.alpha=void 0===v?1:v,s.backgroundFlex(d,g),s.sceneProxy.lstGameBk&&s.sceneProxy.lstGameBk.visible&&(s.sceneProxy.lstGameBk.visible=!1),s.sceneProxy.lstPlotBkKey=p,s.sceneProxy.lstPlotBkOpacity=v,s.sceneProxy.lstPlotBkFlex=g,s.viewComponent.addGifAnimation(d,f[0].url)}}else I(f,[],h[n].uuid);break;case"delImage":if(1===f[0]){var b=s.sceneProxy.curPlotLayer.children.splice(1,1);b.length&&b[0].destroy()}else for(var C=0;C<s.sceneProxy.charsAndPropsLayer.children.length;C++){var S=s.sceneProxy.charsAndPropsLayer.getAt(C);if(-1===S)break;if(S.zIndex===f[0]){s.sceneProxy.charsAndPropsLayer.removeChildAt(C),S.destroy();break}}break;case"showMenu":s.sceneProxy.menuInfo=f.concat(),s.addMenuLayer(!1),s.sceneProxy.menuLayer.x=f[0].x,s.sceneProxy.menuLayer.y=f[0].y;break;case"hideMenu":s.sceneProxy.menuInfo=[],s.sceneProxy.menuLayer.visible=!1;break;case"showGlobalView":for(var E=0;E<o.length;E++)if(o[E]===f[0]){o.splice(E,1);break}A(!1,o);break;case"hideGlobalView":for(var O=0;O<o.length&&o[O]!==f[0];O++);O>=o.length&&(o[O]=f[0]),A(!1,o);break;case"showDialog":return s.sceneProxy.lstDialogInfo=f.concat(),s.sceneProxy.dialogLayer.animateTweens.forEach(function(e,t){e.stop()}),s.sceneProxy.dialogLayer.animateTweens.splice(0),H(f[0]),{v:k(f[0]).then(function(){return"bottom"===f[0].speaking.coverage&&(s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.weatherLayer)),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),A(!1,o),z(f[0].speaking)}).then(function(){var e=s.sceneProxy.plotViewsLayer.children.length>0;if((s.sceneProxy.bCmdAutoText||!e&&(s.sceneProxy.quickPlay||s.sceneProxy.context.auto))&&!s.sceneProxy.playPause)return r(a);var t=function n(t,o){if(!(o&&o.pointerMode===Phaser.PointerMode.CURSOR&&0!==o.button||"auto"===t&&e))return s.sceneProxy.curPlotLayer.onChildInputDown.remove(n),"insertPlot"===t?l():r(a)};s.sceneProxy.curPlotLayer.onChildInputDown.add(t),!e&&s.sceneProxy.space_key.onDown.addOnce(function(){return r(a)})})};case"hideDialog":s.sceneProxy.lstDialogInfo=[],s.sceneProxy.dialogLayer.visible=!1;break;case"playMusic":_(f[0]);break;case"stopMusic":s.sceneProxy.stopMusic();break;case"playSound":if("inherit"===f[0].url){s.sceneProxy.plotSounds[f[0].index]&&s.sceneProxy.playInheritSound(f[0].index,f[0].volume);break}(s.viewComponent.game.load.cache.checkSoundKey(f[0].url)||"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version)&&(s.sceneProxy.stopSound(f[0].index,f[0].url),s.sceneProxy.playSound(f[0].index,f[0].url,f[0].volume,0===f[0].time));break;case"stopSound":s.sceneProxy.stopSound(f[0]);break;case"animateImage":var V=s.sceneProxy.quickPlay?0:f[0].delay,N=s.sceneProxy.quickPlay?0:f[0].duration;if(f[0].index>1&&s.sceneProxy.charsAndPropsLayer.exists)for(var B=function(e){var t=s.sceneProxy.charsAndPropsLayer.children[e];if(t.zIndex===f[0].index){var n=t.children[0],a=function(){t.animateTweens&&(t.animateTweens.forEach(function(e,t){e.stop(!1)}),t.animateTweens.splice(0)),n.animateTweens&&(n.animateTweens.forEach(function(e,t){e.stop(!1)}),n.animateTweens.splice(0)),n.finalState&&(n.alpha=n.finalState.alpha,n.angle=n.finalState.angle,n.x=n.finalState.x,n.y=n.finalState.y,t.x=0,t.y=0,t.scale.x=t.finalState.scale.x,t.scale.y=t.finalState.scale.y);var e=f[0].opacity,a=180===parseInt(f[0].rotate)?179.9:f[0].rotate,o=f[0].x/f[0].scaleX+n.width/2,r=f[0].y/f[0].scaleY+n.height/2,i=f[0].scaleX,l=f[0].scaleY;if(n.mirrorH&&(a=-a,o-=n.width),n.mirrorV&&(a=-a,r-=n.height),(!n.lstAlpha&&n.alpha!==e||n.lstAlpha!==e)&&(n.lstAlpha=e,s.tweenToPromise(n,{alpha:e},N,null,!0,V)),(!n.lstAngle&&n.angle!==a||n.lstAngle!==a)&&(n.lstAngle=a,s.tweenToPromise(n,{angle:a},N,null,!0,V)),!n.lstX&&n.x!==o||n.lstX!==o){n.lstX=o;var u=n.mirrorH?(n.x+n.width/2)*t.scale.x:(n.x-n.width/2)*t.scale.x,c=f[0].x-u*(f[0].scaleX/t.scale.x);s.tweenToPromise(t,{x:c},N,null,!0,V).then(function(){t.x=0,n.x=n.lstX})}if(!n.lstY&&n.y!==r||n.lstY!==r){n.lstY=r;var d=n.mirrorV?(n.y+n.height/2)*t.scale.y:(n.y-n.height/2)*t.scale.y,h=f[0].y-d*(f[0].scaleY/t.scale.y);s.tweenToPromise(t,{y:h},N,null,!0,V).then(function(){t.y=0,n.y=n.lstY})}n.finalState={alpha:e,angle:a,x:o,y:r},(!t.lstScaleX&&t.scale.x!==i||t.lstScaleX!==i)&&(t.lstScaleX=i,s.tweenToPromise(t.scale,{x:i},N,null,!0,V)),(!t.lstScaleY&&t.scale.y!==l||t.lstScaleY!==l)&&(t.lstScaleY=l,s.tweenToPromise(t.scale,{y:l},N,null,!0,V)),t.finalState={scale:{x:i,y:l}}};return a(),"break"}},R=0;R<s.sceneProxy.charsAndPropsLayer.children.length;R++){var j=B(R);if("break"===j)break}else 1===f[0].index&&s.sceneProxy.curPlotLayer.children[1]&&(s.tweenToPromise(s.sceneProxy.curPlotLayer.children[1],{alpha:f[0].opacity},N,null,!0,V),s.sceneProxy.curPlotLayer.children[1].finalState={alpha:f[0].opacity},s.sceneProxy.lstPlotBkOpacity=f[0].opacity);break;case"animateDialog":if(s.sceneProxy.dialogLayer.visible){var D=s.sceneProxy.quickPlay?0:f[0].delay,U=s.sceneProxy.quickPlay?0:f[0].duration,F=function(){var e={alpha:f[0].opacity,angle:f[0].rotate,x:parseFloat(f[0].x),y:parseFloat(f[0].y)};return s.sceneProxy.lstDialogInfo[0].opacity=f[0].opacity,s.sceneProxy.lstDialogInfo[0].rotate=f[0].rotate,s.sceneProxy.lstDialogInfo[0].x=f[0].x,s.sceneProxy.lstDialogInfo[0].y=f[0].y,s.tweenToPromise(s.sceneProxy.dialogLayer,e,U,null,!0,D)},G=function(){return s.tweenToPromise(s.sceneProxy.dialogLayer.scale,{x:f[0].scaleX,y:f[0].scaleY},U,null,!0,D)};F()&&G()}break;case"animateScene":s.sceneProxy.quickPlay||("twinkle"===f[0].type&&P(f[0].duration,f[0].delay,f[0].color),"shake"===f[0].type&&(s.sceneProxy.curPlotLayer.isShaking||(x(18,f[0].duration,f[0].delay),s.sceneProxy.curPlotLayer.isShaking=!0)));break;case"animateMusic":"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?y["default"].tweenToMusic(f[0].volume,f[0].duration,f[0].delay):s.tweenToPromise(s.sceneProxy.bk_music,{volume:f[0].volume},f[0].duration,null,!0,f[0].delay);break;case"animateSound":"ios"===flashvars.client&&"1.5.0"<=flashvars.app_version?y["default"].tweenToSound(f[0].index,f[0].volume,f[0].duration,f[0].delay):s.tweenToPromise(s.sceneProxy.plotSounds[f[0].index],{volume:f[0].volume},f[0].duration,null,!0,f[0].delay);break;case"setValues":s.sceneProxy.valueOperation(e,f);break;case"wait":return s.sceneProxy.quickPlay?{v:r(a)}:{v:W(f[0].value+20,{type:0}).then(function(){return r(a)})};case"jump":return s.sceneProxy.context=JSON.parse(JSON.stringify(s.sceneProxy.context)),s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"jump",f[0]),{v:r(!1)};case"back":return s.sceneProxy.context=JSON.parse(JSON.stringify(s.sceneProxy.context)),s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"back"),{v:r(!1)};case"insert":return s.showNextPlot(s.sceneProxy.context,s.sceneProxy.curChapter,s.sceneProxy.curPlotIndex,"insertPlot",f[0]),{v:r(!1)};case"options":return s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.exists||(s.sceneProxy.optionLayer=s.viewComponent.game.add.group()),s.viewComponent.game.world.bringToTop(s.sceneProxy.optionLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.plotViewsLayer),A(!1,o),s.sceneProxy.isScreenHold&&s.viewComponent.game.world.bringToTop(s.sceneProxy.quickPlayLayer),{v:L(f,null).then(function(e){return a.type="options",a.index=e.index,K(!0,a.index,f,[]),r(a)})};case"conditionOptions":return s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.exists||(s.sceneProxy.optionLayer=s.viewComponent.game.add.group()),{v:L([],f).then(function(e){return 2===e.type&&(a.type="cdtOptions"),K(!1,0,[],f),r(a)})};case"backOption":a.type="backOption",a.eArg=s.sceneProxy.Expression.safeEval(t.commands[n].args[0],e);break;case"jumpOption":a.type="jumpOption",a.eArg=s.sceneProxy.Expression.safeEval(t.commands[n].args[0],e);break;case"autoSaveOrLoad":if(s.sceneProxy.json_data.default_settings&&s.sceneProxy.json_data.default_settings.autoSaveOrLoad){if(1===f[0].type)return s.sceneProxy.loadRecord(f[0].index)?{v:Promise.resolve(-1)}:{v:c["default"].warn("Sorry~读不到存档内容，即将返回封面").then(function(){return s.sceneProxy.reStart(),Promise.resolve(-1)},function(){return s.sceneProxy.reStart(),Promise.resolve(-1)})};0===f[0].type&&(s.sceneProxy.getSnap(),s.sceneProxy.saveRecord(f[0].index,!0))}break;case"autotext":s.sceneProxy.bCmdAutoText=f[0];break;case"weather":"none"===f[0]?s.sceneProxy.weatherLayer.visible=!1:T(f[0]);break;case"disableSaveOrLoad":s.sceneProxy.context.disableSaveOrLoad=f[0]}}();return"object"===("undefined"==typeof m?"undefined":i(m))?m.v:r(a)})},h=function w(a,o){return s.cmdPlotLoadResources(e,t,n,a,o).then(function(){return l(a,o).then(function(r){if(s.sceneProxy.cmdPlotNextPromise=null,r&&e===s.sceneProxy.context){var i=s.sceneProxy.getNextCommand(e,a,o,r),l=i.info,u=i.index;l&&l.commands[u]?w(l,u):s.showNextPlot(e,t,n)}})})};s.sceneProxy.lstPlotLayer&&s.sceneProxy.lstPlotLayer.destroy(),s.sceneProxy.lstPlotLayer=s.sceneProxy.curPlotLayer,s.sceneProxy.bCmdAutoText=!1,s.sceneProxy.lstDialogInfo=[],s.sceneProxy.cmdPlayHandlerFun=h,S(s.sceneProxy.curPlotLayer);var f={commands:u.commands,parentInfo:null,parentCmdIndex:-1},m=0;if(a&&a.cmdInfo&&(f=a.cmdInfo,m=a.cmdIndex,f.commands[m]&&"systemUI"===f.commands[m].type&&m++,f.commands[m]&&"autoSaveOrLoad"===f.commands[m].type&&m++,r(a.cmdScreenSnap,f.commands,m),!f.commands[m])){var p=s.sceneProxy.getNextCommand(e,f,m-1,{type:"insert"}),g=p.info,v=p.index;f=g,m=v}s.addMenuLayer(!!s.sceneProxy.json_data.template.json.shanyiMenu),f&&f.commands[m]?h(f,m):s.showNextPlot(e,t,n)};s.sceneProxy.curPlotLayer=s.viewComponent.game.add.group(),s.sceneProxy.curPlotLayer.inputEnableChildren=!0,s.sceneProxy.curPlotLayer.name="plotLayer",s.sceneProxy.charsAndPropsLayer&&s.sceneProxy.charsAndPropsLayer.destroy(),s.sceneProxy.charsAndPropsLayer=s.viewComponent.game.add.group(),s.sceneProxy.charsAndPropsLayer.name="charactersAndProps",s.sceneProxy.optionLayer&&s.sceneProxy.optionLayer.destroy(),s.sceneProxy.optionLayer=s.viewComponent.game.add.group(),s.viewComponent.game.world.bringToTop(s.sceneProxy.curPlotLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.charsAndPropsLayer),s.viewComponent.game.world.bringToTop(s.sceneProxy.dialogLayer),o||(s.sceneProxy.removeViewTimer(s.sceneProxy.plotViewsLayer),s.sceneProxy.removeInputView(s.sceneProxy.plotViewsLayer),s.sceneProxy.plotViewsLayer.removeAll(!0),s.sceneProxy.plotViews.splice(0,s.sceneProxy.plotViews.length),s.removeViewKey(s.sceneProxy.plotViewKeys)),s.sceneProxy.curPlotInfo=u,s.sceneProxy.curChapter=t,s.sceneProxy.curPlotIndex=n,s.sceneProxy.context.disableSaveOrLoad=u.disableSaveOrLoad,u.commands?l():r()};J(),this.sceneProxy.isScreenHold&&this.viewComponent.game.world.bringToTop(this.sceneProxy.quickPlayLayer)},endPlot:function(){this.sceneProxy.coverLayer.visible=!1,this.viewComponent.game.input.onDown.removeAll(),this.sceneProxy.dialogLayer.visible=!1,this.sceneProxy.menuLayer.visible=!1,this.sceneProxy.space_key.onDown.removeAll(),this.sceneProxy.plotViews.splice(0,this.sceneProxy.plotViews.length),this.sceneProxy.removePlotTweens()},showNextPlot:function(e,t,n,a,o){var i=this,s=this.sceneProxy.getNextPlot(e,t,n,a,o),l=s.chapter,u=s.nIndex,d=s.cmdPlotSnap,h=s.context,m=s.preStackFrame,p=s.preCmdStackFrame,y=(this.viewComponent.game.load.cache,function(e){if(i.sceneProxy.resetResources(),"inherit"===e.background.url){var t=f.ResourcesManager.getCount("img",i.sceneProxy.lstPlotBkKey,"play"),n=i.sceneProxy.usingResourceCount(i.sceneProxy.lstPlotBkKey);t==n&&f.ResourcesManager.addRefCount("img",i.sceneProxy.lstPlotBkKey)}if("inherit"===e.music.url&&i.sceneProxy.bk_music){var a=f.ResourcesManager.getCount("audio",i.sceneProxy.bk_music.key,"play"),o=i.sceneProxy.usingResourceCount(i.sceneProxy.bk_music.key);a==o&&f.ResourcesManager.addRefCount("audio",i.sceneProxy.bk_music.key)}for(var r in e.plot_sound)if(e.plot_sound[r]&&"inherit"==e.plot_sound[r].url&&i.sceneProxy.plotSounds[r]){var s=f.ResourcesManager.getCount("audio",i.sceneProxy.plotSounds[r].key,"play"),l=i.sceneProxy.usingResourceCount(i.sceneProxy.plotSounds[r].key);s==l&&f.ResourcesManager.addRefCount("audio",i.sceneProxy.plotSounds[r].key)}}),g=function(){if(!l.plots[u]){if(u===-2)return i.sceneProxy.reStart();if(!(u<-2))return 0===u?void i.showNextPlot(e,l,u):(i.sceneProxy.dialogLayer.visible=!0,i.sceneProxy.menuLayer.visible=!0,i.gameOver());m&&(h.stack=[m].concat(r(h.stack)),p&&(h.cmdStack=[p].concat(r(h.cmdStack))));var s=i.sceneProxy.getNextPlot(e,t,n,a,o),c=s.chapter,f=s.nIndex,g=s.cmdPlotSnap,v=s.context,x=s.preStackFrame,P=s.preCmdStackFrame;if(l=c,u=f,d=g,h=v,m=x,p=P,u<-2)return m&&(e.stack=[m].concat(r(h.stack)),p&&(h.cmdStack=[p].concat(r(h.cmdStack)))),i.showNextPlot(e,t,n,a,o)}t!==l&&0===u||!i.sceneProxy.isPlotResourceExist(l.plots[u])?i.sceneProxy.preloadChapterAssets(h,l,u,d):(y(l.plots[u]),i.showPlot(h,l,u,d))},v=function(){if(0===n)i.showPlot(e,t,0);else{m&&(d.stack=[m].concat(r(d.stack)),p&&(d.cmdStack=[p].concat(r(d.cmdStack))));var s=i.sceneProxy.getNextPlot(e,t,n-1,a,o),l=s.chapter,u=s.nIndex,c=s.cmdPlotSnap,d=s.context;i.sceneProxy.preloadChapterAssets(d,l,u,c)}};if(this.endPlot(),l.md5&&0===l.plots.length){var x=l.downloadUuid?l.downloadUuid:l.uuid;if(!l.charge||"android"!==flashvars.client&&"ios"!==flashvars.client)this.sceneProxy.checkIfChapterFree(x,l.md5).then(function(e){l.plots=e?e:[],g()},function(e){-1===e.indexOf("code=87")?c["default"].error(e):c["default"].info("当前为收费章节，请前往闪艺app或电脑端进行购买").then(function(){return v()},function(){return g()})});else{var P=function(e,t){e?i.sceneProxy.checkIfChapterFree(x,l.md5).then(function(e){i.sceneProxy.unlockChapterCallBack=null,l.plots=e,g()},function(){c["default"].error("获取付费章节信息失败"),v()}):t?v():(c["default"].error("章节解锁失败"),g())};this.sceneProxy.unlockChapter(x,l.charge,l.md5,P)}}else g()},gameOver:function(){"ios"===flashvars.client?1===flashvars.offline?workFinished("1"):window.webkit&&window.webkit.messageHandlers.workFinished.postMessage("1"):"android"===flashvars.client&&window.app&&window.app.workFinished("1"),this.sceneProxy.showEnd()},onRegister:function(){this.setViewComponent(new diygamePlayer.view.component.Scene),this.facade.registerMediator(new diygamePlayer.view.mediator.CoverMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.SettingsMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.MainMenuMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.RecordMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.PlaybackMediator),this.facade.registerMediator(new diygamePlayer.view.mediator.EndMediator);var e=this;this.viewComponent.onRendered=function(){e.viewComponent.sceneProxy=e.sceneProxy,e.sceneProxy.preloadingBegin()},this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME)},onRemove:function(){this.setViewComponent(null)},curChapter:null},{NAME:"SceneMediator"})}),require.register("js/view/mediator/SettingsMediator.js",function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var o=t("puremvc"),r=a(o),i=t("../../common/FontUtils.js"),s=a(i);r["default"].define({name:"diygamePlayer.view.mediator.SettingsMediator",parent:r["default"].Mediator},{listNotificationInterests:function(){return[diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS]},handleNotification:function(e){var t=e.getBody();switch(e.getName()){case diygamePlayer.AppConstants.SCENE_GOTO_SETTINGS:this.callbackInfo=t.callbackInfo,this.showSettingsLayer(t.context)}},onRegister:function(){this.sceneProxy=this.facade.retrieveProxy(diygamePlayer.model.proxy.SceneProxy.NAME);var e=this.facade.retrieveMediator(diygamePlayer.view.mediator.SceneMediator.NAME);this.game=e.viewComponent&&e.viewComponent.game,this.viewComponent=e.viewComponent},fullMode:function l(){var e=this.sceneProxy.json_data.template.json.settings,l=e.fullMode,t=e.windowMode,n=this.sceneProxy.settingsLayer.getByName("settings_button_fullMode"),a=this.sceneProxy.settingsLayer.getByName("settings_button_windowMode");n&&n.changeBackground(l.checked.background.url,l.checked.text),a&&a.changeBackground(t.unchecked.background.url,t.unchecked.text)},windowMode:function u(){var e=this.sceneProxy.json_data.template.json.settings,t=e.fullMode,u=e.windowMode,n=this.sceneProxy.settingsLayer.getByName("settings_button_fullMode"),a=this.sceneProxy.settingsLayer.getByName("settings_button_windowMode");n&&n.changeBackground(t.unchecked.background.url,t.unchecked.text),a&&a.changeBackground(u.checked.background.url,u.checked.text)},autoOn:function c(){var e=this.sceneProxy.json_data.template.json.settings,c=e.autoOn,t=e.autoOff,n=this.sceneProxy.settingsLayer.getByName("settings_button_autoOn"),a=this.sceneProxy.settingsLayer.getByName("settings_button_autoOff");n&&n.changeBackground(c.checked.background.url,c.checked.text),a&&a.changeBackground(t.unchecked.background.url,t.unchecked.text)},autoOff:function d(){var e=this.sceneProxy.json_data.template.json.settings,t=e.autoOn,d=e.autoOff,n=this.sceneProxy.settingsLayer.getByName("settings_button_autoOn"),a=this.sceneProxy.settingsLayer.getByName("settings_button_autoOff");n&&n.changeBackground(t.unchecked.background.url,t.unchecked.text),a&&a.changeBackground(d.checked.background.url,d.checked.text)},addSettings:function(){var e=this,t=this.sceneProxy.json_data.template.json.settings,n=t.background,a=t.header,o=t.displayHeader,r=t.textHeader,i=t.displayCaption,l=t.textCaption,u=t.fullMode,c=t.windowMode,d=t.autoOn,h=t.autoOff,f=t.back,m=function(t,n,a){var o=e.game.load.cache.checkImageKey(t)?t:"",r=e.sceneProxy.settingsLayer.create(n.x,n.y,o);r.width=n.width,r.height=n.height,r.name=a},p=function(t,n,a,o,r,i,l){var u={},c="";c+=i.fontWeight?i.fontWeight+" ":"normal ",c+=i.fontSize?parseInt(i.fontSize)+"px ":"",c+=e.sceneProxy.json_data.font?e.sceneProxy.json_data.font.fontFamily:i.fontFamily?i.fontFamily:"",u.font=c,u.fill=i.color,u.boundsAlignH="center",u.boundsAlignV="middle",u.stroke=i.stroke,u.strokeThickness=i.stroke?2:0;var d=e.game.add.text(0,0,r,u,e.sceneProxy.settingsLayer);if(d.name=l,s["default"].fontFamily){var h=i.color?i.color:"#fefefe",f=i.fontSize?parseInt(i.fontSize):25,m="";if(h.indexOf("rgb")!==-1){var p=h.replace("rgb(","").replace(")","").split(",");m="0x"+parseInt(p[0],16)+parseInt(p[1],16)+parseInt(p[2],16),"0xffffff"===m&&(m="0xfefefe")}else m=("#ffffff"===h?"#fefefe":h).replace("#","0x");var y=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontHeight(f):f,g=e.sceneProxy.json_data.font.size?e.sceneProxy.toRealImageFontWidth(f):f;d.colors.splice(0,d.colors.length),d.text=" ",d.fill=m,d.addColor(m,0),d.x=t+(a-g*r.length)/2,d.y=n+(o-y)/2,d.wordWrapWidth=g*(r.length+1),e.sceneProxy.addImageFontText([{data:r}],g,y,d,e.sceneProxy.context)}else d.setTextBounds(t,n+(d.height-parseInt(i.fontSize))/2,a,o);return i.hidden&&(d.visible=!1),d},y=function(t,n,a,o){var r={};r.normal=o?t.unchecked.text:t.normal.text,r.active=o?null:t.active.text,r.text=a;var i=e.viewComponent.addButton(t.rect.x,t.rect.y,t.rect.width,t.rect.height,o?null:t.normal.background.url,o?null:t.active.background.url,g,r,e.sceneProxy.btn_sound,n,e.sceneProxy.settingsLayer,o);return o&&i.changeBackground(t.unchecked.background.url,a),i},g=function(t,n){n.pointerMode===Phaser.PointerMode.CURSOR&&0!==n.button||("settings_button_fullMode"===t.parent.name?(e.fullMode(),e.sceneProxy.onSettingsFullModeBtnClicked()):"settings_button_windowMode"===t.parent.name?(e.windowMode(),e.sceneProxy.onSettingsWindowModeBtnClicked()):"settings_button_autoOn"===t.parent.name?(e.autoOn(),e.sceneProxy.onSettingsAutoOnBtnClicked()):"settings_button_autoOff"===t.parent.name?(e.autoOff(),e.sceneProxy.onSettingsAutoOffBtnClicked()):"settings_button_back"===t.parent.name&&(e.sceneProxy.onSettingsBackBtnClicked(),e.callbackInfo&&(e.callbackInfo.callbackFun(e.callbackInfo.callbackArgs),e.callbackInfo=null)))},v=this.sceneProxy.settingsLayer.create(0,0,this.game.load.cache.checkImageKey(n.url)&&n.url);if(v.width=this.game.world.width,v.height=this.game.world.height,v.name="settings_bk_main",v.inputEnabled=!0,m(a.background.url,a.rect),1!=a.title.text.hidden&&p(a.title.rect.x,a.title.rect.y,a.title.rect.width,a.title.rect.height,this.sceneProxy.stringMap.settings,a.title.text,"settings_text_header"),m(o.background.url,o.rect),o.title.text.hidden||p(o.title.rect.x+o.rect.x,o.title.rect.y+o.rect.y,o.title.rect.width,o.title.rect.height,this.sceneProxy.stringMap.displayHeader,o.title.text,"settings_text_displayHeader"),m(r.background.url,r.rect),r.title.text.hidden||p(r.title.rect.x+r.rect.x,r.title.rect.y+r.rect.y,r.title.rect.width,r.title.rect.height,this.sceneProxy.stringMap.textHeader,r.title.text,"settings_text_textHeader"),m(i.background.url,i.rect),i.text.hidden||p(i.rect.x,i.rect.y,i.rect.width,i.rect.height,this.sceneProxy.stringMap.displayCaption,i.text,"settings_text_displayCaption"),m(l.background.url,l.rect),l.text.hidden||p(l.rect.x,l.rect.y,l.rect.width,l.rect.height,this.sceneProxy.stringMap.textCaption,l.text,"settings_text_textCaption"),u.hidden||y(u,"settings_button_fullMode",this.sceneProxy.stringMap.fullMode,!0),c.hidden||y(c,"settings_button_windowMode",this.sceneProxy.stringMap.windowMode,!0),d.hidden||y(d,"settings_button_autoOn",this.sceneProxy.stringMap.autoOn,!0),h.hidden||y(h,"settings_button_autoOff",this.sceneProxy.stringMap.autoOff,!0),!f.hidden){var x=y(f,"settings_button_back",this.sceneProxy.stringMap.back);x.button.onInputUp.add(function(){return e.sceneProxy.btn_sound&&e.sceneProxy.btn_sound.stop()})}this.sceneProxy.settingsLayer.visible=!1},showSettingsLayer:function(e){var t=this;0===this.sceneProxy.settingsLayer.children.length&&this.addSettings();var n=function(){t.game.scale.isFullScreen?(t.fullMode(),e.fullScreen=!0):(t.windowMode(),e.fullScreen=!1)},a=function(){e.auto?t.autoOn():t.autoOff()};this.fullScreenHandler||(this.fullScreenHandler=this.game.scale.onFullScreenChange.add(function(e){return n()})),n(),a(),this.sceneProxy.settingsLayer.visible=!0,this.game.world.bringToTop(this.sceneProxy.settingsLayer)}},{NAME:"SettingsMediator"})}),require.register("___globals___",function(e,t,n){})}(),require("___globals___");
//# sourceMappingURL=app.js.map